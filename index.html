<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1024">
    <title>Zed Supplier Directory</title>
    <style>
        :root {
            --primary-green: #173979;
            --danger-red: #ff4d4d;
            --link-blue: #007bff;
            --nav-yellow: #ffe400;
            --grid-gap: 20px;
            --border-radius: 16px;
            --transition-speed: 0.3s;
            --warning-orange: #ff9800;
            --star-color: #FFD700;
            --star-empty: #ddd;
            --card-bg: #ffffff;
            --soft-shadow: 0 12px 24px -8px rgba(0,0,0,0.08);
            --online-green: #2ecc71;
            --offline-grey: #95a5a6;
            --compliance-green: #2ecc71;
            --compliance-red: #e74c3c;
            --compliance-yellow: #f39c12;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 0;
        }

        #loadingSpinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2f3f, #0f1a24);
            z-index: 30000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease;
        }

        .spinner-container {
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(76, 175, 80, 0.2);
            animation: fadeInScale 0.5s ease;
        }

        .spinner {
            width: 80px;
            height: 80px;
            margin: 0 auto 25px;
            border: 5px solid rgba(76, 175, 80, 0.1);
            border-top: 5px solid var(--primary-green);
            border-right: 5px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }

        /* Document Thumbnail Styles */
        .document-thumbnail {
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #f0f7f4, #e0ebe8);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .document-thumbnail:hover {
            transform: translateY(-4px);
            border-color: var(--primary-green);
            box-shadow: 0 8px 20px rgba(23, 57, 121, 0.15);
        }

        .document-thumbnail .count-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--primary-green);
            color: white;
            border-radius: 20px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: bold;
            min-width: 24px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(23, 57, 121, 0.3);
            border: 2px solid white;
        }

        .document-thumbnail .icon {
            font-size: 28px;
        }

        /* Document Viewer Modal */
        #documentViewerModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 50000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .document-viewer-container {
            width: 90%;
            height: 90%;
            background: white;
            border-radius: 32px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease;
        }

        .document-viewer-header {
            background: linear-gradient(135deg, var(--primary-green), #0f2a4a);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .document-viewer-header h3 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .document-viewer-header h3 span {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 0.9rem;
        }

        .document-viewer-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .document-viewer-close:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }

        .document-viewer-body {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #f8fafc;
        }

        .document-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .document-card {
            background: white;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.02);
            border: 1px solid #eef2f6;
            transition: all 0.3s;
            animation: fadeIn 0.5s ease;
        }

        .document-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 30px -10px rgba(23, 57, 121, 0.15);
            border-color: var(--primary-green);
        }

        .document-preview {
            height: 180px;
            background: linear-gradient(145deg, #f8fafc, #edf2f7);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .document-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }

        .document-card:hover .document-preview img {
            transform: scale(1.05);
        }

        .document-icon {
            font-size: 64px;
            color: var(--primary-green);
            opacity: 0.7;
        }

        .document-info {
            padding: 18px;
        }

        .document-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            word-break: break-word;
            font-size: 14px;
        }

        .document-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }

        .document-type-badge {
            background: #e8f0fe;
            color: var(--primary-green);
            padding: 4px 12px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 11px;
        }

        .document-actions {
            display: flex;
            gap: 10px;
        }

        .document-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .document-btn.view {
            background: var(--primary-green);
            color: white;
        }

        .document-btn.view:hover {
            background: #0f2a4a;
        }

        .document-btn.download {
            background: #ecf0f1;
            color: #34495e;
        }

        .document-btn.download:hover {
            background: #dfe6e9;
        }

        /* Fullscreen Document View */
        #fullscreenDocumentView {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 60000;
            flex-direction: column;
        }

        .fullscreen-header {
            padding: 20px 30px;
            background: linear-gradient(135deg, #1a1a1a, #000);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .fullscreen-title {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .fullscreen-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .fullscreen-close:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }

        .fullscreen-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: auto;
        }

        .fullscreen-content img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .fullscreen-content iframe {
            width: 100%;
            height: 80vh;
            border: none;
            border-radius: 8px;
            background: white;
        }

        .fullscreen-footer {
            padding: 20px 30px;
            background: #1a1a1a;
            color: white;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            border-top: 1px solid #333;
        }

        .fullscreen-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .fullscreen-btn.download {
            background: var(--primary-green);
            color: white;
        }

        .fullscreen-btn.download:hover {
            background: #0f2a4a;
            transform: translateY(-2px);
        }

        /* Change Password Modal */
        #changePasswordModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 45000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .password-modal-content {
            background: white;
            border-radius: 32px;
            width: 450px;
            max-width: 95%;
            padding: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease;
        }

        .password-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .password-header .icon {
            font-size: 48px;
            background: linear-gradient(135deg, var(--primary-green), #0f2a4a);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
        }

        .password-header h3 {
            color: #2c3e50;
            margin: 0;
            font-size: 1.5rem;
        }

        .password-field {
            margin-bottom: 20px;
        }

        .password-field label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        .password-input-wrapper {
            position: relative;
        }

        .password-input-wrapper input {
            width: 100%;
            padding: 14px 45px 14px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 16px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .password-input-wrapper input:focus {
            border-color: var(--primary-green);
            outline: none;
            box-shadow: 0 0 0 4px rgba(23, 57, 121, 0.1);
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #95a5a6;
            font-size: 18px;
        }

        .password-strength {
            margin-top: 8px;
            height: 4px;
            background: #ecf0f1;
            border-radius: 2px;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            width: 0%;
            transition: all 0.3s;
        }

        .password-strength-bar.weak { background: #e74c3c; width: 33%; }
        .password-strength-bar.medium { background: #f39c12; width: 66%; }
        .password-strength-bar.strong { background: #2ecc71; width: 100%; }

        .password-match-indicator {
            font-size: 13px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .password-match-indicator.match {
            color: #2ecc71;
        }

        .password-match-indicator.no-match {
            color: #e74c3c;
        }

        .password-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .password-actions button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save-password {
            background: var(--primary-green);
            color: white;
        }

        .btn-save-password:hover {
            background: #0f2a4a;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(23, 57, 121, 0.3);
        }

        .btn-cancel {
            background: #ecf0f1;
            color: #34495e;
        }

        .btn-cancel:hover {
            background: #dfe6e9;
        }

        /* User Menu */
        .user-menu {
    position: relative;
    display: inline-block;
}

        .user-menu-button {
    background: var(--primary-green);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 30px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    transition: all 0.3s;
    position: relative;
    z-index: 1001;
}

        .user-menu-button:hover {
    background: #0f2a4a;
    transform: translateY(-2px);
}

        .user-dropdown {
    position: absolute;
    top: calc(100% + 5px);
    right: 0;
    background: white;
    min-width: 220px;
    border-radius: 16px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    overflow: hidden;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    border: 1px solid rgba(0,0,0,0.05);
}

        .user-menu:hover .user-dropdown,
.user-dropdown:hover {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

        .user-dropdown-item {
    padding: 14px 20px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 12px;
    color: #2c3e50;
    font-size: 14px;
    border-bottom: 1px solid #f0f0f0;
}

        /* Create an invisible bridge between button and dropdown */
.user-menu::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 0;
    width: 100%;
    height: 15px;
    background: transparent;
    z-index: 1000;
}

.user-dropdown-item:last-child {
    border-bottom: none;
}

        .user-dropdown-item:hover {
    background: #f8f9fa;
    color: var(--primary-green);
    padding-left: 25px;
}

        .user-dropdown-item i, 
.user-dropdown-item span:first-child {
    font-size: 18px;
    width: 24px;
    text-align: center;
}

        .user-dropdown-divider {
    height: 1px;
    background: #ecf0f1;
    margin: 5px 0;
}

.user-dropdown::before {
    content: '';
    position: absolute;
    top: -6px;
    right: 30px;
    width: 12px;
    height: 12px;
    background: white;
    transform: rotate(45deg);
    border-left: 1px solid rgba(0,0,0,0.05);
    border-top: 1px solid rgba(0,0,0,0.05);
}

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInScale {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        .spinner-text {
            color: white;
            font-size: 20px;
            font-weight: 500;
            letter-spacing: 2px;
            margin-top: 15px;
            text-transform: uppercase;
            background: linear-gradient(90deg, #fff, #173979, #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: shimmer 2s linear infinite;
        }

        .spinner-subtext {
            color: #95a5a6;
            font-size: 14px;
            margin-top: 10px;
            font-style: italic;
        }

        .spinner-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .dot {
            width: 10px;
            height: 10px;
            background-color: var(--primary-green);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }

        /* SYSTEM LOCK SCREEN */
        #systemLockScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 40000;
            display: none;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s ease;
        }

        .lock-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 60px 40px;
            border-radius: 30px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 500px;
            width: 90%;
            backdrop-filter: blur(10px);
            animation: slideUp 0.6s ease;
        }

        .lock-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: lockPulse 2s infinite;
        }

        .lock-title {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .lock-message {
            color: #666;
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .lock-timer-container {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            color: white;
        }

        .countdown-timer {
            font-size: 48px;
            font-weight: 800;
            font-family: monospace;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .unlock-time {
            font-size: 16px;
            opacity: 0.9;
            margin-top: 10px;
        }

        .lock-progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.3);
            border-radius: 5px;
            margin-top: 20px;
            overflow: hidden;
        }

        .lock-progress-fill {
            height: 100%;
            background: white;
            border-radius: 5px;
            transition: width 1s linear;
        }

        .back-to-login-btn {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .back-to-login-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        @keyframes lockPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInScale {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); opacity: 0.3; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* REJECT REASON MODAL */
        #rejectReasonModal {
            display: none;
            position: fixed;
            z-index: 50000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }

        .reject-modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 450px;
            max-width: 95%;
        }

        .reject-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin: 15px 0;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        /* LOGIN OVERLAY */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a1a, #333);
            z-index: 20000; display: flex; justify-content: center; align-items: center;
        }

        .login-card {
            background: white; padding: 40px; border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 350px; text-align: center;
        }

        .login-card img { margin-bottom: 20px; }
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .pass-wrapper { position: relative; }
        .toggle-pass { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; }

        /* HEADER */
        .topmenu {
            width: 100%; padding: 20px 0; color: white; text-align: center;
            background-size: cover; background-position: center;
            transition: background-image 1.5s ease-in-out;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }

        .top-nav {
            list-style: none; padding: 0; background: #333; margin: 0;
            display: flex; justify-content: center; flex-wrap: wrap;
        }

        .top-nav li a {
            display: block; padding: 15px 25px; text-decoration: none;
            font-weight: bold; color: white; transition: 0.3s; cursor: pointer;
        }

        .top-nav li a:hover { color: var(--nav-yellow); }

        .grid-section { padding: 40px 20px; max-width: 1200px; margin: 0 auto; }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 25px;
            margin-top: 20px;
        }

        .grid-item {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-decoration: none;
            color: #333;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            border: 1px solid rgba(76,175,80,0.1);
            position: relative;
        }

        .grid-item:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 30px rgba(76,175,80,0.15);
            border-color: var(--primary-green);
        }

        .grid-item .category-image-wrapper {
            width: 100%;
            height: 160px;
            overflow: hidden;
            position: relative;
            background: linear-gradient(145deg, #f0f7f4, #e0ebe8);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s ease;
        }

        .grid-item:hover img { transform: scale(1.08); }

        .category-fallback {
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            font-size: 56px; font-weight: 300; color: white; text-shadow: 0 4px 10px rgba(0,0,0,0.2);
            background: radial-gradient(circle at 30% 30%, #173979, #2c6b2c);
        }

        .grid-item span {
            padding: 18px 12px; text-align: center; font-weight: 600; font-size: 1rem;
            background: white; color: #1e3b37; border-top: 1px solid #f0f0f0; letter-spacing: 0.3px;
        }

        .grid-item:hover span { color: var(--primary-green); background: #fafffc; }

        .btn-del {
            background: var(--danger-red);
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            display: inline-block;
        }
        .btn-del:hover { opacity: 0.85; }

        .admin-controls {
            background: white; padding: 20px; text-align: center;
            border-radius: 50px; box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;
            margin-bottom: 30px;
        }

        #categoryPageView, #aboutView, #contactView, #linksView, #auditLogsView, #userApprovalHistoryView { 
            display: none; padding: 40px 20px; max-width: 1300px; margin: 0 auto; 
        }
        
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .data-table th, .data-table td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        .data-table th { background: var(--primary-green); color: white; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn:hover { opacity: 0.85; transform: scale(0.98); }
        .btn-add { background: var(--primary-green); }
        .btn-back { background: #607d8b; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
        .btn-edit { background: #f39c12; padding: 5px 10px; font-size: 12px; border-radius: 4px; color: white; border: none; display: inline-block; margin-right: 5px; }
        .btn-request-delete { background: #e67e22; padding: 5px 10px; font-size: 12px; border-radius: 4px; color: white; border: none; display: inline-block; }
        .btn-approve { background: #9b59b6; padding: 5px 10px; font-size: 12px; border-radius: 4px; color: white; border: none; }
        .btn-super { background: #9b59b6; }
        .btn-warning { background: #e67e22; }
        .btn-pagination { background: #34495e; padding: 8px 15px; font-size: 13px; }

        .modal {
            display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center;
        }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 500px; max-height: 80vh; overflow-y: auto; }

        .vertical-life-bar-container {
            width: 20px; height: 60px; background: #f0f0f0; border-radius: 10px; overflow: hidden;
            position: relative; border: 1px solid #ddd; margin: 0 auto;
        }
        .vertical-life-bar-fill { width: 100%; background: linear-gradient(to top, #2ecc71, #173979); transition: height 0.5s ease; position: absolute; bottom: 0; }
        .vertical-life-bar-fill.expiring { background: linear-gradient(to top, #f39c12, #e67e22); }
        .vertical-life-bar-fill.expired { background: linear-gradient(to top, #e74c3c, #c0392b); }
        .vertical-life-bar-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: white; text-shadow: 0 0 3px rgba(0,0,0,0.5); }

        .compliance-pill { display: inline-block; padding: 4px 8px; border-radius: 50px; font-size: 10px; font-weight: bold; color: white; margin: 2px; text-transform: uppercase; }
        .comp-ok { background: #2ecc71; }
        .comp-bad { background: #e74c3c; }
        .comp-pending { background: #f39c12; }

        .star-rating-view { display: inline-flex; gap: 2px; }
        .star-view.filled { color: var(--star-color); }
        .rating-value { margin-left: 5px; font-weight: bold; }

        .image-thumbnail { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin: 2px; }

        .about-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .mission-vision-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin: 30px 0; }
        .staff-section { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-top: 30px; }

        .sessions-panel {
            position: fixed; top: 100px; right: 20px; width: 300px; background: white;
            border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.15); z-index: 1000; display: none;
        }

        .notification {
            position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #173979;
            color: white; border-radius: 5px; z-index: 10000; display: none;
        }

        .online-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .pulse-online { background: #2ecc71; box-shadow: 0 0 0 rgba(46, 204, 113, 0.4); animation: pulse-green 2s infinite; }
        .offline-grey { background: #95a5a6; }
        .beaming { animation: beam 1.5s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.6); } 70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } }
        @keyframes beam { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .user-mgmt-table { width:100%; border-collapse: collapse; font-size: 13px; }
        .role-badge { padding: 3px 8px; border-radius: 30px; color: white; font-size: 11px; margin-left: 5px; display: inline-block; }
        .role-superadmin { background: #9b59b6; } 
        .role-admin { background: #3498db; } 
        .role-staff { background: #2ecc71; }

        .hidden { display: none !important; }
        .exclusive-super { display: none; }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
        }

        .audit-log-entry {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            transition: background 0.2s;
        }

        .audit-log-entry:hover {
            background: #f5f9ff;
        }

        .audit-timestamp {
            color: #666;
            font-size: 11px;
            font-family: monospace;
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .audit-action {
            font-weight: bold;
            color: #2c3e50;
            background: #e8f5e9;
            padding: 4px 10px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
            margin-left: 10px;
        }

        .audit-user {
            background: #e3f2fd;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .audit-details {
            margin-top: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
            border-left: 3px solid var(--primary-green);
        }

        .compliance-bar-container {
            width: 100%;
            height: 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        .compliance-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        .compliance-bar-fill.good { background: linear-gradient(90deg, #2ecc71, #27ae60); }
        .compliance-bar-fill.poor { background: linear-gradient(90deg, #e74c3c, #c0392b); }

        .approval-request-item {
            background: #f9f9f9;
            border-left: 4px solid var(--warning-orange);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .reason-modal {
            display: none;
            position: fixed;
            z-index: 15000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .reason-modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 450px;
            max-width: 95%;
        }
        .reason-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin: 15px 0;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        .document-upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s;
            cursor: pointer;
        }
        .document-upload-area:hover {
            border-color: var(--primary-green);
            background: #f0f7f0;
        }
        .document-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .document-item {
            background: #f0f0f0;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .document-item i {
            color: var(--primary-green);
        }

        .rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
            gap: 5px;
        }
        .rating input {
            display: none;
        }
        .rating label {
            cursor: pointer;
            font-size: 24px;
            color: #ddd;
            transition: color 0.2s;
        }
        .rating label:before {
            content: '‚òÖ';
        }
        .rating input:checked ~ label,
        .rating label:hover,
        .rating label:hover ~ label {
            color: var(--star-color);
        }

        .approval-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        .approval-tab {
            padding: 10px 20px;
            border-radius: 30px;
            background: #f0f0f0;
            color: #333;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .approval-tab.active {
            background: var(--primary-green);
            color: white;
        }
        .approval-tab:hover {
            background: #e0e0e0;
        }
        .approval-tab.active:hover {
            background: var(--primary-green);
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .request-count-badge {
            background: #ff4d4d;
            color: white;
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 8px;
            display: inline-block;
            font-weight: bold;
        }

        .request-count-zero {
            background: #95a5a6;
        }

        .category-actions-bar {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            justify-content: center;
        }

        .category-actions-bar button {
            padding: 12px 24px;
        }

        .clickable-phone {
            color: var(--link-blue);
            text-decoration: none;
            cursor: pointer;
        }
        .clickable-phone:hover {
            text-decoration: underline;
        }

        .clickable-email {
            color: var(--link-blue);
            text-decoration: none;
            cursor: pointer;
        }
        .clickable-email:hover {
            text-decoration: underline;
        }

        .clickable-tpin {
            color: var(--primary-green);
            text-decoration: none;
            cursor: pointer;
            font-weight: 600;
        }
        .clickable-tpin:hover {
            text-decoration: underline;
        }

        .modification-history {
            position: relative;
            display: inline-block;
        }

        .modification-dropdown {
            display: none;
            position: absolute;
            background: white;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 12px;
            padding: 15px;
            font-size: 12px;
            border: 1px solid #e0e0e0;
            right: 0;
        }

        .modification-history:hover .modification-dropdown {
            display: block;
        }

        .modification-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .modification-item:last-child {
            border-bottom: none;
        }

        .modification-field {
            font-weight: 700;
            color: #e67e22;
            text-transform: capitalize;
        }

        .modification-old {
            color: #e74c3c;
            text-decoration: line-through;
            background: #fee9e7;
            padding: 2px 5px;
            border-radius: 4px;
        }

        .modification-new {
            color: #27ae60;
            background: #e8f8f5;
            padding: 2px 5px;
            border-radius: 4px;
        }

        @media (max-width: 900px) { 
            .grid-container { grid-template-columns: repeat(2, 1fr); } 
            .top-nav { flex-direction: column; }
            .mission-vision-grid { grid-template-columns: 1fr; }
            .staff-section { grid-template-columns: 1fr; }
            .modal-content { width: 95%; }
        }
        @media (max-width: 480px) { .grid-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<!-- SINGLE TAB ENFORCEMENT -->
<div id="tabConflictWarning" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 99999; color: white; text-align: center; padding-top: 20%; font-size: 24px; font-weight: bold;">
    ‚ö†Ô∏è THIS APPLICATION CAN ONLY BE OPENED IN ONE TAB<br>
    <span style="font-size: 18px; color: #ff4d4d; margin-top: 20px; display: block;">Please close this tab and use the existing tab.</span>
    <button onclick="forceTakeover()" style="margin-top: 40px; padding: 15px 30px; background: #173979; color: white; border: none; border-radius: 5px; cursor: pointer;">FORCE TAKEOVER (Close Other Tab)</button>
</div>

<!-- LOADING SPINNER -->
<div id="loadingSpinner">
    <div class="spinner-container">
        <div class="spinner"></div>
        <div class="spinner-text">Zed Supplier Directory</div>
        <div class="spinner-subtext">Loading your experience...</div>
        <div class="spinner-dots">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
    </div>
</div>

<!-- SYSTEM LOCK SCREEN -->
<div id="systemLockScreen">
    <div class="lock-container">
        <div class="lock-icon">üîí</div>
        <h1 class="lock-title">System Locked</h1>
        <p class="lock-message">Access to the system is restricted to operating hours only</p>
        
        <div class="lock-timer-container">
            <div class="countdown-timer" id="lockCountdown">00:00:00</div>
            <div class="unlock-time" id="unlockTimeDisplay">Next unlock: 07:30:00</div>
            <div class="lock-progress-bar">
                <div class="lock-progress-fill" id="lockProgress" style="width: 0%;"></div>
            </div>
        </div>
        
        <button class="back-to-login-btn" onclick="backToLoginFromLock()">‚Üê Back to Login</button>
    </div>
</div>

<!-- TIME WARNING -->
<div id="timeWarning" style="display: none; position: fixed; top: 0; left: 0; width: 100%; background: #ff4d4d; color: white; text-align: center; padding: 15px; z-index: 30000; font-weight: bold;">
    ‚ö†Ô∏è SYSTEM ALERT: Scheduled lockout at 16:50. Super admin and admin bypass active.
</div>

<!-- LOGIN OVERLAY - EMPTY FIELDS -->
<div id="loginOverlay" style="display: flex;">
    <div class="login-card">
        <img src="./images/mainlogo.png" width="100" alt="logo" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\' viewBox=\'0 0 100 100\'><rect width=\'100\' height=\'100\' fill=\'%23173979\'/><text x=\'50\' y=\'55\' font-size=\'40\' text-anchor=\'middle\' fill=\'white\' font-weight=\'bold\'>Z</text></svg>'">
        <div id="loginFieldsContent">
            <h2>System Login</h2>
            <input type="text" id="userIn" placeholder="Username" value="">
            <div class="pass-wrapper">
                <input type="password" id="passIn" placeholder="Password" value="">
                <span class="toggle-pass" onclick="togglePassword()">üëÅÔ∏è</span>
            </div>
            <button class="btn btn-add" style="width: 100%; margin-top: 10px;" onclick="handleLogin()">Login</button>
            <p style="font-size: 12px; margin-top: 15px; color: #666;">
    <span style="cursor: pointer;" onclick="forgotPasswordSimple()">Forgot Password?</span>
    <span style="margin: 0 10px;">|</span>
    <span style="cursor: pointer; color: var(--primary-green);" onclick="openAccountRequestModal()">Don't have an account? Request account creation here</span>
</p>
        </div>
    </div>
</div>


<!-- ACCOUNT REQUEST MODAL -->
<div id="accountRequestModal" class="modal" style="display: none;">
    <div class="modal-content" style="width: 700px; max-width: 95%; border-radius: 24px; padding: 30px; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: var(--primary-green); margin: 0;">üìù Request Account Creation</h3>
            <button onclick="closeAccountRequestModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">‚úï</button>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Left Column -->
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Full Name *</label>
                <input type="text" id="requestFullName" placeholder="e.g., John Doe" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Username * (Uppercase)</label>
                <input type="text" id="requestUsername" placeholder="e.g., JDOE" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;" oninput="this.value = this.value.toUpperCase()">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">NRC Number *</label>
                <input type="text" id="requestNrc" placeholder="e.g., 123456/78/1" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Phone Number *</label>
                <input type="text" id="requestPhone" placeholder="e.g., +260977123456" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
            </div>
            
            <!-- Right Column -->
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Institution *</label>
                <input type="text" id="requestInstitution" placeholder="e.g., ZAMCOM" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Position *</label>
                <input type="text" id="requestPosition" placeholder="e.g., Procurement Officer" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Email Address *</label>
                <input type="email" id="requestEmail" placeholder="e.g., john@zamcom.zm" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Password *</label>
                <input type="password" id="requestPassword" placeholder="Enter password" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
            </div>
        </div>
        
        <!-- Document Upload Section -->
        <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
            <h4 style="color: var(--primary-green); margin-bottom: 15px;">üìÑ Required Documents (Max 3MB each)</h4>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <!-- NRC -->
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('requestNrcDoc').click()" style="padding: 15px;">
                        <span style="font-size: 32px;">ü™™</span>
                        <p style="margin: 5px 0; font-weight: 600;">NRC</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="requestNrcDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleRequestDocumentUpload('nrc', this)">
                    <div id="requestNrcDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                
                <!-- Degree/Diploma -->
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('requestDegreeDoc').click()" style="padding: 15px;">
                        <span style="font-size: 32px;">üéì</span>
                        <p style="margin: 5px 0; font-weight: 600;">Degree/Diploma</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="requestDegreeDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleRequestDocumentUpload('degree', this)">
                    <div id="requestDegreeDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                
                <!-- ZIPS Certificate -->
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('requestZipsDoc').click()" style="padding: 15px;">
                        <span style="font-size: 32px;">üìú</span>
                        <p style="margin: 5px 0; font-weight: 600;">ZIPS Certificate</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="requestZipsDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleRequestDocumentUpload('zips', this)">
                    <div id="requestZipsDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button class="btn btn-add" style="flex: 1; padding: 14px; font-size: 16px;" onclick="submitAccountRequest()">Submit Request</button>
            <button class="btn" style="flex: 1; background: #95a5a6; padding: 14px; font-size: 16px;" onclick="closeAccountRequestModal()">Cancel</button>
        </div>
    </div>
</div>


<!-- HEADER -->
<div class="topmenu" id="headerSection">
    <img src="./images/mainlogo.png" width="120" alt="zamcom" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'120\' height=\'120\' viewBox=\'0 0 100 100\'><rect width=\'100\' height=\'100\' fill=\'%23173979\'/><text x=\'50\' y=\'55\' font-size=\'40\' text-anchor=\'middle\' fill=\'white\' font-weight=\'bold\'>Z</text></svg>'">
    <h1>Zed Supplier Directory</h1>
    <h2>PROCUREMENT</h2>
    <marquee style="background: rgba(0,0,0,0.3); padding: 2px 0;">Right Quality - Right Quantity - Right Time - Right Price - Right Place</marquee>
    <h4 id="greeting" style="margin-top:20px;"><i>Welcome</i></h4>
</div>

<!-- NAVIGATION -->
<ul class="top-nav">
    <li><a onclick="showView('home')">HOME</a></li>
    <li><a onclick="showView('links')">LINKS</a></li>
    <li><a onclick="showView('contact')">CONTACT US</a></li>
    <li><a onclick="showView('about')">ABOUT US</a></li>
    <li><a onclick="showAuditLogs()">üìã AUDIT LOGS</a></li>
    <li><a onclick="openApprovalRequestsModal()" id="approvalRequestsNavBtn" style="background:#e67e22; display:none;">‚úÖ APPROVALS <span id="approvalRequestCount" class="request-count-badge">0</span></a></li>
    <li><a onclick="openUserApprovalHistory()" id="approvalHistoryNavBtn" style="background:#9b59b6; display:none;">üìú MY REQUESTS</a></li>
    <li><a onclick="logout()" style="background: #888;">LOGOUT</a></li>
    <button id="userMgmtBtn" class="btn" style="background:#e67e22; margin: 10px; display:none;" onclick="manageUsersModal()">üë• User Management</button>
    <button id="sessionsBtn" class="btn" style="background:#2196F3; margin: 10px; display:none;" onclick="toggleSessionsPanel()">üëÅÔ∏è Active Sessions</button>
    <button id="requestsManagementBtn" class="btn exclusive-super" style="background:#9b59b6; margin: 10px; display:none;" onclick="openRequestsManagement()">üìã Requests Management <span id="requestsManagementCount" class="request-count-badge">0</span></button>
</ul>

<!-- STATUS BAR -->
<div id="systemStatusHeader" style="background: #fff; padding: 10px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
    <div style="display: flex; align-items: center; gap: 10px;">
        <span id="statusDot" style="height: 12px; width: 12px; border-radius: 50%; display: inline-block;"></span>
        <span id="statusText" style="font-weight: bold; font-size: 14px;">Checking Status...</span>
    </div>

    <div id="currentUserInfo" style="font-size: 12px; color: #555; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
        <span id="currentUserDisplay">Not logged in</span>
        <span id="userRoleBadge" style="display: none; padding:2px 6px; border-radius:12px; color:white;"></span>
    </div>

    <div id="liveClock" style="font-family: monospace; font-weight: bold;"></div>
</div>

<!-- IMAGE GALLERY MODAL -->
<div id="imageGalleryModal" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index:20001; justify-content:center; align-items:center;">
    <div style="position:relative; width:90%; height:90%;">
        <button onclick="closeImageGallery()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer;">‚úï</button>
        <button onclick="prevImage()" style="position:absolute; left:20px; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:white; border:none; width:50px; height:50px; border-radius:50%; cursor:pointer;">‚Äπ</button>
        <img id="galleryCurrentImage" src="" style="width:100%; height:100%; object-fit:contain;">
        <button onclick="nextImage()" style="position:absolute; right:20px; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:white; border:none; width:50px; height:50px; border-radius:50%; cursor:pointer;">‚Ä∫</button>
        <div id="imageCounter" style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); color:white; background:rgba(0,0,0,0.5); padding:5px 15px; border-radius:20px;">1 / 1</div>
    </div>
</div>


<!-- Add Change Password Modal after the existing modals -->
<div id="changePasswordModal">
    <div class="password-modal-content">
        <div class="password-header">
            <div class="icon">üîê</div>
            <h3>Change Password</h3>
        </div>
        
        <div class="password-field">
            <label>Current Password</label>
            <div class="password-input-wrapper">
                <input type="password" id="currentPassword" placeholder="Enter current password">
                <span class="password-toggle" onclick="togglePasswordField('currentPassword')">üëÅÔ∏è</span>
            </div>
        </div>

        <div class="password-field">
            <label>New Password</label>
            <div class="password-input-wrapper">
                <input type="password" id="newPassword" placeholder="Enter new password" onkeyup="checkPasswordStrength()">
                <span class="password-toggle" onclick="togglePasswordField('newPassword')">üëÅÔ∏è</span>
            </div>
            <div class="password-strength">
                <div class="password-strength-bar" id="passwordStrengthBar"></div>
            </div>
        </div>

        <div class="password-field">
            <label>Confirm New Password</label>
            <div class="password-input-wrapper">
                <input type="password" id="confirmPassword" placeholder="Confirm new password" onkeyup="checkPasswordMatch()">
                <span class="password-toggle" onclick="togglePasswordField('confirmPassword')">üëÅÔ∏è</span>
            </div>
            <div class="password-match-indicator" id="passwordMatchIndicator"></div>
        </div>

        <div class="password-actions">
            <button class="btn-save-password" onclick="changePassword()">
                <span>‚úì</span> Update Password
            </button>
            <button class="btn-cancel" onclick="closeChangePasswordModal()">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Add Fullscreen Document View Modal -->
<div id="fullscreenDocumentView">
    <div class="fullscreen-header">
        <div class="fullscreen-title">
            <span id="fullscreenDocIcon">üìÑ</span>
            <span id="fullscreenDocName">Document Name</span>
        </div>
        <button class="fullscreen-close" onclick="closeFullscreenDocument()">‚úï</button>
    </div>
    <div class="fullscreen-content" id="fullscreenDocContent">
        <!-- Document will be loaded here -->
    </div>
    <div class="fullscreen-footer">
        <button class="fullscreen-btn download" onclick="downloadCurrentFullscreenDoc()">
            <span>üì•</span> Download Document
        </button>
    </div>
</div>


<!-- DOCUMENT VIEWER MODAL -->
<div id="documentViewerModal" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index:20000; justify-content:center; align-items:center;">
    <div style="width:90%; height:90%; background:white; border-radius:10px; display:flex; flex-direction:column;">
        <div style="padding:15px; background:var(--primary-green); color:white; display:flex; justify-content:space-between; align-items:center;">
            <span id="documentViewerTitle">Supplier Documents</span>
            <button onclick="closeDocumentViewer()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">‚úï</button>
        </div>
        <div id="documentViewerBody" style="flex:1; padding:20px; overflow:auto; display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:20px;"></div>
    </div>
</div>

<!-- ========== REASON INPUT MODAL ========== -->
<div id="reasonModal" class="reason-modal">
    <div class="reason-modal-content">
        <h3 id="reasonModalTitle" style="color: var(--warning-orange); margin-bottom: 10px;">State Reason for Deletion</h3>
        <p style="color: #666; font-size: 13px; margin-bottom: 5px;">Please provide a reason for this deletion request:</p>
        <textarea id="deletionReason" class="reason-textarea" placeholder="Enter your reason here..."></textarea>
        <div style="display: flex; gap: 15px; justify-content: flex-end;">
            <button class="btn" style="background: var(--primary-green);" onclick="submitDeletionReason()">Submit Request</button>
            <button class="btn" style="background: #95a5a6;" onclick="closeReasonModal()">Cancel</button>
        </div>
        <input type="hidden" id="pendingDeletionType">
        <input type="hidden" id="pendingDeletionId">
        <input type="hidden" id="pendingDeletionName">
    </div>
</div>

<!-- ========== REJECT REASON MODAL ========== -->
<div id="rejectReasonModal" class="modal">
    <div class="reject-modal-content">
        <h3 style="color: var(--danger-red); margin-bottom: 15px;">‚úó Reason for Rejection</h3>
        <p style="color: #666; margin-bottom: 10px;">Please provide a reason for rejecting this request:</p>
        <textarea id="rejectReasonText" class="reject-textarea" placeholder="Enter rejection reason..."></textarea>
        <div style="display: flex; gap: 15px; justify-content: flex-end;">
            <button class="btn" style="background: var(--danger-red);" onclick="submitRejectionReason()">Confirm Rejection</button>
            <button class="btn" style="background: #95a5a6;" onclick="closeRejectReasonModal()">Cancel</button>
        </div>
        <input type="hidden" id="pendingRejectRequestId">
    </div>
</div>

<!-- ========== HOME VIEW ========== -->
<div id="homeView" class="grid-section" style="display: none;">
    <div class="admin-controls" id="adminControlsBar">
        <button class="btn btn-add" onclick="openCategoryModal()" id="newCategoryBtn">+ New Category</button>
        <button class="btn btn-add" style="background:#3498db" onclick="openSupplierModal()" id="newSupplierBtn">+ New Supplier</button>
        <input type="text" id="globalSearch" placeholder="üîç Search Supplier Name..." style="padding: 10px 20px; border-radius: 30px; border: 1px solid #ddd; width: 250px;" onkeyup="filterEverything()">
        <button id="exportBackupBtn" class="btn exclusive-super" style="background:#607d8b" onclick="exportData()">üíæ Export Backup</button>
        <button id="importMergeBtn" class="btn exclusive-super" style="background:#9c27b0" onclick="document.getElementById('importFile').click()">üì• Import & Merge</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>

    <div id="defaultHomeContent">
        <h2 style="text-align:center; color: #1e3b37; font-size: 2rem; margin-bottom: 10px;">Supplier Categories</h2>
        <p style="text-align:center; color: #5a7c7a; margin-bottom: 20px;">Browse our trusted partners by category</p>
        <div class="grid-container" id="categoryGrid"></div>
    </div>

    <div id="searchResultSection" style="display:none;">
        <h2 style="text-align:center; color: var(--primary-green);">Search Results</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Supplier Name</th>
                    <th>Category</th>
                    <th>Specialization</th>
                    <th>Phone</th>
                    <th>Rating</th>
                    <th>Renewal Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="globalSearchResultsBody"></tbody>
        </table>
        <button class="btn-back" onclick="document.getElementById('searchResultSection').style.display='none'; document.getElementById('defaultHomeContent').style.display='block';">‚Üê Back to Categories</button>
    </div>
</div>

<!-- ========== CATEGORY PAGE VIEW ========== -->
<div id="categoryPageView" style="display: none;">
    <h2 id="categoryTitle" style="color: #333; text-align: center;">Category Name</h2>
    
    <div class="category-actions-bar">
        <button class="btn btn-add" onclick="openCategoryModal()" id="categoryNewCategoryBtn">+ New Category</button>
        <button class="btn btn-add" style="background:#3498db" onclick="openSupplierModal()" id="categoryNewSupplierBtn">+ New Supplier</button>
        <button class="btn-edit" onclick="editCurrentCategory()" id="editCategoryBtn" style="padding: 12px 24px;">‚úèÔ∏è Edit Category</button>
    </div>

    <div id="complianceBanner" style="display:none; margin:15px 0; padding:12px; background:#ff4d4d; color:white; border-radius:8px; font-weight:bold; text-align:center;"></div>
    <button class="btn-back" onclick="showView('home')">‚Üê Back to Home</button>
    <div style="overflow-x: auto;">
        <table class="data-table compact-table">
            <thead>
                <tr>
                    <th>Supplier Name</th>
                    <th>Specialization</th>
                    <th>Phone</th>
                    <th>T-PIN</th>
                    <th>Email</th>
                    <th>Address</th>
                    <th>Rating</th>
                    <th>Compliance</th>
                    <th>Renewal</th>
                    <th>Docs</th>
                    <th>Modified By</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="supplierTableBody"></tbody>
        </table>
    </div>
</div>

<!-- ========== ABOUT VIEW ========== -->
<div id="aboutView" style="display: none;">
    <div class="about-card">
        <h2 style="color: var(--primary-green); text-align: center;">About ZAMCOM Procurement</h2>
        <p style="color: #555; line-height: 1.6; padding: 0 30px;">
            The ZAMCOM Procurement Department is dedicated to the systematic acquisition of goods and services 
            that support the Zambia Institute of Mass Communication's mission.
        </p>
        <div class="mission-vision-grid">
            <div style="padding:20px; border-left:5px solid var(--primary-green); background:#f9f9f9; border-radius:8px;">
                <h3 style="color: #2c3e50;">Our Mission</h3>
                <p style="color: #555;">To deliver timely, transparent, and ethical procurement solutions.</p>
            </div>
            <div style="padding:20px; border-left:5px solid var(--link-blue); background:#f9f9f9; border-radius:8px;">
                <h3 style="color: #2c3e50;">Our Vision</h3>
                <p style="color: #555;">To lead ZAMCOM into digital procurement excellence.</p>
            </div>
        </div>
    </div>
</div>

<!-- ========== CONTACT VIEW ========== -->
<div id="contactView" style="display: none; padding: 40px 20px; max-width: 1000px; margin: 0 auto;">
    <div class="about-card">
        <h2 style="color: var(--primary-green); text-align: center;">Contact Information</h2>
        <p style="color: #555; line-height: 1.6; padding: 0 30px;">
            Plot No. 3529, Government Road, Ridgeway, Lusaka, Zambia.<br>
            Email: zulujosephp@gmail.com<br>
            Phone: +260973031254<br>
        </p>
    </div>
</div>

<!-- ========== LINKS VIEW ========== -->
<div id="linksView" style="display: none; padding: 40px 20px; max-width: 1200px; margin: 0 auto;">
    <h2 style="color: #333;">Links Management</h2>
    <div style="margin-bottom: 20px;" id="addLinkBtnContainer">
        <button class="btn btn-add" onclick="openLinkModal()" id="addLinkBtn">+ Add New Link</button>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th>Institution</th>
                <th>Website</th>
                <th>Email</th>
                <th style="width:80px;" id="linkActionHeader">Action</th>
            </tr>
        </thead>
        <tbody id="linksBody"></tbody>
    </table>
</div>

<!-- ========== AUDIT LOGS VIEW ========== -->
<div id="auditLogsView" style="display: none; padding: 40px 20px; max-width: 1200px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #333; margin:0;">üìã System Audit Trail</h2>
        <div>
            <button id="deleteLast50LogsBtnAudit" class="btn exclusive-super" style="background:#e67e22;" onclick="deleteLast50AuditLogs()">üóëÔ∏è Delete Last 50 Logs</button>
            <button id="deleteAllLogsBtnAudit" class="btn exclusive-super" style="background:#c0392b; margin-left:10px;" onclick="deleteAllAuditLogs()">üóëÔ∏è Delete All Logs</button>
        </div>
    </div>
    <div class="about-card" style="padding:20px;">
        <div id="auditLogsContainer" style="min-height: 400px;">
            <!-- Audit logs will be loaded here -->
        </div>
        <div id="auditPagination" class="pagination-controls">
            <!-- Pagination controls will be loaded here -->
        </div>
    </div>
</div>

<!-- ========== USER APPROVAL HISTORY VIEW ========== -->
<div id="userApprovalHistoryView" style="display: none; padding: 40px 20px; max-width: 1200px; margin: 0 auto;">
    <h2 style="color: #333; margin-bottom: 20px;">üìú My Approval Requests</h2>
    <div class="about-card" style="padding: 20px;">
        <div class="approval-tabs">
            <div class="approval-tab active" onclick="switchApprovalHistoryTab('pending')" id="historyPendingTab">Pending Requests</div>
            <div class="approval-tab" onclick="switchApprovalHistoryTab('history')" id="historyHistoryTab">History (Approved/Rejected)</div>
        </div>
        <div id="userApprovalHistoryContainer" style="min-height: 400px;">
            <!-- User approval history will be loaded here -->
        </div>
    </div>
</div>

<!-- SESSIONS PANEL -->
<div id="sessionsPanel" class="sessions-panel">
    <div style="background:var(--primary-green); color:white; padding:12px; display:flex; justify-content:space-between; align-items:center;">
        <span>üë• Active Sessions & Online Status</span>
        <button onclick="toggleSessionsPanel()" style="background:none; border:none; color:white; cursor:pointer;">‚úï</button>
    </div>
    <div id="activeSessionsList" style="padding:15px; max-height:350px; overflow-y:auto; background:white;"></div>
</div>

<!-- ========== CATEGORY MODAL ========== -->
<div id="categoryModal" class="modal">
    <div class="modal-content" style="border-radius: 20px; max-width: 450px;">
        <h3 id="categoryModalTitle" style="color: var(--primary-green); margin-bottom: 20px; text-align: center;">‚ûï Add New Category</h3>
        <input type="hidden" id="editingCategoryId">
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">Category Name</label>
            <input type="text" id="categoryNameInput" placeholder="e.g., Stationery & Office Supplies" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; transition: border 0.3s;" onfocus="this.style.borderColor='var(--primary-green)'" onblur="this.style.borderColor='#e0e0e0'">
        </div>
        <div style="display: flex; gap: 15px;">
            <button class="btn btn-add" style="flex: 1; padding: 12px;" onclick="saveNewCategory()" id="categoryModalSaveBtn">Create Category</button>
            <button class="btn" style="flex: 1; background: #95a5a6; padding: 12px;" onclick="closeCategoryModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- ========== SUPPLIER MODAL ========== -->
<div id="supplierModal" class="modal" style="display: none;">
    <div class="modal-content" style="width: 700px; max-width: 95%; border-radius: 24px; padding: 30px;">
        <h3 id="supplierModalTitle" style="color: var(--primary-green); margin-bottom: 25px; text-align: center; font-size: 1.8rem;">‚ûï Add New Supplier</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Left Column -->
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Supplier Name *</label>
                <input type="text" id="supplierName" placeholder="e.g., ABC Supplies Ltd" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Specialization</label>
                <input type="text" id="supplierSpecialization" placeholder="e.g., Office Equipment" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Phone Number *</label>
                <input type="text" id="supplierPhone" placeholder="e.g., +260977123456" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">T PIN</label>
                <input type="text" id="supplierTpin" placeholder="Taxpayer PIN" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Email</label>
                <input type="email" id="supplierEmail" placeholder="contact@supplier.com" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Physical Address</label>
                <input type="text" id="supplierAddress" placeholder="Full address" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
            </div>
            
            <!-- Right Column -->
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Category *</label>
                <select id="supplierCategory" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                    <option value="">Select Category</option>
                </select>
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Rating (1-5 Stars)</label>
                <div class="rating" id="supplierRatingContainer" style="margin-bottom: 20px;">
                    <input type="radio" name="rating" id="star5" value="5"><label for="star5"></label>
                    <input type="radio" name="rating" id="star4" value="4"><label for="star4"></label>
                    <input type="radio" name="rating" id="star3" value="3"><label for="star3"></label>
                    <input type="radio" name="rating" id="star2" value="2"><label for="star2"></label>
                    <input type="radio" name="rating" id="star1" value="1" checked><label for="star1"></label>
                </div>
                
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #555;">Compliance Status</label>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="checkbox" id="complianceTpin" style="width: 18px; height: 18px; margin-right: 10px;">
                        <label for="complianceTpin" style="flex:1;">TPIN Registered</label>
                        <span id="complianceTpinStatus" style="font-size: 12px; padding: 3px 8px; border-radius: 20px; background: #e74c3c; color: white;">Not Compliant</span>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="checkbox" id="complianceNapsa" style="width: 18px; height: 18px; margin-right: 10px;">
                        <label for="complianceNapsa" style="flex:1;">NAPSA Registered</label>
                        <span id="complianceNapsaStatus" style="font-size: 12px; padding: 3px 8px; border-radius: 20px; background: #e74c3c; color: white;">Not Compliant</span>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="checkbox" id="complianceZra" style="width: 18px; height: 18px; margin-right: 10px;">
                        <label for="complianceZra" style="flex:1;">ZRA Registered</label>
                        <span id="complianceZraStatus" style="font-size: 12px; padding: 3px 8px; border-radius: 20px; background: #e74c3c; color: white;">Not Compliant</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="complianceZppa" style="width: 18px; height: 18px; margin-right: 10px;">
                        <label for="complianceZppa" style="flex:1;">ZPPA Registered</label>
                        <span id="complianceZppaStatus" style="font-size: 12px; padding: 3px 8px; border-radius: 20px; background: #e74c3c; color: white;">Not Compliant</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-size: 12px;">Overall Compliance</span>
                            <span id="overallCompliancePercent">0%</span>
                        </div>
                        <div class="compliance-bar-container">
                            <div id="overallComplianceBar" class="compliance-bar-fill poor" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Renewal Status</label>
                <div style="display: flex; gap: 10px; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 12px;">
                    <div style="flex:1;">
                        <select id="supplierRenewalMonth" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            <option value="0">January</option>
                            <option value="1">February</option>
                            <option value="2">March</option>
                            <option value="3">April</option>
                            <option value="4">May</option>
                            <option value="5">June</option>
                            <option value="6">July</option>
                            <option value="7">August</option>
                            <option value="8">September</option>
                            <option value="9">October</option>
                            <option value="10">November</option>
                            <option value="11" selected>December</option>
                        </select>
                    </div>
                    <div style="flex:1;">
                        <select id="supplierRenewalYear" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Document Upload Section -->
        <div style="margin-top: 25px; border-top: 1px solid #e0e0e0; padding-top: 20px;">
            <h4 style="color: #333; margin-bottom: 15px;">üìÑ Required Documents (Max 3MB each)</h4>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('tpinDocUpload').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">üìë</span>
                        <p style="margin: 5px 0; font-weight: 600;">TPIN</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="tpinDocUpload" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleDocumentUpload('tpin', this)">
                    <div id="tpinDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('napsaDocUpload').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">üìë</span>
                        <p style="margin: 5px 0; font-weight: 600;">NAPSA</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="napsaDocUpload" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleDocumentUpload('napsa', this)">
                    <div id="napsaDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('zraDocUpload').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">üìë</span>
                        <p style="margin: 5px 0; font-weight: 600;">ZRA</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="zraDocUpload" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleDocumentUpload('zra', this)">
                    <div id="zraDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('zppaDocUpload').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">üìë</span>
                        <p style="margin: 5px 0; font-weight: 600;">ZPPA</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="zppaDocUpload" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleDocumentUpload('zppa', this)">
                    <div id="zppaDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button id="supplierModalSaveBtn" class="btn btn-add" style="flex: 1; padding: 14px; font-size: 16px;" onclick="saveSupplier()">Save Supplier</button>
            <button class="btn" style="flex: 1; background: #95a5a6; padding: 14px; font-size: 16px;" onclick="closeSupplierModal()">Cancel</button>
        </div>
        <input type="hidden" id="editingSupplierId">
        <input type="hidden" id="supplierActionType" value="add">
    </div>
</div>

<!-- ========== APPROVAL REQUESTS MODAL ========== -->
<div id="approvalRequestsModal" class="modal" style="display: none;">
    <div class="modal-content" style="width: 700px; max-width: 95%; border-radius: 24px; padding: 30px;">
        <h3 style="color: var(--warning-orange); margin-bottom: 20px; text-align: center;">‚úÖ Pending Approval Requests <span id="pendingApprovalCount" class="request-count-badge">0</span></h3>
        <div id="pendingApprovalsList" style="max-height: 400px; overflow-y: auto;">
            <!-- Approval items will be loaded here -->
        </div>
        <div style="display: flex; gap: 15px; margin-top: 25px;">
            <button class="btn" style="flex: 1; background: #95a5a6;" onclick="closeApprovalRequestsModal()">Close</button>
        </div>
    </div>
</div>

<!-- ========== APPROVAL ACTION MODAL ========== -->
<div id="approvalActionModal" class="modal" style="display: none;">
    <div class="modal-content" style="width: 500px; border-radius: 24px; padding: 30px;">
        <h3 id="approvalActionTitle" style="color: var(--warning-orange); margin-bottom: 20px; text-align: center;">Approve Request</h3>
        <div id="approvalActionDetails" style="margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 12px;"></div>
        <div style="display: flex; gap: 15px;">
            <button class="btn" style="flex: 1; background: var(--primary-green);" onclick="confirmApproval(true)">‚úì Approve</button>
            <button class="btn" style="flex: 1; background: var(--danger-red);" onclick="openRejectReasonModal()">‚úó Reject</button>
            <button class="btn" style="flex: 1; background: #95a5a6;" onclick="closeApprovalActionModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- USER DOCUMENT VIEWER MODAL -->
<div id="userDocumentViewerModal" class="modal" style="display: none; z-index: 30000;">
    <div class="modal-content" style="width: 90%; max-width: 1200px; height: 90vh; padding: 0; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column;">
        <div style="background: var(--primary-green); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <h3 id="userDocumentViewerTitle" style="margin: 0; font-size: 1.2rem;">Document Viewer</h3>
            <button onclick="closeUserDocumentViewer()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">‚úï</button>
        </div>
        <div id="userDocumentViewerContent" style="flex: 1; padding: 20px; overflow: auto; background: #f5f5f5; display: flex; flex-direction: column; align-items: center;">
            <!-- Document will be loaded here -->
        </div>
        <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; display: flex; justify-content: flex-end; gap: 10px;">
            <button id="downloadUserDocumentBtn" class="btn btn-add" style="padding: 8px 20px;" onclick="downloadCurrentUserDocument()">üì• Download</button>
            <button class="btn" style="background: #6c757d; padding: 8px 20px;" onclick="closeUserDocumentViewer()">Close</button>
        </div>
    </div>
</div>

<!-- USER MANAGEMENT MODAL -->
<div id="userManagementModal" class="modal" style="display:none;">
    <div class="modal-content" style="width:600px; border-radius: 24px;">
        <h3 style="color:var(--primary-green); margin-bottom:15px;">üë§ User Management</h3>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:15px;">
            <button class="btn btn-add" onclick="openAddUserModal()" id="addUserBtn">+ Add User</button>
            <button id="deleteAllLogsBtn" class="btn exclusive-super" style="background:#c0392b;" onclick="deleteAllAuditLogs()">üóëÔ∏è Delete All Logs</button>
            <button id="deleteLast50LogsBtn" class="btn exclusive-super" style="background:#e67e22;" onclick="deleteLast50AuditLogs()">üóëÔ∏è Delete Last 50 Logs</button>
        </div>
        <div style="max-height:400px; overflow-y:auto;">
            <table class="user-mgmt-table" style="width:100%;">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Phone</th>
                        <th>Email/NRC</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="userMgmtTableBody"></tbody>
            </table>
        </div>
        <button onclick="closeUserMgmtModal()" class="btn" style="background:#777; width:100%; margin-top:15px;">Close</button>
    </div>
</div>

<!-- EDIT USER MODAL - Updated with Full Name and Document Uploads -->
<div id="editUserModal" class="modal" style="display:none;">
    <div class="modal-content" style="border-radius: 24px; max-width: 600px;">
        <h3 id="editUserTitle">‚úèÔ∏è Edit User</h3>
        <input type="hidden" id="editUserId">
        
        <!-- Full Name (NEW) -->
        <input type="text" id="editFullName" placeholder="Full Name *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        
        <input type="text" id="editUsername" placeholder="Username" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;" readonly>
        <select id="editRole" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
            <option value="staff">Staff</option>
            <option value="admin">Admin</option>
            <option value="super admin">Super Admin</option>
        </select>
        <input type="text" id="editNrc" placeholder="NRC Number *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="email" id="editEmail" placeholder="Email Address" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="editPhone" placeholder="Phone Number" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="editInstitution" placeholder="Institution / Dept" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="editPosition" placeholder="Position" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="password" id="editPassword" placeholder="New Password (leave blank to keep current)" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        
        <!-- Document Upload Section for Edit (NEW) -->
        <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
            <h4 style="color: var(--primary-green); margin-bottom: 15px;">üìÑ Documents</h4>
            
            <div style="display: grid; gap: 15px;">
                <!-- Degree/Diploma -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Degree/Diploma Certificate</label>
                    <div class="document-upload-area" onclick="document.getElementById('editDegreeDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">üéì</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload New Degree/Diploma</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="editDegreeDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('editDegree', this)">
                    <div id="editDegreeDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                
                <!-- ZIPS Membership -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ZIPS Membership Certificate</label>
                    <div class="document-upload-area" onclick="document.getElementById('editZipsDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">üìú</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload New ZIPS Certificate</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="editZipsDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('editZips', this)">
                    <div id="editZipsDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                
                <!-- NRC -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">NRC (National Registration Card)</label>
                    <div class="document-upload-area" onclick="document.getElementById('editNrcDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">ü™™</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload New NRC</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="editNrcDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('editNrc', this)">
                    <div id="editNrcDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
            </div>
            
            <!-- Current Documents Display -->
            <div id="editCurrentDocs" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h5 style="margin: 0 0 10px 0; color: #555;">Current Documents:</h5>
                <div id="editCurrentDocsList"></div>
            </div>
        </div>
        
        <div style="display:flex; align-items:center; margin:10px 0;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input type="checkbox" id="editEnabled" style="width:16px; height:16px;">
                <span style="font-size:14px;">Account Enabled</span>
            </label>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-add" style="flex:1;" onclick="saveUserEdit()">üíæ Save Changes</button>
            <button class="btn" style="background:#777; flex:1;" onclick="closeEditUserModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- ADD USER MODAL - Updated with Full Name and Document Uploads -->
<div id="addUserModal" class="modal" style="display:none;">
    <div class="modal-content" style="border-radius: 24px; max-width: 600px;">
        <h3 id="addUserTitle">‚ûï Add New User</h3>
        
        <!-- Full Name (NEW) -->
        <input type="text" id="newFullName" placeholder="Full Name *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        
        <input type="text" id="newUsername" placeholder="Username *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <select id="newRole" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
            <option value="staff">Staff</option>
            <option value="admin">Admin</option>
            <option value="super admin">Super Admin</option>
        </select>
        <input type="text" id="newNrc" placeholder="NRC Number *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="email" id="newEmail" placeholder="Email Address" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="newPhone" placeholder="Phone Number" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="newInstitution" placeholder="Institution / Dept" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="newPosition" placeholder="Position" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="password" id="newPassword" placeholder="Password *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        
        <!-- Document Upload Section (NEW) -->
        <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
            <h4 style="color: var(--primary-green); margin-bottom: 15px;">üìÑ Required Documents (Max 3MB each)</h4>
            
            <div style="display: grid; gap: 15px;">
                <!-- Degree/Diploma -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Degree/Diploma Certificate *</label>
                    <div class="document-upload-area" onclick="document.getElementById('newDegreeDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">üéì</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload Degree/Diploma</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="newDegreeDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('degree', this)">
                    <div id="newDegreeDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                
                <!-- ZIPS Membership -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ZIPS Membership Certificate *</label>
                    <div class="document-upload-area" onclick="document.getElementById('newZipsDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">üìú</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload ZIPS Certificate</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="newZipsDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('zips', this)">
                    <div id="newZipsDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                
                <!-- NRC -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">NRC (National Registration Card) *</label>
                    <div class="document-upload-area" onclick="document.getElementById('newNrcDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">ü™™</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload NRC</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="newNrcDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('nrc', this)">
                    <div id="newNrcDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
            </div>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-add" style="flex:1;" onclick="saveNewUser()">Save User</button>
            <button class="btn" style="background:#777; flex:1;" onclick="closeAddUserModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- LINK MODAL -->
<div id="linkModal" class="modal">
    <div class="modal-content" style="border-radius: 24px;">
        <h3 style="color: var(--primary-green); text-align: center;">‚ûï Add New Link</h3>
        <input type="text" id="instName" placeholder="Institution Name" style="width:100%; padding:12px; margin:8px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="instWeb" placeholder="Website" style="width:100%; padding:12px; margin:8px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="email" id="instEmail" placeholder="Email" style="width:100%; padding:12px; margin:8px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <button class="btn btn-add" style="width:100%; margin-top:15px; padding:12px;" onclick="addLink()">Save Link</button>
        <button class="btn" style="background:#95a5a6; width:100%; margin-top:8px; padding:12px;" onclick="closeLinkModal()">Cancel</button>
    </div>
</div>

<!-- NOTIFICATION -->
<div id="notification" class="notification"></div>

<!-- FIREBASE SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<script>
    // ========== SINGLE TAB ENFORCEMENT ==========
    const TAB_LOCK_KEY = 'zamcom_tab_lock';
    const TAB_ID = Math.random().toString(36).substring(2) + Date.now();
    
    function enforceSingleTab() {
        const existingTabId = localStorage.getItem(TAB_LOCK_KEY);
        const currentTime = Date.now();
        
        if (existingTabId) {
            try {
                const tabData = JSON.parse(existingTabId);
                if (tabData.id && (currentTime - tabData.timestamp < 2000)) {
                    document.getElementById('tabConflictWarning').style.display = 'block';
                    return false;
                }
            } catch (e) {}
        }
        
        localStorage.setItem(TAB_LOCK_KEY, JSON.stringify({
            id: TAB_ID,
            timestamp: currentTime
        }));
        
        window.addEventListener('beforeunload', function() {
            const currentLock = localStorage.getItem(TAB_LOCK_KEY);
            if (currentLock) {
                try {
                    const tabData = JSON.parse(currentLock);
                    if (tabData.id === TAB_ID) {
                        localStorage.removeItem(TAB_LOCK_KEY);
                    }
                } catch (e) {}
            }
        });
        
        window.addEventListener('storage', function(e) {
            if (e.key === TAB_LOCK_KEY) {
                if (e.newValue) {
                    try {
                        const newTabData = JSON.parse(e.newValue);
                        if (newTabData.id !== TAB_ID) {
                            document.getElementById('tabConflictWarning').style.display = 'block';
                        }
                    } catch (ex) {}
                }
            }
        });
        
        return true;
    }

    function forceTakeover() {
        localStorage.setItem(TAB_LOCK_KEY, JSON.stringify({
            id: TAB_ID,
            timestamp: Date.now()
        }));
        document.getElementById('tabConflictWarning').style.display = 'none';
        showNotification('Tab takeover successful', 'success');
    }

    // ========== FIREBASE CONFIG ==========
    const firebaseConfig = {
        apiKey: "AIzaSyCJrqk15bvd1746VkkDAcOM_U9w0PH7dP0",
        authDomain: "supplierdirectory-6e5c7.firebaseapp.com",
        projectId: "supplierdirectory-6e5c7",
        storageBucket: "supplierdirectory-6e5c7.firebasestorage.app",
        messagingSenderId: "434327330685",
        appId: "1:434327330685:web:6ac7e874dc5952a89c3614"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // ========== PERFORMANCE CACHING ==========
    const CACHE_DURATION = 30000;
    const dataCache = {
        categories: { data: null, timestamp: 0 },
        suppliers: { data: null, timestamp: 0 },
        links: { data: null, timestamp: 0 },
        users: { data: null, timestamp: 0 },
        approvalRequests: { data: null, timestamp: 0 }
    };

    async function getCachedData(collectionName, forceRefresh = false) {
        const cache = dataCache[collectionName];
        const now = Date.now();
        
        if (!forceRefresh && cache.data && (now - cache.timestamp) < CACHE_DURATION) {
            return cache.data;
        }
        
        let snapshot;
        if (collectionName === 'approvalRequests') {
            snapshot = await db.collection(COLLECTIONS.APPROVALS)
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc')
                .get();
        } else {
            snapshot = await db.collection(COLLECTIONS[collectionName.toUpperCase()]).get();
        }
        
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        cache.data = data;
        cache.timestamp = now;
        
        return data;
    }

    // ========== GLOBAL VARIABLES ==========
    let categories = [];
    let suppliers = [];
    let links = [];

    let userAccounts = [];
    let auditLogs = [];
    let approvalRequests = [];
    let currentCategory = "";
    let currentCategoryId = "";
    let currentGalleryImages = [];
    let currentGalleryIndex = 0;
    let bgIndex = 0;
    let sessionHeartbeat = null;
    let uploadedDocuments = {
        tpin: null,
        napsa: null,
        zra: null,
        zppa: null
    };
     let currentFullscreenDocument = null;
    let currentViewingDocuments = null;
    let currentViewingEntity = null;
    
    let requestDocuments = {
    nrc: null,
    degree: null,
    zips: null
};

    let userUploadedDocuments = {
        degree: null,
        zips: null,
        nrc: null
    };
    let pendingDeletionCallback = null;
    let lockScreenInterval = null;
    let pendingAccountRequest = null;

    // ========== REQUESTS MANAGEMENT & HISTORY ==========
    let requestsHistory = [];

    function handleUserDocumentUpload(docType, input) {
        const file = input.files[0];
        if (!file) return;
        
        if (file.size > 3 * 1024 * 1024) {
            alert(`File size exceeds 3MB limit for ${docType} document`);
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            // Store in appropriate location based on prefix
            if (docType.startsWith('edit')) {
                // For edit modal
                const actualType = docType.replace('edit', '').toLowerCase();
                if (!window.editUserDocuments) window.editUserDocuments = {};
                window.editUserDocuments[actualType] = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: e.target.result,
                    uploadedAt: new Date().toISOString()
                };
                
                const previewEl = document.getElementById(`${docType}DocPreview`);
                if (previewEl) {
                    previewEl.innerHTML = `<span style="color: var(--primary-green);">‚úì ${file.name.substring(0, 20)}${file.name.length > 20 ? '...' : ''}</span>`;
                }
            } else {
                // For add modal
                userUploadedDocuments[docType] = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: e.target.result,
                    uploadedAt: new Date().toISOString()
                };
                
                const previewEl = document.getElementById(`new${docType.charAt(0).toUpperCase() + docType.slice(1)}DocPreview`);
                if (previewEl) {
                    previewEl.innerHTML = `<span style="color: var(--primary-green);">‚úì ${file.name.substring(0, 20)}${file.name.length > 20 ? '...' : ''}</span>`;
                }
            }
        };
        reader.readAsDataURL(file);
    }

    // Global variable to track current document being viewed
    let currentViewingDocument = null;

    // View user document in full screen
    function viewUserDocument(userId, docType, event) {
        if (event) {
            event.stopPropagation();
        }
        
        console.log(`Viewing document for user ${userId}, type: ${docType}`);
        
        const user = userAccounts.find(u => u.id === userId);
        if (!user) {
            alert('User not found');
            return;
        }
        
        if (!user.documents || !user.documents[docType]) {
            alert('Document not found for this user');
            return;
        }
        
        const doc = user.documents[docType];
        currentViewingDocument = { userId, docType, doc };
        
        // Set title
        const titleMap = {
            degree: 'üéì Degree/Diploma Certificate',
            zips: 'üìú ZIPS Membership Certificate',
            nrc: 'ü™™ National Registration Card (NRC)'
        };
        
        document.getElementById('userDocumentViewerTitle').innerHTML = 
            `${titleMap[docType] || 'Document'} - ${user.fullName || user.username}`;
        
        // Set content
        const contentDiv = document.getElementById('userDocumentViewerContent');
        const isImage = doc.type && (doc.type.startsWith('image/') || doc.name?.match(/\.(jpg|jpeg|png|gif|webp)$/i));
        
        let contentHtml = '';
        
        if (isImage) {
            contentHtml = `
                <div style="text-align: center; width: 100%;">
                    <img src="${doc.data}" style="max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; text-align: left; width: 100%; max-width: 600px;">
                        <p><strong>File Name:</strong> ${doc.name}</p>
                        <p><strong>Uploaded:</strong> ${new Date(doc.uploadedAt).toLocaleString()}</p>
                        <p><strong>File Size:</strong> ${(doc.size / 1024).toFixed(1)} KB</p>
                        <p><strong>File Type:</strong> ${doc.type || 'Unknown'}</p>
                    </div>
                </div>
            `;
        } else {
            // For PDFs and other documents
            contentHtml = `
                <div style="width: 100%; height: 70vh; display: flex; flex-direction: column; align-items: center;">
                    <iframe src="${doc.data}" style="width: 100%; height: 100%; border: none; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></iframe>
                    <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; text-align: left; width: 100%; max-width: 600px;">
                        <p><strong>File Name:</strong> ${doc.name}</p>
                        <p><strong>Uploaded:</strong> ${new Date(doc.uploadedAt).toLocaleString()}</p>
                        <p><strong>File Size:</strong> ${(doc.size / 1024).toFixed(1)} KB</p>
                        <p><strong>File Type:</strong> ${doc.type || 'PDF Document'}</p>
                    </div>
                </div>
            `;
        }
        
        contentDiv.innerHTML = contentHtml;
        
        // Show modal
        document.getElementById('userDocumentViewerModal').style.display = 'flex';
    }

    // ========== FIX: Close edit user modal function ==========
function closeEditUserModal() {
    document.getElementById('editUserModal').style.display = 'none';
    document.getElementById('editUserId').value = '';
    document.getElementById('editFullName').value = '';
    document.getElementById('editUsername').value = '';
    document.getElementById('editRole').value = 'staff';
    document.getElementById('editNrc').value = '';
    document.getElementById('editEmail').value = '';
    document.getElementById('editPhone').value = '';
    document.getElementById('editInstitution').value = '';
    document.getElementById('editPosition').value = '';
    document.getElementById('editPassword').value = '';
    document.getElementById('editEnabled').checked = true;
    
    // Reset document previews
    ['editDegreeDocPreview', 'editZipsDocPreview', 'editNrcDocPreview'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
    });
    
    // Reset edit documents
    window.editUserDocuments = {};
}


    // Close document viewer
    function closeUserDocumentViewer() {
        document.getElementById('userDocumentViewerModal').style.display = 'none';
        document.getElementById('userDocumentViewerContent').innerHTML = '';
        currentViewingDocument = null;
    }

    // ========== DOCUMENT THUMBNAIL FUNCTIONS ==========
    
    // Create document thumbnail for user management
    function createDocumentThumbnail(documents, entityType, entityId, entityName) {
        if (!documents || Object.keys(documents).length === 0) {
            return '<span style="color: #ccc; font-size: 11px;">No docs</span>';
        }

        const docCount = Object.keys(documents).length;
        
        return `
            <div class="document-thumbnail" onclick="viewAllDocuments('${entityType}', '${entityId}', '${entityName.replace(/'/g, "\\'")}')" title="Click to view ${docCount} document(s)">
                <span class="icon">üìÑ</span>
                <span class="count-badge">${docCount}</span>
            </div>
        `;
    }

    // View all documents for an entity (user or supplier)
    async function viewAllDocuments(entityType, entityId, entityName) {
        let documents = [];
        let title = '';

        if (entityType === 'user') {
            const user = userAccounts.find(u => u.id === entityId);
            if (user && user.documents) {
                documents = Object.entries(user.documents).map(([type, doc]) => ({
                    ...doc,
                    type: type,
                    displayType: type === 'degree' ? 'üéì Degree/Diploma' :
                                 type === 'zips' ? 'üìú ZIPS Certificate' :
                                 type === 'nrc' ? 'ü™™ NRC' : type.toUpperCase()
                }));
            }
            title = `üìÅ ${user?.fullName || user?.username}'s Documents`;
        } else if (entityType === 'supplier') {
            const supplier = suppliers.find(s => s.id === entityId);
            if (supplier && supplier.documents) {
                documents = supplier.documents.map(doc => ({
                    ...doc,
                    displayType: doc.type === 'tpin' ? 'üìë TPIN' :
                                 doc.type === 'napsa' ? 'üìë NAPSA' :
                                 doc.type === 'zra' ? 'üìë ZRA' :
                                 doc.type === 'zppa' ? 'üìë ZPPA' : 'üìÑ Document'
                }));
            }
            title = `üìÅ ${supplier?.name}'s Documents`;
        }

        if (documents.length === 0) {
            alert('No documents available');
            return;
        }

        currentViewingDocuments = documents;
        currentViewingEntity = { type: entityType, id: entityId, name: entityName };

        const viewerBody = document.getElementById('documentViewerBody');
        viewerBody.innerHTML = '';

        documents.forEach((doc, index) => {
            const isImage = doc.type && (doc.type.startsWith('image/') || doc.name?.match(/\.(jpg|jpeg|png|gif|webp)$/i));
            
            const card = document.createElement('div');
            card.className = 'document-card';
            card.style.animationDelay = `${index * 0.05}s`;
            
            let previewHtml = '';
            if (isImage) {
                previewHtml = `<img src="${doc.data}" alt="${doc.name}">`;
            } else {
                previewHtml = `<span class="document-icon">üìÑ</span>`;
            }

            card.innerHTML = `
                <div class="document-preview">
                    ${previewHtml}
                </div>
                <div class="document-info">
                    <div class="document-name">${doc.name || 'Document'}</div>
                    <div class="document-meta">
                        <span class="document-type-badge">${doc.displayType || doc.type || 'Document'}</span>
                        <span>${doc.size ? (doc.size / 1024).toFixed(1) + ' KB' : ''}</span>
                    </div>
                    <div class="document-actions">
                        <button class="document-btn view" onclick="openFullscreenDocument(${index})">
                            <span>üëÅÔ∏è</span> View
                        </button>
                        <button class="document-btn download" onclick="downloadDocument(${index})">
                            <span>üì•</span> Download
                        </button>
                    </div>
                </div>
            `;
            
            viewerBody.appendChild(card);
        });

        document.getElementById('documentViewerTitle').innerHTML = title;
        document.getElementById('documentViewerModal').style.display = 'flex';
    }

    // Open document in fullscreen
    function openFullscreenDocument(index) {
        if (!currentViewingDocuments || !currentViewingDocuments[index]) return;

        const doc = currentViewingDocuments[index];
        currentFullscreenDocument = doc;

        const isImage = doc.type && (doc.type.startsWith('image/') || doc.name?.match(/\.(jpg|jpeg|png|gif|webp)$/i));
        
        document.getElementById('fullscreenDocName').textContent = doc.name || 'Document';
        document.getElementById('fullscreenDocIcon').textContent = isImage ? 'üñºÔ∏è' : 'üìÑ';

        const contentDiv = document.getElementById('fullscreenDocContent');
        
        if (isImage) {
            contentDiv.innerHTML = `<img src="${doc.data}" alt="${doc.name}">`;
        } else {
            contentDiv.innerHTML = `<iframe src="${doc.data}" title="${doc.name}"></iframe>`;
        }

        document.getElementById('documentViewerModal').style.display = 'none';
        document.getElementById('fullscreenDocumentView').style.display = 'flex';
    }

    // Close fullscreen document
    function closeFullscreenDocument() {
        document.getElementById('fullscreenDocumentView').style.display = 'none';
        document.getElementById('fullscreenDocContent').innerHTML = '';
        currentFullscreenDocument = null;
    }

    // Download current document
    function downloadDocument(index) {
        if (!currentViewingDocuments || !currentViewingDocuments[index]) return;

        const doc = currentViewingDocuments[index];
        const link = document.createElement('a');
        link.href = doc.data;
        link.download = doc.name || 'document';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Download document from fullscreen
    function downloadCurrentFullscreenDoc() {
        if (!currentFullscreenDocument) return;

        const link = document.createElement('a');
        link.href = currentFullscreenDocument.data;
        link.download = currentFullscreenDocument.name || 'document';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // ========== CHANGE PASSWORD FUNCTIONS ==========

    function openChangePasswordModal() {
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        document.getElementById('passwordStrengthBar').className = 'password-strength-bar';
        document.getElementById('passwordMatchIndicator').innerHTML = '';
        document.getElementById('changePasswordModal').style.display = 'flex';
    }

    function closeChangePasswordModal() {
        document.getElementById('changePasswordModal').style.display = 'none';
    }

    function togglePasswordField(fieldId) {
        const field = document.getElementById(fieldId);
        field.type = field.type === 'password' ? 'text' : 'password';
    }

    function checkPasswordStrength() {
        const password = document.getElementById('newPassword').value;
        const strengthBar = document.getElementById('passwordStrengthBar');
        
        if (!password) {
            strengthBar.className = 'password-strength-bar';
            return;
        }

        // Check password strength
        let strength = 0;
        
        // Length check
        if (password.length >= 8) strength++;
        if (password.length >= 12) strength++;
        
        // Character variety checks
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^a-zA-Z0-9]/.test(password)) strength++;

        if (strength <= 2) {
            strengthBar.className = 'password-strength-bar weak';
        } else if (strength <= 4) {
            strengthBar.className = 'password-strength-bar medium';
        } else {
            strengthBar.className = 'password-strength-bar strong';
        }
    }

    function checkPasswordMatch() {
        const newPass = document.getElementById('newPassword').value;
        const confirmPass = document.getElementById('confirmPassword').value;
        const indicator = document.getElementById('passwordMatchIndicator');

        if (!confirmPass) {
            indicator.innerHTML = '';
            return;
        }

        if (newPass === confirmPass) {
            indicator.innerHTML = '‚úì Passwords match';
            indicator.className = 'password-match-indicator match';
        } else {
            indicator.innerHTML = '‚úó Passwords do not match';
            indicator.className = 'password-match-indicator no-match';
        }
    }

    async function changePassword() {
        const currentUser = getCurrentUser();
        if (!currentUser) {
            alert('You must be logged in to change password');
            return;
        }

        const user = getUser(currentUser);
        if (!user) return;

        const currentPass = document.getElementById('currentPassword').value;
        const newPass = document.getElementById('newPassword').value;
        const confirmPass = document.getElementById('confirmPassword').value;

        // Validate inputs
        if (!currentPass || !newPass || !confirmPass) {
            alert('Please fill in all password fields');
            return;
        }

        // Verify current password
        if (currentPass !== user.password) {
            alert('Current password is incorrect');
            return;
        }

        // Check new password match
        if (newPass !== confirmPass) {
            alert('New passwords do not match');
            return;
        }

        // Password strength validation
        if (newPass.length < 6) {
            alert('New password must be at least 6 characters long');
            return;
        }

        try {
            // Update password in Firestore
            await db.collection(COLLECTIONS.USERS).doc(user.id).update({
                password: newPass,
                lastPasswordChange: new Date().toISOString()
            });

            // Log the action
            await logAudit('PASSWORD_CHANGE', {
                username: user.username,
                changedBy: user.username
            });

            // Update local user data
            user.password = newPass;
            
            showNotification('Password changed successfully!', 'success');
            closeChangePasswordModal();

        } catch (error) {
            console.error('Error changing password:', error);
            alert('Failed to change password: ' + error.message);
        }
    }

    // Download current document
    function downloadCurrentUserDocument() {
        if (!currentViewingDocument) {
            alert('No document selected');
            return;
        }
        
        const { doc } = currentViewingDocument;
        
        // Create a temporary link and trigger download
        const link = document.createElement('a');
        link.href = doc.data;
        link.download = doc.name || 'document';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Also add this to close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('userDocumentViewerModal');
        if (event.target === modal) {
            closeUserDocumentViewer();
        }
    }

    // ========== FIX: Update saveNewUser function with better validation ==========
async function saveNewUser() {
    if (!canAddUser()) {
        alert("You don't have permission to add users");
        return;
    }

    // Get values and trim them properly
    const fullName = document.getElementById('newFullName')?.value?.trim() || '';
    const username = document.getElementById('newUsername')?.value?.toUpperCase().trim() || '';
    const role = document.getElementById('newRole')?.value || 'staff';
    const nrc = document.getElementById('newNrc')?.value?.trim() || '';
    const email = document.getElementById('newEmail')?.value?.trim() || '';
    const phone = document.getElementById('newPhone')?.value?.trim() || '';
    const institution = document.getElementById('newInstitution')?.value?.trim() || '';
    const position = document.getElementById('newPosition')?.value?.trim() || '';
    const password = document.getElementById('newPassword')?.value?.trim() || '';

    // Debug logging
    console.log('Form values:', { fullName, username, password, role, nrc, email, phone, institution, position });
    console.log('Uploaded documents:', userUploadedDocuments);

    // Validate required fields
    const missingFields = [];
    if (!fullName) missingFields.push('Full Name');
    if (!username) missingFields.push('Username');
    if (!password) missingFields.push('Password');
    if (!role) missingFields.push('Role');
    if (!nrc) missingFields.push('NRC');

    if (missingFields.length > 0) {
        alert(`The following fields are required: ${missingFields.join(', ')}`);
        return;
    }

    // Check if username already exists
    if (userAccounts.find(u => u.username === username)) {
        alert("Username already exists");
        return;
    }

    const currentUser = getUser(getCurrentUser());
    if (!currentUser) {
        alert('You must be logged in to create a user');
        return;
    }

    // Check role permissions
    if (role === 'super admin' && currentUser.role !== 'super admin') {
        alert("Only super admin can create super admin users");
        return;
    }

    if (currentUser.role === 'staff' && role !== 'staff') {
        alert("Staff can only create staff users");
        return;
    }

    // Create user data object
    const newUser = {
        fullName,
        username,
        password,
        role,
        nrc,
        email,
        phone,
        institution,
        position,
        documents: {},
        enabled: true,
        createdAt: new Date().toISOString(),
        lastActive: null
    };

    // Add documents if uploaded
    if (userUploadedDocuments.degree) {
        newUser.documents.degree = userUploadedDocuments.degree;
    }
    if (userUploadedDocuments.zips) {
        newUser.documents.zips = userUploadedDocuments.zips;
    }
    if (userUploadedDocuments.nrc) {
        newUser.documents.nrc = userUploadedDocuments.nrc;
    }

    // For staff users creating other staff users, check if documents are uploaded
    if (currentUser.role === 'staff' && role === 'staff') {
        if (!userUploadedDocuments.degree || !userUploadedDocuments.zips || !userUploadedDocuments.nrc) {
            alert("Please upload all required documents: Degree/Diploma, ZIPS Certificate, and NRC");
            return;
        }
    }

    try {
        if (currentUser.role === 'super admin') {
            // Super Admin - Add directly
            await db.collection(COLLECTIONS.USERS).add(newUser);
            
            await logAudit('CREATE_USER', {
                username,
                fullName,
                role,
                createdBy: getCurrentUser()
            });
            
            await getAllUsers(true);
            closeAddUserModal();
            manageUsersModal();
            showNotification(`User ${fullName} (${username}) created successfully`);
            
            // Reset uploaded documents
            userUploadedDocuments = { degree: null, zips: null, nrc: null };
        } else {
            // Admin or Staff - Create approval request
            await createApprovalRequest('user', newUser, 'add', null);
            closeAddUserModal();
            manageUsersModal();
            showNotification('User addition request submitted for approval', 'info');
            
            // Reset uploaded documents
            userUploadedDocuments = { degree: null, zips: null, nrc: null };
        }
    } catch (error) {
        console.error("Error creating user:", error);
        alert("Failed to create user: " + error.message);
    }
}

    // Update openEditUserModal to include full name and documents
    function openEditUserModal(userId) {
        const user = userAccounts.find(u => u.id === userId);
        if (!user) {
            alert('User not found');
            return;
        }

        const currentUser = getUser(getCurrentUser());
        
        // Staff can only edit staff users
        if (currentUser.role === 'staff' && user.role !== 'staff') {
            alert('You can only edit staff users');
            return;
        }
        
        if (currentUser.role !== 'super admin') {
            if (user.role === 'super admin') {
                alert('You cannot edit a super admin user');
                return;
            }
        }

        document.getElementById('editUserId').value = user.id;
        document.getElementById('editFullName').value = user.fullName || '';
        document.getElementById('editUsername').value = user.username;
        document.getElementById('editRole').value = user.role;
        document.getElementById('editNrc').value = user.nrc || '';
        document.getElementById('editEmail').value = user.email || '';
        document.getElementById('editPhone').value = user.phone || '';
        document.getElementById('editInstitution').value = user.institution || '';
        document.getElementById('editPosition').value = user.position || '';
        document.getElementById('editPassword').value = '';
        document.getElementById('editEnabled').checked = user.enabled !== false;

        // Reset edit documents
        window.editUserDocuments = {};
        ['editDegreeDocPreview', 'editZipsDocPreview', 'editNrcDocPreview'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = '';
        });

        // Display current documents
        const currentDocsDiv = document.getElementById('editCurrentDocsList');
        if (currentDocsDiv) {
            let docsHtml = '';
            if (user.documents?.degree) {
                docsHtml += `<div style="margin-bottom: 5px;"><span style="background: #3498db; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">üéì Degree</span> ${user.documents.degree.name} <button onclick="viewUserDocument('${user.id}', 'degree')" style="background: none; border: none; color: var(--link-blue); cursor: pointer;">View</button></div>`;
            }
            if (user.documents?.zips) {
                docsHtml += `<div style="margin-bottom: 5px;"><span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">üìú ZIPS</span> ${user.documents.zips.name} <button onclick="viewUserDocument('${user.id}', 'zips')" style="background: none; border: none; color: var(--link-blue); cursor: pointer;">View</button></div>`;
            }
            if (user.documents?.nrc) {
                docsHtml += `<div style="margin-bottom: 5px;"><span style="background: #e67e22; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">ü™™ NRC</span> ${user.documents.nrc.name} <button onclick="viewUserDocument('${user.id}', 'nrc')" style="background: none; border: none; color: var(--link-blue); cursor: pointer;">View</button></div>`;
            }
            if (!docsHtml) docsHtml = '<p style="color: #999; font-style: italic;">No documents uploaded</p>';
            currentDocsDiv.innerHTML = docsHtml;
        }

        if (currentUser.role !== 'super admin') {
            document.getElementById('editRole').disabled = true;
        } else {
            document.getElementById('editRole').disabled = false;
        }

        document.getElementById('editUserModal').style.display = 'flex';
    }

    // Update saveUserEdit to include full name and documents
    async function saveUserEdit() {
        if (!canEditUser()) {
            alert("You don't have permission to edit users");
            return;
        }

        const userId = document.getElementById('editUserId').value;
        const user = userAccounts.find(u => u.id === userId);
        if (!user) {
            alert('User not found');
            return;
        }

        const currentUser = getUser(getCurrentUser());
        
        // Staff can only edit staff users
        if (currentUser.role === 'staff' && user.role !== 'staff') {
            alert('You can only edit staff users');
            return;
        }
        
        if (currentUser.role !== 'super admin' && user.role === 'super admin') {
            alert('You cannot edit a super admin user');
            closeEditUserModal();
            return;
        }

        const fullName = document.getElementById('editFullName').value.trim();
        if (!fullName) {
            alert('Full Name is required');
            return;
        }

        const updatedData = {
            fullName,
            role: document.getElementById('editRole').value,
            nrc: document.getElementById('editNrc').value.trim(),
            email: document.getElementById('editEmail').value.trim(),
            phone: document.getElementById('editPhone').value.trim(),
            institution: document.getElementById('editInstitution').value.trim(),
            position: document.getElementById('editPosition').value.trim(),
            enabled: document.getElementById('editEnabled').checked
        };

        // Handle document updates
        if (window.editUserDocuments && Object.keys(window.editUserDocuments).length > 0) {
            updatedData.documents = { ...user.documents };
            
            if (window.editUserDocuments.degree) {
                updatedData.documents.degree = window.editUserDocuments.degree;
            }
            if (window.editUserDocuments.zips) {
                updatedData.documents.zips = window.editUserDocuments.zips;
            }
            if (window.editUserDocuments.nrc) {
                updatedData.documents.nrc = window.editUserDocuments.nrc;
            }
        }

        const newPassword = document.getElementById('editPassword').value.trim();
        if (newPassword) {
            updatedData.password = newPassword;
        }

        if (currentUser.role !== 'super admin' && updatedData.role === 'super admin') {
            alert('Only super admin can assign super admin role');
            return;
        }

        try {
            if (currentUser.role === 'super admin') {
                await db.collection(COLLECTIONS.USERS).doc(userId).update(updatedData);
                
                await logAudit('EDIT_USER', {
                    username: user.username,
                    fullName: fullName,
                    changes: updatedData,
                    editedBy: getCurrentUser()
                });
                
                await getAllUsers(true);
                closeEditUserModal();
                manageUsersModal();
                showNotification(`User ${fullName} updated successfully`);
                
                window.editUserDocuments = {};
            } else {
                await createApprovalRequest('user', updatedData, 'edit', userId);
                closeEditUserModal();
                manageUsersModal();
                showNotification('User edit request submitted for approval', 'info');
                
                window.editUserDocuments = {};
            }
        } catch (error) {
            console.error("Error updating user:", error);
            alert("Failed to update user: " + error.message);
        }
    }

    // Delete user function
    async function deleteUser(userId) {
        if (!canDeleteUser()) {
            alert("You don't have permission to delete users");
            return;
        }

        const user = userAccounts.find(u => u.id === userId);
        if (!user) return;

        const currentUser = getUser(getCurrentUser());
        
        // Staff can only delete staff users
        if (currentUser.role === 'staff' && user.role !== 'staff') {
            alert('You can only delete staff users');
            return;
        }

        if (isJoseph(user.username)) {
            alert('JOSEPH cannot be deleted');
            return;
        }

        if (currentUser.role === 'super admin') {
            // Super Admin - Delete directly
            if (confirm(`Are you sure you want to permanently delete user ${user.username}?`)) {
                try {
                    await db.collection(COLLECTIONS.USERS).doc(userId).delete();
                    
                    await logAudit('DELETE_USER', {
                        username: user.username,
                        role: user.role,
                        deletedBy: getCurrentUser()
                    });
                    
                    await getAllUsers(true);
                    manageUsersModal();
                    showNotification(`User ${user.username} deleted successfully`);
                } catch (error) {
                    console.error("Error deleting user:", error);
                    alert("Failed to delete user");
                }
            }
        } else {
            // Admin or Staff - Require approval
            openReasonModal('user', userId, user.username, async (type, id, name, reason) => {
                await createApprovalRequest('user', { name: name, role: user.role, fullName: user.fullName }, 'delete', id, reason);
                showNotification('User deletion request submitted for approval', 'info');
                manageUsersModal();
            });
        }
    }

    // ========== FIX: Close add user modal function ==========
function closeAddUserModal() {
    document.getElementById('addUserModal').style.display = 'none';
    // Reset form fields
    document.getElementById('newFullName').value = '';
    document.getElementById('newUsername').value = '';
    document.getElementById('newRole').value = 'staff';
    document.getElementById('newNrc').value = '';
    document.getElementById('newEmail').value = '';
    document.getElementById('newPhone').value = '';
    document.getElementById('newInstitution').value = '';
    document.getElementById('newPosition').value = '';
    document.getElementById('newPassword').value = '';
    
    // Reset document previews
    ['newDegreeDocPreview', 'newZipsDocPreview', 'newNrcDocPreview'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
    });
    
    // Reset uploaded documents
    userUploadedDocuments = { degree: null, zips: null, nrc: null };
}


    // Update default users to include fullName
    async function ensureDefaultUsers() {
        try {
            const usersSnapshot = await db.collection(COLLECTIONS.USERS).get();
            if (usersSnapshot.empty) {
                const defaultUsers = [
                    { 
                        fullName: "Joseph Zulu",
                        username: "JOSEPH", 
                        password: "RIGHTJOSEPH", 
                        role: "super admin", 
                        enabled: true, 
                        nrc: "123456/78/1", 
                        email: "zulujosephp@gmail.com", 
                        phone: "+260973031254", 
                        institution: "ZAMCOM", 
                        position: "Procurement Lead",
                        documents: {},
                        createdAt: new Date().toISOString(),
                        lastActive: null
                    },
                    { 
                        fullName: "Chishala Banda",
                        username: "CHISHALA", 
                        password: "RIGHTCHISHALA", 
                        role: "staff", 
                        enabled: true, 
                        nrc: "998877/66/5", 
                        email: "chishala@zamcom.zm", 
                        phone: "+260977123456", 
                        institution: "ZAMCOM", 
                        position: "Procurement Officer",
                        documents: {},
                        createdAt: new Date().toISOString(),
                        lastActive: null
                    }
                ];
                for (const user of defaultUsers) {
                    await db.collection(COLLECTIONS.USERS).add(user);
                }
                await logAudit('SYSTEM_INIT', { action: 'Default users created' });
                console.log("Default users created with full names");
            }
        } catch (error) { 
            console.error("Error ensuring users:", error); 
        }
    }

    function hideLoadingSpinner() {
        const spinner = document.getElementById('loadingSpinner');
        if (spinner) {
            spinner.style.opacity = '0';
            setTimeout(() => {
                spinner.style.display = 'none';
            }, 500);
        }
    }

    async function loadRequestsHistory() {
        try {
            const snapshot = await db.collection(COLLECTIONS.APPROVALS)
                .orderBy('createdAt', 'desc')
                .limit(100)
                .get();
            requestsHistory = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
        } catch (error) {
            console.error('Error loading requests history:', error);
        }
    }

    // ========== NEW: Update openRequestsManagement to include account requests ==========
async function openRequestsManagement() {
    try {
        // Get all approval requests
        const approvalSnapshot = await db.collection(COLLECTIONS.APPROVALS)
            .orderBy('createdAt', 'desc')
            .get();
        
        // Get all account requests
        const accountSnapshot = await db.collection('account_requests')
            .orderBy('requestedAt', 'desc')
            .get();
        
        const allApprovalRequests = approvalSnapshot.docs.map(doc => ({ 
            id: doc.id, 
            type: 'approval',
            ...doc.data() 
        }));
        
        const allAccountRequests = accountSnapshot.docs.map(doc => ({ 
            id: doc.id, 
            type: 'account',
            ...doc.data() 
        }));
        
        const pendingAccountRequests = allAccountRequests.filter(req => req.status === 'pending');
        const pendingApprovalRequests = allApprovalRequests.filter(req => req.status === 'pending');
        const historyAccountRequests = allAccountRequests.filter(req => req.status === 'approved' || req.status === 'rejected');
        const historyApprovalRequests = allApprovalRequests.filter(req => req.status === 'approved' || req.status === 'rejected');
        
        const approvedCount = historyApprovalRequests.filter(r => r.status === 'approved').length;
        const rejectedCount = historyApprovalRequests.filter(r => r.status === 'rejected').length;
        const totalCount = allApprovalRequests.length + allAccountRequests.length;
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'requestsManagementModal';
        modal.style.display = 'flex';
        
        // Generate HTML for pending account requests
        let pendingAccountHtml = '';
        if (pendingAccountRequests.length === 0) {
            pendingAccountHtml = `
                <div style="text-align: center; padding: 40px; background: white; border-radius: 20px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üë§</div>
                    <div style="font-size: 16px;">No pending account requests</div>
                </div>
            `;
        } else {
            pendingAccountRequests.forEach(req => {
                const requestedAt = req.requestedAt ? new Date(req.requestedAt).toLocaleString() : 'Unknown';
                
                pendingAccountHtml += `
                    <div style="background: white; border-radius: 24px; padding: 24px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.02); border: 1px solid #f0f0f0; border-left: 6px solid #3498db;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="background: #3498db; color: white; padding: 8px 20px; border-radius: 30px; font-weight: 700; font-size: 14px;">
                                    üë§ NEW ACCOUNT REQUEST
                                </span>
                                <span style="background: #2ecc71; color: white; padding: 6px 16px; border-radius: 30px; font-size: 13px; font-weight: 600;">
                                    STAFF
                                </span>
                            </div>
                            <span style="color: #888; font-size: 13px; background: #f8f9fa; padding: 6px 16px; border-radius: 30px;">
                                üïê ${requestedAt}
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px; margin-bottom: 24px;">
                            <div style="background: #fafbfc; padding: 20px; border-radius: 20px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 10px;">üë§ APPLICANT DETAILS</div>
                                <div style="font-weight: 700; font-size: 18px; margin-bottom: 5px;">${req.fullName || 'Unknown'}</div>
                                <div style="color: #666; font-size: 14px;">@${req.username || 'N/A'}</div>
                                <div style="margin-top: 15px;">
                                    <span style="background: #e8f0fe; padding: 4px 12px; border-radius: 20px; font-size: 12px;">üìß ${req.email || 'No email'}</span>
                                </div>
                            </div>
                            
                            <div style="background: #fafbfc; padding: 20px; border-radius: 20px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 10px;">üìã APPLICATION DETAILS</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <div style="font-size: 11px; color: #888;">NRC</div>
                                        <div style="font-weight: 600;">${req.nrc || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: #888;">Phone</div>
                                        <div style="font-weight: 600;">${req.phone || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: #888;">Institution</div>
                                        <div style="font-weight: 600;">${req.institution || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: #888;">Position</div>
                                        <div style="font-weight: 600;">${req.position || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Documents Section -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 16px; margin-bottom: 20px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 15px;">üìÑ UPLOADED DOCUMENTS</div>
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                ${req.documents?.nrc ? `
                                    <div style="display: flex; align-items: center; gap: 10px; background: white; padding: 10px 15px; border-radius: 40px;">
                                        <span style="font-size: 20px;">ü™™</span>
                                        <span>NRC</span>
                                        <button onclick="viewRequestDocument('${req.id}', 'nrc')" style="background: #3498db; color: white; border: none; padding: 4px 12px; border-radius: 20px; font-size: 11px; cursor: pointer;">View</button>
                                    </div>
                                ` : ''}
                                ${req.documents?.degree ? `
                                    <div style="display: flex; align-items: center; gap: 10px; background: white; padding: 10px 15px; border-radius: 40px;">
                                        <span style="font-size: 20px;">üéì</span>
                                        <span>Degree/Diploma</span>
                                        <button onclick="viewRequestDocument('${req.id}', 'degree')" style="background: #27ae60; color: white; border: none; padding: 4px 12px; border-radius: 20px; font-size: 11px; cursor: pointer;">View</button>
                                    </div>
                                ` : ''}
                                ${req.documents?.zips ? `
                                    <div style="display: flex; align-items: center; gap: 10px; background: white; padding: 10px 15px; border-radius: 40px;">
                                        <span style="font-size: 20px;">üìú</span>
                                        <span>ZIPS</span>
                                        <button onclick="viewRequestDocument('${req.id}', 'zips')" style="background: #e67e22; color: white; border: none; padding: 4px 12px; border-radius: 20px; font-size: 11px; cursor: pointer;">View</button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 16px; justify-content: flex-end; border-top: 1px solid #f0f0f0; padding-top: 24px;">
                            <button onclick="approveAccountRequest('${req.id}')" style="background: #27ae60; color: white; border: none; padding: 14px 32px; border-radius: 40px; font-weight: 700; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.2);">
                                <span style="font-size: 18px;">‚úì</span> APPROVE ACCOUNT
                            </button>
                            <button onclick="openRejectAccountReasonModal('${req.id}')" style="background: #e74c3c; color: white; border: none; padding: 14px 32px; border-radius: 40px; font-weight: 700; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(231, 76, 60, 0.2);">
                                <span style="font-size: 18px;">‚úó</span> REJECT ACCOUNT
                            </button>
                        </div>
                    </div>
                `;
            });
        }
        
        // Generate HTML for pending approval requests (existing code)
        let pendingApprovalHtml = '';
        if (pendingApprovalRequests.length === 0) {
            pendingApprovalHtml = `
                <div style="text-align: center; padding: 40px; background: white; border-radius: 20px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚úÖ</div>
                    <div style="font-size: 16px;">No pending approval requests</div>
                </div>
            `;
        } else {
            pendingApprovalHtml = pendingApprovalRequests.map(req => {
                const created = req.createdDate ? new Date(req.createdDate).toLocaleString() : 'Unknown';
                const actionColor = req.action === 'delete' ? '#e74c3c' : 
                                  req.action === 'edit' ? '#f39c12' : '#3498db';
                
                return `
                    <div style="background: white; border-radius: 24px; padding: 24px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.02); border: 1px solid #f0f0f0; border-left: 6px solid ${actionColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="background: ${actionColor}; color: white; padding: 8px 20px; border-radius: 30px; font-weight: 700; font-size: 14px;">
                                    ‚è≥ ${req.action?.toUpperCase() || 'ACTION'} ¬∑ ${req.type?.toUpperCase() || 'ITEM'}
                                </span>
                                <span style="background: ${req.requestedByRole === 'super admin' ? '#9b59b6' : req.requestedByRole === 'admin' ? '#3498db' : '#2ecc71'}; color: white; padding: 6px 16px; border-radius: 30px; font-size: 13px;">
                                    ${req.requestedByRole?.toUpperCase() || 'STAFF'}
                                </span>
                            </div>
                            <span style="color: #888; font-size: 13px; background: #f8f9fa; padding: 6px 16px; border-radius: 30px;">
                                üïê ${created}
                            </span>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: 600; margin-bottom: 5px;">Requested By: ${req.requestedBy || 'Unknown'}</div>
                            <div style="color: #666; font-size: 14px;">Item: ${req.requestedData?.name || req.oldData?.name || req.itemId || 'N/A'}</div>
                            ${req.reason ? `<div style="margin-top: 10px; padding: 10px; background: #fff8e7; border-radius: 8px; font-size: 13px;"><strong>Reason:</strong> ${req.reason}</div>` : ''}
                        </div>
                        
                        <div style="display: flex; gap: 16px; justify-content: flex-end;">
                            <button onclick="approveRequestNow('${req.id}')" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 30px; font-weight: 600; cursor: pointer;">‚úì APPROVE</button>
                            <button onclick="openRejectReasonModalForRequest('${req.id}')" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 30px; font-weight: 600; cursor: pointer;">‚úó REJECT</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        modal.innerHTML = `
            <div style="background: linear-gradient(145deg, #f8fafc, #f0f4f8); width: 1300px; max-width: 95%; max-height: 90vh; overflow-y: auto; border-radius: 32px; padding: 40px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="background: var(--primary-green); width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 20px;">
                            <span style="font-size: 32px; color: white;">üìã</span>
                        </div>
                        <div>
                            <h2 style="color: #1e3b37; margin: 0; font-size: 28px; font-weight: 700;">Requests Management</h2>
                            <p style="color: #6b9080; margin: 5px 0 0 0; font-size: 15px;">Approve, reject, and track all requests</p>
                        </div>
                    </div>
                    <button onclick="this.closest('.modal').remove()" style="background: white; border: none; width: 48px; height: 48px; border-radius: 16px; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #666; box-shadow: 0 4px 12px rgba(0,0,0,0.02);">
                        ‚úï
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 40px;">
                    <div style="background: white; padding: 28px; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.02);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <span style="font-size: 42px;">üë§</span>
                            <span style="background: #3498db; color: white; padding: 6px 14px; border-radius: 30px; font-size: 13px;">Account</span>
                        </div>
                        <div style="font-size: 44px; font-weight: 800; color: #3498db; margin-bottom: 8px;">${pendingAccountRequests.length}</div>
                        <div style="color: #666;">Pending account requests</div>
                    </div>
                    
                    <div style="background: white; padding: 28px; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.02);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <span style="font-size: 42px;">‚è≥</span>
                            <span style="background: #e67e22; color: white; padding: 6px 14px; border-radius: 30px; font-size: 13px;">Approval</span>
                        </div>
                        <div style="font-size: 44px; font-weight: 800; color: #e67e22; margin-bottom: 8px;">${pendingApprovalRequests.length}</div>
                        <div style="color: #666;">Pending approval requests</div>
                    </div>
                    
                    <div style="background: white; padding: 28px; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.02);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <span style="font-size: 42px;">‚úì</span>
                            <span style="background: #2ecc71; color: white; padding: 6px 14px; border-radius: 30px; font-size: 13px;">Approved</span>
                        </div>
                        <div style="font-size: 44px; font-weight: 800; color: #2ecc71; margin-bottom: 8px;">${approvedCount + historyAccountRequests.filter(r => r.status === 'approved').length}</div>
                        <div style="color: #666;">Approved requests</div>
                    </div>
                    
                    <div style="background: white; padding: 28px; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.02);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <span style="font-size: 42px;">‚úó</span>
                            <span style="background: #e74c3c; color: white; padding: 6px 14px; border-radius: 30px; font-size: 13px;">Rejected</span>
                        </div>
                        <div style="font-size: 44px; font-weight: 800; color: #e74c3c; margin-bottom: 8px;">${rejectedCount + historyAccountRequests.filter(r => r.status === 'rejected').length}</div>
                        <div style="color: #666;">Rejected requests</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 16px; margin-bottom: 30px; border-bottom: 2px solid #e9ecef; padding-bottom: 16px;">
                    <button id="accountTabBtn" onclick="showAccountRequestsTab()" style="background: #3498db; color: white; border: none; padding: 14px 32px; border-radius: 40px; font-weight: 700; font-size: 15px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <span>üë§</span> ACCOUNT REQUESTS (${pendingAccountRequests.length})
                    </button>
                    <button id="approvalTabBtn" onclick="showApprovalRequestsTab()" style="background: #e67e22; color: white; border: none; padding: 14px 32px; border-radius: 40px; font-weight: 700; font-size: 15px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <span>‚è≥</span> APPROVAL REQUESTS (${pendingApprovalRequests.length})
                    </button>
                </div>
                
                <div id="accountRequestsSection" style="display: block;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">üë§ Pending Account Requests</h3>
                    <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
                        ${pendingAccountHtml}
                    </div>
                </div>
                
                <div id="approvalRequestsSection" style="display: none;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">‚è≥ Pending Approval Requests</h3>
                    <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
                        ${pendingApprovalHtml}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to load requests: ' + error.message);
    }
}

// ========== NEW: Tab switching functions ==========
function showAccountRequestsTab() {
    const accountSection = document.getElementById('accountRequestsSection');
    const approvalSection = document.getElementById('approvalRequestsSection');
    const accountBtn = document.getElementById('accountTabBtn');
    const approvalBtn = document.getElementById('approvalTabBtn');
    
    if (accountSection && approvalSection) {
        accountSection.style.display = 'block';
        approvalSection.style.display = 'none';
        accountBtn.style.background = '#3498db';
        approvalBtn.style.background = '#34495e';
    }
}

function showApprovalRequestsTab() {
    const accountSection = document.getElementById('accountRequestsSection');
    const approvalSection = document.getElementById('approvalRequestsSection');
    const accountBtn = document.getElementById('accountTabBtn');
    const approvalBtn = document.getElementById('approvalTabBtn');
    
    if (accountSection && approvalSection) {
        accountSection.style.display = 'none';
        approvalSection.style.display = 'block';
        accountBtn.style.background = '#34495e';
        approvalBtn.style.background = '#e67e22';
    }
}

// ========== FIX: Document viewer for account requests ==========
async function viewRequestDocument(requestId, docType) {
    try {
        const doc = await db.collection('account_requests').doc(requestId).get();
        if (!doc.exists) {
            alert('Request not found');
            return;
        }
        
        const requestData = doc.data();
        
        if (!requestData.documents || !requestData.documents[docType]) {
            alert(`No ${docType} document found for this request`);
            return;
        }
        
        const documentData = requestData.documents[docType];
        
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'requestDocumentViewerModal';
        modal.style.display = 'flex';
        modal.style.zIndex = '60000';
        
        const isImage = documentData.type && 
                       (documentData.type.startsWith('image/') || 
                        documentData.name?.match(/\.(jpg|jpeg|png|gif|webp)$/i));
        
        const titleMap = {
            nrc: 'ü™™ NRC Document',
            degree: 'üéì Degree/Diploma Certificate',
            zips: 'üìú ZIPS Membership Certificate'
        };
        
        modal.innerHTML = `
            <div style="background: white; width: 90%; max-width: 1000px; height: 90vh; border-radius: 24px; overflow: hidden; display: flex; flex-direction: column;">
                <div style="background: var(--primary-green); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                        ${titleMap[docType] || 'Document'} - ${requestData.fullName || requestData.username}
                    </h3>
                    <button onclick="this.closest('.modal').remove()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">‚úï</button>
                </div>
                <div style="flex: 1; padding: 20px; overflow: auto; background: #f5f5f5; display: flex; flex-direction: column; align-items: center;">
                    ${isImage ? `
                        <img src="${documentData.data}" style="max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px; width: 100%; max-width: 600px;">
                            <p><strong>File Name:</strong> ${documentData.name}</p>
                            <p><strong>Uploaded:</strong> ${new Date(documentData.uploadedAt).toLocaleString()}</p>
                            <p><strong>File Size:</strong> ${(documentData.size / 1024).toFixed(1)} KB</p>
                        </div>
                    ` : `
                        <iframe src="${documentData.data}" style="width: 100%; height: 80vh; border: none; border-radius: 8px;"></iframe>
                        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px; width: 100%;">
                            <p><strong>File Name:</strong> ${documentData.name}</p>
                            <p><strong>Uploaded:</strong> ${new Date(documentData.uploadedAt).toLocaleString()}</p>
                            <p><strong>File Size:</strong> ${(documentData.size / 1024).toFixed(1)} KB</p>
                        </div>
                    `}
                </div>
                <div style="padding: 20px; background: #f8f9fa; border-top: 1px solid #dee2e6; display: flex; gap: 10px; justify-content: flex-end;">
                    <a href="${documentData.data}" download="${documentData.name}" style="background: var(--primary-green); color: white; border: none; padding: 10px 25px; border-radius: 30px; text-decoration: none; font-weight: 600; cursor: pointer;">üì• Download</a>
                    <button onclick="this.closest('.modal').remove()" style="background: #95a5a6; color: white; border: none; padding: 10px 25px; border-radius: 30px; font-weight: 600; cursor: pointer;">Close</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error viewing document:', error);
        alert('Failed to view document: ' + error.message);
    }
}

// ========== FIX: Approve account request ==========
async function approveAccountRequest(requestId) {
    try {
        const doc = await db.collection('account_requests').doc(requestId).get();
        if (!doc.exists) {
            alert('Request not found');
            return;
        }
        
        const requestData = doc.data();
        
        // Safe defaults
        const newUser = {
            fullName: requestData.fullName || 'Unknown User',
            username: requestData.username || 'unknown',
            password: requestData.password || 'default123',
            role: 'staff',
            nrc: requestData.nrc || '',
            phone: requestData.phone || '',
            institution: requestData.institution || '',
            position: requestData.position || '',
            email: requestData.email || '',
            documents: requestData.documents || {},
            enabled: true,
            createdAt: new Date().toISOString(),
            lastActive: null
        };

        await db.collection(COLLECTIONS.USERS).add(newUser);
        await db.collection('account_requests').doc(requestId).update({
            status: 'approved',
            approvedAt: new Date().toISOString(),
            approvedBy: getCurrentUser()
        });

        await logAudit('ACCOUNT_APPROVED', {
            username: requestData.username,
            fullName: requestData.fullName,
            email: requestData.email,
            approvedBy: getCurrentUser()
        });

        showNotification(`Account for ${requestData.fullName || requestData.username} approved successfully`, 'success');

        const modal = document.getElementById('requestsManagementModal');
        if (modal) modal.remove();
        
        if (typeof openRequestsManagement === 'function') {
            openRequestsManagement();
        }

    } catch (error) {
        console.error('Error approving account:', error);
        alert('Failed to approve account: ' + error.message);
    }
}

// ========== FIX: Reject account request functions ==========
let pendingAccountRejectId = null;

function openRejectAccountReasonModal(requestId) {
    pendingAccountRejectId = requestId;
    
    const existingModal = document.getElementById('rejectAccountReasonModal');
    if (existingModal) existingModal.remove();
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'rejectAccountReasonModal';
    modal.style.display = 'flex';
    
    modal.innerHTML = `
        <div class="reject-modal-content" style="border-radius: 24px; padding: 30px;">
            <h3 style="color: var(--danger-red); margin-bottom: 20px; text-align: center;">‚úó Reject Account Request</h3>
            <p style="color: #666; margin-bottom: 15px;">Please provide a reason for rejecting this account request:</p>
            <textarea id="accountRejectReason" class="reject-textarea" placeholder="Enter rejection reason..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; min-height: 100px;"></textarea>
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="btn" style="flex: 1; background: var(--danger-red);" onclick="submitAccountRejection('${requestId}')">Confirm Rejection</button>
                <button class="btn" style="flex: 1; background: #95a5a6;" onclick="closeRejectAccountModal()">Cancel</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

async function submitAccountRejection(requestId) {
    const reason = document.getElementById('accountRejectReason')?.value.trim();
    
    if (!reason) {
        alert('Please provide a rejection reason');
        return;
    }
    
    try {
        const doc = await db.collection('account_requests').doc(requestId).get();
        if (!doc.exists) {
            alert('Request not found');
            return;
        }
        
        const requestData = doc.data();

        await db.collection('account_requests').doc(requestId).update({
            status: 'rejected',
            rejectedAt: new Date().toISOString(),
            rejectedBy: getCurrentUser(),
            rejectionReason: reason
        });

        await logAudit('ACCOUNT_REJECTED', {
            username: requestData.username,
            fullName: requestData.fullName,
            email: requestData.email,
            rejectedBy: getCurrentUser(),
            reason: reason
        });

        closeRejectAccountModal();
        
        const modal = document.getElementById('requestsManagementModal');
        if (modal) modal.remove();
        
        if (typeof openRequestsManagement === 'function') {
            openRequestsManagement();
        }
        
        showNotification(`Account request for ${requestData.fullName || requestData.username} rejected`, 'info');
        
    } catch (error) {
        console.error('Error rejecting account:', error);
        alert('Failed to reject account: ' + error.message);
    }
}

function closeRejectAccountModal() {
    const modal = document.getElementById('rejectAccountReasonModal');
    if (modal) modal.remove();
    pendingAccountRejectId = null;
}

// ========== NEW: Approve account request ==========
async function approveAccountRequest(requestId) {
    try {
        // Get the request data
        const doc = await db.collection('account_requests').doc(requestId).get();
        if (!doc.exists) {
            alert('Request not found');
            return;
        }
        
        const requestData = doc.data();
        
        // Create new user
        const newUser = {
            fullName: requestData.fullName,
            username: requestData.username,
            password: requestData.password,
            role: 'staff',
            nrc: requestData.nrc,
            phone: requestData.phone,
            institution: requestData.institution,
            position: requestData.position,
            email: requestData.email,
            documents: requestData.documents,
            enabled: true,
            createdAt: new Date().toISOString(),
            lastActive: null,
            createdBy: 'SYSTEM_APPROVAL'
        };

        // Add user to users collection
        await db.collection(COLLECTIONS.USERS).add(newUser);

        // Update request status
        await db.collection('account_requests').doc(requestId).update({
            status: 'approved',
            approvedAt: new Date().toISOString(),
            approvedBy: getCurrentUser()
        });

        // Log the approval
        await logAudit('ACCOUNT_APPROVED', {
            username: requestData.username,
            fullName: requestData.fullName,
            email: requestData.email,
            approvedBy: getCurrentUser()
        });

        // Send email notification
        sendApprovalEmail(requestData.email, requestData.fullName, requestData.username);

        // Refresh the modal
        const modal = document.getElementById('requestsManagementModal');
        if (modal) modal.remove();
        
        openRequestsManagement();
        
        showNotification(`Account for ${requestData.fullName} approved successfully`, 'success');
        
    } catch (error) {
        console.error('Error approving account:', error);
        alert('Failed to approve account: ' + error.message);
    }
}

// ========== NEW: Reject account request ==========
async function submitAccountRejection(requestId) {
    const reason = document.getElementById('accountRejectReason')?.value.trim();
    
    if (!reason) {
        alert('Please provide a rejection reason');
        return;
    }
    
    try {
        // Get the request data
        const doc = await db.collection('account_requests').doc(requestId).get();
        if (!doc.exists) {
            alert('Request not found');
            return;
        }
        
        const requestData = doc.data();

        // Update request status
        await db.collection('account_requests').doc(requestId).update({
            status: 'rejected',
            rejectedAt: new Date().toISOString(),
            rejectedBy: getCurrentUser(),
            rejectionReason: reason
        });

        // Log the rejection
        await logAudit('ACCOUNT_REJECTED', {
            username: requestData.username,
            fullName: requestData.fullName,
            email: requestData.email,
            rejectedBy: getCurrentUser(),
            reason: reason
        });

        // Send rejection email
        sendRejectionEmail(requestData.email, requestData.fullName, reason);

        // Close modals
        closeRejectAccountModal();
        
        const modal = document.getElementById('requestsManagementModal');
        if (modal) modal.remove();
        
        openRequestsManagement();
        
        showNotification(`Account request for ${requestData.fullName} rejected`, 'info');
        
    } catch (error) {
        console.error('Error rejecting account:', error);
        alert('Failed to reject account: ' + error.message);
    }
}

// ========== NEW: Enhanced email functions ==========
function sendApprovalEmail(email, fullName, username) {
    console.log(`[EMAIL] Account approved for ${fullName} (${username}) at ${email}`);
    
    // Create email content
    const subject = "Your Zed Supplier Directory Account Has Been Approved";
    const body = `Dear ${fullName},

Your account request for the Zed Supplier Directory has been APPROVED!

Login Details:
- Username: ${username}
- Role: Staff

You can now login to the system using your credentials.

Thank you for joining Zed Supplier Directory.

Best regards,
ZAMCOM Procurement Team`;

    // For demo purposes, show alert
    alert(`DEMO: Approval email would be sent to ${email}\n\nSubject: ${subject}\n\nBody: ${body}`);
    
    // TODO: Implement actual email sending using EmailJS or similar service
}

function sendRejectionEmail(email, fullName, reason) {
    console.log(`[EMAIL] Account rejected for ${fullName} at ${email}. Reason: ${reason}`);
    
    // Create email content
    const subject = "Your Zed Supplier Directory Account Request";
    const body = `Dear ${fullName},

Your account request for the Zed Supplier Directory has been REJECTED.

Reason for rejection:
${reason}

If you believe this is an error, please contact the system administrator.

Best regards,
ZAMCOM Procurement Team`;

    // For demo purposes, show alert
    alert(`DEMO: Rejection email would be sent to ${email}\n\nSubject: ${subject}\n\nBody: ${body}`);
    
    // TODO: Implement actual email sending using EmailJS or similar service
}

    window.showPendingTab = function() {
        const pending = document.getElementById('pendingSection');
        const history = document.getElementById('historySection');
        const pendingBtn = document.getElementById('pendingTabBtn');
        const historyBtn = document.getElementById('historyTabBtn');
        
        if (pending && history) {
            pending.style.display = 'block';
            history.style.display = 'none';
            pendingBtn.style.background = '#e67e22';
            historyBtn.style.background = '#34495e';
        }
    };

    window.showHistoryTab = function() {
        const pending = document.getElementById('pendingSection');
        const history = document.getElementById('historySection');
        const pendingBtn = document.getElementById('pendingTabBtn');
        const historyBtn = document.getElementById('historyTabBtn');
        
        if (pending && history) {
            pending.style.display = 'none';
            history.style.display = 'block';
            pendingBtn.style.background = '#34495e';
            historyBtn.style.background = '#e67e22';
        }
    };

    function openAccountRequestModal() {
    // Reset form
    document.getElementById('requestFullName').value = '';
    document.getElementById('requestUsername').value = '';
    document.getElementById('requestNrc').value = '';
    document.getElementById('requestPhone').value = '';
    document.getElementById('requestInstitution').value = '';
    document.getElementById('requestPosition').value = '';
    document.getElementById('requestEmail').value = '';
    document.getElementById('requestPassword').value = '';
    
    // Reset document previews
    ['requestNrcDocPreview', 'requestDegreeDocPreview', 'requestZipsDocPreview'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
    });
    
    // Reset documents
    requestDocuments = { nrc: null, degree: null, zips: null };
    
    // Show modal
    document.getElementById('accountRequestModal').style.display = 'flex';
    
    // Hide login overlay
    document.getElementById('loginOverlay').style.display = 'none';
}

function closeAccountRequestModal() {
    document.getElementById('accountRequestModal').style.display = 'none';
    document.getElementById('loginOverlay').style.display = 'flex';
}

function handleRequestDocumentUpload(docType, input) {
    const file = input.files[0];
    if (!file) return;
    
    if (file.size > 3 * 1024 * 1024) {
        alert(`File size exceeds 3MB limit for ${docType} document`);
        input.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        requestDocuments[docType] = {
            name: file.name,
            type: file.type,
            size: file.size,
            data: e.target.result,
            uploadedAt: new Date().toISOString()
        };
        
        const previewEl = document.getElementById(`request${docType.charAt(0).toUpperCase() + docType.slice(1)}DocPreview`);
        if (previewEl) {
            previewEl.innerHTML = `<span style="color: var(--primary-green);">‚úì ${file.name.substring(0, 20)}${file.name.length > 20 ? '...' : ''}</span>`;
        }
    };
    reader.readAsDataURL(file);
}

async function submitAccountRequest() {
    // Get form values
    const fullName = document.getElementById('requestFullName').value.trim();
    const username = document.getElementById('requestUsername').value.toUpperCase().trim();
    const nrc = document.getElementById('requestNrc').value.trim();
    const phone = document.getElementById('requestPhone').value.trim();
    const institution = document.getElementById('requestInstitution').value.trim();
    const position = document.getElementById('requestPosition').value.trim();
    const email = document.getElementById('requestEmail').value.trim();
    const password = document.getElementById('requestPassword').value.trim();

    // Validate required fields
    const missingFields = [];
    if (!fullName) missingFields.push('Full Name');
    if (!username) missingFields.push('Username');
    if (!nrc) missingFields.push('NRC');
    if (!phone) missingFields.push('Phone Number');
    if (!institution) missingFields.push('Institution');
    if (!position) missingFields.push('Position');
    if (!email) missingFields.push('Email');
    if (!password) missingFields.push('Password');

    if (missingFields.length > 0) {
        alert(`Please fill in all required fields: ${missingFields.join(', ')}`);
        return;
    }

    // Validate documents
    const missingDocs = [];
    if (!requestDocuments.nrc) missingDocs.push('NRC');
    if (!requestDocuments.degree) missingDocs.push('Degree/Diploma');
    if (!requestDocuments.zips) missingDocs.push('ZIPS Certificate');

    if (missingDocs.length > 0) {
        alert(`Please upload all required documents: ${missingDocs.join(', ')}`);
        return;
    }

    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert('Please enter a valid email address');
        return;
    }

    // Validate phone number (basic)
    if (phone.length < 10) {
        alert('Please enter a valid phone number');
        return;
    }

    // Create request data
    const requestData = {
        fullName,
        username,
        nrc,
        phone,
        institution,
        position,
        email,
        password,
        documents: {
            nrc: requestDocuments.nrc,
            degree: requestDocuments.degree,
            zips: requestDocuments.zips
        },
        requestedAt: new Date().toISOString(),
        status: 'pending',
        role: 'staff' // All account requests are for staff role
    };

    try {
        // Save to Firestore
        await db.collection('account_requests').add(requestData);
        
        // Log the request
        await logAudit('ACCOUNT_REQUEST', {
            username,
            fullName,
            email,
            requestedAt: new Date().toISOString()
        });
        
        alert('Your account request has been submitted successfully! You will receive an email once your account is approved.');
        closeAccountRequestModal();
    } catch (error) {
        console.error('Error submitting account request:', error);
        alert('Failed to submit account request. Please try again.');
    }
}

    function closeRequestsManagement() {
        const modal = document.getElementById('requestsManagementModal');
        if (modal) modal.remove();
    }

    // ========== REJECT REASON MODAL FUNCTIONS ==========
    function openRejectReasonModalForRequest(requestId) {
        document.getElementById('pendingRejectRequestId').value = requestId;
        document.getElementById('rejectReasonText').value = '';
        document.getElementById('rejectReasonModal').style.display = 'flex';
    }

    function openRejectReasonModal() {
        document.getElementById('rejectReasonText').value = '';
        document.getElementById('rejectReasonModal').style.display = 'flex';
    }

    function closeRejectReasonModal() {
        document.getElementById('rejectReasonModal').style.display = 'none';
        document.getElementById('pendingRejectRequestId').value = '';
        document.getElementById('rejectReasonText').value = '';
    }

    // Fixed submitRejectionReason function to properly store rejection reason
    async function submitRejectionReason() {
        const requestId = document.getElementById('pendingRejectRequestId').value || localStorage.getItem('currentApprovalRequestId');
        const reason = document.getElementById('rejectReasonText').value.trim();
        
        if (!reason) {
            alert('Please provide a reason for rejection');
            return;
        }

        try {
            const docRef = db.collection(COLLECTIONS.APPROVALS).doc(requestId);
            
            await docRef.update({
                status: 'rejected',
                reviewedBy: getCurrentUser(),
                reviewedAt: new Date().toISOString(),
                rejectionReason: reason,  // Store as rejectionReason
                rejectionDate: new Date().toISOString()
            });

            await logAudit('APPROVAL_REJECTED', {
                requestId: requestId,
                reason: reason,
                reviewedBy: getCurrentUser()
            });

            showNotification('Request rejected successfully', 'success');
            
            closeRejectReasonModal();
            document.getElementById('approvalActionModal').style.display = 'none';
            document.getElementById('approvalRequestsModal').style.display = 'none';
            
            const modal = document.getElementById('requestsManagementModal');
            if (modal) modal.remove();
            
            await loadAllData(true);
            await loadApprovalRequests();
            
            const currentUser = getUser(getCurrentUser());
            if (currentUser && currentUser.role !== 'super admin') {
                await loadUserApprovalHistory();
            }
            
            renderCategories();
            applyRoleBasedUI();

        } catch (error) {
            console.error('Error:', error);
            alert('Failed to reject request: ' + error.message);
        }
    }

    // ========== UPDATE USER MANAGEMENT TABLE ==========
    // Replace the existing user management table rendering section

    function renderUserManagementTable() {
        const tbody = document.getElementById('userMgmtTableBody');
        const currentUser = getUser(getCurrentUser());
        
        if (!currentUser) return;

        let html = '';

        for (let u of userAccounts) {
            // Filter users based on role
            if (currentUser.role === 'staff' && u.role !== 'staff') continue;
            if (currentUser.role === 'admin' && u.role === 'super admin') continue;

            const status = u.enabled ? 
                '<span style="color:green; font-weight:bold;">Enabled</span>' : 
                '<span style="color:red; font-weight:bold;">Disabled</span>';

            // Check permissions
            const canEdit = (currentUser.role === 'super admin') || 
                           (currentUser.role === 'admin' && u.role !== 'super admin') ||
                           (currentUser.role === 'staff' && u.role === 'staff');

            const canDelete = (currentUser.role === 'super admin' && !isJoseph(u.username)) ||
                             (currentUser.role === 'admin' && u.role === 'staff') ||
                             (currentUser.role === 'staff' && u.role === 'staff' && !isJoseph(u.username));

            // Mask sensitive data for non-super admin
            let displayPhone = u.phone || '';
            let displayInfo = '';

            if (currentUser.role === 'super admin') {
                displayInfo = `
                    <div style="font-size: 11px; color: #666;">
                        ${u.email || ''}<br>
                        NRC: ${u.nrc || ''}
                    </div>
                `;
            } else {
                displayInfo = `
                    <div style="font-size: 11px; color: #999;">
                        ********
                    </div>
                `;
            }

            // Create document thumbnail
            const docThumbnail = createDocumentThumbnail(u.documents, 'user', u.id, u.fullName || u.username);

            html += `
                <tr>
                    <td>
                        <div style="font-weight: 600;">${u.fullName || u.username}</div>
                        <div style="font-size: 11px; color: #666;">@${u.username}</div>
                        ${isJoseph(u.username) ? '<span style="color: #f39c12; font-size: 10px;">üîí Protected</span>' : ''}
                    </td>
                    <td>
                        <span class="role-badge" style="background: ${
                            u.role === 'super admin' ? '#9b59b6' : 
                            u.role === 'admin' ? '#3498db' : '#2ecc71'
                        }">
                            ${u.role}
                        </span>
                    </td>
                    <td>${displayPhone}</td>
                    <td>
                        ${displayInfo}
                    </td>
                    <td>
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            ${status}
                            ${docThumbnail}
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${canEdit ? 
                                `<button class="btn-edit" onclick="openEditUserModal('${u.id}')">
                                    <span>‚úèÔ∏è</span> Edit
                                </button>` : ''
                            }
                            ${canDelete ? 
                                `<button class="btn-del" onclick="deleteUser('${u.id}')">
                                    <span>üóëÔ∏è</span> Delete
                                </button>` : ''
                            }
                        </div>
                    </td>
                </tr>
            `;
        }

        tbody.innerHTML = html;
    }


    // Enhanced renderUserApprovalHistory to show rejection reasons properly
    function renderUserApprovalHistory(requests, filter) {
        const container = document.getElementById('userApprovalHistoryContainer');
        
        if (requests.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üì≠</div>
                    <div style="font-size: 18px; font-weight: 500;">
                        ${filter === 'pending' ? 'No pending requests' : 'No request history'}
                    </div>
                </div>
            `;
            return;
        }

        let html = '';
        requests.forEach(req => {
            const created = req.createdAt ? 
                (req.createdAt.toDate ? req.createdAt.toDate().toLocaleString() : new Date(req.createdAt).toLocaleString()) 
                : 'Unknown';
            
            // Determine the status and its color
            const status = req.status || 'pending';
            const statusColor = status === 'approved' ? '#2ecc71' : 
                              status === 'rejected' ? '#e74c3c' : '#f39c12';
            const statusBg = status === 'approved' ? '#e8f8f5' : 
                            status === 'rejected' ? '#fee9e7' : '#fef5e7';
            
            // Action color based on action type
            const actionColor = req.action === 'delete' ? '#e74c3c' : 
                              req.action === 'edit' ? '#f39c12' : '#3498db';
            
            // Get the appropriate reason (submission reason or rejection reason)
            const submissionReason = req.reason || '';
            const rejectionReason = req.rejectionReason || '';
            const reviewedBy = req.reviewedBy || 'System';
            const reviewedAt = req.reviewedAt ? new Date(req.reviewedAt).toLocaleString() : '';
            
            // Build change summary if available
            let changeSummaryHtml = '';
            if (req.changeSummary && req.changeSummary.length > 0 && status !== 'pending') {
                changeSummaryHtml = `
                    <div style="margin-top: 12px; background: #f8f9fa; padding: 12px; border-radius: 8px;">
                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px; font-size: 12px;">üìã CHANGES THAT WERE APPLIED:</div>
                        ${req.changeSummary.map(change => {
                            if (change.type === 'object' && change.nestedChanges) {
                                return `
                                    <div style="margin-bottom: 8px;">
                                        <span style="font-weight: bold; color: #e67e22;">${change.field}:</span>
                                        ${change.nestedChanges.map(n => `
                                            <div style="margin-left: 15px; font-size: 11px;">
                                                ${n.field}: <span style="color: #e74c3c;">${n.oldValue}</span> ‚Üí <span style="color: #27ae60;">${n.newValue}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;
                            } else {
                                return `
                                    <div style="margin-bottom: 5px; font-size: 11px;">
                                        <span style="font-weight: bold;">${change.field}:</span> 
                                        <span style="color: #e74c3c;">${change.oldValue}</span> ‚Üí 
                                        <span style="color: #27ae60;">${change.newValue}</span>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                `;
            }
            
            html += `
                <div style="background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid #e0e0e0; border-left: 6px solid ${actionColor};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <span style="background: ${statusColor}; color: white; padding: 6px 16px; border-radius: 30px; font-size: 12px; font-weight: 700; display: inline-block;">
                                ${status.toUpperCase()}
                            </span>
                            <span style="margin-left: 12px; font-weight: 600; color: #2c3e50; background: ${statusBg}; padding: 6px 16px; border-radius: 30px; display: inline-block;">
                                ${req.action?.toUpperCase()} - ${req.type?.toUpperCase()}
                            </span>
                        </div>
                        <span style="color: #888; font-size: 12px; background: #f8f9fa; padding: 4px 12px; border-radius: 20px;">${created}</span>
                    </div>
                    
                    <div style="margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 12px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">üì¶ ITEM</div>
                                <div style="font-weight: 600;">${req.requestedData?.name || req.oldData?.name || req.itemId || 'N/A'}</div>
                                <div style="font-size: 11px; color: #999; margin-top: 4px;">ID: ${req.itemId?.substring(0, 8) || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">üë§ REQUESTED BY</div>
                                <div style="font-weight: 600;">${req.requestedBy || 'Unknown'}</div>
                                <span class="role-badge" style="background: ${req.requestedByRole === 'super admin' ? '#9b59b6' : req.requestedByRole === 'admin' ? '#3498db' : '#2ecc71'}; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block; margin-top: 4px;">
                                    ${req.requestedByRole || 'staff'}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    ${submissionReason && status === 'pending' ? `
                    <div style="background: #fef5e7; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #f39c12;">
                        <span style="font-weight: 600; color: #f39c12;">üìù REASON PROVIDED:</span>
                        <p style="margin: 5px 0 0 0; color: #333; font-size: 13px;">${submissionReason}</p>
                    </div>
                    ` : ''}
                    
                    ${status === 'rejected' && rejectionReason ? `
                    <div style="background: #fee9e7; padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #e74c3c;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="background: #e74c3c; color: white; padding: 4px 12px; border-radius: 30px; font-size: 11px; font-weight: 700;">‚úó REJECTION REASON</span>
                            <span style="font-size: 11px; color: #666;">By ${reviewedBy}</span>
                        </div>
                        <p style="margin: 0; color: #2c3e50; font-size: 14px; font-weight: 500;">${rejectionReason}</p>
                        ${reviewedAt ? `<div style="margin-top: 8px; font-size: 11px; color: #999;">Rejected on: ${reviewedAt}</div>` : ''}
                    </div>
                    ` : ''}
                    
                    ${status === 'approved' && reviewedBy ? `
                    <div style="background: #e8f8f5; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #2ecc71;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: #2ecc71; color: white; padding: 4px 12px; border-radius: 30px; font-size: 11px; font-weight: 700;">‚úì APPROVED</span>
                            <span style="font-size: 11px; color: #666;">By ${reviewedBy}</span>
                        </div>
                        ${reviewedAt ? `<div style="margin-top: 8px; font-size: 11px; color: #999;">Approved on: ${reviewedAt}</div>` : ''}
                    </div>
                    ` : ''}
                    
                    ${changeSummaryHtml}
                    
                    ${status === 'pending' ? `
                    <div style="margin-top: 12px; font-size: 12px; color: #e67e22; background: #fef5e7; padding: 10px 15px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">‚è≥</span>
                        <span>This request is awaiting approval</span>
                    </div>
                    ` : ''}
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    // Enhanced renderRequestsManagement to show rejection reasons in history tab
    function renderRequestsManagementHistory(requests) {
        let historyHtml = '';
        if (requests.length === 0) {
            historyHtml = `
                <div style="text-align: center; padding: 60px; background: white; border-radius: 20px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üì≠</div>
                    <div style="font-size: 18px; font-weight: 500;">No request history</div>
                </div>
            `;
        } else {
            requests.slice(0, 20).forEach(req => {
                const created = req.createdAt ? 
                    (req.createdAt.toDate ? req.createdAt.toDate().toLocaleString() : new Date(req.createdAt).toLocaleString()) 
                    : 'Unknown';
                const statusColor = req.status === 'approved' ? '#2ecc71' : '#e74c3c';
                const statusBg = req.status === 'approved' ? '#e8f8f0' : '#fee9e7';
                
                // Get the appropriate reason based on status
                const displayReason = req.status === 'rejected' ? 
                    (req.rejectionReason || req.reason || 'No reason provided') : 
                    (req.reason || 'No reason provided');
                
                const reviewedBy = req.reviewedBy || 'System';
                const reviewedAt = req.reviewedAt ? new Date(req.reviewedAt).toLocaleString() : '';
                
                historyHtml += `
                    <div style="background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid #f0f0f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <div style="background: ${statusBg}; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 16px; font-size: 24px;">
                                    ${req.status === 'approved' ? '‚úì' : '‚úó'}
                                </div>
                                <div>
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="background: ${statusColor}; color: white; padding: 4px 14px; border-radius: 30px; font-size: 12px; font-weight: 700;">
                                            ${req.status.toUpperCase()}
                                        </span>
                                        <span style="color: #666; font-size: 12px;">${req.action?.toUpperCase()} ¬∑ ${req.type?.toUpperCase()}</span>
                                    </div>
                                    <div style="display: flex; gap: 20px; font-size: 13px;">
                                        <span style="color: #555;">üë§ Requested: ${req.requestedBy}</span>
                                        <span style="color: #555;">‚úì Reviewed: ${reviewedBy}</span>
                                    </div>
                                </div>
                            </div>
                            <div style="color: #888; font-size: 12px; background: #f8f9fa; padding: 4px 12px; border-radius: 20px;">
                                ${created}
                            </div>
                        </div>
                        
                        ${req.status === 'rejected' ? `
                        <div style="background: #fee9e7; padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #e74c3c;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                <span style="background: #e74c3c; color: white; padding: 2px 12px; border-radius: 30px; font-size: 11px; font-weight: 700;">‚úó REJECTION REASON</span>
                                <span style="font-size: 11px; color: #666;">By ${reviewedBy} ${reviewedAt ? 'on ' + reviewedAt : ''}</span>
                            </div>
                            <p style="margin: 8px 0 0 0; color: #2c3e50; font-size: 14px; font-weight: 500;">${displayReason}</p>
                        </div>
                        ` : req.status === 'approved' ? `
                        <div style="background: #e8f8f5; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #2ecc71;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="background: #2ecc71; color: white; padding: 2px 12px; border-radius: 30px; font-size: 11px; font-weight: 700;">‚úì APPROVED</span>
                                <span style="font-size: 11px; color: #666;">By ${reviewedBy} ${reviewedAt ? 'on ' + reviewedAt : ''}</span>
                            </div>
                            ${req.reason ? `
                            <p style="margin: 8px 0 0 0; color: #666; font-size: 13px; background: white; padding: 8px; border-radius: 4px;">
                                <strong>Reason provided:</strong> ${req.reason}
                            </p>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        ${req.changeSummary && req.changeSummary.length > 0 ? `
                        <div style="margin-top: 12px; background: #f8f9fa; padding: 12px; border-radius: 8px;">
                            <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">üìã Changes:</div>
                            ${req.changeSummary.map(change => `
                                <div style="font-size: 12px; margin-bottom: 3px;">
                                    ${change.field}: <span style="color: #e74c3c;">${change.oldValue}</span> ‚Üí <span style="color: #27ae60;">${change.newValue}</span>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                `;
            });
        }
        
        return historyHtml;
    }

    // ========== FIXED: USER APPROVAL HISTORY - NO INDEX REQUIRED ==========
    async function openUserApprovalHistory() {
        const currentUser = getUser(getCurrentUser());
        // Super admin should NOT see the My Requests tab - they use Requests Management
        if (currentUser && currentUser.role === 'super admin') {
            showNotification('Super admin: Please use Requests Management to view all requests', 'info');
            openRequestsManagement();
            return;
        }
        
        showView('userApprovalHistory');
        await loadUserApprovalHistory('pending');
    }

    async function loadUserApprovalHistory(filter = 'pending') {
        const currentUser = getCurrentUser();
        if (!currentUser) return;
        
        const container = document.getElementById('userApprovalHistoryContainer');
        if (!container) return;
        
        try {
            console.log(`Loading ${filter} requests for user: ${currentUser}`);
            
            // First, get all requests for this user (no composite index required)
            const snapshot = await db.collection(COLLECTIONS.APPROVALS)
                .where('requestedBy', '==', currentUser)
                .get();
            
            console.log(`Found ${snapshot.docs.length} total requests for user`);
            
            let userRequests = snapshot.docs.map(doc => ({ 
                id: doc.id, 
                ...doc.data() 
            }));
            
            // Filter by status in JavaScript (client-side)
            if (filter === 'pending') {
                userRequests = userRequests.filter(req => req.status === 'pending');
            } else {
                userRequests = userRequests.filter(req => 
                    req.status === 'approved' || req.status === 'rejected'
                );
            }
            
            // Sort by createdAt (newest first) in JavaScript
            userRequests.sort((a, b) => {
                const dateA = a.createdAt?.toDate?.() || new Date(a.createdAt || 0);
                const dateB = b.createdAt?.toDate?.() || new Date(b.createdAt || 0);
                return dateB - dateA;
            });
            
            renderUserApprovalHistory(userRequests, filter);
            
        } catch (error) {
            console.error('Error loading user approval history:', error);
            container.innerHTML = `
                <div style="text-align: center; padding: 60px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                    <div style="font-size: 18px; font-weight: 500;">Failed to load requests</div>
                    <div style="font-size: 14px; color: #999; margin-top: 10px;">${error.message}</div>
                    <button onclick="loadUserApprovalHistory('${filter}')" class="btn" style="margin-top: 20px; background: var(--primary-green);">Retry</button>
                    <p style="margin-top: 20px; font-size: 12px; color: #f39c12;">
                        ‚ö†Ô∏è Please contact super admin to create the required Firestore indexes.
                    </p>
                </div>
            `;
        }
    }

    function renderUserApprovalHistory(requests, filter) {
        const container = document.getElementById('userApprovalHistoryContainer');
        
        if (requests.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üì≠</div>
                    <div style="font-size: 18px; font-weight: 500;">
                        ${filter === 'pending' ? 'No pending requests' : 'No request history'}
                    </div>
                </div>
            `;
            return;
        }

        let html = '';
        requests.forEach(req => {
            const created = req.createdAt ? 
                (req.createdAt.toDate ? req.createdAt.toDate().toLocaleString() : new Date(req.createdAt).toLocaleString()) 
                : 'Unknown';
            const actionColor = req.action === 'delete' ? '#e74c3c' : 
                              req.action === 'edit' ? '#f39c12' : '#3498db';
            const statusColor = req.status === 'approved' ? '#2ecc71' : 
                              req.status === 'rejected' ? '#e74c3c' : '#f39c12';
            
            const rejectionReason = req.rejectionReason || '';
            
            html += `
                <div style="background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid #e0e0e0; border-left: 6px solid ${actionColor};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 30px; font-size: 12px; font-weight: 700;">
                                ${req.status?.toUpperCase() || 'PENDING'}
                            </span>
                            <span style="margin-left: 12px; font-weight: 600; color: #2c3e50;">
                                ${req.action?.toUpperCase()} - ${req.type?.toUpperCase()}
                            </span>
                        </div>
                        <span style="color: #888; font-size: 12px;">${created}</span>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <span style="font-weight: 600; color: #555;">Item:</span>
                        <span style="color: #333; margin-left: 8px;">${req.requestedData?.name || req.requestedData?.fullName || req.itemId || 'N/A'}</span>
                    </div>
                    
                    ${req.reason ? `
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <span style="font-weight: 600; color: #f39c12;">Reason provided:</span>
                        <span style="color: #333; margin-left: 8px;">${req.reason}</span>
                    </div>
                    ` : ''}
                    
                    ${req.status === 'rejected' && req.rejectionReason ? `
                    <div style="background: #fee9e7; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #e74c3c;">
                        <span style="font-weight: 600; color: #e74c3c;">Rejection reason:</span>
                        <span style="color: #333; margin-left: 8px;">${req.rejectionReason}</span>
                    </div>
                    ` : ''}
                    
                    ${req.reviewedBy ? `
                    <div style="font-size: 12px; color: #666; border-top: 1px solid #eee; padding-top: 12px;">
                        Reviewed by: ${req.reviewedBy} on ${req.reviewedAt ? new Date(req.reviewedAt).toLocaleString() : 'N/A'}
                    </div>
                    ` : ''}
                    
                    ${req.status === 'pending' ? `
                    <div style="margin-top: 12px; font-size: 12px; color: #e67e22; background: #fef5e7; padding: 8px 12px; border-radius: 8px;">
                        ‚è≥ This request is awaiting approval
                    </div>
                    ` : ''}
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    function switchApprovalHistoryTab(tab) {
        document.getElementById('historyPendingTab').classList.toggle('active', tab === 'pending');
        document.getElementById('historyHistoryTab').classList.toggle('active', tab === 'history');
        loadUserApprovalHistory(tab);
    }

    // Audit pagination variables
    let currentAuditPage = 1;
    let auditLogsPerPage = 20;
    let totalAuditPages = 1;

    const bgImages = [
        './images/bgx.jpg',
        './images/bg.jpg',
        './images/bgx1.jpg'
    ];

    const LOCK_TIME = { hr: 23, min: 50 };
    const OPEN_TIME = { hr: 7, min: 30 };
    const COLLECTIONS = {
        USERS: 'users',
        CATEGORIES: 'categories',
        SUPPLIERS: 'suppliers',
        LINKS: 'links',
        AUDIT_LOGS: 'audit_logs',
        SESSIONS: 'sessions',
        APPROVALS: 'approval_requests'
    };

    // ========== ROLE HELPERS ==========
    function getCurrentUser() { 
        return localStorage.getItem('logged_user') || null; 
    }
    
    function getUser(username) { 
        return userAccounts.find(u => u.username === username); 
    }
    
    function isCurrentUserSuperAdmin() { 
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin'; 
    }
    
    function isCurrentUserAdmin() { 
        const user = getUser(getCurrentUser());
        return user && (user.role === 'admin' || user.role === 'super admin'); 
    }
    
    function isCurrentUserStaff() { 
        const user = getUser(getCurrentUser());
        return user && user.role === 'staff'; 
    }
    
    function canWorkAfterLock() { 
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin'); 
    }

    // ========== PERMISSION CHECKS ==========
    
    // USER MANAGEMENT PERMISSIONS
    function canAddUser() {
        const user = getUser(getCurrentUser());
        if (!user) return false;
        return user.role === 'super admin' || user.role === 'admin' || user.role === 'staff';
    }
    
    function canEditUser() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canDeleteUser() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canDeleteUserWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }
    
    function isJoseph(username) {
        return username === 'JOSEPH';
    }

    // CATEGORY PERMISSIONS
    function canCreateCategory() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canCreateCategoryWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }
    
    function canEditCategory() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canEditCategoryWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }
    
    function canDeleteCategory() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canDeleteCategoryWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }

    // SUPPLIER PERMISSIONS
    function canCreateSupplier() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canCreateSupplierWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }
    
    function canEditSupplier() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canEditSupplierWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }
    
    function canDeleteSupplier() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canDeleteSupplierWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }

    // LINK PERMISSIONS
    function canCreateLink() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canCreateLinkWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }
    
    function canEditLink() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canEditLinkWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }
    
    function canDeleteLink() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canDeleteLinkWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }

    // AUDIT LOG PERMISSIONS
    function canViewAuditLogs() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canDeleteAuditLogs() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }

    // SESSIONS PERMISSIONS
    function canViewSessions() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }

    // APPROVAL PERMISSIONS
    function canApproveRequests() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }
    
    function canApproveAllRequests() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }

    // SYSTEM LOCK PERMISSIONS
    function canAccessLockedSystem() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }

    // ========== SYSTEM LOCK ==========
    function isSystemLocked() {
        const now = new Date();
        const currentTotal = (now.getHours() * 60) + now.getMinutes();
        const lockTotal = (LOCK_TIME.hr * 60) + LOCK_TIME.min;
        const openTotal = (OPEN_TIME.hr * 60) + OPEN_TIME.min;
        return (currentTotal >= lockTotal || currentTotal < openTotal);
    }

    // ========== LOCK SCREEN FUNCTIONS ==========
    function showLockScreen() {
        const lockScreen = document.getElementById('systemLockScreen');
        if (lockScreen) {
            lockScreen.style.display = 'flex';
            startLockCountdown();
        }
    }

    function hideLockScreen() {
        const lockScreen = document.getElementById('systemLockScreen');
        if (lockScreen) {
            lockScreen.style.display = 'none';
            if (lockScreenInterval) {
                clearInterval(lockScreenInterval);
                lockScreenInterval = null;
            }
        }
    }

    function startLockCountdown() {
        if (lockScreenInterval) {
            clearInterval(lockScreenInterval);
        }
        
        updateLockDisplay();
        lockScreenInterval = setInterval(updateLockDisplay, 1000);
    }

    function updateLockDisplay() {
        const now = new Date();
        const openTime = new Date(now);
        openTime.setHours(OPEN_TIME.hr, OPEN_TIME.min, 0, 0);
        
        // If current time is after lock time, set unlock to tomorrow
        if (now.getHours() >= LOCK_TIME.hr) {
            openTime.setDate(openTime.getDate() + 1);
        }
        
        const timeUntilUnlock = openTime - now;
        
        if (timeUntilUnlock <= 0) {
            // Time to unlock - hide lock screen
            hideLockScreen();
            return;
        }
        
        // Format countdown
        const hours = Math.floor(timeUntilUnlock / (1000 * 60 * 60));
        const minutes = Math.floor((timeUntilUnlock % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeUntilUnlock % (1000 * 60)) / 1000);
        
        const countdownEl = document.getElementById('lockCountdown');
        if (countdownEl) {
            countdownEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Calculate progress percentage (24 hour cycle)
        const totalLockHours = 24 - (LOCK_TIME.hr - OPEN_TIME.hr);
        const totalLockMs = totalLockHours * 60 * 60 * 1000;
        const progress = ((totalLockMs - timeUntilUnlock) / totalLockMs) * 100;
        
        const progressBar = document.getElementById('lockProgress');
        if (progressBar) {
            progressBar.style.width = `${progress}%`;
        }
        
        const unlockTimeEl = document.getElementById('unlockTimeDisplay');
        if (unlockTimeEl) {
            const unlockHour = openTime.getHours().toString().padStart(2, '0');
            const unlockMin = openTime.getMinutes().toString().padStart(2, '0');
            unlockTimeEl.textContent = `Next unlock: ${unlockHour}:${unlockMin}:00`;
        }
    }

    function backToLoginFromLock() {
        hideLockScreen();
        document.getElementById('loginOverlay').style.display = 'flex';
        localStorage.removeItem('logged_user');
        localStorage.removeItem('last_login');
    }

    // ========== AUDIT LOGGING WITH DETAILED ACTIONS ==========
    async function logAudit(action, details = {}) {
        try {
            const currentUser = getCurrentUser();
            
            // Format the action to be more descriptive
            let actionDescription = action;
            let detailedMessage = '';
            
            // Create detailed description based on action type
            if (action.includes('CREATE')) {
                if (details.name) {
                    detailedMessage = `Created new ${action.replace('CREATE_', '').toLowerCase()}: "${details.name}"`;
                } else if (details.username) {
                    detailedMessage = `Created new user: "${details.username}" with role ${details.role}`;
                } else {
                    detailedMessage = `Created ${action.replace('CREATE_', '').toLowerCase()}`;
                }
            } else if (action.includes('UPDATE') || action.includes('EDIT')) {
                if (details.name) {
                    detailedMessage = `Updated ${action.replace('UPDATE_', '').replace('EDIT_', '').toLowerCase()}: "${details.name}"`;
                    if (details.changes) {
                        const changeFields = Object.keys(details.changes).join(', ');
                        detailedMessage += ` (Modified: ${changeFields})`;
                    }
                } else if (details.username) {
                    detailedMessage = `Updated user: "${details.username}"`;
                    if (details.changes) {
                        const changeFields = Object.keys(details.changes).join(', ');
                        detailedMessage += ` (Modified: ${changeFields})`;
                    }
                } else {
                    detailedMessage = `Updated ${action.replace('UPDATE_', '').replace('EDIT_', '').toLowerCase()}`;
                }
            } else if (action.includes('DELETE')) {
                if (details.name) {
                    detailedMessage = `Deleted ${action.replace('DELETE_', '').toLowerCase()}: "${details.name}"`;
                } else if (details.username) {
                    detailedMessage = `Deleted user: "${details.username}"`;
                } else {
                    detailedMessage = `Deleted ${action.replace('DELETE_', '').toLowerCase()}`;
                }
            } else if (action.includes('APPROVAL')) {
                if (action.includes('GRANTED')) {
                    detailedMessage = `Approved request for ${details.type} ${details.action} by ${details.requestedBy}`;
                } else if (action.includes('REJECTED')) {
                    detailedMessage = `Rejected request for ${details.type} ${details.action} by ${details.requestedBy}. Reason: ${details.reason}`;
                }
            } else if (action.includes('LOGIN')) {
                detailedMessage = `User logged in`;
            } else if (action.includes('LOGOUT')) {
                detailedMessage = `User logged out`;
            } else if (action.includes('EXPORT')) {
                detailedMessage = `Exported backup with ${details.recordCounts?.categories || 0} categories, ${details.recordCounts?.suppliers || 0} suppliers`;
            }
            
            const logEntry = {
                timestamp: new Date().toISOString(),
                user: currentUser || 'SYSTEM',
                action: action,
                description: detailedMessage || action,
                details: details,
                userAgent: navigator.userAgent,
                ip: 'client-side'
            };
            
            await db.collection(COLLECTIONS.AUDIT_LOGS).add(logEntry);
            console.log('Audit log created:', action, detailedMessage);
        } catch (error) {
            console.error('Error creating audit log:', error);
        }
    }

    // ========== AUDIT LOGS VIEW ==========
    async function showAuditLogs() {
        if (!canViewAuditLogs()) {
            alert('You do not have permission to view audit logs');
            return;
        }
        showView('auditLogs');
        await loadAuditLogs();
        renderAuditLogs();
    }

    async function loadAuditLogs() {
        try {
            const snapshot = await db.collection(COLLECTIONS.AUDIT_LOGS)
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get();
            auditLogs = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            totalAuditPages = Math.ceil(auditLogs.length / auditLogsPerPage) || 1;
            currentAuditPage = 1;
        } catch (error) {
            console.error('Error loading audit logs:', error);
            auditLogs = [];
            totalAuditPages = 1;
        }
    }

    function renderAuditLogs() {
        const container = document.getElementById('auditLogsContainer');
        const paginationDiv = document.getElementById('auditPagination');
        
        if (!container) return;
        
        if (!auditLogs || auditLogs.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 60px; color: #666;">üì≠ No audit logs found</div>';
            if (paginationDiv) paginationDiv.innerHTML = '';
            return;
        }

        const startIndex = (currentAuditPage - 1) * auditLogsPerPage;
        const endIndex = startIndex + auditLogsPerPage;
        const paginatedLogs = auditLogs.slice(startIndex, endIndex);

        let html = '<div style="margin-bottom: 20px;">';
        html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="font-size: 14px; color: #666;">Showing ${startIndex + 1} - ${Math.min(endIndex, auditLogs.length)} of ${auditLogs.length} logs</span>
                 </div>`;
        
        paginatedLogs.forEach(log => {
            const timestamp = log.timestamp ? new Date(log.timestamp) : new Date();
            const timeStr = timestamp.toLocaleString();
            const actionClass = log.action?.includes('DELETE') ? 'comp-bad' : 
                              log.action?.includes('CREATE') ? 'comp-ok' : 
                              log.action?.includes('UPDATE') ? 'btn-edit' : '';
            
            // Get description or create one from details
            const description = log.description || log.action || 'Action performed';
            
            // Format details for display
            let detailsHtml = '';
            if (log.details) {
                if (typeof log.details === 'object') {
                    const detailEntries = Object.entries(log.details)
                        .filter(([key]) => !['userAgent', 'ip'].includes(key))
                        .map(([key, value]) => {
                            if (key === 'changes' && typeof value === 'object') {
                                return `<div style="margin-top: 5px;"><strong>Changes:</strong> ${Object.keys(value).join(', ')}</div>`;
                            }
                            return `<div><strong>${key}:</strong> ${JSON.stringify(value)}</div>`;
                        }).join('');
                    if (detailEntries) {
                        detailsHtml = `<div class="audit-details">${detailEntries}</div>`;
                    }
                }
            }
            
            html += `<div class="audit-log-entry">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <span class="audit-timestamp">${timeStr}</span>
                                <span class="audit-user">üë§ ${log.user || 'SYSTEM'}</span>
                                <span style="padding:4px 12px; background:${actionClass || '#34495e'}; color:white; border-radius:20px; font-size:11px; font-weight:600;">${log.action || 'ACTION'}</span>
                            </div>
                        </div>
                        <div style="margin-top: 8px; font-size: 14px; color: #2c3e50; font-weight: 500;">
                            ${description}
                        </div>
                        ${detailsHtml}
                        <div style="margin-top: 5px; font-size: 11px; color: #999; font-family: monospace;">
                            ID: ${log.id}
                        </div>
                    </div>`;
        });
        html += '</div>';
        
        container.innerHTML = html;

        let paginationHtml = '';
        if (totalAuditPages > 1) {
            paginationHtml += '<div style="display: flex; gap: 10px; align-items: center;">';
            
            if (currentAuditPage > 1) {
                paginationHtml += `<button class="btn btn-pagination" onclick="changeAuditPage(${currentAuditPage - 1})">‚Üê Previous</button>`;
            }
            
            paginationHtml += `<span style="font-size: 14px;">Page ${currentAuditPage} of ${totalAuditPages}</span>`;
            
            if (currentAuditPage < totalAuditPages) {
                paginationHtml += `<button class="btn btn-pagination" onclick="changeAuditPage(${currentAuditPage + 1})">Next ‚Üí</button>`;
            }
            
            paginationHtml += '</div>';
        }
        
        if (paginationDiv) paginationDiv.innerHTML = paginationHtml;
    }

    function changeAuditPage(page) {
        currentAuditPage = page;
        renderAuditLogs();
    }

    // ========== DELETE AUDIT LOGS (SUPER ADMIN ONLY) ==========
    async function deleteAllAuditLogs() {
        if (!canDeleteAuditLogs()) {
            alert('Only super admin can delete audit logs');
            return;
        }

        if (confirm('‚ö†Ô∏è Delete ALL audit logs? This action CANNOT be undone.')) {
            try {
                showNotification('Deleting all audit logs...', 'info');
                
                const snapshot = await db.collection(COLLECTIONS.AUDIT_LOGS).get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                await logAudit('DELETE_ALL_AUDIT_LOGS', { 
                    count: snapshot.size,
                    deletedBy: getCurrentUser() 
                });
                
                await loadAuditLogs();
                renderAuditLogs();
                showNotification(`‚úÖ Deleted ${snapshot.size} audit logs successfully`, 'success');
            } catch (error) {
                console.error('Error deleting audit logs:', error);
                alert('Failed to delete audit logs: ' + error.message);
            }
        }
    }

    async function deleteLast50AuditLogs() {
        if (!canDeleteAuditLogs()) {
            alert('Only super admin can delete audit logs');
            return;
        }

        if (confirm('Delete the last 50 audit logs?')) {
            try {
                showNotification('Deleting last 50 audit logs...', 'info');
                
                const snapshot = await db.collection(COLLECTIONS.AUDIT_LOGS)
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                await logAudit('DELETE_LAST_50_AUDIT_LOGS', { 
                    count: snapshot.size,
                    deletedBy: getCurrentUser() 
                });
                
                await loadAuditLogs();
                renderAuditLogs();
                showNotification(`‚úÖ Deleted ${snapshot.size} audit logs successfully`, 'success');
            } catch (error) {
                console.error('Error deleting audit logs:', error);
                alert('Failed to delete audit logs: ' + error.message);
            }
        }
    }

    // ========== REASON MODAL FUNCTIONS ==========
    function openReasonModal(type, id, name, callback) {
        document.getElementById('reasonModalTitle').innerHTML = `State Reason for ${type} Deletion`;
        document.getElementById('pendingDeletionType').value = type;
        document.getElementById('pendingDeletionId').value = id;
        document.getElementById('pendingDeletionName').value = name;
        document.getElementById('deletionReason').value = '';
        pendingDeletionCallback = callback;
        document.getElementById('reasonModal').style.display = 'flex';
    }

    function closeReasonModal() {
        document.getElementById('reasonModal').style.display = 'none';
        document.getElementById('deletionReason').value = '';
        pendingDeletionCallback = null;
    }

    async function submitDeletionReason() {
        const reason = document.getElementById('deletionReason').value.trim();
        if (!reason) {
            alert('Please provide a reason for deletion');
            return;
        }

        const type = document.getElementById('pendingDeletionType').value;
        const id = document.getElementById('pendingDeletionId').value;
        const name = document.getElementById('pendingDeletionName').value;

        if (pendingDeletionCallback) {
            await pendingDeletionCallback(type, id, name, reason);
        }

        closeReasonModal();
    }

    // ========== APPROVAL REQUESTS WITH COUNT UPDATES ==========
    async function loadApprovalRequests() {
        try {
            console.log("Loading approval requests...");
            const snapshot = await db.collection(COLLECTIONS.APPROVALS)
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc')
                .get();
            
            approvalRequests = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            console.log(`Found ${approvalRequests.length} pending requests:`, approvalRequests);
            
            updateApprovalsButton();
            updateRequestCounts();
        } catch (error) {
            console.error('Error loading approval requests:', error);
            approvalRequests = [];
            updateRequestCounts();
        }
    }

    function updateRequestCounts() {
        // Update approval button count
        const navBtn = document.getElementById('approvalRequestsNavBtn');
        const countSpan = document.getElementById('approvalRequestCount');
        const requestsMgmtCount = document.getElementById('requestsManagementCount');
        const pendingCountSpan = document.getElementById('pendingApprovalCount');
        
        const currentUser = getUser(getCurrentUser());
        if (!currentUser) return;
        
        // Filter requests based on user role
        let visibleRequests = approvalRequests;
        if (currentUser.role === 'admin') {
            // Admin sees requests from staff and admin (but not super admin)
            visibleRequests = approvalRequests.filter(req => 
                req.requestedByRole === 'staff' || req.requestedByRole === 'admin'
            );
        } else if (currentUser.role === 'super admin') {
            // Super admin sees ALL pending requests
            visibleRequests = approvalRequests;
        } else if (currentUser.role === 'staff') {
            // Staff doesn't see approval button
            visibleRequests = [];
        }
        
        const count = visibleRequests.length;
        
        // Update all count badges
        if (countSpan) {
            countSpan.textContent = count;
            countSpan.className = `request-count-badge ${count === 0 ? 'request-count-zero' : ''}`;
        }
        
        if (requestsMgmtCount) {
            requestsMgmtCount.textContent = approvalRequests.length;
            requestsMgmtCount.className = `request-count-badge ${approvalRequests.length === 0 ? 'request-count-zero' : ''}`;
        }
        
        if (pendingCountSpan) {
            pendingCountSpan.textContent = count;
            pendingCountSpan.className = `request-count-badge ${count === 0 ? 'request-count-zero' : ''}`;
        }
        
        // Show/hide approval button based on count and permissions
        if (navBtn) {
            if (canApproveRequests() && count > 0) {
                navBtn.style.display = 'inline-block';
            } else {
                navBtn.style.display = 'none';
            }
        }
        
        // Show/hide requests management button for super admin
        const requestsBtn = document.getElementById('requestsManagementBtn');
        if (requestsBtn) {
            if (currentUser.role === 'super admin') {
                requestsBtn.style.display = 'inline-block';
            } else {
                requestsBtn.style.display = 'none';
            }
        }
    }

    async function createApprovalRequest(type, data, action, itemId, reason = null) {
        try {
            const currentUser = getUser(getCurrentUser());
            if (!currentUser) {
                alert('You must be logged in to create a request');
                return;
            }

            console.log(`Creating ${action} request for ${type}:`, data);
            
            const request = {
                type: type,
                action: action,
                itemId: itemId,
                requestedBy: getCurrentUser(),
                requestedByRole: currentUser.role,
                requestedData: data,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdDate: new Date().toISOString()
            };
            
            if (reason) {
                request.reason = reason;
            }
            
            const docRef = await db.collection(COLLECTIONS.APPROVALS).add(request);
            console.log(`Request created with ID: ${docRef.id}`);
            
            await loadApprovalRequests();
            
            updateApprovalsButton();
            updateRequestCounts();
            
            showNotification('‚úÖ Approval request submitted successfully', 'success');
        } catch (error) {
            console.error('Error creating approval request:', error);
            alert('Failed to create approval request: ' + error.message);
        }
    }

    function updateApprovalsButton() {
        const navBtn = document.getElementById('approvalRequestsNavBtn');
        if (!navBtn) return;
        
        const currentUser = getUser(getCurrentUser());
        if (!currentUser || !canApproveRequests()) {
            navBtn.style.display = 'none';
            return;
        }
        
        let visibleRequests = approvalRequests;
        if (currentUser.role === 'admin') {
            visibleRequests = approvalRequests.filter(req => 
                req.requestedByRole === 'staff' || req.requestedByRole === 'admin'
            );
        } else if (currentUser.role === 'super admin') {
            visibleRequests = approvalRequests;
        }
        
        if (visibleRequests.length > 0) {
            navBtn.style.display = 'inline-block';
            navBtn.innerHTML = `‚úÖ APPROVALS <span id="approvalRequestCount" class="request-count-badge">${visibleRequests.length}</span>`;
            navBtn.style.background = '#e67e22';
        } else {
            navBtn.style.display = 'none';
        }

        const historyBtn = document.getElementById('approvalHistoryNavBtn');
        if (historyBtn && getCurrentUser()) {
            // Super admin should NOT see My Requests button
            if (currentUser && currentUser.role === 'super admin') {
                historyBtn.style.display = 'none';
            } else {
                historyBtn.style.display = 'inline-block';
            }
        }
        
        updateRequestCounts();
    }

    // Enhanced openApprovalRequestsModal
    async function openApprovalRequestsModal() {
        await loadApprovalRequests();
        
        const container = document.getElementById('pendingApprovalsList');
        if (!container) return;
        
        const currentUser = getUser(getCurrentUser());
        
        if (!canApproveRequests()) {
            alert('You do not have permission to approve requests');
            return;
        }
        
        if (approvalRequests.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">‚úÖ No pending approval requests</div>';
        } else {
            renderEnhancedApprovalRequests();
        }
        
        document.getElementById('approvalRequestsModal').style.display = 'flex';
    }

    async function openApprovalActionModal(requestId) {
        const request = approvalRequests.find(r => r.id === requestId);
        if (!request) return;
        
        localStorage.setItem('currentApprovalRequestId', requestId);
        
        const detailsDiv = document.getElementById('approvalActionDetails');
        let detailsHtml = `<p><strong>Request Type:</strong> ${request.action} ${request.type}</p>`;
        detailsHtml += `<p><strong>Requested By:</strong> ${request.requestedBy} (${request.requestedByRole})</p>`;
        detailsHtml += `<p><strong>Date:</strong> ${new Date(request.createdAt?.toDate ? request.createdAt.toDate() : request.createdAt).toLocaleString()}</p>`;
        detailsHtml += `<p><strong>Item ID:</strong> ${request.itemId || 'N/A'}</p>`;
        
        if (request.reason) {
            detailsHtml += `<div style="margin-top: 10px; padding: 10px; background: #fff8e7; border-radius: 8px;">
                <strong style="color: #f39c12;">Reason:</strong>
                <p style="margin: 5px 0 0 0; font-size: 13px;">${request.reason}</p>
            </div>`;
        }
        
        detailsHtml += `<div style="margin-top: 15px;"><strong>Request Data:</strong><pre style="background: #fff; padding: 10px; border-radius: 5px; font-size: 12px; overflow-x: auto;">${JSON.stringify(request.requestedData, null, 2)}</pre></div>`;
        
        detailsDiv.innerHTML = detailsHtml;
        document.getElementById('approvalActionTitle').innerHTML = `Review ${request.action} Request`;
        document.getElementById('approvalActionModal').style.display = 'flex';
    }


    // ========== NEW: Function to load account requests for super admin ==========
async function loadAccountRequests() {
    try {
        const snapshot = await db.collection('account_requests')
            .where('status', '==', 'pending')
            .orderBy('requestedAt', 'desc')
            .get();
        
        return snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
    } catch (error) {
        console.error('Error loading account requests:', error);
        return [];
    }
}

// ========== NEW: Function to approve account request ==========
async function approveAccountRequest(requestId, requestData) {
    try {
        // Create new user
        const newUser = {
            fullName: requestData.fullName,
            username: requestData.username,
            password: requestData.password,
            role: 'staff',
            nrc: requestData.nrc,
            phone: requestData.phone,
            institution: requestData.institution,
            position: requestData.position,
            email: requestData.email,
            documents: requestData.documents,
            enabled: true,
            createdAt: new Date().toISOString(),
            lastActive: null
        };

        // Add user to users collection
        await db.collection(COLLECTIONS.USERS).add(newUser);

        // Update request status
        await db.collection('account_requests').doc(requestId).update({
            status: 'approved',
            approvedAt: new Date().toISOString(),
            approvedBy: getCurrentUser()
        });

        // Log the approval
        await logAudit('ACCOUNT_APPROVED', {
            username: requestData.username,
            fullName: requestData.fullName,
            approvedBy: getCurrentUser()
        });

        // Send email (you'll need to implement this separately)
        sendApprovalEmail(requestData.email, requestData.fullName);

        showNotification(`Account for ${requestData.fullName} approved successfully`, 'success');
        
    } catch (error) {
        console.error('Error approving account:', error);
        alert('Failed to approve account: ' + error.message);
    }
}

// ========== NEW: Function to reject account request ==========
async function rejectAccountRequest(requestId, requestData, reason) {
    try {
        // Update request status
        await db.collection('account_requests').doc(requestId).update({
            status: 'rejected',
            rejectedAt: new Date().toISOString(),
            rejectedBy: getCurrentUser(),
            rejectionReason: reason
        });

        // Log the rejection
        await logAudit('ACCOUNT_REJECTED', {
            username: requestData.username,
            fullName: requestData.fullName,
            rejectedBy: getCurrentUser(),
            reason: reason
        });

        // Send rejection email (you'll need to implement this separately)
        sendRejectionEmail(requestData.email, requestData.fullName, reason);

        showNotification(`Account request for ${requestData.fullName} rejected`, 'info');
        
    } catch (error) {
        console.error('Error rejecting account:', error);
        alert('Failed to reject account: ' + error.message);
    }
}

// ========== NEW: Placeholder email functions ==========
function sendApprovalEmail(email, fullName) {
    console.log(`[EMAIL] Account approved for ${fullName} at ${email}`);
    // Implement actual email sending here (using EmailJS or similar service)
    alert(`Demo: Approval email would be sent to ${email}`);
}

function sendRejectionEmail(email, fullName, reason) {
    console.log(`[EMAIL] Account rejected for ${fullName} at ${email}. Reason: ${reason}`);
    // Implement actual email sending here (using EmailJS or similar service)
    alert(`Demo: Rejection email would be sent to ${email} with reason: ${reason}`);
}

    // Enhanced confirmApproval to show what's being approved
    async function confirmApprovalWithSummary(approved) {
        const requestId = localStorage.getItem('currentApprovalRequestId');
        
        if (!requestId) {
            alert('No request selected');
            return;
        }

        try {
            const docRef = db.collection(COLLECTIONS.APPROVALS).doc(requestId);
            const doc = await docRef.get();
            
            if (!doc.exists) {
                alert('Request not found. It may have been already processed.');
                localStorage.removeItem('currentApprovalRequestId');
                return;
            }

            const request = { id: doc.id, ...doc.data() };
            
            // Show summary of what's being approved
            let approvalMessage = '';
            if (request.changeSummary && request.changeSummary.length > 0) {
                approvalMessage = 'Changes to be applied:\n' + 
                    request.changeSummary.map(change => 
                        `- ${change.field}: "${change.oldValue}" ‚Üí "${change.newValue}"`
                    ).join('\n');
            } else if (request.action === 'delete') {
                approvalMessage = `Delete ${request.type}: ${request.oldData?.name || request.requestedData?.name}`;
            } else if (request.action === 'add') {
                approvalMessage = `Add new ${request.type}: ${request.requestedData?.name}`;
            }
            
            if (approvalMessage && !confirm(`Are you sure you want to ${approved ? 'APPROVE' : 'REJECT'} this request?\n\n${approvalMessage}`)) {
                return;
            }
            
            if (approved) {
                if (request.action === 'delete') {
                    if (request.type === 'category') {
                        await db.collection(COLLECTIONS.CATEGORIES).doc(request.itemId).delete();
                        showNotification('Category deleted', 'success');
                    } else if (request.type === 'supplier') {
                        await db.collection(COLLECTIONS.SUPPLIERS).doc(request.itemId).delete();
                        showNotification('Supplier deleted', 'success');
                    } else if (request.type === 'link') {
                        await db.collection(COLLECTIONS.LINKS).doc(request.itemId).delete();
                        showNotification('Link deleted', 'success');
                    } else if (request.type === 'user') {
                        await db.collection(COLLECTIONS.USERS).doc(request.itemId).delete();
                        showNotification('User deleted', 'success');
                    }
                } else if (request.action === 'edit') {
                    if (request.type === 'category') {
                        await db.collection(COLLECTIONS.CATEGORIES).doc(request.itemId).update(request.requestedData);
                        showNotification('Category updated', 'success');
                    } else if (request.type === 'supplier') {
                        await db.collection(COLLECTIONS.SUPPLIERS).doc(request.itemId).update(request.requestedData);
                        showNotification('Supplier updated', 'success');
                    } else if (request.type === 'link') {
                        await db.collection(COLLECTIONS.LINKS).doc(request.itemId).update(request.requestedData);
                        showNotification('Link updated', 'success');
                    } else if (request.type === 'user') {
                        await db.collection(COLLECTIONS.USERS).doc(request.itemId).update(request.requestedData);
                        showNotification('User updated', 'success');
                    }
                } else if (request.action === 'add') {
                    if (request.type === 'user' || request.type === 'category' || request.type === 'supplier' || request.type === 'link') {
                        const collectionMap = {
                            'user': COLLECTIONS.USERS,
                            'category': COLLECTIONS.CATEGORIES,
                            'supplier': COLLECTIONS.SUPPLIERS,
                            'link': COLLECTIONS.LINKS
                        };
                        
                        await db.collection(collectionMap[request.type]).add(request.requestedData);
                        showNotification(`${request.type} added successfully`, 'success');
                    }
                }
            }

            await docRef.update({
                status: approved ? 'approved' : 'pending',
                reviewedBy: getCurrentUser(),
                reviewedAt: new Date().toISOString()
            });

            await logAudit(approved ? 'APPROVAL_GRANTED' : 'APPROVAL_PENDING', {
                requestId: requestId,
                type: request.type,
                action: request.action,
                requestedBy: request.requestedBy,
                changes: request.changeSummary,
                reason: request.reason
            });

            if (approved) {
                showNotification('Request approved successfully', 'success');
            }

            document.getElementById('approvalActionModal').style.display = 'none';
            document.getElementById('approvalRequestsModal').style.display = 'none';
            
            const modal = document.getElementById('requestsManagementModal');
            if (modal) modal.remove();
            
            await loadAllData(true);
            await loadApprovalRequests();
            
            const currentUser = getUser(getCurrentUser());
            if (currentUser && currentUser.role !== 'super admin') {
                await loadUserApprovalHistory();
            }
            
            renderCategories();
            applyRoleBasedUI();
            
            if (document.getElementById('categoryPageView').style.display === 'block') {
                const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
                renderSuppliersTable(categorySuppliers);
            }

        } catch (error) {
            console.error('Error:', error);
            alert('Failed to process request: ' + error.message);
        } finally {
            localStorage.removeItem('currentApprovalRequestId');
        }
    }

    // Override the original confirmApproval
    window.confirmApproval = confirmApprovalWithSummary;

    async function confirmApproval(approved) {
        const requestId = localStorage.getItem('currentApprovalRequestId');
        
        if (!requestId) {
            alert('No request selected');
            return;
        }

        try {
            const docRef = db.collection(COLLECTIONS.APPROVALS).doc(requestId);
            const doc = await docRef.get();
            
            if (!doc.exists) {
                alert('Request not found. It may have been already processed.');
                localStorage.removeItem('currentApprovalRequestId');
                return;
            }

            const request = { id: doc.id, ...doc.data() };
            
            if (approved) {
                if (request.action === 'delete') {
                    if (request.type === 'category') {
                        await db.collection(COLLECTIONS.CATEGORIES).doc(request.itemId).delete();
                        showNotification('Category deleted', 'success');
                    } else if (request.type === 'supplier') {
                        await db.collection(COLLECTIONS.SUPPLIERS).doc(request.itemId).delete();
                        showNotification('Supplier deleted', 'success');
                    } else if (request.type === 'link') {
                        await db.collection(COLLECTIONS.LINKS).doc(request.itemId).delete();
                        showNotification('Link deleted', 'success');
                    } else if (request.type === 'user') {
                        await db.collection(COLLECTIONS.USERS).doc(request.itemId).delete();
                        showNotification('User deleted', 'success');
                    }
                } else if (request.action === 'edit') {
                    if (request.type === 'category') {
                        await db.collection(COLLECTIONS.CATEGORIES).doc(request.itemId).update(request.requestedData);
                        showNotification('Category updated', 'success');
                    } else if (request.type === 'supplier') {
                        await db.collection(COLLECTIONS.SUPPLIERS).doc(request.itemId).update(request.requestedData);
                        showNotification('Supplier updated', 'success');
                    } else if (request.type === 'link') {
                        await db.collection(COLLECTIONS.LINKS).doc(request.itemId).update(request.requestedData);
                        showNotification('Link updated', 'success');
                    } else if (request.type === 'user') {
                        await db.collection(COLLECTIONS.USERS).doc(request.itemId).update(request.requestedData);
                        showNotification('User updated', 'success');
                    }
                } else if (request.action === 'add') {
                    if (request.type === 'user' || request.type === 'category' || request.type === 'supplier' || request.type === 'link') {
                        // Add the item to the appropriate collection
                        const collectionMap = {
                            'user': COLLECTIONS.USERS,
                            'category': COLLECTIONS.CATEGORIES,
                            'supplier': COLLECTIONS.SUPPLIERS,
                            'link': COLLECTIONS.LINKS
                        };
                        
                        await db.collection(collectionMap[request.type]).add(request.requestedData);
                        showNotification(`${request.type} added successfully`, 'success');
                    }
                }
            }

            await docRef.update({
                status: approved ? 'approved' : 'pending', // Will be updated by reject function
                reviewedBy: getCurrentUser(),
                reviewedAt: new Date().toISOString()
            });

            await logAudit(approved ? 'APPROVAL_GRANTED' : 'APPROVAL_PENDING', {
                requestId: requestId,
                type: request.type,
                action: request.action,
                requestedBy: request.requestedBy,
                reason: request.reason
            });

            if (approved) {
                showNotification('Request approved successfully', 'success');
            }

            document.getElementById('approvalActionModal').style.display = 'none';
            document.getElementById('approvalRequestsModal').style.display = 'none';
            
            const modal = document.getElementById('requestsManagementModal');
            if (modal) modal.remove();
            
            await loadAllData(true);
            await loadApprovalRequests();
            
            const currentUser = getUser(getCurrentUser());
            if (currentUser && currentUser.role !== 'super admin') {
                await loadUserApprovalHistory();
            }
            
            renderCategories();
            applyRoleBasedUI();
            
            if (document.getElementById('categoryPageView').style.display === 'block') {
                const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
                renderSuppliersTable(categorySuppliers);
            }

        } catch (error) {
            console.error('Error:', error);
            alert('Failed to process request: ' + error.message);
        } finally {
            localStorage.removeItem('currentApprovalRequestId');
        }
    }

    window.approveRequestNow = async function(requestId) {
        localStorage.setItem('currentApprovalRequestId', requestId);
        await confirmApproval(true);
        openRequestsManagement();
    };

    window.rejectRequestNow = async function(requestId) {
        localStorage.setItem('currentApprovalRequestId', requestId);
        openRejectReasonModal();
    };

    window.deleteRequestNow = async function(requestId) {
        if (!isCurrentUserSuperAdmin()) {
            alert('Only super admin can delete approval requests');
            return;
        }
        
        if (confirm('Delete this approval request permanently?')) {
            try {
                await db.collection(COLLECTIONS.APPROVALS).doc(requestId).delete();
                await loadApprovalRequests();
                showNotification('Approval request deleted', 'success');
            } catch (error) {
                console.error('Error deleting approval request:', error);
                alert('Failed to delete approval request: ' + error.message);
            }
        }
    };

    async function deleteApprovalRequest(requestId) {
        if (!isCurrentUserSuperAdmin()) {
            alert('Only super admin can delete approval requests');
            return;
        }
        
        if (confirm('Delete this approval request permanently?')) {
            try {
                await db.collection(COLLECTIONS.APPROVALS).doc(requestId).delete();
                await loadApprovalRequests();
                openApprovalRequestsModal();
                showNotification('Approval request deleted', 'success');
            } catch (error) {
                console.error('Error deleting approval request:', error);
                alert('Failed to delete approval request: ' + error.message);
            }
        }
    }

    function closeApprovalRequestsModal() {
        document.getElementById('approvalRequestsModal').style.display = 'none';
    }

    function closeApprovalActionModal() {
        document.getElementById('approvalActionModal').style.display = 'none';
        localStorage.removeItem('currentApprovalRequestId');
    }

    // ========== COMPLIANCE TRACKING ==========
    function updateComplianceUI() {
        const tpinChecked = document.getElementById('complianceTpin')?.checked || false;
        const napsaChecked = document.getElementById('complianceNapsa')?.checked || false;
        const zraChecked = document.getElementById('complianceZra')?.checked || false;
        const zppaChecked = document.getElementById('complianceZppa')?.checked || false;
        
        const statusElements = {
            tpin: document.getElementById('complianceTpinStatus'),
            napsa: document.getElementById('complianceNapsaStatus'),
            zra: document.getElementById('complianceZraStatus'),
            zppa: document.getElementById('complianceZppaStatus')
        };
        
        if (statusElements.tpin) {
            statusElements.tpin.textContent = tpinChecked ? 'Compliant' : 'Not Compliant';
            statusElements.tpin.style.background = tpinChecked ? '#2ecc71' : '#e74c3c';
        }
        if (statusElements.napsa) {
            statusElements.napsa.textContent = napsaChecked ? 'Compliant' : 'Not Compliant';
            statusElements.napsa.style.background = napsaChecked ? '#2ecc71' : '#e74c3c';
        }
        if (statusElements.zra) {
            statusElements.zra.textContent = zraChecked ? 'Compliant' : 'Not Compliant';
            statusElements.zra.style.background = zraChecked ? '#2ecc71' : '#e74c3c';
        }
        if (statusElements.zppa) {
            statusElements.zppa.textContent = zppaChecked ? 'Compliant' : 'Not Compliant';
            statusElements.zppa.style.background = zppaChecked ? '#2ecc71' : '#e74c3c';
        }
        
        const totalChecked = [tpinChecked, napsaChecked, zraChecked, zppaChecked].filter(Boolean).length;
        const percent = (totalChecked / 4) * 100;
        
        const percentEl = document.getElementById('overallCompliancePercent');
        const barEl = document.getElementById('overallComplianceBar');
        
        if (percentEl) percentEl.textContent = `${Math.round(percent)}%`;
        if (barEl) {
            barEl.style.width = `${percent}%`;
            barEl.className = `compliance-bar-fill ${percent >= 70 ? 'good' : percent >= 40 ? 'expiring' : 'poor'}`;
        }
    }

    // ========== DOCUMENT UPLOAD ==========
    function handleDocumentUpload(docType, input) {
        const file = input.files[0];
        if (!file) return;
        
        if (file.size > 3 * 1024 * 1024) {
            alert(`File size exceeds 3MB limit for ${docType.toUpperCase()} document`);
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            uploadedDocuments[docType] = {
                name: file.name,
                type: file.type,
                size: file.size,
                data: e.target.result,
                uploadedAt: new Date().toISOString()
            };
            
            const previewEl = document.getElementById(`${docType}DocPreview`);
            if (previewEl) {
                previewEl.innerHTML = `<span style="color: var(--primary-green);">‚úì ${file.name.substring(0, 20)}${file.name.length > 20 ? '...' : ''}</span>`;
            }
            
            if (docType === 'tpin') document.getElementById('complianceTpin').checked = true;
            if (docType === 'napsa') document.getElementById('complianceNapsa').checked = true;
            if (docType === 'zra') document.getElementById('complianceZra').checked = true;
            if (docType === 'zppa') document.getElementById('complianceZppa').checked = true;
            
            updateComplianceUI();
        };
        reader.readAsDataURL(file);
    }

    // ========== FIREBASE DATA FUNCTIONS ==========
    async function getAllUsers(forceRefresh = false) {
        try {
            userAccounts = await getCachedData('users', forceRefresh);
            console.log('Loaded users with documents:', userAccounts.map(u => ({
                username: u.username,
                hasDocs: !!u.documents,
                docKeys: u.documents ? Object.keys(u.documents) : []
            })));
        } catch (error) { 
            console.error("Error getting users:", error); 
        }
    }

    async function loadAllData(forceRefresh = false) {
        try {
            const [catData, supData, linkData] = await Promise.all([
                getCachedData('categories', forceRefresh),
                getCachedData('suppliers', forceRefresh),
                getCachedData('links', forceRefresh)
            ]);
            
            categories = catData;
            suppliers = supData;
            links = linkData;
            
            console.log("‚úÖ Data loaded from " + (forceRefresh ? 'Firestore' : 'cache'));
        } catch (error) { 
            console.error("Error loading data:", error); 
        }
    }

    async function initializeFirestoreCollections() {
        try {
            const catSnap = await db.collection(COLLECTIONS.CATEGORIES).limit(1).get();
            if (catSnap.empty) {
                const defaultCategories = [
                    "Stationery & Office Supplies",
                    "ICT Equipment & Services",
                    "Cleaning Services & Materials",
                    "Catering & Refreshments",
                    "Furniture & Furnishings",
                    "Printing & Publishing",
                    "Construction & Maintenance",
                    "Transport & Logistics",
                    "Consultancy Services",
                    "Security Services"
                ];
                for (const name of defaultCategories) {
                    await db.collection(COLLECTIONS.CATEGORIES).add({ 
                        name, 
                        createdAt: new Date().toISOString() 
                    });
                }
                await logAudit('SYSTEM_INIT', { action: 'Default categories created' });
                console.log("Default categories created");
            }
            
            const linkSnap = await db.collection(COLLECTIONS.LINKS).limit(1).get();
            if (linkSnap.empty) {
                await db.collection(COLLECTIONS.LINKS).add({ 
                    institution: "Public Procurement Authority", 
                    website: "https://www.ppa.org.zm", 
                    email: "info@ppa.org.zm", 
                    createdAt: new Date().toISOString() 
                });
                await db.collection(COLLECTIONS.LINKS).add({ 
                    institution: "ZPPA", 
                    website: "https://www.zppa.org.zm", 
                    email: "director@zppa.org.zm", 
                    createdAt: new Date().toISOString() 
                });
                await logAudit('SYSTEM_INIT', { action: 'Default links created' });
                console.log("Default links created");
            }
        } catch (error) { 
            console.error("Error initializing collections:", error); 
        }
    }

    // ========== LOGIN / AUTH FUNCTIONS ==========
    function togglePassword() {
        const pField = document.getElementById('passIn');
        if (pField) pField.type = pField.type === "password" ? "text" : "password";
    }

    async function handleLogin() {
        const username = document.getElementById('userIn').value.toUpperCase().trim();
        const password = document.getElementById('passIn').value.trim();
        
        if (!username || !password) { 
            alert("Username and password required."); 
            return; 
        }

        try {
            await getAllUsers(true);
            const user = userAccounts.find(u => u.username === username);
            
            if (user && user.password === password && user.enabled) {
                
                // Check system lock for staff users
                if (isSystemLocked() && user.role === 'staff') {
                    showLockScreen();
                    return;
                }
                
                localStorage.setItem('logged_user', username);
                localStorage.setItem('last_login', new Date().toDateString());
                
                if (isSystemLocked()) {
                    if (canAccessLockedSystem()) {
                        document.getElementById('timeWarning').style.display = 'block';
                        setTimeout(() => {
                            document.getElementById('timeWarning').style.display = 'none';
                        }, 5000);
                    }
                }

                if (user.id) {
                    await db.collection(COLLECTIONS.USERS).doc(user.id).update({
                        lastActive: new Date().toISOString()
                    });
                }

                await getAllUsers(true);
                await loadAllData(true);
                await initializeFirestoreCollections();
                await loadApprovalRequests();
                
                await logAudit('USER_LOGIN', { 
                    username: username,
                    role: user.role,
                    locked: isSystemLocked()
                });

                document.getElementById('loginOverlay').style.display = 'none';
                hideLoadingSpinner();

                updateGreeting();
                updateUserDisplay();
                applyRoleBasedUI();
                showView('home');
                startSessionHeartbeat();
                showNotification(`Welcome, ${username} (${user.role})`, 'success');
            } else {
                if (user && !user.enabled) {
                    alert("Your account has been disabled. Please contact super admin.");
                } else {
                    alert("Invalid username or password!");
                }
            }
        } catch (error) {
            console.error("Login error:", error);
            alert("Login failed. Please try again.");
        }
    }


    // ========== LOGOUT WITH CLEANUP ==========
    function logout() {
        const username = getCurrentUser();
        logAudit('USER_LOGOUT', { username: username });
        
        localStorage.removeItem('logged_user');
        localStorage.removeItem('last_login');
        
        if (sessionHeartbeat) {
            clearInterval(sessionHeartbeat);
            sessionHeartbeat = null;
        }

        ['homeView','categoryPageView','aboutView','contactView','linksView','auditLogsView','userApprovalHistoryView'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });

        hideLockScreen();
        document.getElementById('loginOverlay').style.display = 'flex';
        document.getElementById('userIn').value = '';
        document.getElementById('passIn').value = '';
        document.getElementById('timeWarning').style.display = 'none';
    }

    // ========== ROLE BASED UI ==========
    function applyRoleBasedUI() {
        const user = getUser(getCurrentUser());
        if (!user) return;

        const isSuper = (user.role === 'super admin');
        const isAdmin = (user.role === 'admin');
        const isStaff = (user.role === 'staff');

        document.querySelectorAll('.exclusive-super').forEach(el => {
            el.style.display = isSuper ? 'inline-block' : 'none';
        });

        // User Management Button - All roles can access now (Staff can add staff users)
        document.getElementById('userMgmtBtn').style.display = 'inline-block';
        
        // Sessions Button - All roles can view
        document.getElementById('sessionsBtn').style.display = canViewSessions() ? 'inline-block' : 'none';
        
        // Approvals Button - Admin and Super Admin only (will be shown/hidden by count)
        const approvalsBtn = document.getElementById('approvalRequestsNavBtn');
        if (approvalsBtn) {
            if (canApproveRequests()) {
                let visibleRequests = approvalRequests;
                if (user.role === 'admin') {
                    visibleRequests = approvalRequests.filter(req => 
                        req.requestedByRole === 'staff' || req.requestedByRole === 'admin'
                    );
                } else if (user.role === 'super admin') {
                    visibleRequests = approvalRequests;
                }
                if (visibleRequests.length > 0) {
                    approvalsBtn.style.display = 'inline-block';
                } else {
                    approvalsBtn.style.display = 'none';
                }
            } else {
                approvalsBtn.style.display = 'none';
            }
        }

        // My Requests Button - All roles except super admin
        const historyBtn = document.getElementById('approvalHistoryNavBtn');
        if (historyBtn) {
            if (getCurrentUser() && !isSuper) {
                historyBtn.style.display = 'inline-block';
            } else {
                historyBtn.style.display = 'none';
            }
        }

        // Requests Management - Super Admin only
        const requestsBtn = document.getElementById('requestsManagementBtn');
        if (requestsBtn) {
            requestsBtn.style.display = isSuper ? 'inline-block' : 'none';
        }

        // Category Controls
        const newCategoryBtn = document.getElementById('newCategoryBtn');
        if (newCategoryBtn) {
            newCategoryBtn.style.display = canCreateCategory() ? 'inline-block' : 'none';
        }

        // Category Page Buttons
        const categoryNewCategoryBtn = document.getElementById('categoryNewCategoryBtn');
        if (categoryNewCategoryBtn) {
            categoryNewCategoryBtn.style.display = canCreateCategory() ? 'inline-block' : 'none';
        }

        const categoryNewSupplierBtn = document.getElementById('categoryNewSupplierBtn');
        if (categoryNewSupplierBtn) {
            categoryNewSupplierBtn.style.display = canCreateSupplier() ? 'inline-block' : 'none';
        }

        const editCategoryBtn = document.getElementById('editCategoryBtn');
        if (editCategoryBtn) {
            editCategoryBtn.style.display = canEditCategory() ? 'inline-block' : 'none';
        }

        // Supplier Controls
        const newSupplierBtn = document.getElementById('newSupplierBtn');
        if (newSupplierBtn) {
            newSupplierBtn.style.display = canCreateSupplier() ? 'inline-block' : 'none';
        }

        // Link Controls
        const addLinkBtn = document.getElementById('addLinkBtn');
        if (addLinkBtn) {
            addLinkBtn.style.display = canCreateLink() ? 'inline-block' : 'none';
        }

        renderCategories();
        renderLinks();
        updateRequestCounts();
    }

    // ========== SESSION HEARTBEAT ==========
    function startSessionHeartbeat() {
        if (sessionHeartbeat) clearInterval(sessionHeartbeat);
        sessionHeartbeat = setInterval(async () => {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const user = getUser(currentUser);
            if (user && user.id) {
                try {
                    await db.collection(COLLECTIONS.USERS).doc(user.id).update({
                        lastActive: new Date().toISOString()
                    });
                    await getAllUsers(true);
                } catch (error) {
                    console.error("Heartbeat error:", error);
                }
            }
        }, 30000);
    }

    // ========== CATEGORY MANAGEMENT ==========
    function openCategoryModal() {
        if (!canCreateCategory() && !canEditCategory()) {
            alert('You do not have permission to create/edit categories');
            return;
        }
        
        const isEdit = document.getElementById('editingCategoryId').value;
        document.getElementById('categoryModalTitle').innerHTML = isEdit ? '‚úèÔ∏è Edit Category' : '‚ûï Add New Category';
        document.getElementById('categoryModalSaveBtn').innerHTML = isEdit ? 'Update Category' : 'Create Category';
        document.getElementById('categoryNameInput').value = isEdit ? categories.find(c => c.id === document.getElementById('editingCategoryId').value)?.name || '' : '';
        document.getElementById('categoryModal').style.display = 'flex';
    }

    function closeCategoryModal() {
        document.getElementById('categoryModal').style.display = 'none';
        document.getElementById('editingCategoryId').value = '';
        document.getElementById('categoryNameInput').value = '';
    }

    function editCurrentCategory() {
        if (!canEditCategory()) {
            alert('You do not have permission to edit categories');
            return;
        }
        
        const category = categories.find(c => c.name === currentCategory);
        if (!category) return;
        
        document.getElementById('editingCategoryId').value = category.id;
        openCategoryModal();
    }

    async function saveNewCategory() {
        if (!canCreateCategory() && !canEditCategory()) {
            alert('You do not have permission to create/edit categories');
            return;
        }

        const name = document.getElementById('categoryNameInput').value.trim();
        const editingId = document.getElementById('editingCategoryId').value;
        
        if (!name) {
            alert('Category name is required');
            return;
        }

        try {
            if (editingId) {
                // Edit mode
                const oldCategory = categories.find(c => c.id === editingId);
                
                if (canEditCategoryWithoutApproval()) {
                    // Super Admin - Edit directly
                    await db.collection(COLLECTIONS.CATEGORIES).doc(editingId).update({
                        name: name,
                        lastModifiedBy: getCurrentUser(),
                        lastModifiedAt: new Date().toISOString()
                    });

                    await logAudit('UPDATE_CATEGORY', { 
                        categoryId: editingId,
                        oldName: oldCategory?.name,
                        newName: name,
                        updatedBy: getCurrentUser()
                    });

                    await loadAllData(true);
                    renderCategories();
                    closeCategoryModal();
                    showNotification(`Category updated to "${name}" successfully`, 'success');
                    populateCategoryDropdown();
                    
                    if (document.getElementById('categoryPageView').style.display === 'block') {
                        document.getElementById('categoryTitle').textContent = name;
                    }
                } else {
                    // Admin or Staff - Create approval request
                    await createApprovalRequest('category', { name: name }, 'edit', editingId);
                    closeCategoryModal();
                    showNotification('Category edit request submitted for approval', 'info');
                }
            } else {
                // Add mode
                if (canCreateCategoryWithoutApproval()) {
                    // Admin or Super Admin - Save directly
                    await db.collection(COLLECTIONS.CATEGORIES).add({
                        name: name,
                        createdAt: new Date().toISOString(),
                        createdBy: getCurrentUser()
                    });

                    await logAudit('CREATE_CATEGORY', { 
                        name: name,
                        createdBy: getCurrentUser()
                    });

                    await loadAllData(true);
                    renderCategories();
                    closeCategoryModal();
                    showNotification(`Category "${name}" created successfully`, 'success');
                    populateCategoryDropdown();
                } else {
                    // Staff - Create approval request
                    await createApprovalRequest('category', { name: name }, 'add', null);
                    closeCategoryModal();
                    showNotification('Category creation request submitted for approval', 'info');
                }
            }
        } catch (error) {
            console.error('Error saving category:', error);
            alert('Failed to save category: ' + error.message);
        }
    }

    async function deleteCategory(categoryId) {
        if (!canDeleteCategory()) {
            alert('You do not have permission to delete categories');
            return;
        }

        const category = categories.find(c => c.id === categoryId);
        if (!category) return;

        const currentUser = getUser(getCurrentUser());

        if (currentUser.role === 'super admin') {
            // Super Admin - Delete directly
            if (confirm(`Delete category "${category.name}"?`)) {
                try {
                    await db.collection(COLLECTIONS.CATEGORIES).doc(categoryId).delete();
                    await logAudit('DELETE_CATEGORY', { 
                        categoryId, 
                        name: category.name,
                        deletedBy: getCurrentUser() 
                    });
                    await loadAllData(true);
                    renderCategories();
                    showNotification('Category deleted', 'success');
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to delete');
                }
            }
        } else {
            // Admin or Staff - Require reason and create approval request
            openReasonModal('category', categoryId, category.name, async (type, id, name, reason) => {
                await createApprovalRequest('category', { name: name }, 'delete', id, reason);
                showNotification('Delete request submitted for approval', 'info');
            });
        }
    }

    function renderCategories() {
        const categoryGrid = document.getElementById('categoryGrid');
        if (!categoryGrid) return;

        const user = getUser(getCurrentUser());

        if (!categories || categories.length === 0) {
            categoryGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6b9080; padding: 60px; font-size: 1.2rem;">No categories yet ‚Äî click "New Category" to add your first category.</p>';
            return;
        }

        const categoryImagePath = './images/mainlogo3.png';
        
        categoryGrid.innerHTML = categories.map((cat, index) => {
            const supplierCount = suppliers.filter(s => s.category === cat.name).length;
            const fallbackColor = `hsl(${(index * 45) % 360}, 70%, 55%)`;
            
            const showDelete = canDeleteCategory();
            const isSuperAdmin = user && user.role === 'super admin';
            
            return `
                <div class="grid-item" onclick="openCategoryPage('${cat.id}')">
                    <div class="category-image-wrapper">
                        <img src="${categoryImagePath}" alt="${cat.name}" loading="lazy"
                             onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'category-fallback\' style=\'background: radial-gradient(circle at 30% 30%, ${fallbackColor}, #2c6b2c);\'>${cat.name.charAt(0)}</div>';">
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 18px 12px;">
                        <span style="font-weight: 600; font-size: 1rem; color: #1e3b37; margin-bottom: 8px;">${cat.name}</span>
                        <span style="background: #173979; color: white; padding: 6px 16px; border-radius: 40px; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 4px 8px rgba(76, 175, 80, 0.2);">
                            ${supplierCount} ${supplierCount === 1 ? 'Supplier' : 'Suppliers'}
                        </span>
                    </div>
                    ${showDelete && isSuperAdmin ? `<button class="btn-del" onclick="event.stopPropagation(); deleteCategory('${cat.id}')">Delete</button>` : ''}
                    ${showDelete && !isSuperAdmin ? `<button class="btn-request-delete" onclick="event.stopPropagation(); deleteCategory('${cat.id}')">Request Delete</button>` : ''}
                </div>
            `;
        }).join('');
    }

    // ========== SUPPLIER MANAGEMENT ==========
    function openSupplierModal() {
        if (!canCreateSupplier()) {
            alert('You do not have permission to add suppliers');
            return;
        }

        document.getElementById('supplierModalTitle').innerHTML = '‚ûï Add New Supplier';
        document.getElementById('supplierName').value = '';
        document.getElementById('supplierSpecialization').value = '';
        document.getElementById('supplierPhone').value = '';
        document.getElementById('supplierTpin').value = '';
        document.getElementById('supplierEmail').value = '';
        document.getElementById('supplierAddress').value = '';
        document.getElementById('editingSupplierId').value = '';
        document.getElementById('supplierActionType').value = 'add';
        
        document.getElementById('star3').checked = true;
        
        document.getElementById('complianceTpin').checked = false;
        document.getElementById('complianceNapsa').checked = false;
        document.getElementById('complianceZra').checked = false;
        document.getElementById('complianceZppa').checked = false;
        
        document.getElementById('supplierRenewalMonth').value = '11';
        
        uploadedDocuments = { tpin: null, napsa: null, zra: null, zppa: null };
        ['tpin', 'napsa', 'zra', 'zppa'].forEach(type => {
            const previewEl = document.getElementById(`${type}DocPreview`);
            if (previewEl) previewEl.innerHTML = '';
        });
        
        updateComplianceUI();
        
        populateCategoryDropdown();
        
        document.getElementById('supplierModal').style.display = 'flex';
    }

    function populateCategoryDropdown() {
        const select = document.getElementById('supplierCategory');
        if (!select) return;
        
        select.innerHTML = '<option value="">Select Category</option>';
        categories.forEach(cat => {
            select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
        });
    }

    function closeSupplierModal() {
        document.getElementById('supplierModal').style.display = 'none';
    }

    async function saveSupplier() {
        if (!canCreateSupplier() && !canEditSupplier()) {
            alert('You do not have permission to save suppliers');
            return;
        }

        const name = document.getElementById('supplierName').value.trim();
        const phone = document.getElementById('supplierPhone').value.trim();
        const category = document.getElementById('supplierCategory').value;
        
        if (!name || !phone || !category) {
            alert('Supplier Name, Phone Number, and Category are required');
            return;
        }

        let rating = 3;
        const ratingInputs = document.querySelectorAll('input[name="rating"]');
        for (let input of ratingInputs) {
            if (input.checked) {
                rating = parseInt(input.value);
                break;
            }
        }

        const renewalYear = document.getElementById('supplierRenewalYear').value;
        const renewalMonth = document.getElementById('supplierRenewalMonth').value;
        const renewalDate = new Date(renewalYear, parseInt(renewalMonth), 31).toISOString();

        const compliance = {
            tpin: document.getElementById('complianceTpin').checked ? 'yes' : 'no',
            napsa: document.getElementById('complianceNapsa').checked ? 'yes' : 'no',
            zra: document.getElementById('complianceZra').checked ? 'yes' : 'no',
            zppa: document.getElementById('complianceZppa').checked ? 'yes' : 'no'
        };

        const documents = [];
        for (let [type, doc] of Object.entries(uploadedDocuments)) {
            if (doc) {
                documents.push({
                    type: type,
                    name: doc.name,
                    size: doc.size,
                    uploadedAt: doc.uploadedAt,
                    data: doc.data
                });
            }
        }

        const supplierData = {
            name: name,
            specialization: document.getElementById('supplierSpecialization').value.trim(),
            phone: phone,
            tpin: document.getElementById('supplierTpin').value.trim(),
            email: document.getElementById('supplierEmail').value.trim(),
            address: document.getElementById('supplierAddress').value.trim(),
            category: category,
            rating: rating,
            compliance: compliance,
            renewalDate: renewalDate,
            documents: documents,
            images: [],
            lastModifiedBy: getCurrentUser(),
            lastModifiedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        const editingId = document.getElementById('editingSupplierId').value;
        const actionType = document.getElementById('supplierActionType').value;
        const currentUser = getUser(getCurrentUser());

        try {
            if (actionType === 'edit' && editingId) {
                // Get old data for audit log
                const oldSupplier = suppliers.find(s => s.id === editingId);
                
                if (currentUser.role === 'super admin' || currentUser.role === 'admin') {
                    // Admin or Super Admin - Update directly
                    await db.collection(COLLECTIONS.SUPPLIERS).doc(editingId).update(supplierData);
                    
                    // Track changes
                    const changes = {};
                    if (oldSupplier) {
                        for (let key in supplierData) {
                            if (JSON.stringify(oldSupplier[key]) !== JSON.stringify(supplierData[key])) {
                                changes[key] = { old: oldSupplier[key], new: supplierData[key] };
                            }
                        }
                    }
                    
                    await logAudit('UPDATE_SUPPLIER', {
                        supplierId: editingId,
                        name: name,
                        updatedBy: getCurrentUser(),
                        changes: changes
                    });

                    showNotification('Supplier updated successfully', 'success');
                } else {
                    // Staff - Create approval request
                    await createApprovalRequest('supplier', supplierData, 'edit', editingId);
                    closeSupplierModal();
                    showNotification('Supplier edit request submitted for approval', 'info');
                    return;
                }
            } else {
                if (currentUser.role === 'super admin' || currentUser.role === 'admin') {
                    // Admin or Super Admin - Add directly
                    await db.collection(COLLECTIONS.SUPPLIERS).add({
                        ...supplierData,
                        createdAt: new Date().toISOString(),
                        createdBy: getCurrentUser()
                    });

                    await logAudit('CREATE_SUPPLIER', {
                        name: name,
                        category: category,
                        createdBy: getCurrentUser()
                    });

                    showNotification('Supplier added successfully', 'success');
                } else {
                    // Staff - Create approval request
                    await createApprovalRequest('supplier', supplierData, 'add', null);
                    closeSupplierModal();
                    showNotification('Supplier addition request submitted for approval', 'info');
                    return;
                }
            }

            await loadAllData(true);
            closeSupplierModal();

            if (document.getElementById('categoryPageView').style.display === 'block') {
                const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
                renderSuppliersTable(categorySuppliers);
            }
        } catch (error) {
            console.error('Error saving supplier:', error);
            alert('Failed to save supplier: ' + error.message);
        }
    }

    function editSupplier(supplierId) {
        if (!canEditSupplier()) {
            alert('You do not have permission to edit suppliers');
            return;
        }

        const supplier = suppliers.find(s => s.id === supplierId);
        if (!supplier) return;

        document.getElementById('supplierModalTitle').innerHTML = '‚úèÔ∏è Edit Supplier';
        document.getElementById('supplierName').value = supplier.name || '';
        document.getElementById('supplierSpecialization').value = supplier.specialization || '';
        document.getElementById('supplierPhone').value = supplier.phone || '';
        document.getElementById('supplierTpin').value = supplier.tpin || '';
        document.getElementById('supplierEmail').value = supplier.email || '';
        document.getElementById('supplierAddress').value = supplier.address || '';
        document.getElementById('editingSupplierId').value = supplierId;
        document.getElementById('supplierActionType').value = 'edit';
        
        populateCategoryDropdown();
        setTimeout(() => {
            document.getElementById('supplierCategory').value = supplier.category || '';
        }, 100);
        
        const rating = supplier.rating || 3;
        document.querySelectorAll('input[name="rating"]').forEach(input => {
            input.checked = parseInt(input.value) === rating;
        });
        
        document.getElementById('complianceTpin').checked = supplier.compliance?.tpin === 'yes';
        document.getElementById('complianceNapsa').checked = supplier.compliance?.napsa === 'yes';
        document.getElementById('complianceZra').checked = supplier.compliance?.zra === 'yes';
        document.getElementById('complianceZppa').checked = supplier.compliance?.zppa === 'yes';
        
        if (supplier.renewalDate) {
            const date = new Date(supplier.renewalDate);
            document.getElementById('supplierRenewalMonth').value = date.getMonth().toString();
            document.getElementById('supplierRenewalYear').value = date.getFullYear().toString();
        }
        
        updateComplianceUI();
        
        uploadedDocuments = { tpin: null, napsa: null, zra: null, zppa: null };
        ['tpin', 'napsa', 'zra', 'zppa'].forEach(type => {
            const previewEl = document.getElementById(`${type}DocPreview`);
            if (previewEl) previewEl.innerHTML = '';
        });
        
        document.getElementById('supplierModal').style.display = 'flex';
    }

    async function deleteSupplier(supplierId) {
        if (!canDeleteSupplier()) {
            alert('You do not have permission to delete suppliers');
            return;
        }

        const supplier = suppliers.find(s => s.id === supplierId);
        if (!supplier) return;

        const currentUser = getUser(getCurrentUser());

        if (currentUser.role === 'super admin') {
            // Super Admin - Delete directly
            if (confirm(`Delete supplier "${supplier.name}"?`)) {
                try {
                    await db.collection(COLLECTIONS.SUPPLIERS).doc(supplierId).delete();
                    await logAudit('DELETE_SUPPLIER', { 
                        supplierId, 
                        name: supplier.name,
                        deletedBy: getCurrentUser() 
                    });
                    await loadAllData(true);
                    showNotification('Supplier deleted', 'success');
                    
                    if (document.getElementById('categoryPageView').style.display === 'block') {
                        const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
                        renderSuppliersTable(categorySuppliers);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to delete');
                }
            }
        } else {
            // Admin or Staff - Require reason and create approval request
            openReasonModal('supplier', supplierId, supplier.name, async (type, id, name, reason) => {
                await createApprovalRequest('supplier', { name: name }, 'delete', id, reason);
                showNotification('Delete request submitted for approval', 'info');
            });
        }
    }

    // ========== SUPPLIER TABLE ==========
    function openCategoryPage(categoryId) {
        const category = categories.find(cat => cat.id === categoryId);
        if (!category) return;
        currentCategory = category.name;
        currentCategoryId = categoryId;
        document.getElementById('categoryTitle').textContent = category.name;
        
        const categorySuppliers = suppliers.filter(s => s.category === category.name);
        renderSuppliersTable(categorySuppliers);
        showView('category');
    }

    function renderSuppliersTable(suppliersList) {
        const tbody = document.getElementById('supplierTableBody');
        if (!tbody) return;

        const user = getUser(getCurrentUser());

        if (!suppliersList || suppliersList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 20px;">No suppliers found in this category.</td></tr>';
            return;
        }

        tbody.innerHTML = suppliersList.map(s => {
            const daysRemaining = getDaysRemaining(s);
            const renewalClass = daysRemaining < 0 ? 'expired' : daysRemaining < 30 ? 'expiring' : '';
            
            const canEdit = canEditSupplier();
            const canDelete = canDeleteSupplier();
            const isSuperAdmin = user && user.role === 'super admin';
            
            // Create document thumbnail
            const docThumbnail = createDocumentThumbnail(
                s.documents ? { docs: s.documents } : null, 
                'supplier', 
                s.id, 
                s.name
            );

            // Get modification history
            const modifications = s.modifications || [];
            const modHistory = modifications.slice(0, 3).map(mod => 
                `<div class="modification-item"><span class="modification-field">${mod.field}</span> ‚Üí from <span class="modification-old">${mod.old}</span> to <span class="modification-new">${mod.new}</span> <span style="color: #999; font-size: 10px;">by ${mod.modifiedBy} on ${new Date(mod.modifiedAt).toLocaleDateString()}</span></div>`
            ).join('');
            
            return `
                <tr>
                    <td>${s.name || ''}</td>
                    <td>${s.specialization || ''}</td>
                    <td><a href="https://wa.me/${s.phone?.replace(/\D/g, '')}" target="_blank" class="clickable-phone" title="Open WhatsApp">${s.phone || ''}</a></td>
                    <td><a href="https://portal.zra.org.zm/searchTaxpayer" target="_blank" class="clickable-tpin" title="Search on ZRA Portal">${s.tpin || ''}</a></td>
                    <td><a href="mailto:${s.email || ''}" class="clickable-email" title="Send Email">${s.email || ''}</a></td>
                    <td>${s.address || ''}</td>
                    <td><div class="star-rating-view">${renderStars(s.rating || 0)}<span class="rating-value">${s.rating || 0}/5</span></div></td>
                    <td><div class="compliance-box">${renderCompliancePills(s)}</div></td>
                    <td>
                        <div class="vertical-life-bar-container">
                            <div class="vertical-life-bar-fill ${renewalClass}" style="height:${calculateRenewalPercentage(s)}%"></div>
                            <div class="vertical-life-bar-text">${daysRemaining}d</div>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; justify-content: center;">
                            ${docThumbnail}
                        </div>
                    </td>
                    <td>
                        <div class="modification-history">
                            <span style="cursor: pointer; background: #f0f0f0; padding: 4px 8px; border-radius: 12px; font-size: 11px; display: inline-block;">
                                üë§ ${s.lastModifiedBy || s.createdBy || 'System'} ‚ñº
                            </span>
                            <div class="modification-dropdown">
                                <div style="font-weight: 700; margin-bottom: 8px; color: #2c3e50; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                                    Modification History
                                    <span style="float: right; font-size: 10px; color: #999;">Last: ${formatDate(s.lastModifiedAt || s.createdAt)}</span>
                                </div>
                                ${modHistory || '<div style="color: #999; padding: 5px;">No modification history</div>'}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${canEdit ? `<button class="btn-edit" onclick="editSupplier('${s.id}')">Edit</button>` : ''}
                            ${canDelete && isSuperAdmin ? `<button class="btn-del" onclick="deleteSupplier('${s.id}')">Delete</button>` : ''}
                            ${canDelete && !isSuperAdmin ? `<button class="btn-request-delete" onclick="deleteSupplier('${s.id}')">Request Delete</button>` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // ========== LINKS MANAGEMENT ==========
    function renderLinks() {
        const tbody = document.getElementById('linksBody');
        if (!tbody) return;

        const user = getUser(getCurrentUser());
        const canDelete = canDeleteLink();
        const isSuperAdmin = user && user.role === 'super admin';

        if (!links || links.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No links found.</td></tr>';
            return;
        }

        tbody.innerHTML = links.map(link => `
            <tr>
                <td>${link.institution || ''}</td>
                <td><a href="${link.website}" target="_blank">${link.website}</a></td>
                <td>${link.email || ''}</td>
                <td>
                    <div class="action-buttons">
                        ${canDelete && isSuperAdmin ? 
                            `<button class="btn-del" onclick="deleteLink('${link.id}')">Delete</button>` : 
                            canDelete && !isSuperAdmin ? 
                            `<button class="btn-request-delete" onclick="deleteLink('${link.id}')">Request Delete</button>` : 
                            '‚Äî'}
                    </div>
                </td>
            </tr>
        `).join('');
    }

    async function addLink() {
        if (!canCreateLink()) {
            alert('You do not have permission to add links');
            return;
        }

        const institution = document.getElementById('instName').value.trim();
        const website = document.getElementById('instWeb').value.trim();
        const email = document.getElementById('instEmail').value.trim();
        const currentUser = getUser(getCurrentUser());
        
        if (!institution || !website) {
            alert("Institution and website are required");
            return;
        }

        try {
            if (currentUser.role === 'super admin' || currentUser.role === 'admin') {
                // Admin or Super Admin - Add directly
                const newLink = {
                    institution,
                    website,
                    email,
                    createdAt: new Date().toISOString(),
                    createdBy: getCurrentUser()
                };
                
                await db.collection(COLLECTIONS.LINKS).add(newLink);
                await logAudit('CREATE_LINK', { institution, website, email, createdBy: getCurrentUser() });
                await loadAllData(true);
                renderLinks();
                closeLinkModal();
                showNotification('Link added successfully');
            } else {
                // Staff - Create approval request
                await createApprovalRequest('link', { institution, website, email }, 'add', null);
                closeLinkModal();
                showNotification('Link addition request submitted for approval', 'info');
            }
        } catch (error) {
            console.error("Error adding link:", error);
            alert("Failed to add link");
        }
    }

    async function deleteLink(id) {
        if (!canDeleteLink()) {
            alert("You don't have permission to delete links");
            return;
        }

        const link = links.find(l => l.id === id);
        if (!link) return;

        const currentUser = getUser(getCurrentUser());

        if (currentUser.role === 'super admin') {
            // Super Admin - Delete directly
            if (confirm('Are you sure you want to delete this link?')) {
                try {
                    await db.collection(COLLECTIONS.LINKS).doc(id).delete();
                    await logAudit('DELETE_LINK', { 
                        institution: link?.institution,
                        website: link?.website,
                        deletedBy: getCurrentUser() 
                    });
                    await loadAllData(true);
                    renderLinks();
                    showNotification('Link deleted successfully');
                } catch (error) {
                    console.error("Error deleting link:", error);
                    alert("Failed to delete link");
                }
            }
        } else {
            // Admin or Staff - Require reason and create approval request
            openReasonModal('link', id, link.institution, async (type, id, name, reason) => {
                await createApprovalRequest('link', { name: name }, 'delete', id, reason);
                showNotification('Delete request submitted for approval', 'info');
            });
        }
    }

    // Add this helper function to track changes between old and new data
    function getChangeSummary(oldData, newData, excludeFields = ['id', 'createdAt', 'updatedAt', 'lastModifiedAt', 'lastModifiedBy', 'createdBy']) {
        const changes = [];
        const allKeys = new Set([...Object.keys(oldData || {}), ...Object.keys(newData || {})]);
        
        for (const key of allKeys) {
            if (excludeFields.includes(key)) continue;
            
            const oldValue = oldData?.[key];
            const newValue = newData?.[key];
            
            // Skip if both are undefined/null/empty
            if (!oldValue && !newValue) continue;
            
            // Handle objects (like compliance, documents)
            if (typeof oldValue === 'object' && typeof newValue === 'object' && oldValue !== null && newValue !== null) {
                const nestedChanges = getChangeSummary(oldValue, newValue, []);
                if (nestedChanges.length > 0) {
                    changes.push({
                        field: key,
                        oldValue: oldValue,
                        newValue: newValue,
                        type: 'object',
                        nestedChanges: nestedChanges
                    });
                }
            }
            // Handle primitive values
            else if (JSON.stringify(oldValue) !== JSON.stringify(newValue)) {
                changes.push({
                    field: key,
                    oldValue: oldValue || '(empty)',
                    newValue: newValue || '(empty)',
                    type: 'primitive'
                });
            }
        }
        
        return changes;
    }

    // Enhanced createApprovalRequest function that includes change summary
    async function createApprovalRequestWithChanges(type, newData, action, itemId, reason = null, oldData = null) {
        try {
            const currentUser = getUser(getCurrentUser());
            if (!currentUser) {
                alert('You must be logged in to create a request');
                return;
            }

            console.log(`Creating ${action} request for ${type}:`, newData);
            
            // Calculate changes if this is an edit
            let changeSummary = null;
            let changeDescription = '';
            
            if (action === 'edit' && oldData) {
                const changes = getChangeSummary(oldData, newData);
                changeSummary = changes;
                
                // Create a human-readable description
                if (changes.length > 0) {
                    changeDescription = changes.map(change => {
                        if (change.type === 'object' && change.nestedChanges) {
                            const nestedDesc = change.nestedChanges.map(n => 
                                `${n.field}: "${n.oldValue}" ‚Üí "${n.newValue}"`
                            ).join(', ');
                            return `${change.field} (${nestedDesc})`;
                        } else {
                            return `${change.field}: "${change.oldValue}" ‚Üí "${change.newValue}"`;
                        }
                    }).join('; ');
                }
            }
            
            const request = {
                type: type,
                action: action,
                itemId: itemId,
                requestedBy: getCurrentUser(),
                requestedByRole: currentUser.role,
                requestedData: newData,
                oldData: oldData, // Store old data for comparison
                changeSummary: changeSummary,
                changeDescription: changeDescription,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdDate: new Date().toISOString()
            };
            
            if (reason) {
                request.reason = reason;
            }
            
            const docRef = await db.collection(COLLECTIONS.APPROVALS).add(request);
            console.log(`Request created with ID: ${docRef.id}`);
            
            await loadApprovalRequests();
            updateApprovalsButton();
            updateRequestCounts();
            
            showNotification('‚úÖ Approval request submitted successfully', 'success');
        } catch (error) {
            console.error('Error creating approval request:', error);
            alert('Failed to create approval request: ' + error.message);
        }
    }

    // Enhanced saveSupplier function with change tracking
    async function saveSupplierWithChangeTracking() {
        if (!canCreateSupplier() && !canEditSupplier()) {
            alert('You do not have permission to save suppliers');
            return;
        }

        const name = document.getElementById('supplierName').value.trim();
        const phone = document.getElementById('supplierPhone').value.trim();
        const category = document.getElementById('supplierCategory').value;
        
        if (!name || !phone || !category) {
            alert('Supplier Name, Phone Number, and Category are required');
            return;
        }

        let rating = 3;
        const ratingInputs = document.querySelectorAll('input[name="rating"]');
        for (let input of ratingInputs) {
            if (input.checked) {
                rating = parseInt(input.value);
                break;
            }
        }

        const renewalYear = document.getElementById('supplierRenewalYear').value;
        const renewalMonth = document.getElementById('supplierRenewalMonth').value;
        const renewalDate = new Date(renewalYear, parseInt(renewalMonth), 31).toISOString();

        const compliance = {
            tpin: document.getElementById('complianceTpin').checked ? 'yes' : 'no',
            napsa: document.getElementById('complianceNapsa').checked ? 'yes' : 'no',
            zra: document.getElementById('complianceZra').checked ? 'yes' : 'no',
            zppa: document.getElementById('complianceZppa').checked ? 'yes' : 'no'
        };

        const documents = [];
        for (let [type, doc] of Object.entries(uploadedDocuments)) {
            if (doc) {
                documents.push({
                    type: type,
                    name: doc.name,
                    size: doc.size,
                    uploadedAt: doc.uploadedAt,
                    data: doc.data
                });
            }
        }

        const supplierData = {
            name: name,
            specialization: document.getElementById('supplierSpecialization').value.trim(),
            phone: phone,
            tpin: document.getElementById('supplierTpin').value.trim(),
            email: document.getElementById('supplierEmail').value.trim(),
            address: document.getElementById('supplierAddress').value.trim(),
            category: category,
            rating: rating,
            compliance: compliance,
            renewalDate: renewalDate,
            documents: documents,
            images: [],
            lastModifiedBy: getCurrentUser(),
            lastModifiedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        const editingId = document.getElementById('editingSupplierId').value;
        const actionType = document.getElementById('supplierActionType').value;
        const currentUser = getUser(getCurrentUser());

        try {
            if (actionType === 'edit' && editingId) {
                // Get old data for change tracking
                const oldSupplier = suppliers.find(s => s.id === editingId);
                
                if (currentUser.role === 'super admin' || currentUser.role === 'admin') {
                    // Admin or Super Admin - Update directly
                    await db.collection(COLLECTIONS.SUPPLIERS).doc(editingId).update(supplierData);
                    
                    // Track changes for audit log
                    const changes = getChangeSummary(oldSupplier, supplierData);
                    
                    await logAudit('UPDATE_SUPPLIER', {
                        supplierId: editingId,
                        name: name,
                        updatedBy: getCurrentUser(),
                        changes: changes,
                        changeDescription: changes.map(c => `${c.field}: "${c.oldValue}" ‚Üí "${c.newValue}"`).join('; ')
                    });

                    showNotification('Supplier updated successfully', 'success');
                } else {
                    // Staff - Create approval request with change summary
                    await createApprovalRequestWithChanges(
                        'supplier', 
                        supplierData, 
                        'edit', 
                        editingId,
                        null,
                        oldSupplier  // Pass old data for comparison
                    );
                    closeSupplierModal();
                    showNotification('Supplier edit request submitted for approval. Changes: ' + 
                        getChangeSummary(oldSupplier, supplierData).map(c => 
                            `${c.field}: "${c.oldValue}" ‚Üí "${c.newValue}"`
                        ).join(', '), 'info');
                    return;
                }
            } else {
                if (currentUser.role === 'super admin' || currentUser.role === 'admin') {
                    // Admin or Super Admin - Add directly
                    await db.collection(COLLECTIONS.SUPPLIERS).add({
                        ...supplierData,
                        createdAt: new Date().toISOString(),
                        createdBy: getCurrentUser()
                    });

                    await logAudit('CREATE_SUPPLIER', {
                        name: name,
                        category: category,
                        createdBy: getCurrentUser()
                    });

                    showNotification('Supplier added successfully', 'success');
                } else {
                    // Staff - Create approval request for addition
                    await createApprovalRequestWithChanges('supplier', supplierData, 'add', null);
                    closeSupplierModal();
                    showNotification('Supplier addition request submitted for approval', 'info');
                    return;
                }
            }

            await loadAllData(true);
            closeSupplierModal();

            if (document.getElementById('categoryPageView').style.display === 'block') {
                const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
                renderSuppliersTable(categorySuppliers);
            }
        } catch (error) {
            console.error('Error saving supplier:', error);
            alert('Failed to save supplier: ' + error.message);
        }
    }

    // Enhanced category save function with change tracking
    async function saveCategoryWithChangeTracking() {
        if (!canCreateCategory() && !canEditCategory()) {
            alert('You do not have permission to create/edit categories');
            return;
        }

        const name = document.getElementById('categoryNameInput').value.trim();
        const editingId = document.getElementById('editingCategoryId').value;
        
        if (!name) {
            alert('Category name is required');
            return;
        }

        try {
            if (editingId) {
                // Edit mode
                const oldCategory = categories.find(c => c.id === editingId);
                
                if (canEditCategoryWithoutApproval()) {
                    // Super Admin - Edit directly
                    await db.collection(COLLECTIONS.CATEGORIES).doc(editingId).update({
                        name: name,
                        lastModifiedBy: getCurrentUser(),
                        lastModifiedAt: new Date().toISOString()
                    });

                    await logAudit('UPDATE_CATEGORY', { 
                        categoryId: editingId,
                        oldName: oldCategory?.name,
                        newName: name,
                        changeDescription: `Category name changed from "${oldCategory?.name}" to "${name}"`,
                        updatedBy: getCurrentUser()
                    });

                    await loadAllData(true);
                    renderCategories();
                    closeCategoryModal();
                    showNotification(`Category updated from "${oldCategory?.name}" to "${name}" successfully`, 'success');
                    populateCategoryDropdown();
                    
                    if (document.getElementById('categoryPageView').style.display === 'block') {
                        document.getElementById('categoryTitle').textContent = name;
                    }
                } else {
                    // Admin or Staff - Create approval request with change summary
                    await createApprovalRequestWithChanges(
                        'category', 
                        { name: name }, 
                        'edit', 
                        editingId,
                        null,
                        oldCategory  // Pass old data for comparison
                    );
                    closeCategoryModal();
                    showNotification(`Category edit request submitted for approval: "${oldCategory?.name}" ‚Üí "${name}"`, 'info');
                }
            } else {
                // Add mode
                if (canCreateCategoryWithoutApproval()) {
                    // Admin or Super Admin - Save directly
                    await db.collection(COLLECTIONS.CATEGORIES).add({
                        name: name,
                        createdAt: new Date().toISOString(),
                        createdBy: getCurrentUser()
                    });

                    await logAudit('CREATE_CATEGORY', { 
                        name: name,
                        createdBy: getCurrentUser()
                    });

                    await loadAllData(true);
                    renderCategories();
                    closeCategoryModal();
                    showNotification(`Category "${name}" created successfully`, 'success');
                    populateCategoryDropdown();
                } else {
                    // Staff - Create approval request
                    await createApprovalRequestWithChanges('category', { name: name }, 'add', null);
                    closeCategoryModal();
                    showNotification('Category creation request submitted for approval', 'info');
                }
            }
        } catch (error) {
            console.error('Error saving category:', error);
            alert('Failed to save category: ' + error.message);
        }
    }

    // Enhanced delete function with reason
    async function deleteSupplierWithReason(supplierId) {
        if (!canDeleteSupplier()) {
            alert('You do not have permission to delete suppliers');
            return;
        }

        const supplier = suppliers.find(s => s.id === supplierId);
        if (!supplier) return;

        const currentUser = getUser(getCurrentUser());

        if (currentUser.role === 'super admin') {
            // Super Admin - Delete directly (no approval needed)
            if (confirm(`Delete supplier "${supplier.name}"?`)) {
                try {
                    await db.collection(COLLECTIONS.SUPPLIERS).doc(supplierId).delete();
                    await logAudit('DELETE_SUPPLIER', { 
                        supplierId, 
                        name: supplier.name,
                        deletedBy: getCurrentUser() 
                    });
                    await loadAllData(true);
                    showNotification('Supplier deleted', 'success');
                    
                    if (document.getElementById('categoryPageView').style.display === 'block') {
                        const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
                        renderSuppliersTable(categorySuppliers);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to delete');
                }
            }
        } else {
            // Admin or Staff - Require reason and create approval request
            openReasonModal('supplier', supplierId, supplier.name, async (type, id, name, reason) => {
                await createApprovalRequestWithChanges(
                    'supplier', 
                    { name: name, role: currentUser.role }, 
                    'delete', 
                    id, 
                    reason,
                    supplier  // Pass the full supplier data for context
                );
                showNotification(`Delete request submitted for approval for supplier "${name}". Reason: ${reason}`, 'info');
            });
        }
    }

    // Enhanced renderApprovalRequestModal to show specific changes
    function renderEnhancedApprovalRequests() {
        const container = document.getElementById('pendingApprovalsList');
        const currentUser = getUser(getCurrentUser());
        
        if (!currentUser) return;
        
        let visibleRequests = approvalRequests;
        if (currentUser.role === 'admin') {
            visibleRequests = approvalRequests.filter(req => 
                req.requestedByRole === 'staff' || req.requestedByRole === 'admin'
            );
        }
        
        if (visibleRequests.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">‚úÖ No pending approval requests</div>';
            return;
        }
        
        let html = '';
        visibleRequests.forEach(req => {
            const created = req.createdDate ? new Date(req.createdDate) : new Date();
            const timeStr = created.toLocaleString();
            
            const actionColor = req.action === 'delete' ? '#e74c3c' : 
                              req.action === 'edit' ? '#f39c12' : '#3498db';
            
            // Build change summary HTML
            let changeSummaryHtml = '';
            if (req.changeSummary && req.changeSummary.length > 0) {
                changeSummaryHtml = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #2c3e50;">üìã SPECIFIC CHANGES:</div>
                        ${req.changeSummary.map(change => {
                            if (change.type === 'object' && change.nestedChanges) {
                                return `
                                    <div style="margin-bottom: 12px; border-bottom: 1px dashed #ddd; padding-bottom: 8px;">
                                        <div style="font-weight: bold; color: #e67e22; text-transform: capitalize;">${change.field}:</div>
                                        ${change.nestedChanges.map(n => `
                                            <div style="display: flex; margin-left: 20px; font-size: 13px;">
                                                <span style="min-width: 100px; color: #555;">${n.field}:</span>
                                                <span style="color: #e74c3c; text-decoration: line-through; margin-right: 10px;">${n.oldValue}</span>
                                                <span style="color: #27ae60;">‚Üí ${n.newValue}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;
                            } else {
                                return `
                                    <div style="display: flex; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                                        <span style="min-width: 120px; font-weight: bold; color: #2c3e50; text-transform: capitalize;">${change.field}:</span>
                                        <div style="flex: 1;">
                                            <span style="color: #e74c3c; text-decoration: line-through; background: #fee9e7; padding: 2px 8px; border-radius: 4px; margin-right: 10px;">${change.oldValue}</span>
                                            <span style="color: #27ae60; background: #e8f8f5; padding: 2px 8px; border-radius: 4px;">‚Üí ${change.newValue}</span>
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                `;
            } else if (req.changeDescription) {
                changeSummaryHtml = `
                    <div style="background: #fff8e7; border-left: 4px solid #f39c12; padding: 12px; margin: 15px 0; border-radius: 8px;">
                        <strong style="color: #f39c12;">CHANGES:</strong>
                        <p style="margin: 5px 0 0 0; font-size: 13px;">${req.changeDescription}</p>
                    </div>
                `;
            }
            
            // For delete requests, show what's being deleted
            if (req.action === 'delete' && req.oldData) {
                changeSummaryHtml = `
                    <div style="background: #fee9e7; border-left: 4px solid #e74c3c; padding: 15px; margin: 15px 0; border-radius: 8px;">
                        <div style="font-weight: bold; color: #e74c3c; margin-bottom: 10px;">üóëÔ∏è ITEM TO BE DELETED:</div>
                        <pre style="background: white; padding: 10px; border-radius: 5px; font-size: 12px; overflow-x: auto;">${JSON.stringify(req.oldData, null, 2)}</pre>
                        ${req.reason ? `<div style="margin-top: 10px;"><strong>Reason:</strong> ${req.reason}</div>` : ''}
                    </div>
                `;
            }
            
            // For add requests, show what's being added
            if (req.action === 'add' && req.requestedData) {
                const data = req.requestedData;
                const dataPreview = Object.entries(data)
                    .filter(([key]) => !['documents', 'images', 'id'].includes(key))
                    .map(([key, value]) => `<strong>${key}:</strong> ${value || '(empty)'}`)
                    .join('<br>');
                
                changeSummaryHtml = `
                    <div style="background: #e8f8f5; border-left: 4px solid #27ae60; padding: 15px; margin: 15px 0; border-radius: 8px;">
                        <div style="font-weight: bold; color: #27ae60; margin-bottom: 10px;">‚ûï NEW ITEM TO BE ADDED:</div>
                        <div style="background: white; padding: 10px; border-radius: 5px; font-size: 13px;">${dataPreview}</div>
                    </div>
                `;
            }
            
            html += `
                <div class="approval-request-item" style="border-left-color: ${actionColor}; border-left-width: 6px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="font-weight: bold; color: ${actionColor}; text-transform: uppercase; background: ${actionColor}20; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
                            ‚è≥ ${req.action?.toUpperCase() || 'ACTION'} - ${req.type?.toUpperCase() || 'ITEM'}
                        </span>
                        <span style="font-size: 11px; color: #666; background: #f0f0f0; padding: 4px 8px; border-radius: 12px;">
                            ${timeStr}
                        </span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px; margin-bottom: 15px;">
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 4px;">üë§ REQUESTED BY</div>
                            <div style="font-weight: 600; font-size: 14px;">${req.requestedBy || 'Unknown'}</div>
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                                <span class="role-badge" style="background: ${req.requestedByRole === 'super admin' ? '#9b59b6' : req.requestedByRole === 'admin' ? '#3498db' : '#2ecc71'}; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;">
                                    ${req.requestedByRole || 'staff'}
                                </span>
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 4px;">üì¶ ITEM DETAILS</div>
                            <div style="font-weight: 600; font-size: 14px;">${req.requestedData?.name || req.oldData?.name || (req.type === 'category' ? 'Category' : 'Supplier')}</div>
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                                ID: ${req.itemId?.substring(0, 8) || 'N/A'}
                            </div>
                        </div>
                    </div>
                    
                    ${req.reason ? `
                    <div style="background: #fff8e7; border-left: 4px solid #f39c12; padding: 12px; margin-bottom: 15px; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <span style="background: #f39c12; color: white; padding: 2px 10px; border-radius: 30px; font-size: 10px; font-weight: 700;">REASON</span>
                            <span style="font-size: 11px; color: #666;">Provided by ${req.requestedBy}</span>
                        </div>
                        <p style="margin: 0; color: #2c3e50; font-size: 13px;">${req.reason}</p>
                    </div>
                    ` : ''}
                    
                    ${changeSummaryHtml}
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button class="btn-approve" style="background: #27ae60; padding: 8px 20px; font-size: 13px; font-weight: bold;" onclick="openApprovalActionModal('${req.id}')">
                            ‚úì REVIEW REQUEST
                        </button>
                        ${isCurrentUserSuperAdmin() ? 
                            `<button class="btn-del" style="background: #95a5a6; padding: 8px 16px;" onclick="deleteApprovalRequest('${req.id}')">
                                üóëÔ∏è DELETE
                            </button>` : ''
                        }
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    // Enhanced approval action modal to show changes
    async function openEnhancedApprovalActionModal(requestId) {
        const request = approvalRequests.find(r => r.id === requestId);
        if (!request) return;
        
        localStorage.setItem('currentApprovalRequestId', requestId);
        
        const detailsDiv = document.getElementById('approvalActionDetails');
        const actionColor = request.action === 'delete' ? '#e74c3c' : 
                           request.action === 'edit' ? '#f39c12' : '#3498db';
        
        let changesHtml = '';
        
        if (request.changeSummary && request.changeSummary.length > 0) {
            changesHtml = `
                <div style="margin-top: 20px; border-top: 2px solid ${actionColor}; padding-top: 15px;">
                    <h4 style="color: ${actionColor}; margin-bottom: 15px;">üìã SPECIFIC CHANGES TO BE APPLIED:</h4>
                    ${request.changeSummary.map(change => {
                        if (change.type === 'object' && change.nestedChanges) {
                            return `
                                <div style="margin-bottom: 15px; background: #f8f9fa; padding: 12px; border-radius: 8px;">
                                    <div style="font-weight: bold; color: #e67e22; margin-bottom: 8px; text-transform: capitalize;">${change.field}</div>
                                    ${change.nestedChanges.map(n => `
                                        <div style="display: flex; margin-bottom: 5px;">
                                            <span style="min-width: 100px; font-weight: 500;">${n.field}:</span>
                                            <div style="flex: 1;">
                                                <span style="color: #e74c3c; text-decoration: line-through; margin-right: 10px;">${n.oldValue}</span>
                                                <span style="color: #27ae60;">‚Üí ${n.newValue}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        } else {
                            return `
                                <div style="display: flex; margin-bottom: 10px; background: #f8f9fa; padding: 8px 12px; border-radius: 8px;">
                                    <span style="min-width: 120px; font-weight: bold; text-transform: capitalize;">${change.field}:</span>
                                    <div style="flex: 1;">
                                        <span style="color: #e74c3c; text-decoration: line-through; margin-right: 10px;">${change.oldValue}</span>
                                        <span style="color: #27ae60;">‚Üí ${change.newValue}</span>
                                    </div>
                                </div>
                            `;
                        }
                    }).join('')}
                </div>
            `;
        }
        
        let detailsHtml = `
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <p><strong>Request Type:</strong> <span style="color: ${actionColor}; font-weight: bold;">${request.action.toUpperCase()} ${request.type.toUpperCase()}</span></p>
                <p><strong>Requested By:</strong> ${request.requestedBy} <span class="role-badge" style="background: ${request.requestedByRole === 'super admin' ? '#9b59b6' : request.requestedByRole === 'admin' ? '#3498db' : '#2ecc71'};">${request.requestedByRole}</span></p>
                <p><strong>Date:</strong> ${new Date(request.createdAt?.toDate ? request.createdAt.toDate() : request.createdAt).toLocaleString()}</p>
                <p><strong>Item ID:</strong> ${request.itemId || 'N/A'}</p>
            </div>
        `;
        
        if (request.reason) {
            detailsHtml += `
                <div style="margin-top: 15px; padding: 12px; background: #fff8e7; border-left: 4px solid #f39c12; border-radius: 8px;">
                    <strong style="color: #f39c12;">Reason:</strong>
                    <p style="margin: 5px 0 0 0; font-size: 13px;">${request.reason}</p>
                </div>
            `;
        }
        
        detailsHtml += changesHtml;
        
        if (!request.changeSummary && request.action === 'edit') {
            detailsHtml += `
                <div style="margin-top: 15px;">
                    <strong>Full Request Data:</strong>
                    <pre style="background: #fff; padding: 10px; border-radius: 5px; font-size: 12px; overflow-x: auto; max-height: 200px;">${JSON.stringify(request.requestedData, null, 2)}</pre>
                </div>
            `;
        }
        
        detailsDiv.innerHTML = detailsHtml;
        document.getElementById('approvalActionTitle').innerHTML = `Review ${request.action} Request`;
        document.getElementById('approvalActionModal').style.display = 'flex';
    }

    // Override the original functions with enhanced versions
    const originalOpenApprovalActionModal = window.openApprovalActionModal;
    window.openApprovalActionModal = openEnhancedApprovalActionModal;

    // Replace the supplier save function
    window.saveSupplier = saveSupplierWithChangeTracking;

    // Replace the category save function
    window.saveNewCategory = saveCategoryWithChangeTracking;

    // Replace delete supplier function
    window.deleteSupplier = deleteSupplierWithReason;

    function openLinkModal() { 
        if (!canCreateLink()) {
            alert('You do not have permission to add links');
            return;
        }
        document.getElementById('linkModal').style.display = 'flex'; 
    }
    
    function closeLinkModal() { 
        document.getElementById('linkModal').style.display = 'none'; 
        document.getElementById('instName').value = '';
        document.getElementById('instWeb').value = '';
        document.getElementById('instEmail').value = '';
    }

    // ========== USER MANAGEMENT WITH APPROVAL FOR STAFF ==========
    async function manageUsersModal() {
        const currentUser = getCurrentUser();
        const curUser = getUser(currentUser);
        
        if (!curUser) {
            alert("Please log in first");
            return;
        }

        await getAllUsers(true);
        
        const tbody = document.getElementById('userMgmtTableBody');
        let html = '';

        for (let u of userAccounts) {
            // Staff can only see staff users with masked data
            const canSeeFullData = (curUser.role === 'super admin' || curUser.role === 'admin');
            
            let displayEmail = '';
            let displayNrc = '';
            let displayPhone = u.phone || '';
            
            if (curUser.role === 'super admin') {
                displayEmail = u.email || '';
                displayNrc = u.nrc || '';
            } else if (curUser.role === 'admin') {
                // Admin sees all but with masked data for non-super admin users
                if (u.role === 'super admin') {
                    continue; // Admin shouldn't see super admin users
                }
                displayEmail = u.email || '****@****';
                displayNrc = '******';
            } else if (curUser.role === 'staff') {
                // Staff only sees staff users with masked data
                if (u.role !== 'staff') {
                    continue;
                }
                displayEmail = '****@****';
                displayNrc = '******';
            }

            const status = u.enabled ? 
                '<span style="color:green; font-weight:bold;">Enabled</span>' : 
                '<span style="color:red; font-weight:bold;">Disabled</span>';
            
            // Check if current user can edit/delete this user
            const canEdit = (curUser.role === 'super admin') || 
                           (curUser.role === 'admin' && u.role !== 'super admin' && u.role !== 'admin') ||
                           (curUser.role === 'staff' && u.role === 'staff');
            
            const canDelete = (curUser.role === 'super admin' && !isJoseph(u.username)) ||
                             (curUser.role === 'admin' && u.role === 'staff') ||
                             (curUser.role === 'staff' && u.role === 'staff' && !isJoseph(u.username));
            
            let actions = '';
            if (canEdit) {
                actions += `<button class="btn-edit" onclick="openEditUserModal('${u.id}')">Edit</button> `;
            }
            if (canDelete) {
                actions += `<button class="btn-del" onclick="deleteUser('${u.id}')">Delete</button>`;
            }
            if (!actions) actions = '‚Äî';

            const roleClass = u.role.replace(' ', '');
            
            html += `<tr>
    <td>
        ${u.username}
        ${isJoseph(u.username) ? ' üîí' : ''}
        <br><span style="font-size: 11px; color: #666;">${u.fullName || ''}</span>
    </td>
    <td><span class="role-badge role-${roleClass}">${u.role}</span></td>
    <td>${displayPhone}</td>
    <td>${displayEmail}<br><span style="font-size:11px; color:#666;">NRC: ${displayNrc}</span></td>
    <td>
        ${status}
        <div style="display: flex; gap: 5px; justify-content: center; margin-top: 8px;">
            ${u.documents?.degree && canSeeFullData ? 
                `<button onclick="viewUserDocument('${u.id}', 'degree', event)" style="background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 20px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;" title="View Degree/Diploma">
                    <span>üéì</span> Degree
                </button>` 
                : '<span style="color: #ccc; font-size: 11px; background: #f0f0f0; padding: 5px 10px; border-radius: 20px;">üéì No Degree</span>'}
        </div>
        <div style="display: flex; gap: 5px; justify-content: center; margin-top: 5px;">
            ${u.documents?.zips && canSeeFullData ? 
                `<button onclick="viewUserDocument('${u.id}', 'zips', event)" style="background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 20px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;" title="View ZIPS Certificate">
                    <span>üìú</span> ZIPS
                </button>` 
                : '<span style="color: #ccc; font-size: 11px; background: #f0f0f0; padding: 5px 10px; border-radius: 20px;">üìú No ZIPS</span>'}
        </div>
        <div style="display: flex; gap: 5px; justify-content: center; margin-top: 5px;">
            ${u.documents?.nrc && canSeeFullData ? 
                `<button onclick="viewUserDocument('${u.id}', 'nrc', event)" style="background: #e67e22; color: white; border: none; padding: 5px 10px; border-radius: 20px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;" title="View NRC">
                    <span>ü™™</span> NRC
                </button>` 
                : '<span style="color: #ccc; font-size: 11px; background: #f0f0f0; padding: 5px 10px; border-radius: 20px;">ü™™ No NRC</span>'}
        </div>
    </td>
    <td><div class="action-buttons">${actions}</div></td>
</tr>`;
        }

        tbody.innerHTML = html;
        document.getElementById('userManagementModal').style.display = 'flex';
    }

    function closeUserMgmtModal() { 
        document.getElementById('userManagementModal').style.display = 'none'; 
    }

    function openAddUserModal() {
        if (!canAddUser()) {
            alert("You don't have permission to add users");
            return;
        }

        document.getElementById('addUserTitle').innerText = '‚ûï Add New User';
        
        ['newFullName', 'newUsername', 'newNrc', 'newEmail', 'newPhone', 'newInstitution', 'newPosition', 'newPassword'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        
        // Reset document previews
        ['newDegreeDocPreview', 'newZipsDocPreview', 'newNrcDocPreview'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = '';
        });
        
        userUploadedDocuments = { degree: null, zips: null, nrc: null };
        
        document.getElementById('newRole').value = 'staff';

        const currentUser = getUser(getCurrentUser());
        
        if (currentUser.role === 'staff') {
            // Staff can only add staff users - disable other options
            const roleSelect = document.getElementById('newRole');
            for (let i = 0; i < roleSelect.options.length; i++) {
                if (roleSelect.options[i].value !== 'staff') {
                    roleSelect.options[i].disabled = true;
                }
            }
        } else if (currentUser.role === 'admin') {
            // Admin can add staff and admin users
            const roleSelect = document.getElementById('newRole');
            for (let i = 0; i < roleSelect.options.length; i++) {
                if (roleSelect.options[i].value === 'super admin') {
                    roleSelect.options[i].disabled = true;
                } else {
                    roleSelect.options[i].disabled = false;
                }
            }
        } else if (currentUser.role === 'super admin') {
            // Super admin can add any role
            document.querySelectorAll('#newRole option').forEach(opt => opt.disabled = false);
        }

        document.getElementById('addUserModal').style.display = 'flex';
    }

    // ========== SESSIONS PANEL ==========
    async function toggleSessionsPanel() {
        if (!canViewSessions()) {
            alert('You do not have permission to view sessions');
            return;
        }

        const panel = document.getElementById('sessionsPanel');
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
            return;
        }

        await getAllUsers(true);
        const listDiv = document.getElementById('activeSessionsList');
        const now = new Date();
        let html = '';

        for (let u of userAccounts) {
            if (!u.enabled) continue;
            
            const lastActive = u.lastActive ? new Date(u.lastActive) : null;
            const isOnline = lastActive && (now - lastActive) < 300000;
            
            let timeAgo = 'Never';
            if (lastActive) {
                const diffMs = now - lastActive;
                const diffMins = Math.floor(diffMs / 60000);
                if (diffMins < 1) timeAgo = 'Just now';
                else if (diffMins < 60) timeAgo = `${diffMins} min ago`;
                else timeAgo = `${Math.floor(diffMins / 60)}h ${diffMins % 60}m ago`;
            }

            html += `
                <div style="padding:10px; border-bottom:1px solid #eee;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span class="online-indicator ${isOnline ? 'pulse-online beaming' : 'offline-grey'}"></span>
                        <strong>${u.username}</strong>
                        <span style="font-size:11px; background:#f0f0f0; padding:2px 6px; border-radius:12px;">${u.role}</span>
                    </div>
                    <div style="font-size:11px; color:#666; margin-top:4px;">
                        Last active: ${timeAgo}
                    </div>
                </div>
            `;
        }

        listDiv.innerHTML = html || '<p style="padding:15px; text-align:center; color:#888;">No users found</p>';
        panel.style.display = 'block';
    }

    // ========== EXPORT BACKUP (SUPER ADMIN ONLY) ==========
    async function exportData() {
        if (!isCurrentUserSuperAdmin()) {
            alert("Only super admin can export backup");
            return;
        }

        try {
            await loadAllData(true);
            await getAllUsers(true);
            await loadAuditLogs();

            const backup = {
                categories,
                suppliers,
                links,
                users: userAccounts.map(u => {
                    const { password, ...safeUser } = u;
                    return safeUser;
                }),
                auditLogs: auditLogs.slice(0, 100),
                exportedAt: new Date().toISOString(),
                exportedBy: getCurrentUser()
            };

            const dataStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `zamcom_backup_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            await logAudit('EXPORT_BACKUP', {
                recordCounts: {
                    categories: categories.length,
                    suppliers: suppliers.length,
                    links: links.length,
                    users: userAccounts.length
                }
            });
            
            showNotification('Backup downloaded successfully (super admin only)');
        } catch (error) {
            console.error("Export error:", error);
            alert("Failed to export backup");
        }
    }

    function importData(event) {
        if (!isCurrentUserSuperAdmin()) {
            alert("Only super admin can import data");
            event.target.value = '';
            return;
        }
        alert('Import & Merge feature - Firestore implementation pending');
        event.target.value = '';
    }

    // ========== UI HELPER FUNCTIONS ==========
    function showView(viewName) {
        document.getElementById('homeView').style.display = 'none';
        document.getElementById('categoryPageView').style.display = 'none';
        document.getElementById('aboutView').style.display = 'none';
        document.getElementById('contactView').style.display = 'none';
        document.getElementById('linksView').style.display = 'none';
        document.getElementById('auditLogsView').style.display = 'none';
        document.getElementById('userApprovalHistoryView').style.display = 'none';
        document.getElementById('searchResultSection').style.display = 'none';
        
        if (viewName === 'home') {
            document.getElementById('homeView').style.display = 'block';
            renderCategories();
        } else if (viewName === 'category') {
            document.getElementById('categoryPageView').style.display = 'block';
        } else if (viewName === 'about') {
            document.getElementById('aboutView').style.display = 'block';
        } else if (viewName === 'contact') {
            document.getElementById('contactView').style.display = 'block';
        } else if (viewName === 'links') {
            document.getElementById('linksView').style.display = 'block';
            renderLinks();
        } else if (viewName === 'auditLogs') {
            document.getElementById('auditLogsView').style.display = 'block';
        } else if (viewName === 'userApprovalHistory') {
            document.getElementById('userApprovalHistoryView').style.display = 'block';
            loadUserApprovalHistory('pending');
        }
    }

    function updateGreeting() {
        const hour = new Date().getHours();
        const user = getCurrentUser() || 'User';
        const msg = hour < 12 ? "Good Morning" : hour < 18 ? "Good Afternoon" : "Good Evening";
        const greetingEl = document.getElementById('greeting');
        if (greetingEl) greetingEl.innerHTML = `<i>${msg}, ${user}</i>`;
    }

    function updateUserDisplay() {
    const currentUser = getCurrentUser();
    const userInfo = document.getElementById('currentUserDisplay');
    const roleBadge = document.getElementById('userRoleBadge');
    
    if (currentUser && userInfo) {
        const user = getUser(currentUser);
        if (user) {
            userInfo.innerHTML = `
                <div class="user-menu">
                    <button class="user-menu-button">
                        <span>üë§</span> ${currentUser}
                        <span style="font-size: 12px; margin-left: 5px;">‚ñº</span>
                    </button>
                    <div class="user-dropdown">
                        <div class="user-dropdown-item" onclick="openChangePasswordModal()">
                            <span>üîê</span> Change Password
                        </div>
                        <div class="user-dropdown-divider"></div>
                        <div class="user-dropdown-item" onclick="logout()">
                            <span>üö™</span> Logout
                        </div>
                    </div>
                </div>
            `;
            
            if (roleBadge) {
                roleBadge.textContent = user.role.toUpperCase();
                roleBadge.style.display = 'inline-block';
                roleBadge.style.background = 
                    user.role === 'super admin' ? '#9b59b6' : 
                    user.role === 'admin' ? '#3498db' : '#2ecc71';
            }
        }
    } else if (userInfo) {
        userInfo.textContent = 'Not logged in';
        if (roleBadge) roleBadge.style.display = 'none';
    }
}

    function updateDashboardStatus() {
        const clockEl = document.getElementById('liveClock');
        if (clockEl) {
            const now = new Date();
            clockEl.textContent = now.toLocaleTimeString('en-US', { 
                hour12: true, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
        }

        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const currentUser = getCurrentUser();
        
        if (statusDot && statusText) {
            if (isSystemLocked()) {
                if (canAccessLockedSystem()) {
                    statusDot.className = 'pulse-online';
                    statusText.innerText = "üîì SYSTEM LOCKED - You have after-hours access";
                    statusText.style.color = "var(--warning-orange)";
                } else {
                    statusDot.className = 'offline-grey';
                    statusText.innerText = "üîí SYSTEM LOCKED (07:30 - 16:50 only)";
                    statusText.style.color = "var(--danger-red)";
                }
            } else {
                statusDot.className = 'pulse-online';
                statusText.innerText = "‚úÖ SYSTEM OPERATIONAL (OPEN)";
                statusText.style.color = "var(--primary-green)";
            }
        }
    }

    function syncBG() {
        const header = document.getElementById('headerSection');
        if (!header) return;
        header.style.backgroundImage = `linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('${bgImages[bgIndex]}')`;
        bgIndex = (bgIndex + 1) % bgImages.length;
    }

    // ========== SUPPLIER HELPER FUNCTIONS ==========
    function renderStars(rating) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            stars += `<span class="star-view ${i <= rating ? 'filled' : 'star-empty-view'}">‚òÖ</span>`;
        }
        return stars;
    }

    function renderCompliancePills(supplier) {
        if (!supplier.compliance) return '<span class="compliance-pill comp-bad">NO DATA</span>';
        let pills = [];
        pills.push(supplier.compliance.tpin === 'yes' ? 
            '<span class="compliance-pill comp-ok">TPIN</span>' : 
            '<span class="compliance-pill comp-bad">TPIN</span>');
        pills.push(supplier.compliance.napsa === 'yes' ? 
            '<span class="compliance-pill comp-ok">NAPSA</span>' : 
            '<span class="compliance-pill comp-bad">NAPSA</span>');
        pills.push(supplier.compliance.zra === 'yes' ? 
            '<span class="compliance-pill comp-ok">ZRA</span>' : 
            '<span class="compliance-pill comp-bad">ZRA</span>');
        pills.push(supplier.compliance.zppa === 'yes' ? 
            '<span class="compliance-pill comp-ok">ZPPA</span>' : 
            '<span class="compliance-pill comp-bad">ZPPA</span>');
        return pills.join('');
    }

    function getDaysRemaining(supplier) {
        if (!supplier.renewalDate) return 0;
        const today = new Date();
        const renewal = new Date(supplier.renewalDate);
        return Math.ceil((renewal - today) / (1000 * 60 * 60 * 24));
    }

    function calculateRenewalPercentage(supplier) {
        if (!supplier.renewalDate) return 0;
        const days = getDaysRemaining(supplier);
        if (days < 0) return 0;
        return Math.min(100, (days / 365) * 100);
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' });
    }

    // ========== DOCUMENT VIEWER WITH FIXED IMAGE DISPLAY ==========
    function viewDocuments(supplierId) {
        const supplier = suppliers.find(s => s.id === supplierId);
        if (!supplier || !supplier.documents || supplier.documents.length === 0) {
            alert('No documents available for this supplier');
            return;
        }

        const viewerBody = document.getElementById('documentViewerBody');
        viewerBody.innerHTML = '';

        supplier.documents.forEach((doc, index) => {
            const isImage = doc.type && (doc.type.startsWith('image/') || doc.name?.match(/\.(jpg|jpeg|png|gif|webp)$/i));
            const docType = doc.type ? doc.type.toUpperCase() : 'PDF';
            
            const docElement = document.createElement('div');
            docElement.style.cssText = 'background: #f8f9fa; border-radius: 12px; padding: 15px; text-align: center;';
            
            if (isImage) {
                docElement.innerHTML = `
                    <img src="${doc.data}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; cursor: pointer;" onclick="window.open('${doc.data}', '_blank')">
                    <div style="font-weight: bold; margin-bottom: 5px; word-break: break-word;">${doc.name}</div>
                    <div style="font-size: 11px; color: #666;">${doc.type || 'Image'} ‚Ä¢ ${(doc.size / 1024).toFixed(1)} KB</div>
                    <div style="margin-top: 10px;">
                        <button class="btn-edit" style="padding: 5px 10px; font-size: 11px;" onclick="window.open('${doc.data}', '_blank')">View Full Image</button>
                    </div>
                `;
            } else {
                // For PDFs and other documents
                docElement.innerHTML = `
                    <div style="background: #e74c3c; width: 100%; height: 150px; display: flex; align-items: center; justify-content: center; border-radius: 8px; margin-bottom: 10px;">
                        <span style="font-size: 48px; color: white;">üìÑ</span>
                    </div>
                    <div style="font-weight: bold; margin-bottom: 5px; word-break: break-word;">${doc.name}</div>
                    <div style="font-size: 11px; color: #666;">${docType} ‚Ä¢ ${(doc.size / 1024).toFixed(1)} KB</div>
                    <div style="margin-top: 10px;">
                        <button class="btn-edit" style="padding: 5px 10px; font-size: 11px;" onclick="window.open('${doc.data}', '_blank')">View</button>
                    </div>
                `;
            }
            
            viewerBody.appendChild(docElement);
        });

        document.getElementById('documentViewerTitle').innerHTML = `üìÅ Documents: ${supplier.name}`;
        document.getElementById('documentViewerModal').style.display = 'flex';
    }

    function closeDocumentViewer() { 
        document.getElementById('documentViewerModal').style.display = 'none'; 
    }

    // ========== SEARCH FUNCTION ==========
    let searchTimeout;
    function filterEverything() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const term = document.getElementById('globalSearch').value.toLowerCase();
            if (term.length < 2) { 
                document.getElementById('searchResultSection').style.display = 'none';
                document.getElementById('defaultHomeContent').style.display = 'block';
                return;
            }
            
            const results = suppliers.filter(s => s.name && s.name.toLowerCase().includes(term));
            const tbody = document.getElementById('globalSearchResultsBody');
            
            tbody.innerHTML = results.map(s => {
                const daysRemaining = getDaysRemaining(s);
                return `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.category || ''}</td>
                    <td>${s.specialization || ''}</td>
                    <td><a href="https://wa.me/${s.phone?.replace(/\D/g, '')}" target="_blank">${s.phone || ''}</a></td>
                    <td>${renderStars(s.rating || 0)} ${s.rating || 0}/5</td>
                    <td><span style="background: ${daysRemaining < 0 ? '#e74c3c' : daysRemaining < 30 ? '#f39c12' : '#2ecc71'}; color: white; padding: 3px 8px; border-radius: 12px;">${daysRemaining} days</span></td>
                    <td><div class="action-buttons">${canEditSupplier() ? `<button class="btn-edit" onclick="editSupplier('${s.id}')">Edit</button>` : '‚Äî'}</div></td>
                </tr>
            `}).join('');
            
            document.getElementById('defaultHomeContent').style.display = 'none';
            document.getElementById('searchResultSection').style.display = 'block';
        }, 300);
    }

    // ========== NOTIFICATION ==========
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        notification.style.background = type === 'success' ? '#173979' : type === 'info' ? '#3498db' : '#ff4d4d';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 4000);
    }

    // ========== MISC ==========
    function forgotPasswordSimple() { 
        alert('Please contact the super admin at zulujosephp@gmail.com'); 
    }

    // ========== REALTIME APPROVAL LISTENER ==========
    let unsubscribeApprovals = null;

    function startRealtimeApprovalListener() {
        if (unsubscribeApprovals) {
            unsubscribeApprovals();
            unsubscribeApprovals = null;
        }
        
        const user = getCurrentUser();
        if (!user) return;
        
        const currentUser = getUser(user);
        if (!currentUser || !canApproveRequests()) {
            return;
        }
        
        let query;
        if (currentUser.role === 'super admin') {
            query = db.collection(COLLECTIONS.APPROVALS)
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc');
        } else {
            // Admin sees requests from staff and admin
            query = db.collection(COLLECTIONS.APPROVALS)
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc');
            // We'll filter client-side for admin
        }
        
        unsubscribeApprovals = query.onSnapshot((snapshot) => {
            console.log(`üì° Realtime update: ${snapshot.docs.length} pending approvals`);
            
            approvalRequests = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            updateApprovalsButton();
            updateRequestCounts();
            
            const modal = document.getElementById('approvalRequestsModal');
            if (modal && modal.style.display === 'flex') {
                openApprovalRequestsModal();
            }
            
            const reqModal = document.getElementById('requestsManagementModal');
            if (reqModal) {
                openRequestsManagement();
            }
            
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const req = change.doc.data();
                    if (req.requestedBy !== getCurrentUser()) {
                        showNotification(`üì® New approval request from ${req.requestedBy}`, 'info');
                    }
                }
            });
            
        }, (error) => {
            console.error("Realtime listener error:", error);
        });
    }


    // Update the initializeApp function (replace the existing one)
    // ========== INITIALIZATION WITH LOADING SPINNER ==========
    async function initializeApp() {
        console.log("Initializing Zed Supplier Directory with loading spinner...");
        
        if (!enforceSingleTab()) {
            return;
        }
        
        // Keep spinner visible, hide login overlay initially
        document.getElementById('loadingSpinner').style.display = 'flex';
        document.getElementById('loginOverlay').style.display = 'none';
        const userDocModal = document.getElementById('userDocumentViewerModal');
        if (userDocModal) {
            userDocModal.style.display = 'none';
        }
        
        try {
            await ensureDefaultUsers();
            await getAllUsers(true);
            
            startRealtimeApprovalListener();
            
            ['complianceTpin', 'complianceNapsa', 'complianceZra', 'complianceZppa'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', updateComplianceUI);
                }
            });
            
            // Login fields are EMPTY
            const userIn = document.getElementById('userIn');
            const passIn = document.getElementById('passIn');
            if (userIn) userIn.value = '';
            if (passIn) passIn.value = '';
            
            const savedUser = localStorage.getItem('logged_user');
            
            if (savedUser) {
                const user = getUser(savedUser);
                if (user && user.enabled) {
                    // Check system lock for staff users
                    if (isSystemLocked() && user.role === 'staff') {
                        localStorage.removeItem('logged_user');
                        hideLoadingSpinner();
                        showLockScreen();
                        return;
                    }
                    
                    localStorage.setItem('last_login', new Date().toDateString());
                    
                    await loadAllData(false);
                    await initializeFirestoreCollections();
                    await loadApprovalRequests();
                    
                    if (user.id) {
                        await db.collection(COLLECTIONS.USERS).doc(user.id).update({
                            lastActive: new Date().toISOString()
                        });
                    }
                    
                    // Hide spinner and show home
                    hideLoadingSpinner();
                    document.getElementById('loginOverlay').style.display = 'none';
                    
                    updateGreeting();
                    updateUserDisplay();
                    applyRoleBasedUI();
                    showView('home');
                    
                    startSessionHeartbeat();
                    
                    if (isSystemLocked() && canAccessLockedSystem()) {
                        document.getElementById('timeWarning').style.display = 'block';
                        setTimeout(() => {
                            document.getElementById('timeWarning').style.display = 'none';
                        }, 5000);
                    }
                } else {
                    // Invalid saved user - show login
                    localStorage.removeItem('logged_user');
                    localStorage.removeItem('last_login');
                    hideLoadingSpinner();
                    document.getElementById('loginOverlay').style.display = 'flex';
                }
            } else {
                // No saved user - show login
                hideLoadingSpinner();
                document.getElementById('loginOverlay').style.display = 'flex';
            }
        } catch (error) {
            console.error("Initialization error:", error);
            // On error, show login
            hideLoadingSpinner();
            document.getElementById('loginOverlay').style.display = 'flex';
        }

        setInterval(syncBG, 5000);
        setInterval(updateDashboardStatus, 1000);
        syncBG();
        updateDashboardStatus();

        const passInField = document.getElementById('passIn');
        if (passInField) {
            passInField.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
        }
        
        console.log("‚úÖ Initialization complete");

        // ========== ENHANCED DOCUMENT VIEWER AND PASSWORD CHANGE FEATURES ==========
    
    // Override the existing initializeApp function to include our new features
    const originalInitializeApp = initializeApp;
    window.initializeApp = async function() {
        await originalInitializeApp();
        
        // Add escape key handler for modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeFullscreenDocument();
                closeChangePasswordModal();
            }
        });

        // Click outside to close modals
        window.onclick = function(event) {
            const fullscreenModal = document.getElementById('fullscreenDocumentView');
            const passwordModal = document.getElementById('changePasswordModal');
            
            if (event.target === fullscreenModal) {
                closeFullscreenDocument();
            }
            if (event.target === passwordModal) {
                closeChangePasswordModal();
            }
        };
    };

    // Replace the manageUsersModal function
    window.manageUsersModal = async function() {
        const currentUser = getCurrentUser();
        const curUser = getUser(currentUser);
        
        if (!curUser) {
            alert("Please log in first");
            return;
        }

        await getAllUsers(true);
        renderUserManagementTable();
        document.getElementById('userManagementModal').style.display = 'flex';
    };

    // Add change password option to user menu
    window.openChangePasswordModal = openChangePasswordModal;
    window.closeChangePasswordModal = closeChangePasswordModal;

    // Close document viewer when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('documentViewerModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
        const fullscreenModal = document.getElementById('fullscreenDocumentView');
        if (event.target === fullscreenModal) {
            closeFullscreenDocument();
        }
        const passwordModal = document.getElementById('changePasswordModal');
        if (event.target === passwordModal) {
            closeChangePasswordModal();
        }
    };

    console.log("‚úÖ Enhanced document viewer and password change features loaded");
    }

    window.onload = initializeApp;
    window.viewRequestDocument = viewRequestDocument;
window.approveAccountRequest = approveAccountRequest;
window.openRejectAccountReasonModal = openRejectAccountReasonModal;
window.submitAccountRejection = submitAccountRejection;
window.closeRejectAccountModal = closeRejectAccountModal;
</script>

<!-- FOOTER -->
<footer style="text-align:center; padding: 40px; background: #333; color: white; margin-top: 40px;">
    <img src="./images/logo1.png" width="130" height="50" alt="ZAMCOM" onerror="this.style.display='none';">
    <p>Designed by Joseph Zulu <br> Zed Supplier Directory <br>Procurement Departments<br> ¬© 2026 - Present</p>
    <a href="#headerSection" style="color: var(--primary-green); text-decoration: none;">Back to Top</a>
</footer>

</body>
</html>
