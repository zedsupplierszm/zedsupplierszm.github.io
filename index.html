<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZAMCOM Supplier Directory</title>
    <style>
        :root {
            --primary-green: #4CAF50;
            --danger-red: #ff4d4d;
            --link-blue: #007bff;
            --nav-yellow: #ffe400;
            --grid-gap: 15px;
            --border-radius: 12px;
            --transition-speed: 0.3s;
            --warning-orange: #ff9800;
            --star-color: #FFD700;
            --star-empty: #ddd;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 0;
        }

        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a1a, #333);
            z-index: 20000; display: none; justify-content: center; align-items: center;
        }

        .login-card {
            background: white; padding: 40px; border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 350px; text-align: center;
        }

        .login-card img { margin-bottom: 20px; }
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .login-card h2 { margin-top: 0; color: #333; }
        
        .pass-wrapper { position: relative; }
        .toggle-pass { 
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
            cursor: pointer; font-size: 18px; color: #777; 
        }

        .topmenu {
            width: 100%; padding: 20px 0; color: white; text-align: center;
            background-size: cover; background-position: center;
            transition: background-image 1.5s ease-in-out;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }

        .top-nav {
            list-style: none; padding: 0; background: #333; margin: 0;
            display: flex; justify-content: center; flex-wrap: wrap;
        }

        .top-nav li a {
            display: block; padding: 15px 25px; text-decoration: none;
            font-weight: bold; color: white; transition: 0.3s; cursor: pointer;
        }

        .top-nav li a:hover { color: var(--nav-yellow); }

        .admin-controls {
            background: #fff; padding: 15px; text-align: center;
            border-bottom: 1px solid #ddd; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;
        }

        .grid-section { padding: 40px 20px; max-width: 1200px; margin: 0 auto; }
        .grid-container {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: var(--grid-gap); width: 100%;
        }

        .grid-item {
            background: #3CB8F4; border-radius: var(--border-radius); overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform var(--transition-speed) ease;
            text-decoration: none; color: #333; display: flex; flex-direction: column; cursor: pointer;
        }

        .grid-item img { width: 100%; height: 140px; object-fit: cover; }
        .grid-item span { padding: 15px; text-align: center; font-weight: 600; font-size: 0.9rem; background: white; }
        .grid-item:hover { transform: translateY(-5px); box-shadow: 0 15px 25px rgba(0,0,0,0.20); }

        #categoryPageView, #aboutView, #contactView, #linksView { 
            display: none; 
            padding: 40px 20px; 
            max-width: 1300px; 
            margin: 0 auto; 
        }
        
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; font-size: 14px; }
        .data-table th, .data-table td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        .data-table th { background: var(--primary-green); color: white; }
        .data-table a { color: var(--link-blue); text-decoration: none; font-weight: bold; }

        .compliance-pill { 
            display: inline-block; padding: 4px 8px; border-radius: 50px; 
            font-size: 10px; font-weight: bold; color: white; margin: 2px;
            text-transform: uppercase;
        }
        .comp-ok { background: #2ecc71; }
        .comp-bad { background: #e74c3c; }
        .comp-expired { background: #f39c12; }

        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-add { background: var(--primary-green); }
        .btn-back { background: #607d8b; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-bottom: 20px; font-weight: bold;}
        .btn-edit { background: #f39c12; padding: 5px 10px; font-size: 12px; border-radius: 4px; color: white; border: none; }
        .btn-del { background: var(--danger-red); padding: 5px 10px; font-size: 12px; border-radius: 4px; color: white; border: none; }

        .modal {
            display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center;
        }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 450px; max-height: 80vh; overflow-y: auto; }

        .audit-container { max-height: 400px; overflow-y: auto; text-align: left; border: 1px solid #eee; padding: 10px; border-radius: 5px; }
        .log-entry { padding: 8px; border-bottom: 1px solid #f9f9f9; display: flex; justify-content: space-between; font-size: 12px; }
        .log-user { font-weight: bold; color: var(--primary-green); }
        .log-action { color: #444; margin-left: 5px; }
        .log-time { color: #999; font-style: italic; }

        .modified-by-container {
            position: relative;
            display: inline-block;
        }
        
        .modified-by-display {
            cursor: pointer;
            padding: 5px 10px;
            background: #f0f0f0;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
        }
        
        .modified-by-display:hover {
            background: #e0e0e0;
        }
        
        .dropdown-arrow {
            font-size: 10px;
            color: #666;
        }
        
        .history-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 250px;
            max-width: 300px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 100;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-dropdown.show {
            display: block;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #f5f5f5;
            font-size: 12px;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-user {
            font-weight: bold;
            color: var(--primary-green);
        }
        
        .history-date {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }
        
        .history-action {
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }

        .role-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .role-admin {
            background: #e74c3c;
            color: white;
        }
        
        .role-staff {
            background: #3498db;
            color: white;
        }
        
        .user-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-online {
            background: #2ecc71;
        }
        
        .status-offline {
            background: #95a5a6;
        }

        .certificate-upload {
            margin: 10px 0;
            padding: 10px;
            border: 1px dashed #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        
        .certificate-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .certificate-item {
            width: 100px;
            text-align: center;
            font-size: 10px;
        }
        
        .certificate-thumbnail {
            width: 100px;
            height: 80px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        .certificate-name {
            word-break: break-word;
            margin-top: 5px;
        }
        
        .remove-certificate {
            background: var(--danger-red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            position: absolute;
            margin-left: -10px;
            margin-top: -10px;
        }

        .vertical-life-bar-container {
            width: 20px;
            height: 60px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 1px solid #ddd;
            margin: 0 auto;
        }
        
        .vertical-life-bar-fill {
            width: 100%;
            background: linear-gradient(to top, #2ecc71, #4CAF50);
            transition: height 0.5s ease;
            border-radius: 10px;
            position: absolute;
            bottom: 0;
        }
        
        .vertical-life-bar-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: #333;
            writing-mode: vertical-lr;
            text-orientation: mixed;
        }
        
        .vertical-life-bar-expiring {
            background: linear-gradient(to top, #ff9800, #ff5722);
        }
        
        .vertical-life-bar-expired {
            background: linear-gradient(to top, #f44336, #e74c3c);
        }

        .sessions-panel {
            position: fixed;
            top: 100px;
            right: 20px;
            width: 250px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        
        .sessions-header {
            background: var(--primary-green);
            color: white;
            padding: 10px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sessions-body {
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .session-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .session-user {
            display: flex;
            align-items: center;
        }
        
        .session-time {
            font-size: 10px;
            color: #888;
        }

        .pulse-online {
            background: #2ecc71;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }

        .about-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin: 0 auto;
            max-width: 1000px;
        }
        
        .mission-vision-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin: 30px 0;
        }
        
        .mv-box {
            padding: 20px;
            border-left: 5px solid var(--primary-green);
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .staff-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-top: 30px;
        }
        
        .staff-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #eee;
        }
        
        .staff-card img {
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-green);
        }

        .controls-container {
            width: 95%;
            margin: 0 auto;
            display: flex;
            gap: 10px;
            padding: 10px 0;
        }

        .document-thumbnail {
            display: inline-block;
            position: relative;
            margin: 2px;
        }

        .document-icon {
            width: 24px;
            height: 24px;
            background: var(--primary-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .document-icon:hover {
            background: #45a049;
            transform: scale(1.1);
        }

        .document-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 20000;
            justify-content: center;
            align-items: center;
        }

        .document-viewer-content {
            width: 90%;
            height: 90%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .document-viewer-header {
            padding: 15px;
            background: var(--primary-green);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .document-viewer-body {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: auto;
        }

        .document-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .pdf-viewer {
            width: 100%;
            height: 100%;
            border: none;
        }

        .document-thumbnail-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .document-thumbnail-item {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
        }

        .document-thumbnail-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .document-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-red);
            color: white;
            font-size: 10px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            gap: 10px;
        }
        
        .page-btn {
            padding: 5px 12px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .page-btn:hover {
            background: #e0e0e0;
        }
        
        .page-btn.active {
            background: var(--primary-green);
            color: white;
            border-color: var(--primary-green);
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .compact-table th, .compact-table td {
            padding: 8px 10px !important;
            font-size: 13px !important;
        }
        
        .compact-table .compliance-box {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .supplier-images-preview {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .image-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid #ddd;
            transition: all 0.3s ease;
        }
        
        .image-thumbnail:hover {
            border-color: var(--primary-green);
            transform: scale(1.05);
        }
        
        .image-gallery-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 20001;
            justify-content: center;
            align-items: center;
        }
        
        .image-gallery-content {
            position: relative;
            width: 90%;
            height: 90%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .gallery-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: opacity 0.3s ease;
        }
        
        .gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .gallery-nav:hover {
            background: rgba(0, 0, 0, 0.8);
        }
        
        .gallery-prev {
            left: 20px;
        }
        
        .gallery-next {
            right: 20px;
        }
        
        .gallery-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            z-index: 10;
        }
        
        .gallery-close:hover {
            background: rgba(0, 0, 0, 0.8);
        }
        
        .image-counter {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .star-rating {
            display: inline-flex;
            gap: 2px;
        }
        
        .star {
            font-size: 16px;
            cursor: pointer;
            color: var(--star-empty);
            transition: color 0.2s;
        }
        
        .star.filled {
            color: var(--star-color);
        }
        
        .star-rating-view {
            display: inline-flex;
            gap: 2px;
            font-size: 12px;
        }
        
        .star-view {
            color: var(--star-color);
        }
        
        .star-empty-view {
            color: var(--star-empty);
        }
        
        .rating-value {
            margin-left: 5px;
            font-weight: bold;
            color: #333;
        }

        .user-contact-fields {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            background: #f9f9f9;
        }
        
        .user-contact-fields input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #4CAF50;
            color: white;
            border-radius: 5px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
            display: none;
        }
        
        .notification.error { background: #f44336; }
        .notification.warning { background: #ff9800; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 900px) { 
            .grid-container { grid-template-columns: repeat(2, 1fr); } 
            .top-nav { flex-direction: column; }
            .admin-controls { flex-direction: column; }
            .sessions-panel { position: static; width: 100%; margin: 10px 0; }
            .mission-vision-grid { grid-template-columns: 1fr; }
            .staff-section { grid-template-columns: 1fr; }
            .compact-table th, .compact-table td {
                padding: 6px 8px !important;
                font-size: 12px !important;
            }
        }
    </style>
</head>
<body>

<div id="timeWarning" style="display: none; position: fixed; top: 0; left: 0; width: 100%; background: #ff4d4d; color: white; text-align: center; padding: 15px; z-index: 30000; font-weight: bold; border-bottom: 2px solid #fff;">
    ‚ö†Ô∏è SYSTEM ALERT: Scheduled lockout at 16:50. Please save your work!
</div>

<div id="loginOverlay">
    <div class="login-card">
        <img src="./images/mainlogo.png" width="100">
        
        <div id="lockStatusContent" style="display: none;">
            <h2 style="color: #ff4d4d;">System Locked</h2>
            <p style="color: #666; font-size: 14px;">Access resumes in:</p>
            <div id="countdownClock" style="font-size: 2.5rem; font-weight: bold; color: #333; margin: 20px 0; font-family: 'Courier New', Courier, monospace; letter-spacing: 2px;">
                00:00:00
            </div>
            <p style="font-size: 12px; color: #888;">Operating Hours: 07:30 - 16:50 CAT</p>
            <p id="lockMessage" style="font-size: 12px; color: #666; margin-top: 10px;"></p>
        </div>

        <div id="loginFieldsContent">
            <h2>System Login</h2>
            <input type="text" id="userIn" placeholder="Username">
            <div class="pass-wrapper">
                <input type="password" id="passIn" placeholder="Password">
                <span class="toggle-pass" onclick="togglePassword()">üëÅÔ∏è</span>
            </div>
            <button class="btn btn-add" style="width: 100%; margin-top: 10px;" onclick="handleLogin()">Login</button>
            <p style="font-size: 12px; margin-top: 15px; color: #666; cursor: pointer;" onclick="forgotPasswordSimple()">Forgot Password?</p>
        </div>
    </div>
</div>

<div id="imageGalleryModal" class="image-gallery-modal">
    <div class="image-gallery-content">
        <button class="gallery-close" onclick="closeImageGallery()">‚úï</button>
        <button class="gallery-nav gallery-prev" onclick="prevImage()">‚Äπ</button>
        <img id="galleryCurrentImage" class="gallery-image" src="" alt="">
        <button class="gallery-nav gallery-next" onclick="nextImage()">‚Ä∫</button>
        <div class="image-counter" id="imageCounter">1 / 1</div>
    </div>
</div>

<div class="topmenu" id="headerSection">
    <img src="./images/mainlogo.png" width="120">
    <h1>ZAMCOM SUPPLIER DIRECTORY</h1>
    <h2>PROCUREMENT</h2>
    <marquee style="background: rgba(0,0,0,0.3); padding: 2px 0; margin-top: 2px;">Right Quality - Right Quantity - Right Time - Right Price - Right Place</marquee>
    <h4 id="greeting" style="margin-top:20px;"> <i> Welcome </i> </h4>
</div>

<ul class="top-nav">
    <li><a onclick="showView('home')">HOME</a></li>
    <li><a onclick="showView('links')">LINKS</a></li>
    <li><a onclick="showView('contact')">CONTACT US</a></li>
    <li><a onclick="showView('about')">ABOUT US</a></li>
    <li><a onclick="logout()" style="background: #888;">LOGOUT</a></li>
    <button class="btn" style="background:#455A64; margin: 10px;" onclick="showAuditLogs()">üìú View Logs</button>
    <button id="userMgmtBtn" class="btn" style="background:#e67e22; margin: 10px; display:none;" onclick="manageUsersModal()">üë• User Management</button>
    <button id="sessionsBtn" class="btn" style="background:#9b59b6; margin: 10px; display:none;" onclick="toggleSessionsPanel()">üëÅÔ∏è Active Sessions</button>
    <button id="syncSettingsBtn" class="btn" style="background:#2196F3; margin: 10px;" onclick="showSyncSettings()">‚òÅÔ∏è Sync Settings</button>
</ul>

<div id="backupStatus" style="text-align: center; font-size: 12px; color: #666; margin: 10px 0;">
    Last Backup: <span id="lastBackupDate">Never</span>
</div>

<div id="systemStatusHeader" style="background: #fff; padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; px-20px;">
    <div style="display: flex; align-items: center; gap: 10px; margin-left: 20px;">
        <span id="statusDot" style="height: 12px; width: 12px; border-radius: 50%; display: inline-block;"></span>
        <span id="statusText" style="font-weight: bold; font-size: 14px;">Checking Status...</span>
    </div>
    <div style="display: flex; align-items: center; gap: 15px;">
        <div id="currentUserInfo" style="font-size: 12px; color: #555;">
            <span id="currentUserDisplay">Not logged in</span>
            <span id="userRoleBadge" style="display: none;"></span>
        </div>
        <div id="liveClock" style="font-family: monospace; font-weight: bold; color: #555;"></div>
    </div>
</div>

<div id="documentViewerModal" class="document-viewer-modal">
    <div class="document-viewer-content">
        <div class="document-viewer-header">
            <span id="documentViewerTitle">Supplier Documents</span>
            <button onclick="closeDocumentViewer()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">‚úï</button>
        </div>
        <div class="document-viewer-body" id="documentViewerBody">
        </div>
    </div>
</div>

<div id="homeView" class="grid-section">
    <div class="admin-controls">
        <button class="btn btn-add" onclick="openModal('category')">+ New Category</button>
        <button class="btn btn-add" style="background:#3498db" onclick="openModal('supplier')">+ New Supplier</button>
        
        <input type="text" id="globalSearch" placeholder="üîç Search Supplier Name..." 
               style="padding: 10px; border-radius: 5px; border: 1px solid #ddd; width: 250px;" 
               onkeyup="filterEverything()">

        <button class="btn" style="background:#607d8b" onclick="exportData()">üíæ Export Backup</button>
        <button class="btn" style="background:#9c27b0" onclick="document.getElementById('importFile').click()">üì• Import & Merge</button>
        <input type="file" id="importFile" style="display:none" multiple onchange="importData(event)">
    </div>

    <div id="defaultHomeContent">
        <h2 style="text-align:center; color: #333;">Supplier Categories</h2>
        <div class="grid-container" id="categoryGrid"></div>
    </div>

    <div id="searchResultSection" style="display:none;">
        <h2 style="text-align:center; color: var(--primary-green);">Search Results</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Supplier Name</th>
                    <th>Category</th>
                    <th>Specialization</th>
                    <th>Phone</th>
                    <th>Rating</th>
                    <th>Renewal Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="globalSearchResultsBody"></tbody>
        </table>
    </div>
</div>

<div id="categoryPageView">
    <h2 id="categoryTitle" style="color: #333;">Category Name</h2>
    <div id="complianceBanner"
     style="display:none; margin:15px 0; padding:12px;
            background:#ff4d4d; color:white; border-radius:8px;
            font-weight:bold; text-align:center;">
    ‚ö†Ô∏è WARNING: This category contains NON-COMPLIANT or EXPIRED suppliers.
</div>
    <button class="btn-back" onclick="showView('home')">‚Üê Back to Home</button>
    <div style="overflow-x: auto;">
        <table class="data-table compact-table">
            <thead>
                <tr>
                    <th>Supplier Name</th>
                    <th>Specialization</th>
                    <th>Phone</th>
                    <th>T-PIN</th>
                    <th>Email</th>
                    <th>Address</th>
                    <th>Rating</th>
                    <th>Compliance</th>
                    <th style="width: 40px;">Renewal</th>
                    <th style="width: 40px;">Docs</th>
                    <th style="width: 40px;">Images</th>
                    <th style="width: 80px;">Modified</th>
                    <th style="width: 80px;">Actions</th>
                </tr>
            </thead>
            <tbody id="supplierTableBody"></tbody>
        </table>
    </div>
</div>

<div id="aboutView">
    <div class="about-card">
        <h2 style="color: var(--primary-green); text-align: center;">About ZAMCOM Procurement</h2>
        <p style="color: #555; line-height: 1.6; padding-left : 30px; padding-right : 30px;" >
            The ZAMCOM Procurement Department is dedicated to the systematic acquisition of goods and services 
            that support the Zambia Institute of Mass Communication's mission. We ensure every kwacha spent 
            brings maximum value to our institution. 
        </p> 

        <div class="mission-vision-grid">
            <div class="mv-box">
                <h3 style="color: #2c3e50; padding-left : 30px; padding-right : 30px;">Our Mission </h3>
                <p style=" color: #555; line-height: 1.6; padding-left : 30px; padding-right : 30px;" >To deliver timely, transparent, and ethical procurement solutions through strategic sourcing and robust supplier relationship management.</p>
            </div>

            <div class="mv-box" style="border-left-color: var(--link-blue);">
                <h3 style="color: #2c3e50; padding-left : 30px; padding-right : 30px;">Our Vision</h3>
                <p style="color: #555; line-height: 1.6; padding-left : 30px; padding-right : 30px;">To lead ZAMCOM into a new era of digital procurement excellence, fostering growth for local and international suppliers.</p>
            </div>
        </div>

        <h2 style="text-align: center; color: #2c3e50;">Our Leadership</h2>
        <div class="staff-section">
            <div class="staff-card">
                <center>
                <img src="./images/mainlogo3.png" alt="Chishala Lusaka" width="130" height="130" >
                <h3>Chishala Lusaka</h3>
                <p>Procurement Officer <br> Expertise: Contract Management & Compliance</p>
                </center>
            </div>
           
            <div class="staff-card">
                <center>
                <img src="./images/josephprofile.jpg" alt="Joseph Zulu" width="130" height="130">
                <h3>Joseph Zulu</h3>
                <p>Procurement Officer <br> Expertise: Supplier Relations & Compliance</p>
                </center>
            </div>
        </div>
    </div>
</div>

<div id="contactView" style="padding: 40px 20px; max-width: 1000px; margin: 0 auto;">
    <div class="about-card">
        <h2 style="color: var(--primary-green); text-align: center;">Contact Information</h2>
        <p style="color: #555; line-height: 1.6; padding-left : 30px; padding-right : 30px;" >
            Welcome to the ZAMCOM Supplier Directory. This system was developed by Joseph Zulu, with a purpose to create a single directory where we can find all our most trusted vendors and suppliers. For more information, you can contact the developer on the contact details below:<br><br>
            - Office Location: Plot No. 3529, Government Road, Ridgeway, Lusaka, Zambia.<br>
            - General Inquiries: zulujosephp@gmail.com<br>
            - Phone: +260973031254<br>
        </p> 
    </div>
</div>

<div id="linksView" style="padding: 20px;">
    <h2>Links Management</h2>
    <div class="controls-container">
        <button class="btn btn-add" onclick="openLinkModal()">+ Add New Link</button>
    </div>
    
    <table class="data-table" id="linksTable">
        <thead>
            <tr>
                <th>Institution</th>
                <th>Website</th>
                <th>Email Address</th>
                <th style="width: 80px;">Action</th>
            </tr>
        </thead>
        <tbody id="linksBody"></tbody>
    </table>
</div>

<div id="sessionsPanel" class="sessions-panel">
    <div class="sessions-header">
        <span>üë• Active Sessions</span>
        <button onclick="toggleSessionsPanel()" style="background: none; border: none; color: white; cursor: pointer;">‚úï</button>
    </div>
    <div class="sessions-body" id="activeSessionsList">
        <div style="padding: 10px; text-align: center; color: #888;">Loading...</div>
    </div>
</div>

<div id="modalOverlay" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Add New</h3>
        <div id="modalFields"></div>
        <button class="btn btn-add" id="modalSaveBtn" style="width:100%">Save Changes</button>
        <button onclick="closeModal()" class="btn" style="background:#777; width:100%; margin-top:5px;">Close</button>
    </div>
</div>

<div id="linkModal" class="modal">
    <div class="modal-content">
        <h3>Add New Institution</h3>
        <input type="text" id="instName" placeholder="Institution Name">
        <input type="text" id="instWeb" placeholder="Website (e.g., www.site.com)">
        <input type="email" id="instEmail" placeholder="Email Address">
        <button class="btn btn-add" style="width:100%" onclick="addLink()">Save Link</button>
        <button class="btn" style="background:#ccc; width:100%; margin-top:5px;" onclick="closeLinkModal()">Close</button>
    </div>
</div>

<!-- Add Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCJrqk15bvd1746VkkDAcOM_U9w0PH7dP0",
        authDomain: "supplierdirectory-6e5c7.firebaseapp.com",
        projectId: "supplierdirectory-6e5c7",
        storageBucket: "supplierdirectory-6e5c7.firebasestorage.app",
        messagingSenderId: "434327330685",
        appId: "1:434327330685:web:6ac7e874dc5952a89c3614"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    const LOCK_TIME = { hr: 16, min: 50 };
    const OPEN_TIME = { hr: 7, min: 30 };
    const WARNING_TIME = { hr: 16, min: 30 };
    const MAX_LOGIN_ATTEMPTS = 3;
    const LOCK_DURATION_MINUTES = 10;
    const MAX_IMAGE_SIZE = 3 * 1024 * 1024;
    
    const USER_ROLES = {
        ADMIN: 'admin',
        STAFF: 'staff'
    };

    // Firebase collections
    const COLLECTIONS = {
        USERS: 'users',
        CATEGORIES: 'categories',
        SUPPLIERS: 'suppliers',
        LINKS: 'links',
        AUDIT_LOGS: 'audit_logs',
        SESSIONS: 'sessions'
    };

    // Global data variables
    let categories = [];
    let suppliers = [];
    let links = [];
    let userAccounts = [];
    let currentCategory = "";
    let currentGalleryImages = [];
    let currentGalleryIndex = 0;
    let currentRatingValue = 0;

    // ==================== FIREBASE FUNCTIONS ====================

    async function loadAllData() {
        try {
            // Load categories
            const categoriesSnapshot = await db.collection(COLLECTIONS.CATEGORIES).get();
            categories = categoriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Load suppliers
            const suppliersSnapshot = await db.collection(COLLECTIONS.SUPPLIERS).get();
            suppliers = suppliersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Load links
            const linksSnapshot = await db.collection(COLLECTIONS.LINKS).get();
            links = linksSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Load users
            const usersSnapshot = await db.collection(COLLECTIONS.USERS).get();
            userAccounts = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // If no users exist, create default users
            if (userAccounts.length === 0) {
                await createDefaultUsers();
            }
            
            return true;
        } catch (error) {
            console.error("Error loading data:", error);
            showNotification("Failed to load data from database", "error");
            return false;
        }
    }

    async function createDefaultUsers() {
        const defaultUsers = [
            { 
                username: "JOSEPH", 
                password: "RIGHTJOSEPH", 
                role: "super admin",
                enabled: true, 
                nrc: "123456/78/1", 
                email: "zulujosephp@gmail.com",
                createdAt: new Date().toISOString()
            },
            { 
                username: "CHISHALA", 
                password: "RIGHTCHISHALA", 
                role: "staff", 
                enabled: true,
                createdAt: new Date().toISOString()
            }
        ];
        
        for (const user of defaultUsers) {
            await db.collection(COLLECTIONS.USERS).add(user);
        }
        
        // Reload users
        const usersSnapshot = await db.collection(COLLECTIONS.USERS).get();
        userAccounts = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    async function saveCategory(name) {
        try {
            await db.collection(COLLECTIONS.CATEGORIES).add({
                name: name,
                createdAt: new Date().toISOString(),
                createdBy: getCurrentUser()
            });
            await loadAllData();
            return true;
        } catch (error) {
            console.error("Error saving category:", error);
            return false;
        }
    }

    async function updateCategory(id, newName) {
        try {
            await db.collection(COLLECTIONS.CATEGORIES).doc(id).update({
                name: newName,
                updatedAt: new Date().toISOString(),
                updatedBy: getCurrentUser()
            });
            await loadAllData();
            return true;
        } catch (error) {
            console.error("Error updating category:", error);
            return false;
        }
    }

    async function deleteCategory(id) {
        try {
            await db.collection(COLLECTIONS.CATEGORIES).doc(id).delete();
            await loadAllData();
            return true;
        } catch (error) {
            console.error("Error deleting category:", error);
            return false;
        }
    }

    async function saveSupplier(supplierData) {
        try {
            const supplierWithMeta = {
                ...supplierData,
                createdAt: new Date().toISOString(),
                createdBy: getCurrentUser(),
                updatedAt: new Date().toISOString(),
                updatedBy: getCurrentUser()
            };
            
            await db.collection(COLLECTIONS.SUPPLIERS).add(supplierWithMeta);
            await loadAllData();
            return true;
        } catch (error) {
            console.error("Error saving supplier:", error);
            return false;
        }
    }

    async function updateSupplier(id, supplierData) {
        try {
            await db.collection(COLLECTIONS.SUPPLIERS).doc(id).update({
                ...supplierData,
                updatedAt: new Date().toISOString(),
                updatedBy: getCurrentUser()
            });
            await loadAllData();
            return true;
        } catch (error) {
            console.error("Error updating supplier:", error);
            return false;
        }
    }

    async function deleteSupplier(id) {
        try {
            await db.collection(COLLECTIONS.SUPPLIERS).doc(id).delete();
            await loadAllData();
            return true;
        } catch (error) {
            console.error("Error deleting supplier:", error);
            return false;
        }
    }

    async function saveLink(linkData) {
        try {
            await db.collection(COLLECTIONS.LINKS).add({
                ...linkData,
                createdAt: new Date().toISOString(),
                createdBy: getCurrentUser()
            });
            await loadAllData();
            return true;
        } catch (error) {
            console.error("Error saving link:", error);
            return false;
        }
    }

    async function deleteLink(id) {
        try {
            await db.collection(COLLECTIONS.LINKS).doc(id).delete();
            await loadAllData();
            return true;
        } catch (error) {
            console.error("Error deleting link:", error);
            return false;
        }
    }

    async function recordAction(action) {
        try {
            await db.collection(COLLECTIONS.AUDIT_LOGS).add({
                user: getCurrentUser(),
                action: action,
                timestamp: new Date().toISOString(),
                time: new Date().toLocaleString('en-GB', { 
                    day:'2-digit', 
                    month:'short', 
                    hour:'2-digit', 
                    minute:'2-digit', 
                    second:'2-digit' 
                })
            });
        } catch (error) {
            console.error("Error recording action:", error);
        }
    }

    async function getAuditLogs(page = 1, limit = 20) {
        try {
            const snapshot = await db.collection(COLLECTIONS.AUDIT_LOGS)
                .orderBy('timestamp', 'desc')
                .limit(limit * page)
                .get();
            
            const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            return logs.slice((page - 1) * limit, page * limit);
        } catch (error) {
            console.error("Error getting audit logs:", error);
            return [];
        }
    }

    async function updateActiveSession(username) {
        try {
            await db.collection(COLLECTIONS.SESSIONS).doc(username).set({
                username: username,
                lastActive: new Date().toISOString(),
                sessionId: generateSessionId()
            }, { merge: true });
        } catch (error) {
            console.error("Error updating session:", error);
        }
    }

    async function removeActiveSession(username) {
        try {
            await db.collection(COLLECTIONS.SESSIONS).doc(username).delete();
        } catch (error) {
            console.error("Error removing session:", error);
        }
    }

    async function getActiveSessions() {
        try {
            const snapshot = await db.collection(COLLECTIONS.SESSIONS).get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) {
            console.error("Error getting sessions:", error);
            return [];
        }
    }

    async function uploadFileToStorage(file, path) {
        try {
            const storageRef = storage.ref();
            const fileRef = storageRef.child(path);
            await fileRef.put(file);
            const downloadURL = await fileRef.getDownloadURL();
            return downloadURL;
        } catch (error) {
            console.error("Error uploading file:", error);
            throw error;
        }
    }

    async function deleteFileFromStorage(path) {
        try {
            const storageRef = storage.ref();
            const fileRef = storageRef.child(path);
            await fileRef.delete();
            return true;
        } catch (error) {
            console.error("Error deleting file:", error);
            return false;
        }
    }

    // ==================== HELPER FUNCTIONS ====================

    function getCurrentUser() {
        return localStorage.getItem('logged_user') || 'System';
    }

    function getUser(username) {
        return userAccounts.find(u => u.username === username.toUpperCase());
    }

    function hasPermission(username, permission) {
        const user = getUser(username);
        if (!user || !user.enabled) return false;
        
        if (user.role === 'super admin' || user.role === USER_ROLES.ADMIN) return true;
        
        if (user.role === USER_ROLES.STAFF) {
            const staffPermissions = [
                'add_category',
                'edit_category',
                'add_supplier',
                'edit_supplier',
                'view_suppliers',
                'view_categories',
                'export_data',
                'import_data',
                'view_logs',
                'add_link',
                'edit_link'
            ];
            return staffPermissions.includes(permission);
        }
        
        return false;
    }

    function isCurrentUserAdmin() {
        const currentUser = getCurrentUser();
        const user = getUser(currentUser);
        return user && (user.role === 'super admin' || user.role === USER_ROLES.ADMIN);
    }

    function generateSessionId() {
        return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function showNotification(message, type = 'success') {
        let notification = document.getElementById('notification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'notification';
            notification.className = 'notification';
            document.body.appendChild(notification);
        }
        
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        
        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.display = 'none';
            }
        }, 5000);
    }

    // ==================== SYSTEM FUNCTIONS ====================

    function isSystemLocked() {
        const currentUser = getCurrentUser();
        if(currentUser === "JOSEPH") return false;
        
        const now = new Date();
        const currentTotal = (now.getHours() * 60) + now.getMinutes();
        const lockTotal = (LOCK_TIME.hr * 60) + LOCK_TIME.min;
        const openTotal = (OPEN_TIME.hr * 60) + OPEN_TIME.min;

        return (currentTotal >= lockTotal || currentTotal < openTotal);
    }

    function togglePassword() {
        const pField = document.getElementById('passIn');
        pField.type = pField.type === "password" ? "text" : "password";
    }

    async function handleLogin() {
        if (isSystemLocked()) {
            const currentUser = document.getElementById('userIn').value.toUpperCase().trim();
            if (currentUser !== "JOSEPH") {
                alert("Access Denied: The system is currently locked. Operating hours: 07:30 to 16:50 CAT.");
                return;
            }
        }

        const u = document.getElementById('userIn').value.toUpperCase().trim();
        const p = document.getElementById('passIn').value.trim();

        if (!u) {
            alert("Username required.");
            return;
        }

        const user = getUser(u);
        if (!user) {
            alert("Invalid username or password!");
            return;
        }
        
        if (!user.enabled) {
            alert("This account has been disabled. Please contact the administrator.");
            return;
        }

        if (user.password === p) {
            localStorage.setItem('logged_user', u);
            localStorage.setItem('last_login', new Date().toDateString());
            document.getElementById('loginOverlay').style.display = 'none';

            await updateActiveSession(u);
            updateGreeting();
            updateUserDisplay();
            await recordAction("Logged into the system");
            
            if (isCurrentUserAdmin()) {
                document.getElementById('userMgmtBtn').style.display = 'inline-block';
                document.getElementById('sessionsBtn').style.display = 'inline-block';
                document.getElementById('syncSettingsBtn').style.display = 'inline-block';
            } else {
                document.getElementById('userMgmtBtn').style.display = 'none';
                document.getElementById('sessionsBtn').style.display = 'none';
                document.getElementById('syncSettingsBtn').style.display = 'inline-block';
            }
            
            showView('home');
            
        } else {
            alert("Invalid Username or Password!");
        }
    }

    async function logout() {
        const currentUser = getCurrentUser();
        if (currentUser) {
            await removeActiveSession(currentUser);
            await recordAction("Logged out");
        }
        localStorage.removeItem('logged_user');
        localStorage.removeItem('last_login');
        location.reload();
    }

    // ==================== UI FUNCTIONS ====================

    function updateGreeting() {
        const hour = new Date().getHours();
        const user = getCurrentUser() || 'User';
        const msg = hour < 12 ? "Good Morning" : hour < 18 ? "Good Afternoon" : "Good Evening";
        document.getElementById('greeting').innerHTML = `<i>${msg}, ${user}</i>`;
    }

    function updateUserDisplay() {
        const currentUser = getCurrentUser();
        const userInfo = document.getElementById('currentUserDisplay');
        const roleBadge = document.getElementById('userRoleBadge');
        
        if (currentUser) {
            const user = getUser(currentUser);
            userInfo.textContent = currentUser;
            
            if (user) {
                roleBadge.textContent = user.role.toUpperCase();
                roleBadge.className = user.role === USER_ROLES.ADMIN ? 'role-badge role-admin' : 'role-badge role-staff';
                roleBadge.style.display = 'inline-block';
            }
        } else {
            userInfo.textContent = 'Not logged in';
            roleBadge.style.display = 'none';
        }
    }

    async function showView(viewName, catName = "") {
        document.getElementById('globalSearch').value = "";
        document.getElementById('searchResultSection').style.display = 'none';
        document.getElementById('defaultHomeContent').style.display = 'block';

        document.getElementById('homeView').style.display = 'none';
        document.getElementById('categoryPageView').style.display = 'none';
        document.getElementById('aboutView').style.display = 'none';
        document.getElementById('contactView').style.display = 'none';
        document.getElementById('linksView').style.display = 'none';

        if(viewName === 'home') {
            document.getElementById('homeView').style.display = 'block';
            await renderCategories();
        } else if(viewName === 'about') {
            document.getElementById('aboutView').style.display = 'block';
        } else if(viewName === 'contact') {
            document.getElementById('contactView').style.display = 'block';
        } else if(viewName === 'links') {
            document.getElementById('linksView').style.display = 'block';
            await displayLinks();
        } else if(viewName === 'detail') {
            currentCategory = catName;
            document.getElementById('categoryPageView').style.display = 'block';
            document.getElementById('categoryTitle').innerText = catName;
            await renderSuppliers();
        }
    }

    async function renderCategories() {
        const grid = document.getElementById('categoryGrid');
        const categoriesWithCount = await Promise.all(categories.map(async (cat) => {
            const countSnapshot = await db.collection(COLLECTIONS.SUPPLIERS)
                .where('category', '==', cat.name)
                .get();
            return { ...cat, count: countSnapshot.size };
        }));
        
        grid.innerHTML = categoriesWithCount.map(cat => {
            const currentUser = getCurrentUser();
            
            return `
                <div class="grid-item" onclick="showView('detail', '${cat.name}')">
                    <img src="./images/mainlogo3.png" alt="${cat.name}">
                    <span>${cat.name} (${cat.count})</span>
                    <div style="background:white; padding-bottom:10px; text-align:center; display:flex; justify-content:center; gap:5px;">
                        ${hasPermission(currentUser, 'edit_category') ? 
                            `<button class="btn-edit" onclick="event.stopPropagation(); editCategory('${cat.id}', '${cat.name}')">Edit</button>` : ''}
                        ${hasPermission(currentUser, 'delete_category') && isCurrentUserAdmin() ? 
                            `<button class="btn-del" onclick="event.stopPropagation(); deleteCategoryConfirm('${cat.id}', '${cat.name}')">Delete</button>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    async function deleteCategoryConfirm(id, name) {
        if (!isCurrentUserAdmin()) {
            alert("Only administrators can delete categories!");
            return;
        }
        
        if(confirm(`Delete category "${name}"? This will not delete suppliers in this category.`)) {
            await deleteCategory(id);
            await renderCategories();
        }
    }

    async function renderSuppliers() {
        const tbody = document.getElementById('supplierTableBody');
        
        const filtered = suppliers.filter(s => s.category === currentCategory);
        
        const currentUser = getCurrentUser();

        const banner = document.getElementById('complianceBanner');
        const currentYear = new Date().getFullYear();

        const hasNonCompliant = filtered.some(s => {
            if (!s.compliance) return true;
            if (s.compliance.year !== currentYear) return true;

            return !(
                s.compliance.incorporation &&
                s.compliance.napsa &&
                s.compliance.tax
            );
        });

        banner.style.display = hasNonCompliant ? 'block' : 'none';

        tbody.innerHTML = filtered.map((s) => {
            const cleanPhone = s.phone.replace(/\D/g, '');
            const currentYear = new Date().getFullYear();
            const comp = s.compliance || {};
            const expired = comp.year !== currentYear;
            const rating = s.rating || 0;

            function badge(label, ok) {
                if (expired) return `<span class="compliance-pill comp-expired">${label}</span>`;
                return ok
                    ? `<span class="compliance-pill comp-ok">${label}</span>`
                    : `<span class="compliance-pill comp-bad">${label}</span>`;
            }

            const renewalBar = createVerticalRenewalBarHTML(s);
            const ratingDisplay = createRatingDisplayHTML(rating);
            
            const deleteButton = isCurrentUserAdmin() ? 
                `<button class="btn-del" onclick="deleteSupplierConfirm('${s.id}')">Delete</button>` : 
                '';

            return `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.person}</td>
                    <td><a href="https://wa.me/${cleanPhone}" target="_blank">${s.phone}</a></td>
                    <td>${s.tpin || 'N/A'}</td>
                    <td><a href="mailto:${s.email}">${s.email}</a></td>
                    <td>${s.website || 'N/A'}</td>
                    <td>${ratingDisplay}</td>
                    <td><div class="compliance-box">
                        ${badge("COI", comp.incorporation)}
                        ${badge("NAPSA", comp.napsa)}
                        ${badge("TAX", comp.tax)}
                    </div></td>
                    <td style="text-align: center;">${renewalBar}</td>
                    <td style="text-align: center;">
                        <div class="document-thumbnail" onclick="openSupplierDocuments('${s.id}')">
                            <div class="document-icon">üìÑ</div>
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <div class="document-thumbnail" onclick="openSupplierImages('${s.id}')">
                            <div class="document-icon">üñºÔ∏è</div>
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <div style="font-size:9px; color:#666;">
                            <b>${s.updatedBy || s.createdBy || 'System'}</b><br>
                            ${s.updatedAt ? new Date(s.updatedAt).toLocaleDateString() : 
                              s.createdAt ? new Date(s.createdAt).toLocaleDateString() : '---'}
                        </div>
                    </td>
                    <td style="text-align: center;">
                        ${hasPermission(currentUser, 'edit_supplier') ? 
                            `<button class="btn-edit" onclick="editSupplier('${s.id}')">Edit</button>` : ''}
                        ${deleteButton}
                    </td>
                </tr>
            `;
        }).join('');
    }

    function createVerticalRenewalBarHTML(supplier) {
        const currentYear = new Date().getFullYear();
        const compYear = supplier.compliance?.year || currentYear;
        
        let barClass = 'vertical-life-bar-fill';
        let progress = 100;
        let displayText = '100%';
        
        if (compYear === currentYear) {
            const currentMonth = new Date().getMonth();
            const monthsLeft = 12 - currentMonth;
            progress = (monthsLeft / 12) * 100;
            displayText = `${Math.round(progress)}%`;
        } else {
            barClass += ' vertical-life-bar-expired';
            displayText = 'EXP';
        }
        
        if (progress < 25) {
            barClass += ' vertical-life-bar-expired';
        } else if (progress < 50) {
            barClass += ' vertical-life-bar-expiring';
        }
        
        const barHeight = `${progress}%`;
        
        return `
            <div class="vertical-life-bar-container" title="Renews Dec ${compYear} - ${displayText}">
                <div class="${barClass}" style="height: ${barHeight}"></div>
                <div class="vertical-life-bar-text">${displayText}</div>
            </div>
        `;
    }

    function createRatingDisplayHTML(rating) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
        
        let starsHTML = '<div class="star-rating-view">';
        
        for (let i = 0; i < fullStars; i++) {
            starsHTML += '<span class="star-view">‚òÖ</span>';
        }
        
        if (hasHalfStar) {
            starsHTML += '<span class="star-view" style="position: relative;">';
            starsHTML += '<span style="position: absolute; width: 50%; overflow: hidden;">‚òÖ</span>';
            starsHTML += '<span style="color: var(--star-empty);">‚òÖ</span>';
            starsHTML += '</span>';
        }
        
        for (let i = 0; i < emptyStars; i++) {
            starsHTML += '<span class="star-empty-view">‚òÖ</span>';
        }
        
        starsHTML += `<span class="rating-value">${rating.toFixed(1)}</span>`;
        starsHTML += '</div>';
        
        return starsHTML;
    }

    async function deleteSupplierConfirm(id) {
        if (!isCurrentUserAdmin()) {
            alert("Only administrators can delete suppliers!");
            return;
        }
        
        if(confirm("Are you sure you want to delete this supplier?")) {
            await deleteSupplier(id);
            await renderSuppliers();
        }
    }

    async function openModal(type, editId = null) {
        const currentUser = getCurrentUser();
        
        if (type === 'category' && !hasPermission(currentUser, 'add_category')) {
            alert("You don't have permission to add categories!");
            return;
        }
        
        if (type === 'supplier' && !hasPermission(currentUser, editId !== null ? 'edit_supplier' : 'add_supplier')) {
            alert("You don't have permission to manage suppliers!");
            return;
        }
        
        const modal = document.getElementById('modalOverlay');
        const fields = document.getElementById('modalFields');
        const title = document.getElementById('modalTitle');
        const saveBtn = document.getElementById('modalSaveBtn');
        saveBtn.style.display = 'block';
        modal.style.display = 'flex';

        if(type === 'category') {
            title.innerText = editId ? "Edit Category" : "New Category";
            const category = editId ? categories.find(c => c.id === editId) : null;
            fields.innerHTML = `<input type="text" id="field1" placeholder="Category Name" style="width:100%; padding:10px; margin-bottom:10px;" value="${category ? category.name : ''}">`;

            saveBtn.onclick = async () => {
                const name = document.getElementById('field1').value;
                if(name) {
                    if (editId) {
                        await updateCategory(editId, name);
                        await recordAction(`Updated category: ${name}`);
                    } else {
                        await saveCategory(name);
                        await recordAction(`Created new category: ${name}`);
                    }
                    await renderCategories();
                    closeModal();
                }
            };
        } else {
            const s = editId ? suppliers.find(sup => sup.id === editId) : {
                name:'', 
                person:'', 
                phone:'', 
                tpin:'', 
                email:'', 
                website:'', 
                category:currentCategory, 
                rating: 0,
                compliance: {
                    incorporation: false,
                    napsa: false,
                    tax: false,
                    year: new Date().getFullYear()
                }
            };
            
            title.innerText = editId ? "Edit Supplier" : "Add New Supplier";
            
            fields.innerHTML = `
                <input type="text" id="s_name" value="${s.name}" placeholder="Company Name" style="width:100%; padding:8px; margin-bottom:5px;">
                <input type="text" id="s_person" value="${s.person}" placeholder="Specialization" style="width:100%; padding:8px; margin-bottom:5px;">
                <input type="text" id="s_phone" value="${s.phone}" placeholder="Phone" style="width:100%; padding:8px; margin-bottom:5px;">
                <input type="text" id="s_tpin" value="${s.tpin || ''}" placeholder="T-PIN" style="width:100%; padding:8px; margin-bottom:5px;">
                <input type="email" id="s_email" value="${s.email}" placeholder="Email" style="width:100%; padding:8px; margin-bottom:5px;">
                <input type="text" id="s_website" value="${s.website || ''}" placeholder="Physical Address" style="width:100%; padding:8px; margin-bottom:5px;">
                
                <div style="margin:10px 0;">
                    <label style="display: block; margin-bottom: 5px;"><b>Supplier Rating (1-5 stars)</b></label>
                    ${createRatingInputHTML(s.rating || 0)}
                </div>
                
                <div style="margin:10px 0; padding:10px; border:1px solid #eee; border-radius:8px;">
                    <b>Legal Compliance (Valid until 31 Dec)</b><br><br>

                    <label>
                        <input type="checkbox" id="c_incorp" ${s.compliance?.incorporation ? 'checked' : ''}>
                        Certificate of Incorporation
                    </label><br>

                    <label>
                        <input type="checkbox" id="c_napsa" ${s.compliance?.napsa ? 'checked' : ''}>
                        NAPSA Certificate
                    </label><br>

                    <label>
                        <input type="checkbox" id="c_tax" ${s.compliance?.tax ? 'checked' : ''}>
                        Tax Clearance Certificate
                    </label>
                </div>

                <select id="s_cat" style="width:100%; padding:8px; margin-bottom:5px;">
                    ${categories.map(c => `<option ${c.name===s.category?'selected':''}>${c.name}</option>`).join('')}
                </select>
            `;

            currentRatingValue = s.rating || 0;

            saveBtn.onclick = async () => {
                const currentYear = new Date().getFullYear();

                const newSup = {
                    name: document.getElementById('s_name').value,
                    person: document.getElementById('s_person').value,
                    phone: document.getElementById('s_phone').value,
                    tpin: document.getElementById('s_tpin').value,
                    email: document.getElementById('s_email').value,
                    website: document.getElementById('s_website').value,
                    category: document.getElementById('s_cat').value,
                    rating: currentRatingValue,
                    compliance: {
                        incorporation: document.getElementById('c_incorp').checked,
                        napsa: document.getElementById('c_napsa').checked,
                        tax: document.getElementById('c_tax').checked,
                        year: currentYear
                    }
                };
                
                if(!newSup.name) return alert("Company name required");
                
                if(editId) {
                    await updateSupplier(editId, newSup);
                    await recordAction(`Updated supplier details: ${newSup.name}`);
                } else {
                    await saveSupplier(newSup);
                    await recordAction(`Added new supplier: ${newSup.name}`);
                }
                
                await renderSuppliers();
                closeModal();
            };
        }
    }

    function closeModal() { 
        document.getElementById('modalOverlay').style.display = 'none'; 
    }

    // ==================== OTHER FUNCTIONS ====================

    function updateDashboardStatus() {
        const now = new Date();
        const isLocked = isSystemLocked();
        const dot = document.getElementById('statusDot');
        const txt = document.getElementById('statusText');
        const clock = document.getElementById('liveClock');

        clock.innerText = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

        if (isLocked) {
            dot.className = 'status-offline';
            txt.innerText = "SYSTEM SECURED (LOCKED)";
            txt.style.color = "var(--danger-red)";
        } else {
            dot.className = 'pulse-online';
            txt.innerText = "SYSTEM OPERATIONAL (OPEN)";
            txt.style.color = "var(--primary-green)";
        }
    }

    async function displayLinks() {
        const tbody = document.getElementById('linksBody');
        tbody.innerHTML = '';

        links.forEach((link) => {
            const deleteButton = isCurrentUserAdmin() ? 
                `<button class="btn btn-del" onclick="deleteLinkConfirm('${link.id}')">Delete</button>` : 
                '';
            
            const row = `<tr>
                <td>${link.name}</td>
                <td><a href="${link.url.startsWith('http') ? link.url : 'http://' + link.url}" target="_blank"><b>${link.url}</b></a></td>
                <td><a href="mailto:${link.email}">${link.email}</a></td>
                <td>${deleteButton}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    async function deleteLinkConfirm(id) {
        if (!isCurrentUserAdmin()) {
            alert("Only administrators can delete links!");
            return;
        }
        
        if(confirm("Are you sure you want to delete this link?")) {
            await deleteLink(id);
            await displayLinks();
        }
    }

    async function openLinkModal() {
        if (!hasPermission(getCurrentUser(), 'add_link')) {
            alert("You don't have permission to add links!");
            return;
        }
        document.getElementById('linkModal').style.display = 'flex';
    }

    function closeLinkModal() {
        document.getElementById('linkModal').style.display = 'none';
        document.getElementById('instName').value = '';
        document.getElementById('instWeb').value = '';
        document.getElementById('instEmail').value = '';
    }

    async function addLink() {
        if (!hasPermission(getCurrentUser(), 'add_link')) {
            alert("You don't have permission to add links!");
            return;
        }
        
        const name = document.getElementById('instName').value;
        const url = document.getElementById('instWeb').value;
        const email = document.getElementById('instEmail').value;

        if(name && url && email) {
            await saveLink({ name, url, email });
            await displayLinks();
            closeLinkModal();
        } else {
            alert("Please fill in all fields");
        }
    }

    async function showAuditLogs(page = 1) {
        if (!hasPermission(getCurrentUser(), 'view_logs')) {
            alert("You don't have permission to view audit logs!");
            return;
        }
        
        const modal = document.getElementById('modalOverlay');
        const fields = document.getElementById('modalFields');
        const title = document.getElementById('modalTitle');
        const saveBtn = document.getElementById('modalSaveBtn');
        
        title.innerText = "System Audit Logs";
        modal.style.display = 'flex';
        saveBtn.style.display = 'none';

        const logs = await getAuditLogs(page, 20);
        
        let paginationHTML = '';
        if (logs.length === 20) {
            paginationHTML = `
                <div class="pagination">
                    <button class="page-btn" onclick="showAuditLogs(${page - 1})" ${page <= 1 ? 'disabled' : ''}>‚Äπ Prev</button>
                    <span style="font-size: 12px;">Page ${page}</span>
                    <button class="page-btn" onclick="showAuditLogs(${page + 1})">Next ‚Ä∫</button>
                </div>
            `;
        }
        
        fields.innerHTML = `
            <div style="margin-bottom: 10px; font-size: 12px; color: #666;">
                Showing latest ${logs.length} logs
            </div>
            <div class="audit-container">
                ${logs.length === 0 ? '<p style="text-align:center">No logs recorded yet.</p>' : 
                  logs.map(l => `
                    <div class="log-entry">
                        <span><span class="log-user">${l.user}</span>: <span class="log-action">${l.action}</span></span>
                        <span class="log-time">${l.time}</span>
                    </div>
                  `).join('')}
            </div>
            ${paginationHTML}
            <button onclick="closeModal();" class="btn" style="background:#777; width:100%; margin-top:15px;">Close Logs</button>
        `;
    }

    async function toggleSessionsPanel() {
        const panel = document.getElementById('sessionsPanel');
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
        } else {
            await updateSessionsPanel();
            panel.style.display = 'block';
        }
    }

    async function updateSessionsPanel() {
        const sessions = await getActiveSessions();
        const container = document.getElementById('activeSessionsList');
        
        if (sessions.length === 0) {
            container.innerHTML = '<div style="padding: 10px; text-align: center; color: #888;">No active sessions</div>';
            return;
        }
        
        let html = '';
        sessions.forEach(session => {
            const sessionAge = new Date() - new Date(session.lastActive);
            const minutesAgo = Math.floor(sessionAge / (1000 * 60));
            const timeText = minutesAgo === 0 ? 'Just now' : `${minutesAgo} min ago`;
            
            html += `
                <div class="session-item">
                    <div class="session-user">
                        <span class="user-status status-online"></span>
                        <strong>${session.username}</strong>
                    </div>
                    <div class="session-time">${timeText}</div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    // ==================== INITIALIZATION ====================

    const bgImages = ['./images/bgx.jpg', './images/bgx1.jpg', './images/bg.jpg', './images/bgx3.jpg', './images/bgx4.jpg', './images/bgx5.jpg', './images/bgx6.jpg', './images/bgx7.jpg', './images/bgx8.jpg', './images/bgx9.jpg', './images/bgy1.jpg', './images/bgy3.jpg', './images/bgy4.jpg', './images/bgy5.jpg'];
    
    function syncBG() {
        const header = document.getElementById('headerSection');
        if(!header) return;
        const index = Math.floor((Math.floor(Date.now() / 1000) % (bgImages.length * 15)) / 15);
        header.style.backgroundImage = `url(${bgImages[index]})`;
    }

    function runTimeMonitoring() {
        const now = new Date();
        const hrs = now.getHours();
        const mins = now.getMinutes();

        updateDashboardStatus();
        const warningBanner = document.getElementById('timeWarning');
        if (hrs === 16 && mins >= 30 && mins < 50) {
            warningBanner.style.display = 'block';
        } else {
            warningBanner.style.display = 'none';
        }

        if (isSystemLocked() && getCurrentUser() && !isCurrentUserAdmin()) {
            alert("SYSTEM LOCK: Access hours ended. The system will now close until 07:30 CAT.");
            logout();
        }
    }

    window.onload = async () => {
        // Load all data from Firebase
        await loadAllData();
        
        // Check if user is logged in
        const currentUser = getCurrentUser();
        const lastLogin = localStorage.getItem('last_login');
        const today = new Date().toDateString();
        
        if (currentUser && lastLogin === today) {
            updateGreeting();
            updateUserDisplay();
            
            if(isCurrentUserAdmin()) {
                document.getElementById('userMgmtBtn').style.display = 'inline-block';
                document.getElementById('sessionsBtn').style.display = 'inline-block';
                document.getElementById('syncSettingsBtn').style.display = 'inline-block';
            } else {
                document.getElementById('userMgmtBtn').style.display = 'none';
                document.getElementById('sessionsBtn').style.display = 'none';
                document.getElementById('syncSettingsBtn').style.display = 'inline-block';
            }
            
            const user = getUser(currentUser);
            if (user && user.enabled) {
                document.getElementById('loginOverlay').style.display = 'none';
            } else {
                document.getElementById('loginOverlay').style.display = 'flex';
            }
        } else {
            document.getElementById('loginOverlay').style.display = 'flex';
        }
        
        // Initialize UI
        await showView('home');
        
        // Set up intervals
        setInterval(syncBG, 1000);
        setInterval(runTimeMonitoring, 30000);
        setInterval(updateDashboardStatus, 1000);
        
        syncBG();
        updateDashboardStatus();
        
        // Add event listeners
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('sessionsPanel');
            const sessionsBtn = document.getElementById('sessionsBtn');
            if (panel.style.display === 'block' && 
                !panel.contains(e.target) && 
                sessionsBtn && !sessionsBtn.contains(e.target)) {
                panel.style.display = 'none';
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeImageGallery();
                closeDocumentViewer();
            }
            
            if (document.getElementById('imageGalleryModal').style.display === 'flex') {
                if (e.key === 'ArrowRight') {
                    nextImage();
                } else if (e.key === 'ArrowLeft') {
                    prevImage();
                }
            }
        });
    };

    // ==================== RATING FUNCTIONS ====================

    function createRatingInputHTML(currentRating = 0) {
        let starsHTML = '<div class="star-rating" id="ratingStars">';
        
        for (let i = 1; i <= 5; i++) {
            const isFilled = i <= currentRating || (i - 0.5 <= currentRating && currentRating < i);
            starsHTML += `
                <span class="star ${isFilled ? 'filled' : ''}" 
                      data-value="${i}"
                      onclick="setRating(${i})"
                      onmouseover="hoverRating(${i})"
                      onmouseout="resetRating()">
                    ‚òÖ
                </span>
            `;
        }
        
        starsHTML += `<span style="margin-left: 10px; font-size: 12px;" id="ratingValueDisplay">${currentRating.toFixed(1)}</span>`;
        starsHTML += '</div>';
        
        return starsHTML;
    }

    function setRating(value) {
        currentRatingValue = value;
        updateRatingDisplay(value);
    }

    function hoverRating(value) {
        updateRatingDisplay(value, true);
    }

    function resetRating() {
        updateRatingDisplay(currentRatingValue);
    }

    function updateRatingDisplay(value, isHover = false) {
        const stars = document.querySelectorAll('#ratingStars .star');
        stars.forEach(star => {
            const starValue = parseInt(star.getAttribute('data-value'));
            if (starValue <= value) {
                star.classList.add('filled');
            } else {
                star.classList.remove('filled');
            }
        });
        
        if (!isHover) {
            document.getElementById('ratingValueDisplay').textContent = value.toFixed(1);
        }
    }

    // ==================== IMAGE GALLERY FUNCTIONS ====================

    function closeImageGallery() {
        document.getElementById('imageGalleryModal').style.display = 'none';
        currentGalleryImages = [];
        currentGalleryIndex = 0;
    }

    function nextImage() {
        if (currentGalleryImages.length === 0) return;
        currentGalleryIndex = (currentGalleryIndex + 1) % currentGalleryImages.length;
        document.getElementById('galleryCurrentImage').src = currentGalleryImages[currentGalleryIndex].data;
        document.getElementById('imageCounter').textContent = `${currentGalleryIndex + 1} / ${currentGalleryImages.length}`;
    }

    function prevImage() {
        if (currentGalleryImages.length === 0) return;
        currentGalleryIndex = (currentGalleryIndex - 1 + currentGalleryImages.length) % currentGalleryImages.length;
        document.getElementById('galleryCurrentImage').src = currentGalleryImages[currentGalleryIndex].data;
        document.getElementById('imageCounter').textContent = `${currentGalleryIndex + 1} / ${currentGalleryImages.length}`;
    }

    // ==================== DOCUMENT VIEWER FUNCTIONS ====================

    function closeDocumentViewer() {
        document.getElementById('documentViewerModal').style.display = 'none';
    }

    // ==================== PLACEHOLDER FUNCTIONS ====================

    // These functions need to be implemented based on your specific requirements
    function openSupplierDocuments(supplierId) {
        // TODO: Implement document viewer for supplier
        alert("Document viewer for supplier " + supplierId + " - To be implemented");
    }

    function openSupplierImages(supplierId) {
        // TODO: Implement image gallery for supplier
        alert("Image gallery for supplier " + supplierId + " - To be implemented");
    }

    function filterEverything() {
        // TODO: Implement search functionality
        const term = document.getElementById('globalSearch').value.toLowerCase().trim();
        if (term.length === 0) return;
        alert("Search functionality - To be implemented");
    }

    function editSupplier(supplierId) {
        openModal('supplier', supplierId);
    }

    function editCategory(categoryId, categoryName) {
        const newName = prompt("Enter new name for the category:", categoryName);
        if (newName && newName !== categoryName) {
            updateCategory(categoryId, newName);
        }
    }

    function forgotPasswordSimple() {
        const username = prompt("Enter your username:").toUpperCase();
        if (!username) return;

        const user = getUser(username);
        
        if (!user) {
            alert("User not found!");
            return;
        }
        
        if (!user.email) {
            alert("No email registered for this user. Please contact administrator.");
            return;
        }
        
        const subject = encodeURIComponent("ZAMCOM Supplier Directory - Your Password");
        const body = encodeURIComponent(
            `Hello ${user.username},\n\n` +
            `Your login credentials are:\n` +
            `Username: ${user.username}\n` +
            `Password: ${user.password}\n\n` +
            `Please login and change your password immediately for security.\n\n` +
            `ZAMCOM Procurement Department`
        );
        
        const mailtoLink = `mailto:${user.email}?subject=${subject}&body=${body}`;
        
        if (confirm(`Send password recovery email to ${user.email}?`)) {
            window.open(mailtoLink, '_blank');
            recordAction(`Password recovery email sent for ${username}`);
            alert("Email client opened. Please send the email to receive your password.");
        }
    }

    function changePassword() {
        const currentUser = getCurrentUser();
        if (!currentUser) {
            alert("You must be logged in to change password.");
            return;
        }
        
        const oldPassword = prompt("Enter your current password:");
        if (!oldPassword) return;
        
        const user = getUser(currentUser);
        
        if (!user) {
            alert("User not found!");
            return;
        }
        
        if (user.password !== oldPassword) {
            alert("Current password is incorrect!");
            return;
        }
        
        const newPassword = prompt("Enter new password:");
        if (!newPassword) return;
        
        const confirmPassword = prompt("Confirm new password:");
        if (newPassword !== confirmPassword) {
            alert("Passwords don't match!");
            return;
        }
        
        // TODO: Implement password change in Firebase
        alert("Password change functionality - To be implemented with Firebase Auth");
    }

    function manageUsersModal() {
        // TODO: Implement user management modal
        alert("User management - To be implemented");
    }

    function showSyncSettings() {
        // TODO: Implement sync settings
        alert("Sync settings - To be implemented");
    }

    function exportData() {
        // TODO: Implement data export
        alert("Export functionality - To be implemented");
    }

    function importData(event) {
        // TODO: Implement data import
        alert("Import functionality - To be implemented");
    }
</script>

<footer style="text-align:center; padding: 40px; background: #333; color: white;">
    <img src="./images/logo1.png" width="130" height="50">
    <p>Designed by Joseph Zulu <br> ZAMCOM Procurement Department ¬© 2026 - Present</p>
    <a href="#headerSection" style="color:var(--primary-green)">Back to Top</a>
</footer>

</body>
</html>
