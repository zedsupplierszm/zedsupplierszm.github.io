<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1024">
    <title>Zed Supplier Directory</title>
    <style>
        :root {
            --primary-green: #173979;
            --danger-red: #ff4d4d;
            --link-blue: #007bff;
            --nav-yellow: #ffe400;
            --grid-gap: 20px;
            --border-radius: 16px;
            --transition-speed: 0.3s;
            --warning-orange: #ff9800;
            --star-color: #FFD700;
            --star-empty: #ddd;
            --card-bg: #ffffff;
            --soft-shadow: 0 12px 24px -8px rgba(0,0,0,0.08);
            --online-green: #2ecc71;
            --offline-grey: #95a5a6;
            --compliance-green: #2ecc71;
            --compliance-red: #e74c3c;
            --compliance-yellow: #f39c12;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 0;
        }

        #loadingSpinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2f3f, #0f1a24);
            z-index: 30000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease;
        }

        .spinner-container {
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(76, 175, 80, 0.2);
            animation: fadeInScale 0.5s ease;
        }

        .spinner {
            width: 80px;
            height: 80px;
            margin: 0 auto 25px;
            border: 5px solid rgba(76, 175, 80, 0.1);
            border-top: 5px solid var(--primary-green);
            border-right: 5px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }

        .spinner-text {
            color: white;
            font-size: 20px;
            font-weight: 500;
            letter-spacing: 2px;
            margin-top: 15px;
            text-transform: uppercase;
            background: linear-gradient(90deg, #fff, #173979, #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: shimmer 2s linear infinite;
        }

        .spinner-subtext {
            color: #95a5a6;
            font-size: 14px;
            margin-top: 10px;
            font-style: italic;
        }

        .spinner-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .dot {
            width: 10px;
            height: 10px;
            background-color: var(--primary-green);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInScale {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); opacity: 0.3; }
            40% { transform: scale(1); opacity: 1; }
        }


        /* LOGIN OVERLAY */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a1a, #333);
            z-index: 20000; display: flex; justify-content: center; align-items: center;
        }

        .login-card {
            background: white; padding: 40px; border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 350px; text-align: center;
        }

        .login-card img { margin-bottom: 20px; }
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .pass-wrapper { position: relative; }
        .toggle-pass { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; }

        /* HEADER */
        .topmenu {
            width: 100%; padding: 20px 0; color: white; text-align: center;
            background-size: cover; background-position: center;
            transition: background-image 1.5s ease-in-out;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }

        .top-nav {
            list-style: none; padding: 0; background: #333; margin: 0;
            display: flex; justify-content: center; flex-wrap: wrap;
        }

        .top-nav li a {
            display: block; padding: 15px 25px; text-decoration: none;
            font-weight: bold; color: white; transition: 0.3s; cursor: pointer;
        }

        .top-nav li a:hover { color: var(--nav-yellow); }

        /* BEAUTIFUL CATEGORY GRID - mainlogo3.png */
        .grid-section { padding: 40px 20px; max-width: 1200px; margin: 0 auto; }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 25px;
            margin-top: 20px;
        }

        .grid-item {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-decoration: none;
            color: #333;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            border: 1px solid rgba(76,175,80,0.1);
            position: relative;
        }

        .grid-item:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 30px rgba(76,175,80,0.15);
            border-color: var(--primary-green);
        }

        .grid-item .category-image-wrapper {
            width: 100%;
            height: 160px;
            overflow: hidden;
            position: relative;
            background: linear-gradient(145deg, #f0f7f4, #e0ebe8);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s ease;
        }

        .grid-item:hover img { transform: scale(1.08); }

        .category-fallback {
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            font-size: 56px; font-weight: 300; color: white; text-shadow: 0 4px 10px rgba(0,0,0,0.2);
            background: radial-gradient(circle at 30% 30%, #173979, #2c6b2c);
        }

        .grid-item span {
            padding: 18px 12px; text-align: center; font-weight: 600; font-size: 1rem;
            background: white; color: #1e3b37; border-top: 1px solid #f0f0f0; letter-spacing: 0.3px;
        }

        .grid-item:hover span { color: var(--primary-green); background: #fafffc; }

        .btn-del {
            background: var(--danger-red);
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            display: inline-block;
        }
        .btn-del:hover { opacity: 0.85; }

        /* ADMIN CONTROLS ‚Äî visibility will be role toggled */
        .admin-controls {
            background: white; padding: 20px; text-align: center;
            border-radius: 50px; box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;
            margin-bottom: 30px;
        }

        #categoryPageView, #aboutView, #contactView, #linksView, #auditLogsView, #userApprovalHistoryView { 
            display: none; padding: 40px 20px; max-width: 1300px; margin: 0 auto; 
        }
        
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .data-table th, .data-table td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        .data-table th { background: var(--primary-green); color: white; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn:hover { opacity: 0.85; transform: scale(0.98); }
        .btn-add { background: var(--primary-green); }
        .btn-back { background: #607d8b; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
        .btn-edit { background: #f39c12; padding: 5px 10px; font-size: 12px; border-radius: 4px; color: white; border: none; display: inline-block; margin-right: 5px; }
        .btn-del { background: var(--danger-red); padding: 5px 10px; font-size: 12px; border-radius: 4px; color: white; border: none; display: inline-block; }
        .btn-request-delete { background: #e67e22; padding: 5px 10px; font-size: 12px; border-radius: 4px; color: white; border: none; display: inline-block; }
        .btn-approve { background: #9b59b6; padding: 5px 10px; font-size: 12px; border-radius: 4px; color: white; border: none; }
        .btn-super { background: #9b59b6; }
        .btn-warning { background: #e67e22; }
        .btn-pagination { background: #34495e; padding: 8px 15px; font-size: 13px; }

        .modal {
            display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center;
        }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 500px; max-height: 80vh; overflow-y: auto; }

        .vertical-life-bar-container {
            width: 20px; height: 60px; background: #f0f0f0; border-radius: 10px; overflow: hidden;
            position: relative; border: 1px solid #ddd; margin: 0 auto;
        }
        .vertical-life-bar-fill { width: 100%; background: linear-gradient(to top, #2ecc71, #173979); transition: height 0.5s ease; position: absolute; bottom: 0; }
        .vertical-life-bar-fill.expiring { background: linear-gradient(to top, #f39c12, #e67e22); }
        .vertical-life-bar-fill.expired { background: linear-gradient(to top, #e74c3c, #c0392b); }
        .vertical-life-bar-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: white; text-shadow: 0 0 3px rgba(0,0,0,0.5); }

        .compliance-pill { display: inline-block; padding: 4px 8px; border-radius: 50px; font-size: 10px; font-weight: bold; color: white; margin: 2px; text-transform: uppercase; }
        .comp-ok { background: #2ecc71; }
        .comp-bad { background: #e74c3c; }
        .comp-pending { background: #f39c12; }

        .star-rating-view { display: inline-flex; gap: 2px; }
        .star-view.filled { color: var(--star-color); }
        .rating-value { margin-left: 5px; font-weight: bold; }

        .image-thumbnail { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin: 2px; }

        .about-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .mission-vision-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin: 30px 0; }
        .staff-section { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-top: 30px; }

        .sessions-panel {
            position: fixed; top: 100px; right: 20px; width: 300px; background: white;
            border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.15); z-index: 1000; display: none;
        }

        .notification {
            position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #173979;
            color: white; border-radius: 5px; z-index: 10000; display: none;
        }

        .online-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .pulse-online { background: #2ecc71; box-shadow: 0 0 0 rgba(46, 204, 113, 0.4); animation: pulse-green 2s infinite; }
        .offline-grey { background: #95a5a6; }
        .beaming { animation: beam 1.5s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.6); } 70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } }
        @keyframes beam { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .user-mgmt-table { width:100%; border-collapse: collapse; font-size: 13px; }
        .role-badge { padding: 3px 8px; border-radius: 30px; color: white; font-size: 11px; margin-left: 5px; display: inline-block; }
        .role-superadmin { background: #9b59b6; } 
        .role-admin { background: #3498db; } 
        .role-staff { background: #2ecc71; }

        .hidden { display: none !important; }
        .exclusive-super { display: none; }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
        }

        .audit-log-entry {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            transition: background 0.2s;
        }

        .audit-log-entry:hover {
            background: #f5f9ff;
        }

        .audit-timestamp {
            color: #666;
            font-size: 11px;
            font-family: monospace;
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .audit-action {
            font-weight: bold;
            color: #2c3e50;
            background: #e8f5e9;
            padding: 4px 10px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
            margin-left: 10px;
        }

        .audit-user {
            background: #e3f2fd;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .audit-details {
            margin-top: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
            border-left: 3px solid var(--primary-green);
        }

        /* COMPLIANCE BAR */
        .compliance-bar-container {
            width: 100%;
            height: 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        .compliance-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        .compliance-bar-fill.good { background: linear-gradient(90deg, #2ecc71, #27ae60); }
        .compliance-bar-fill.poor { background: linear-gradient(90deg, #e74c3c, #c0392b); }

        /* APPROVAL MODAL */
        .approval-request-item {
            background: #f9f9f9;
            border-left: 4px solid var(--warning-orange);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        /* REASON INPUT MODAL */
        .reason-modal {
            display: none;
            position: fixed;
            z-index: 15000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .reason-modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 450px;
            max-width: 95%;
        }
        .reason-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin: 15px 0;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        /* DOCUMENT UPLOAD */
        .document-upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s;
            cursor: pointer;
        }
        .document-upload-area:hover {
            border-color: var(--primary-green);
            background: #f0f7f0;
        }
        .document-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .document-item {
            background: #f0f0f0;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .document-item i {
            color: var(--primary-green);
        }

        /* RATING STARS */
        .rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
            gap: 5px;
        }
        .rating input {
            display: none;
        }
        .rating label {
            cursor: pointer;
            font-size: 24px;
            color: #ddd;
            transition: color 0.2s;
        }
        .rating label:before {
            content: '‚òÖ';
        }
        .rating input:checked ~ label,
        .rating label:hover,
        .rating label:hover ~ label {
            color: var(--star-color);
        }

        .approval-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        .approval-tab {
            padding: 10px 20px;
            border-radius: 30px;
            background: #f0f0f0;
            color: #333;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .approval-tab.active {
            background: var(--primary-green);
            color: white;
        }
        .approval-tab:hover {
            background: #e0e0e0;
        }
        .approval-tab.active:hover {
            background: var(--primary-green);
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        /* Request Count Badge */
        .request-count-badge {
            background: #ff4d4d;
            color: white;
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 8px;
            display: inline-block;
            font-weight: bold;
        }

        .request-count-zero {
            background: #95a5a6;
        }

        /* Category Actions in Category Page */
        .category-actions-bar {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            justify-content: center;
        }

        .category-actions-bar button {
            padding: 12px 24px;
        }

        /* Clickable links */
        .clickable-phone {
            color: var(--link-blue);
            text-decoration: none;
            cursor: pointer;
        }
        .clickable-phone:hover {
            text-decoration: underline;
        }

        .clickable-email {
            color: var(--link-blue);
            text-decoration: none;
            cursor: pointer;
        }
        .clickable-email:hover {
            text-decoration: underline;
        }

        .clickable-tpin {
            color: var(--primary-green);
            text-decoration: none;
            cursor: pointer;
            font-weight: 600;
        }
        .clickable-tpin:hover {
            text-decoration: underline;
        }

        /* Modification History Dropdown */
        .modification-history {
            position: relative;
            display: inline-block;
        }

        .modification-dropdown {
            display: none;
            position: absolute;
            background: white;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 12px;
            padding: 15px;
            font-size: 12px;
            border: 1px solid #e0e0e0;
            right: 0;
        }

        .modification-history:hover .modification-dropdown {
            display: block;
        }

        .modification-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .modification-item:last-child {
            border-bottom: none;
        }

        .modification-field {
            font-weight: 700;
            color: #e67e22;
            text-transform: capitalize;
        }

        .modification-old {
            color: #e74c3c;
            text-decoration: line-through;
            background: #fee9e7;
            padding: 2px 5px;
            border-radius: 4px;
        }

        .modification-new {
            color: #27ae60;
            background: #e8f8f5;
            padding: 2px 5px;
            border-radius: 4px;
        }

        @media (max-width: 900px) { 
            .grid-container { grid-template-columns: repeat(2, 1fr); } 
            .top-nav { flex-direction: column; }
            .mission-vision-grid { grid-template-columns: 1fr; }
            .staff-section { grid-template-columns: 1fr; }
            .modal-content { width: 95%; }
        }
        @media (max-width: 480px) { .grid-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<!-- SINGLE TAB ENFORCEMENT -->
<div id="tabConflictWarning" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 99999; color: white; text-align: center; padding-top: 20%; font-size: 24px; font-weight: bold;">
    ‚ö†Ô∏è THIS APPLICATION CAN ONLY BE OPENED IN ONE TAB<br>
    <span style="font-size: 18px; color: #ff4d4d; margin-top: 20px; display: block;">Please close this tab and use the existing tab.</span>
    <button onclick="forceTakeover()" style="margin-top: 40px; padding: 15px 30px; background: #173979; color: white; border: none; border-radius: 5px; cursor: pointer;">FORCE TAKEOVER (Close Other Tab)</button>
</div>

<!-- LOADING SPINNER -->
<div id="loadingSpinner">
    <div class="spinner-container">
        <div class="spinner"></div>
        <div class="spinner-text">Zed Supplier Directory</div>
        <div class="spinner-subtext">Loading your experience...</div>
        <div class="spinner-dots">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
    </div>
</div>



<!-- TIME WARNING -->
<div id="timeWarning" style="display: none; position: fixed; top: 0; left: 0; width: 100%; background: #ff4d4d; color: white; text-align: center; padding: 15px; z-index: 30000; font-weight: bold;">
    ‚ö†Ô∏è SYSTEM ALERT: Scheduled lockout at 16:50. Super admin and admin bypass active.
</div>

<!-- LOGIN OVERLAY - EMPTY FIELDS -->
<div id="loginOverlay" style="display: flex;">
    <div class="login-card">
        <img src="./images/mainlogo.png" width="100" alt="logo" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\' viewBox=\'0 0 100 100\'><rect width=\'100\' height=\'100\' fill=\'%23173979\'/><text x=\'50\' y=\'55\' font-size=\'40\' text-anchor=\'middle\' fill=\'white\' font-weight=\'bold\'>Z</text></svg>'">
        <div id="loginFieldsContent">
            <h2>System Login</h2>
            <input type="text" id="userIn" placeholder="Username" value="">
            <div class="pass-wrapper">
                <input type="password" id="passIn" placeholder="Password" value="">
                <span class="toggle-pass" onclick="togglePassword()">üëÅÔ∏è</span>
            </div>
            <button class="btn btn-add" style="width: 100%; margin-top: 10px;" onclick="handleLogin()">Login</button>
            <p style="font-size: 12px; margin-top: 15px; color: #666; cursor: pointer;" onclick="forgotPasswordSimple()">Forgot Password?</p>
        </div>
    </div>
</div>

<!-- HEADER -->
<div class="topmenu" id="headerSection">
    <img src="./images/mainlogo.png" width="120" alt="zamcom" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'120\' height=\'120\' viewBox=\'0 0 100 100\'><rect width=\'100\' height=\'100\' fill=\'%23173979\'/><text x=\'50\' y=\'55\' font-size=\'40\' text-anchor=\'middle\' fill=\'white\' font-weight=\'bold\'>Z</text></svg>'">
    <h1>Zed Supplier Directory</h1>
    <h2>PROCUREMENT</h2>
    <marquee style="background: rgba(0,0,0,0.3); padding: 2px 0;">Right Quality - Right Quantity - Right Time - Right Price - Right Place</marquee>
    <h4 id="greeting" style="margin-top:20px;"><i>Welcome</i></h4>
</div>

<!-- NAVIGATION -->
<ul class="top-nav">
    <li><a onclick="showView('home')">HOME</a></li>
    <li><a onclick="showView('links')">LINKS</a></li>
    <li><a onclick="showView('contact')">CONTACT US</a></li>
    <li><a onclick="showView('about')">ABOUT US</a></li>
    <li><a onclick="showAuditLogs()">üìã AUDIT LOGS</a></li>
    <li><a onclick="openApprovalRequestsModal()" id="approvalRequestsNavBtn" style="background:#e67e22; display:none;">‚úÖ APPROVALS <span id="approvalRequestCount" class="request-count-badge">0</span></a></li>
    <li><a onclick="openUserApprovalHistory()" id="approvalHistoryNavBtn" style="background:#9b59b6; display:none;">üìú MY REQUESTS</a></li>
    <li><a onclick="logout()" style="background: #888;">LOGOUT</a></li>
    <button id="userMgmtBtn" class="btn" style="background:#e67e22; margin: 10px; display:none;" onclick="manageUsersModal()">üë• User Management</button>
    <button id="sessionsBtn" class="btn" style="background:#2196F3; margin: 10px; display:none;" onclick="toggleSessionsPanel()">üëÅÔ∏è Active Sessions</button>
    <button id="requestsManagementBtn" class="btn exclusive-super" style="background:#9b59b6; margin: 10px; display:none;" onclick="openRequestsManagement()">üìã Requests Management <span id="requestsManagementCount" class="request-count-badge">0</span></button>
</ul>

<!-- STATUS BAR -->
<div id="systemStatusHeader" style="background: #fff; padding: 10px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
    <div style="display: flex; align-items: center; gap: 10px;">
        <span id="statusDot" style="height: 12px; width: 12px; border-radius: 50%; display: inline-block;"></span>
        <span id="statusText" style="font-weight: bold; font-size: 14px;">Checking Status...</span>
    </div>

    <div id="currentUserInfo" style="font-size: 12px; color: #555; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
    <span id="currentUserDisplay">Not logged in</span>
    <span id="userRoleBadge" style="display: none; padding:2px 6px; border-radius:12px; color:white;"></span>
    <a href="javascript:void(0);" onclick="openChangePasswordModal()" id="changePasswordLink" style="color: var(--primary-green); text-decoration: none; font-size: 11px; display: none; background: #f0f7f0; padding: 3px 8px; border-radius: 12px; cursor: pointer;">üîë Change Password</a>
</div>

        <div id="liveClock" style="font-family: monospace; font-weight: bold;"></div>
    </div>
</div>

<!-- IMAGE GALLERY MODAL -->
<div id="imageGalleryModal" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index:20001; justify-content:center; align-items:center;">
    <div style="position:relative; width:90%; height:90%;">
        <button onclick="closeImageGallery()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer;">‚úï</button>
        <button onclick="prevImage()" style="position:absolute; left:20px; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:white; border:none; width:50px; height:50px; border-radius:50%; cursor:pointer;">‚Äπ</button>
        <img id="galleryCurrentImage" src="" style="width:100%; height:100%; object-fit:contain;">
        <button onclick="nextImage()" style="position:absolute; right:20px; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:white; border:none; width:50px; height:50px; border-radius:50%; cursor:pointer;">‚Ä∫</button>
        <div id="imageCounter" style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); color:white; background:rgba(0,0,0,0.5); padding:5px 15px; border-radius:20px;">1 / 1</div>
    </div>
</div>

<!-- DOCUMENT VIEWER MODAL -->
<div id="documentViewerModal" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index:20000; justify-content:center; align-items:center;">
    <div style="width:90%; height:90%; background:white; border-radius:10px; display:flex; flex-direction:column;">
        <div style="padding:15px; background:var(--primary-green); color:white; display:flex; justify-content:space-between; align-items:center;">
            <span id="documentViewerTitle">Supplier Documents</span>
            <button onclick="closeDocumentViewer()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">‚úï</button>
        </div>
        <div id="documentViewerBody" style="flex:1; padding:20px; overflow:auto; display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:20px;"></div>
    </div>
</div>

<!-- ========== REASON INPUT MODAL ========== -->
<div id="reasonModal" class="reason-modal">
    <div class="reason-modal-content">
        <h3 id="reasonModalTitle" style="color: var(--warning-orange); margin-bottom: 10px;">State Reason for Deletion</h3>
        <p style="color: #666; font-size: 13px; margin-bottom: 5px;">Please provide a reason for this deletion request:</p>
        <textarea id="deletionReason" class="reason-textarea" placeholder="Enter your reason here..."></textarea>
        <div style="display: flex; gap: 15px; justify-content: flex-end;">
            <button class="btn" style="background: var(--primary-green);" onclick="submitDeletionReason()">Submit Request</button>
            <button class="btn" style="background: #95a5a6;" onclick="closeReasonModal()">Cancel</button>
        </div>
        <input type="hidden" id="pendingDeletionType">
        <input type="hidden" id="pendingDeletionId">
        <input type="hidden" id="pendingDeletionName">
    </div>
</div>

<!-- ========== HOME VIEW ========== -->
<div id="homeView" class="grid-section" style="display: none;">
    <div class="admin-controls" id="adminControlsBar">
        <button class="btn btn-add" onclick="openCategoryModal()" id="newCategoryBtn">+ New Category</button>
        <button class="btn btn-add" style="background:#3498db" onclick="openSupplierModal()" id="newSupplierBtn">+ New Supplier</button>
        <input type="text" id="globalSearch" placeholder="üîç Search Supplier Name..." style="padding: 10px 20px; border-radius: 30px; border: 1px solid #ddd; width: 250px;" onkeyup="filterEverything()">
        <button id="exportBackupBtn" class="btn exclusive-super" style="background:#607d8b" onclick="exportData()">üíæ Export Backup</button>
        <button id="importMergeBtn" class="btn exclusive-super" style="background:#9c27b0" onclick="document.getElementById('importFile').click()">üì• Import & Merge</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>

    <div id="defaultHomeContent">
        <h2 style="text-align:center; color: #1e3b37; font-size: 2rem; margin-bottom: 10px;">Supplier Categories</h2>
        <p style="text-align:center; color: #5a7c7a; margin-bottom: 20px;">Browse our trusted partners by category</p>
        <div class="grid-container" id="categoryGrid"></div>
    </div>

    <div id="searchResultSection" style="display:none;">
        <h2 style="text-align:center; color: var(--primary-green);">Search Results</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Supplier Name</th>
                    <th>Category</th>
                    <th>Specialization</th>
                    <th>Phone</th>
                    <th>Rating</th>
                    <th>Renewal Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="globalSearchResultsBody"></tbody>
        </table>
        <button class="btn-back" onclick="document.getElementById('searchResultSection').style.display='none'; document.getElementById('defaultHomeContent').style.display='block';">‚Üê Back to Categories</button>
    </div>
</div>

<!-- ========== CATEGORY PAGE VIEW ========== -->
<div id="categoryPageView" style="display: none;">
    <h2 id="categoryTitle" style="color: #333; text-align: center;">Category Name</h2>
    
    <div class="category-actions-bar">
        <button class="btn btn-add" onclick="openCategoryModal()" id="categoryNewCategoryBtn">+ New Category</button>
        <button class="btn btn-add" style="background:#3498db" onclick="openSupplierModal()" id="categoryNewSupplierBtn">+ New Supplier</button>
        <button class="btn-edit" onclick="editCurrentCategory()" id="editCategoryBtn" style="padding: 12px 24px;">‚úèÔ∏è Edit Category</button>
    </div>

    <div id="complianceBanner" style="display:none; margin:15px 0; padding:12px; background:#ff4d4d; color:white; border-radius:8px; font-weight:bold; text-align:center;"></div>
    <button class="btn-back" onclick="showView('home')">‚Üê Back to Home</button>
    <div style="overflow-x: auto;">
        <table class="data-table compact-table">
            <thead>
                <tr>
                    <th>Supplier Name</th>
                    <th>Specialization</th>
                    <th>Phone</th>
                    <th>T-PIN</th>
                    <th>Email</th>
                    <th>Address</th>
                    <th>Rating</th>
                    <th>Compliance</th>
                    <th>Renewal</th>
                    <th>Docs</th>
                    <th>Modified By</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="supplierTableBody"></tbody>
        </table>
    </div>
</div>

<!-- ========== ABOUT VIEW ========== -->
<div id="aboutView" style="display: none;">
    <div class="about-card">
        <h2 style="color: var(--primary-green); text-align: center;">About ZAMCOM Procurement</h2>
        <p style="color: #555; line-height: 1.6; padding: 0 30px;">
            The ZAMCOM Procurement Department is dedicated to the systematic acquisition of goods and services 
            that support the Zambia Institute of Mass Communication's mission.
        </p>
        <div class="mission-vision-grid">
            <div style="padding:20px; border-left:5px solid var(--primary-green); background:#f9f9f9; border-radius:8px;">
                <h3 style="color: #2c3e50;">Our Mission</h3>
                <p style="color: #555;">To deliver timely, transparent, and ethical procurement solutions.</p>
            </div>
            <div style="padding:20px; border-left:5px solid var(--link-blue); background:#f9f9f9; border-radius:8px;">
                <h3 style="color: #2c3e50;">Our Vision</h3>
                <p style="color: #555;">To lead ZAMCOM into digital procurement excellence.</p>
            </div>
        </div>
    </div>
</div>

<!-- ========== CONTACT VIEW ========== -->
<div id="contactView" style="display: none; padding: 40px 20px; max-width: 1000px; margin: 0 auto;">
    <div class="about-card">
        <h2 style="color: var(--primary-green); text-align: center;">Contact Information</h2>
        <p style="color: #555; line-height: 1.6; padding: 0 30px;">
            Plot No. 3529, Government Road, Ridgeway, Lusaka, Zambia.<br>
            Email: zulujosephp@gmail.com<br>
            Phone: +260973031254<br>
        </p>
    </div>
</div>

<!-- ========== LINKS VIEW ========== -->
<div id="linksView" style="display: none; padding: 40px 20px; max-width: 1200px; margin: 0 auto;">
    <h2 style="color: #333;">Links Management</h2>
    <div style="margin-bottom: 20px;" id="addLinkBtnContainer">
        <button class="btn btn-add" onclick="openLinkModal()" id="addLinkBtn">+ Add New Link</button>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th>Institution</th>
                <th>Website</th>
                <th>Email</th>
                <th style="width:80px;" id="linkActionHeader">Action</th>
            </tr>
        </thead>
        <tbody id="linksBody"></tbody>
    </table>
</div>

<!-- ========== AUDIT LOGS VIEW ========== -->
<div id="auditLogsView" style="display: none; padding: 40px 20px; max-width: 1200px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #333; margin:0;">üìã System Audit Trail</h2>
        <div>
            <button id="deleteLast50LogsBtnAudit" class="btn exclusive-super" style="background:#e67e22;" onclick="deleteLast50AuditLogs()">üóëÔ∏è Delete Last 50 Logs</button>
            <button id="deleteAllLogsBtnAudit" class="btn exclusive-super" style="background:#c0392b; margin-left:10px;" onclick="deleteAllAuditLogs()">üóëÔ∏è Delete All Logs</button>
        </div>
    </div>
    <div class="about-card" style="padding:20px;">
        <div id="auditLogsContainer" style="min-height: 400px;">
            <!-- Audit logs will be loaded here -->
        </div>
        <div id="auditPagination" class="pagination-controls">
            <!-- Pagination controls will be loaded here -->
        </div>
    </div>
</div>

<!-- ========== USER APPROVAL HISTORY VIEW ========== -->
<div id="userApprovalHistoryView" style="display: none; padding: 40px 20px; max-width: 1200px; margin: 0 auto;">
    <h2 style="color: #333; margin-bottom: 20px;">üìú My Approval Requests</h2>
    <div class="about-card" style="padding: 20px;">
        <div class="approval-tabs">
            <div class="approval-tab active" onclick="switchApprovalHistoryTab('pending')" id="historyPendingTab">Pending Requests</div>
            <div class="approval-tab" onclick="switchApprovalHistoryTab('history')" id="historyHistoryTab">History (Approved/Rejected)</div>
        </div>
        <div id="userApprovalHistoryContainer" style="min-height: 400px;">
            <!-- User approval history will be loaded here -->
        </div>
    </div>
</div>

<!-- SESSIONS PANEL -->
<div id="sessionsPanel" class="sessions-panel">
    <div style="background:var(--primary-green); color:white; padding:12px; display:flex; justify-content:space-between; align-items:center;">
        <span>üë• Active Sessions & Online Status</span>
        <button onclick="toggleSessionsPanel()" style="background:none; border:none; color:white; cursor:pointer;">‚úï</button>
    </div>
    <div id="activeSessionsList" style="padding:15px; max-height:350px; overflow-y:auto; background:white;"></div>
</div>

<!-- ========== CATEGORY MODAL ========== -->
<div id="categoryModal" class="modal">
    <div class="modal-content" style="border-radius: 20px; max-width: 450px;">
        <h3 id="categoryModalTitle" style="color: var(--primary-green); margin-bottom: 20px; text-align: center;">‚ûï Add New Category</h3>
        <input type="hidden" id="editingCategoryId">
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">Category Name</label>
            <input type="text" id="categoryNameInput" placeholder="e.g., Stationery & Office Supplies" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; transition: border 0.3s;" onfocus="this.style.borderColor='var(--primary-green)'" onblur="this.style.borderColor='#e0e0e0'">
        </div>
        <div style="display: flex; gap: 15px;">
            <button class="btn btn-add" style="flex: 1; padding: 12px;" onclick="saveNewCategory()" id="categoryModalSaveBtn">Create Category</button>
            <button class="btn" style="flex: 1; background: #95a5a6; padding: 12px;" onclick="closeCategoryModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- ========== SUPPLIER MODAL ========== -->
<div id="supplierModal" class="modal" style="display: none;">
    <div class="modal-content" style="width: 700px; max-width: 95%; border-radius: 24px; padding: 30px;">
        <h3 id="supplierModalTitle" style="color: var(--primary-green); margin-bottom: 25px; text-align: center; font-size: 1.8rem;">‚ûï Add New Supplier</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Left Column -->
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Supplier Name *</label>
                <input type="text" id="supplierName" placeholder="e.g., ABC Supplies Ltd" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Specialization</label>
                <input type="text" id="supplierSpecialization" placeholder="e.g., Office Equipment" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Phone Number *</label>
                <input type="text" id="supplierPhone" placeholder="e.g., +260977123456" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">T PIN</label>
                <input type="text" id="supplierTpin" placeholder="Taxpayer PIN" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Email</label>
                <input type="email" id="supplierEmail" placeholder="contact@supplier.com" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Physical Address</label>
                <input type="text" id="supplierAddress" placeholder="Full address" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
            </div>
            
            <!-- Right Column -->
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Category *</label>
                <select id="supplierCategory" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                    <option value="">Select Category</option>
                </select>
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Rating (1-5 Stars)</label>
                <div class="rating" id="supplierRatingContainer" style="margin-bottom: 20px;">
                    <input type="radio" name="rating" id="star5" value="5"><label for="star5"></label>
                    <input type="radio" name="rating" id="star4" value="4"><label for="star4"></label>
                    <input type="radio" name="rating" id="star3" value="3"><label for="star3"></label>
                    <input type="radio" name="rating" id="star2" value="2"><label for="star2"></label>
                    <input type="radio" name="rating" id="star1" value="1" checked><label for="star1"></label>
                </div>
                
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #555;">Compliance Status</label>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="checkbox" id="complianceTpin" style="width: 18px; height: 18px; margin-right: 10px;">
                        <label for="complianceTpin" style="flex:1;">TPIN Registered</label>
                        <span id="complianceTpinStatus" style="font-size: 12px; padding: 3px 8px; border-radius: 20px; background: #e74c3c; color: white;">Not Compliant</span>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="checkbox" id="complianceNapsa" style="width: 18px; height: 18px; margin-right: 10px;">
                        <label for="complianceNapsa" style="flex:1;">NAPSA Registered</label>
                        <span id="complianceNapsaStatus" style="font-size: 12px; padding: 3px 8px; border-radius: 20px; background: #e74c3c; color: white;">Not Compliant</span>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="checkbox" id="complianceZra" style="width: 18px; height: 18px; margin-right: 10px;">
                        <label for="complianceZra" style="flex:1;">ZRA Registered</label>
                        <span id="complianceZraStatus" style="font-size: 12px; padding: 3px 8px; border-radius: 20px; background: #e74c3c; color: white;">Not Compliant</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="complianceZppa" style="width: 18px; height: 18px; margin-right: 10px;">
                        <label for="complianceZppa" style="flex:1;">ZPPA Registered</label>
                        <span id="complianceZppaStatus" style="font-size: 12px; padding: 3px 8px; border-radius: 20px; background: #e74c3c; color: white;">Not Compliant</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-size: 12px;">Overall Compliance</span>
                            <span id="overallCompliancePercent">0%</span>
                        </div>
                        <div class="compliance-bar-container">
                            <div id="overallComplianceBar" class="compliance-bar-fill poor" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Renewal Status</label>
                <div style="display: flex; gap: 10px; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 12px;">
                    <div style="flex:1;">
                        <select id="supplierRenewalMonth" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            <option value="0">January</option>
                            <option value="1">February</option>
                            <option value="2">March</option>
                            <option value="3">April</option>
                            <option value="4">May</option>
                            <option value="5">June</option>
                            <option value="6">July</option>
                            <option value="7">August</option>
                            <option value="8">September</option>
                            <option value="9">October</option>
                            <option value="10">November</option>
                            <option value="11" selected>December</option>
                        </select>
                    </div>
                    <div style="flex:1;">
                        <select id="supplierRenewalYear" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Document Upload Section -->
        <div style="margin-top: 25px; border-top: 1px solid #e0e0e0; padding-top: 20px;">
            <h4 style="color: #333; margin-bottom: 15px;">üìÑ Required Documents (Max 3MB each)</h4>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('tpinDocUpload').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">üìë</span>
                        <p style="margin: 5px 0; font-weight: 600;">TPIN</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="tpinDocUpload" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleDocumentUpload('tpin', this)">
                    <div id="tpinDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('napsaDocUpload').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">üìë</span>
                        <p style="margin: 5px 0; font-weight: 600;">NAPSA</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="napsaDocUpload" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleDocumentUpload('napsa', this)">
                    <div id="napsaDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('zraDocUpload').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">üìë</span>
                        <p style="margin: 5px 0; font-weight: 600;">ZRA</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="zraDocUpload" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleDocumentUpload('zra', this)">
                    <div id="zraDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('zppaDocUpload').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">üìë</span>
                        <p style="margin: 5px 0; font-weight: 600;">ZPPA</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="zppaDocUpload" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleDocumentUpload('zppa', this)">
                    <div id="zppaDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button id="supplierModalSaveBtn" class="btn btn-add" style="flex: 1; padding: 14px; font-size: 16px;" onclick="saveSupplier()">Save Supplier</button>
            <button class="btn" style="flex: 1; background: #95a5a6; padding: 14px; font-size: 16px;" onclick="closeSupplierModal()">Cancel</button>
        </div>
        <input type="hidden" id="editingSupplierId">
        <input type="hidden" id="supplierActionType" value="add">
    </div>
</div>

<!-- ========== APPROVAL REQUESTS MODAL ========== -->
<div id="approvalRequestsModal" class="modal" style="display: none;">
    <div class="modal-content" style="width: 700px; max-width: 95%; border-radius: 24px; padding: 30px;">
        <h3 style="color: var(--warning-orange); margin-bottom: 20px; text-align: center;">‚úÖ Pending Approval Requests <span id="pendingApprovalCount" class="request-count-badge">0</span></h3>
        <div id="pendingApprovalsList" style="max-height: 400px; overflow-y: auto;">
            <!-- Approval items will be loaded here -->
        </div>
        <div style="display: flex; gap: 15px; margin-top: 25px;">
            <button class="btn" style="flex: 1; background: #95a5a6;" onclick="closeApprovalRequestsModal()">Close</button>
        </div>
    </div>
</div>

<!-- ========== APPROVAL ACTION MODAL ========== -->
<div id="approvalActionModal" class="modal" style="display: none;">
    <div class="modal-content" style="width: 500px; border-radius: 24px; padding: 30px;">
        <h3 id="approvalActionTitle" style="color: var(--warning-orange); margin-bottom: 20px; text-align: center;">Approve Request</h3>
        <div id="approvalActionDetails" style="margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 12px;"></div>
        <div style="display: flex; gap: 15px;">
            <button class="btn" style="flex: 1; background: var(--primary-green);" onclick="confirmApproval(true)">‚úì Approve</button>
            <button class="btn" style="flex: 1; background: var(--danger-red);" onclick="confirmApproval(false)">‚úó Reject</button>
            <button class="btn" style="flex: 1; background: #95a5a6;" onclick="closeApprovalActionModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- USER DOCUMENT VIEWER MODAL -->
<div id="userDocumentViewerModal" class="modal" style="display: none; z-index: 30000;">
    <div class="modal-content" style="width: 90%; max-width: 1200px; height: 90vh; padding: 0; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column;">
        <div style="background: var(--primary-green); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <h3 id="userDocumentViewerTitle" style="margin: 0; font-size: 1.2rem;">Document Viewer</h3>
            <button onclick="closeUserDocumentViewer()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">‚úï</button>
        </div>
        <div id="userDocumentViewerContent" style="flex: 1; padding: 20px; overflow: auto; background: #f5f5f5; display: flex; flex-direction: column; align-items: center;">
            <!-- Document will be loaded here -->
        </div>
        <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; display: flex; justify-content: flex-end; gap: 10px;">
            <button id="downloadUserDocumentBtn" class="btn btn-add" style="padding: 8px 20px;" onclick="downloadCurrentUserDocument()">üì• Download</button>
            <button class="btn" style="background: #6c757d; padding: 8px 20px;" onclick="closeUserDocumentViewer()">Close</button>
        </div>
    </div>
</div>

<!-- USER MANAGEMENT MODAL -->
<div id="userManagementModal" class="modal" style="display:none;">
    <div class="modal-content" style="width:600px; border-radius: 24px;">
        <h3 style="color:var(--primary-green); margin-bottom:15px;">üë§ User Management</h3>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:15px;">
            <button class="btn btn-add" onclick="openAddUserModal()" id="addUserBtn">+ Add User</button>
            <button id="deleteAllLogsBtn" class="btn exclusive-super" style="background:#c0392b;" onclick="deleteAllAuditLogs()">üóëÔ∏è Delete All Logs</button>
            <button id="deleteLast50LogsBtn" class="btn exclusive-super" style="background:#e67e22;" onclick="deleteLast50AuditLogs()">üóëÔ∏è Delete Last 50 Logs</button>
        </div>
        <div style="max-height:400px; overflow-y:auto;">
            <table class="user-mgmt-table" style="width:100%;">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Phone</th>
                        <th>Email/NRC</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="userMgmtTableBody"></tbody>
            </table>
        </div>
        <button onclick="closeUserMgmtModal()" class="btn" style="background:#777; width:100%; margin-top:15px;">Close</button>
    </div>
</div>

<!-- EDIT USER MODAL - Updated with Full Name and Document Uploads -->
<div id="editUserModal" class="modal" style="display:none;">
    <div class="modal-content" style="border-radius: 24px; max-width: 600px;">
        <h3 id="editUserTitle">‚úèÔ∏è Edit User</h3>
        <input type="hidden" id="editUserId">
        
        <!-- Full Name (NEW) -->
        <input type="text" id="editFullName" placeholder="Full Name *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        
        <input type="text" id="editUsername" placeholder="Username" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;" readonly>
        <select id="editRole" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
            <option value="staff">Staff</option>
            <option value="admin">Admin</option>
            <option value="super admin">Super Admin</option>
        </select>
        <input type="text" id="editNrc" placeholder="NRC Number *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="email" id="editEmail" placeholder="Email Address" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="editPhone" placeholder="Phone Number" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="editInstitution" placeholder="Institution / Dept" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="editPosition" placeholder="Position" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="password" id="editPassword" placeholder="New Password (leave blank to keep current)" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        
        <!-- Document Upload Section for Edit (NEW) -->
        <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
            <h4 style="color: var(--primary-green); margin-bottom: 15px;">üìÑ Documents</h4>
            
            <div style="display: grid; gap: 15px;">
                <!-- Degree/Diploma -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Degree/Diploma Certificate</label>
                    <div class="document-upload-area" onclick="document.getElementById('editDegreeDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">üéì</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload New Degree/Diploma</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="editDegreeDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('editDegree', this)">
                    <div id="editDegreeDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                
                <!-- ZIPS Membership -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ZIPS Membership Certificate</label>
                    <div class="document-upload-area" onclick="document.getElementById('editZipsDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">üìú</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload New ZIPS Certificate</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="editZipsDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('editZips', this)">
                    <div id="editZipsDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                
                <!-- NRC -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">NRC (National Registration Card)</label>
                    <div class="document-upload-area" onclick="document.getElementById('editNrcDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">ü™™</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload New NRC</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="editNrcDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('editNrc', this)">
                    <div id="editNrcDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
            </div>
            
            <!-- Current Documents Display -->
            <div id="editCurrentDocs" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h5 style="margin: 0 0 10px 0; color: #555;">Current Documents:</h5>
                <div id="editCurrentDocsList"></div>
            </div>
        </div>
        
        <div style="display:flex; align-items:center; margin:10px 0;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input type="checkbox" id="editEnabled" style="width:16px; height:16px;">
                <span style="font-size:14px;">Account Enabled</span>
            </label>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-add" style="flex:1;" onclick="saveUserEdit()">üíæ Save Changes</button>
            <button class="btn" style="background:#777; flex:1;" onclick="closeEditUserModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- ADD USER MODAL - Updated with Full Name and Document Uploads -->
<div id="addUserModal" class="modal" style="display:none;">
    <div class="modal-content" style="border-radius: 24px; max-width: 600px;">
        <h3 id="addUserTitle">‚ûï Add New User</h3>
        
        <!-- Full Name (NEW) -->
        <input type="text" id="newFullName" placeholder="Full Name *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        
        <input type="text" id="newUsername" placeholder="Username *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <select id="newRole" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
            <option value="staff">Staff</option>
            <option value="admin">Admin</option>
            <option value="super admin">Super Admin</option>
        </select>
        <input type="text" id="newNrc" placeholder="NRC Number *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="email" id="newEmail" placeholder="Email Address" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="newPhone" placeholder="Phone Number" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="newInstitution" placeholder="Institution / Dept" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="newPosition" placeholder="Position" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="password" id="newPassword" placeholder="Password *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        
        <!-- Document Upload Section (NEW) -->
        <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
            <h4 style="color: var(--primary-green); margin-bottom: 15px;">üìÑ Required Documents (Max 3MB each)</h4>
            
            <div style="display: grid; gap: 15px;">
                <!-- Degree/Diploma -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Degree/Diploma Certificate *</label>
                    <div class="document-upload-area" onclick="document.getElementById('newDegreeDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">üéì</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload Degree/Diploma</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="newDegreeDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('degree', this)">
                    <div id="newDegreeDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                
                <!-- ZIPS Membership -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ZIPS Membership Certificate *</label>
                    <div class="document-upload-area" onclick="document.getElementById('newZipsDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">üìú</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload ZIPS Certificate</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="newZipsDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('zips', this)">
                    <div id="newZipsDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                
                <!-- NRC -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">NRC (National Registration Card) *</label>
                    <div class="document-upload-area" onclick="document.getElementById('newNrcDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">ü™™</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload NRC</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="newNrcDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('nrc', this)">
                    <div id="newNrcDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
            </div>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-add" style="flex:1;" onclick="saveNewUser()">Save User</button>
            <button class="btn" style="background:#777; flex:1;" onclick="closeAddUserModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- CHANGE PASSWORD MODAL - SIMPLIFIED VERSION -->
<div id="changePasswordModal" class="modal" style="display:none;">
    <div class="modal-content" style="width: 400px; border-radius: 24px; padding: 30px;">
        <h3 style="color: var(--primary-green); margin-bottom: 20px; text-align: center;">üîê Change Password</h3>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Current Password</label>
            <input type="password" id="currentPassword" placeholder="Enter current password" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">New Password</label>
            <input type="password" id="newPassword" placeholder="Enter new password" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
            <div style="font-size: 11px; color: #666; margin-top: 5px;">Minimum 6 characters</div>
        </div>
        
        <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Confirm New Password</label>
            <input type="password" id="confirmPassword" placeholder="Confirm new password" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
        </div>
        
        <div style="display: flex; gap: 15px; margin-bottom: 10px;">
            <button class="btn btn-add" style="flex: 1; padding: 12px;" onclick="changePassword()">Update Password</button>
            <button class="btn" style="flex: 1; background: #95a5a6; padding: 12px;" onclick="closeChangePasswordModal()">Cancel</button>
        </div>
        
        <!-- TEST BUTTONS -->
        <div style="display: flex; gap: 10px; margin-top: 5px;">
            <button class="btn" style="flex: 1; background: #3498db; padding: 10px;" onclick="testFillPasswordFields()">üîß Test Fill</button>
            <button class="btn" style="flex: 1; background: #95a5a6; padding: 10px;" onclick="debugPasswordModal()">üîç Debug</button>
        </div>
        
        <div style="margin-top: 15px; font-size: 12px; color: #666; text-align: center; background: #f8f9fa; padding: 10px; border-radius: 8px;">
            ‚ö° Test with: Current: RIGHTJOSEPH / New: test123
        </div>
    </div>
</div>


<!-- LINK MODAL -->
<div id="linkModal" class="modal">
    <div class="modal-content" style="border-radius: 24px;">
        <h3 style="color: var(--primary-green); text-align: center;">‚ûï Add New Link</h3>
        <input type="text" id="instName" placeholder="Institution Name" style="width:100%; padding:12px; margin:8px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="instWeb" placeholder="Website" style="width:100%; padding:12px; margin:8px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="email" id="instEmail" placeholder="Email" style="width:100%; padding:12px; margin:8px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <button class="btn btn-add" style="width:100%; margin-top:15px; padding:12px;" onclick="addLink()">Save Link</button>
        <button class="btn" style="background:#95a5a6; width:100%; margin-top:8px; padding:12px;" onclick="closeLinkModal()">Cancel</button>
    </div>
</div>

<!-- NOTIFICATION -->
<div id="notification" class="notification"></div>

<!-- FIREBASE SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<script>
    // ========== SINGLE TAB ENFORCEMENT ==========
    const TAB_LOCK_KEY = 'zamcom_tab_lock';
    const TAB_ID = Math.random().toString(36).substring(2) + Date.now();
    
    function enforceSingleTab() {
        const existingTabId = localStorage.getItem(TAB_LOCK_KEY);
        const currentTime = Date.now();
        
        if (existingTabId) {
            try {
                const tabData = JSON.parse(existingTabId);
                if (tabData.id && (currentTime - tabData.timestamp < 2000)) {
                    document.getElementById('tabConflictWarning').style.display = 'block';
                    return false;
                }
            } catch (e) {}
        }
        
        localStorage.setItem(TAB_LOCK_KEY, JSON.stringify({
            id: TAB_ID,
            timestamp: currentTime
        }));
        
        window.addEventListener('beforeunload', function() {
            const currentLock = localStorage.getItem(TAB_LOCK_KEY);
            if (currentLock) {
                try {
                    const tabData = JSON.parse(currentLock);
                    if (tabData.id === TAB_ID) {
                        localStorage.removeItem(TAB_LOCK_KEY);
                    }
                } catch (e) {}
            }
        });
        
        window.addEventListener('storage', function(e) {
            if (e.key === TAB_LOCK_KEY) {
                if (e.newValue) {
                    try {
                        const newTabData = JSON.parse(e.newValue);
                        if (newTabData.id !== TAB_ID) {
                            document.getElementById('tabConflictWarning').style.display = 'block';
                        }
                    } catch (ex) {}
                }
            }
        });
        
        return true;
    }

    function forceTakeover() {
        localStorage.setItem(TAB_LOCK_KEY, JSON.stringify({
            id: TAB_ID,
            timestamp: Date.now()
        }));
        document.getElementById('tabConflictWarning').style.display = 'none';
        showNotification('Tab takeover successful', 'success');
    }

    // ========== FIREBASE CONFIG ==========
    const firebaseConfig = {
        apiKey: "AIzaSyCJrqk15bvd1746VkkDAcOM_U9w0PH7dP0",
        authDomain: "supplierdirectory-6e5c7.firebaseapp.com",
        projectId: "supplierdirectory-6e5c7",
        storageBucket: "supplierdirectory-6e5c7.firebasestorage.app",
        messagingSenderId: "434327330685",
        appId: "1:434327330685:web:6ac7e874dc5952a89c3614"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // ========== PERFORMANCE CACHING ==========
    const CACHE_DURATION = 30000;
    const dataCache = {
        categories: { data: null, timestamp: 0 },
        suppliers: { data: null, timestamp: 0 },
        links: { data: null, timestamp: 0 },
        users: { data: null, timestamp: 0 },
        approvalRequests: { data: null, timestamp: 0 }
    };

    

    async function getCachedData(collectionName, forceRefresh = false) {
        const cache = dataCache[collectionName];
        const now = Date.now();
        
        if (!forceRefresh && cache.data && (now - cache.timestamp) < CACHE_DURATION) {
            return cache.data;
        }
        
        let snapshot;
        if (collectionName === 'approvalRequests') {
            snapshot = await db.collection(COLLECTIONS.APPROVALS)
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc')
                .get();
        } else {
            snapshot = await db.collection(COLLECTIONS[collectionName.toUpperCase()]).get();
        }
        
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        cache.data = data;
        cache.timestamp = now;
        
        return data;
    }

    // ========== GLOBAL VARIABLES ==========
    let categories = [];
    let suppliers = [];
    let links = [];
    let userAccounts = [];
    let auditLogs = [];
    let approvalRequests = [];
    let currentCategory = "";
    let currentCategoryId = "";
    let currentGalleryImages = [];
    let currentGalleryIndex = 0;
    let bgIndex = 0;
    let sessionHeartbeat = null;
    let uploadedDocuments = {
        tpin: null,
        napsa: null,
        zra: null,
        zppa: null
    };

    let userUploadedDocuments = {
    degree: null,
    zips: null,
    nrc: null
};
    let pendingDeletionCallback = null;

    // ========== REQUESTS MANAGEMENT & HISTORY ==========
    let requestsHistory = [];

    function handleUserDocumentUpload(docType, input) {
    const file = input.files[0];
    if (!file) return;
    
    if (file.size > 3 * 1024 * 1024) {
        alert(`File size exceeds 3MB limit for ${docType} document`);
        input.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        // Store in appropriate location based on prefix
        if (docType.startsWith('edit')) {
            // For edit modal
            const actualType = docType.replace('edit', '').toLowerCase();
            if (!window.editUserDocuments) window.editUserDocuments = {};
            window.editUserDocuments[actualType] = {
                name: file.name,
                type: file.type,
                size: file.size,
                data: e.target.result,
                uploadedAt: new Date().toISOString()
            };
            
            const previewEl = document.getElementById(`${docType}DocPreview`);
            if (previewEl) {
                previewEl.innerHTML = `<span style="color: var(--primary-green);">‚úì ${file.name.substring(0, 20)}${file.name.length > 20 ? '...' : ''}</span>`;
            }
        } else {
            // For add modal
            userUploadedDocuments[docType] = {
                name: file.name,
                type: file.type,
                size: file.size,
                data: e.target.result,
                uploadedAt: new Date().toISOString()
            };
            
            const previewEl = document.getElementById(`new${docType.charAt(0).toUpperCase() + docType.slice(1)}DocPreview`);
            if (previewEl) {
                previewEl.innerHTML = `<span style="color: var(--primary-green);">‚úì ${file.name.substring(0, 20)}${file.name.length > 20 ? '...' : ''}</span>`;
            }
        }
    };
    reader.readAsDataURL(file);
}

// Global variable to track current document being viewed
let currentViewingDocument = null;

// View user document in full screen
function viewUserDocument(userId, docType, event) {
    if (event) {
        event.stopPropagation();
    }
    
    console.log(`Viewing document for user ${userId}, type: ${docType}`);
    
    const user = userAccounts.find(u => u.id === userId);
    if (!user) {
        alert('User not found');
        return;
    }
    
    if (!user.documents || !user.documents[docType]) {
        alert('Document not found for this user');
        return;
    }
    
    const doc = user.documents[docType];
    currentViewingDocument = { userId, docType, doc };
    
    // Set title
    const titleMap = {
        degree: 'üéì Degree/Diploma Certificate',
        zips: 'üìú ZIPS Membership Certificate',
        nrc: 'ü™™ National Registration Card (NRC)'
    };
    
    document.getElementById('userDocumentViewerTitle').innerHTML = 
        `${titleMap[docType] || 'Document'} - ${user.fullName || user.username}`;
    
    // Set content
    const contentDiv = document.getElementById('userDocumentViewerContent');
    const isImage = doc.type && (doc.type.startsWith('image/') || doc.name?.match(/\.(jpg|jpeg|png|gif|webp)$/i));
    
    let contentHtml = '';
    
    if (isImage) {
        contentHtml = `
            <div style="text-align: center; width: 100%;">
                <img src="${doc.data}" style="max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; text-align: left; width: 100%; max-width: 600px;">
                    <p><strong>File Name:</strong> ${doc.name}</p>
                    <p><strong>Uploaded:</strong> ${new Date(doc.uploadedAt).toLocaleString()}</p>
                    <p><strong>File Size:</strong> ${(doc.size / 1024).toFixed(1)} KB</p>
                    <p><strong>File Type:</strong> ${doc.type || 'Unknown'}</p>
                </div>
            </div>
        `;
    } else {
        // For PDFs and other documents
        contentHtml = `
            <div style="width: 100%; height: 70vh; display: flex; flex-direction: column; align-items: center;">
                <iframe src="${doc.data}" style="width: 100%; height: 100%; border: none; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></iframe>
                <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; text-align: left; width: 100%; max-width: 600px;">
                    <p><strong>File Name:</strong> ${doc.name}</p>
                    <p><strong>Uploaded:</strong> ${new Date(doc.uploadedAt).toLocaleString()}</p>
                    <p><strong>File Size:</strong> ${(doc.size / 1024).toFixed(1)} KB</p>
                    <p><strong>File Type:</strong> ${doc.type || 'PDF Document'}</p>
                </div>
            </div>
        `;
    }
    
    contentDiv.innerHTML = contentHtml;
    
    // Show modal
    document.getElementById('userDocumentViewerModal').style.display = 'flex';
}

// Close document viewer
function closeUserDocumentViewer() {
    document.getElementById('userDocumentViewerModal').style.display = 'none';
    document.getElementById('userDocumentViewerContent').innerHTML = '';
    currentViewingDocument = null;
}

// Download current document
function downloadCurrentUserDocument() {
    if (!currentViewingDocument) {
        alert('No document selected');
        return;
    }
    
    const { doc } = currentViewingDocument;
    
    // Create a temporary link and trigger download
    const link = document.createElement('a');
    link.href = doc.data;
    link.download = doc.name || 'document';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Also add this to close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('userDocumentViewerModal');
    if (event.target === modal) {
        closeUserDocumentViewer();
    }
}

// Update saveNewUser function to include full name and documents
async function saveNewUser() {
    if (!canAddUser()) {
        alert("You don't have permission to add users");
        return;
    }

    const fullName = document.getElementById('newFullName').value.trim();
    const username = document.getElementById('newUsername').value.toUpperCase().trim();
    const role = document.getElementById('newRole').value;
    const nrc = document.getElementById('newNrc').value.trim();
    const email = document.getElementById('newEmail').value.trim();
    const phone = document.getElementById('newPhone').value.trim();
    const institution = document.getElementById('newInstitution').value.trim();
    const position = document.getElementById('newPosition').value.trim();
    const password = document.getElementById('newPassword').value.trim();

    // Validate required fields including full name and documents
    if (!fullName || !username || !password || !role || !nrc) {
        alert("Full Name, Username, Password, Role, and NRC are required");
        return;
    }

    // Check if documents are uploaded
    if (!userUploadedDocuments.degree || !userUploadedDocuments.zips || !userUploadedDocuments.nrc) {
        alert("Please upload all required documents: Degree/Diploma, ZIPS Certificate, and NRC");
        return;
    }

    if (role === 'super admin' && !isCurrentUserSuperAdmin()) {
        alert("Only super admin can create super admin users");
        return;
    }

    if (userAccounts.find(u => u.username === username)) {
        alert("Username already exists");
        return;
    }

    const newUser = {
        fullName, // NEW
        username,
        password,
        role,
        nrc,
        email,
        phone,
        institution,
        position,
        documents: { // NEW - Store all uploaded documents
            degree: userUploadedDocuments.degree,
            zips: userUploadedDocuments.zips,
            nrc: userUploadedDocuments.nrc
        },
        enabled: true,
        createdAt: new Date().toISOString(),
        lastActive: null
    };

    try {
        if (canAddUserWithoutApproval()) {
            await db.collection(COLLECTIONS.USERS).add(newUser);
            
            await logAudit('CREATE_USER', {
                username,
                fullName,
                role,
                createdBy: getCurrentUser()
            });
            
            await getAllUsers(true);
            closeAddUserModal();
            manageUsersModal();
            showNotification(`User ${fullName} (${username}) created successfully`);
            
            // Reset uploaded documents
            userUploadedDocuments = { degree: null, zips: null, nrc: null };
        } else {
            const currentUser = getUser(getCurrentUser());
            await createApprovalRequest('user', newUser, 'add', null);
            closeAddUserModal();
            showNotification(`User addition request submitted for ${currentUser.role === 'admin' ? 'super admin' : 'admin/super admin'} approval`, 'info');
            
            // Reset uploaded documents
            userUploadedDocuments = { degree: null, zips: null, nrc: null };
        }
    } catch (error) {
        console.error("Error creating user:", error);
        alert("Failed to create user");
    }
}

// Update openEditUserModal to include full name and documents
function openEditUserModal(userId) {
    const user = userAccounts.find(u => u.id === userId);
    if (!user) {
        alert('User not found');
        return;
    }

    const currentUser = getUser(getCurrentUser());
    
    if (currentUser.role !== 'super admin') {
        if (user.role === 'super admin') {
            alert('You cannot edit a super admin user');
            return;
        }
    }

    document.getElementById('editUserId').value = user.id;
    document.getElementById('editFullName').value = user.fullName || ''; // NEW
    document.getElementById('editUsername').value = user.username;
    document.getElementById('editRole').value = user.role;
    document.getElementById('editNrc').value = user.nrc || '';
    document.getElementById('editEmail').value = user.email || '';
    document.getElementById('editPhone').value = user.phone || '';
    document.getElementById('editInstitution').value = user.institution || '';
    document.getElementById('editPosition').value = user.position || '';
    document.getElementById('editPassword').value = '';
    document.getElementById('editEnabled').checked = user.enabled !== false;

    // Reset edit documents
    window.editUserDocuments = {};
    ['editDegreeDocPreview', 'editZipsDocPreview', 'editNrcDocPreview'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
    });

    // Display current documents
    const currentDocsDiv = document.getElementById('editCurrentDocsList');
    if (currentDocsDiv) {
        let docsHtml = '';
        if (user.documents?.degree) {
            docsHtml += `<div style="margin-bottom: 5px;"><span style="background: #3498db; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">üéì Degree</span> ${user.documents.degree.name} <button onclick="viewUserDocument('${user.id}', 'degree')" style="background: none; border: none; color: var(--link-blue); cursor: pointer;">View</button></div>`;
        }
        if (user.documents?.zips) {
            docsHtml += `<div style="margin-bottom: 5px;"><span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">üìú ZIPS</span> ${user.documents.zips.name} <button onclick="viewUserDocument('${user.id}', 'zips')" style="background: none; border: none; color: var(--link-blue); cursor: pointer;">View</button></div>`;
        }
        if (user.documents?.nrc) {
            docsHtml += `<div style="margin-bottom: 5px;"><span style="background: #e67e22; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">ü™™ NRC</span> ${user.documents.nrc.name} <button onclick="viewUserDocument('${user.id}', 'nrc')" style="background: none; border: none; color: var(--link-blue); cursor: pointer;">View</button></div>`;
        }
        if (!docsHtml) docsHtml = '<p style="color: #999; font-style: italic;">No documents uploaded</p>';
        currentDocsDiv.innerHTML = docsHtml;
    }

    if (currentUser.role !== 'super admin') {
        document.getElementById('editRole').disabled = true;
    } else {
        document.getElementById('editRole').disabled = false;
    }

    document.getElementById('editUserModal').style.display = 'flex';
}

// Update saveUserEdit to include full name and documents
async function saveUserEdit() {
    if (!isCurrentUserSuperAdmin() && !isCurrentUserAdmin()) {
        alert("You don't have permission to edit users");
        return;
    }

    const userId = document.getElementById('editUserId').value;
    const user = userAccounts.find(u => u.id === userId);
    if (!user) {
        alert('User not found');
        return;
    }

    const currentUser = getUser(getCurrentUser());
    
    if (currentUser.role !== 'super admin' && user.role === 'super admin') {
        alert('You cannot edit a super admin user');
        closeEditUserModal();
        return;
    }

    const fullName = document.getElementById('editFullName').value.trim();
    if (!fullName) {
        alert('Full Name is required');
        return;
    }

    const updatedData = {
        fullName, // NEW
        role: document.getElementById('editRole').value,
        nrc: document.getElementById('editNrc').value.trim(),
        email: document.getElementById('editEmail').value.trim(),
        phone: document.getElementById('editPhone').value.trim(),
        institution: document.getElementById('editInstitution').value.trim(),
        position: document.getElementById('editPosition').value.trim(),
        enabled: document.getElementById('editEnabled').checked
    };

    // Handle document updates
    if (window.editUserDocuments && Object.keys(window.editUserDocuments).length > 0) {
        updatedData.documents = { ...user.documents };
        
        if (window.editUserDocuments.degree) {
            updatedData.documents.degree = window.editUserDocuments.degree;
        }
        if (window.editUserDocuments.zips) {
            updatedData.documents.zips = window.editUserDocuments.zips;
        }
        if (window.editUserDocuments.nrc) {
            updatedData.documents.nrc = window.editUserDocuments.nrc;
        }
    }

    const newPassword = document.getElementById('editPassword').value.trim();
    if (newPassword) {
        updatedData.password = newPassword;
    }

    if (currentUser.role !== 'super admin' && updatedData.role === 'super admin') {
        alert('Only super admin can assign super admin role');
        return;
    }

    try {
        if (currentUser.role === 'super admin') {
            await db.collection(COLLECTIONS.USERS).doc(userId).update(updatedData);
            
            await logAudit('EDIT_USER', {
                username: user.username,
                fullName: fullName,
                changes: updatedData,
                editedBy: getCurrentUser()
            });
            
            await getAllUsers(true);
            closeEditUserModal();
            manageUsersModal();
            showNotification(`User ${fullName} updated successfully`);
            
            // Reset edit documents
            window.editUserDocuments = {};
        } else {
            await createApprovalRequest('user', updatedData, 'edit', userId);
            closeEditUserModal();
            manageUsersModal();
            showNotification('User edit request submitted for super admin approval', 'info');
            
            // Reset edit documents
            window.editUserDocuments = {};
        }
    } catch (error) {
        console.error("Error updating user:", error);
        alert("Failed to update user: " + error.message);
    }
}

// Reset function for add user modal
function closeAddUserModal() {
    document.getElementById('addUserModal').style.display = 'none';
    // Reset form fields
    document.getElementById('newFullName').value = '';
    document.getElementById('newUsername').value = '';
    document.getElementById('newRole').value = 'staff';
    document.getElementById('newNrc').value = '';
    document.getElementById('newEmail').value = '';
    document.getElementById('newPhone').value = '';
    document.getElementById('newInstitution').value = '';
    document.getElementById('newPosition').value = '';
    document.getElementById('newPassword').value = '';
    
    // Reset document previews
    ['newDegreeDocPreview', 'newZipsDocPreview', 'newNrcDocPreview'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
    });
    
    // Reset uploaded documents
    userUploadedDocuments = { degree: null, zips: null, nrc: null };
}

// Update default users to include fullName
async function ensureDefaultUsers() {
    try {
        const usersSnapshot = await db.collection(COLLECTIONS.USERS).get();
        if (usersSnapshot.empty) {
            const defaultUsers = [
                { 
                    fullName: "Joseph Zulu", // NEW
                    username: "JOSEPH", 
                    password: "RIGHTJOSEPH", 
                    role: "super admin", 
                    enabled: true, 
                    nrc: "123456/78/1", 
                    email: "zulujosephp@gmail.com", 
                    phone: "+260973031254", 
                    institution: "ZAMCOM", 
                    position: "Procurement Lead",
                    documents: {}, // Empty documents for default users
                    createdAt: new Date().toISOString(),
                    lastActive: null
                },
                { 
                    fullName: "Chishala Banda", // NEW
                    username: "CHISHALA", 
                    password: "RIGHTCHISHALA", 
                    role: "staff", 
                    enabled: true, 
                    nrc: "998877/66/5", 
                    email: "chishala@zamcom.zm", 
                    phone: "+260977123456", 
                    institution: "ZAMCOM", 
                    position: "Procurement Officer",
                    documents: {}, // Empty documents for default users
                    createdAt: new Date().toISOString(),
                    lastActive: null
                }
            ];
            for (const user of defaultUsers) {
                await db.collection(COLLECTIONS.USERS).add(user);
            }
            await logAudit('SYSTEM_INIT', { action: 'Default users created' });
            console.log("Default users created with full names");
        }
    } catch (error) { 
        console.error("Error ensuring users:", error); 
    }
}

    function hideLoadingSpinner() {
        const spinner = document.getElementById('loadingSpinner');
        if (spinner) {
            spinner.style.opacity = '0';
            setTimeout(() => {
                spinner.style.display = 'none';
            }, 500);
        }
    }

    async function loadRequestsHistory() {
        try {
            const snapshot = await db.collection(COLLECTIONS.APPROVALS)
                .orderBy('createdAt', 'desc')
                .limit(100)
                .get();
            requestsHistory = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
        } catch (error) {
            console.error('Error loading requests history:', error);
        }
    }

    async function openRequestsManagement() {
        try {
            const snapshot = await db.collection(COLLECTIONS.APPROVALS)
                .orderBy('createdAt', 'desc')
                .get();
            
            const allRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const pendingRequests = allRequests.filter(req => req.status === 'pending');
            const historyRequests = allRequests.filter(req => req.status === 'approved' || req.status === 'rejected');
            
            const approvedCount = historyRequests.filter(r => r.status === 'approved').length;
            const rejectedCount = historyRequests.filter(r => r.status === 'rejected').length;
            const totalCount = allRequests.length;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'requestsManagementModal';
            modal.style.display = 'flex';
            
            let pendingHtml = '';
            if (pendingRequests.length === 0) {
                pendingHtml = `
                    <div style="text-align: center; padding: 60px; background: white; border-radius: 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚úÖ</div>
                        <div style="font-size: 18px; font-weight: 500;">No pending requests</div>
                        <div style="font-size: 14px; color: #999; margin-top: 10px;">All caught up!</div>
                    </div>
                `;
            } else {
                pendingRequests.forEach(req => {
                    let created = 'Unknown';
                    if (req.createdAt) {
                        if (req.createdAt.toDate) created = req.createdAt.toDate().toLocaleString();
                        else if (req.createdDate) created = new Date(req.createdDate).toLocaleString();
                        else if (req.createdAt.seconds) created = new Date(req.createdAt.seconds * 1000).toLocaleString();
                        else if (typeof req.createdAt === 'string') created = new Date(req.createdAt).toLocaleString();
                    }
                    
                    const actionColor = req.action === 'delete' ? '#e74c3c' : 
                                      req.action === 'edit' ? '#f39c12' : '#3498db';
                    
                    const actionBg = req.action === 'delete' ? '#fee9e7' :
                                   req.action === 'edit' ? '#fef5e7' : '#e8f0fe';
                    
                    const itemName = req.requestedData?.name || 
                                   (req.type === 'category' ? 'Category' : 'Supplier') + 
                                   (req.itemId ? ` (${req.itemId.substring(0, 6)}...)` : '');
                    
                    const reason = req.reason || 'No reason provided';
                    
                    pendingHtml += `
                        <div style="background: white; border-radius: 24px; padding: 24px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.02); border: 1px solid #f0f0f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="background: ${actionBg}; color: ${actionColor}; padding: 8px 20px; border-radius: 30px; font-weight: 700; font-size: 14px; letter-spacing: 0.5px;">
                                        ‚è≥ ${req.action?.toUpperCase() || 'ACTION'} ¬∑ ${req.type?.toUpperCase() || 'ITEM'}
                                    </span>
                                    <span style="background: ${req.requestedByRole === 'super admin' ? '#9b59b6' : req.requestedByRole === 'admin' ? '#3498db' : '#2ecc71'}; color: white; padding: 6px 16px; border-radius: 30px; font-size: 13px; font-weight: 600;">
                                        ${req.requestedByRole?.toUpperCase() || 'STAFF'}
                                    </span>
                                </div>
                                <span style="color: #888; font-size: 13px; background: #f8f9fa; padding: 6px 16px; border-radius: 30px;">
                                    üïê ${created}
                                </span>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px; margin-bottom: 24px;">
                                <div style="background: #fafbfc; padding: 20px; border-radius: 20px;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <div style="background: ${actionColor}20; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 16px; font-size: 20px;">
                                            üë§
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Requested By</div>
                                            <div style="font-weight: 700; font-size: 16px;">${req.requestedBy || 'Unknown'}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 12px; margin-top: 8px; color: #666; font-size: 13px;">
                                        <span>üìã ${req.action}</span>
                                        <span>üì¶ ${req.type}</span>
                                    </div>
                                </div>
                                
                                <div style="background: #fafbfc; padding: 20px; border-radius: 20px;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <div style="background: #e8f5e9; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 16px; font-size: 20px;">
                                            üì¶
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Item Details</div>
                                            <div style="font-weight: 700; font-size: 16px;">${itemName}</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 12px; color: #888; margin-top: 8px; word-break: break-all; background: white; padding: 12px; border-radius: 12px;">
                                        ID: ${req.itemId || 'N/A'}
                                    </div>
                                </div>
                            </div>
                            
                            ${req.reason ? `
                            <div style="background: #fff8e7; border-left: 4px solid #f39c12; padding: 16px; margin-bottom: 20px; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="background: #f39c12; color: white; padding: 4px 12px; border-radius: 30px; font-size: 11px; font-weight: 700;">REASON</span>
                                    <span style="font-size: 12px; color: #666;">Provided by ${req.requestedBy}</span>
                                </div>
                                <p style="margin: 0; color: #2c3e50; font-size: 14px; line-height: 1.6;">${req.reason}</p>
                            </div>
                            ` : ''}
                            
                            ${req.action === 'edit' && req.requestedData ? `
                            <div style="margin-top: 16px; border-top: 1px dashed #e0e0e0; padding-top: 16px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                    <span style="background: #f39c12; color: white; padding: 4px 12px; border-radius: 30px; font-size: 11px; font-weight: 700;">CHANGES</span>
                                    <span style="font-size: 12px; color: #666;">Modified fields</span>
                                </div>
                                <div style="background: #fff3e0; border-radius: 16px; padding: 16px;">
                                    ${Object.entries(req.requestedData)
                                        .filter(([key]) => !['id', 'createdAt', 'updatedAt', 'lastModifiedAt', 'lastModifiedBy'].includes(key))
                                        .map(([key, value]) => {
                                            if (typeof value === 'object') {
                                                return `<div style="margin-bottom: 8px; font-size: 12px;">
                                                    <span style="font-weight: 700; color: #e67e22; text-transform: capitalize;">${key}:</span>
                                                    <pre style="background: white; padding: 8px; border-radius: 8px; margin: 4px 0 0 0; font-size: 11px; overflow-x: auto;">${JSON.stringify(value, null, 2)}</pre>
                                                </div>`;
                                            }
                                            return `<div style="display: flex; margin-bottom: 8px; font-size: 12px;">
                                                <span style="font-weight: 700; color: #e67e22; width: 120px; text-transform: capitalize;">${key}:</span>
                                                <span style="color: #2c3e50; flex: 1;">${value || '<span style="color: #999;">(empty)</span>'}</span>
                                            </div>`;
                                        }).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            <div style="display: flex; gap: 16px; justify-content: flex-end; border-top: 1px solid #f0f0f0; padding-top: 24px;">
                                <button onclick="approveRequestNow('${req.id}')" style="background: #27ae60; color: white; border: none; padding: 14px 32px; border-radius: 40px; font-weight: 700; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.2);">
                                    <span style="font-size: 18px;">‚úì</span> APPROVE REQUEST
                                </button>
                                <button onclick="rejectRequestNow('${req.id}')" style="background: #e74c3c; color: white; border: none; padding: 14px 32px; border-radius: 40px; font-weight: 700; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(231, 76, 60, 0.2);">
                                    <span style="font-size: 18px;">‚úó</span> REJECT REQUEST
                                </button>
                                ${isCurrentUserSuperAdmin() ? 
                                    `<button onclick="deleteRequestNow('${req.id}')" style="background: #95a5a6; color: white; border: none; padding: 14px 28px; border-radius: 40px; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                        üóëÔ∏è DELETE
                                    </button>` : ''
                                }
                            </div>
                        </div>
                    `;
                });
            }
            
            let historyHtml = '';
            if (historyRequests.length === 0) {
                historyHtml = `
                    <div style="text-align: center; padding: 60px; background: white; border-radius: 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üì≠</div>
                        <div style="font-size: 18px; font-weight: 500;">No request history</div>
                    </div>
                `;
            } else {
                historyRequests.slice(0, 20).forEach(req => {
                    const created = req.createdAt ? new Date(req.createdAt).toLocaleString() : 'Unknown';
                    const statusColor = req.status === 'approved' ? '#2ecc71' : '#e74c3c';
                    const statusBg = req.status === 'approved' ? '#e8f8f0' : '#fee9e7';
                    const reason = req.reason || 'No reason provided';
                    
                    historyHtml += `
                        <div style="background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid #f0f0f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; gap: 20px;">
                                    <div style="background: ${statusBg}; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 16px; font-size: 24px;">
                                        ${req.status === 'approved' ? '‚úì' : '‚úó'}
                                    </div>
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                            <span style="background: ${statusColor}; color: white; padding: 4px 14px; border-radius: 30px; font-size: 12px; font-weight: 700;">
                                                ${req.status.toUpperCase()}
                                            </span>
                                            <span style="color: #666; font-size: 12px;">${req.action?.toUpperCase()} ¬∑ ${req.type?.toUpperCase()}</span>
                                        </div>
                                        <div style="display: flex; gap: 20px; font-size: 13px;">
                                            <span style="color: #555;">üë§ ${req.requestedBy}</span>
                                            <span style="color: #888;">‚úì ${req.reviewedBy || 'System'}</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="color: #888; font-size: 12px;">
                                    ${created}
                                </div>
                            </div>
                            ${req.reason ? `
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 3px solid ${statusColor};">
                                <span style="font-weight: 600; font-size: 12px; color: #555;">Reason:</span>
                                <span style="font-size: 13px; color: #333; margin-left: 8px;">${req.reason}</span>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
            
            modal.innerHTML = `
                <div style="background: linear-gradient(145deg, #f8fafc, #f0f4f8); width: 1300px; max-width: 95%; max-height: 90vh; overflow-y: auto; border-radius: 32px; padding: 40px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="background: var(--primary-green); width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 20px;">
                                <span style="font-size: 32px; color: white;">üìã</span>
                            </div>
                            <div>
                                <h2 style="color: #1e3b37; margin: 0; font-size: 28px; font-weight: 700;">Requests Management</h2>
                                <p style="color: #6b9080; margin: 5px 0 0 0; font-size: 15px;">Approve, reject, and track all change requests</p>
                            </div>
                        </div>
                        <button onclick="this.closest('.modal').remove()" style="background: white; border: none; width: 48px; height: 48px; border-radius: 16px; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #666; box-shadow: 0 4px 12px rgba(0,0,0,0.02);">
                            ‚úï
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 40px;">
                        <div style="background: white; padding: 28px; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.02); border: 1px solid white;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <span style="font-size: 42px;">‚è≥</span>
                                <span style="background: #e67e22; color: white; padding: 6px 14px; border-radius: 30px; font-size: 13px; font-weight: 600;">Pending</span>
                            </div>
                            <div style="font-size: 44px; font-weight: 800; color: #e67e22; margin-bottom: 8px;">${pendingRequests.length}</div>
                            <div style="color: #666; font-size: 15px;">Awaiting approval</div>
                        </div>
                        
                        <div style="background: white; padding: 28px; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.02); border: 1px solid white;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <span style="font-size: 42px;">‚úì</span>
                                <span style="background: #2ecc71; color: white; padding: 6px 14px; border-radius: 30px; font-size: 13px; font-weight: 600;">Approved</span>
                            </div>
                            <div style="font-size: 44px; font-weight: 800; color: #2ecc71; margin-bottom: 8px;">${approvedCount}</div>
                            <div style="color: #666; font-size: 15px;">Successfully approved</div>
                        </div>
                        
                        <div style="background: white; padding: 28px; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.02); border: 1px solid white;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <span style="font-size: 42px;">‚úó</span>
                                <span style="background: #e74c3c; color: white; padding: 6px 14px; border-radius: 30px; font-size: 13px; font-weight: 600;">Rejected</span>
                            </div>
                            <div style="font-size: 44px; font-weight: 800; color: #e74c3c; margin-bottom: 8px;">${rejectedCount}</div>
                            <div style="color: #666; font-size: 15px;">Declined requests</div>
                        </div>
                        
                        <div style="background: white; padding: 28px; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.02); border: 1px solid white;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <span style="font-size: 42px;">üìä</span>
                                <span style="background: #3498db; color: white; padding: 6px 14px; border-radius: 30px; font-size: 13px; font-weight: 600;">Total</span>
                            </div>
                            <div style="font-size: 44px; font-weight: 800; color: #3498db; margin-bottom: 8px;">${totalCount}</div>
                            <div style="color: #666; font-size: 15px;">All time requests</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 16px; margin-bottom: 30px; border-bottom: 2px solid #e9ecef; padding-bottom: 16px;">
                        <button id="pendingTabBtn" onclick="showPendingTab()" style="background: #e67e22; color: white; border: none; padding: 14px 32px; border-radius: 40px; font-weight: 700; font-size: 15px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <span>‚è≥</span> PENDING REQUESTS (${pendingRequests.length})
                        </button>
                        <button id="historyTabBtn" onclick="showHistoryTab()" style="background: #34495e; color: white; border: none; padding: 14px 32px; border-radius: 40px; font-weight: 700; font-size: 15px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <span>üìú</span> HISTORY & ARCHIVE (${historyRequests.length})
                        </button>
                    </div>
                    
                    <div id="pendingSection" style="display: block;">
                        <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
                            ${pendingHtml}
                        </div>
                    </div>
                    
                    <div id="historySection" style="display: none;">
                        <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
                            ${historyHtml}
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end;">
                        <span style="color: #888; font-size: 13px;">Last updated: ${new Date().toLocaleString()}</span>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to load requests: ' + error.message);
        }
    }

    window.showPendingTab = function() {
        const pending = document.getElementById('pendingSection');
        const history = document.getElementById('historySection');
        const pendingBtn = document.getElementById('pendingTabBtn');
        const historyBtn = document.getElementById('historyTabBtn');
        
        if (pending && history) {
            pending.style.display = 'block';
            history.style.display = 'none';
            pendingBtn.style.background = '#e67e22';
            historyBtn.style.background = '#34495e';
        }
    };

    window.showHistoryTab = function() {
        const pending = document.getElementById('pendingSection');
        const history = document.getElementById('historySection');
        const pendingBtn = document.getElementById('pendingTabBtn');
        const historyBtn = document.getElementById('historyTabBtn');
        
        if (pending && history) {
            pending.style.display = 'none';
            history.style.display = 'block';
            pendingBtn.style.background = '#34495e';
            historyBtn.style.background = '#e67e22';
        }
    };

    function closeRequestsManagement() {
        const modal = document.getElementById('requestsManagementModal');
        if (modal) modal.remove();
    }

    // ========== FIXED: USER APPROVAL HISTORY - NO INDEX REQUIRED ==========
    async function openUserApprovalHistory() {
        const currentUser = getUser(getCurrentUser());
        // Super admin should NOT see the My Requests tab - they use Requests Management
        if (currentUser && currentUser.role === 'super admin') {
            showNotification('Super admin: Please use Requests Management to view all requests', 'info');
            openRequestsManagement();
            return;
        }
        
        showView('userApprovalHistory');
        await loadUserApprovalHistory('pending');
    }

    async function loadUserApprovalHistory(filter = 'pending') {
        const currentUser = getCurrentUser();
        if (!currentUser) return;
        
        const container = document.getElementById('userApprovalHistoryContainer');
        if (!container) return;
        
        try {
            console.log(`Loading ${filter} requests for user: ${currentUser}`);
            
            // First, get all requests for this user (no composite index required)
            const snapshot = await db.collection(COLLECTIONS.APPROVALS)
                .where('requestedBy', '==', currentUser)
                .get();
            
            console.log(`Found ${snapshot.docs.length} total requests for user`);
            
            let userRequests = snapshot.docs.map(doc => ({ 
                id: doc.id, 
                ...doc.data() 
            }));
            
            // Filter by status in JavaScript (client-side)
            if (filter === 'pending') {
                userRequests = userRequests.filter(req => req.status === 'pending');
            } else {
                userRequests = userRequests.filter(req => 
                    req.status === 'approved' || req.status === 'rejected'
                );
            }
            
            // Sort by createdAt (newest first) in JavaScript
            userRequests.sort((a, b) => {
                const dateA = a.createdAt?.toDate?.() || new Date(a.createdAt || 0);
                const dateB = b.createdAt?.toDate?.() || new Date(b.createdAt || 0);
                return dateB - dateA;
            });
            
            renderUserApprovalHistory(userRequests, filter);
            
        } catch (error) {
            console.error('Error loading user approval history:', error);
            container.innerHTML = `
                <div style="text-align: center; padding: 60px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                    <div style="font-size: 18px; font-weight: 500;">Failed to load requests</div>
                    <div style="font-size: 14px; color: #999; margin-top: 10px;">${error.message}</div>
                    <button onclick="loadUserApprovalHistory('${filter}')" class="btn" style="margin-top: 20px; background: var(--primary-green);">Retry</button>
                    <p style="margin-top: 20px; font-size: 12px; color: #f39c12;">
                        ‚ö†Ô∏è Please contact super admin to create the required Firestore indexes.
                    </p>
                </div>
            `;
        }
    }

    function renderUserApprovalHistory(requests, filter) {
        const container = document.getElementById('userApprovalHistoryContainer');
        
        if (requests.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üì≠</div>
                    <div style="font-size: 18px; font-weight: 500;">
                        ${filter === 'pending' ? 'No pending requests' : 'No request history'}
                    </div>
                </div>
            `;
            return;
        }

        let html = '';
        requests.forEach(req => {
            const created = req.createdAt ? 
                (req.createdAt.toDate ? req.createdAt.toDate().toLocaleString() : new Date(req.createdAt).toLocaleString()) 
                : 'Unknown';
            const actionColor = req.action === 'delete' ? '#e74c3c' : 
                              req.action === 'edit' ? '#f39c12' : '#3498db';
            const statusColor = req.status === 'approved' ? '#2ecc71' : 
                              req.status === 'rejected' ? '#e74c3c' : '#f39c12';
            
            html += `
                <div style="background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid #e0e0e0; border-left: 6px solid ${actionColor};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 30px; font-size: 12px; font-weight: 700;">
                                ${req.status?.toUpperCase() || 'PENDING'}
                            </span>
                            <span style="margin-left: 12px; font-weight: 600; color: #2c3e50;">
                                ${req.action?.toUpperCase()} - ${req.type?.toUpperCase()}
                            </span>
                        </div>
                        <span style="color: #888; font-size: 12px;">${created}</span>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <span style="font-weight: 600; color: #555;">Item:</span>
                        <span style="color: #333; margin-left: 8px;">${req.requestedData?.name || req.itemId || 'N/A'}</span>
                    </div>
                    
                    ${req.reason ? `
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <span style="font-weight: 600; color: #f39c12;">Reason:</span>
                        <span style="color: #333; margin-left: 8px;">${req.reason}</span>
                    </div>
                    ` : ''}
                    
                    ${req.reviewedBy ? `
                    <div style="font-size: 12px; color: #666; border-top: 1px solid #eee; padding-top: 12px;">
                        Reviewed by: ${req.reviewedBy} on ${req.reviewedAt ? new Date(req.reviewedAt).toLocaleString() : 'N/A'}
                    </div>
                    ` : ''}
                    
                    ${req.status === 'pending' ? `
                    <div style="margin-top: 12px; font-size: 12px; color: #e67e22; background: #fef5e7; padding: 8px 12px; border-radius: 8px;">
                        ‚è≥ This request is awaiting approval
                    </div>
                    ` : ''}
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    function switchApprovalHistoryTab(tab) {
        document.getElementById('historyPendingTab').classList.toggle('active', tab === 'pending');
        document.getElementById('historyHistoryTab').classList.toggle('active', tab === 'history');
        loadUserApprovalHistory(tab);
    }

    // Audit pagination variables
    let currentAuditPage = 1;
    let auditLogsPerPage = 20;
    let totalAuditPages = 1;

    const bgImages = [
        './images/bgx.jpg',
        './images/bg.jpg',
        './images/bgx1.jpg'
    ];

    const LOCK_TIME = { hr: 16, min: 50 };
    const OPEN_TIME = { hr: 7, min: 30 };
    const COLLECTIONS = {
        USERS: 'users',
        CATEGORIES: 'categories',
        SUPPLIERS: 'suppliers',
        LINKS: 'links',
        AUDIT_LOGS: 'audit_logs',
        SESSIONS: 'sessions',
        APPROVALS: 'approval_requests'
    };

    // ========== ROLE HELPERS ==========
    function getCurrentUser() { 
        return localStorage.getItem('logged_user') || null; 
    }
    
    function getUser(username) { 
        return userAccounts.find(u => u.username === username); 
    }
    
    function isCurrentUserSuperAdmin() { 
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin'; 
    }
    
    function isCurrentUserAdmin() { 
        const user = getUser(getCurrentUser());
        return user && (user.role === 'admin' || user.role === 'super admin'); 
    }
    
    function isCurrentUserStaff() { 
        const user = getUser(getCurrentUser());
        return user && user.role === 'staff'; 
    }
    
    function canWorkAfterLock() { 
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin'); 
    }

    // ========== PERMISSION CHECKS ==========
    
    // USER MANAGEMENT PERMISSIONS
    function canAddUser() {
        const user = getUser(getCurrentUser());
        if (!user) return false;
        return user.role === 'super admin' || user.role === 'admin' || user.role === 'staff';
    }
    
    function canAddUserWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }
    
    function canDeleteUser() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }
    
    function canDeleteUserWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }
    
    function isJoseph(username) {
        return username === 'JOSEPH';
    }

    // CATEGORY PERMISSIONS
    function canCreateCategory() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canCreateCategoryWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }
    
    function canEditCategory() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canEditCategoryWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }
    
    function canDeleteCategory() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canDeleteCategoryWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }
    
    function requiresReasonForCategoryDeletion() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'admin' || user.role === 'staff');
    }

    // SUPPLIER PERMISSIONS
    function canCreateSupplier() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canCreateSupplierWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }
    
    function canEditSupplier() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canEditSupplierWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }
    
    function canDeleteSupplier() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canDeleteSupplierWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }
    
    function requiresReasonForSupplierDeletion() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'admin' || user.role === 'staff');
    }

    // LINK PERMISSIONS
    function canCreateLink() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canCreateLinkWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }
    
    function canEditLink() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canEditLinkWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }
    
    function canDeleteLink() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canDeleteLinkWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }
    
    function requiresReasonForLinkDeletion() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'admin' || user.role === 'staff');
    }

    // AUDIT LOG PERMISSIONS
    function canViewAuditLogs() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canDeleteAuditLogs() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }

    // SESSIONS PERMISSIONS
    function canViewSessions() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }

    // APPROVAL PERMISSIONS
    function canApproveRequests() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }
    
    function canApproveAllRequests() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }

    // SYSTEM LOCK PERMISSIONS
    function canAccessLockedSystem() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }

    // ========== SYSTEM LOCK ==========
    function isSystemLocked() {
        const now = new Date();
        const currentTotal = (now.getHours() * 60) + now.getMinutes();
        const lockTotal = (LOCK_TIME.hr * 60) + LOCK_TIME.min;
        const openTotal = (OPEN_TIME.hr * 60) + OPEN_TIME.min;
        return (currentTotal >= lockTotal || currentTotal < openTotal);
    }

    // ========== AUDIT LOGGING WITH DETAILED ACTIONS ==========
    async function logAudit(action, details = {}) {
        try {
            const currentUser = getCurrentUser();
            
            // Format the action to be more descriptive
            let actionDescription = action;
            let detailedMessage = '';
            
            // Create detailed description based on action type
            if (action.includes('CREATE')) {
                if (details.name) {
                    detailedMessage = `Created new ${action.replace('CREATE_', '').toLowerCase()}: "${details.name}"`;
                } else if (details.username) {
                    detailedMessage = `Created new user: "${details.username}" with role ${details.role}`;
                } else {
                    detailedMessage = `Created ${action.replace('CREATE_', '').toLowerCase()}`;
                }
            } else if (action.includes('UPDATE') || action.includes('EDIT')) {
                if (details.name) {
                    detailedMessage = `Updated ${action.replace('UPDATE_', '').replace('EDIT_', '').toLowerCase()}: "${details.name}"`;
                    if (details.changes) {
                        const changeFields = Object.keys(details.changes).join(', ');
                        detailedMessage += ` (Modified: ${changeFields})`;
                    }
                } else if (details.username) {
                    detailedMessage = `Updated user: "${details.username}"`;
                    if (details.changes) {
                        const changeFields = Object.keys(details.changes).join(', ');
                        detailedMessage += ` (Modified: ${changeFields})`;
                    }
                } else {
                    detailedMessage = `Updated ${action.replace('UPDATE_', '').replace('EDIT_', '').toLowerCase()}`;
                }
            } else if (action.includes('DELETE')) {
                if (details.name) {
                    detailedMessage = `Deleted ${action.replace('DELETE_', '').toLowerCase()}: "${details.name}"`;
                } else if (details.username) {
                    detailedMessage = `Deleted user: "${details.username}"`;
                } else {
                    detailedMessage = `Deleted ${action.replace('DELETE_', '').toLowerCase()}`;
                }
            } else if (action.includes('APPROVAL')) {
                if (action.includes('GRANTED')) {
                    detailedMessage = `Approved request for ${details.type} ${details.action} by ${details.requestedBy}`;
                } else if (action.includes('REJECTED')) {
                    detailedMessage = `Rejected request for ${details.type} ${details.action} by ${details.requestedBy}`;
                }
            } else if (action.includes('LOGIN')) {
                detailedMessage = `User logged in`;
            } else if (action.includes('LOGOUT')) {
                detailedMessage = `User logged out`;
            } else if (action.includes('EXPORT')) {
                detailedMessage = `Exported backup with ${details.recordCounts?.categories || 0} categories, ${details.recordCounts?.suppliers || 0} suppliers`;
            }
            
            const logEntry = {
                timestamp: new Date().toISOString(),
                user: currentUser || 'SYSTEM',
                action: action,
                description: detailedMessage || action,
                details: details,
                userAgent: navigator.userAgent,
                ip: 'client-side'
            };
            
            await db.collection(COLLECTIONS.AUDIT_LOGS).add(logEntry);
            console.log('Audit log created:', action, detailedMessage);
        } catch (error) {
            console.error('Error creating audit log:', error);
        }
    }

    // ========== AUDIT LOGS VIEW ==========
    async function showAuditLogs() {
        if (!canViewAuditLogs()) {
            alert('You do not have permission to view audit logs');
            return;
        }
        showView('auditLogs');
        await loadAuditLogs();
        renderAuditLogs();
    }

    async function loadAuditLogs() {
        try {
            const snapshot = await db.collection(COLLECTIONS.AUDIT_LOGS)
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get();
            auditLogs = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            totalAuditPages = Math.ceil(auditLogs.length / auditLogsPerPage) || 1;
            currentAuditPage = 1;
        } catch (error) {
            console.error('Error loading audit logs:', error);
            auditLogs = [];
            totalAuditPages = 1;
        }
    }

    function renderAuditLogs() {
        const container = document.getElementById('auditLogsContainer');
        const paginationDiv = document.getElementById('auditPagination');
        
        if (!container) return;
        
        if (!auditLogs || auditLogs.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 60px; color: #666;">üì≠ No audit logs found</div>';
            if (paginationDiv) paginationDiv.innerHTML = '';
            return;
        }

        const startIndex = (currentAuditPage - 1) * auditLogsPerPage;
        const endIndex = startIndex + auditLogsPerPage;
        const paginatedLogs = auditLogs.slice(startIndex, endIndex);

        let html = '<div style="margin-bottom: 20px;">';
        html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="font-size: 14px; color: #666;">Showing ${startIndex + 1} - ${Math.min(endIndex, auditLogs.length)} of ${auditLogs.length} logs</span>
                 </div>`;
        
        paginatedLogs.forEach(log => {
            const timestamp = log.timestamp ? new Date(log.timestamp) : new Date();
            const timeStr = timestamp.toLocaleString();
            const actionClass = log.action?.includes('DELETE') ? 'comp-bad' : 
                              log.action?.includes('CREATE') ? 'comp-ok' : 
                              log.action?.includes('UPDATE') ? 'btn-edit' : '';
            
            // Get description or create one from details
            const description = log.description || log.action || 'Action performed';
            
            // Format details for display
            let detailsHtml = '';
            if (log.details) {
                if (typeof log.details === 'object') {
                    const detailEntries = Object.entries(log.details)
                        .filter(([key]) => !['userAgent', 'ip'].includes(key))
                        .map(([key, value]) => {
                            if (key === 'changes' && typeof value === 'object') {
                                return `<div style="margin-top: 5px;"><strong>Changes:</strong> ${Object.keys(value).join(', ')}</div>`;
                            }
                            return `<div><strong>${key}:</strong> ${JSON.stringify(value)}</div>`;
                        }).join('');
                    if (detailEntries) {
                        detailsHtml = `<div class="audit-details">${detailEntries}</div>`;
                    }
                }
            }
            
            html += `<div class="audit-log-entry">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <span class="audit-timestamp">${timeStr}</span>
                                <span class="audit-user">üë§ ${log.user || 'SYSTEM'}</span>
                                <span style="padding:4px 12px; background:${actionClass || '#34495e'}; color:white; border-radius:20px; font-size:11px; font-weight:600;">${log.action || 'ACTION'}</span>
                            </div>
                        </div>
                        <div style="margin-top: 8px; font-size: 14px; color: #2c3e50; font-weight: 500;">
                            ${description}
                        </div>
                        ${detailsHtml}
                        <div style="margin-top: 5px; font-size: 11px; color: #999; font-family: monospace;">
                            ID: ${log.id}
                        </div>
                    </div>`;
        });
        html += '</div>';
        
        container.innerHTML = html;

        let paginationHtml = '';
        if (totalAuditPages > 1) {
            paginationHtml += '<div style="display: flex; gap: 10px; align-items: center;">';
            
            if (currentAuditPage > 1) {
                paginationHtml += `<button class="btn btn-pagination" onclick="changeAuditPage(${currentAuditPage - 1})">‚Üê Previous</button>`;
            }
            
            paginationHtml += `<span style="font-size: 14px;">Page ${currentAuditPage} of ${totalAuditPages}</span>`;
            
            if (currentAuditPage < totalAuditPages) {
                paginationHtml += `<button class="btn btn-pagination" onclick="changeAuditPage(${currentAuditPage + 1})">Next ‚Üí</button>`;
            }
            
            paginationHtml += '</div>';
        }
        
        if (paginationDiv) paginationDiv.innerHTML = paginationHtml;
    }

    function changeAuditPage(page) {
        currentAuditPage = page;
        renderAuditLogs();
    }

    // ========== DELETE AUDIT LOGS (SUPER ADMIN ONLY) ==========
    async function deleteAllAuditLogs() {
        if (!canDeleteAuditLogs()) {
            alert('Only super admin can delete audit logs');
            return;
        }

        if (confirm('‚ö†Ô∏è Delete ALL audit logs? This action CANNOT be undone.')) {
            try {
                showNotification('Deleting all audit logs...', 'info');
                
                const snapshot = await db.collection(COLLECTIONS.AUDIT_LOGS).get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                await logAudit('DELETE_ALL_AUDIT_LOGS', { 
                    count: snapshot.size,
                    deletedBy: getCurrentUser() 
                });
                
                await loadAuditLogs();
                renderAuditLogs();
                showNotification(`‚úÖ Deleted ${snapshot.size} audit logs successfully`, 'success');
            } catch (error) {
                console.error('Error deleting audit logs:', error);
                alert('Failed to delete audit logs: ' + error.message);
            }
        }
    }

    async function deleteLast50AuditLogs() {
        if (!canDeleteAuditLogs()) {
            alert('Only super admin can delete audit logs');
            return;
        }

        if (confirm('Delete the last 50 audit logs?')) {
            try {
                showNotification('Deleting last 50 audit logs...', 'info');
                
                const snapshot = await db.collection(COLLECTIONS.AUDIT_LOGS)
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                await logAudit('DELETE_LAST_50_AUDIT_LOGS', { 
                    count: snapshot.size,
                    deletedBy: getCurrentUser() 
                });
                
                await loadAuditLogs();
                renderAuditLogs();
                showNotification(`‚úÖ Deleted ${snapshot.size} audit logs successfully`, 'success');
            } catch (error) {
                console.error('Error deleting audit logs:', error);
                alert('Failed to delete audit logs: ' + error.message);
            }
        }
    }

    // ========== REASON MODAL FUNCTIONS ==========
    function openReasonModal(type, id, name, callback) {
        document.getElementById('reasonModalTitle').innerHTML = `State Reason for ${type} Deletion`;
        document.getElementById('pendingDeletionType').value = type;
        document.getElementById('pendingDeletionId').value = id;
        document.getElementById('pendingDeletionName').value = name;
        document.getElementById('deletionReason').value = '';
        pendingDeletionCallback = callback;
        document.getElementById('reasonModal').style.display = 'flex';
    }

    function closeReasonModal() {
        document.getElementById('reasonModal').style.display = 'none';
        document.getElementById('deletionReason').value = '';
        pendingDeletionCallback = null;
    }

    async function submitDeletionReason() {
        const reason = document.getElementById('deletionReason').value.trim();
        if (!reason) {
            alert('Please provide a reason for deletion');
            return;
        }

        const type = document.getElementById('pendingDeletionType').value;
        const id = document.getElementById('pendingDeletionId').value;
        const name = document.getElementById('pendingDeletionName').value;

        if (pendingDeletionCallback) {
            await pendingDeletionCallback(type, id, name, reason);
        }

        closeReasonModal();
    }

    // ========== APPROVAL REQUESTS WITH COUNT UPDATES ==========
    async function loadApprovalRequests() {
        try {
            console.log("Loading approval requests...");
            const snapshot = await db.collection(COLLECTIONS.APPROVALS)
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc')
                .get();
            
            approvalRequests = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            console.log(`Found ${approvalRequests.length} pending requests:`, approvalRequests);
            
            updateApprovalsButton();
            updateRequestCounts();
        } catch (error) {
            console.error('Error loading approval requests:', error);
            approvalRequests = [];
            updateRequestCounts();
        }
    }

    function updateRequestCounts() {
        // Update approval button count
        const navBtn = document.getElementById('approvalRequestsNavBtn');
        const countSpan = document.getElementById('approvalRequestCount');
        const requestsMgmtCount = document.getElementById('requestsManagementCount');
        const pendingCountSpan = document.getElementById('pendingApprovalCount');
        
        const currentUser = getUser(getCurrentUser());
        if (!currentUser) return;
        
        // Filter requests based on user role
        let visibleRequests = approvalRequests;
        if (currentUser.role === 'admin') {
            visibleRequests = approvalRequests.filter(req => req.requestedByRole === 'staff');
        } else if (currentUser.role === 'super admin') {
            // Super admin sees ALL pending requests
            visibleRequests = approvalRequests;
        }
        
        const count = visibleRequests.length;
        
        // Update all count badges
        if (countSpan) {
            countSpan.textContent = count;
            countSpan.className = `request-count-badge ${count === 0 ? 'request-count-zero' : ''}`;
        }
        
        if (requestsMgmtCount) {
            requestsMgmtCount.textContent = approvalRequests.length;
            requestsMgmtCount.className = `request-count-badge ${approvalRequests.length === 0 ? 'request-count-zero' : ''}`;
        }
        
        if (pendingCountSpan) {
            pendingCountSpan.textContent = count;
            pendingCountSpan.className = `request-count-badge ${count === 0 ? 'request-count-zero' : ''}`;
        }
        
        // Show/hide approval button based on count and permissions
        if (navBtn) {
            if (canApproveRequests() && count > 0) {
                navBtn.style.display = 'inline-block';
            } else {
                navBtn.style.display = 'none';
            }
        }
        
        // Show/hide requests management button for super admin
        const requestsBtn = document.getElementById('requestsManagementBtn');
        if (requestsBtn) {
            if (currentUser.role === 'super admin') {
                requestsBtn.style.display = 'inline-block';
            } else {
                requestsBtn.style.display = 'none';
            }
        }
    }

    async function createApprovalRequest(type, data, action, itemId, reason = null) {
        try {
            const currentUser = getUser(getCurrentUser());
            if (!currentUser) {
                alert('You must be logged in to create a request');
                return;
            }

            console.log(`Creating ${action} request for ${type}:`, data);
            
            const request = {
                type: type,
                action: action,
                itemId: itemId,
                requestedBy: getCurrentUser(),
                requestedByRole: currentUser.role,
                requestedData: data,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdDate: new Date().toISOString()
            };
            
            if (reason) {
                request.reason = reason;
            }
            
            const docRef = await db.collection(COLLECTIONS.APPROVALS).add(request);
            console.log(`Request created with ID: ${docRef.id}`);
            
            await loadApprovalRequests();
            
            updateApprovalsButton();
            updateRequestCounts();
            
            showNotification('‚úÖ Approval request submitted successfully', 'success');
        } catch (error) {
            console.error('Error creating approval request:', error);
            alert('Failed to create approval request: ' + error.message);
        }
    }

    function updateApprovalsButton() {
        const navBtn = document.getElementById('approvalRequestsNavBtn');
        if (!navBtn) return;
        
        const currentUser = getUser(getCurrentUser());
        if (!currentUser || !canApproveRequests()) {
            navBtn.style.display = 'none';
            return;
        }
        
        let visibleRequests = approvalRequests;
        if (currentUser.role === 'admin') {
            visibleRequests = approvalRequests.filter(req => req.requestedByRole === 'staff');
        } else if (currentUser.role === 'super admin') {
            visibleRequests = approvalRequests;
        }
        
        if (visibleRequests.length > 0) {
            navBtn.style.display = 'inline-block';
            navBtn.innerHTML = `‚úÖ APPROVALS <span id="approvalRequestCount" class="request-count-badge">${visibleRequests.length}</span>`;
            navBtn.style.background = '#e67e22';
        } else {
            navBtn.style.display = 'none';
        }

        const historyBtn = document.getElementById('approvalHistoryNavBtn');
        if (historyBtn && getCurrentUser()) {
            // Super admin should NOT see My Requests button
            if (currentUser && currentUser.role === 'super admin') {
                historyBtn.style.display = 'none';
            } else {
                historyBtn.style.display = 'inline-block';
            }
        }
        
        updateRequestCounts();
    }

    async function openApprovalRequestsModal() {
        await loadApprovalRequests();
        
        const container = document.getElementById('pendingApprovalsList');
        if (!container) return;
        
        const currentUser = getUser(getCurrentUser());
        
        if (!canApproveRequests()) {
            alert('You do not have permission to approve requests');
            return;
        }
        
        if (approvalRequests.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">‚úÖ No pending approval requests</div>';
        } else {
            let html = '';
            
            let visibleRequests = approvalRequests;
            if (currentUser.role === 'admin') {
                visibleRequests = approvalRequests.filter(req => req.requestedByRole === 'staff');
            } else if (currentUser.role === 'super admin') {
                visibleRequests = approvalRequests;
            }
            
            if (visibleRequests.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">‚úÖ No pending approval requests for your role</div>';
            } else {
                visibleRequests.forEach(req => {
                    const created = req.createdDate ? new Date(req.createdDate) : new Date();
                    const timeStr = created.toLocaleString();
                    
                    const actionColor = req.action === 'delete' ? '#e74c3c' : 
                                      req.action === 'edit' ? '#f39c12' : '#3498db';
                    
                    const itemName = req.requestedData?.name || 
                                   (req.type === 'category' ? 'Category' : 'Supplier') + 
                                   (req.itemId ? ` (${req.itemId.substring(0, 6)}...)` : '');
                    
                    const reason = req.reason || 'No reason provided';
                    
                    html += `<div class="approval-request-item" style="border-left-color: ${actionColor}; border-left-width: 6px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                    <span style="font-weight: bold; color: ${actionColor}; text-transform: uppercase; background: ${actionColor}20; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
                                        ‚è≥ ${req.action?.toUpperCase() || 'ACTION'} - ${req.type?.toUpperCase() || 'ITEM'}
                                    </span>
                                    <span style="font-size: 11px; color: #666; background: #f0f0f0; padding: 4px 8px; border-radius: 12px;">
                                        ${timeStr}
                                    </span>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                                        <div style="font-size: 11px; color: #666; margin-bottom: 4px;">üë§ REQUESTED BY</div>
                                        <div style="font-weight: 600; font-size: 14px;">${req.requestedBy || 'Unknown'}</div>
                                        <div style="font-size: 11px; color: #666; margin-top: 4px;">
                                            <span class="role-badge" style="background: ${req.requestedByRole === 'super admin' ? '#9b59b6' : req.requestedByRole === 'admin' ? '#3498db' : '#2ecc71'}; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block;">
                                                ${req.requestedByRole || 'staff'}
                                            </span>
                                        </div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                                        <div style="font-size: 11px; color: #666; margin-bottom: 4px;">üì¶ ITEM DETAILS</div>
                                        <div style="font-weight: 600; font-size: 14px;">${itemName}</div>
                                        <div style="font-size: 11px; color: #666; margin-top: 4px;">
                                            ID: ${req.itemId?.substring(0, 8) || 'N/A'}
                                        </div>
                                    </div>
                                </div>
                                
                                ${req.reason ? `
                                <div style="background: #fff8e7; border-left: 4px solid #f39c12; padding: 12px; margin-bottom: 15px; border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <span style="background: #f39c12; color: white; padding: 2px 10px; border-radius: 30px; font-size: 10px; font-weight: 700;">REASON</span>
                                        <span style="font-size: 11px; color: #666;">Provided by ${req.requestedBy}</span>
                                    </div>
                                    <p style="margin: 0; color: #2c3e50; font-size: 13px;">${req.reason}</p>
                                </div>
                                ` : ''}
                                
                                <div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                        <span style="background: #34495e; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px;">DATA</span>
                                        Request Details
                                    </div>
                                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; font-size: 11px; overflow-x: auto; margin: 0; max-height: 150px; white-space: pre-wrap; word-wrap: break-word;">
${JSON.stringify(req.requestedData, null, 2)}</pre>
                                </div>
                                
                                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
                                    <button class="btn-approve" style="background: #27ae60; padding: 8px 20px; font-size: 13px; font-weight: bold;" onclick="openApprovalActionModal('${req.id}')">
                                        ‚úì REVIEW REQUEST
                                    </button>
                                    ${isCurrentUserSuperAdmin() ? 
                                        `<button class="btn-del" style="background: #95a5a6; padding: 8px 16px;" onclick="deleteApprovalRequest('${req.id}')">
                                            üóëÔ∏è DELETE
                                        </button>` : ''
                                    }
                                </div>
                            </div>`;
                });
                container.innerHTML = html;
            }
        }
        
        document.getElementById('approvalRequestsModal').style.display = 'flex';
    }

    async function openApprovalActionModal(requestId) {
        const request = approvalRequests.find(r => r.id === requestId);
        if (!request) return;
        
        localStorage.setItem('currentApprovalRequestId', requestId);
        
        const detailsDiv = document.getElementById('approvalActionDetails');
        let detailsHtml = `<p><strong>Request Type:</strong> ${request.action} ${request.type}</p>`;
        detailsHtml += `<p><strong>Requested By:</strong> ${request.requestedBy} (${request.requestedByRole})</p>`;
        detailsHtml += `<p><strong>Date:</strong> ${new Date(request.createdAt).toLocaleString()}</p>`;
        detailsHtml += `<p><strong>Item ID:</strong> ${request.itemId || 'N/A'}</p>`;
        
        if (request.reason) {
            detailsHtml += `<div style="margin-top: 10px; padding: 10px; background: #fff8e7; border-radius: 8px;">
                <strong style="color: #f39c12;">Reason:</strong>
                <p style="margin: 5px 0 0 0; font-size: 13px;">${request.reason}</p>
            </div>`;
        }
        
        detailsHtml += `<div style="margin-top: 15px;"><strong>Request Data:</strong><pre style="background: #fff; padding: 10px; border-radius: 5px; font-size: 12px; overflow-x: auto;">${JSON.stringify(request.requestedData, null, 2)}</pre></div>`;
        
        detailsDiv.innerHTML = detailsHtml;
        document.getElementById('approvalActionTitle').innerHTML = `Review ${request.action} Request`;
        document.getElementById('approvalActionModal').style.display = 'flex';
    }

    async function confirmApproval(approved) {
        const requestId = localStorage.getItem('currentApprovalRequestId');
        
        if (!requestId) {
            alert('No request selected');
            return;
        }

        try {
            const docRef = db.collection(COLLECTIONS.APPROVALS).doc(requestId);
            const doc = await docRef.get();
            
            if (!doc.exists) {
                alert('Request not found. It may have been already processed.');
                localStorage.removeItem('currentApprovalRequestId');
                return;
            }

            const request = { id: doc.id, ...doc.data() };
            
            if (approved) {
                if (request.action === 'delete') {
                    if (request.type === 'category') {
                        await db.collection(COLLECTIONS.CATEGORIES).doc(request.itemId).delete();
                        showNotification('Category deleted', 'success');
                    } else if (request.type === 'supplier') {
                        await db.collection(COLLECTIONS.SUPPLIERS).doc(request.itemId).delete();
                        showNotification('Supplier deleted', 'success');
                    } else if (request.type === 'link') {
                        await db.collection(COLLECTIONS.LINKS).doc(request.itemId).delete();
                        showNotification('Link deleted', 'success');
                    } else if (request.type === 'user') {
                        await db.collection(COLLECTIONS.USERS).doc(request.itemId).delete();
                        showNotification('User deleted', 'success');
                    }
                } else if (request.action === 'edit') {
                    if (request.type === 'category') {
                        await db.collection(COLLECTIONS.CATEGORIES).doc(request.itemId).update(request.requestedData);
                        showNotification('Category updated', 'success');
                    } else if (request.type === 'supplier') {
                        await db.collection(COLLECTIONS.SUPPLIERS).doc(request.itemId).update(request.requestedData);
                        showNotification('Supplier updated', 'success');
                    } else if (request.type === 'link') {
                        await db.collection(COLLECTIONS.LINKS).doc(request.itemId).update(request.requestedData);
                        showNotification('Link updated', 'success');
                    } else if (request.type === 'user') {
                        await db.collection(COLLECTIONS.USERS).doc(request.itemId).update(request.requestedData);
                        showNotification('User updated', 'success');
                    }
                } else if (request.action === 'add') {
                    if (request.type === 'user') {
                        await db.collection(COLLECTIONS.USERS).add(request.requestedData);
                        showNotification('User added', 'success');
                    }
                }
            }

            await docRef.update({
                status: approved ? 'approved' : 'rejected',
                reviewedBy: getCurrentUser(),
                reviewedAt: new Date().toISOString()
            });

            await logAudit(approved ? 'APPROVAL_GRANTED' : 'APPROVAL_REJECTED', {
                requestId: requestId,
                type: request.type,
                action: request.action,
                requestedBy: request.requestedBy,
                reason: request.reason
            });

            showNotification(`Request ${approved ? 'approved' : 'rejected'} successfully`, 'success');
            
            document.getElementById('approvalActionModal').style.display = 'none';
            document.getElementById('approvalRequestsModal').style.display = 'none';
            
            const modal = document.getElementById('requestsManagementModal');
            if (modal) modal.remove();
            
            await loadAllData(true);
            await loadApprovalRequests();
            
            // Only load user approval history if not super admin
            const currentUser = getUser(getCurrentUser());
            if (currentUser && currentUser.role !== 'super admin') {
                await loadUserApprovalHistory();
            }
            
            renderCategories();
            applyRoleBasedUI();
            
            if (document.getElementById('categoryPageView').style.display === 'block') {
                const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
                renderSuppliersTable(categorySuppliers);
            }

        } catch (error) {
            console.error('Error:', error);
            alert('Failed to process request: ' + error.message);
        } finally {
            localStorage.removeItem('currentApprovalRequestId');
        }
    }

    window.approveRequestNow = async function(requestId) {
        localStorage.setItem('currentApprovalRequestId', requestId);
        await confirmApproval(true);
        openRequestsManagement();
    };

    window.rejectRequestNow = async function(requestId) {
        localStorage.setItem('currentApprovalRequestId', requestId);
        await confirmApproval(false);
        openRequestsManagement();
    };

    window.deleteRequestNow = async function(requestId) {
        if (!isCurrentUserSuperAdmin()) {
            alert('Only super admin can delete approval requests');
            return;
        }
        
        if (confirm('Delete this approval request permanently?')) {
            try {
                await db.collection(COLLECTIONS.APPROVALS).doc(requestId).delete();
                await loadApprovalRequests();
                showNotification('Approval request deleted', 'success');
            } catch (error) {
                console.error('Error deleting approval request:', error);
                alert('Failed to delete approval request: ' + error.message);
            }
        }
    };

    async function deleteApprovalRequest(requestId) {
        if (!isCurrentUserSuperAdmin()) {
            alert('Only super admin can delete approval requests');
            return;
        }
        
        if (confirm('Delete this approval request permanently?')) {
            try {
                await db.collection(COLLECTIONS.APPROVALS).doc(requestId).delete();
                await loadApprovalRequests();
                openApprovalRequestsModal();
                showNotification('Approval request deleted', 'success');
            } catch (error) {
                console.error('Error deleting approval request:', error);
                alert('Failed to delete approval request: ' + error.message);
            }
        }
    }

    function closeApprovalRequestsModal() {
        document.getElementById('approvalRequestsModal').style.display = 'none';
    }

    function closeApprovalActionModal() {
        document.getElementById('approvalActionModal').style.display = 'none';
        localStorage.removeItem('currentApprovalRequestId');
    }

    // ========== COMPLIANCE TRACKING ==========
    function updateComplianceUI() {
        const tpinChecked = document.getElementById('complianceTpin')?.checked || false;
        const napsaChecked = document.getElementById('complianceNapsa')?.checked || false;
        const zraChecked = document.getElementById('complianceZra')?.checked || false;
        const zppaChecked = document.getElementById('complianceZppa')?.checked || false;
        
        const statusElements = {
            tpin: document.getElementById('complianceTpinStatus'),
            napsa: document.getElementById('complianceNapsaStatus'),
            zra: document.getElementById('complianceZraStatus'),
            zppa: document.getElementById('complianceZppaStatus')
        };
        
        if (statusElements.tpin) {
            statusElements.tpin.textContent = tpinChecked ? 'Compliant' : 'Not Compliant';
            statusElements.tpin.style.background = tpinChecked ? '#2ecc71' : '#e74c3c';
        }
        if (statusElements.napsa) {
            statusElements.napsa.textContent = napsaChecked ? 'Compliant' : 'Not Compliant';
            statusElements.napsa.style.background = napsaChecked ? '#2ecc71' : '#e74c3c';
        }
        if (statusElements.zra) {
            statusElements.zra.textContent = zraChecked ? 'Compliant' : 'Not Compliant';
            statusElements.zra.style.background = zraChecked ? '#2ecc71' : '#e74c3c';
        }
        if (statusElements.zppa) {
            statusElements.zppa.textContent = zppaChecked ? 'Compliant' : 'Not Compliant';
            statusElements.zppa.style.background = zppaChecked ? '#2ecc71' : '#e74c3c';
        }
        
        const totalChecked = [tpinChecked, napsaChecked, zraChecked, zppaChecked].filter(Boolean).length;
        const percent = (totalChecked / 4) * 100;
        
        const percentEl = document.getElementById('overallCompliancePercent');
        const barEl = document.getElementById('overallComplianceBar');
        
        if (percentEl) percentEl.textContent = `${Math.round(percent)}%`;
        if (barEl) {
            barEl.style.width = `${percent}%`;
            barEl.className = `compliance-bar-fill ${percent >= 70 ? 'good' : percent >= 40 ? 'expiring' : 'poor'}`;
        }
    }

    // ========== DOCUMENT UPLOAD ==========
    function handleDocumentUpload(docType, input) {
        const file = input.files[0];
        if (!file) return;
        
        if (file.size > 3 * 1024 * 1024) {
            alert(`File size exceeds 3MB limit for ${docType.toUpperCase()} document`);
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            uploadedDocuments[docType] = {
                name: file.name,
                type: file.type,
                size: file.size,
                data: e.target.result,
                uploadedAt: new Date().toISOString()
            };
            
            const previewEl = document.getElementById(`${docType}DocPreview`);
            if (previewEl) {
                previewEl.innerHTML = `<span style="color: var(--primary-green);">‚úì ${file.name.substring(0, 20)}${file.name.length > 20 ? '...' : ''}</span>`;
            }
            
            if (docType === 'tpin') document.getElementById('complianceTpin').checked = true;
            if (docType === 'napsa') document.getElementById('complianceNapsa').checked = true;
            if (docType === 'zra') document.getElementById('complianceZra').checked = true;
            if (docType === 'zppa') document.getElementById('complianceZppa').checked = true;
            
            updateComplianceUI();
        };
        reader.readAsDataURL(file);
    }

    // ========== FIREBASE DATA FUNCTIONS ==========
    async function ensureDefaultUsers() {
        try {
            const usersSnapshot = await db.collection(COLLECTIONS.USERS).get();
            if (usersSnapshot.empty) {
                const defaultUsers = [
                    { 
                        username: "JOSEPH", 
                        password: "RIGHTJOSEPH", 
                        role: "super admin", 
                        enabled: true, 
                        nrc: "123456/78/1", 
                        email: "zulujosephp@gmail.com", 
                        phone: "+260973031254", 
                        institution: "ZAMCOM", 
                        position: "Procurement Lead", 
                        createdAt: new Date().toISOString(),
                        lastActive: null
                    },
                    { 
                        username: "CHISHALA", 
                        password: "RIGHTCHISHALA", 
                        role: "staff", 
                        enabled: true, 
                        nrc: "998877/66/5", 
                        email: "chishala@zamcom.zm", 
                        phone: "+260977123456", 
                        institution: "ZAMCOM", 
                        position: "Procurement Officer", 
                        createdAt: new Date().toISOString(),
                        lastActive: null
                    }
                ];
                for (const user of defaultUsers) {
                    await db.collection(COLLECTIONS.USERS).add(user);
                }
                await logAudit('SYSTEM_INIT', { action: 'Default users created' });
                console.log("Default users created");
            }
        } catch (error) { 
            console.error("Error ensuring users:", error); 
        }
    }

    async function getAllUsers(forceRefresh = false) {
    try {
        userAccounts = await getCachedData('users', forceRefresh);
        console.log('Loaded users with documents:', userAccounts.map(u => ({
            username: u.username,
            hasDocs: !!u.documents,
            docKeys: u.documents ? Object.keys(u.documents) : []
        })));
    } catch (error) { 
        console.error("Error getting users:", error); 
    }
}

    async function loadAllData(forceRefresh = false) {
        try {
            const [catData, supData, linkData] = await Promise.all([
                getCachedData('categories', forceRefresh),
                getCachedData('suppliers', forceRefresh),
                getCachedData('links', forceRefresh)
            ]);
            
            categories = catData;
            suppliers = supData;
            links = linkData;
            
            console.log("‚úÖ Data loaded from " + (forceRefresh ? 'Firestore' : 'cache'));
        } catch (error) { 
            console.error("Error loading data:", error); 
        }
    }

    async function initializeFirestoreCollections() {
        try {
            const catSnap = await db.collection(COLLECTIONS.CATEGORIES).limit(1).get();
            if (catSnap.empty) {
                const defaultCategories = [
                    "Stationery & Office Supplies",
                    "ICT Equipment & Services",
                    "Cleaning Services & Materials",
                    "Catering & Refreshments",
                    "Furniture & Furnishings",
                    "Printing & Publishing",
                    "Construction & Maintenance",
                    "Transport & Logistics",
                    "Consultancy Services",
                    "Security Services"
                ];
                for (const name of defaultCategories) {
                    await db.collection(COLLECTIONS.CATEGORIES).add({ 
                        name, 
                        createdAt: new Date().toISOString() 
                    });
                }
                await logAudit('SYSTEM_INIT', { action: 'Default categories created' });
                console.log("Default categories created");
            }
            
            const linkSnap = await db.collection(COLLECTIONS.LINKS).limit(1).get();
            if (linkSnap.empty) {
                await db.collection(COLLECTIONS.LINKS).add({ 
                    institution: "Public Procurement Authority", 
                    website: "https://www.ppa.org.zm", 
                    email: "info@ppa.org.zm", 
                    createdAt: new Date().toISOString() 
                });
                await db.collection(COLLECTIONS.LINKS).add({ 
                    institution: "ZPPA", 
                    website: "https://www.zppa.org.zm", 
                    email: "director@zppa.org.zm", 
                    createdAt: new Date().toISOString() 
                });
                await logAudit('SYSTEM_INIT', { action: 'Default links created' });
                console.log("Default links created");
            }
        } catch (error) { 
            console.error("Error initializing collections:", error); 
        }
    }

    // ========== LOGIN / AUTH FUNCTIONS ==========
    function togglePassword() {
        const pField = document.getElementById('passIn');
        if (pField) pField.type = pField.type === "password" ? "text" : "password";
    }

    // Update the beginning of handleLogin function
async function handleLogin() {
        const username = document.getElementById('userIn').value.toUpperCase().trim();
        const password = document.getElementById('passIn').value.trim();
        
        if (!username || !password) { 
            alert("Username and password required."); 
            return; 
        }

        try {
            await getAllUsers(true);
            const user = userAccounts.find(u => u.username === username);
            
            if (user && user.password === password && user.enabled) {
                
                localStorage.setItem('logged_user', username);
                localStorage.setItem('last_login', new Date().toDateString());
                
                if (isSystemLocked()) {
                    if (!canAccessLockedSystem()) {
                        localStorage.removeItem('logged_user');
                        localStorage.removeItem('last_login');
                        alert("System is currently locked. Operating hours: 07:30 - 16:50 CAT.\nOnly Super Admin and Admin users have after-hours access.");
                        return;
                    } else {
                        document.getElementById('timeWarning').style.display = 'block';
                        setTimeout(() => {
                            document.getElementById('timeWarning').style.display = 'none';
                        }, 5000);
                    }
                }

                if (user.id) {
                    await db.collection(COLLECTIONS.USERS).doc(user.id).update({
                        lastActive: new Date().toISOString()
                    });
                }

                await getAllUsers(true);
                await loadAllData(true);
                await initializeFirestoreCollections();
                await loadApprovalRequests();
                
                await logAudit('USER_LOGIN', { 
                    username: username,
                    role: user.role,
                    locked: isSystemLocked()
                });

                document.getElementById('loginOverlay').style.display = 'none';
                hideLoadingSpinner();

                updateGreeting();
                updateUserDisplay();
                applyRoleBasedUI();
                showView('home');
                startSessionHeartbeat();
                showNotification(`Welcome, ${username} (${user.role})`, 'success');
            } else {
                if (user && !user.enabled) {
                    alert("Your account has been disabled. Please contact super admin.");
                } else {
                    alert("Invalid username or password!");
                }
            }
        } catch (error) {
            console.error("Login error:", error);
            alert("Login failed. Please try again.");
        }
    }


    // ========== LOGOUT WITH CLEANUP ==========
    function logout() {
    const username = getCurrentUser();
    logAudit('USER_LOGOUT', { username: username });
    
    localStorage.removeItem('logged_user');
    localStorage.removeItem('last_login');
    
    // Close change password modal if open
    const changePwModal = document.getElementById('changePasswordModal');
    if (changePwModal) changePwModal.style.display = 'none';
    
    if (sessionHeartbeat) {
        clearInterval(sessionHeartbeat);
        sessionHeartbeat = null;
    }

    ['homeView','categoryPageView','aboutView','contactView','linksView','auditLogsView','userApprovalHistoryView'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });

    document.getElementById('loginOverlay').style.display = 'flex';
    document.getElementById('userIn').value = '';
    document.getElementById('passIn').value = '';
    document.getElementById('timeWarning').style.display = 'none';
}

    // ========== ROLE BASED UI ==========
    function applyRoleBasedUI() {
        const user = getUser(getCurrentUser());
        if (!user) return;

        const isSuper = (user.role === 'super admin');
        const isAdmin = (user.role === 'admin');
        const isStaff = (user.role === 'staff');

        document.querySelectorAll('.exclusive-super').forEach(el => {
            el.style.display = isSuper ? 'inline-block' : 'none';
        });

        // User Management Button - Admin and Super Admin only
        document.getElementById('userMgmtBtn').style.display = (isSuper || isAdmin) ? 'inline-block' : 'none';
        
        // Sessions Button - All roles can view
        document.getElementById('sessionsBtn').style.display = canViewSessions() ? 'inline-block' : 'none';
        
        // Approvals Button - Admin and Super Admin only (will be shown/hidden by count)
        const approvalsBtn = document.getElementById('approvalRequestsNavBtn');
        if (approvalsBtn) {
            if (canApproveRequests()) {
                let visibleRequests = approvalRequests;
                if (user.role === 'admin') {
                    visibleRequests = approvalRequests.filter(req => req.requestedByRole === 'staff');
                } else if (user.role === 'super admin') {
                    visibleRequests = approvalRequests;
                }
                if (visibleRequests.length > 0) {
                    approvalsBtn.style.display = 'inline-block';
                } else {
                    approvalsBtn.style.display = 'none';
                }
            } else {
                approvalsBtn.style.display = 'none';
            }
        }

        // My Requests Button - Staff and Admin only (NOT super admin)
        const historyBtn = document.getElementById('approvalHistoryNavBtn');
        if (historyBtn) {
            if (getCurrentUser() && (isStaff || isAdmin)) {
                historyBtn.style.display = 'inline-block';
            } else {
                historyBtn.style.display = 'none';
            }
        }

        // Requests Management - Super Admin only
        const requestsBtn = document.getElementById('requestsManagementBtn');
        if (requestsBtn) {
            requestsBtn.style.display = isSuper ? 'inline-block' : 'none';
        }

        // Category Controls
        const newCategoryBtn = document.getElementById('newCategoryBtn');
        if (newCategoryBtn) {
            newCategoryBtn.style.display = canCreateCategory() ? 'inline-block' : 'none';
        }

        // Category Page Buttons
        const categoryNewCategoryBtn = document.getElementById('categoryNewCategoryBtn');
        if (categoryNewCategoryBtn) {
            categoryNewCategoryBtn.style.display = canCreateCategory() ? 'inline-block' : 'none';
        }

        const categoryNewSupplierBtn = document.getElementById('categoryNewSupplierBtn');
        if (categoryNewSupplierBtn) {
            categoryNewSupplierBtn.style.display = canCreateSupplier() ? 'inline-block' : 'none';
        }

        const editCategoryBtn = document.getElementById('editCategoryBtn');
        if (editCategoryBtn) {
            editCategoryBtn.style.display = canEditCategory() ? 'inline-block' : 'none';
        }

        // Supplier Controls
        const newSupplierBtn = document.getElementById('newSupplierBtn');
        if (newSupplierBtn) {
            newSupplierBtn.style.display = canCreateSupplier() ? 'inline-block' : 'none';
        }

        // Link Controls
        const addLinkBtn = document.getElementById('addLinkBtn');
        if (addLinkBtn) {
            addLinkBtn.style.display = canCreateLink() ? 'inline-block' : 'none';
        }

        // User Management Modal - Admin and Super Admin can view/edit, Staff cannot
        if (!isSuper && !isAdmin) {
            const userMgmtModal = document.getElementById('userManagementModal');
            if (userMgmtModal && userMgmtModal.style.display === 'flex') {
                userMgmtModal.style.display = 'none';
            }
        }

        renderCategories();
        renderLinks();
        updateRequestCounts();
    }

    // ========== SESSION HEARTBEAT ==========
    function startSessionHeartbeat() {
        if (sessionHeartbeat) clearInterval(sessionHeartbeat);
        sessionHeartbeat = setInterval(async () => {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const user = getUser(currentUser);
            if (user && user.id) {
                try {
                    await db.collection(COLLECTIONS.USERS).doc(user.id).update({
                        lastActive: new Date().toISOString()
                    });
                    await getAllUsers(true);
                } catch (error) {
                    console.error("Heartbeat error:", error);
                }
            }
        }, 30000);
    }

    // ========== CATEGORY MANAGEMENT ==========
    function openCategoryModal() {
        if (!canCreateCategory() && !canEditCategory()) {
            alert('You do not have permission to create/edit categories');
            return;
        }
        
        const isEdit = document.getElementById('editingCategoryId').value;
        document.getElementById('categoryModalTitle').innerHTML = isEdit ? '‚úèÔ∏è Edit Category' : '‚ûï Add New Category';
        document.getElementById('categoryModalSaveBtn').innerHTML = isEdit ? 'Update Category' : 'Create Category';
        document.getElementById('categoryNameInput').value = isEdit ? categories.find(c => c.id === document.getElementById('editingCategoryId').value)?.name || '' : '';
        document.getElementById('categoryModal').style.display = 'flex';
    }

    function closeCategoryModal() {
        document.getElementById('categoryModal').style.display = 'none';
        document.getElementById('editingCategoryId').value = '';
        document.getElementById('categoryNameInput').value = '';
    }

    function editCurrentCategory() {
        if (!canEditCategory()) {
            alert('You do not have permission to edit categories');
            return;
        }
        
        const category = categories.find(c => c.name === currentCategory);
        if (!category) return;
        
        document.getElementById('editingCategoryId').value = category.id;
        openCategoryModal();
    }

    async function saveNewCategory() {
        if (!canCreateCategory() && !canEditCategory()) {
            alert('You do not have permission to create/edit categories');
            return;
        }

        const name = document.getElementById('categoryNameInput').value.trim();
        const editingId = document.getElementById('editingCategoryId').value;
        
        if (!name) {
            alert('Category name is required');
            return;
        }

        try {
            if (editingId) {
                // Edit mode
                const oldCategory = categories.find(c => c.id === editingId);
                
                if (canEditCategoryWithoutApproval()) {
                    // Super Admin - Edit directly
                    await db.collection(COLLECTIONS.CATEGORIES).doc(editingId).update({
                        name: name,
                        lastModifiedBy: getCurrentUser(),
                        lastModifiedAt: new Date().toISOString()
                    });

                    await logAudit('UPDATE_CATEGORY', { 
                        categoryId: editingId,
                        oldName: oldCategory?.name,
                        newName: name,
                        updatedBy: getCurrentUser()
                    });

                    await loadAllData(true);
                    renderCategories();
                    closeCategoryModal();
                    showNotification(`Category updated to "${name}" successfully`, 'success');
                    populateCategoryDropdown();
                    
                    if (document.getElementById('categoryPageView').style.display === 'block') {
                        document.getElementById('categoryTitle').textContent = name;
                    }
                } else {
                    // Admin or Staff - Create approval request
                    await createApprovalRequest('category', { name: name }, 'edit', editingId);
                    closeCategoryModal();
                    showNotification('Category edit request submitted for approval', 'info');
                }
            } else {
                // Add mode
                if (canCreateCategoryWithoutApproval()) {
                    // Admin or Super Admin - Save directly
                    await db.collection(COLLECTIONS.CATEGORIES).add({
                        name: name,
                        createdAt: new Date().toISOString(),
                        createdBy: getCurrentUser()
                    });

                    await logAudit('CREATE_CATEGORY', { 
                        name: name,
                        createdBy: getCurrentUser()
                    });

                    await loadAllData(true);
                    renderCategories();
                    closeCategoryModal();
                    showNotification(`Category "${name}" created successfully`, 'success');
                    populateCategoryDropdown();
                } else {
                    // Staff - Create approval request
                    await createApprovalRequest('category', { name: name }, 'add', null);
                    closeCategoryModal();
                    showNotification('Category creation request submitted for approval', 'info');
                }
            }
        } catch (error) {
            console.error('Error saving category:', error);
            alert('Failed to save category: ' + error.message);
        }
    }

    async function deleteCategory(categoryId) {
        if (!canDeleteCategory()) {
            alert('You do not have permission to delete categories');
            return;
        }

        const category = categories.find(c => c.id === categoryId);
        if (!category) return;

        if (canDeleteCategoryWithoutApproval()) {
            // Super Admin - Delete directly
            if (confirm(`Delete category "${category.name}"?`)) {
                try {
                    await db.collection(COLLECTIONS.CATEGORIES).doc(categoryId).delete();
                    await logAudit('DELETE_CATEGORY', { 
                        categoryId, 
                        name: category.name,
                        deletedBy: getCurrentUser() 
                    });
                    await loadAllData(true);
                    renderCategories();
                    showNotification('Category deleted', 'success');
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to delete');
                }
            }
        } else if (requiresReasonForCategoryDeletion()) {
            // Admin or Staff - Require reason and create approval request
            openReasonModal('category', categoryId, category.name, async (type, id, name, reason) => {
                await createApprovalRequest('category', { name: name }, 'delete', id, reason);
                showNotification('Delete request submitted for approval', 'info');
            });
        }
    }

    function renderCategories() {
        const categoryGrid = document.getElementById('categoryGrid');
        if (!categoryGrid) return;

        const user = getUser(getCurrentUser());

        if (!categories || categories.length === 0) {
            categoryGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6b9080; padding: 60px; font-size: 1.2rem;">No categories yet ‚Äî click "New Category" to add your first category.</p>';
            return;
        }

        const categoryImagePath = './images/mainlogo3.png';
        
        categoryGrid.innerHTML = categories.map((cat, index) => {
            const supplierCount = suppliers.filter(s => s.category === cat.name).length;
            const fallbackColor = `hsl(${(index * 45) % 360}, 70%, 55%)`;
            
            const showDelete = canDeleteCategory() && canDeleteCategoryWithoutApproval();
            
            return `
                <div class="grid-item" onclick="openCategoryPage('${cat.id}')">
                    <div class="category-image-wrapper">
                        <img src="${categoryImagePath}" alt="${cat.name}" loading="lazy"
                             onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'category-fallback\' style=\'background: radial-gradient(circle at 30% 30%, ${fallbackColor}, #2c6b2c);\'>${cat.name.charAt(0)}</div>';">
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 18px 12px;">
                        <span style="font-weight: 600; font-size: 1rem; color: #1e3b37; margin-bottom: 8px;">${cat.name}</span>
                        <span style="background: #173979; color: white; padding: 6px 16px; border-radius: 40px; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 4px 8px rgba(76, 175, 80, 0.2);">
                            ${supplierCount} ${supplierCount === 1 ? 'Supplier' : 'Suppliers'}
                        </span>
                    </div>
                    ${showDelete ? `<button class="btn-del" onclick="event.stopPropagation(); deleteCategory('${cat.id}')">Delete</button>` : ''}
                    ${!showDelete && canDeleteCategory() ? `<button class="btn-request-delete" onclick="event.stopPropagation(); deleteCategory('${cat.id}')">Request Delete</button>` : ''}
                </div>
            `;
        }).join('');
    }

    // ========== SUPPLIER MANAGEMENT ==========
    function openSupplierModal() {
        if (!canCreateSupplier()) {
            alert('You do not have permission to add suppliers');
            return;
        }

        document.getElementById('supplierModalTitle').innerHTML = '‚ûï Add New Supplier';
        document.getElementById('supplierName').value = '';
        document.getElementById('supplierSpecialization').value = '';
        document.getElementById('supplierPhone').value = '';
        document.getElementById('supplierTpin').value = '';
        document.getElementById('supplierEmail').value = '';
        document.getElementById('supplierAddress').value = '';
        document.getElementById('editingSupplierId').value = '';
        document.getElementById('supplierActionType').value = 'add';
        
        document.getElementById('star3').checked = true;
        
        document.getElementById('complianceTpin').checked = false;
        document.getElementById('complianceNapsa').checked = false;
        document.getElementById('complianceZra').checked = false;
        document.getElementById('complianceZppa').checked = false;
        
        document.getElementById('supplierRenewalMonth').value = '11';
        
        uploadedDocuments = { tpin: null, napsa: null, zra: null, zppa: null };
        ['tpin', 'napsa', 'zra', 'zppa'].forEach(type => {
            const previewEl = document.getElementById(`${type}DocPreview`);
            if (previewEl) previewEl.innerHTML = '';
        });
        
        updateComplianceUI();
        
        populateCategoryDropdown();
        
        document.getElementById('supplierModal').style.display = 'flex';
    }

    function populateCategoryDropdown() {
        const select = document.getElementById('supplierCategory');
        if (!select) return;
        
        select.innerHTML = '<option value="">Select Category</option>';
        categories.forEach(cat => {
            select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
        });
    }

    function closeSupplierModal() {
        document.getElementById('supplierModal').style.display = 'none';
    }

    async function saveSupplier() {
        if (!canCreateSupplier() && !canEditSupplier()) {
            alert('You do not have permission to save suppliers');
            return;
        }

        const name = document.getElementById('supplierName').value.trim();
        const phone = document.getElementById('supplierPhone').value.trim();
        const category = document.getElementById('supplierCategory').value;
        
        if (!name || !phone || !category) {
            alert('Supplier Name, Phone Number, and Category are required');
            return;
        }

        let rating = 3;
        const ratingInputs = document.querySelectorAll('input[name="rating"]');
        for (let input of ratingInputs) {
            if (input.checked) {
                rating = parseInt(input.value);
                break;
            }
        }

        const renewalYear = document.getElementById('supplierRenewalYear').value;
        const renewalMonth = document.getElementById('supplierRenewalMonth').value;
        const renewalDate = new Date(renewalYear, parseInt(renewalMonth), 31).toISOString();

        const compliance = {
            tpin: document.getElementById('complianceTpin').checked ? 'yes' : 'no',
            napsa: document.getElementById('complianceNapsa').checked ? 'yes' : 'no',
            zra: document.getElementById('complianceZra').checked ? 'yes' : 'no',
            zppa: document.getElementById('complianceZppa').checked ? 'yes' : 'no'
        };

        const documents = [];
        for (let [type, doc] of Object.entries(uploadedDocuments)) {
            if (doc) {
                documents.push({
                    type: type,
                    name: doc.name,
                    size: doc.size,
                    uploadedAt: doc.uploadedAt,
                    data: doc.data
                });
            }
        }

        const supplierData = {
            name: name,
            specialization: document.getElementById('supplierSpecialization').value.trim(),
            phone: phone,
            tpin: document.getElementById('supplierTpin').value.trim(),
            email: document.getElementById('supplierEmail').value.trim(),
            address: document.getElementById('supplierAddress').value.trim(),
            category: category,
            rating: rating,
            compliance: compliance,
            renewalDate: renewalDate,
            documents: documents,
            images: [],
            lastModifiedBy: getCurrentUser(),
            lastModifiedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        const editingId = document.getElementById('editingSupplierId').value;
        const actionType = document.getElementById('supplierActionType').value;

        try {
            if (actionType === 'edit' && editingId) {
                // Get old data for audit log
                const oldSupplier = suppliers.find(s => s.id === editingId);
                
                if (canEditSupplierWithoutApproval()) {
                    // Admin or Super Admin - Update directly
                    await db.collection(COLLECTIONS.SUPPLIERS).doc(editingId).update(supplierData);
                    
                    // Track changes
                    const changes = {};
                    if (oldSupplier) {
                        for (let key in supplierData) {
                            if (JSON.stringify(oldSupplier[key]) !== JSON.stringify(supplierData[key])) {
                                changes[key] = { old: oldSupplier[key], new: supplierData[key] };
                            }
                        }
                    }
                    
                    await logAudit('UPDATE_SUPPLIER', {
                        supplierId: editingId,
                        name: name,
                        updatedBy: getCurrentUser(),
                        changes: changes
                    });

                    showNotification('Supplier updated successfully', 'success');
                } else {
                    // Staff - Create approval request
                    await createApprovalRequest('supplier', supplierData, 'edit', editingId);
                    closeSupplierModal();
                    showNotification('Supplier edit request submitted for approval', 'info');
                    return;
                }
            } else {
                if (canCreateSupplierWithoutApproval()) {
                    // Admin or Super Admin - Add directly
                    await db.collection(COLLECTIONS.SUPPLIERS).add({
                        ...supplierData,
                        createdAt: new Date().toISOString(),
                        createdBy: getCurrentUser()
                    });

                    await logAudit('CREATE_SUPPLIER', {
                        name: name,
                        category: category,
                        createdBy: getCurrentUser()
                    });

                    showNotification('Supplier added successfully', 'success');
                } else {
                    // Staff - Create approval request
                    await createApprovalRequest('supplier', supplierData, 'add', null);
                    closeSupplierModal();
                    showNotification('Supplier addition request submitted for approval', 'info');
                    return;
                }
            }

            await loadAllData(true);
            closeSupplierModal();

            if (document.getElementById('categoryPageView').style.display === 'block') {
                const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
                renderSuppliersTable(categorySuppliers);
            }
        } catch (error) {
            console.error('Error saving supplier:', error);
            alert('Failed to save supplier: ' + error.message);
        }
    }

    function editSupplier(supplierId) {
        if (!canEditSupplier()) {
            alert('You do not have permission to edit suppliers');
            return;
        }

        const supplier = suppliers.find(s => s.id === supplierId);
        if (!supplier) return;

        document.getElementById('supplierModalTitle').innerHTML = '‚úèÔ∏è Edit Supplier';
        document.getElementById('supplierName').value = supplier.name || '';
        document.getElementById('supplierSpecialization').value = supplier.specialization || '';
        document.getElementById('supplierPhone').value = supplier.phone || '';
        document.getElementById('supplierTpin').value = supplier.tpin || '';
        document.getElementById('supplierEmail').value = supplier.email || '';
        document.getElementById('supplierAddress').value = supplier.address || '';
        document.getElementById('editingSupplierId').value = supplierId;
        document.getElementById('supplierActionType').value = 'edit';
        
        populateCategoryDropdown();
        setTimeout(() => {
            document.getElementById('supplierCategory').value = supplier.category || '';
        }, 100);
        
        const rating = supplier.rating || 3;
        document.querySelectorAll('input[name="rating"]').forEach(input => {
            input.checked = parseInt(input.value) === rating;
        });
        
        document.getElementById('complianceTpin').checked = supplier.compliance?.tpin === 'yes';
        document.getElementById('complianceNapsa').checked = supplier.compliance?.napsa === 'yes';
        document.getElementById('complianceZra').checked = supplier.compliance?.zra === 'yes';
        document.getElementById('complianceZppa').checked = supplier.compliance?.zppa === 'yes';
        
        if (supplier.renewalDate) {
            const date = new Date(supplier.renewalDate);
            document.getElementById('supplierRenewalMonth').value = date.getMonth().toString();
            document.getElementById('supplierRenewalYear').value = date.getFullYear().toString();
        }
        
        updateComplianceUI();
        
        uploadedDocuments = { tpin: null, napsa: null, zra: null, zppa: null };
        ['tpin', 'napsa', 'zra', 'zppa'].forEach(type => {
            const previewEl = document.getElementById(`${type}DocPreview`);
            if (previewEl) previewEl.innerHTML = '';
        });
        
        document.getElementById('supplierModal').style.display = 'flex';
    }

    async function deleteSupplier(supplierId) {
        if (!canDeleteSupplier()) {
            alert('You do not have permission to delete suppliers');
            return;
        }

        const supplier = suppliers.find(s => s.id === supplierId);
        if (!supplier) return;

        if (canDeleteSupplierWithoutApproval()) {
            // Super Admin - Delete directly
            if (confirm(`Delete supplier "${supplier.name}"?`)) {
                try {
                    await db.collection(COLLECTIONS.SUPPLIERS).doc(supplierId).delete();
                    await logAudit('DELETE_SUPPLIER', { 
                        supplierId, 
                        name: supplier.name,
                        deletedBy: getCurrentUser() 
                    });
                    await loadAllData(true);
                    showNotification('Supplier deleted', 'success');
                    
                    if (document.getElementById('categoryPageView').style.display === 'block') {
                        const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
                        renderSuppliersTable(categorySuppliers);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to delete');
                }
            }
        } else if (requiresReasonForSupplierDeletion()) {
            // Admin or Staff - Require reason and create approval request
            openReasonModal('supplier', supplierId, supplier.name, async (type, id, name, reason) => {
                await createApprovalRequest('supplier', { name: name }, 'delete', id, reason);
                showNotification('Delete request submitted for approval', 'info');
            });
        }
    }

    // ========== SUPPLIER TABLE ==========
    function openCategoryPage(categoryId) {
        const category = categories.find(cat => cat.id === categoryId);
        if (!category) return;
        currentCategory = category.name;
        currentCategoryId = categoryId;
        document.getElementById('categoryTitle').textContent = category.name;
        
        const categorySuppliers = suppliers.filter(s => s.category === category.name);
        renderSuppliersTable(categorySuppliers);
        showView('category');
    }

    function renderSuppliersTable(suppliersList) {
        const tbody = document.getElementById('supplierTableBody');
        if (!tbody) return;

        const user = getUser(getCurrentUser());

        if (!suppliersList || suppliersList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 20px;">No suppliers found in this category.</td></tr>';
            return;
        }

        tbody.innerHTML = suppliersList.map(s => {
            const daysRemaining = getDaysRemaining(s);
            const renewalClass = daysRemaining < 0 ? 'expired' : daysRemaining < 30 ? 'expiring' : '';
            
            const canEdit = canEditSupplier();
            const canDelete = canDeleteSupplier();
            const canDeleteDirect = canDeleteSupplierWithoutApproval();
            const requiresReason = requiresReasonForSupplierDeletion();
            
            // Get modification history
            const modifications = s.modifications || [];
            const modHistory = modifications.slice(0, 3).map(mod => 
                `<div class="modification-item"><span class="modification-field">${mod.field}</span> ‚Üí from <span class="modification-old">${mod.old}</span> to <span class="modification-new">${mod.new}</span> <span style="color: #999; font-size: 10px;">by ${mod.modifiedBy} on ${new Date(mod.modifiedAt).toLocaleDateString()}</span></div>`
            ).join('');
            
            return `
            <tr>
                <td>${s.name || ''}</td>
                <td>${s.specialization || ''}</td>
                <td><a href="https://wa.me/${s.phone?.replace(/\D/g, '')}" target="_blank" class="clickable-phone" title="Open WhatsApp">${s.phone || ''}</a></td>
                <td><a href="https://portal.zra.org.zm/searchTaxpayer" target="_blank" class="clickable-tpin" title="Search on ZRA Portal">${s.tpin || ''}</a></td>
                <td><a href="mailto:${s.email || ''}" class="clickable-email" title="Send Email">${s.email || ''}</a></td>
                <td>${s.address || ''}</td>
                <td><div class="star-rating-view">${renderStars(s.rating || 0)}<span class="rating-value">${s.rating || 0}/5</span></div></td>
                <td><div class="compliance-box">${renderCompliancePills(s)}</div></td>
                <td>
                    <div class="vertical-life-bar-container">
                        <div class="vertical-life-bar-fill ${renewalClass}" style="height:${calculateRenewalPercentage(s)}%"></div>
                        <div class="vertical-life-bar-text">${daysRemaining}d</div>
                    </div>
                </td>
                <td>
                    <div onclick="viewDocuments('${s.id}')" style="cursor:pointer; display:flex; align-items:center; gap:5px;">
                        <span style="background: #3498db; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">üìÑ ${s.documents?.length || 0}</span>
                    </div>
                </td>
                <td>
                    <div class="modification-history">
                        <span style="cursor: pointer; background: #f0f0f0; padding: 4px 8px; border-radius: 12px; font-size: 11px; display: inline-block;">
                            üë§ ${s.lastModifiedBy || s.createdBy || 'System'} ‚ñº
                        </span>
                        <div class="modification-dropdown">
                            <div style="font-weight: 700; margin-bottom: 8px; color: #2c3e50; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                                Modification History
                                <span style="float: right; font-size: 10px; color: #999;">Last: ${formatDate(s.lastModifiedAt || s.createdAt)}</span>
                            </div>
                            ${modHistory || '<div style="color: #999; padding: 5px;">No modification history</div>'}
                        </div>
                    </div>
                </td>
                <td>
                    <div class="action-buttons">
                        ${canEdit ? `<button class="btn-edit" onclick="editSupplier('${s.id}')">Edit</button>` : ''}
                        ${canDelete && canDeleteDirect ? `<button class="btn-del" onclick="deleteSupplier('${s.id}')">Delete</button>` : ''}
                        ${canDelete && !canDeleteDirect && requiresReason ? 
                            `<button class="btn-request-delete" onclick="deleteSupplier('${s.id}')">Request Delete</button>` : ''}
                    </div>
                </td>
            </tr>
        `}).join('');
    }

    // ========== LINKS MANAGEMENT ==========
    function renderLinks() {
        const tbody = document.getElementById('linksBody');
        if (!tbody) return;

        const user = getUser(getCurrentUser());
        const canDelete = canDeleteLink();
        const canDeleteDirect = canDeleteLinkWithoutApproval();
        const requiresReason = requiresReasonForLinkDeletion();

        if (!links || links.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No links found.</td></tr>';
            return;
        }

        tbody.innerHTML = links.map(link => `
            <tr>
                <td>${link.institution || ''}</td>
                <td><a href="${link.website}" target="_blank">${link.website}</a></td>
                <td>${link.email || ''}</td>
                <td>
                    <div class="action-buttons">
                        ${canDelete && canDeleteDirect ? 
                            `<button class="btn-del" onclick="deleteLink('${link.id}')">Delete</button>` : 
                            canDelete && !canDeleteDirect && requiresReason ? 
                            `<button class="btn-request-delete" onclick="deleteLink('${link.id}')">Request Delete</button>` : 
                            '‚Äî'}
                    </div>
                </td>
            </tr>
        `).join('');
    }

    async function addLink() {
        if (!canCreateLink()) {
            alert('You do not have permission to add links');
            return;
        }

        const institution = document.getElementById('instName').value.trim();
        const website = document.getElementById('instWeb').value.trim();
        const email = document.getElementById('instEmail').value.trim();
        
        if (!institution || !website) {
            alert("Institution and website are required");
            return;
        }

        try {
            if (canCreateLinkWithoutApproval()) {
                // Admin or Super Admin - Add directly
                const newLink = {
                    institution,
                    website,
                    email,
                    createdAt: new Date().toISOString(),
                    createdBy: getCurrentUser()
                };
                
                await db.collection(COLLECTIONS.LINKS).add(newLink);
                await logAudit('CREATE_LINK', { institution, website, email, createdBy: getCurrentUser() });
                await loadAllData(true);
                renderLinks();
                closeLinkModal();
                showNotification('Link added successfully');
            } else {
                // Staff - Create approval request
                await createApprovalRequest('link', { institution, website, email }, 'add', null);
                closeLinkModal();
                showNotification('Link addition request submitted for approval', 'info');
            }
        } catch (error) {
            console.error("Error adding link:", error);
            alert("Failed to add link");
        }
    }

    async function deleteLink(id) {
        if (!canDeleteLink()) {
            alert("You don't have permission to delete links");
            return;
        }

        const link = links.find(l => l.id === id);
        if (!link) return;

        if (canDeleteLinkWithoutApproval()) {
            // Super Admin - Delete directly
            if (confirm('Are you sure you want to delete this link?')) {
                try {
                    await db.collection(COLLECTIONS.LINKS).doc(id).delete();
                    await logAudit('DELETE_LINK', { 
                        institution: link?.institution,
                        website: link?.website,
                        deletedBy: getCurrentUser() 
                    });
                    await loadAllData(true);
                    renderLinks();
                    showNotification('Link deleted successfully');
                } catch (error) {
                    console.error("Error deleting link:", error);
                    alert("Failed to delete link");
                }
            }
        } else if (requiresReasonForLinkDeletion()) {
            // Admin or Staff - Require reason and create approval request
            openReasonModal('link', id, link.institution, async (type, id, name, reason) => {
                await createApprovalRequest('link', { name: name }, 'delete', id, reason);
                showNotification('Delete request submitted for approval', 'info');
            });
        }
    }

    function openLinkModal() { 
        if (!canCreateLink()) {
            alert('You do not have permission to add links');
            return;
        }
        document.getElementById('linkModal').style.display = 'flex'; 
    }
    
    function closeLinkModal() { 
        document.getElementById('linkModal').style.display = 'none'; 
        document.getElementById('instName').value = '';
        document.getElementById('instWeb').value = '';
        document.getElementById('instEmail').value = '';
    }

    // ========== USER MANAGEMENT WITH APPROVAL FOR STAFF ==========
    async function manageUsersModal() {
        const currentUser = getCurrentUser();
        const curUser = getUser(currentUser);
        
        if (!curUser || (curUser.role !== 'super admin' && curUser.role !== 'admin')) {
            alert("Access denied - Only Admin and Super Admin can manage users");
            return;
        }

        await getAllUsers(true);
        
        const tbody = document.getElementById('userMgmtTableBody');
        let html = '';

        for (let u of userAccounts) {
            const isSuperAdmin = (curUser.role === 'super admin');
            const canEdit = (curUser.role === 'super admin') || (curUser.role === 'admin' && u.role !== 'super admin');
            const canDelete = (curUser.role === 'super admin') && !isJoseph(u.username);
            
            let displayEmail = '';
            let displayNrc = '';
            let displayPhone = u.phone || '';
            
            if (curUser.role === 'super admin') {
                displayEmail = u.email || '';
                displayNrc = u.nrc || '';
            } else if (curUser.role === 'admin') {
                // Admin sees masked data for privacy
                displayEmail = '****@****';
                displayNrc = '******';
            }

            const status = u.enabled ? 
                '<span style="color:green; font-weight:bold;">Enabled</span>' : 
                '<span style="color:red; font-weight:bold;">Disabled</span>';
            
            let actions = '';
            if (canEdit) {
                actions += `<button class="btn-edit" onclick="openEditUserModal('${u.id}')">Edit</button> `;
            }
            if (canDelete) {
                actions += `<button class="btn-del" onclick="deleteUser('${u.id}')">Delete</button>`;
            }
            if (!actions) actions = '‚Äî';

            const roleClass = u.role.replace(' ', '');
            
            // In manageUsersModal function, update the table row generation:
// In manageUsersModal function, update the table row generation:
html += `<tr>
    <td>
        ${u.username}
        ${isJoseph(u.username) ? ' üîí' : ''}
        <br><span style="font-size: 11px; color: #666;">${u.fullName || ''}</span>
    </td>
    <td><span class="role-badge role-${roleClass}">${u.role}</span></td>
    <td>${displayPhone}</td>
    <td>${displayEmail}<br><span style="font-size:11px; color:#666;">NRC: ${displayNrc}</span></td>
    <td>
        ${status}
        <div style="display: flex; gap: 5px; justify-content: center; margin-top: 8px;">
            ${u.documents?.degree ? 
                `<button onclick="viewUserDocument('${u.id}', 'degree', event)" style="background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 20px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;" title="View Degree/Diploma">
                    <span>üéì</span> Degree
                </button>` 
                : '<span style="color: #ccc; font-size: 11px; background: #f0f0f0; padding: 5px 10px; border-radius: 20px;">üéì No Degree</span>'}
        </div>
        <div style="display: flex; gap: 5px; justify-content: center; margin-top: 5px;">
            ${u.documents?.zips ? 
                `<button onclick="viewUserDocument('${u.id}', 'zips', event)" style="background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 20px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;" title="View ZIPS Certificate">
                    <span>üìú</span> ZIPS
                </button>` 
                : '<span style="color: #ccc; font-size: 11px; background: #f0f0f0; padding: 5px 10px; border-radius: 20px;">üìú No ZIPS</span>'}
        </div>
        <div style="display: flex; gap: 5px; justify-content: center; margin-top: 5px;">
            ${u.documents?.nrc ? 
                `<button onclick="viewUserDocument('${u.id}', 'nrc', event)" style="background: #e67e22; color: white; border: none; padding: 5px 10px; border-radius: 20px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;" title="View NRC">
                    <span>ü™™</span> NRC
                </button>` 
                : '<span style="color: #ccc; font-size: 11px; background: #f0f0f0; padding: 5px 10px; border-radius: 20px;">ü™™ No NRC</span>'}
        </div>
    </td>
    <td><div class="action-buttons">${actions}</div></td>
</tr>`;
        }

        tbody.innerHTML = html;
        document.getElementById('userManagementModal').style.display = 'flex';
    }



    function openEditUserModal(userId) {
        const user = userAccounts.find(u => u.id === userId);
        if (!user) {
            alert('User not found');
            return;
        }

        const currentUser = getUser(getCurrentUser());
        
        if (currentUser.role !== 'super admin') {
            if (user.role === 'super admin') {
                alert('You cannot edit a super admin user');
                return;
            }
        }

        document.getElementById('editUserId').value = user.id;
        document.getElementById('editUsername').value = user.username;
        document.getElementById('editRole').value = user.role;
        document.getElementById('editNrc').value = user.nrc || '';
        document.getElementById('editEmail').value = user.email || '';
        document.getElementById('editPhone').value = user.phone || '';
        document.getElementById('editInstitution').value = user.institution || '';
        document.getElementById('editPosition').value = user.position || '';
        document.getElementById('editPassword').value = '';
        document.getElementById('editEnabled').checked = user.enabled !== false;

        if (currentUser.role !== 'super admin') {
            document.getElementById('editRole').disabled = true;
        } else {
            document.getElementById('editRole').disabled = false;
        }

        document.getElementById('editUserModal').style.display = 'flex';
    }

    async function saveUserEdit() {
        if (!isCurrentUserSuperAdmin() && !isCurrentUserAdmin()) {
            alert("You don't have permission to edit users");
            return;
        }

        const userId = document.getElementById('editUserId').value;
        const user = userAccounts.find(u => u.id === userId);
        if (!user) {
            alert('User not found');
            return;
        }

        const currentUser = getUser(getCurrentUser());
        
        if (currentUser.role !== 'super admin' && user.role === 'super admin') {
            alert('You cannot edit a super admin user');
            closeEditUserModal();
            return;
        }

        const updatedData = {
            role: document.getElementById('editRole').value,
            nrc: document.getElementById('editNrc').value.trim(),
            email: document.getElementById('editEmail').value.trim(),
            phone: document.getElementById('editPhone').value.trim(),
            institution: document.getElementById('editInstitution').value.trim(),
            position: document.getElementById('editPosition').value.trim(),
            enabled: document.getElementById('editEnabled').checked
        };

        const newPassword = document.getElementById('editPassword').value.trim();
        if (newPassword) {
            updatedData.password = newPassword;
        }

        if (currentUser.role !== 'super admin' && updatedData.role === 'super admin') {
            alert('Only super admin can assign super admin role');
            return;
        }

        try {
            if (currentUser.role === 'super admin') {
                // Super Admin - Update directly
                await db.collection(COLLECTIONS.USERS).doc(userId).update(updatedData);
                
                await logAudit('EDIT_USER', {
                    username: user.username,
                    changes: updatedData,
                    editedBy: getCurrentUser()
                });
                
                await getAllUsers(true);
                closeEditUserModal();
                manageUsersModal();
                showNotification(`User ${user.username} updated successfully`);
            } else {
                // Admin - Require super admin approval
                await createApprovalRequest('user', updatedData, 'edit', userId);
                closeEditUserModal();
                manageUsersModal();
                showNotification('User edit request submitted for super admin approval', 'info');
            }
        } catch (error) {
            console.error("Error updating user:", error);
            alert("Failed to update user: " + error.message);
        }
    }

    function closeEditUserModal() {
        document.getElementById('editUserModal').style.display = 'none';
        document.getElementById('editPassword').value = '';
    }

    function openAddUserModal() {
        if (!canAddUser()) {
            alert("You don't have permission to add users");
            return;
        }

        document.getElementById('addUserTitle').innerText = '‚ûï Add New User';
        
        ['newUsername', 'newNrc', 'newEmail', 'newPhone', 'newInstitution', 'newPosition', 'newPassword'].forEach(id => {
            document.getElementById(id).value = '';
        });
        
        document.getElementById('newRole').value = 'staff';

        const currentUser = getUser(getCurrentUser());
        
        if (currentUser.role === 'staff') {
            // Staff can only add staff users
            const roleSelect = document.getElementById('newRole');
            for (let i = 0; i < roleSelect.options.length; i++) {
                if (roleSelect.options[i].value !== 'staff') {
                    roleSelect.options[i].disabled = true;
                }
            }
        } else if (currentUser.role === 'admin') {
            // Admin can add staff users (requires super admin approval)
            const roleSelect = document.getElementById('newRole');
            for (let i = 0; i < roleSelect.options.length; i++) {
                if (roleSelect.options[i].value !== 'staff') {
                    roleSelect.options[i].disabled = true;
                }
            }
        } else if (currentUser.role === 'super admin') {
            // Super admin can add any role
            document.querySelectorAll('#newRole option').forEach(opt => opt.disabled = false);
        }

        document.getElementById('addUserModal').style.display = 'flex';
    }

    async function saveNewUser() {
        if (!canAddUser()) {
            alert("You don't have permission to add users");
            return;
        }

        const username = document.getElementById('newUsername').value.toUpperCase().trim();
        const role = document.getElementById('newRole').value;
        const nrc = document.getElementById('newNrc').value.trim();
        const email = document.getElementById('newEmail').value.trim();
        const phone = document.getElementById('newPhone').value.trim();
        const institution = document.getElementById('newInstitution').value.trim();
        const position = document.getElementById('newPosition').value.trim();
        const password = document.getElementById('newPassword').value.trim();

        if (!username || !password || !role) {
            alert("Username, password and role are required");
            return;
        }

        if (role === 'super admin' && !isCurrentUserSuperAdmin()) {
            alert("Only super admin can create super admin users");
            return;
        }

        if (userAccounts.find(u => u.username === username)) {
            alert("Username already exists");
            return;
        }

        const newUser = {
            username,
            password,
            role,
            nrc,
            email,
            phone,
            institution,
            position,
            enabled: true,
            createdAt: new Date().toISOString(),
            lastActive: null
        };

        try {
            if (canAddUserWithoutApproval()) {
                // Super Admin - Add directly
                await db.collection(COLLECTIONS.USERS).add(newUser);
                
                await logAudit('CREATE_USER', {
                    username,
                    role,
                    createdBy: getCurrentUser()
                });
                
                await getAllUsers(true);
                closeAddUserModal();
                manageUsersModal();
                showNotification(`User ${username} created successfully`);
            } else {
                // Staff or Admin - Create approval request
                const currentUser = getUser(getCurrentUser());
                await createApprovalRequest('user', newUser, 'add', null);
                closeAddUserModal();
                showNotification(`User addition request submitted for ${currentUser.role === 'admin' ? 'super admin' : 'admin/super admin'} approval`, 'info');
            }
        } catch (error) {
            console.error("Error creating user:", error);
            alert("Failed to create user");
        }
    }

    async function deleteUser(userId) {
        if (!canDeleteUser()) {
            alert("You don't have permission to delete users");
            return;
        }

        const user = userAccounts.find(u => u.id === userId);
        if (!user) return;

        if (isJoseph(user.username)) {
            alert('JOSEPH cannot be deleted');
            return;
        }

        if (canDeleteUserWithoutApproval()) {
            // Super Admin - Delete directly
            if (confirm(`Are you sure you want to permanently delete user ${user.username}?`)) {
                try {
                    await db.collection(COLLECTIONS.USERS).doc(userId).delete();
                    
                    await logAudit('DELETE_USER', {
                        username: user.username,
                        role: user.role,
                        deletedBy: getCurrentUser()
                    });
                    
                    await getAllUsers(true);
                    manageUsersModal();
                    showNotification(`User ${user.username} deleted successfully`);
                } catch (error) {
                    console.error("Error deleting user:", error);
                    alert("Failed to delete user");
                }
            }
        } else {
            // Admin - Require super admin approval
            openReasonModal('user', userId, user.username, async (type, id, name, reason) => {
                await createApprovalRequest('user', { name: name, role: user.role }, 'delete', id, reason);
                showNotification('User deletion request submitted for super admin approval', 'info');
                manageUsersModal();
            });
        }
    }

    function closeUserMgmtModal() { 
        document.getElementById('userManagementModal').style.display = 'none'; 
    }
    
    function closeAddUserModal() { 
        document.getElementById('addUserModal').style.display = 'none'; 
    }

    // ========== SESSIONS PANEL ==========
    async function toggleSessionsPanel() {
        if (!canViewSessions()) {
            alert('You do not have permission to view sessions');
            return;
        }

        const panel = document.getElementById('sessionsPanel');
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
            return;
        }

        await getAllUsers(true);
        const listDiv = document.getElementById('activeSessionsList');
        const now = new Date();
        let html = '';

        for (let u of userAccounts) {
            if (!u.enabled) continue;
            
            const lastActive = u.lastActive ? new Date(u.lastActive) : null;
            const isOnline = lastActive && (now - lastActive) < 300000;
            
            let timeAgo = 'Never';
            if (lastActive) {
                const diffMs = now - lastActive;
                const diffMins = Math.floor(diffMs / 60000);
                if (diffMins < 1) timeAgo = 'Just now';
                else if (diffMins < 60) timeAgo = `${diffMins} min ago`;
                else timeAgo = `${Math.floor(diffMins / 60)}h ${diffMins % 60}m ago`;
            }

            html += `
                <div style="padding:10px; border-bottom:1px solid #eee;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span class="online-indicator ${isOnline ? 'pulse-online beaming' : 'offline-grey'}"></span>
                        <strong>${u.username}</strong>
                        <span style="font-size:11px; background:#f0f0f0; padding:2px 6px; border-radius:12px;">${u.role}</span>
                    </div>
                    <div style="font-size:11px; color:#666; margin-top:4px;">
                        Last active: ${timeAgo}
                    </div>
                </div>
            `;
        }

        listDiv.innerHTML = html || '<p style="padding:15px; text-align:center; color:#888;">No users found</p>';
        panel.style.display = 'block';
    }

    // ========== EXPORT BACKUP (SUPER ADMIN ONLY) ==========
    async function exportData() {
        if (!isCurrentUserSuperAdmin()) {
            alert("Only super admin can export backup");
            return;
        }

        try {
            await loadAllData(true);
            await getAllUsers(true);
            await loadAuditLogs();

            const backup = {
                categories,
                suppliers,
                links,
                users: userAccounts.map(u => {
                    const { password, ...safeUser } = u;
                    return safeUser;
                }),
                auditLogs: auditLogs.slice(0, 100),
                exportedAt: new Date().toISOString(),
                exportedBy: getCurrentUser()
            };

            const dataStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `zamcom_backup_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            await logAudit('EXPORT_BACKUP', {
                recordCounts: {
                    categories: categories.length,
                    suppliers: suppliers.length,
                    links: links.length,
                    users: userAccounts.length
                }
            });
            
            showNotification('Backup downloaded successfully (super admin only)');
        } catch (error) {
            console.error("Export error:", error);
            alert("Failed to export backup");
        }
    }

    function importData(event) {
        if (!isCurrentUserSuperAdmin()) {
            alert("Only super admin can import data");
            event.target.value = '';
            return;
        }
        alert('Import & Merge feature - Firestore implementation pending');
        event.target.value = '';
    }

    // ========== UI HELPER FUNCTIONS ==========
    function showView(viewName) {
        document.getElementById('homeView').style.display = 'none';
        document.getElementById('categoryPageView').style.display = 'none';
        document.getElementById('aboutView').style.display = 'none';
        document.getElementById('contactView').style.display = 'none';
        document.getElementById('linksView').style.display = 'none';
        document.getElementById('auditLogsView').style.display = 'none';
        document.getElementById('userApprovalHistoryView').style.display = 'none';
        document.getElementById('searchResultSection').style.display = 'none';
        
        if (viewName === 'home') {
            document.getElementById('homeView').style.display = 'block';
            renderCategories();
        } else if (viewName === 'category') {
            document.getElementById('categoryPageView').style.display = 'block';
        } else if (viewName === 'about') {
            document.getElementById('aboutView').style.display = 'block';
        } else if (viewName === 'contact') {
            document.getElementById('contactView').style.display = 'block';
        } else if (viewName === 'links') {
            document.getElementById('linksView').style.display = 'block';
            renderLinks();
        } else if (viewName === 'auditLogs') {
            document.getElementById('auditLogsView').style.display = 'block';
        } else if (viewName === 'userApprovalHistory') {
            document.getElementById('userApprovalHistoryView').style.display = 'block';
            loadUserApprovalHistory('pending');
        }
    }

    function updateGreeting() {
        const hour = new Date().getHours();
        const user = getCurrentUser() || 'User';
        const msg = hour < 12 ? "Good Morning" : hour < 18 ? "Good Afternoon" : "Good Evening";
        const greetingEl = document.getElementById('greeting');
        if (greetingEl) greetingEl.innerHTML = `<i>${msg}, ${user}</i>`;
    }

    function updateUserDisplay() {
    const currentUser = getCurrentUser();
    const userInfo = document.getElementById('currentUserDisplay');
    const roleBadge = document.getElementById('userRoleBadge');
    const changePasswordLink = document.getElementById('changePasswordLink');
    
    if (currentUser && userInfo) {
        userInfo.textContent = currentUser;
        const user = getUser(currentUser);
        if (user && roleBadge) {
            roleBadge.textContent = user.role.toUpperCase();
            roleBadge.style.display = 'inline-block';
            roleBadge.style.background = 
                user.role === 'super admin' ? '#9b59b6' : 
                user.role === 'admin' ? '#3498db' : '#2ecc71';
        }
        
        // Show change password link for logged in users
        if (changePasswordLink) {
            changePasswordLink.style.display = 'inline-block';
            console.log('Change password link should be visible');
        }
    } else if (userInfo) {
        userInfo.textContent = 'Not logged in';
        if (roleBadge) roleBadge.style.display = 'none';
        if (changePasswordLink) changePasswordLink.style.display = 'none';
    }
}

    // ========== CHANGE PASSWORD FUNCTIONS ==========
function openChangePasswordModal() {
    console.log('Opening change password modal');
    
    // Get elements
    const modal = document.getElementById('changePasswordModal');
    const currentPw = document.getElementById('currentPassword');
    const newPw = document.getElementById('newPassword');
    const confirmPw = document.getElementById('confirmPassword');
    
    console.log('Modal found:', modal !== null);
    console.log('Current password field found:', currentPw !== null);
    console.log('New password field found:', newPw !== null);
    console.log('Confirm password field found:', confirmPw !== null);
    
    if (!modal) {
        alert('Error: Change password modal not found. Please refresh the page.');
        return;
    }
    
    if (!currentPw || !newPw || !confirmPw) {
        alert('Error: Password input fields not found. Please refresh the page.');
        return;
    }
    
    // Clear fields
    currentPw.value = '';
    newPw.value = '';
    confirmPw.value = '';
    
    // Show modal
    modal.style.display = 'flex';
    
    // Focus on current password field
    setTimeout(() => {
        currentPw.focus();
    }, 100);
}

function closeChangePasswordModal() {
    const modal = document.getElementById('changePasswordModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// ========== SIMPLIFIED CHANGE PASSWORD FUNCTIONS ==========

function openChangePasswordModal() {
    console.log('Opening change password modal');
    
    // Get the modal
    const modal = document.getElementById('changePasswordModal');
    if (!modal) {
        alert('ERROR: Change password modal not found in the HTML!');
        return;
    }
    
    // Get input fields
    const currentField = document.getElementById('currentPassword');
    const newField = document.getElementById('newPassword');
    const confirmField = document.getElementById('confirmPassword');
    
    console.log('Input fields found:', {
        current: currentField ? 'YES' : 'NO',
        new: newField ? 'YES' : 'NO',
        confirm: confirmField ? 'YES' : 'NO'
    });
    
    if (!currentField || !newField || !confirmField) {
        alert('ERROR: Password input fields not found in the HTML!');
        return;
    }
    
    // Clear fields
    currentField.value = '';
    newField.value = '';
    confirmField.value = '';
    
    // Show modal
    modal.style.display = 'flex';
    
    // Focus on first field
    setTimeout(() => {
        currentField.focus();
    }, 100);
}

function closeChangePasswordModal() {
    const modal = document.getElementById('changePasswordModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Simple test function - this should definitely work
function testFillPasswordFields() {
    console.log('Test fill function called');
    
    // Get fields directly
    const currentField = document.getElementById('currentPassword');
    const newField = document.getElementById('newPassword');
    const confirmField = document.getElementById('confirmPassword');
    
    console.log('Fields in test function:', {
        current: currentField,
        new: newField,
        confirm: confirmField
    });
    
    if (!currentField || !newField || !confirmField) {
        alert('Cannot find password fields!');
        return;
    }
    
    // Set values directly
    currentField.value = 'RIGHTJOSEPH';
    newField.value = 'test123';
    confirmField.value = 'test123';
    
    console.log('Values set:', {
        current: currentField.value,
        new: newField.value,
        confirm: confirmField.value
    });
    
    // Visual feedback
    currentField.style.borderColor = 'green';
    newField.style.borderColor = 'green';
    confirmField.style.borderColor = 'green';
    
    alert('‚úì Test values filled! Current: RIGHTJOSEPH, New: test123');
}

// Simple password change function
async function changePassword() {
    console.log('Change password called');
    
    // Get fields
    const currentField = document.getElementById('currentPassword');
    const newField = document.getElementById('newPassword');
    const confirmField = document.getElementById('confirmPassword');
    
    if (!currentField || !newField || !confirmField) {
        alert('Cannot find password fields!');
        return;
    }
    
    // Get values
    const currentPassword = currentField.value;
    const newPassword = newField.value;
    const confirmPassword = confirmField.value;
    
    console.log('Values entered:', {
        current: currentPassword ? '‚úì' : '‚úó',
        new: newPassword ? '‚úì' : '‚úó',
        confirm: confirmPassword ? '‚úì' : '‚úó'
    });
    
    // Check if empty
    if (currentPassword === '') {
        alert('Please enter your current password');
        currentField.focus();
        return;
    }
    
    if (newPassword === '') {
        alert('Please enter a new password');
        newField.focus();
        return;
    }
    
    if (confirmPassword === '') {
        alert('Please confirm your new password');
        confirmField.focus();
        return;
    }
    
    // Check if match
    if (newPassword !== confirmPassword) {
        alert('New passwords do not match!');
        confirmField.focus();
        return;
    }
    
    // Check length
    if (newPassword.length < 6) {
        alert('Password must be at least 6 characters');
        newField.focus();
        return;
    }
    
    // Get current user
    const username = getCurrentUser();
    if (!username) {
        alert('Not logged in!');
        return;
    }
    
    // Get user data
    await getAllUsers(true);
    const user = getUser(username);
    
    if (!user) {
        alert('User not found!');
        return;
    }
    
    // Check current password
    if (user.password !== currentPassword) {
        alert('Current password is incorrect!');
        currentField.focus();
        return;
    }
    
    // Update password
    try {
        console.log('Updating password for:', user.id);
        
        await db.collection(COLLECTIONS.USERS).doc(user.id).update({
            password: newPassword,
            lastPasswordChange: new Date().toISOString()
        });
        
        console.log('Password updated');
        
        // Log audit
        await logAudit('CHANGE_PASSWORD', { username: username });
        
        // Clear fields and close
        currentField.value = '';
        newField.value = '';
        confirmField.value = '';
        
        closeChangePasswordModal();
        
        alert('‚úÖ Password changed successfully!');
        showNotification('Password changed successfully!', 'success');
        
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to update password: ' + error.message);
    }
}

// Debug function
function debugPasswordModal() {
    console.log('=== DEBUG PASSWORD MODAL ===');
    
    const modal = document.getElementById('changePasswordModal');
    console.log('Modal:', modal);
    
    const fields = ['currentPassword', 'newPassword', 'confirmPassword'];
    
    fields.forEach(id => {
        const field = document.getElementById(id);
        console.log(`${id}:`, {
            exists: field !== null,
            type: field ? field.type : 'N/A',
            value: field ? `"${field.value}"` : 'N/A',
            parent: field ? field.parentElement : 'N/A'
        });
    });
    
    console.log('===========================');
    alert('Check console (F12) for debug info');
}

// Make sure the change password modal is properly hidden on logout
function logout() {
    const username = getCurrentUser();
    logAudit('USER_LOGOUT', { username: username });
    
    localStorage.removeItem('logged_user');
    localStorage.removeItem('last_login');
    
    // Close change password modal if open
    const changePwModal = document.getElementById('changePasswordModal');
    if (changePwModal) changePwModal.style.display = 'none';
    
    if (sessionHeartbeat) {
        clearInterval(sessionHeartbeat);
        sessionHeartbeat = null;
    }

    ['homeView','categoryPageView','aboutView','contactView','linksView','auditLogsView','userApprovalHistoryView'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });

    document.getElementById('loginOverlay').style.display = 'flex';
    document.getElementById('userIn').value = '';
    document.getElementById('passIn').value = '';
    document.getElementById('timeWarning').style.display = 'none';
}

    function updateDashboardStatus() {
        const clockEl = document.getElementById('liveClock');
        if (clockEl) {
            const now = new Date();
            clockEl.textContent = now.toLocaleTimeString('en-US', { 
                hour12: true, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
        }

        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const currentUser = getCurrentUser();
        
        if (statusDot && statusText) {
            if (isSystemLocked()) {
                if (canAccessLockedSystem()) {
                    statusDot.className = 'pulse-online';
                    statusText.innerText = "üîì SYSTEM LOCKED - You have after-hours access";
                    statusText.style.color = "var(--warning-orange)";
                } else {
                    statusDot.className = 'offline-grey';
                    statusText.innerText = "üîí SYSTEM LOCKED (07:30 - 16:50 only)";
                    statusText.style.color = "var(--danger-red)";
                }
            } else {
                statusDot.className = 'pulse-online';
                statusText.innerText = "‚úÖ SYSTEM OPERATIONAL (OPEN)";
                statusText.style.color = "var(--primary-green)";
            }
        }
    }

    function syncBG() {
        const header = document.getElementById('headerSection');
        if (!header) return;
        header.style.backgroundImage = `linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('${bgImages[bgIndex]}')`;
        bgIndex = (bgIndex + 1) % bgImages.length;
    }

    // ========== SUPPLIER HELPER FUNCTIONS ==========
    function renderStars(rating) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            stars += `<span class="star-view ${i <= rating ? 'filled' : 'star-empty-view'}">‚òÖ</span>`;
        }
        return stars;
    }

    function renderCompliancePills(supplier) {
        if (!supplier.compliance) return '<span class="compliance-pill comp-bad">NO DATA</span>';
        let pills = [];
        pills.push(supplier.compliance.tpin === 'yes' ? 
            '<span class="compliance-pill comp-ok">TPIN</span>' : 
            '<span class="compliance-pill comp-bad">TPIN</span>');
        pills.push(supplier.compliance.napsa === 'yes' ? 
            '<span class="compliance-pill comp-ok">NAPSA</span>' : 
            '<span class="compliance-pill comp-bad">NAPSA</span>');
        pills.push(supplier.compliance.zra === 'yes' ? 
            '<span class="compliance-pill comp-ok">ZRA</span>' : 
            '<span class="compliance-pill comp-bad">ZRA</span>');
        pills.push(supplier.compliance.zppa === 'yes' ? 
            '<span class="compliance-pill comp-ok">ZPPA</span>' : 
            '<span class="compliance-pill comp-bad">ZPPA</span>');
        return pills.join('');
    }

    function getDaysRemaining(supplier) {
        if (!supplier.renewalDate) return 0;
        const today = new Date();
        const renewal = new Date(supplier.renewalDate);
        return Math.ceil((renewal - today) / (1000 * 60 * 60 * 24));
    }

    function calculateRenewalPercentage(supplier) {
        if (!supplier.renewalDate) return 0;
        const days = getDaysRemaining(supplier);
        if (days < 0) return 0;
        return Math.min(100, (days / 365) * 100);
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' });
    }

    // ========== DOCUMENT VIEWER WITH FIXED IMAGE DISPLAY ==========
    function viewDocuments(supplierId) {
        const supplier = suppliers.find(s => s.id === supplierId);
        if (!supplier || !supplier.documents || supplier.documents.length === 0) {
            alert('No documents available for this supplier');
            return;
        }

        const viewerBody = document.getElementById('documentViewerBody');
        viewerBody.innerHTML = '';

        supplier.documents.forEach((doc, index) => {
            const isImage = doc.type && (doc.type.startsWith('image/') || doc.name?.match(/\.(jpg|jpeg|png|gif|webp)$/i));
            const docType = doc.type ? doc.type.toUpperCase() : 'PDF';
            
            const docElement = document.createElement('div');
            docElement.style.cssText = 'background: #f8f9fa; border-radius: 12px; padding: 15px; text-align: center;';
            
            if (isImage) {
                docElement.innerHTML = `
                    <img src="${doc.data}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; cursor: pointer;" onclick="window.open('${doc.data}', '_blank')">
                    <div style="font-weight: bold; margin-bottom: 5px; word-break: break-word;">${doc.name}</div>
                    <div style="font-size: 11px; color: #666;">${doc.type || 'Image'} ‚Ä¢ ${(doc.size / 1024).toFixed(1)} KB</div>
                    <div style="margin-top: 10px;">
                        <button class="btn-edit" style="padding: 5px 10px; font-size: 11px;" onclick="window.open('${doc.data}', '_blank')">View Full Image</button>
                    </div>
                `;
            } else {
                // For PDFs and other documents
                docElement.innerHTML = `
                    <div style="background: #e74c3c; width: 100%; height: 150px; display: flex; align-items: center; justify-content: center; border-radius: 8px; margin-bottom: 10px;">
                        <span style="font-size: 48px; color: white;">üìÑ</span>
                    </div>
                    <div style="font-weight: bold; margin-bottom: 5px; word-break: break-word;">${doc.name}</div>
                    <div style="font-size: 11px; color: #666;">${docType} ‚Ä¢ ${(doc.size / 1024).toFixed(1)} KB</div>
                    <div style="margin-top: 10px;">
                        <button class="btn-edit" style="padding: 5px 10px; font-size: 11px;" onclick="window.open('${doc.data}', '_blank')">View</button>
                    </div>
                `;
            }
            
            viewerBody.appendChild(docElement);
        });

        document.getElementById('documentViewerTitle').innerHTML = `üìÅ Documents: ${supplier.name}`;
        document.getElementById('documentViewerModal').style.display = 'flex';
    }

    function closeDocumentViewer() { 
        document.getElementById('documentViewerModal').style.display = 'none'; 
    }

    // ========== SEARCH FUNCTION ==========
    let searchTimeout;
    function filterEverything() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const term = document.getElementById('globalSearch').value.toLowerCase();
            if (term.length < 2) { 
                document.getElementById('searchResultSection').style.display = 'none';
                document.getElementById('defaultHomeContent').style.display = 'block';
                return;
            }
            
            const results = suppliers.filter(s => s.name && s.name.toLowerCase().includes(term));
            const tbody = document.getElementById('globalSearchResultsBody');
            
            tbody.innerHTML = results.map(s => {
                const daysRemaining = getDaysRemaining(s);
                return `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.category || ''}</td>
                    <td>${s.specialization || ''}</td>
                    <td><a href="https://wa.me/${s.phone?.replace(/\D/g, '')}" target="_blank">${s.phone || ''}</a></td>
                    <td>${renderStars(s.rating || 0)} ${s.rating || 0}/5</td>
                    <td><span style="background: ${daysRemaining < 0 ? '#e74c3c' : daysRemaining < 30 ? '#f39c12' : '#2ecc71'}; color: white; padding: 3px 8px; border-radius: 12px;">${daysRemaining} days</span></td>
                    <td><div class="action-buttons">${canEditSupplier() ? `<button class="btn-edit" onclick="editSupplier('${s.id}')">Edit</button>` : '‚Äî'}</div></td>
                </tr>
            `}).join('');
            
            document.getElementById('defaultHomeContent').style.display = 'none';
            document.getElementById('searchResultSection').style.display = 'block';
        }, 300);
    }

    // ========== NOTIFICATION ==========
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        notification.style.background = type === 'success' ? '#173979' : type === 'info' ? '#3498db' : '#ff4d4d';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 4000);
    }

    // ========== MISC ==========
    function forgotPasswordSimple() { 
        alert('Please contact the super admin at zulujosephp@gmail.com'); 
    }

    // ========== REALTIME APPROVAL LISTENER ==========
    let unsubscribeApprovals = null;

    function startRealtimeApprovalListener() {
        if (unsubscribeApprovals) {
            unsubscribeApprovals();
            unsubscribeApprovals = null;
        }
        
        const user = getCurrentUser();
        if (!user) return;
        
        const currentUser = getUser(user);
        if (!currentUser || !canApproveRequests()) {
            return;
        }
        
        let query;
        if (currentUser.role === 'super admin') {
            query = db.collection(COLLECTIONS.APPROVALS)
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc');
        } else {
            query = db.collection(COLLECTIONS.APPROVALS)
                .where('status', '==', 'pending')
                .where('requestedByRole', '==', 'staff')
                .orderBy('createdAt', 'desc');
        }
        
        unsubscribeApprovals = query.onSnapshot((snapshot) => {
            console.log(`üì° Realtime update: ${snapshot.docs.length} pending approvals`);
            
            approvalRequests = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            updateApprovalsButton();
            updateRequestCounts();
            
            const modal = document.getElementById('approvalRequestsModal');
            if (modal && modal.style.display === 'flex') {
                openApprovalRequestsModal();
            }
            
            const reqModal = document.getElementById('requestsManagementModal');
            if (reqModal) {
                openRequestsManagement();
            }
            
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const req = change.doc.data();
                    if (req.requestedBy !== getCurrentUser()) {
                        showNotification(`üì® New approval request from ${req.requestedBy}`, 'info');
                    }
                }
            });
            
        }, (error) => {
            console.error("Realtime listener error:", error);
        });
    }


    // Update the initializeApp function (replace the existing one)
// ========== INITIALIZATION WITH LOADING SPINNER ==========
    async function initializeApp() {
        console.log("Initializing Zed Supplier Directory with loading spinner...");
        
        if (!enforceSingleTab()) {
            return;
        }
        
        // Keep spinner visible, hide login overlay initially
        document.getElementById('loadingSpinner').style.display = 'flex';
        document.getElementById('loginOverlay').style.display = 'none';
        const userDocModal = document.getElementById('userDocumentViewerModal');
    if (userDocModal) {
        userDocModal.style.display = 'none';
    }
        
        try {
            await ensureDefaultUsers();
            await getAllUsers(true);
            
            startRealtimeApprovalListener();
            
            ['complianceTpin', 'complianceNapsa', 'complianceZra', 'complianceZppa'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', updateComplianceUI);
                }
            });
            
            // Login fields are EMPTY
            const userIn = document.getElementById('userIn');
            const passIn = document.getElementById('passIn');
            if (userIn) userIn.value = '';
            if (passIn) passIn.value = '';
            
            const savedUser = localStorage.getItem('logged_user');
            
            if (savedUser) {
                const user = getUser(savedUser);
                if (user && user.enabled) {
                    localStorage.setItem('last_login', new Date().toDateString());
                    
                    await loadAllData(false);
                    await initializeFirestoreCollections();
                    await loadApprovalRequests();
                    
                    if (user.id) {
                        await db.collection(COLLECTIONS.USERS).doc(user.id).update({
                            lastActive: new Date().toISOString()
                        });
                    }
                    
                    // Hide spinner and show home
                    hideLoadingSpinner();
                    document.getElementById('loginOverlay').style.display = 'none';
                    
                    updateGreeting();
                    updateUserDisplay();
                    applyRoleBasedUI();
                    showView('home');
                    
                    startSessionHeartbeat();
                    
                    if (isSystemLocked() && canAccessLockedSystem()) {
                        document.getElementById('timeWarning').style.display = 'block';
                        setTimeout(() => {
                            document.getElementById('timeWarning').style.display = 'none';
                        }, 5000);
                    }
                } else {
                    // Invalid saved user - show login
                    localStorage.removeItem('logged_user');
                    localStorage.removeItem('last_login');
                    hideLoadingSpinner();
                    document.getElementById('loginOverlay').style.display = 'flex';
                }
            } else {
                // No saved user - show login
                hideLoadingSpinner();
                document.getElementById('loginOverlay').style.display = 'flex';
            }
        } catch (error) {
            console.error("Initialization error:", error);
            // On error, show login
            hideLoadingSpinner();
            document.getElementById('loginOverlay').style.display = 'flex';
        }

        setInterval(syncBG, 5000);
        setInterval(updateDashboardStatus, 1000);
        syncBG();
        updateDashboardStatus();

        const passInField = document.getElementById('passIn');
        if (passInField) {
            passInField.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
        }
        
        console.log("‚úÖ Initialization complete");
    }

    window.onload = initializeApp;
</script>

<!-- FOOTER -->
<footer style="text-align:center; padding: 40px; background: #333; color: white; margin-top: 40px;">
    <img src="./images/logo1.png" width="130" height="50" alt="ZAMCOM" onerror="this.style.display='none';">
    <p>Designed by Joseph Zulu <br> Zed Supplier Directory <br>Procurement Departments<br> ¬© 2026 - Present</p>
    <a href="#headerSection" style="color: var(--primary-green); text-decoration: none;">Back to Top</a>
</footer>

</body>
</html>

