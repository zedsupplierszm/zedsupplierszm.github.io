<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZAMCOM Supplier Directory</title>
    <style>
        :root {
            --primary-green: #4CAF50;
            --danger-red: #ff4d4d;
            --link-blue: #007bff;
            --nav-yellow: #ffe400;
            --grid-gap: 15px;
            --border-radius: 12px;
            --transition-speed: 0.3s;
            --warning-orange: #ff9800;
            --star-color: #FFD700;
            --star-empty: #ddd;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 0;
        }

        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a1a, #333);
            z-index: 20000; display: none; justify-content: center; align-items: center;
        }

        .login-card {
            background: white; padding: 40px; border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 350px; text-align: center;
        }

        .login-card img { margin-bottom: 20px; }
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .login-card h2 { margin-top: 0; color: #333; }
        
        .pass-wrapper { position: relative; }
        .toggle-pass { 
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
            cursor: pointer; font-size: 18px; color: #777; 
        }

        .topmenu {
            width: 100%; padding: 20px 0; color: white; text-align: center;
            background-size: cover; background-position: center;
            transition: background-image 1.5s ease-in-out;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }

        .top-nav {
            list-style: none; padding: 0; background: #333; margin: 0;
            display: flex; justify-content: center; flex-wrap: wrap;
        }

        .top-nav li a {
            display: block; padding: 15px 25px; text-decoration: none;
            font-weight: bold; color: white; transition: 0.3s; cursor: pointer;
        }

        .top-nav li a:hover { color: var(--nav-yellow); }

        .admin-controls {
            background: #fff; padding: 15px; text-align: center;
            border-bottom: 1px solid #ddd; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;
        }

        .grid-section { padding: 40px 20px; max-width: 1200px; margin: 0 auto; }
        .grid-container {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: var(--grid-gap); width: 100%;
        }

        .grid-item {
            background: #3CB8F4; border-radius: var(--border-radius); overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform var(--transition-speed) ease;
            text-decoration: none; color: #333; display: flex; flex-direction: column; cursor: pointer;
        }

        .grid-item img { width: 100%; height: 140px; object-fit: cover; }
        .grid-item span { padding: 15px; text-align: center; font-weight: 600; font-size: 0.9rem; background: white; }
        .grid-item:hover { transform: translateY(-5px); box-shadow: 0 15px 25px rgba(0,0,0,0.20); }

        #categoryPageView, #aboutView, #contactView, #linksView { 
            display: none; 
            padding: 40px 20px; 
            max-width: 1300px; 
            margin: 0 auto; 
        }
        
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; font-size: 14px; }
        .data-table th, .data-table td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        .data-table th { background: var(--primary-green); color: white; }
        .data-table a { color: var(--link-blue); text-decoration: none; font-weight: bold; }

        .compliance-pill { 
            display: inline-block; padding: 4px 8px; border-radius: 50px; 
            font-size: 10px; font-weight: bold; color: white; margin: 2px;
            text-transform: uppercase;
        }
        .comp-ok { background: #2ecc71; }
        .comp-bad { background: #e74c3c; }
        .comp-expired { background: #f39c12; }

        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-add { background: var(--primary-green); }
        .btn-back { background: #607d8b; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-bottom: 20px; font-weight: bold;}
        .btn-edit { background: #f39c12; padding: 5px 10px; font-size: 12px; border-radius: 4px; color: white; border: none; }
        .btn-del { background: var(--danger-red); padding: 5px 10px; font-size: 12px; border-radius: 4px; color: white; border: none; }

        .modal {
            display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center;
        }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 450px; max-height: 80vh; overflow-y: auto; }

        .audit-container { max-height: 400px; overflow-y: auto; text-align: left; border: 1px solid #eee; padding: 10px; border-radius: 5px; }
        .log-entry { padding: 8px; border-bottom: 1px solid #f9f9f9; display: flex; justify-content: space-between; font-size: 12px; }
        .log-user { font-weight: bold; color: var(--primary-green); }
        .log-action { color: #444; margin-left: 5px; }
        .log-time { color: #999; font-style: italic; }

        .modified-by-container {
            position: relative;
            display: inline-block;
        }
        
        .modified-by-display {
            cursor: pointer;
            padding: 5px 10px;
            background: #f0f0f0;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
        }
        
        .modified-by-display:hover {
            background: #e0e0e0;
        }
        
        .dropdown-arrow {
            font-size: 10px;
            color: #666;
        }
        
        .history-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 250px;
            max-width: 300px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 100;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-dropdown.show {
            display: block;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #f5f5f5;
            font-size: 12px;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-user {
            font-weight: bold;
            color: var(--primary-green);
        }
        
        .history-date {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }
        
        .history-action {
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }

        .role-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .role-admin {
            background: #e74c3c;
            color: white;
        }
        
        .role-staff {
            background: #3498db;
            color: white;
        }
        
        .user-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-online {
            background: #2ecc71;
        }
        
        .status-offline {
            background: #95a5a6;
        }

        .certificate-upload {
            margin: 10px 0;
            padding: 10px;
            border: 1px dashed #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        
        .certificate-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .certificate-item {
            width: 100px;
            text-align: center;
            font-size: 10px;
        }
        
        .certificate-thumbnail {
            width: 100px;
            height: 80px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        .certificate-name {
            word-break: break-word;
            margin-top: 5px;
        }
        
        .remove-certificate {
            background: var(--danger-red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            position: absolute;
            margin-left: -10px;
            margin-top: -10px;
        }

        .vertical-life-bar-container {
            width: 20px;
            height: 60px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 1px solid #ddd;
            margin: 0 auto;
        }
        
        .vertical-life-bar-fill {
            width: 100%;
            background: linear-gradient(to top, #2ecc71, #4CAF50);
            transition: height 0.5s ease;
            border-radius: 10px;
            position: absolute;
            bottom: 0;
        }
        
        .vertical-life-bar-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: #333;
            writing-mode: vertical-lr;
            text-orientation: mixed;
        }
        
        .vertical-life-bar-expiring {
            background: linear-gradient(to top, #ff9800, #ff5722);
        }
        
        .vertical-life-bar-expired {
            background: linear-gradient(to top, #f44336, #e74c3c);
        }

        .sessions-panel {
            position: fixed;
            top: 100px;
            right: 20px;
            width: 250px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        
        .sessions-header {
            background: var(--primary-green);
            color: white;
            padding: 10px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sessions-body {
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .session-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .session-user {
            display: flex;
            align-items: center;
        }
        
        .session-time {
            font-size: 10px;
            color: #888;
        }

        .pulse-online {
            background: #2ecc71;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }

        .about-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin: 0 auto;
            max-width: 1000px;
        }
        
        .mission-vision-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin: 30px 0;
        }
        
        .mv-box {
            padding: 20px;
            border-left: 5px solid var(--primary-green);
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .staff-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-top: 30px;
        }
        
        .staff-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #eee;
        }
        
        .staff-card img {
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-green);
        }

        .controls-container {
            width: 95%;
            margin: 0 auto;
            display: flex;
            gap: 10px;
            padding: 10px 0;
        }

        .document-thumbnail {
            display: inline-block;
            position: relative;
            margin: 2px;
        }

        .document-icon {
            width: 24px;
            height: 24px;
            background: var(--primary-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .document-icon:hover {
            background: #45a049;
            transform: scale(1.1);
        }

        .document-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 20000;
            justify-content: center;
            align-items: center;
        }

        .document-viewer-content {
            width: 90%;
            height: 90%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .document-viewer-header {
            padding: 15px;
            background: var(--primary-green);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .document-viewer-body {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: auto;
        }

        .document-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .pdf-viewer {
            width: 100%;
            height: 100%;
            border: none;
        }

        .document-thumbnail-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .document-thumbnail-item {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
        }

        .document-thumbnail-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .document-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-red);
            color: white;
            font-size: 10px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            gap: 10px;
        }
        
        .page-btn {
            padding: 5px 12px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .page-btn:hover {
            background: #e0e0e0;
        }
        
        .page-btn.active {
            background: var(--primary-green);
            color: white;
            border-color: var(--primary-green);
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .compact-table th, .compact-table td {
            padding: 8px 10px !important;
            font-size: 13px !important;
        }
        
        .compact-table .compliance-box {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .supplier-images-preview {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .image-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid #ddd;
            transition: all 0.3s ease;
        }
        
        .image-thumbnail:hover {
            border-color: var(--primary-green);
            transform: scale(1.05);
        }
        
        .image-gallery-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 20001;
            justify-content: center;
            align-items: center;
        }
        
        .image-gallery-content {
            position: relative;
            width: 90%;
            height: 90%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .gallery-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: opacity 0.3s ease;
        }
        
        .gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .gallery-nav:hover {
            background: rgba(0, 0, 0, 0.8);
        }
        
        .gallery-prev {
            left: 20px;
        }
        
        .gallery-next {
            right: 20px;
        }
        
        .gallery-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            z-index: 10;
        }
        
        .gallery-close:hover {
            background: rgba(0, 0, 0, 0.8);
        }
        
        .image-counter {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .star-rating {
            display: inline-flex;
            gap: 2px;
        }
        
        .star {
            font-size: 16px;
            cursor: pointer;
            color: var(--star-empty);
            transition: color 0.2s;
        }
        
        .star.filled {
            color: var(--star-color);
        }
        
        .star-rating-view {
            display: inline-flex;
            gap: 2px;
            font-size: 12px;
        }
        
        .star-view {
            color: var(--star-color);
        }
        
        .star-empty-view {
            color: var(--star-empty);
        }
        
        .rating-value {
            margin-left: 5px;
            font-weight: bold;
            color: #333;
        }

        .user-contact-fields {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            background: #f9f9f9;
        }
        
        .user-contact-fields input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #4CAF50;
            color: white;
            border-radius: 5px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
            display: none;
        }
        
        .notification.error { background: #f44336; }
        .notification.warning { background: #ff9800; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 900px) { 
            .grid-container { grid-template-columns: repeat(2, 1fr); } 
            .top-nav { flex-direction: column; }
            .admin-controls { flex-direction: column; }
            .sessions-panel { position: static; width: 100%; margin: 10px 0; }
            .mission-vision-grid { grid-template-columns: 1fr; }
            .staff-section { grid-template-columns: 1fr; }
            .compact-table th, .compact-table td {
                padding: 6px 8px !important;
                font-size: 12px !important;
            }
        }
    </style>
</head>
<body>

<div id="timeWarning" style="display: none; position: fixed; top: 0; left: 0; width: 100%; background: #ff4d4d; color: white; text-align: center; padding: 15px; z-index: 30000; font-weight: bold; border-bottom: 2px solid #fff;">
    ‚ö†Ô∏è SYSTEM ALERT: Scheduled lockout at 16:50. Please save your work!
</div>

<div id="loginOverlay">
    <div class="login-card">
        <img src="./images/mainlogo.png" width="100">
        
        <div id="lockStatusContent" style="display: none;">
            <h2 style="color: #ff4d4d;">System Locked</h2>
            <p style="color: #666; font-size: 14px;">Access resumes in:</p>
            <div id="countdownClock" style="font-size: 2.5rem; font-weight: bold; color: #333; margin: 20px 0; font-family: 'Courier New', Courier, monospace; letter-spacing: 2px;">
                00:00:00
            </div>
            <p style="font-size: 12px; color: #888;">Operating Hours: 07:30 - 16:50 CAT</p>
            <p id="lockMessage" style="font-size: 12px; color: #666; margin-top: 10px;"></p>
        </div>

        <div id="loginFieldsContent">
            <h2>System Login</h2>
            <input type="text" id="userIn" placeholder="Username">
            <div class="pass-wrapper">
                <input type="password" id="passIn" placeholder="Password">
                <span class="toggle-pass" onclick="togglePassword()">üëÅÔ∏è</span>
            </div>
            <button class="btn btn-add" style="width: 100%; margin-top: 10px;" onclick="handleLogin()">Login</button>
            <p style="font-size: 12px; margin-top: 15px; color: #666; cursor: pointer;" onclick="forgotPasswordSimple()">Forgot Password?</p>
        </div>
    </div>
</div>

<div id="imageGalleryModal" class="image-gallery-modal">
    <div class="image-gallery-content">
        <button class="gallery-close" onclick="closeImageGallery()">‚úï</button>
        <button class="gallery-nav gallery-prev" onclick="prevImage()">‚Äπ</button>
        <img id="galleryCurrentImage" class="gallery-image" src="" alt="">
        <button class="gallery-nav gallery-next" onclick="nextImage()">‚Ä∫</button>
        <div class="image-counter" id="imageCounter">1 / 1</div>
    </div>
</div>

<div class="topmenu" id="headerSection">
    <img src="./images/mainlogo.png" width="120">
    <h1>ZAMCOM SUPPLIER DIRECTORY</h1>
    <h2>PROCUREMENT</h2>
    <marquee style="background: rgba(0,0,0,0.3); padding: 2px 0; margin-top: 2px;">Right Quality - Right Quantity - Right Time - Right Price - Right Place</marquee>
    <h4 id="greeting" style="margin-top:20px;"> <i> Welcome </i> </h4>
</div>

<ul class="top-nav">
    <li><a onclick="showView('home')">HOME</a></li>
    <li><a onclick="showView('links')">LINKS</a></li>
    <li><a onclick="showView('contact')">CONTACT US</a></li>
    <li><a onclick="showView('about')">ABOUT US</a></li>
    <li><a onclick="logout()" style="background: #888;">LOGOUT</a></li>
    <button class="btn" style="background:#455A64; margin: 10px;" onclick="showAuditLogs()">üìú View Logs</button>
    <button id="userMgmtBtn" class="btn" style="background:#e67e22; margin: 10px; display:none;" onclick="manageUsersModal()">üë• User Management</button>
    <button id="sessionsBtn" class="btn" style="background:#9b59b6; margin: 10px; display:none;" onclick="toggleSessionsPanel()">üëÅÔ∏è Active Sessions</button>
    <button id="syncSettingsBtn" class="btn" style="background:#2196F3; margin: 10px;" onclick="showSyncSettings()">‚òÅÔ∏è Sync Settings</button>
</ul>

<div id="backupStatus" style="text-align: center; font-size: 12px; color: #666; margin: 10px 0;">
    Last Backup: <span id="lastBackupDate">Never</span>
</div>

<div id="systemStatusHeader" style="background: #fff; padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; px-20px;">
    <div style="display: flex; align-items: center; gap: 10px; margin-left: 20px;">
        <span id="statusDot" style="height: 12px; width: 12px; border-radius: 50%; display: inline-block;"></span>
        <span id="statusText" style="font-weight: bold; font-size: 14px;">Checking Status...</span>
    </div>
    <div style="display: flex; align-items: center; gap: 15px;">
        <div id="currentUserInfo" style="font-size: 12px; color: #555;">
            <span id="currentUserDisplay">Not logged in</span>
            <span id="userRoleBadge" style="display: none;"></span>
        </div>
        <div id="liveClock" style="font-family: monospace; font-weight: bold; color: #555;"></div>
    </div>
</div>

<div id="documentViewerModal" class="document-viewer-modal">
    <div class="document-viewer-content">
        <div class="document-viewer-header">
            <span id="documentViewerTitle">Supplier Documents</span>
            <button onclick="closeDocumentViewer()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">‚úï</button>
        </div>
        <div class="document-viewer-body" id="documentViewerBody">
        </div>
    </div>
</div>

<div id="homeView" class="grid-section">
    <div class="admin-controls">
        <button class="btn btn-add" onclick="openModal('category')">+ New Category</button>
        <button class="btn btn-add" style="background:#3498db" onclick="openModal('supplier')">+ New Supplier</button>
        
        <input type="text" id="globalSearch" placeholder="üîç Search Supplier Name..." 
               style="padding: 10px; border-radius: 5px; border: 1px solid #ddd; width: 250px;" 
               onkeyup="filterEverything()">

        <button class="btn" style="background:#607d8b" onclick="exportData()">üíæ Export Backup</button>
        <button class="btn" style="background:#9c27b0" onclick="document.getElementById('importFile').click()">üì• Import & Merge</button>
        <input type="file" id="importFile" style="display:none" multiple onchange="importData(event)">
    </div>

    <div id="defaultHomeContent">
        <h2 style="text-align:center; color: #333;">Supplier Categories</h2>
        <div class="grid-container" id="categoryGrid"></div>
    </div>

    <div id="searchResultSection" style="display:none;">
        <h2 style="text-align:center; color: var(--primary-green);">Search Results</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Supplier Name</th>
                    <th>Category</th>
                    <th>Specialization</th>
                    <th>Phone</th>
                    <th>Rating</th>
                    <th>Renewal Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="globalSearchResultsBody"></tbody>
        </table>
    </div>
</div>

<div id="categoryPageView">
    <h2 id="categoryTitle" style="color: #333;">Category Name</h2>
    <div id="complianceBanner"
     style="display:none; margin:15px 0; padding:12px;
            background:#ff4d4d; color:white; border-radius:8px;
            font-weight:bold; text-align:center;">
    ‚ö†Ô∏è WARNING: This category contains NON-COMPLIANT or EXPIRED suppliers.
</div>
    <button class="btn-back" onclick="showView('home')">‚Üê Back to Home</button>
    <div style="overflow-x: auto;">
        <table class="data-table compact-table">
            <thead>
                <tr>
                    <th>Supplier Name</th>
                    <th>Specialization</th>
                    <th>Phone</th>
                    <th>T-PIN</th>
                    <th>Email</th>
                    <th>Address</th>
                    <th>Rating</th>
                    <th>Compliance</th>
                    <th style="width: 40px;">Renewal</th>
                    <th style="width: 40px;">Docs</th>
                    <th style="width: 40px;">Images</th>
                    <th style="width: 80px;">Modified</th>
                    <th style="width: 80px;">Actions</th>
                </tr>
            </thead>
            <tbody id="supplierTableBody"></tbody>
        </table>
    </div>
</div>

<div id="aboutView">
    <div class="about-card">
        <h2 style="color: var(--primary-green); text-align: center;">About ZAMCOM Procurement</h2>
        <p style="color: #555; line-height: 1.6; padding-left : 30px; padding-right : 30px;" >
            The ZAMCOM Procurement Department is dedicated to the systematic acquisition of goods and services 
            that support the Zambia Institute of Mass Communication's mission. We ensure every kwacha spent 
            brings maximum value to our institution. 
        </p> 

        <div class="mission-vision-grid">
            <div class="mv-box">
                <h3 style="color: #2c3e50; padding-left : 30px; padding-right : 30px;">Our Mission </h3>
                <p style=" color: #555; line-height: 1.6; padding-left : 30px; padding-right : 30px;" >To deliver timely, transparent, and ethical procurement solutions through strategic sourcing and robust supplier relationship management.</p>
            </div>

            <div class="mv-box" style="border-left-color: var(--link-blue);">
                <h3 style="color: #2c3e50; padding-left : 30px; padding-right : 30px;">Our Vision</h3>
                <p style="color: #555; line-height: 1.6; padding-left : 30px; padding-right : 30px;">To lead ZAMCOM into a new era of digital procurement excellence, fostering growth for local and international suppliers.</p>
            </div>
        </div>

        <h2 style="text-align: center; color: #2c3e50;">Our Leadership</h2>
        <div class="staff-section">
            <div class="staff-card">
                <center>
                <img src="./images/mainlogo3.png" alt="Chishala Lusaka" width="130" height="130" >
                <h3>Chishala Lusaka</h3>
                <p>Procurement Officer <br> Expertise: Contract Management & Compliance</p>
                </center>
            </div>
           
            <div class="staff-card">
                <center>
                <img src="./images/josephprofile.jpg" alt="Joseph Zulu" width="130" height="130">
                <h3>Joseph Zulu</h3>
                <p>Procurement Officer <br> Expertise: Supplier Relations & Compliance</p>
                </center>
            </div>
        </div>
    </div>
</div>

<div id="contactView" style="padding: 40px 20px; max-width: 1000px; margin: 0 auto;">
    <div class="about-card">
        <h2 style="color: var(--primary-green); text-align: center;">Contact Information</h2>
        <p style="color: #555; line-height: 1.6; padding-left : 30px; padding-right : 30px;" >
            Welcome to the ZAMCOM Supplier Directory. This system was developed by Joseph Zulu, with a purpose to create a single directory where we can find all our most trusted vendors and suppliers. For more information, you can contact the developer on the contact details below:<br><br>
            - Office Location: Plot No. 3529, Government Road, Ridgeway, Lusaka, Zambia.<br>
            - General Inquiries: zulujosephp@gmail.com<br>
            - Phone: +260973031254<br>
        </p> 
    </div>
</div>

<div id="linksView" style="padding: 20px;">
    <h2>Links Management</h2>
    <div class="controls-container">
        <button class="btn btn-add" onclick="openLinkModal()">+ Add New Link</button>
    </div>
    
    <table class="data-table" id="linksTable">
        <thead>
            <tr>
                <th>Institution</th>
                <th>Website</th>
                <th>Email Address</th>
                <th style="width: 80px;">Action</th>
            </tr>
        </thead>
        <tbody id="linksBody"></tbody>
    </table>
</div>

<div id="sessionsPanel" class="sessions-panel">
    <div class="sessions-header">
        <span>üë• Active Sessions</span>
        <button onclick="toggleSessionsPanel()" style="background: none; border: none; color: white; cursor: pointer;">‚úï</button>
    </div>
    <div class="sessions-body" id="activeSessionsList">
        <div style="padding: 10px; text-align: center; color: #888;">Loading...</div>
    </div>
</div>

<div id="modalOverlay" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Add New</h3>
        <div id="modalFields"></div>
        <button class="btn btn-add" id="modalSaveBtn" style="width:100%">Save Changes</button>
        <button onclick="closeModal()" class="btn" style="background:#777; width:100%; margin-top:5px;">Close</button>
    </div>
</div>

<div id="linkModal" class="modal">
    <div class="modal-content">
        <h3>Add New Institution</h3>
        <input type="text" id="instName" placeholder="Institution Name">
        <input type="text" id="instWeb" placeholder="Website (e.g., www.site.com)">
        <input type="email" id="instEmail" placeholder="Email Address">
        <button class="btn btn-add" style="width:100%" onclick="addLink()">Save Link</button>
        <button class="btn" style="background:#ccc; width:100%; margin-top:5px;" onclick="closeLinkModal()">Close</button>
    </div>
</div>

<!-- Add Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCJrqk15bvd1746VkkDAcOM_U9w0PH7dP0",
        authDomain: "supplierdirectory-6e5c7.firebaseapp.com",
        projectId: "supplierdirectory-6e5c7",
        storageBucket: "supplierdirectory-6e5c7.firebasestorage.app",
        messagingSenderId: "434327330685",
        appId: "1:434327330685:web:6ac7e874dc5952a89c3614"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // Global variables
    let categories = [];
    let suppliers = [];
    let links = [];
    let userAccounts = [];
    let currentCategory = "";
    let currentGalleryImages = [];
    let currentGalleryIndex = 0;
    let currentRatingValue = 0;
    let bgIndex = 0;

    const bgImages = [
        './images/background1.jpg',
        './images/background2.jpg',
        './images/background3.jpg'
    ];

    // System constants
    const LOCK_TIME = { hr: 16, min: 50 };
    const OPEN_TIME = { hr: 7, min: 30 };
    const WARNING_TIME = { hr: 16, min: 30 };
    const MAX_LOGIN_ATTEMPTS = 3;
    const LOCK_DURATION_MINUTES = 10;
    const MAX_IMAGE_SIZE = 3 * 1024 * 1024;
    
    const USER_ROLES = {
        ADMIN: 'admin',
        STAFF: 'staff'
    };

    // Firebase collections
    const COLLECTIONS = {
        USERS: 'users',
        CATEGORIES: 'categories',
        SUPPLIERS: 'suppliers',
        LINKS: 'links',
        AUDIT_LOGS: 'audit_logs',
        SESSIONS: 'sessions'
    };

    // ==================== FIREBASE FUNCTIONS ====================

    async function getAllUsers() {
        try {
            const snapshot = await db.collection(COLLECTIONS.USERS).get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) {
            console.error("Error getting users:", error);
            return [];
        }
    }

    async function loadAllData() {
        try {
            console.log("Loading data from Firebase...");
            
            // Load users
            userAccounts = await getAllUsers();
            
            // Load categories
            const categoriesSnapshot = await db.collection(COLLECTIONS.CATEGORIES).get();
            categories = categoriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Load suppliers
            const suppliersSnapshot = await db.collection(COLLECTIONS.SUPPLIERS).get();
            suppliers = suppliersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Load links
            const linksSnapshot = await db.collection(COLLECTIONS.LINKS).get();
            links = linksSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            return true;
        } catch (error) {
            console.error("Error loading data:", error);
            showNotification("Failed to load data from database", "error");
            return false;
        }
    }

    async function createDefaultUsers() {
        const defaultUsers = [
            { 
                username: "JOSEPH", 
                password: "RIGHTJOSEPH", 
                role: "super admin",
                enabled: true, 
                nrc: "123456/78/1", 
                email: "zulujosephp@gmail.com",
                phone: "+260973031254",
                createdAt: new Date().toISOString()
            },
            { 
                username: "CHISHALA", 
                password: "RIGHTCHISHALA", 
                role: "staff", 
                enabled: true,
                createdAt: new Date().toISOString()
            }
        ];
        
        for (const user of defaultUsers) {
            await db.collection(COLLECTIONS.USERS).add(user);
        }
        
        userAccounts = await getAllUsers();
    }

    async function initializeFirestoreCollections() {
        console.log("Checking/creating collections...");
        
        try {
            // Check if categories collection has documents
            const categoriesSnapshot = await db.collection(COLLECTIONS.CATEGORIES).limit(1).get();
            
            if (categoriesSnapshot.empty) {
                console.log("Creating default categories...");
                const defaultCategories = [
                    { name: "Stationery & Office Supplies", icon: "üìé", createdAt: new Date().toISOString() },
                    { name: "ICT Equipment & Services", icon: "üíª", createdAt: new Date().toISOString() },
                    { name: "Cleaning Services & Materials", icon: "üßπ", createdAt: new Date().toISOString() },
                    { name: "Catering & Refreshments", icon: "üçΩÔ∏è", createdAt: new Date().toISOString() },
                    { name: "Furniture & Furnishings", icon: "üõãÔ∏è", createdAt: new Date().toISOString() },
                    { name: "Printing & Publishing", icon: "üñ®Ô∏è", createdAt: new Date().toISOString() },
                    { name: "Construction & Maintenance", icon: "üî®", createdAt: new Date().toISOString() },
                    { name: "Transport & Logistics", icon: "üöö", createdAt: new Date().toISOString() },
                    { name: "Consultancy Services", icon: "üíº", createdAt: new Date().toISOString() },
                    { name: "Security Services", icon: "üîí", createdAt: new Date().toISOString() }
                ];
                
                for (const category of defaultCategories) {
                    await db.collection(COLLECTIONS.CATEGORIES).add(category);
                }
                
                const newSnapshot = await db.collection(COLLECTIONS.CATEGORIES).get();
                categories = newSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }
            
            // Check if links collection has documents
            const linksSnapshot = await db.collection(COLLECTIONS.LINKS).limit(1).get();
            if (linksSnapshot.empty) {
                console.log("Creating default links...");
                const defaultLinks = [
                    { 
                        institution: "Public Procurement Authority (PPA)", 
                        website: "https://www.ppa.org.zm", 
                        email: "info@ppa.org.zm",
                        createdAt: new Date().toISOString()
                    },
                    { 
                        institution: "Zambia Public Procurement Agency (ZPPA)", 
                        website: "https://www.zppa.org.zm", 
                        email: "director@zppa.org.zm",
                        createdAt: new Date().toISOString()
                    }
                ];
                
                for (const link of defaultLinks) {
                    await db.collection(COLLECTIONS.LINKS).add(link);
                }
                
                const newLinksSnapshot = await db.collection(COLLECTIONS.LINKS).get();
                links = newLinksSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }
            
            return true;
        } catch (error) {
            console.error("Error initializing collections:", error);
            return false;
        }
    }

    // ==================== CORE UI FUNCTIONS ====================

    function showView(viewName) {
        console.log(`Showing view: ${viewName}`);
        
        // Hide all views
        document.getElementById('homeView').style.display = 'none';
        document.getElementById('categoryPageView').style.display = 'none';
        document.getElementById('aboutView').style.display = 'none';
        document.getElementById('contactView').style.display = 'none';
        document.getElementById('linksView').style.display = 'none';
        
        // Also hide search results
        const searchSection = document.getElementById('searchResultSection');
        if (searchSection) searchSection.style.display = 'none';
        
        const defaultHomeContent = document.getElementById('defaultHomeContent');
        if (defaultHomeContent) defaultHomeContent.style.display = 'block';
        
        // Show selected view
        switch(viewName) {
            case 'home':
                document.getElementById('homeView').style.display = 'block';
                renderCategories();
                break;
            case 'category':
                document.getElementById('categoryPageView').style.display = 'block';
                break;
            case 'about':
                document.getElementById('aboutView').style.display = 'block';
                break;
            case 'contact':
                document.getElementById('contactView').style.display = 'block';
                break;
            case 'links':
                document.getElementById('linksView').style.display = 'block';
                renderLinks();
                break;
        }
    }

    function syncBG() {
        const header = document.getElementById('headerSection');
        if (!header) return;
        
        const currentImage = bgImages[bgIndex];
        
        const img = new Image();
        img.onload = function() {
            header.style.backgroundImage = `linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('${currentImage}')`;
        };
        img.onerror = function() {
            header.style.backgroundImage = 'linear-gradient(135deg, #1a237e, #4a148c)';
        };
        img.src = currentImage;
        
        bgIndex = (bgIndex + 1) % bgImages.length;
        
        const clockElement = document.getElementById('liveClock');
        if (clockElement) {
            const now = new Date();
            clockElement.textContent = now.toLocaleTimeString('en-US', { 
                hour12: true, 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
        }
    }

    function renderCategories() {
        console.log("Rendering categories...");
        
        const categoryGrid = document.getElementById('categoryGrid');
        if (!categoryGrid) return;
        
        if (!categories || categories.length === 0) {
            categoryGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #666; padding: 40px;">No categories found. Click "New Category" to add your first category!</p>';
            return;
        }
        
        categoryGrid.innerHTML = categories.map((cat, index) => {
            const imgIndex = (index % 5) + 1;
            return `
            <div class="grid-item" onclick="openCategoryPage('${cat.id}')" style="cursor: pointer;">
                <img src="./images/category_${imgIndex}.jpg" alt="${cat.name}" 
                     onerror="this.src='./images/mainlogo.png'">
                <span>${cat.icon || 'üìÅ'} ${cat.name}</span>
            </div>
            `;
        }).join('');
    }

    function openCategoryPage(categoryId) {
        console.log("Opening category:", categoryId);
        
        const category = categories.find(cat => cat.id === categoryId);
        if (!category) {
            alert("Category not found!");
            return;
        }
        
        currentCategory = category.name;
        document.getElementById('categoryTitle').textContent = category.name;
        
        const categorySuppliers = suppliers.filter(supplier => supplier.category === category.name);
        renderSuppliersTable(categorySuppliers);
        
        showView('category');
    }

    function renderSuppliersTable(suppliersList) {
        const tbody = document.getElementById('supplierTableBody');
        if (!tbody) return;
        
        if (!suppliersList || suppliersList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 20px; color: #666;">No suppliers found in this category.</td></tr>';
            return;
        }
        
        tbody.innerHTML = suppliersList.map(supplier => `
            <tr>
                <td>${supplier.name || ''}</td>
                <td>${supplier.specialization || ''}</td>
                <td>${supplier.phone || ''}</td>
                <td>${supplier.tpin || ''}</td>
                <td>${supplier.email || ''}</td>
                <td>${supplier.address || ''}</td>
                <td>
                    <div class="star-rating-view">
                        ${renderStars(supplier.rating || 0)}
                        <span class="rating-value">${supplier.rating || 0}/5</span>
                    </div>
                </td>
                <td>
                    <div class="compliance-box">
                        ${renderCompliancePills(supplier)}
                    </div>
                </td>
                <td>
                    <div class="vertical-life-bar-container">
                        <div class="vertical-life-bar-fill ${getRenewalStatusClass(supplier)}" 
                             style="height: ${calculateRenewalPercentage(supplier)}%"></div>
                        <div class="vertical-life-bar-text">${getDaysRemaining(supplier)}d</div>
                    </div>
                </td>
                <td>
                    <div class="document-thumbnail-grid">
                        ${renderDocumentThumbnails(supplier)}
                    </div>
                </td>
                <td>
                    <div class="supplier-images-preview">
                        ${renderImageThumbnails(supplier)}
                    </div>
                </td>
                <td>
                    <div class="modified-by-container">
                        <span class="modified-by-display">
                            <span class="user-status status-online"></span>
                            ${supplier.lastModifiedBy || 'System'}
                            <span class="dropdown-arrow">‚ñº</span>
                        </span>
                        <div class="history-dropdown">
                            <div class="history-item">
                                <span class="history-user">${supplier.lastModifiedBy || 'System'}</span>
                                <div class="history-date">${supplier.lastModifiedDate || 'Unknown date'}</div>
                                <div class="history-action">Last modified</div>
                            </div>
                        </div>
                    </div>
                </td>
                <td>
                    <button class="btn-edit" onclick="editSupplier('${supplier.id}')">Edit</button>
                    <button class="btn-del" onclick="deleteSupplier('${supplier.id}')">Delete</button>
                </td>
            </tr>
        `).join('');
    }

    function renderLinks() {
        const tbody = document.getElementById('linksBody');
        if (!tbody) return;
        
        if (!links || links.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No links found.</td></tr>';
            return;
        }
        
        tbody.innerHTML = links.map(link => `
            <tr>
                <td>${link.institution || ''}</td>
                <td><a href="${link.website}" target="_blank">${link.website}</a></td>
                <td>${link.email || ''}</td>
                <td>
                    <button class="btn-del" onclick="deleteLink('${link.id}')">Delete</button>
                </td>
            </tr>
        `).join('');
    }

    // ==================== HELPER FUNCTIONS ====================

    function renderStars(rating) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            stars += `<span class="star-view ${i <= rating ? 'filled' : 'star-empty-view'}">‚òÖ</span>`;
        }
        return stars;
    }

    function renderCompliancePills(supplier) {
        if (!supplier.compliance) return '<span class="compliance-pill comp-bad">NO DATA</span>';
        
        const pills = [];
        if (supplier.compliance.tpin === 'yes') pills.push('<span class="compliance-pill comp-ok">TPIN</span>');
        else pills.push('<span class="compliance-pill comp-bad">TPIN</span>');
        
        if (supplier.compliance.napsa === 'yes') pills.push('<span class="compliance-pill comp-ok">NAPSA</span>');
        else pills.push('<span class="compliance-pill comp-bad">NAPSA</span>');
        
        if (supplier.compliance.zra === 'yes') pills.push('<span class="compliance-pill comp-ok">ZRA</span>');
        else pills.push('<span class="compliance-pill comp-bad">ZRA</span>');
        
        return pills.join('');
    }

    function getRenewalStatusClass(supplier) {
        if (!supplier.renewalDate) return 'expired';
        const days = getDaysRemaining(supplier);
        if (days < 0) return 'expired';
        if (days < 30) return 'expiring';
        return '';
    }

    function calculateRenewalPercentage(supplier) {
        if (!supplier.renewalDate) return 0;
        const days = getDaysRemaining(supplier);
        if (days < 0) return 0;
        if (days > 365) return 100;
        return Math.min(100, (days / 365) * 100);
    }

    function getDaysRemaining(supplier) {
        if (!supplier.renewalDate) return 0;
        const today = new Date();
        const renewal = new Date(supplier.renewalDate);
        const diff = renewal - today;
        return Math.ceil(diff / (1000 * 60 * 60 * 24));
    }

    function renderDocumentThumbnails(supplier) {
        if (!supplier.documents || supplier.documents.length === 0) {
            return '<span style="color:#999;">None</span>';
        }
        return `
            <div class="document-thumbnail-item" onclick="viewDocuments('${supplier.id}')">
                <div class="document-icon">üìÑ</div>
                <div class="document-count">${supplier.documents.length}</div>
            </div>
        `;
    }

    function renderImageThumbnails(supplier) {
        if (!supplier.images || supplier.images.length === 0) {
            return '<span style="color:#999;">No images</span>';
        }
        return supplier.images.slice(0, 3).map((img, idx) => `
            <img src="${img}" class="image-thumbnail" 
                 onclick="openImageGallery('${supplier.id}', ${idx})"
                 onerror="this.src='./images/mainlogo.png'">
        `).join('');
    }

    function getCurrentUser() {
        return localStorage.getItem('logged_user') || null;
    }

    function getUser(username) {
        if (!userAccounts || userAccounts.length === 0) return null;
        return userAccounts.find(u => u.username === username.toUpperCase());
    }

    function isCurrentUserAdmin() {
        const currentUser = getCurrentUser();
        if (!currentUser) return false;
        const user = getUser(currentUser);
        return user && (user.role === 'super admin' || user.role === USER_ROLES.ADMIN);
    }

    function showNotification(message, type = 'success') {
        let notification = document.getElementById('notification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'notification';
            notification.className = 'notification';
            document.body.appendChild(notification);
        }
        
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 5000);
    }

    // ==================== LOGIN FUNCTIONS ====================

    function isSystemLocked() {
        const currentUser = getCurrentUser();
        if(currentUser === "JOSEPH") return false;
        
        const now = new Date();
        const currentTotal = (now.getHours() * 60) + now.getMinutes();
        const lockTotal = (LOCK_TIME.hr * 60) + LOCK_TIME.min;
        const openTotal = (OPEN_TIME.hr * 60) + OPEN_TIME.min;

        return (currentTotal >= lockTotal || currentTotal < openTotal);
    }

    function togglePassword() {
        const pField = document.getElementById('passIn');
        if (pField) {
            pField.type = pField.type === "password" ? "text" : "password";
        }
    }

    async function handleLogin() {
        const usernameField = document.getElementById('userIn');
        const passwordField = document.getElementById('passIn');
        
        if (!usernameField || !passwordField) {
            alert("Login form not found!");
            return;
        }

        if (isSystemLocked()) {
            const currentUser = usernameField.value.toUpperCase().trim();
            if (currentUser !== "JOSEPH") {
                alert("Access Denied: The system is currently locked. Operating hours: 07:30 to 16:50 CAT.");
                return;
            }
        }

        const u = usernameField.value.toUpperCase().trim();
        const p = passwordField.value.trim();

        if (!u) {
            alert("Username required.");
            return;
        }

        try {
            console.log("Attempting login for user:", u);
            
            const usersRef = db.collection(COLLECTIONS.USERS);
            const query = usersRef.where('username', '==', u);
            const querySnapshot = await query.get();
            
            if (querySnapshot.empty) {
                console.log("User not found:", u);
                alert("Invalid username or password!");
                return;
            }
            
            const userDoc = querySnapshot.docs[0];
            const user = userDoc.data();
            
            if (!user.enabled) {
                alert("This account has been disabled. Please contact the administrator.");
                return;
            }

            if (user.password === p) {
                console.log("Login successful for user:", u);
                
                // Set session
                localStorage.setItem('logged_user', u);
                localStorage.setItem('last_login', new Date().toDateString());
                
                // Hide login overlay
                const loginOverlay = document.getElementById('loginOverlay');
                if (loginOverlay) {
                    loginOverlay.style.display = 'none';
                }

                // Load all data
                await loadAllData();
                await initializeFirestoreCollections();
                
                // Update UI
                updateGreeting();
                updateUserDisplay();
                
                // Show admin buttons if applicable
                const isAdmin = isCurrentUserAdmin();
                const userMgmtBtn = document.getElementById('userMgmtBtn');
                const sessionsBtn = document.getElementById('sessionsBtn');
                const syncSettingsBtn = document.getElementById('syncSettingsBtn');
                
                if (userMgmtBtn) userMgmtBtn.style.display = isAdmin ? 'inline-block' : 'none';
                if (sessionsBtn) sessionsBtn.style.display = isAdmin ? 'inline-block' : 'none';
                if (syncSettingsBtn) syncSettingsBtn.style.display = 'inline-block';
                
                // Show home view
                showView('home');
                
                showNotification(`Welcome, ${u}!`, 'success');
            } else {
                console.log("Invalid password for user:", u);
                alert("Invalid Username or Password!");
            }
        } catch (error) {
            console.error("Login error:", error);
            alert("Login failed. Error: " + error.message);
        }
    }

    function logout() {
        localStorage.removeItem('logged_user');
        localStorage.removeItem('last_login');
        
        const loginOverlay = document.getElementById('loginOverlay');
        if (loginOverlay) {
            loginOverlay.style.display = 'flex';
            
            // Clear login form
            const usernameField = document.getElementById('userIn');
            const passwordField = document.getElementById('passIn');
            if (usernameField) usernameField.value = '';
            if (passwordField) passwordField.value = '';
        }
        
        // Hide all views
        showView('home'); // This will hide views but home will be empty
        document.getElementById('homeView').style.display = 'none';
        
        showNotification('Logged out successfully', 'success');
    }

    function updateGreeting() {
        const hour = new Date().getHours();
        const user = getCurrentUser() || 'User';
        const msg = hour < 12 ? "Good Morning" : hour < 18 ? "Good Afternoon" : "Good Evening";
        const greetingEl = document.getElementById('greeting');
        if (greetingEl) greetingEl.innerHTML = `<i>${msg}, ${user}</i>`;
    }

    function updateUserDisplay() {
        const currentUser = getCurrentUser();
        const userInfo = document.getElementById('currentUserDisplay');
        const roleBadge = document.getElementById('userRoleBadge');
        
        if (currentUser && userInfo && roleBadge) {
            const user = getUser(currentUser);
            userInfo.textContent = currentUser;
            
            if (user) {
                roleBadge.textContent = user.role.toUpperCase();
                roleBadge.className = user.role === 'admin' || user.role === 'super admin' ? 'role-badge role-admin' : 'role-badge role-staff';
                roleBadge.style.display = 'inline-block';
            }
        } else if (userInfo) {
            userInfo.textContent = 'Not logged in';
            if (roleBadge) roleBadge.style.display = 'none';
        }
    }

    // ==================== PLACEHOLDER FUNCTIONS ====================

    function openModal(type) {
        alert(`Open ${type} modal - Feature coming soon!`);
    }

    function editSupplier(id) {
        alert(`Edit supplier ${id} - Feature coming soon!`);
    }

    function deleteSupplier(id) {
        if (confirm('Are you sure you want to delete this supplier?')) {
            alert(`Delete supplier ${id} - Feature coming soon!`);
        }
    }

    function deleteLink(id) {
        if (confirm('Are you sure you want to delete this link?')) {
            alert(`Delete link ${id} - Feature coming soon!`);
        }
    }

    function openLinkModal() {
        const modal = document.getElementById('linkModal');
        if (modal) modal.style.display = 'flex';
    }

    function closeLinkModal() {
        const modal = document.getElementById('linkModal');
        if (modal) modal.style.display = 'none';
    }

    function addLink() {
        alert('Add link - Feature coming soon!');
        closeLinkModal();
    }

    function closeModal() {
        const modal = document.getElementById('modalOverlay');
        if (modal) modal.style.display = 'none';
    }

    function forgotPasswordSimple() {
        alert('Please contact the administrator at zulujosephp@gmail.com');
    }

    function filterEverything() {
        const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
        if (searchTerm.length < 2) {
            document.getElementById('searchResultSection').style.display = 'none';
            document.getElementById('defaultHomeContent').style.display = 'block';
            return;
        }
        
        const results = suppliers.filter(s => 
            s.name && s.name.toLowerCase().includes(searchTerm)
        );
        
        const tbody = document.getElementById('globalSearchResultsBody');
        tbody.innerHTML = results.map(s => `
            <tr>
                <td>${s.name}</td>
                <td>${s.category || ''}</td>
                <td>${s.specialization || ''}</td>
                <td>${s.phone || ''}</td>
                <td>${s.rating || 0}/5</td>
                <td>${getDaysRemaining(s)} days</td>
                <td>
                    <button class="btn-edit" onclick="editSupplier('${s.id}')">Edit</button>
                </td>
            </tr>
        `).join('');
        
        document.getElementById('defaultHomeContent').style.display = 'none';
        document.getElementById('searchResultSection').style.display = 'block';
    }

    function exportData() {
        alert('Export feature coming soon!');
    }

    function importData(event) {
        alert('Import feature coming soon!');
        if (event.target) event.target.value = '';
    }

    function showAuditLogs() {
        alert('Audit logs feature coming soon!');
    }

    function manageUsersModal() {
        alert('User management feature coming soon!');
    }

    function toggleSessionsPanel() {
        alert('Sessions panel feature coming soon!');
    }

    function showSyncSettings() {
        alert('Sync settings feature coming soon!');
    }

    function closeImageGallery() {
        document.getElementById('imageGalleryModal').style.display = 'none';
    }

    function closeDocumentViewer() {
        document.getElementById('documentViewerModal').style.display = 'none';
    }

    function openImageGallery(supplierId, imageIndex) {
        const supplier = suppliers.find(s => s.id === supplierId);
        if (supplier && supplier.images && supplier.images.length > 0) {
            currentGalleryImages = supplier.images;
            currentGalleryIndex = imageIndex;
            document.getElementById('galleryCurrentImage').src = supplier.images[imageIndex];
            document.getElementById('imageCounter').textContent = `${imageIndex + 1} / ${supplier.images.length}`;
            document.getElementById('imageGalleryModal').style.display = 'flex';
        }
    }

    function nextImage() {
        if (currentGalleryImages.length > 0) {
            currentGalleryIndex = (currentGalleryIndex + 1) % currentGalleryImages.length;
            document.getElementById('galleryCurrentImage').src = currentGalleryImages[currentGalleryIndex];
            document.getElementById('imageCounter').textContent = `${currentGalleryIndex + 1} / ${currentGalleryImages.length}`;
        }
    }

    function prevImage() {
        if (currentGalleryImages.length > 0) {
            currentGalleryIndex = (currentGalleryIndex - 1 + currentGalleryImages.length) % currentGalleryImages.length;
            document.getElementById('galleryCurrentImage').src = currentGalleryImages[currentGalleryIndex];
            document.getElementById('imageCounter').textContent = `${currentGalleryIndex + 1} / ${currentGalleryImages.length}`;
        }
    }

    function viewDocuments(supplierId) {
        alert(`View documents for supplier ${supplierId} - Feature coming soon!`);
    }

    function runTimeMonitoring() {
        // Placeholder for time monitoring
    }

    function updateDashboardStatus() {
        const now = new Date();
        const clockEl = document.getElementById('liveClock');
        if (clockEl) {
            clockEl.textContent = now.toLocaleTimeString('en-US', { 
                hour12: true, 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        
        if (statusDot && statusText) {
            if (isSystemLocked()) {
                statusDot.style.background = '#ff4d4d';
                statusText.textContent = 'System Locked';
            } else {
                statusDot.style.background = '#2ecc71';
                statusText.textContent = 'System Online';
            }
        }
        
        const currentUser = getCurrentUser();
        if (currentUser && currentUser !== 'Not logged in') {
            updateGreeting();
            updateUserDisplay();
        }
    }

    // ==================== INITIALIZATION ====================

    async function initializeApp() {
        console.log("Initializing app...");
        
        // Always show login overlay first
        const loginOverlay = document.getElementById('loginOverlay');
        if (loginOverlay) {
            loginOverlay.style.display = 'flex';
        }
        
        // Load initial data
        await loadAllData();
        
        // Create default users if none exist
        if (userAccounts.length === 0) {
            console.log("No users found, creating default users...");
            await createDefaultUsers();
            await loadAllData(); // Reload after creating
        }
        
        // Initialize collections
        await initializeFirestoreCollections();
        
        // Check for existing valid session
        const currentUser = getCurrentUser();
        const lastLogin = localStorage.getItem('last_login');
        const today = new Date().toDateString();
        
        if (currentUser && lastLogin === today) {
            const user = getUser(currentUser);
            if (user && user.enabled) {
                console.log("Valid session found for user:", currentUser);
                
                // Hide login overlay for valid session
                if (loginOverlay) {
                    loginOverlay.style.display = 'none';
                }
                
                // Update UI
                updateGreeting();
                updateUserDisplay();
                
                // Show admin buttons if applicable
                const isAdmin = isCurrentUserAdmin();
                const userMgmtBtn = document.getElementById('userMgmtBtn');
                const sessionsBtn = document.getElementById('sessionsBtn');
                const syncSettingsBtn = document.getElementById('syncSettingsBtn');
                
                if (userMgmtBtn) userMgmtBtn.style.display = isAdmin ? 'inline-block' : 'none';
                if (sessionsBtn) sessionsBtn.style.display = isAdmin ? 'inline-block' : 'none';
                if (syncSettingsBtn) syncSettingsBtn.style.display = 'inline-block';
                
                // Show home view
                showView('home');
            } else {
                // Invalid user or disabled account - clear session
                localStorage.removeItem('logged_user');
                localStorage.removeItem('last_login');
            }
        }
        
        // Start background processes
        setInterval(syncBG, 5000);
        setInterval(runTimeMonitoring, 30000);
        setInterval(updateDashboardStatus, 1000);
        
        // Initial updates
        syncBG();
        updateDashboardStatus();
        
        // Event listeners
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeImageGallery();
                closeDocumentViewer();
            }
        });
        
        // Enter key for login
        const passIn = document.getElementById('passIn');
        if (passIn) {
            passIn.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
        }
        
        const userIn = document.getElementById('userIn');
        if (userIn) {
            userIn.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('passIn').focus();
                }
            });
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const linkModal = document.getElementById('linkModal');
            const imageModal = document.getElementById('imageGalleryModal');
            const docModal = document.getElementById('documentViewerModal');
            
            if (event.target === linkModal) linkModal.style.display = 'none';
            if (event.target === imageModal) imageModal.style.display = 'none';
            if (event.target === docModal) docModal.style.display = 'none';
        };
    }

    // Start the app when page loads
    window.onload = initializeApp;
</script>

<footer style="text-align:center; padding: 40px; background: #333; color: white;">
    <img src="./images/logo1.png" width="130" height="50">
    <p>Designed by Joseph Zulu <br> ZAMCOM Procurement Department ¬© 2026 - Present</p>
    <a href="#headerSection" style="color:var(--primary-green)">Back to Top</a>
</footer>

</body>
</html>
