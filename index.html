<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1024">
    <title>Zed Supplier Directory</title>
    <style>
        :root {
            --primary-green: #173979;
            --danger-red: #ff4d4d;
            --link-blue: #007bff;
            --nav-yellow: #ffe400;
            --grid-gap: 20px;
            --border-radius: 16px;
            --transition-speed: 0.3s;
            --warning-orange: #ff9800;
            --star-color: #FFD700;
            --star-empty: #ddd;
            --card-bg: #ffffff;
            --soft-shadow: 0 12px 24px -8px rgba(0,0,0,0.08);
            --online-green: #2ecc71;
            --offline-grey: #95a5a6;
            --compliance-green: #2ecc71;
            --compliance-red: #e74c3c;
            --compliance-yellow: #f39c12;
        }

        * { 
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 0;
        }

        #loadingSpinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2f3f, #0f1a24);
            z-index: 30000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease;
        }

        .spinner-container {
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: fadeInScale 0.5s ease;
        }

        .spinner {
            width: 80px;
            height: 80px;
            margin: 0 auto 25px;
            border: 5px solid rgba(255, 255, 255, 1);
            border-top: 5px solid var(--primary-green);
            border-right: 5px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }

        
        #accountRequestModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a, #333); /* Same as login overlay */
            z-index: 50000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        #accountRequestModal .modal-content {
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        .history-row {
            background: transparent !important;
        }

        .history-row:hover {
            background: transparent !important;
        }

        .history-row td {
            border: none !important;
            padding: 0 !important;
            background: transparent !important;
        }

        .document-thumbnail {
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #f0f7f4, #e0ebe8);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .document-thumbnail:hover {
            transform: translateY(-4px);
            border-color: var(--primary-green);
            box-shadow: 0 8px 20px rgba(23, 57, 121, 0.15);
        }

        .document-thumbnail .count-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--primary-green);
            color: white;
            border-radius: 20px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: bold;
            min-width: 24px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(23, 57, 121, 0.3);
            border: 2px solid white;
        }

        .document-thumbnail .icon {
            font-size: 28px;
        }

        #documentViewerModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 50000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .document-viewer-container {
            width: 90%;
            height: 90%;
            background: white;
            border-radius: 32px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease;
        }

        .document-viewer-header {
            background: linear-gradient(135deg, var(--primary-green), #0f2a4a);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .document-viewer-header h3 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .document-viewer-header h3 span {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 0.9rem;
        }

        .document-viewer-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .document-viewer-close:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }

        .document-viewer-body {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #f8fafc;
        }

        .document-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .document-card {
            background: white;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.02);
            border: 1px solid #eef2f6;
            transition: all 0.3s;
            animation: fadeIn 0.5s ease;
        }

        .document-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 30px -10px rgba(23, 57, 121, 0.15);
            border-color: var(--primary-green);
        }

        .document-preview {
            height: 180px;
            background: linear-gradient(145deg, #f8fafc, #edf2f7);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .document-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }

        .document-card:hover .document-preview img {
            transform: scale(1.05);
        }

        .document-icon {
            font-size: 64px;
            color: var(--primary-green);
            opacity: 0.7;
        }

        .document-info {
            padding: 18px;
        }

        .document-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            word-break: break-word;
            font-size: 14px;
        }

        .document-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }

        .document-type-badge {
            background: #e8f0fe;
            color: var(--primary-green);
            padding: 4px 12px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 11px;
        }

        .document-actions {
            display: flex;
            gap: 10px;
        }

        .document-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .document-btn.view {
            background: var(--primary-green);
            color: white;
        }

        .document-btn.view:hover {
            background: #0f2a4a;
        }

        .document-btn.download {
            background: #ecf0f1;
            color: #34495e;
        }

        .document-btn.download:hover {
            background: #dfe6e9;
        }

        #fullscreenDocumentView {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 60000;
            flex-direction: column;
        }

        .fullscreen-header {
            padding: 20px 30px;
            background: linear-gradient(135deg, #1a1a1a, #000);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .fullscreen-title {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .fullscreen-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .fullscreen-close:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }

        .fullscreen-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: auto;
        }

        .fullscreen-content img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .fullscreen-content iframe {
            width: 100%;
            height: 80vh;
            border: none;
            border-radius: 8px;
            background: white;
        }

        .fullscreen-footer {
            padding: 20px 30px;
            background: #1a1a1a;
            color: white;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            border-top: 1px solid #333;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .fullscreen-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .fullscreen-btn.download {
            background: var(--primary-green);
            color: white;
        }

        .fullscreen-btn.download:hover {
            background: #0f2a4a;
            transform: translateY(-2px);
        }

        #changePasswordModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 45000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .password-modal-content {
            background: white;
            border-radius: 32px;
            width: 450px;
            max-width: 95%;
            padding: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease;
        }

        .password-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .password-header .icon {
            font-size: 48px;
            background: linear-gradient(135deg, var(--primary-green), #0f2a4a);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
        }

        .password-header h3 {
            color: #2c3e50;
            margin: 0;
            font-size: 1.5rem;
        }

        .password-field {
            margin-bottom: 20px;
        }

        .password-field label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        .password-input-wrapper {
            position: relative;
        }

        .password-input-wrapper input {
            width: 100%;
            padding: 14px 45px 14px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 16px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .password-input-wrapper input:focus {
            border-color: var(--primary-green);
            outline: none;
            box-shadow: 0 0 0 4px rgba(23, 57, 121, 0.1);
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #95a5a6;
            font-size: 18px;
        }

        .password-strength {
            margin-top: 8px;
            height: 4px;
            background: #ecf0f1;
            border-radius: 2px;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            width: 0%;
            transition: all 0.3s;
        }

        .password-strength-bar.weak { background: #e74c3c; width: 33%; }
        .password-strength-bar.medium { background: #f39c12; width: 66%; }
        .password-strength-bar.strong { background: #2ecc71; width: 100%; }
        .password-match-indicator {
            font-size: 13px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .password-match-indicator.match {
            color: #2ecc71;
        }

        .password-match-indicator.no-match {
            color: #e74c3c;
        }

        .password-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .password-actions button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save-password {
            background: var(--primary-green);
            color: white;
        }

        .btn-save-password:hover {
            background: #0f2a4a;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(23, 57, 121, 0.3);
        }

        .btn-cancel {
            background: #ecf0f1;
            color: #34495e;
        }

        .btn-cancel:hover {
            background: #dfe6e9;
        }

        .user-menu {
        position: relative;
        display: inline-block;
        }

        .user-menu-button {
        background: var(--primary-green);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 30px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        transition: all 0.3s;
        position: relative;
        z-index: 1001;
        }

        .user-menu-button:hover {
        background: #0f2a4a;
        transform: translateY(-2px);
        }

        .user-dropdown {
        position: absolute;
        top: calc(100% + 5px);
        right: 0;
        background: white;
        min-width: 220px;
        border-radius: 16px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        border: 1px solid rgba(0,0,0,0.05);
        }   

        .user-menu:hover .user-dropdown,
        .user-dropdown:hover {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        }

        .user-dropdown-item {
        padding: 14px 20px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
        color: #2c3e50;
        font-size: 14px;
        border-bottom: 1px solid #f0f0f0;
         }

         .history-row {
        background: transparent !important;
        }
        .history-row:hover {
            background: transparent !important;
        }
        .history-row td {
            border: none !important;
            padding: 0 !important;
            background: transparent !important;
        }
    .btn-view {
        transition: all 0.2s;
    }
    .btn-view:hover {
        opacity: 0.85;
        transform: translateY(-1px);
    }

        /* Create an invisible bridge between button and dropdown */
        .user-menu::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 0;
        width: 100%;
        height: 15px;
        background: transparent;
        z-index: 1000;
         }

        .user-dropdown-item:last-child {
            border-bottom: none;
        }

        .user-dropdown-item:hover {
    background: #f8f9fa;
    color: var(--primary-green);
    padding-left: 25px;
}

        .user-dropdown-item i, 
.user-dropdown-item span:first-child {
    font-size: 18px;
    width: 24px;
    text-align: center;
}

        .user-dropdown-divider {
    height: 1px;
    background: #ecf0f1;
    margin: 5px 0;
}

.user-dropdown::before {
    content: '';
    position: absolute;
    top: -6px;
    right: 30px;
    width: 12px;
    height: 12px;
    background: white;
    transform: rotate(45deg);
    border-left: 1px solid rgba(0,0,0,0.05);
    border-top: 1px solid rgba(0,0,0,0.05);
}

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInScale {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        .spinner-text {
            color: white;
            font-size: 20px;
            font-weight: 500;
            letter-spacing: 2px;
            margin-top: 15px;
            text-transform: uppercase;
            background: linear-gradient(90deg, #fff, #173979, #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: shimmer 2s linear infinite;
        }

        .spinner-subtext {
            color: #95a5a6;
            font-size: 14px;
            margin-top: 10px;
            font-style: italic;
        }

        .spinner-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .dot {
            width: 10px;
            height: 10px;
            background-color: var(--primary-green);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }

        #systemLockScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 40000;
            display: none;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s ease;
        }

        .lock-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 60px 40px;
            border-radius: 30px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 500px;
            width: 90%;
            backdrop-filter: blur(10px);
            animation: slideUp 0.6s ease;
        }

        .lock-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: lockPulse 2s infinite;
        }

        .lock-title {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .lock-message {
            color: #666;
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .lock-timer-container {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            color: white;
        }

        .countdown-timer {
            font-size: 48px;
            font-weight: 800;
            font-family: monospace;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .unlock-time {
            font-size: 16px;
            opacity: 0.9;
            margin-top: 10px;
        }

        .lock-progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.3);
            border-radius: 5px;
            margin-top: 20px;
            overflow: hidden;
        }

        .lock-progress-fill {
            height: 100%;
            background: white;
            border-radius: 5px;
            transition: width 1s linear;
        }

        .back-to-login-btn {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .back-to-login-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        @keyframes lockPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        /* Professional pulse animation */
@keyframes professional-pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(255, 77, 77, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(255, 77, 77, 0);
    }
}

.status-pulse {
    position: relative;
}

.status-pulse::after {
    content: '';
    position: absolute;
    top: -3px;
    right: -3px;
    width: 10px;
    height: 10px;
    background: #ff4d4d;
    border-radius: 50%;
    animation: professional-pulse 1.5s infinite;
    border: 2px solid white;
}

/* For button elements specifically */
.nav-pulse {
    position: relative !important;
    overflow: visible !important;
}

.nav-pulse::after {
    content: '' !important;
    position: absolute !important;
    top: 5px !important;
    right: 5px !important;
    width: 10px !important;
    height: 10px !important;
    background: #ff4d4d !important;
    border-radius: 50% !important;
    animation: professional-pulse 1.5s infinite !important;
    border: 2px solid white !important;
    z-index: 1000 !important;
}

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInScale {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); opacity: 0.3; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Simple pulse animation */
@keyframes simple-pulse {
    0% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.5;
        transform: scale(1.5);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

.pulse-dot {
    position: absolute;
    width: 12px;
    height: 12px;
    background-color: #ff4d4d;
    border-radius: 50%;
    animation: simple-pulse 1s infinite;
    z-index: 9999;
    box-shadow: 0 0 10px #ff4d4d;
}

/* Notification badge for buttons */
.button-notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 12px;
    height: 12px;
    background: #ff4d4d;
    border-radius: 50%;
    box-shadow: 0 0 0 rgba(255, 77, 77, 0.4);
    animation: pulse-red 1.5s infinite;
}

.top-nav li a, .top-nav button {
    position: relative;
    overflow: visible !important;
}

/* My Requests pulse */
.my-requests-pulse {
    position: relative;
}

.my-requests-pulse::after {
    content: '';
    position: absolute;
    top: -5px;
    right: -5px;
    width: 10px;
    height: 10px;
    background: #ff4d4d;
    border-radius: 50%;
    animation: pulse-red 1.5s infinite;
}


        /* REJECT REASON MODAL */
        #rejectReasonModal {
            display: none;
            position: fixed;
            z-index: 50000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }

        .reject-modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 450px;
            max-width: 95%;
        }

        .reject-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin: 15px 0;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        /* LOGIN OVERLAY */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a1a, #333);
            z-index: 20000; display: flex; justify-content: center; align-items: center;
        }

        .login-card {
            background: white; padding: 40px; border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 400px; text-align: center;
        }

        .login-card img { margin-bottom: 20px; }
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .pass-wrapper { position: relative; }
        .toggle-pass { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; }

        /* HEADER */
        .topmenu {
            width: 100%; padding: 20px 0; color: white; text-align: center;
            background-size: cover; background-position: center;
            transition: background-image 1.5s ease-in-out;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }

        .top-nav {
            list-style: none; padding: 0; background: #333; margin: 0;
            display: flex; justify-content: center; flex-wrap: wrap;
        }

        .top-nav li a {
            display: block; padding: 15px 25px; text-decoration: none;
            font-weight: bold; color: white; transition: 0.3s; cursor: pointer;
        }

        .top-nav li a:hover { color: var(--nav-yellow); }

        .grid-section {
         padding: 40px 15px; 
    width: 100%;
    max-width: 100%;
    margin: 0;
    box-sizing: border-box;
}
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 25px;
            margin-top: 20px;
        }

        .grid-item {
             background: white;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 20px rgba(0,0,0,0.05);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    text-decoration: none;
    color: #333;
    display: flex;
    flex-direction: column;
    cursor: pointer;
    border: 1px solid rgba(76,175,80,0.1);
    position: relative;
        }

        .grid-item:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 30px rgba(76,175,80,0.15);
            border-color: var(--primary-green);
        }

        .grid-item .category-image-wrapper {
            width: 100%;
            height: 120px;
            overflow: hidden;
            position: relative;
            background: linear-gradient(145deg, #f0f7f4, #e0ebe8);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s ease;
        }

        .grid-item:hover img { transform: scale(1.08); }

        .category-fallback {
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            font-size: 48px; font-weight: 300; color: white; text-shadow: 0 4px 10px rgba(0,0,0,0.2);
            background: radial-gradient(circle at 30% 30%, #173979, #2c6b2c);
        }

        .grid-item span {
            padding: 18px 30px; text-align: center; font-weight: 600; font-size: 1rem;
            background: white; color: #1e3b37; border-top: 1px solid #f0f0f0; letter-spacing: 0.3px;
        }

        .grid-item:hover span { color: var(--primary-green); background: #fafffc; }

        .btn-del {
            background: var(--danger-red);
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            display: inline-block;
        }
        .btn-del:hover { opacity: 0.85; }
        /* Supplier count badge styling */
.grid-item span + span {
    background: #173979;
    color: white;
    padding: 6px 16px;
    border-radius: 40px;
    font-size: 13px;
    font-weight: 600;
    display: inline-block;
    box-shadow: 0 4px 8px rgba(23, 57, 121, 0.2);
    margin-bottom: 0;
}

        .admin-controls {
            background: white; padding: 20px; text-align: center;
            border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;
            margin-bottom: 30px;
        }

        #homeView, 
        #categoryPageView, 
        #aboutView, 
        #contactView, 
        #linksView,
        #auditLogsView, 
        #userApprovalHistoryView,
        #requestsManagementView { 
        display: none; 
        padding: 40px 15px; 
        width: 100%;
        max-width: 100%;
        margin: 0;
        box-sizing: border-box;
            }
        
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .data-table th, .data-table td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        .data-table th { background: var(--primary-green); color: white; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn:hover { opacity: 0.85; transform: scale(0.98); }
        .btn-add { background: var(--primary-green); }
        .btn-back { background: #607d8b; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
        .btn-edit { background: #f39c12; padding: 5px 10px; font-size: 12px; border-radius: 4px; color: white; border: none; display: inline-block; margin-right: 5px; }
        .btn-request-delete { background: #e67e22; padding: 5px 10px; font-size: 12px; border-radius: 4px; color: white; border: none; display: inline-block; }
        .btn-approve { background: #9b59b6; padding: 5px 10px; font-size: 12px; border-radius: 4px; color: white; border: none; }
        .btn-super { background: #9b59b6; }
        .btn-warning { background: #e67e22; }
        .btn-pagination { background: #34495e; padding: 8px 15px; font-size: 13px; }

        .modal {
        display: none; 
        position: fixed; 
        z-index: 10000; 
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%;
        background-color: rgba(0,0,0,0.9); /* Changed from 0.7 to 0.9 for darker overlay */
        backdrop-filter: blur(10px);
        justify-content: center; 
        align-items: center;
    }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 500px; max-height: 80vh; overflow-y: auto; }

        .vertical-life-bar-container {
            width: 20px; height: 60px; background: #f0f0f0; border-radius: 10px; overflow: hidden;
            position: relative; border: 1px solid #ddd; margin: 0 auto;
        }
        .vertical-life-bar-fill { width: 100%; background: linear-gradient(to top, #2ecc71, #173979); transition: height 0.5s ease; position: absolute; bottom: 0; }
        .vertical-life-bar-fill.expiring { background: linear-gradient(to top, #f39c12, #e67e22); }
        .vertical-life-bar-fill.expired { background: linear-gradient(to top, #e74c3c, #c0392b); }
        .vertical-life-bar-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: white; text-shadow: 0 0 3px rgba(0,0,0,0.5); }

        .compliance-pill { display: inline-block; padding: 4px 8px; border-radius: 50px; font-size: 10px; font-weight: bold; color: white; margin: 2px; text-transform: uppercase; }
        .comp-ok { background: #2ecc71; }
        .comp-bad { background: #e74c3c; }
        .comp-pending { background: #f39c12; }

        .star-rating-view { display: inline-flex; gap: 2px; }
        .star-view.filled { color: var(--star-color); }
        .rating-value { margin-left: 5px; font-weight: bold; }

        .image-thumbnail { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin: 2px; }

        .about-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .mission-vision-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin: 30px 0; }
        .staff-section { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-top: 30px; }

        .sessions-panel {
            position: fixed; top: 100px; right: 20px; width: 300px; background: white;
            border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.15); z-index: 1000; display: none;
        }

        .notification {
            position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #173979;
            color: white; border-radius: 5px; z-index: 10000; display: none;
        }

        .online-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .pulse-online { background: #2ecc71; box-shadow: 0 0 0 rgba(46, 204, 113, 0.4); animation: pulse-green 2s infinite; }
        .offline-grey { background: #95a5a6; }
        .beaming { animation: beam 1.5s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.6); } 70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } }
        @keyframes beam { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .user-mgmt-table { width:100%; border-collapse: collapse; font-size: 13px; }
        .role-badge { padding: 3px 8px; border-radius: 30px; color: white; font-size: 11px; margin-left: 5px; display: inline-block; }
        .role-superadmin { background: #9b59b6; } 
        .role-admin { background: #3498db; } 
        .role-staff { background: #2ecc71; }

        .hidden { display: none !important; }
        .exclusive-super { display: none; }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
        }

        .audit-log-entry {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            transition: background 0.2s;
        }

        .audit-log-entry:hover {
            background: #f5f9ff;
        }

        .audit-timestamp {
            color: #666;
            font-size: 11px;
            font-family: monospace;
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .audit-action {
            font-weight: bold;
            color: #2c3e50;
            background: #e8f5e9;
            padding: 4px 10px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
            margin-left: 10px;
        }

        .audit-user {
            background: #e3f2fd;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .audit-details {
            margin-top: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
            border-left: 3px solid var(--primary-green);
        }

        .compliance-bar-container {
            width: 100%;
            height: 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        .compliance-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        .compliance-bar-fill.good { background: linear-gradient(90deg, #2ecc71, #27ae60); }
        .compliance-bar-fill.poor { background: linear-gradient(90deg, #e74c3c, #c0392b); }

        .approval-request-item {
            background: #f9f9f9;
            border-left: 4px solid var(--warning-orange);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .reason-modal {
            display: none;
            position: fixed;
            z-index: 15000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .reason-modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 450px;
            max-width: 95%;
        }
        .reason-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin: 15px 0;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        .document-upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s;
            cursor: pointer;
        }
        .document-upload-area:hover {
            border-color: var(--primary-green);
            background: #f0f7f0;
        }
        .document-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .document-item {
            background: #f0f0f0;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .document-item i {
            color: var(--primary-green);
        }

        .rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
            gap: 5px;
        }
        .rating input {
            display: none;
        }
        .rating label {
            cursor: pointer;
            font-size: 24px;
            color: #ddd;
            transition: color 0.2s;
        }
        .rating label:before {
            content: '★';
        }
        .rating input:checked ~ label,
        .rating label:hover,
        .rating label:hover ~ label {
            color: var(--star-color);
        }

        .approval-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        .approval-tab {
            padding: 10px 20px;
            border-radius: 30px;
            background: #f0f0f0;
            color: #333;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .approval-tab.active {
            background: var(--primary-green);
            color: white;
        }
        .approval-tab:hover {
            background: #e0e0e0;
        }
        .approval-tab.active:hover {
            background: var(--primary-green);
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .request-count-badge {
            background: #ff4d4d;
            color: white;
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 8px;
            display: inline-block;
            font-weight: bold;
        }

        .request-count-zero {
            background: #95a5a6;
        }

        .category-actions-bar {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            justify-content: center;
        }

        .category-actions-bar button {
            padding: 12px 24px;
        }

        .clickable-phone {
            color: var(--link-blue);
            text-decoration: none;
            cursor: pointer;
        }
        .clickable-phone:hover {
            text-decoration: underline;
        }

        .clickable-email {
            color: var(--link-blue);
            text-decoration: none;
            cursor: pointer;
        }
        .clickable-email:hover {
            text-decoration: underline;
        }



        .clickable-tpin {
            color: var(--primary-green);
            text-decoration: none;
            cursor: pointer;
            font-weight: 600;
        }
        .clickable-tpin:hover {
            text-decoration: underline;
        }

        .modification-history {
            position: relative;
            display: inline-block;
        }

        .modification-dropdown {
            display: none;
            position: absolute;
            background: white;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 12px;
            padding: 15px;
            font-size: 12px;
            border: 1px solid #e0e0e0;
            right: 0;
        }

        .modification-history:hover .modification-dropdown {
            display: block;
        }

        .modification-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .modification-item:last-child {
            border-bottom: none;
        }

        .modification-field {
            font-weight: 700;
            color: #e67e22;
            text-transform: capitalize;
        }

        .modification-old {
            color: #e74c3c;
            text-decoration: line-through;
            background: #fee9e7;
            padding: 2px 5px;
            border-radius: 4px;
        }

        .modification-new {
            color: #27ae60;
            background: #e8f8f5;
            padding: 2px 5px;
            border-radius: 4px;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 77, 77, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 77, 77, 0);
            }
        }

        @media (max-width: 900px) { 
            .grid-container { grid-template-columns: repeat(2, 1fr); } 
            .top-nav { flex-direction: column; }
            .mission-vision-grid { grid-template-columns: 1fr; }
            .staff-section { grid-template-columns: 1fr; }
            .modal-content { width: 95%; }
        }
        @media (max-width: 480px) { .grid-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<!-- SINGLE TAB ENFORCEMENT -->
<div id="tabConflictWarning" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 99999; color: white; text-align: center; padding-top: 20%; font-size: 24px; font-weight: bold;">
    ⚠️ THIS APPLICATION CAN ONLY BE OPENED IN ONE TAB<br>
    <span style="font-size: 18px; color: #ff4d4d; margin-top: 20px; display: block;">Please close this tab and use the existing tab.</span>
    <button onclick="forceTakeover()" style="margin-top: 40px; padding: 15px 30px; background: #173979; color: white; border: none; border-radius: 5px; cursor: pointer;">FORCE TAKEOVER (Close Other Tab)</button>
</div>

<!-- LOADING SPINNER -->
<div id="loadingSpinner">
    <div class="spinner-container">
        <div class="spinner"></div>
        <div class="spinner-text">Zed Supplier Directory</div>
        <div class="spinner-subtext">Loading your experience...</div>
        <div class="spinner-dots">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
    </div>
</div>

<!-- SYSTEM LOCK SCREEN -->
<div id="systemLockScreen">
    <div class="lock-container">
        <div class="lock-icon">🔒</div>
        <h1 class="lock-title">System Locked</h1>
        <p class="lock-message">Access to the system is restricted during operating hours only</p>
        
        <div class="lock-timer-container">
            <div class="countdown-timer" id="lockCountdown">00:00:00</div>
            <div class="unlock-time" id="unlockTimeDisplay">Next unlock: 07:30:00</div>
            <div class="lock-progress-bar">
                <div class="lock-progress-fill" id="lockProgress" style="width: 0%;"></div>
            </div>
        </div>
        
        <button class="back-to-login-btn" onclick="backToLoginFromLock()">← Back to Login</button>
    </div>
</div>

<!-- TIME WARNING -->
<div id="timeWarning" style="display: none; position: fixed; top: 0; left: 0; width: 100%; background: #ff4d4d; color: white; text-align: center; padding: 15px; z-index: 30000; font-weight: bold;">
    ⚠️ SYSTEM ALERT: Scheduled lockout at 16:50. Super admin and admin bypass active.
</div>

<!-- LOGIN OVERLAY - EMPTY FIELDS -->
<div id="loginOverlay" style="display: flex;">
    <div class="login-card">
        <img src="./images/mainlogo.png" width="100" alt="logo" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\' viewBox=\'0 0 100 100\'><rect width=\'100\' height=\'100\' fill=\'%23173979\'/><text x=\'50\' y=\'55\' font-size=\'40\' text-anchor=\'middle\' fill=\'white\' font-weight=\'bold\'>Z</text></svg>'">
        <div id="loginFieldsContent">
            <h2 style="color: var(--primary-green); text-align: center;">Zed Supplier Directory</h2>
            <h2 style="font-size: 15px;">System Login</h2>
            <input type="text" id="userIn" placeholder="Username" value="">
            <div class="pass-wrapper">
                <input type="password" id="passIn" placeholder="Password" value="">
                <span class="toggle-pass" onclick="togglePassword()">👁️</span>
            </div>
            <button class="btn btn-add" style="width: 100%; margin-top: 10px;" onclick="handleLogin()">Login</button>
            <p style="font-size: 12px; margin-top: 15px; color: #666;">

    <!-- Find this section in your HTML and update the forgot password link -->
<span style="cursor: pointer;" onclick="openForgotPasswordModal()">Forgot Password?</span>
    <span style="margin: 0 10px;">|</span>
    <span style="cursor: pointer; color: var(--primary-green);" onclick="openAccountRequestModal()">Don't have an account? Request account creation here</span> </p>
    <span style="font-size: 10px; display: inline-block; margin-top: 0;"> <br>Powered by <br> Jatkiss Empire Group</span>
        </div>
    </div>
</div>


<!-- ACCOUNT REQUEST MODAL -->
<div id="accountRequestModal" class="modal" style="display: none; z-index: 25000;">
    <div class="modal-content" style="width: 700px; max-width: 95%; border-radius: 24px; padding: 30px; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">

            <h3 style="color: var(--primary-green); margin: 0;">📝 Request Account Creation</h3>
            <button onclick="closeAccountRequestModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">✕</button>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Left Column -->
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Full Name *</label>
                <input type="text" id="requestFullName" placeholder="e.g., John Doe" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Username * (Uppercase)</label>
                <input type="text" id="requestUsername" placeholder="e.g., JDOE" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;" oninput="this.value = this.value.toUpperCase()">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">NRC Number *</label>
                <input type="text" id="requestNrc" placeholder="e.g., 123456/78/1" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Phone Number *</label>
                <input type="text" id="requestPhone" placeholder="e.g., +260977123456" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
            </div>
            
            <!-- Right Column -->
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Institution *</label>
                <input type="text" id="requestInstitution" placeholder="e.g., ZAMCOM" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Position *</label>
                <input type="text" id="requestPosition" placeholder="e.g., Procurement Officer" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Email Address *</label>
                <input type="email" id="requestEmail" placeholder="e.g., john@zamcom.zm" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Password *</label>
                <input type="password" id="requestPassword" placeholder="Enter password" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
            </div>
        </div>
        
        <!-- Document Upload Section -->
        <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
            <h4 style="color: var(--primary-green); margin-bottom: 15px;">📄 Required Documents (Max 1MB each)</h4>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <!-- NRC -->
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('requestNrcDoc').click()" style="padding: 15px;">
                        <span style="font-size: 32px;">🪪</span>
                        <p style="margin: 5px 0; font-weight: 600;">NRC</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="requestNrcDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleRequestDocumentUpload('nrc', this)">
                    <div id="requestNrcDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                
                <!-- Degree/Diploma -->
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('requestDegreeDoc').click()" style="padding: 15px;">
                        <span style="font-size: 32px;">🎓</span>
                        <p style="margin: 5px 0; font-weight: 600;">Degree/Diploma</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="requestDegreeDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleRequestDocumentUpload('degree', this)">
                    <div id="requestDegreeDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                
                <!-- ZIPS Certificate -->
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('requestZipsDoc').click()" style="padding: 15px;">
                        <span style="font-size: 32px;">📜</span>
                        <p style="margin: 5px 0; font-weight: 600;">ZIPS Certificate</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="requestZipsDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleRequestDocumentUpload('zips', this)">
                    <div id="requestZipsDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button class="btn btn-add" style="flex: 1; padding: 14px; font-size: 16px;" onclick="submitAccountRequest()">Submit Request</button>
            <button class="btn" style="flex: 1; background: #95a5a6; padding: 14px; font-size: 16px;" onclick="closeAccountRequestModal()">Cancel</button>
        </div>
    </div>
</div>


<!-- HEADER -->
<div class="topmenu" id="headerSection">
    <img src="./images/mainlogo.png" width="120" alt="zamcom" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'120\' height=\'120\' viewBox=\'0 0 100 100\'><rect width=\'100\' height=\'100\' fill=\'%23173979\'/><text x=\'50\' y=\'55\' font-size=\'40\' text-anchor=\'middle\' fill=\'white\' font-weight=\'bold\'>Z</text></svg>'">
    <h1>Zed Supplier Directory</h1>
    <h2>PROCUREMENT</h2>
    <marquee style="background: rgba(0,0,0,0.3); padding: 2px 0;">Right Quality - Right Quantity - Right Time - Right Price - Right Place</marquee>
    <h4 id="greeting" style="margin-top:20px;"><i>Welcome</i></h4>
</div>


<!-- NAVIGATION -->
<ul class="top-nav">
    <li><a onclick="showView('home'); clearSearch()">HOME</a></li>
    <li><a onclick="showView('links')">LINKS</a></li>
    <li><a onclick="showView('contact')">CONTACT US</a></li>
    <li><a onclick="showView('about')">ABOUT US</a></li>
    <li><a onclick="showAuditLogs()" id="auditLogsNavBtn" class="nav-item" style="display:none;">📋 AUDIT LOGS</a></li>
    <li><a onclick="openUserApprovalHistory()" id="approvalHistoryNavBtn" class="nav-item pulse-container" style="background:#9b59b6; display:none;">📜 MY REQUESTS</a></li>
    <li><a onclick="manageUsersModal()" id="userMgmtBtn" class="nav-item" style="background:#e67e22; display:none;">👥 USER MANAGEMENT</a></li>
    <li><a onclick="toggleSessionsPanel()" id="sessionsBtn" class="nav-item" style="background:#2196F3; display:none;">👁️ ACTIVE SESSIONS</a></li>
    <li><a onclick="showRequestsManagementView()" id="requestsManagementNavBtn" class="nav-item exclusive-super" style="display:none; background:#9b59b6;">📋 REQUESTS MANAGEMENT</a></li>
</ul>

<!-- Add this div for pulses - they will be positioned absolutely -->
<div id="pulseContainer" style="position: relative;"></div>

<!-- STATUS BAR -->
<div id="systemStatusHeader" style="background: #fff; padding: 10px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
    <div style="display: flex; align-items: center; gap: 10px;">
        <span id="statusDot" style="height: 12px; width: 12px; border-radius: 50%; display: inline-block;"></span>
        <span id="statusText" style="font-weight: bold; font-size: 14px;">Checking Status...</span>
    </div>

    <div id="currentUserInfo" style="font-size: 12px; color: #555; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
        <span id="currentUserDisplay">Not logged in</span>
        <span id="userRoleBadge" style="display: none; padding:2px 6px; border-radius:12px; color:white;"></span>
    </div>

    <div id="liveClock" style="font-family: monospace; font-weight: bold;"></div>
</div>

<!-- IMAGE GALLERY MODAL -->
<div id="imageGalleryModal" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index:20001; justify-content:center; align-items:center;">
    <div style="position:relative; width:90%; height:90%;">
        <button onclick="closeImageGallery()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer;">✕</button>
        <button onclick="prevImage()" style="position:absolute; left:20px; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:white; border:none; width:50px; height:50px; border-radius:50%; cursor:pointer;">‹</button>
        <img id="galleryCurrentImage" src="" style="width:100%; height:100%; object-fit:contain;">
        <button onclick="nextImage()" style="position:absolute; right:20px; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:white; border:none; width:50px; height:50px; border-radius:50%; cursor:pointer;">›</button>
        <div id="imageCounter" style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); color:white; background:rgba(0,0,0,0.5); padding:5px 15px; border-radius:20px;">1 / 1</div>
    </div>
</div>


<div id="changePasswordModal">
    <div class="password-modal-content">
        <div class="password-header">
            <div class="icon">🔐</div>
            <h3>Change Password</h3>
        </div>
        
        <div class="password-field">
            <label>Current Password</label>
            <div class="password-input-wrapper">
                <input type="password" id="currentPassword" placeholder="Enter current password">
                <span class="password-toggle" onclick="togglePasswordField('currentPassword')">👁️</span>
            </div>
        </div>

        <div class="password-field">
            <label>New Password</label>
            <div class="password-input-wrapper">
                <input type="password" id="newPasswordChange" placeholder="Enter new password" onkeyup="checkPasswordStrength()">
                <span class="password-toggle" onclick="togglePasswordField('newPasswordChange')">👁️</span>
            </div>
            <div class="password-strength">
                <div class="password-strength-bar" id="passwordStrengthBar"></div>
            </div>
        </div>

        <div class="password-field">
            <label>Confirm New Password</label>
            <div class="password-input-wrapper">
                <input type="password" id="confirmPassword" placeholder="Confirm new password" onkeyup="checkPasswordMatch()">
                <span class="password-toggle" onclick="togglePasswordField('confirmPassword')">👁️</span>
            </div>
            <div class="password-match-indicator" id="passwordMatchIndicator"></div>
        </div>

        <div class="password-actions">
            <button class="btn-save-password" onclick="changePassword()">
                <span>✓</span> Update Password
            </button>
            <button class="btn-cancel" onclick="closeChangePasswordModal()">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Add Fullscreen Document View Modal -->
<div id="fullscreenDocumentView">
    <div class="fullscreen-header">
        <div class="fullscreen-title">
            <span id="fullscreenDocIcon">📄</span>
            <span id="fullscreenDocName">Document Name</span>
        </div>
        <button class="fullscreen-close" onclick="closeFullscreenDocument()">✕</button>
    </div>
    <div class="fullscreen-content" id="fullscreenDocContent">
        <!-- Document will be loaded here -->
    </div>
    <div class="fullscreen-footer">
        <button class="fullscreen-btn download" onclick="downloadCurrentFullscreenDoc()">
            <span>📥</span> Download Document
        </button>
    </div>
</div>


<!-- DOCUMENT VIEWER MODAL -->
<div id="documentViewerModal" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index:20000; justify-content:center; align-items:center;">
    <div style="width:90%; height:90%; background:white; border-radius:10px; display:flex; flex-direction:column;">
        <div style="padding:15px; background:var(--primary-green); color:white; display:flex; justify-content:space-between; align-items:center;">
            <span id="documentViewerTitle">Supplier Documents</span>
            <button onclick="closeDocumentViewer()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">✕</button>
        </div>
        <div id="documentViewerBody" style="flex:1; padding:20px; overflow:auto; display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:20px;"></div>
    </div>
</div>

<!-- ========== REASON INPUT MODAL ========== -->
<div id="reasonModal" class="reason-modal">
    <div class="reason-modal-content">
        <h3 id="reasonModalTitle" style="color: var(--warning-orange); margin-bottom: 10px;">State Reason for Deletion</h3>
        <p style="color: #666; font-size: 13px; margin-bottom: 5px;">Please provide a reason for this deletion request:</p>
        <textarea id="deletionReason" class="reason-textarea" placeholder="Enter your reason here..."></textarea>
        <div style="display: flex; gap: 15px; justify-content: flex-end;">
            <button class="btn" style="background: var(--primary-green);" onclick="submitDeletionReason()">Submit Request</button>
            <button class="btn" style="background: #95a5a6;" onclick="closeReasonModal()">Cancel</button>
        </div>
        <input type="hidden" id="pendingDeletionType">
        <input type="hidden" id="pendingDeletionId">
        <input type="hidden" id="pendingDeletionName">
    </div>
</div>

<!-- ========== REJECT REASON MODAL ========== -->
<div id="rejectReasonModal" class="modal">
    <div class="reject-modal-content">
        <h3 style="color: var(--danger-red); margin-bottom: 15px;">✗ Reason for Rejection</h3>
        <p style="color: #666; margin-bottom: 10px;">Please provide a reason for rejecting this request:</p>
        <textarea id="rejectReasonText" class="reject-textarea" placeholder="Enter rejection reason..."></textarea>
        <div style="display: flex; gap: 15px; justify-content: flex-end;">
            <button class="btn" style="background: var(--danger-red);" onclick="submitRejectionReason()">Confirm Rejection</button>
            <button class="btn" style="background: #95a5a6;" onclick="closeRejectReasonModal()">Cancel</button>
        </div>
        <input type="hidden" id="pendingRejectRequestId">
    </div>
</div>

<!-- ========== HOME VIEW ========== -->
<div id="homeView" class="grid-section" style="display: none;">
    <div class="admin-controls" id="adminControlsBar">
        <button class="btn btn-add" onclick="openCategoryModal()" id="newCategoryBtn">+ New Category</button>
        <button class="btn btn-add" style="background:#3498db" onclick="openSupplierModal()" id="newSupplierBtn">+ New Supplier</button>
        <input type="text" id="globalSearch" placeholder="🔍 Search Supplier Name..." style="padding: 10px 20px; border-radius: 30px; border: 1px solid #ddd; width: 250px;" onkeyup="filterEverything()">
        <select id="provinceFilter" style="padding: 10px 20px; border-radius: 30px; border: 1px solid #ddd; min-width: 200px;" onchange="filterByProvince()">
        <option value="All">🌍 All Provinces</option>
        <option value="Lusaka Province">📍 Lusaka Province</option>
        <option value="Copperbelt Province">📍 Copperbelt Province</option>
        <option value="Central Province">📍 Central Province</option>
        <option value="Eastern Province">📍 Eastern Province</option>
        <option value="Muchinga Province">📍 Muchinga Province</option>
        <option value="Luapula Province">📍 Luapula Province</option>
        <option value="Southern Province">📍 Southern Province</option>
        <option value="Western Province">📍 Western Province</option>
        <option value="North-Western Province">📍 North-Western Province</option>
        <option value="Northern Province">📍 Northern Province</option>
    </select>
        <button id="exportBackupBtn" class="btn exclusive-super" style="background:#607d8b" onclick="exportData()">💾 Export Backup</button>
        <button id="importMergeBtn" class="btn exclusive-super" style="background:#9c27b0" onclick="document.getElementById('importFile').click()">📥 Import & Merge</button>
        
<button id="fixSupplierCountBtn" class="btn exclusive-super" style="background:#e67e22" onclick="fixSupplierCount()">
    🔧 Fix Supplier Count
</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>



    <div id="defaultHomeContent">
        <h2 style="text-align:center; color: #1e3b37; font-size: 2rem; margin-bottom: 10px;">Supplier Categories</h2>
        <p style="text-align:center; color: #5a7c7a; margin-bottom: 20px;">Browse our trusted partners by category</p>
        <div class="grid-container" id="categoryGrid"></div>
        
        <!-- Beautiful supplier summary counter -->
        <div id="totalSuppliersCounter" style="margin-top: 60px; margin-bottom: 20px;">
            <div style="background: linear-gradient(135deg, #173979, #1e4b8a); border-radius: 80px; padding: 30px 40px; max-width: 800px; margin: 0 auto; box-shadow: 0 25px 40px -15px rgba(23, 57, 121, 0.5); text-align: center; position: relative; overflow: hidden;">
                <!-- Decorative elements -->
                <div style="position: absolute; top: -20px; left: -20px; width: 150px; height: 150px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;"></div>
                <div style="position: absolute; bottom: -40px; right: -20px; width: 200px; height: 200px; background: rgba(255, 255, 255, 0.05); border-radius: 50%;"></div>
                
                <div style="display: flex; align-items: center; justify-content: center; gap: 30px; flex-wrap: wrap; position: relative; z-index: 2;">
                    <div style="text-align: left;">
                        <div style="font-size: 18px; color: rgba(255, 255, 255, 0.8); letter-spacing: 2px; margin-bottom: 5px;">TOTAL SUPPLIERS</div>
                        <div style="display: flex; align-items: baseline; gap: 10px;">
                            <span id="totalSuppliersCount" style="font-size: 72px; font-weight: 800; color: white; line-height: 1;">0</span>
                            <span style="font-size: 24px; color: rgba(255, 255, 255, 0.7);">registered</span>
                        </div>
                    </div>
                    
                    <div style="width: 2px; height: 70px; background: rgba(255, 255, 255, 0.2);"></div>
                    
                    <div style="display: flex; gap: 40px;">
                        <div style="text-align: center;">
                            <div style="background: rgba(255, 255, 255, 0.15); width: 60px; height: 60px; border-radius: 30px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                                <span style="font-size: 28px;">📊</span>
                            </div>
                            <div style="font-size: 24px; font-weight: 700; color: white;" id="totalCategoriesCount">0</div>
                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7);">Categories</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: rgba(255, 255, 255, 0.15); width: 60px; height: 60px; border-radius: 30px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                                <span style="font-size: 28px;">⭐</span>
                            </div>
                            <div style="font-size: 24px; font-weight: 700; color: white;" id="avgRatingDisplay">0.0</div>
                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7);">Avg. Rating</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: rgba(255, 255, 255, 0.15); width: 60px; height: 60px; border-radius: 30px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                                <span style="font-size: 28px;">✅</span>
                            </div>
                            <div style="font-size: 24px; font-weight: 700; color: white;" id="compliantCount">0</div>
                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7);">Compliant</div>
                        </div>
                    </div>
                </div>
                
                <!-- Animated pulse effect -->
                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 30% 50%, rgba(255,255,255,0.1) 0%, transparent 60%); pointer-events: none;"></div>
            </div>
        </div>
    </div>

    <div id="searchResultSection" style="display:none;">
        <h2 style="text-align:center; color: var(--primary-green);">Search Results</h2>
        <table class="data-table">
    <thead>
        <tr>
            <th>Name</th>
            <th>Category</th>
            <th>Specialization</th>
            <th>Province</th>
            <th>Phone</th>
            <th>Rating</th>
            <th>Renewal Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="globalSearchResultsBody"></tbody>
</table>
        <button class="btn-back" onclick="document.getElementById('searchResultSection').style.display='none'; document.getElementById('defaultHomeContent').style.display='block';">← Back to Categories</button>
    </div>
</div>

<!-- ========== CATEGORY PAGE VIEW ========== -->
<div id="categoryPageView" style="display: none;">
    <h2 id="categoryTitle" style="color: #333; text-align: center;">Category Name</h2>
    
    <div class="category-actions-bar">
        <button class="btn btn-add" onclick="openCategoryModal()" id="categoryNewCategoryBtn" >+ New Category</button>
        <button class="btn btn-add" style="background:#3498db " onclick="openSupplierModal()" id="categoryNewSupplierBtn">+ New Supplier</button>
        <button class="btn-edit" onclick="editCurrentCategory()" id="editCategoryBtn" style="padding: 12px 24px;">✏️ Edit Category</button>
    </div>

    <div id="complianceBanner" style="display:none; margin:15px 0; padding:12px; background:#ff4d4d; color:white; border-radius:8px; font-weight:bold; text-align:center;"></div>
    <button class="btn-back" onclick="showView('home')">← Back to Home</button>
    <div style="overflow-x: auto;">
        <table class="data-table compact-table">
            <thead>
                <tr>
                    <th>Supplier Name</th>
                    <th>Specialization</th>
                    <th>Province</th>
                    <th>Phone</th>
                    <th>T-PIN</th>
                    <th>Email</th>
                    <th>Address</th>
                    <th>Rating</th>
                    <th>Compliance</th>
                    <th>Renewal</th>
                    <th>Docs</th>
                    <th>Actions</th>
                    </tr>
            </thead>
            <tbody id="supplierTableBody"></tbody>
        </table>
    </div>
</div>

<!-- ========== ABOUT VIEW ========== -->
<div id="aboutView" style="display: none;">
    <div class="about-card">
        <h2 style="color: var(--primary-green); text-align: center;">About Zed Supplier Directory</h2>
        <p style="color: #555; line-height: 1.6; padding: 0 30px;">
            The Zed Supplier Directory is a specialized digital platform designed to streamline and modernize procurement processes. Serving as a centralized repository for vetted vendors, the system bridges the gap between procurement departments and reliable service providers. <br> By maintaining a comprehensive database of suppliers across diverse industries—including ICT, Construction, Consultancy, and Office Supplies—the directory ensures that organizations can quickly identify, evaluate, and engage with businesses that meet their specific requirements. Our platform focuses on transparency and compliance, requiring suppliers to maintain up-to-date documentation such as TPIN, NAPSA, and ZRA certifications.
        </p>
        <div class="mission-vision-grid">
            <div style="padding:20px; border-left:5px solid var(--primary-green); background:#f9f9f9; border-radius:8px;">
                <h3 style="color: #2c3e50;">Our Mission</h3>
                <p style="color: #555;">To deliver timely, transparent, and ethical procurement solutions with easy supplier engangement.</p>
            </div>
            <div style="padding:20px; border-left:5px solid var(--link-blue); background:#f9f9f9; border-radius:8px;">
                <h3 style="color: #2c3e50;">Our Vision</h3>
                <p style="color: #555;">Our vision is to be the go-to place where the best businesses and organizations connect with ease and total confidence.</p>
            </div>
        </div>
    </div>
</div>

<!-- ========== CONTACT VIEW ========== -->
<div id="contactView" style="display: none; padding: 40px 20px; max-width: 1000px; margin: 0 auto;">
    <div class="about-card">
        <h2 style="color: var(--primary-green); text-align: center;">Contact Information</h2>
        <p style="color: #555; line-height: 1.6; padding: 0 30px;">
            Email: zedsupplierszm@gmail.com<br>
            Phone: +260973031254<br>
            Powered by: Jatkiss Empire Group<br>
        </p>
    </div>
</div>

<!-- ========== LINKS VIEW ========== -->
<div id="linksView" style="display: none; padding: 40px 20px; max-width: 1200px; margin: 0 auto;">
    <h2 style="color: #333;">Links Management</h2>
    <div style="margin-bottom: 20px;" id="addLinkBtnContainer">
        <button class="btn btn-add" onclick="openLinkModal()" id="addLinkBtn">+ Add New Link</button>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th>Institution</th>
                <th>Website</th>
                <th>Email</th>
                <th style="width:80px;" id="linkActionHeader">Action</th>
            </tr>
        </thead>
        <tbody id="linksBody"></tbody>
    </table>
</div>

<!-- ========== AUDIT LOGS VIEW ========== -->
<div id="auditLogsView" style="display: none; padding: 40px 20px; max-width: 1200px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #333; margin:0;">📋 System Audit Trail</h2>
        <div>
            <button id="deleteLast50LogsBtnAudit" class="btn exclusive-super" style="background:#e67e22;" onclick="deleteLast50AuditLogs()">🗑️ Delete Last 50 Logs</button>
            <button id="deleteAllLogsBtnAudit" class="btn exclusive-super" style="background:#c0392b; margin-left:10px;" onclick="deleteAllAuditLogs()">🗑️ Delete All Logs</button>
        </div>
    </div>
    <div class="about-card" style="padding:20px;">
        <div id="auditLogsContainer" style="min-height: 400px;">
            <!-- Audit logs will be loaded here -->
        </div>
        <div id="auditPagination" class="pagination-controls">
            <!-- Pagination controls will be loaded here -->
        </div>
    </div>
</div>

<!-- Add this after the userApprovalHistoryView div (around line 1020 in your main file) -->

<!-- ========== REQUESTS MANAGEMENT VIEW ========== -->
<div id="requestsManagementView" style="display: none; padding: 40px 20px; max-width: 1300px; margin: 0 auto;">
    <div style="background: linear-gradient(145deg, #f8fafc, #f0f4f8); border-radius: 32px; padding: 40px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="background: var(--primary-green); width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 20px;">
                    <span style="font-size: 32px; color: white;">📋</span>
                </div>
                <div>
                    <h2 style="color: #1e3b37; margin: 0; font-size: 28px; font-weight: 700;">Requests Management</h2>
                    <p style="color: #6b9080; margin: 5px 0 0 0; font-size: 15px;">Complete history of all account and approval requests</p>
                </div>
            </div>
            <button onclick="showView('home')" style="background: white; border: none; width: 48px; height: 48px; border-radius: 16px; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #666; box-shadow: 0 4px 12px rgba(0,0,0,0.02);">
                ✕
            </button>
        </div>
        
        <!-- Stats Cards -->
        <div id="requestsStatsCards" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 40px;">
            <!-- Stats will be loaded dynamically -->
        </div>
        
        <!-- Tab Navigation -->
        <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e9ecef; padding-bottom: 16px; flex-wrap: wrap;">
            <button id="pendingAccountsTabBtn" onclick="showRequestsManagementTab('pendingAccounts')" style="background: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 40px; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span>👤</span> PENDING ACCOUNTS <span id="pendingAccountsCount" class="request-count-badge">0</span>
            </button>
            <button id="pendingApprovalsTabBtn" onclick="showRequestsManagementTab('pendingApprovals')" style="background: #34495e; color: white; border: none; padding: 12px 24px; border-radius: 40px; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span>⏳</span> PENDING APPROVALS <span id="pendingApprovalsCount" class="request-count-badge">0</span>
            </button>
            <button id="approvedAccountsTabBtn" onclick="showRequestsManagementTab('approvedAccounts')" style="background: #34495e; color: white; border: none; padding: 12px 24px; border-radius: 40px; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span>✓</span> APPROVED ACCOUNTS
            </button>
            <button id="approvedApprovalsTabBtn" onclick="showRequestsManagementTab('approvedApprovals')" style="background: #34495e; color: white; border: none; padding: 12px 24px; border-radius: 40px; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span>✓</span> APPROVED APPROVALS
            </button>
            <button id="rejectedAccountsTabBtn" onclick="showRequestsManagementTab('rejectedAccounts')" style="background: #34495e; color: white; border: none; padding: 12px 24px; border-radius: 40px; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span>✗</span> REJECTED ACCOUNTS
            </button>
            <button id="rejectedApprovalsTabBtn" onclick="showRequestsManagementTab('rejectedApprovals')" style="background: #34495e; color: white; border: none; padding: 12px 24px; border-radius: 40px; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span>✗</span> REJECTED APPROVALS
            </button>
        </div>
        
        <!-- Content Sections -->
        <div id="pendingAccountsSection" class="requests-section" style="display: block;">
            <h3 style="margin-bottom: 20px; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                <span style="background: #3498db; width: 8px; height: 30px; border-radius: 4px;"></span>
                👤 Pending Account Requests
            </h3>
            <div id="pendingAccountsList" style="max-height: 600px; overflow-y: auto; padding-right: 8px;">
                <div style="text-align: center; padding: 60px; color: #666;">Loading...</div>
            </div>
        </div>
        
        <div id="pendingApprovalsSection" class="requests-section" style="display: none;">
            <h3 style="margin-bottom: 20px; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                <span style="background: #f39c12; width: 8px; height: 30px; border-radius: 4px;"></span>
                ⏳ Pending Approval Requests
            </h3>
            <div id="pendingApprovalsList" style="max-height: 600px; overflow-y: auto; padding-right: 8px;">
                <div style="text-align: center; padding: 60px; color: #666;">Loading...</div>
            </div>
        </div>
        
        <div id="approvedAccountsSection" class="requests-section" style="display: none;">
            <h3 style="margin-bottom: 20px; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                <span style="background: #2ecc71; width: 8px; height: 30px; border-radius: 4px;"></span>
                ✓ Approved Account Requests
            </h3>
            <div id="approvedAccountsList" style="max-height: 600px; overflow-y: auto; padding-right: 8px;">
                <div style="text-align: center; padding: 60px; color: #666;">Loading...</div>
            </div>
        </div>
        
        <div id="approvedApprovalsSection" class="requests-section" style="display: none;">
            <h3 style="margin-bottom: 20px; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                <span style="background: #27ae60; width: 8px; height: 30px; border-radius: 4px;"></span>
                ✓ Approved Approval Requests
            </h3>
            <div id="approvedApprovalsList" style="max-height: 600px; overflow-y: auto; padding-right: 8px;">
                <div style="text-align: center; padding: 60px; color: #666;">Loading...</div>
            </div>
        </div>
        
        <div id="rejectedAccountsSection" class="requests-section" style="display: none;">
            <h3 style="margin-bottom: 20px; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                <span style="background: #e74c3c; width: 8px; height: 30px; border-radius: 4px;"></span>
                ✗ Rejected Account Requests
            </h3>
            <div id="rejectedAccountsList" style="max-height: 600px; overflow-y: auto; padding-right: 8px;">
                <div style="text-align: center; padding: 60px; color: #666;">Loading...</div>
            </div>
        </div>
        
        <div id="rejectedApprovalsSection" class="requests-section" style="display: none;">
            <h3 style="margin-bottom: 20px; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                <span style="background: #c0392b; width: 8px; height: 30px; border-radius: 4px;"></span>
                ✗ Rejected Approval Requests
            </h3>
            <div id="rejectedApprovalsList" style="max-height: 600px; overflow-y: auto; padding-right: 8px;">
                <div style="text-align: center; padding: 60px; color: #666;">Loading...</div>
            </div>
        </div>
        
        <div style="margin-top: 30px; text-align: center;">
            <button class="btn-back" onclick="showView('home')" style="background: #173979;">← Back to Home</button>
        </div>
    </div>
</div>

<!-- ========== USER APPROVAL HISTORY VIEW ========== -->
<div id="userApprovalHistoryView" style="display: none; padding: 40px 20px; max-width: 1200px; margin: 0 auto;">
    <h2 style="color: #333; margin-bottom: 20px;">📜 My Approval Requests</h2>
    <div class="about-card" style="padding: 20px;">
        <div class="approval-tabs">
            <div class="approval-tab active" onclick="switchApprovalHistoryTab('pending')" id="historyPendingTab">Pending Requests</div>
            <div class="approval-tab" onclick="switchApprovalHistoryTab('history')" id="historyHistoryTab">History (Approved/Rejected)</div>
        </div>
        <div id="userApprovalHistoryContainer" style="min-height: 400px;">
            <!-- User approval history will be loaded here -->
        </div>
    </div>
</div>

<!-- SESSIONS PANEL -->
<div id="sessionsPanel" class="sessions-panel">
    <div style="background:var(--primary-green); color:white; padding:12px; display:flex; justify-content:space-between; align-items:center;">
        <span>👥 Active Sessions & Online Status</span>
        <button onclick="toggleSessionsPanel()" style="background:none; border:none; color:white; cursor:pointer;">✕</button>
    </div>
    <div id="activeSessionsList" style="padding:15px; max-height:350px; overflow-y:auto; background:white;"></div>
</div>

<!-- ========== CATEGORY MODAL ========== -->
<div id="categoryModal" class="modal">
    <div class="modal-content" style="border-radius: 20px; max-width: 450px;">
        <h3 id="categoryModalTitle" style="color: var(--primary-green); margin-bottom: 20px; text-align: center;">➕ Add New Category</h3>
        <input type="hidden" id="editingCategoryId">
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">Category Name</label>
            <input type="text" id="categoryNameInput" placeholder="e.g., Stationery & Office Supplies" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; transition: border 0.3s;" onfocus="this.style.borderColor='var(--primary-green)'" onblur="this.style.borderColor='#e0e0e0'">
        </div>
        <div style="display: flex; gap: 15px;">
            <button class="btn btn-add" style="flex: 1; padding: 12px;" onclick="saveNewCategory()" id="categoryModalSaveBtn">Create Category</button>
            <button class="btn" style="flex: 1; background: #95a5a6; padding: 12px;" onclick="closeCategoryModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- ========== SUPPLIER MODAL ========== -->
<div id="supplierModal" class="modal" style="display: none;">
    <div class="modal-content" style="width: 700px; max-width: 95%; border-radius: 24px; padding: 30px;">
        <h3 id="supplierModalTitle" style="color: var(--primary-green); margin-bottom: 25px; text-align: center; font-size: 1.8rem;">➕ Add New Supplier</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Left Column -->
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Supplier Name *</label>
                <input type="text" id="supplierName" placeholder="e.g., ABC Supplies Ltd" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Specialization</label>
                <input type="text" id="supplierSpecialization" placeholder="e.g., Office Equipment" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Phone Number *</label>
                <input type="text" id="supplierPhone" placeholder="e.g., +260977123456" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">T PIN</label>
                <input type="text" id="supplierTpin" placeholder="Taxpayer PIN" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Email</label>
                <input type="email" id="supplierEmail" placeholder="contact@supplier.com" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Physical Address</label>
                <input type="text" id="supplierAddress" placeholder="Full address" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
            </div>
            
            <!-- Right Column -->
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Category *</label>
<select id="supplierCategory" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
    <option value="">Select Category</option>
</select>

<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Province *</label>
<select id="supplierProvince" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;">
    <option value="">Select Province</option>
    <option value="Lusaka Province">Lusaka Province</option>
    <option value="Copperbelt Province">Copperbelt Province</option>
    <option value="Central Province">Central Province</option>
    <option value="Eastern Province">Eastern Province</option>
    <option value="Muchinga Province">Muchinga Province</option>
    <option value="Luapula Province">Luapula Province</option>
    <option value="Southern Province">Southern Province</option>
    <option value="Western Province">Western Province</option>
    <option value="North-Western Province">North-Western Province</option>
    <option value="Northern Province">Northern Province</option>
</select>
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Rating (1-5 Stars)</label>
                <div class="rating" id="supplierRatingContainer" style="margin-bottom: 20px;">
                    <input type="radio" name="rating" id="star5" value="5"><label for="star5"></label>
                    <input type="radio" name="rating" id="star4" value="4"><label for="star4"></label>
                    <input type="radio" name="rating" id="star3" value="3"><label for="star3"></label>
                    <input type="radio" name="rating" id="star2" value="2"><label for="star2"></label>
                    <input type="radio" name="rating" id="star1" value="1" checked><label for="star1"></label>
                </div>
                
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #555;">Compliance Status</label>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
    <div style="display: flex; align-items: center; margin-bottom: 10px;">
        <input type="checkbox" id="complianceTpin" style="width: 18px; height: 18px; margin-right: 10px;">
        <label for="complianceTpin" style="flex:1;">TPIN Registered</label>
        <span id="complianceTpinStatus" style="font-size: 12px; padding: 3px 8px; border-radius: 20px; background: #e74c3c; color: white;">Not Compliant</span>
    </div>
    <div style="display: flex; align-items: center; margin-bottom: 10px;">
        <input type="checkbox" id="complianceNapsa" style="width: 18px; height: 18px; margin-right: 10px;">
        <label for="complianceNapsa" style="flex:1;">NAPSA Registered</label>
        <span id="complianceNapsaStatus" style="font-size: 12px; padding: 3px 8px; border-radius: 20px; background: #e74c3c; color: white;">Not Compliant</span>
    </div>
    <div style="display: flex; align-items: center; margin-bottom: 10px;">
        <input type="checkbox" id="complianceZra" style="width: 18px; height: 18px; margin-right: 10px;">
        <label for="complianceZra" style="flex:1;">ZRA Registered</label>
        <span id="complianceZraStatus" style="font-size: 12px; padding: 3px 8px; border-radius: 20px; background: #e74c3c; color: white;">Not Compliant</span>
    </div>
    <div style="display: flex; align-items: center; margin-bottom: 10px;">
        <input type="checkbox" id="complianceZppa" style="width: 18px; height: 18px; margin-right: 10px;">
        <label for="complianceZppa" style="flex:1;">ZPPA Registered</label>
        <span id="complianceZppaStatus" style="font-size: 12px; padding: 3px 8px; border-radius: 20px; background: #e74c3c; color: white;">Not Compliant</span>
    </div>
    <!-- NEW: Active on E-Gp System checkbox -->
    <div style="display: flex; align-items: center; margin-bottom: 10px; background: linear-gradient(135deg, #f0f9ff, #e6f2ff); padding: 8px 12px; border-radius: 8px;">
        <input type="checkbox" id="complianceEgp" style="width: 18px; height: 18px; margin-right: 10px; accent-color: #3498db;">
        <label for="complianceEgp" style="flex:1; font-weight: 600; color: #2c3e50;">Active on E-Gp System</label>
        <span id="complianceEgpStatus" style="font-size: 12px; padding: 3px 8px; border-radius: 20px; background: #e74c3c; color: white;">Not Active</span>
    </div>
    <div style="margin-top: 15px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span style="font-size: 12px;">Overall Compliance</span>
            <span id="overallCompliancePercent">0%</span>
        </div>
        <div class="compliance-bar-container">
            <div id="overallComplianceBar" class="compliance-bar-fill poor" style="width: 0%;"></div>
        </div>
    </div>
</div>
                
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Renewal Status</label>
                <div style="display: flex; gap: 10px; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 12px;">
                    <div style="flex:1;">
                        <select id="supplierRenewalMonth" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            <option value="0">January</option>
                            <option value="1">February</option>
                            <option value="2">March</option>
                            <option value="3">April</option>
                            <option value="4">May</option>
                            <option value="5">June</option>
                            <option value="6">July</option>
                            <option value="7">August</option>
                            <option value="8">September</option>
                            <option value="9">October</option>
                            <option value="10">November</option>
                            <option value="11" selected>December</option>
                        </select>
                    </div>
                    <div style="flex:1;">
                        <select id="supplierRenewalYear" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Document Upload Section -->
        <div style="margin-top: 25px; border-top: 1px solid #e0e0e0; padding-top: 20px;">
            <h4 style="color: #333; margin-bottom: 15px;">📄 Required Documents (Max 3MB each)</h4>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('tpinDocUpload').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">📑</span>
                        <p style="margin: 5px 0; font-weight: 600;">TPIN</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="tpinDocUpload" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleDocumentUpload('tpin', this)">
                    <div id="tpinDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('napsaDocUpload').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">📑</span>
                        <p style="margin: 5px 0; font-weight: 600;">NAPSA</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="napsaDocUpload" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleDocumentUpload('napsa', this)">
                    <div id="napsaDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('zraDocUpload').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">📑</span>
                        <p style="margin: 5px 0; font-weight: 600;">ZRA</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="zraDocUpload" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleDocumentUpload('zra', this)">
                    <div id="zraDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                <div>
                    <div class="document-upload-area" onclick="document.getElementById('zppaDocUpload').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">📑</span>
                        <p style="margin: 5px 0; font-weight: 600;">ZPPA</p>
                        <p style="font-size: 10px; color: #666;">Click to upload</p>
                    </div>
                    <input type="file" id="zppaDocUpload" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleDocumentUpload('zppa', this)">
                    <div id="zppaDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button id="supplierModalSaveBtn" class="btn btn-add" style="flex: 1; padding: 14px; font-size: 16px;" onclick="saveSupplier()">Save Supplier</button>
            <button class="btn" style="flex: 1; background: #95a5a6; padding: 14px; font-size: 16px;" onclick="closeSupplierModal()">Cancel</button>
        </div>
        <input type="hidden" id="editingSupplierId">
        <input type="hidden" id="supplierActionType" value="add">
    </div>
</div>

<!-- ========== APPROVAL ACTION MODAL ========== -->
<div id="approvalActionModal" class="modal" style="display: none;">
    <div class="modal-content" style="width: 500px; border-radius: 24px; padding: 30px;">
        <h3 id="approvalActionTitle" style="color: var(--warning-orange); margin-bottom: 20px; text-align: center;">Approve Request</h3>
        <div id="approvalActionDetails" style="margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 12px;"></div>
        <div style="display: flex; gap: 15px;">
            <button class="btn" style="flex: 1; background: var(--primary-green);" onclick="confirmApproval(true)">✓ Approve</button>
            <button class="btn" style="flex: 1; background: var(--danger-red);" onclick="openRejectReasonModal()">✗ Reject</button>
            <button class="btn" style="flex: 1; background: #95a5a6;" onclick="closeApprovalActionModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- USER DOCUMENT VIEWER MODAL -->
<div id="userDocumentViewerModal" class="modal" style="display: none; z-index: 30000;">
    <div class="modal-content" style="width: 90%; max-width: 1200px; height: 90vh; padding: 0; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column;">
        <div style="background: var(--primary-green); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <h3 id="userDocumentViewerTitle" style="margin: 0; font-size: 1.2rem;">Document Viewer</h3>
            <button onclick="closeUserDocumentViewer()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">✕</button>
        </div>
        <div id="userDocumentViewerContent" style="flex: 1; padding: 20px; overflow: auto; background: #f5f5f5; display: flex; flex-direction: column; align-items: center;">
            <!-- Document will be loaded here -->
        </div>
        <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; display: flex; justify-content: flex-end; gap: 10px;">
            <button id="downloadUserDocumentBtn" class="btn btn-add" style="padding: 8px 20px;" onclick="downloadCurrentUserDocument()">📥 Download</button>
            <button class="btn" style="background: #6c757d; padding: 8px 20px;" onclick="closeUserDocumentViewer()">Close</button>
        </div>
    </div>
</div>

<!-- USER MANAGEMENT MODAL -->
<div id="userManagementModal" class="modal" style="display:none;">
    <div class="modal-content" style="width:600px; border-radius: 24px;">
        <h3 style="color:var(--primary-green); margin-bottom:15px;">👤 User Management</h3>
        <!-- In the userManagementModal div, replace with these enhanced buttons -->
<div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:15px;">
    <button class="btn btn-add" onclick="openAddUserModal()" id="addUserBtn">+ Add User</button>
    <button id="deleteAllLogsBtn" class="btn exclusive-super" style="background:#c0392b;" onclick="deleteAllAuditLogs()">🗑️ Delete All Logs</button>
    <button id="deleteLast50LogsBtn" class="btn exclusive-super" style="background:#e67e22;" onclick="deleteLast50AuditLogs()">🗑️ Delete Last 50 Logs</button>
    
    <!-- Enhanced duplicate management buttons -->
    <button id="checkAllDuplicatesBtn" class="btn exclusive-super" style="background:#3498db;" onclick="checkAllDuplicates()">
        🔍 Check All Duplicates
    </button>
    <button id="removeAllDuplicatesBtn" class="btn exclusive-super" style="background:#e74c3c;" onclick="removeAllDuplicateAccounts()">
        🗑️ Remove All Duplicates
    </button>
    <button class="btn exclusive-super" style="background:#9b59b6" onclick="migrateSuppliersAddProvince()">
    🗺️ Migrate Province Data
</button>
</div>
        <div style="max-height:400px; overflow-y:auto;">
            <table class="user-mgmt-table" style="width:100%;">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Phone</th>
                        <th>Email/NRC</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="userMgmtTableBody"></tbody>
            </table>
        </div>
        <button onclick="closeUserMgmtModal()" class="btn" style="background:#777; width:100%; margin-top:15px;">Close</button>
    </div>
</div>

<!-- JOSEPH'S SUPER ADMIN PASSWORD VAULT (Only visible to JOSEPH) -->
<div id="josephPasswordVault" class="modal" style="display:none; z-index: 50000;">
    <div class="modal-content" style="width: 100%; height: 100vh; max-width: 100%; border-radius: 0; padding: 0; overflow: hidden; background: linear-gradient(145deg, #f8fafc, #f0f4f8); margin: 0;">
        
        <!-- Header with Joseph's special badge - more compact -->
        <div style="background: linear-gradient(135deg, #9b59b6, #8e44ad); padding: 16px 24px; position: relative; overflow: hidden;">
            <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
            
            <div style="display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 2;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 20px;">👑</span>
                    </div>
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <h2 style="color: white; margin: 0; font-size: 18px; font-weight: 600;">Password Vault</h2>
                            <span style="background: #f1c40f; color: #2c3e50; padding: 2px 10px; border-radius: 20px; font-size: 10px; font-weight: 600;">JOSEPH ONLY</span>
                        </div>
                        <p style="color: rgba(255,255,255,0.8); margin: 2px 0 0 0; font-size: 11px;">Full user details with passwords</p>
                    </div>
                </div>
                <button onclick="closeJosephPasswordVault()" style="background: rgba(255,255,255,0.2); border: none; width: 36px; height: 36px; border-radius: 10px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; transition: all 0.2s;">
                    ✕
                </button>
            </div>
        </div>
        
        <!-- Compact Stats Cards -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 16px 24px 0 24px;">
            <div style="background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); border-left: 3px solid #9b59b6; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">👥</span>
                <div>
                    <div style="font-size: 16px; font-weight: 600; color: #9b59b6; line-height: 1.2;" id="josephTotalUsers">0</div>
                    <div style="font-size: 10px; color: #666;">Total</div>
                </div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); border-left: 3px solid #3498db; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">👤</span>
                <div>
                    <div style="font-size: 16px; font-weight: 600; color: #3498db; line-height: 1.2;" id="josephStaffCount">0</div>
                    <div style="font-size: 10px; color: #666;">Staff</div>
                </div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); border-left: 3px solid #f39c12; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">🔐</span>
                <div>
                    <div style="font-size: 16px; font-weight: 600; color: #f39c12; line-height: 1.2;" id="josephAdminCount">0</div>
                    <div style="font-size: 10px; color: #666;">Admins</div>
                </div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); border-left: 3px solid #e74c3c; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">👑</span>
                <div>
                    <div style="font-size: 16px; font-weight: 600; color: #e74c3c; line-height: 1.2;" id="josephSuperAdminCount">0</div>
                    <div style="font-size: 10px; color: #666;">Super</div>
                </div>
            </div>
        </div>
        
        <!-- Search and Actions - compact -->
        <div style="padding: 12px 24px; display: flex; gap: 10px; align-items: center;">
            <div style="flex: 1; position: relative;">
                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9b59b6; font-size: 14px;">🔍</span>
                <input type="text" id="josephPasswordSearch" placeholder="Search users..." 
                       style="width: 100%; padding: 10px 10px 10px 35px; border: 1px solid #e0e0e0; border-radius: 30px; font-size: 13px; background: white;">
            </div>
            <button onclick="exportJosephPasswordVault()" style="background: white; border: 1px solid #9b59b6; color: #9b59b6; padding: 10px 20px; border-radius: 30px; font-size: 12px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                <span style="font-size: 14px;">📥</span> Export
            </button>
        </div>
        
        <!-- User Cards Grid - full height scrollable -->
        <div style="padding: 0 24px 24px 24px; height: calc(100vh - 160px); overflow-y: auto;" id="josephPasswordVaultGrid">
            <!-- Users will be loaded here dynamically -->
        </div>
        
        <!-- Footer Note - compact -->
        <div style="padding: 8px 24px; background: #f8f9fa; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; font-size: 10px; color: #666;">
            <div>
                <span style="background: #9b59b6; color: white; padding: 2px 8px; border-radius: 20px; font-weight: 500; margin-right: 8px; font-size: 9px;">🔒 SECURE</span>
                JOSEPH exclusive
            </div>
            <div id="josephVaultTimestamp">Just now</div>
        </div>
    </div>
</div>

<!-- EDIT USER MODAL - Updated with Full Name and Document Uploads -->
<div id="editUserModal" class="modal" style="display:none;">
    <div class="modal-content" style="border-radius: 24px; max-width: 600px;">
        <h3 id="editUserTitle">✏️ Edit User</h3>
        <input type="hidden" id="editUserId">
        
        <!-- Full Name (NEW) -->
        <input type="text" id="editFullName" placeholder="Full Name *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        
        <input type="text" id="editUsername" placeholder="Username" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;" readonly>
        <select id="editRole" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
            <option value="staff">Staff</option>
            <option value="admin">Admin</option>
            <option value="super admin">Super Admin</option>
        </select>
        <input type="text" id="editNrc" placeholder="NRC Number *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="email" id="editEmail" placeholder="Email Address" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="editPhone" placeholder="Phone Number" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="editInstitution" placeholder="Institution / Dept" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="editPosition" placeholder="Position" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="password" id="editPassword" placeholder="New Password (leave blank to keep current)" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        
        <!-- Document Upload Section for Edit (NEW) -->
        <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
            <h4 style="color: var(--primary-green); margin-bottom: 15px;">📄 Documents</h4>
            
            <div style="display: grid; gap: 15px;">
                <!-- Degree/Diploma -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Degree/Diploma Certificate</label>
                    <div class="document-upload-area" onclick="document.getElementById('editDegreeDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">🎓</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload New Degree/Diploma</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="editDegreeDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('editDegree', this)">
                    <div id="editDegreeDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                
                <!-- ZIPS Membership -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ZIPS Membership Certificate</label>
                    <div class="document-upload-area" onclick="document.getElementById('editZipsDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">📜</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload New ZIPS Certificate</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="editZipsDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('editZips', this)">
                    <div id="editZipsDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                
                <!-- NRC -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">NRC (National Registration Card)</label>
                    <div class="document-upload-area" onclick="document.getElementById('editNrcDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">🪪</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload New NRC</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="editNrcDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('editNrc', this)">
                    <div id="editNrcDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
            </div>
            
            <div id="editCurrentDocs" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h5 style="margin: 0 0 10px 0; color: #555;">Current Documents:</h5>
                <div id="editCurrentDocsList"></div>
            </div>
        </div>
        
        <div style="display:flex; align-items:center; margin:10px 0;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input type="checkbox" id="editEnabled" style="width:16px; height:16px;">
                <span style="font-size:14px;">Account Enabled</span>
            </label>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-add" style="flex:1;" onclick="saveUserEdit()">💾 Save Changes</button>
            <button class="btn" style="background:#777; flex:1;" onclick="closeEditUserModal()">Cancel</button>
        </div>
    </div>
</div>


<div id="addUserModal" class="modal" style="display:none;">
    <div class="modal-content" style="border-radius: 24px; max-width: 600px;">
        <h3 id="addUserTitle">➕ Add New User</h3>
        
        <input type="text" id="newFullName" placeholder="Full Name *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        
        <input type="text" id="newUsername" placeholder="Username *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <select id="newRole" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
            <option value="staff">Staff</option>
            <option value="admin">Admin</option>
            <option value="super admin">Super Admin</option>
        </select>
        <input type="text" id="newNrc" placeholder="NRC Number *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="email" id="newEmail" placeholder="Email Address" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="newPhone" placeholder="Phone Number" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="newInstitution" placeholder="Institution / Dept" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="newPosition" placeholder="Position" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="password" id="newPassword" placeholder="Password *" style="width:100%; padding:12px; margin:6px 0; border:2px solid #e0e0e0; border-radius:10px;">
        
        <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
            <h4 style="color: var(--primary-green); margin-bottom: 15px;">📄 Required Documents (Max 3MB each)</h4>
            
            <div style="display: grid; gap: 15px;">


                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Degree/Diploma Certificate *</label>
                    <div class="document-upload-area" onclick="document.getElementById('newDegreeDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">🎓</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload Degree/Diploma</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="newDegreeDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('degree', this)">
                    <div id="newDegreeDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ZIPS Membership Certificate *</label>
                    <div class="document-upload-area" onclick="document.getElementById('newZipsDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">📜</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload ZIPS Certificate</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="newZipsDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('zips', this)">
                    <div id="newZipsDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">NRC (National Registration Card) *</label>
                    <div class="document-upload-area" onclick="document.getElementById('newNrcDoc').click()" style="padding: 15px;">
                        <span style="font-size: 24px;">🪪</span>
                        <p style="margin: 5px 0; font-weight: 600;">Upload NRC</p>
                        <p style="font-size: 10px; color: #666;">Click to upload (PDF, PNG, JPEG)</p>
                    </div>
                    <input type="file" id="newNrcDoc" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleUserDocumentUpload('nrc', this)">
                    <div id="newNrcDocPreview" style="margin-top: 5px; font-size: 11px;"></div>
                </div>
            </div>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-add" style="flex:1;" onclick="saveNewUser()">Save User</button>
            <button class="btn" style="background:#777; flex:1;" onclick="closeAddUserModal()">Cancel</button>
        </div>
    </div>
</div>

<div id="linkModal" class="modal">
    <div class="modal-content" style="border-radius: 24px;">
        <h3 style="color: var(--primary-green); text-align: center;">➕ Add New Link</h3>
        <input type="text" id="instName" placeholder="Institution Name" style="width:100%; padding:12px; margin:8px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="text" id="instWeb" placeholder="Website" style="width:100%; padding:12px; margin:8px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <input type="email" id="instEmail" placeholder="Email" style="width:100%; padding:12px; margin:8px 0; border:2px solid #e0e0e0; border-radius:10px;">
        <button class="btn btn-add" style="width:100%; margin-top:15px; padding:12px;" onclick="addLink()">Save Link</button>
        <button class="btn" style="background:#95a5a6; width:100%; margin-top:8px; padding:12px;" onclick="closeLinkModal()">Cancel</button>
    </div>
</div>
<div id="notification" class="notification"></div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<script>
    const TAB_LOCK_KEY = 'zamcom_tab_lock';
    const TAB_ID = Math.random().toString(36).substring(2) + Date.now();
    
    function enforceSingleTab() {
        const existingTabId = localStorage.getItem(TAB_LOCK_KEY);
        const currentTime = Date.now();
        
        if (existingTabId) {
            try {
                const tabData = JSON.parse(existingTabId);
                if (tabData.id && (currentTime - tabData.timestamp < 2000)) {
                    document.getElementById('tabConflictWarning').style.display = 'block';
                    return false;
                }
            } catch (e) {}
        }
        
        localStorage.setItem(TAB_LOCK_KEY, JSON.stringify({
            id: TAB_ID,
            timestamp: currentTime
        }));
        
        window.addEventListener('beforeunload', function() {
            const currentLock = localStorage.getItem(TAB_LOCK_KEY);
            if (currentLock) {
                try {
                    const tabData = JSON.parse(currentLock);
                    if (tabData.id === TAB_ID) {
                        localStorage.removeItem(TAB_LOCK_KEY);
                    }
                } catch (e) {}
            }
        });
        
        window.addEventListener('storage', function(e) {
            if (e.key === TAB_LOCK_KEY) {
                if (e.newValue) {
                    try {
                        const newTabData = JSON.parse(e.newValue);
                        if (newTabData.id !== TAB_ID) {
                            document.getElementById('tabConflictWarning').style.display = 'block';
                        }
                    } catch (ex) {}
                }
            }
        });
        
        return true;
    }

function handleRequestDocumentUpload(docType, input) {
    console.log('Uploading document:', docType);
    
    const file = input.files[0];
    if (!file) {
        console.log('No file selected');
        return;
    }
    
    console.log(`Uploading ${docType} document:`, file.name, 'Size:', file.size);
    
    if (file.size > 3 * 1024 * 1024) {
        alert(`File size exceeds 1MB limit for ${docType} document`);
        input.value = '';
        return;
    }
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        console.log(`FileReader loaded ${docType} document successfully`);
        
        requestDocuments[docType] = {
            name: file.name,
            type: file.type || 'application/octet-stream',
            size: file.size,
            data: e.target.result,
            uploadedAt: new Date().toISOString()
        };
        
        console.log(`${docType} document stored successfully`);
        
        const previewId = `request${docType.charAt(0).toUpperCase() + docType.slice(1)}DocPreview`;
        const previewEl = document.getElementById(previewId);
        if (previewEl) {
            previewEl.innerHTML = `<span style="color: var(--primary-green); font-weight: bold;">✓ ${file.name.substring(0, 30)}${file.name.length > 30 ? '...' : ''}</span>`;
        }
        
        if (typeof showNotification === 'function') {
            showNotification(`${docType.toUpperCase()} document uploaded successfully`, 'success');
        } else {
            alert(`${docType.toUpperCase()} document uploaded successfully`);
        }
    };
    
    reader.onerror = function(error) {
        console.error('FileReader error:', error);
        alert('Error reading file. Please try again.');
        input.value = '';
    };
    
    reader.readAsDataURL(file);
}

function clearSearch() {
    const searchInput = document.getElementById('globalSearch');
    if (searchInput) {
        searchInput.value = '';
    }
    document.getElementById('searchResultSection').style.display = 'none';
    document.getElementById('defaultHomeContent').style.display = 'block';
}

async function submitAccountRequest() {
    console.log('Starting account request submission...');
    
    const fullName = document.getElementById('requestFullName')?.value?.trim() || '';
    const username = document.getElementById('requestUsername')?.value?.toUpperCase().trim() || '';
    const nrc = document.getElementById('requestNrc')?.value?.trim() || '';
    const phone = document.getElementById('requestPhone')?.value?.trim() || '';
    const institution = document.getElementById('requestInstitution')?.value?.trim() || '';
    const position = document.getElementById('requestPosition')?.value?.trim() || '';
    const email = document.getElementById('requestEmail')?.value?.trim() || '';
    const password = document.getElementById('requestPassword')?.value?.trim() || '';

    console.log('Form values:', { fullName, username, nrc, phone, email });

    const missingFields = [];
    if (!fullName) missingFields.push('Full Name');
    if (!username) missingFields.push('Username');
    if (!nrc) missingFields.push('NRC');
    if (!phone) missingFields.push('Phone Number');
    if (!institution) missingFields.push('Institution');
    if (!position) missingFields.push('Position');
    if (!email) missingFields.push('Email');
    if (!password) missingFields.push('Password');

    if (missingFields.length > 0) {
        alert(`Please fill in all required fields: ${missingFields.join(', ')}`);
        return;
    }

    console.log('Checking documents:', requestDocuments);
    
    const missingDocs = [];
    if (!requestDocuments.nrc) missingDocs.push('NRC');
    if (!requestDocuments.degree) missingDocs.push('Degree/Diploma');
    if (!requestDocuments.zips) missingDocs.push('ZIPS Certificate');

    if (missingDocs.length > 0) {
        alert(`Please upload all required documents: ${missingDocs.join(', ')}`);
        return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert('Please enter a valid email address');
        return;
    }

    const submitBtn = document.querySelector('#accountRequestModal .btn-add');
    if (submitBtn) {
        submitBtn.innerHTML = '⏳ Checking...';
        submitBtn.disabled = true;
    }

    try {
        console.log('Checking for existing approved users...');
        
        const usernameSnapshot = await db.collection(COLLECTIONS.USERS)
            .where('username', '==', username)
            .get();
        
        const nrcSnapshot = await db.collection(COLLECTIONS.USERS)
            .where('nrc', '==', nrc)
            .get();
        
        const phoneSnapshot = await db.collection(COLLECTIONS.USERS)
            .where('phone', '==', phone)
            .get();
        
        const emailSnapshot = await db.collection(COLLECTIONS.USERS)
            .where('email', '==', email)
            .get();
        
        const potentialDuplicates = [];
        
        usernameSnapshot.forEach(doc => potentialDuplicates.push({ id: doc.id, ...doc.data(), matchedBy: 'username' }));
        nrcSnapshot.forEach(doc => potentialDuplicates.push({ id: doc.id, ...doc.data(), matchedBy: 'NRC' }));
        phoneSnapshot.forEach(doc => potentialDuplicates.push({ id: doc.id, ...doc.data(), matchedBy: 'phone' }));
        emailSnapshot.forEach(doc => potentialDuplicates.push({ id: doc.id, ...doc.data(), matchedBy: 'email' }));
        
        const uniqueDuplicates = [];
        const seenIds = new Set();
        
        potentialDuplicates.forEach(user => {
            if (!seenIds.has(user.id)) {
                seenIds.add(user.id);
                uniqueDuplicates.push(user);
            }
        });
        
        if (uniqueDuplicates.length > 0) {
            let message = '❌ Account Already Exists!\n\n';
            message += 'The following information matches existing accounts:\n\n';
            
            uniqueDuplicates.forEach(user => {
                const matchedFields = [];
                if (user.username === username) matchedFields.push('Username');
                if (user.nrc === nrc) matchedFields.push('NRC');
                if (user.phone === phone) matchedFields.push('Phone');
                if (user.email === email) matchedFields.push('Email');
                
                message += `• ${user.fullName || user.username} - Matched by: ${matchedFields.join(', ')}\n`;
            });
            
            message += '\nIf you believe this is an error, please contact support at zedsupplierdirectoryzm@gmail.com';
            
            alert(message);
            
            if (submitBtn) {
                submitBtn.innerHTML = 'Submit Request';
                submitBtn.disabled = false;
            }
            return;
        }
        
        console.log('Checking for pending approval requests...');
        
        const usernameRequests = await db.collection('account_requests')
            .where('username', '==', username)
            .where('status', '==', 'pending')
            .get();
        
        if (!usernameRequests.empty) {
            alert('⏳ Account Already Submitted - Pending Approval\n\nA pending account request with this username already exists. Please wait for approval. If you need assistance, contact support at zedsupplierdirectoryzm@gmail.com');
            
            if (submitBtn) {
                submitBtn.innerHTML = 'Submit Request';
                submitBtn.disabled = false;
            }
            return;
        }
        
        const nrcRequests = await db.collection('account_requests')
            .where('nrc', '==', nrc)
            .where('status', '==', 'pending')
            .get();
        
        if (!nrcRequests.empty) {
            alert('⏳ Account Already Submitted - Pending Approval\n\nA pending account request with this NRC number already exists. Please wait for approval. If you need assistance, contact support at zedsupplierdirectoryzm@gmail.com');
            
            if (submitBtn) {
                submitBtn.innerHTML = 'Submit Request';
                submitBtn.disabled = false;
            }
            return;
        }
        
        const phoneRequests = await db.collection('account_requests')
            .where('phone', '==', phone)
            .where('status', '==', 'pending')
            .get();
        
        if (!phoneRequests.empty) {
            alert('⏳ Account Already Submitted - Pending Approval\n\nA pending account request with this phone number already exists. Please wait for approval. If you need assistance, contact support at zedsupplierdirectoryzm@gmail.com');
            
            if (submitBtn) {
                submitBtn.innerHTML = 'Submit Request';
                submitBtn.disabled = false;
            }
            return;
        }
        
        const emailRequests = await db.collection('account_requests')
            .where('email', '==', email)
            .where('status', '==', 'pending')
            .get();
        
        if (!emailRequests.empty) {
            alert('⏳ Account Already Submitted - Pending Approval\n\nA pending account request with this email address already exists. Please wait for approval. If you need assistance, contact support at zedsupplierdirectoryzm@gmail.com');
            
            if (submitBtn) {
                submitBtn.innerHTML = 'Submit Request';
                submitBtn.disabled = false;
            }
            return;
        }
        
        const rejectedRequestsSnapshot = await db.collection('account_requests')
            .where('username', '==', username)
            .where('status', '==', 'rejected')
            .get();

        if (!rejectedRequestsSnapshot.empty) {
            const rejectedRequests = rejectedRequestsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            rejectedRequests.sort((a, b) => {
                const dateA = a.requestedAt ? new Date(a.requestedAt) : new Date(0);
                const dateB = b.requestedAt ? new Date(b.requestedAt) : new Date(0);
                return dateB - dateA;
            });
            
            const lastRejected = rejectedRequests[0];
            const rejectedDate = lastRejected.rejectedAt ? new Date(lastRejected.rejectedAt).toLocaleDateString() : 'Unknown date';
            const rejectReason = lastRejected.rejectionReason || 'No reason provided';
            
            const proceed = confirm(`⚠️ You had a previous account request that was rejected on ${rejectedDate}.\n\nRejection reason: ${rejectReason}\n\nDo you want to submit a new request anyway?`);
            
            if (!proceed) {
                if (submitBtn) {
                    submitBtn.innerHTML = 'Submit Request';
                    submitBtn.disabled = false;
                }
                return;
            }
        }
        
        console.log('No duplicate found, proceeding with submission...');
        
        const requestData = {
            fullName: fullName,
            username: username,
            nrc: nrc,
            phone: phone,
            institution: institution,
            position: position,
            email: email,
            password: password,
            documents: {
                nrc: requestDocuments.nrc,
                degree: requestDocuments.degree,
                zips: requestDocuments.zips
            },
            requestedAt: new Date().toISOString(),
            status: 'pending',
            role: 'staff'
        };

        console.log('Submitting request with documents:', {
            nrcDoc: requestDocuments.nrc?.name || 'none',
            degreeDoc: requestDocuments.degree?.name || 'none',
            zipsDoc: requestDocuments.zips?.name || 'none'
        });
        
        await db.collection('account_requests').add(requestData);
        
        if (typeof logAudit === 'function') {
            await logAudit('ACCOUNT_REQUEST', {
                username: username,
                fullName: fullName,
                email: email,
                phone: phone,
                nrc: nrc,
                requestedAt: new Date().toISOString()
            });
        }
        
        alert('✅ Your Account Creation request has been submitted successfully!\n\nIf Approved, you will receive an email and be able to access your account within 24 Hours. If rejected or no response after 24 Hours, contact: zedsupplierdirectoryzm@gmail.com');
        closeAccountRequestModal();

    } catch (error) {
        console.error('Error submitting account request:', error);
        alert('Failed to submit account request. Error: ' + error.message);
    } finally {
        if (submitBtn) {
            submitBtn.innerHTML = 'Submit Request';
            submitBtn.disabled = false;
        }
    }
}

function closeAccountRequestModal() {
    document.getElementById('accountRequestModal').style.display = 'none';
    document.getElementById('loginOverlay').style.display = 'flex';
    
    requestDocuments = { nrc: null, degree: null, zips: null };
    
    const nrcInput = document.getElementById('requestNrcDoc');
    const degreeInput = document.getElementById('requestDegreeDoc');
    const zipsInput = document.getElementById('requestZipsDoc');
    
    if (nrcInput) nrcInput.value = '';
    if (degreeInput) degreeInput.value = '';
    if (zipsInput) zipsInput.value = '';
    
    const nrcPreview = document.getElementById('requestNrcDocPreview');
    const degreePreview = document.getElementById('requestDegreeDocPreview');
    const zipsPreview = document.getElementById('requestZipsDocPreview');
    
    if (nrcPreview) nrcPreview.innerHTML = '';
    if (degreePreview) degreePreview.innerHTML = '';
    if (zipsPreview) zipsPreview.innerHTML = '';
}

    function forceTakeover() {
        localStorage.setItem(TAB_LOCK_KEY, JSON.stringify({
            id: TAB_ID,
            timestamp: Date.now()
        }));
        document.getElementById('tabConflictWarning').style.display = 'none';
        showNotification('Tab takeover successful', 'success');
    }

    const firebaseConfig = {
        apiKey: "AIzaSyCJrqk15bvd1746VkkDAcOM_U9w0PH7dP0",
        authDomain: "supplierdirectory-6e5c7.firebaseapp.com",
        projectId: "supplierdirectory-6e5c7",
        storageBucket: "supplierdirectory-6e5c7.firebasestorage.app",
        messagingSenderId: "434327330685",
        appId: "1:434327330685:web:6ac7e874dc5952a89c3614"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    const CACHE_DURATION = 30000;
    const dataCache = {
        categories: { data: null, timestamp: 0 },
        suppliers: { data: null, timestamp: 0 },
        links: { data: null, timestamp: 0 },
        users: { data: null, timestamp: 0 },
        approvalRequests: { data: null, timestamp: 0 }
    };

        const requestsCache = {
            approvalRequests: { data: null, timestamp: 0 },
            accountRequests: { data: null, timestamp: 0 }
        };

const REQUESTS_CACHE_DURATION = 60000;

    async function getCachedData(collectionName, forceRefresh = false) {
        const cache = dataCache[collectionName];
        const now = Date.now();
        
        if (!forceRefresh && cache.data && (now - cache.timestamp) < CACHE_DURATION) {
            return cache.data;
        }
        
        let snapshot;
        if (collectionName === 'approvalRequests') {
            snapshot = await db.collection(COLLECTIONS.APPROVALS)
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc')
                .get();
        } else {
            snapshot = await db.collection(COLLECTIONS[collectionName.toUpperCase()]).get();
        }
        
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        cache.data = data;
        cache.timestamp = now;
        
        return data;
    }

    const ZAMBIAN_PROVINCES = [
        "All Provinces",
        "Lusaka Province",
        "Copperbelt Province",
        "Central Province",
        "Eastern Province",
        "Muchinga Province",
        "Luapula Province",
        "Southern Province",
        "Western Province",
        "North-Western Province",
        "Northern Province"
    ];

    let categories = [];
    let suppliers = [];
    let links = [];
    let userAccounts = [];
    let auditLogs = [];
    let approvalRequests = [];
    let currentCategory = "";
    let currentCategoryId = "";
    let currentGalleryImages = [];
    let currentGalleryIndex = 0;
    let bgIndex = 0;
    let sessionHeartbeat = null;
    let uploadedDocuments = {
        tpin: null,
        napsa: null,
        zra: null,
        zppa: null
    };
     let currentFullscreenDocument = null;
    let currentViewingDocuments = null;
    let currentViewingEntity = null;
    
    let requestDocuments = {
        nrc: null,
        degree: null,
        zips: null
    };

    let userUploadedDocuments = {
        degree: null,
        zips: null,
        nrc: null
    };
    let pendingDeletionCallback = null;
    let lockScreenInterval = null;
    let pendingAccountRequest = null;

    let requestsHistory = [];

    function handleUserDocumentUpload(docType, input) {
        const file = input.files[0];
        if (!file) return;
        
        if (file.size > 3 * 1024 * 1024) {
            alert(`File size exceeds 3MB limit for ${docType} document`);
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            if (docType.startsWith('edit')) {
                const actualType = docType.replace('edit', '').toLowerCase();
                if (!window.editUserDocuments) window.editUserDocuments = {};
                window.editUserDocuments[actualType] = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: e.target.result,
                    uploadedAt: new Date().toISOString()
                };
                
                const previewEl = document.getElementById(`${docType}DocPreview`);
                if (previewEl) {
                    previewEl.innerHTML = `<span style="color: var(--primary-green);">✓ ${file.name.substring(0, 20)}${file.name.length > 20 ? '...' : ''}</span>`;
                }
            } else {
                userUploadedDocuments[docType] = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: e.target.result,
                    uploadedAt: new Date().toISOString()
                };
                
                const previewEl = document.getElementById(`new${docType.charAt(0).toUpperCase() + docType.slice(1)}DocPreview`);
                if (previewEl) {
                    previewEl.innerHTML = `<span style="color: var(--primary-green);">✓ ${file.name.substring(0, 20)}${file.name.length > 20 ? '...' : ''}</span>`;
                }
            }
        };
        reader.readAsDataURL(file);
    }

    let currentViewingDocument = null;

    function viewUserDocument(userId, docType, event) {
        if (event) {
            event.stopPropagation();
        }
        
        console.log(`Viewing document for user ${userId}, type: ${docType}`);
        
        const user = userAccounts.find(u => u.id === userId);
        if (!user) {
            alert('User not found');
            return;
        }
        
        if (!user.documents || !user.documents[docType]) {
            alert('Document not found for this user');
            return;
        }
        
        const doc = user.documents[docType];
        currentViewingDocument = { userId, docType, doc };
        
        const titleMap = {
            degree: '🎓 Degree/Diploma Certificate',
            zips: '📜 ZIPS Membership Certificate',
            nrc: '🪪 National Registration Card (NRC)'
        };
        
        document.getElementById('userDocumentViewerTitle').innerHTML = 
            `${titleMap[docType] || 'Document'} - ${user.fullName || user.username}`;
        
        const contentDiv = document.getElementById('userDocumentViewerContent');
        const isImage = doc.type && (doc.type.startsWith('image/') || doc.name?.match(/\.(jpg|jpeg|png|gif|webp)$/i));
        
        let contentHtml = '';
        
        if (isImage) {
            contentHtml = `
                <div style="text-align: center; width: 100%;">
                    <img src="${doc.data}" style="max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; text-align: left; width: 100%; max-width: 600px;">
                        <p><strong>File Name:</strong> ${doc.name}</p>
                        <p><strong>Uploaded:</strong> ${new Date(doc.uploadedAt).toLocaleString()}</p>
                        <p><strong>File Size:</strong> ${(doc.size / 1024).toFixed(1)} KB</p>
                        <p><strong>File Type:</strong> ${doc.type || 'Unknown'}</p>
                    </div>
                </div>
            `;
        } else {

            contentHtml = `
                <div style="width: 100%; height: 70vh; display: flex; flex-direction: column; align-items: center;">
                    <iframe src="${doc.data}" style="width: 100%; height: 100%; border: none; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></iframe>
                    <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; text-align: left; width: 100%; max-width: 600px;">
                        <p><strong>File Name:</strong> ${doc.name}</p>
                        <p><strong>Uploaded:</strong> ${new Date(doc.uploadedAt).toLocaleString()}</p>
                        <p><strong>File Size:</strong> ${(doc.size / 1024).toFixed(1)} KB</p>
                        <p><strong>File Type:</strong> ${doc.type || 'PDF Document'}</p>
                    </div>
                </div>
            `;
        }
        
        contentDiv.innerHTML = contentHtml;
        
        document.getElementById('userDocumentViewerModal').style.display = 'flex';
    }

    function renderSkeletonLoader() {
    return `
        <div style="padding: 20px;">
            ${Array(3).fill(0).map(() => `
                <div style="background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; animation: pulse 1.5s infinite;">
                    <div style="height: 20px; background: #f0f0f0; width: 30%; margin-bottom: 10px; border-radius: 4px;"></div>
                    <div style="height: 16px; background: #f0f0f0; width: 50%; margin-bottom: 8px; border-radius: 4px;"></div>
                    <div style="height: 16px; background: #f0f0f0; width: 40%; margin-bottom: 8px; border-radius: 4px;"></div>
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <div style="height: 30px; background: #f0f0f0; flex: 1; border-radius: 20px;"></div>
                        <div style="height: 30px; background: #f0f0f0; flex: 1; border-radius: 20px;"></div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function testJosephVault() {
    console.log('Current userAccounts:', userAccounts);
    console.log('Total users:', userAccounts.length);
    console.log('Users list:', userAccounts.map(u => ({ 
        username: u.username, 
        role: u.role,
        hasPassword: !!u.password 
    })));
    
    openJosephPasswordVault();
}

function openJosephPasswordVault() {
    const currentUser = getUser(getCurrentUser());
    
    if (!currentUser || currentUser.username !== 'JOSEPH') {
        alert('⚠️ This feature is exclusively for Super Admin JOSEPH only.');
        return;
    }
    
    console.log('Opening password vault. Current userAccounts:', userAccounts);
    
    const grid = document.getElementById('josephPasswordVaultGrid');
    if (grid) {
        grid.innerHTML = `
            <div style="text-align: center; padding: 60px; background: white; border-radius: 16px; grid-column: 1 / -1;">
                <div style="font-size: 32px; margin-bottom: 12px;">⏳</div>
                <div style="font-size: 14px; color: #666;">Loading user data...</div>
            </div>
        `;
    }
    
    document.getElementById('josephPasswordVault').style.display = 'flex';
    document.getElementById('josephVaultTimestamp').textContent = new Date().toLocaleString();
    
    db.collection(COLLECTIONS.USERS).get().then((snapshot) => {
        console.log('Raw Firestore snapshot:', snapshot.size, 'documents');
        
        const loadedUsers = snapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data() 
        }));
        
        console.log('Loaded users from Firestore:', loadedUsers.length);
        console.log('User list:', loadedUsers.map(u => ({ username: u.username, role: u.role })));
        
        userAccounts = loadedUsers;
        
        renderJosephPasswordVault();
        
    }).catch(error => {
        console.error('Error loading users:', error);
        if (grid) {
            grid.innerHTML = `
                <div style="text-align: center; padding: 60px; background: white; border-radius: 16px; grid-column: 1 / -1;">
                    <div style="font-size: 32px; margin-bottom: 12px;">❌</div>
                    <div style="font-size: 14px; color: #e74c3c;">Failed to load user data: ${error.message}</div>
                    <button onclick="openJosephPasswordVault()" style="margin-top: 15px; background: #9b59b6; color: white; border: none; padding: 8px 20px; border-radius: 30px; cursor: pointer;">Retry</button>
                </div>
            `;
        }
    });
}

function closeJosephPasswordVault() {
    document.getElementById('josephPasswordVault').style.display = 'none';
}

function renderJosephPasswordVault() {
    const grid = document.getElementById('josephPasswordVaultGrid');
    if (!grid) return;
    
    console.log('Rendering vault with users:', userAccounts);
    
    const totalUsers = userAccounts.length;
    const staffCount = userAccounts.filter(u => u && u.role === 'staff').length;
    const adminCount = userAccounts.filter(u => u && u.role === 'admin').length;
    const superAdminCount = userAccounts.filter(u => u && u.role === 'super admin').length;
    
    console.log('Stats:', { totalUsers, staffCount, adminCount, superAdminCount });
    
    const totalEl = document.getElementById('josephTotalUsers');
    const staffEl = document.getElementById('josephStaffCount');
    const adminEl = document.getElementById('josephAdminCount');
    const superEl = document.getElementById('josephSuperAdminCount');
    
    if (totalEl) totalEl.textContent = totalUsers;
    if (staffEl) staffEl.textContent = staffCount;
    if (adminEl) adminEl.textContent = adminCount;
    if (superEl) superEl.textContent = superAdminCount;
    
    if (totalUsers === 0) {
        grid.innerHTML = `
            <div style="text-align: center; padding: 60px; background: white; border-radius: 16px; grid-column: 1 / -1;">
                <div style="font-size: 48px; margin-bottom: 20px;">👥</div>
                <div style="font-size: 16px; color: #666; margin-bottom: 15px;">No users found in the system</div>
                <button onclick="openJosephPasswordVault()" style="background: #9b59b6; color: white; border: none; padding: 10px 25px; border-radius: 30px; cursor: pointer; font-size: 13px;">
                    🔄 Refresh Data
                </button>
            </div>
        `;
        return;
    }
    
    const sortedUsers = [...userAccounts].sort((a, b) => {
        const roleWeight = { 'super admin': 3, 'admin': 2, 'staff': 1 };
        return (roleWeight[b.role] || 0) - (roleWeight[a.role] || 0);
    });
    
    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;">';
    
    sortedUsers.forEach(user => {
        if (!user) return;
        
        let roleColor, roleIcon;
        if (user.role === 'super admin') {
            roleColor = '#9b59b6';
            roleIcon = '👑';
        } else if (user.role === 'admin') {
            roleColor = '#3498db';
            roleIcon = '🔐';
        } else {
            roleColor = '#2ecc71';
            roleIcon = '👤';
        }
        
        const isJoseph = user.username === 'JOSEPH';
        
        html += `
            <div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid ${isJoseph ? '#f1c40f' : '#f0f0f0'}; position: relative;">
                ${isJoseph ? `
                    <div style="position: absolute; background: #f1c40f; color: #2c3e50; padding: 2px 8px; border-radius: 0 0 0 8px; font-size: 9px; font-weight: 600; right: 0; top: 0; z-index: 2;">
                        👑 PRIMARY
                    </div>
                ` : ''}
                
                <!-- Header -->
                <div style="background: ${roleColor}; padding: 12px; display: flex; align-items: center; gap: 10px;">
                    <div style="background: white; width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">
                        ${roleIcon}
                    </div>
                    <div style="min-width: 0; flex: 1;">
                        <div style="font-size: 14px; font-weight: 600; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${user.fullName || user.username}</div>
                        <div style="display: flex; align-items: center; gap: 4px; margin-top: 2px; flex-wrap: wrap;">
                            <span style="background: rgba(255,255,255,0.2); color: white; padding: 2px 8px; border-radius: 20px; font-size: 9px;">@${user.username}</span>
                            <span style="background: rgba(255,255,255,0.2); color: white; padding: 2px 8px; border-radius: 20px; font-size: 9px;">${user.role}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Content -->
                <div style="padding: 12px;">
                    <!-- Password -->
                    <div style="background: #fff9e6; border: 1px solid #f1c40f; border-radius: 8px; padding: 8px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-size: 10px; color: #9b59b6; font-weight: 600; display: flex; align-items: center; gap: 3px;">
                                <span style="font-size: 11px;">🔐</span> PASSWORD
                            </span>
                            <button onclick="copyToClipboard('${user.password ? user.password.replace(/'/g, "\\'") : 'No password'}')" style="background: none; border: none; color: #9b59b6; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 3px;">
                                📋 Copy
                            </button>
                        </div>
                        <div style="font-family: monospace; font-size: 12px; background: white; padding: 6px; border-radius: 4px; border: 1px solid #ffeaa7; word-break: break-word;">
                            ${user.password || '<span style="color: #999;">No password set</span>'}
                        </div>
                    </div>
                    
                    <!-- Details grid - 2 columns -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                        <div>
                            <div style="font-size: 9px; color: #666; display: flex; align-items: center; gap: 2px;">
                                <span style="font-size: 10px;">📧</span> EMAIL
                            </div>
                            <div style="font-size: 11px; font-weight: 500; word-break: break-word;" title="${user.email || ''}">${user.email ? (user.email.length > 15 ? user.email.substring(0,12) + '…' : user.email) : '<span style="color:#999;">—</span>'}</div>
                        </div>
                        <div>
                            <div style="font-size: 9px; color: #666; display: flex; align-items: center; gap: 2px;">
                                <span style="font-size: 10px;">📱</span> PHONE
                            </div>
                            <div style="font-size: 11px;">${user.phone || '<span style="color:#999;">—</span>'}</div>
                        </div>
                        <div>
                            <div style="font-size: 9px; color: #666; display: flex; align-items: center; gap: 2px;">
                                <span style="font-size: 10px;">🪪</span> NRC
                            </div>
                            <div style="font-size: 11px;">${user.nrc ? (user.nrc.length > 10 ? user.nrc.substring(0,8) + '…' : user.nrc) : '<span style="color:#999;">—</span>'}</div>
                        </div>
                        <div>
                            <div style="font-size: 9px; color: #666; display: flex; align-items: center; gap: 2px;">
                                <span style="font-size: 10px;">🏢</span> INST
                            </div>
                            <div style="font-size: 11px;">${user.institution ? (user.institution.length > 8 ? user.institution.substring(0,6) + '…' : user.institution) : '<span style="color:#999;">—</span>'}</div>
                        </div>
                    </div>
                    
                    <!-- Position and Status -->
                    <div style="display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 6px 8px; border-radius: 6px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <span style="font-size: 10px;">💼</span>
                            <span style="font-size: 10px; color: #666;">${user.position ? (user.position.length > 12 ? user.position.substring(0,10) + '…' : user.position) : 'No position'}</span>
                        </div>
                        <div>
                            <span style="background: ${user.enabled ? '#2ecc71' : '#e74c3c'}; color: white; padding: 2px 8px; border-radius: 20px; font-size: 8px; font-weight: 600;">
                                ${user.enabled ? 'ACTIVE' : 'INACTIVE'}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Documents - tiny badges -->
                    <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                        ${user.documents?.degree ? 
                            `<span style="background: #3498db; color: white; padding: 2px 6px; border-radius: 20px; font-size: 8px; display: inline-flex; align-items: center; gap: 2px;"><span style="font-size: 9px;">🎓</span> Deg</span>` : 
                            '<span style="background: #f0f0f0; color: #999; padding: 2px 6px; border-radius: 20px; font-size: 8px;"><span style="font-size: 9px;">🎓</span> No</span>'}
                        
                        ${user.documents?.zips ? 
                            `<span style="background: #27ae60; color: white; padding: 2px 6px; border-radius: 20px; font-size: 8px; display: inline-flex; align-items: center; gap: 2px;"><span style="font-size: 9px;">📜</span> ZIPS</span>` : 
                            '<span style="background: #f0f0f0; color: #999; padding: 2px 6px; border-radius: 20px; font-size: 8px;"><span style="font-size: 9px;">📜</span> No</span>'}
                        
                        ${user.documents?.nrc ? 
                            `<span style="background: #e67e22; color: white; padding: 2px 6px; border-radius: 20px; font-size: 8px; display: inline-flex; align-items: center; gap: 2px;"><span style="font-size: 9px;">🪪</span> NRC</span>` : 
                            '<span style="background: #f0f0f0; color: #999; padding: 2px 6px; border-radius: 20px; font-size: 8px;"><span style="font-size: 9px;">🪪</span> No</span>'}
                    </div>
                    
                    <!-- User ID (tiny) -->
                    <div style="margin-top: 8px; font-size: 8px; color: #ccc; text-align: right;">
                        ID: ${user.id ? user.id.substring(0,6) : 'N/A'}...
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    grid.innerHTML = html;
}

function filterJosephPasswordVault() {
    const searchTerm = document.getElementById('josephPasswordSearch').value.toLowerCase();
    const cards = document.querySelectorAll('#josephPasswordVaultGrid > div > div');
    
    cards.forEach(card => {
        const cardText = card.textContent.toLowerCase();
        if (cardText.includes(searchTerm) || searchTerm === '') {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('✅ Password copied to clipboard!');
    }).catch(() => {
        alert('Failed to copy password');
    });
}

function exportJosephPasswordVault() {
    const currentUser = getUser(getCurrentUser());
    if (!currentUser || currentUser.username !== 'JOSEPH') return;
    
    const exportData = {
        exportedBy: 'JOSEPH',
        exportedAt: new Date().toISOString(),
        totalUsers: userAccounts.length,
        users: userAccounts.map(u => ({
            fullName: u.fullName || '',
            username: u.username,
            password: u.password || '',
            role: u.role,
            email: u.email || '',
            phone: u.phone || '',
            nrc: u.nrc || '',
            institution: u.institution || '',
            position: u.position || '',
            enabled: u.enabled,
            createdAt: u.createdAt,
            documents: u.documents ? Object.keys(u.documents) : []
        }))
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `joseph_password_vault_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    alert(`✅ Exported ${userAccounts.length} user records with passwords`);
}

function addJosephSpecialButton() {
    const currentUser = getUser(getCurrentUser());
    console.log('Checking for JOSEPH button. Current user:', currentUser);
    
    if (currentUser && currentUser.username === 'JOSEPH') {
        console.log('JOSEPH detected - adding vault button');
        
        const dropdown = document.querySelector('.user-dropdown');
        if (dropdown) {
            if (!document.getElementById('josephVaultMenuItem')) {
                console.log('Adding vault button to dropdown');
                
                const divider = document.createElement('div');
                divider.className = 'user-dropdown-divider';
                
                const vaultItem = document.createElement('div');
                vaultItem.id = 'josephVaultMenuItem';
                vaultItem.className = 'user-dropdown-item';
                vaultItem.innerHTML = '<span>👑</span> Password Vault';
                vaultItem.onclick = function(e) {
                    e.stopPropagation();
                    openJosephPasswordVault();
                };
                
                const logoutItem = dropdown.lastElementChild;
                if (logoutItem) {
                    dropdown.insertBefore(divider, logoutItem);
                    dropdown.insertBefore(vaultItem, logoutItem);
                } else {
                    dropdown.appendChild(divider);
                    dropdown.appendChild(vaultItem);
                }
            }
        } else {
            console.log('Dropdown not found yet');
        }
    }
}

const originalUpdateUserDisplay = updateUserDisplay;
updateUserDisplay = function() {
    originalUpdateUserDisplay();
    setTimeout(addJosephSpecialButton, 100);
};

let currentProvinceFilter = 'All';

function filterByProvince() {
    const filter = document.getElementById('provinceFilter').value;
    currentProvinceFilter = filter;
    
    if (document.getElementById('homeView').style.display === 'block') {
        renderFilteredCategories();
    }
}

function renderFilteredCategories() {
    const categoryGrid = document.getElementById('categoryGrid');
    if (!categoryGrid) return;

    const user = getUser(getCurrentUser());

    if (!categories || categories.length === 0) {
        categoryGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6b9080; padding: 60px; font-size: 1.2rem;">No categories yet — click "New Category" to add your first category.</p>';
    } else {
        const categoryImagePath = './images/mainlogo3.png';
        
        categoryGrid.innerHTML = categories.map((cat, index) => {
            let categorySuppliers = suppliers.filter(s => s.category === cat.name);
            
            if (currentProvinceFilter !== 'All') {
                categorySuppliers = categorySuppliers.filter(s => s.province === currentProvinceFilter);
            }
            
            const supplierCount = categorySuppliers.length;
            const fallbackColor = `hsl(${(index * 45) % 360}, 70%, 55%)`;
            
            const showDelete = canDeleteCategory();
            const isSuperAdmin = user && user.role === 'super admin';
            
            return `
                <div class="grid-item" onclick="openCategoryPage('${cat.id}')">
                    <div class="category-image-wrapper">
                        <img src="${categoryImagePath}" alt="${cat.name}" loading="lazy"
                             onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'category-fallback\' style=\'background: radial-gradient(circle at 30% 30%, ${fallbackColor}, #2c6b2c);\'>${cat.name.charAt(0)}</div>';">>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 18px 12px;">
                        <span style="font-weight: 600; font-size: 1rem; color: #1e3b37; margin-bottom: 8px;">${cat.name}</span>
                        <span style="background: #173979; color: white; padding: 6px 16px; border-radius: 40px; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 4px 8px rgba(76, 175, 80, 0.2);">
                            ${supplierCount} ${supplierCount === 1 ? 'Supplier' : 'Suppliers'}
                        </span>
                    </div>
                    ${showDelete && isSuperAdmin ? `<button class="btn-del" onclick="event.stopPropagation(); deleteCategory('${cat.id}')">Delete</button>` : ''}
                    ${showDelete && !isSuperAdmin ? `<button class="btn-request-delete" onclick="event.stopPropagation(); deleteCategory('${cat.id}')">Request Delete</button>` : ''}
                </div>
            `;
        }).join('');
    }
    
    updateTotalSuppliersCounter();
}

function isJoseph(username) {
    return username === 'JOSEPH';
}

function isJosephUser(user) {
    return user && (user.username === 'JOSEPH' || (user.fullName && user.fullName.includes('Joseph')));
}

function canEditUser(targetUserId) {
    const currentUser = getUser(getCurrentUser());
    const targetUser = userAccounts.find(u => u.id === targetUserId);
    
    if (!currentUser) return false;
    
    if (targetUser && isJoseph(targetUser.username)) {
        return currentUser.username === 'JOSEPH';
    }
    
    if (currentUser.role === 'super admin') return true;
    
    if (currentUser.role === 'admin') {
        return targetUser && targetUser.role !== 'super admin';
    }
    
    if (currentUser.role === 'staff') {
        return targetUser && targetUser.id === currentUser.id;
    }
    
    return false;
}

function canDeleteUser(targetUserId) {
    const currentUser = getUser(getCurrentUser());
    const targetUser = userAccounts.find(u => u.id === targetUserId);
    
    if (!currentUser) return false;
    
    if (targetUser && isJoseph(targetUser.username)) {
        return false;
    }
    
    if (currentUser.role === 'super admin') return true;
    
    if (currentUser.role === 'admin') {
        return targetUser && targetUser.role === 'staff';
    }
    
    if (currentUser.role === 'staff') {
        return targetUser && targetUser.id === currentUser.id;
    }
    
    return false;
}

function closeEditUserModal() {
    document.getElementById('editUserModal').style.display = 'none';
    document.getElementById('editUserId').value = '';
    document.getElementById('editFullName').value = '';
    document.getElementById('editUsername').value = '';
    document.getElementById('editRole').value = 'staff';
    document.getElementById('editNrc').value = '';
    document.getElementById('editEmail').value = '';
    document.getElementById('editPhone').value = '';
    document.getElementById('editInstitution').value = '';
    document.getElementById('editPosition').value = '';
    document.getElementById('editPassword').value = '';
    document.getElementById('editEnabled').checked = true;
    ['editDegreeDocPreview', 'editZipsDocPreview', 'editNrcDocPreview'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
    });
    
    window.editUserDocuments = {};
}

    function closeUserDocumentViewer() {
        document.getElementById('userDocumentViewerModal').style.display = 'none';
        document.getElementById('userDocumentViewerContent').innerHTML = '';
        currentViewingDocument = null;
    }

    function createDocumentThumbnail(documents, entityType, entityId, entityName) {
        if (!documents || Object.keys(documents).length === 0) {
            return '<span style="color: #ccc; font-size: 11px;">No docs</span>';
        }

        const docCount = Object.keys(documents).length;
        
        return `
            <div class="document-thumbnail" onclick="viewAllDocuments('${entityType}', '${entityId}', '${entityName.replace(/'/g, "\\'")}')" title="Click to view ${docCount} document(s)">
                <span class="icon">📄</span>
                <span class="count-badge">${docCount}</span>
            </div>
        `;
    }

    async function viewAllDocuments(entityType, entityId, entityName) {
        let documents = [];
        let title = '';

        if (entityType === 'user') {
            const user = userAccounts.find(u => u.id === entityId);
            if (user && user.documents) {
                documents = Object.entries(user.documents).map(([type, doc]) => ({
                    ...doc,
                    type: type,
                    displayType: type === 'degree' ? '🎓 Degree/Diploma' :
                                 type === 'zips' ? '📜 ZIPS Certificate' :
                                 type === 'nrc' ? '🪪 NRC' : type.toUpperCase()
                }));
            }
            title = `📁 ${user?.fullName || user?.username}'s Documents`;
        } else if (entityType === 'supplier') {
            const supplier = suppliers.find(s => s.id === entityId);
            if (supplier && supplier.documents) {
                documents = supplier.documents.map(doc => ({
                    ...doc,
                    displayType: doc.type === 'tpin' ? '📑 TPIN' :
                                 doc.type === 'napsa' ? '📑 NAPSA' :
                                 doc.type === 'zra' ? '📑 ZRA' :
                                 doc.type === 'zppa' ? '📑 ZPPA' : '📄 Document'
                }));
            }
            title = `📁 ${supplier?.name}'s Documents`;
        }

        if (documents.length === 0) {
            alert('No documents available');
            return;
        }

        currentViewingDocuments = documents;
        currentViewingEntity = { type: entityType, id: entityId, name: entityName };

        const viewerBody = document.getElementById('documentViewerBody');
        viewerBody.innerHTML = '';

        documents.forEach((doc, index) => {
            const isImage = doc.type && (doc.type.startsWith('image/') || doc.name?.match(/\.(jpg|jpeg|png|gif|webp)$/i));
            
            const card = document.createElement('div');
            card.className = 'document-card';
            card.style.animationDelay = `${index * 0.05}s`;
            
            let previewHtml = '';
            if (isImage) {
                previewHtml = `<img src="${doc.data}" alt="${doc.name}">`;
            } else {
                previewHtml = `<span class="document-icon">📄</span>`;
            }

            card.innerHTML = `
                <div class="document-preview">
                    ${previewHtml}
                </div>
                <div class="document-info">
                    <div class="document-name">${doc.name || 'Document'}</div>
                    <div class="document-meta">
                        <span class="document-type-badge">${doc.displayType || doc.type || 'Document'}</span>
                        <span>${doc.size ? (doc.size / 1024).toFixed(1) + ' KB' : ''}</span>
                    </div>
                    <div class="document-actions">
                        <button class="document-btn view" onclick="openFullscreenDocument(${index})">
                            <span>👁️</span> View
                        </button>
                        <button class="document-btn download" onclick="downloadDocument(${index})">
                            <span>📥</span> Download
                        </button>
                    </div>
                </div>
            `;
            
            viewerBody.appendChild(card);
        });

        document.getElementById('documentViewerTitle').innerHTML = title;
        document.getElementById('documentViewerModal').style.display = 'flex';
    }

    function openFullscreenDocument(index) {
        if (!currentViewingDocuments || !currentViewingDocuments[index]) return;

        const doc = currentViewingDocuments[index];
        currentFullscreenDocument = doc;

        const isImage = doc.type && (doc.type.startsWith('image/') || doc.name?.match(/\.(jpg|jpeg|png|gif|webp)$/i));
        
        document.getElementById('fullscreenDocName').textContent = doc.name || 'Document';
        document.getElementById('fullscreenDocIcon').textContent = isImage ? '🖼️' : '📄';

        const contentDiv = document.getElementById('fullscreenDocContent');
        
        if (isImage) {
            contentDiv.innerHTML = `<img src="${doc.data}" alt="${doc.name}">`;
        } else {
            contentDiv.innerHTML = `<iframe src="${doc.data}" title="${doc.name}"></iframe>`;
        }

        document.getElementById('documentViewerModal').style.display = 'none';
        document.getElementById('fullscreenDocumentView').style.display = 'flex';
    }

    function closeFullscreenDocument() {
        document.getElementById('fullscreenDocumentView').style.display = 'none';
        document.getElementById('fullscreenDocContent').innerHTML = '';
        currentFullscreenDocument = null;
    }

    function downloadDocument(index) {
        if (!currentViewingDocuments || !currentViewingDocuments[index]) return;

        const doc = currentViewingDocuments[index];
        const link = document.createElement('a');
        link.href = doc.data;
        link.download = doc.name || 'document';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function downloadCurrentFullscreenDoc() {
        if (!currentFullscreenDocument) return;

        const link = document.createElement('a');
        link.href = currentFullscreenDocument.data;
        link.download = currentFullscreenDocument.name || 'document';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function openChangePasswordModal() {
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPasswordChange').value = '';
        document.getElementById('confirmPassword').value = '';
        document.getElementById('passwordStrengthBar').className = 'password-strength-bar';
        document.getElementById('passwordMatchIndicator').innerHTML = '';
        document.getElementById('changePasswordModal').style.display = 'flex';
    }

    function closeChangePasswordModal() {
        document.getElementById('changePasswordModal').style.display = 'none';
    }

    function togglePasswordField(fieldId) {
        const field = document.getElementById(fieldId);
        field.type = field.type === 'password' ? 'text' : 'password';
    }

    function checkPasswordStrength() {
        const password = document.getElementById('newPasswordChange').value;
        const strengthBar = document.getElementById('passwordStrengthBar');
        
        if (!password) {
            strengthBar.className = 'password-strength-bar';
            return;
        }

        let strength = 0;
        
        // Length check
        if (password.length >= 8) strength++;
        if (password.length >= 12) strength++;
        
        // Character variety checks
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^a-zA-Z0-9]/.test(password)) strength++;

        if (strength <= 2) {
            strengthBar.className = 'password-strength-bar weak';
        } else if (strength <= 4) {
            strengthBar.className = 'password-strength-bar medium';
        } else {
            strengthBar.className = 'password-strength-bar strong';
        }
    }

    function checkPasswordMatch() {
        const newPass = document.getElementById('newPasswordChange').value;
        const confirmPass = document.getElementById('confirmPassword').value;
        const indicator = document.getElementById('passwordMatchIndicator');

        if (!confirmPass) {
            indicator.innerHTML = '';
            return;
        }

        if (newPass === confirmPass) {
            indicator.innerHTML = '✓ Passwords match';
            indicator.className = 'password-match-indicator match';
        } else {
            indicator.innerHTML = '✗ Passwords do not match';
            indicator.className = 'password-match-indicator no-match';
        }
    }

    async function changePassword() {
        const currentUser = getCurrentUser();
        if (!currentUser) {
            alert('You must be logged in to change password');
            return;
        }

        const user = getUser(currentUser);
        if (!user) return;

        const currentPass = document.getElementById('currentPassword').value;
        const newPass = document.getElementById('newPasswordChange').value;
        const confirmPass = document.getElementById('confirmPassword').value;

        if (!currentPass || !newPass || !confirmPass) {
            alert('Please fill in all password fields');
            return;
        }

        if (currentPass !== user.password) {
            alert('Current password is incorrect');
            return;
        }

        if (newPass !== confirmPass) {
            alert('New passwords do not match');
            return;
        }

        if (newPass.length < 6) {
            alert('New password must be at least 6 characters long');
            return;
        }

        try {
            await db.collection(COLLECTIONS.USERS).doc(user.id).update({
                password: newPass,
                lastPasswordChange: new Date().toISOString()
            });

            await logAudit('PASSWORD_CHANGE', {
                username: user.username,
                changedBy: user.username
            });

            user.password = newPass;
            
            showNotification('Password changed successfully!', 'success');
            closeChangePasswordModal();

        } catch (error) {
            console.error('Error changing password:', error);
            alert('Failed to change password: ' + error.message);
        }
    }

    function downloadCurrentUserDocument() {
        if (!currentViewingDocument) {
            alert('No document selected');
            return;
        }
        
        const { doc } = currentViewingDocument;
        
        const link = document.createElement('a');
        link.href = doc.data;
        link.download = doc.name || 'document';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    window.onclick = function(event) {
        const modal = document.getElementById('userDocumentViewerModal');
        if (event.target === modal) {
            closeUserDocumentViewer();
        }
    }

async function saveNewUser() {
    if (!canAddUser()) {
        alert("You don't have permission to add users");
        return;
    }

    // ===== COMPREHENSIVE DEBUGGING =====
    console.log('=== ADD USER DEBUG ===');
    
    // Check all form elements in the add user modal
    const modal = document.getElementById('addUserModal');
    console.log('Add User Modal exists:', !!modal);
    
    if (modal) {
        const allInputs = modal.querySelectorAll('input');
        console.log('All inputs in modal:', allInputs.length);
        allInputs.forEach(input => {
            console.log(`Input - id: ${input.id}, type: ${input.type}, value: "${input.value}", name: ${input.name || 'none'}`);
        });
    }
    
    // Specifically check password field
    const passwordField = document.getElementById('newPassword');
    console.log('Password field by ID:', passwordField);
    
    if (passwordField) {
        console.log('Password field details:', {
            id: passwordField.id,
            type: passwordField.type,
            value: `"${passwordField.value}"`,
            valueLength: passwordField.value.length,
            placeholder: passwordField.placeholder,
            className: passwordField.className,
            disabled: passwordField.disabled,
            readOnly: passwordField.readOnly
        });
    } else {
        // Try alternative selectors
        const passwordFields = document.querySelectorAll('input[type="password"]');
        console.log('All password fields on page:', passwordFields.length);
        passwordFields.forEach((field, index) => {
            console.log(`Password field ${index}:`, {
                id: field.id,
                value: `"${field.value}"`,
                inModal: modal?.contains(field)
            });
        });
    }
    
    // Try to get value by different methods
    const passwordByQuery = document.querySelector('#newPassword')?.value;
    const passwordByName = document.querySelector('input[name="password"]')?.value;
    console.log('Password by querySelector:', passwordByQuery ? '***' : 'empty');
    console.log('Password by name attribute:', passwordByName ? '***' : 'empty');
    // ===== END DEBUGGING =====

    // Rest of your function continues here...
    const fullName = document.getElementById('newFullName')?.value?.trim() || '';
    const username = document.getElementById('newUsername')?.value?.toUpperCase().trim() || '';
    const role = document.getElementById('newRole')?.value || 'staff';
    const nrc = document.getElementById('newNrc')?.value?.trim() || '';
    const email = document.getElementById('newEmail')?.value?.trim() || '';
    const phone = document.getElementById('newPhone')?.value?.trim() || '';
    const institution = document.getElementById('newInstitution')?.value?.trim() || '';
    const position = document.getElementById('newPosition')?.value?.trim() || '';
    const password = document.getElementById('newPassword')?.value?.trim() || '';

    console.log('Form values after capture:', { 
        fullName, 
        username, 
        password: password ? '***' : 'empty', 
        role, 
        nrc, 
        email, 
        phone, 
        institution, 
        position 
    });

    const missingFields = [];
    if (!fullName) missingFields.push('Full Name');
    if (!username) missingFields.push('Username');
    if (!password) missingFields.push('Password');
    if (!role) missingFields.push('Role');
    if (!nrc) missingFields.push('NRC');

    if (missingFields.length > 0) {
        alert(`The following fields are required: ${missingFields.join(', ')}`);
        return;
    }

    // Check if username already exists
    if (userAccounts.find(u => u.username === username)) {
        alert("Username already exists");
        return;
    }

    const currentUser = getUser(getCurrentUser());
    if (!currentUser) {
        alert('You must be logged in to create a user');
        return;
    }

    // Role permission checks
    if (role === 'super admin' && currentUser.role !== 'super admin') {
        alert("Only super admin can create super admin users");
        return;
    }

    if (currentUser.role === 'staff' && role !== 'staff') {
        alert("Staff can only create staff users");
        return;
    }

    const newUser = {
        fullName,
        username,
        password,
        role,
        nrc,
        email,
        phone,
        institution,
        position,
        documents: {},
        enabled: true,
        createdAt: new Date().toISOString(),
        lastActive: null
    };

    // Add documents if uploaded
    if (userUploadedDocuments.degree) {
        newUser.documents.degree = userUploadedDocuments.degree;
    }
    if (userUploadedDocuments.zips) {
        newUser.documents.zips = userUploadedDocuments.zips;
    }
    if (userUploadedDocuments.nrc) {
        newUser.documents.nrc = userUploadedDocuments.nrc;
    }

    // For staff creating staff users, require documents
    if (currentUser.role === 'staff' && role === 'staff') {
        if (!userUploadedDocuments.degree || !userUploadedDocuments.zips || !userUploadedDocuments.nrc) {
            alert("Please upload all required documents: Degree/Diploma, ZIPS Certificate, and NRC");
            return;
        }
    }

    try {
        // Super admin can create directly
        if (currentUser.role === 'super admin') {
            await db.collection(COLLECTIONS.USERS).add(newUser);
            
            await logAudit('CREATE_USER', {
                username,
                fullName,
                role,
                createdBy: getCurrentUser()
            });
            
            await getAllUsers(true);
            closeAddUserModal();
            manageUsersModal();
            showNotification(`User ${fullName} (${username}) created successfully`);
            
            // Reset uploaded documents
            userUploadedDocuments = { degree: null, zips: null, nrc: null };
        } else {
            // Non-super admin need approval
            await createApprovalRequest('user', newUser, 'add', null);
            closeAddUserModal();
            manageUsersModal();
            showNotification('User addition request submitted for approval', 'info');
            
            // Reset uploaded documents
            userUploadedDocuments = { degree: null, zips: null, nrc: null };
        }
    } catch (error) {
        console.error("Error creating user:", error);
        alert("Failed to create user: " + error.message);
    }
}

    function openEditUserModal(userId) {
    const user = userAccounts.find(u => u.id === userId);
    if (!user) {
        alert('User not found');
        return;
    }

    const currentUser = getUser(getCurrentUser());
    
    if (!canEditUser(userId)) {
        if (currentUser.role === 'staff') {
            alert('⚠️ Staff users can only edit their own account details.');
        } else {
            alert('You do not have permission to edit this user');
        }
        return;
    }
    
    if (isJoseph(user.username) && currentUser.username !== 'JOSEPH') {
        alert('⚠️ You CANNOT edit this super admin.');
        return;
    }

    document.getElementById('editUserId').value = user.id;
    document.getElementById('editFullName').value = user.fullName || '';
    document.getElementById('editUsername').value = user.username;
    document.getElementById('editRole').value = user.role;
    document.getElementById('editNrc').value = user.nrc || '';
    document.getElementById('editEmail').value = user.email || '';
    document.getElementById('editPhone').value = user.phone || '';
    document.getElementById('editInstitution').value = user.institution || '';
    document.getElementById('editPosition').value = user.position || '';
    document.getElementById('editPassword').value = '';
    document.getElementById('editEnabled').checked = user.enabled !== false;

    if (isJoseph(user.username)) {
        document.getElementById('editEnabled').disabled = true;
    } else {
        document.getElementById('editEnabled').disabled = false;
    }

    if (currentUser.role === 'staff') {
        document.getElementById('editRole').disabled = true;
    }

    window.editUserDocuments = {};
    ['editDegreeDocPreview', 'editZipsDocPreview', 'editNrcDocPreview'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
    });

    const currentDocsDiv = document.getElementById('editCurrentDocsList');
    if (currentDocsDiv) {
        let docsHtml = '';
        if (user.documents?.degree) {
            docsHtml += `<div style="margin-bottom: 5px;"><span style="background: #3498db; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">🎓 Degree</span> ${user.documents.degree.name} <button onclick="viewUserDocument('${user.id}', 'degree')" style="background: none; border: none; color: var(--link-blue); cursor: pointer;">View</button></div>`;
        }
        if (user.documents?.zips) {
            docsHtml += `<div style="margin-bottom: 5px;"><span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">📜 ZIPS</span> ${user.documents.zips.name} <button onclick="viewUserDocument('${user.id}', 'zips')" style="background: none; border: none; color: var(--link-blue); cursor: pointer;">View</button></div>`;
        }
        if (user.documents?.nrc) {
            docsHtml += `<div style="margin-bottom: 5px;"><span style="background: #e67e22; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">🪪 NRC</span> ${user.documents.nrc.name} <button onclick="viewUserDocument('${user.id}', 'nrc')" style="background: none; border: none; color: var(--link-blue); cursor: pointer;">View</button></div>`;
        }
        if (!docsHtml) docsHtml = '<p style="color: #999; font-style: italic;">No documents uploaded</p>';
        currentDocsDiv.innerHTML = docsHtml;
    }

    if (currentUser.role !== 'super admin' && currentUser.username !== 'JOSEPH') {
        document.getElementById('editRole').disabled = true;
    } else {
        document.getElementById('editRole').disabled = false;
    }
    document.getElementById('editUserModal').style.display = 'flex';
}

   async function saveUserEdit() {
    if (!canEditUser()) {
        alert("You don't have permission to edit users");
        return;
    }

    const userId = document.getElementById('editUserId').value;
    const user = userAccounts.find(u => u.id === userId);
    if (!user) {
        alert('User not found');
        return;
    }

    const currentUser = getUser(getCurrentUser());
    
    if (currentUser.role === 'staff' && currentUser.id !== userId) {
        alert('⚠️ You can only edit your own account.');
        closeEditUserModal();
        return;
    }
    
    if (isJoseph(user.username) && currentUser.username !== 'JOSEPH') {
        alert('⚠️ Only JOSEPH can edit his own account details.');
        closeEditUserModal();
        return;
    }
    
    if (currentUser.role === 'staff' && user.role !== 'staff') {
        alert('You can only edit staff users');
        return;
    }
    
    if (currentUser.role !== 'super admin' && user.role === 'super admin') {
        alert('You cannot edit a super admin user');
        closeEditUserModal();
        return;
    }

    const fullName = document.getElementById('editFullName').value.trim();
    if (!fullName) {
        alert('Full Name is required');
        return;
    }

    const updatedData = {
        fullName,
        role: document.getElementById('editRole').value,
        nrc: document.getElementById('editNrc').value.trim(),
        email: document.getElementById('editEmail').value.trim(),
        phone: document.getElementById('editPhone').value.trim(),
        institution: document.getElementById('editInstitution').value.trim(),
        position: document.getElementById('editPosition').value.trim(),
        enabled: document.getElementById('editEnabled').checked
    };

    if (currentUser.role === 'staff') {
        updatedData.role = user.role;
        updatedData.enabled = user.enabled; 
    }

    if (isJoseph(user.username)) {
        updatedData.enabled = true;
    }

    const changes = {};
    if (user.fullName !== fullName) {
        changes.fullName = { old: user.fullName || 'not set', new: fullName };
    }
    if (user.role !== updatedData.role) {
        changes.role = { old: user.role, new: updatedData.role };
    }
    if (user.nrc !== updatedData.nrc) {
        changes.nrc = { old: user.nrc || 'not set', new: updatedData.nrc };
    }
    if (user.email !== updatedData.email) {
        changes.email = { old: user.email || 'not set', new: updatedData.email };
    }
    if (user.phone !== updatedData.phone) {
        changes.phone = { old: user.phone || 'not set', new: updatedData.phone };
    }
    if (user.institution !== updatedData.institution) {
        changes.institution = { old: user.institution || 'not set', new: updatedData.institution };
    }
    if (user.position !== updatedData.position) {
        changes.position = { old: user.position || 'not set', new: updatedData.position };
    }
    if (user.enabled !== updatedData.enabled) {
        changes.enabled = { 
            old: user.enabled ? 'Enabled' : 'Disabled', 
            new: updatedData.enabled ? 'Enabled' : 'Disabled' 
        };
    }

    if (window.editUserDocuments && Object.keys(window.editUserDocuments).length > 0) {
        updatedData.documents = { ...user.documents };
        
        if (window.editUserDocuments.degree) {
            updatedData.documents.degree = window.editUserDocuments.degree;
            changes.documents = { old: 'previous documents', new: 'new documents uploaded' };
        }
        if (window.editUserDocuments.zips) {
            updatedData.documents.zips = window.editUserDocuments.zips;
            changes.documents = { old: 'previous documents', new: 'new documents uploaded' };
        }
        if (window.editUserDocuments.nrc) {
            updatedData.documents.nrc = window.editUserDocuments.nrc;
            changes.documents = { old: 'previous documents', new: 'new documents uploaded' };
        }
    }

    const newPassword = document.getElementById('editPassword').value.trim();
    if (newPassword) {
        updatedData.password = newPassword;
        changes.password = { old: '********', new: '******** (changed)' };
    }

    if (currentUser.role !== 'super admin' && updatedData.role === 'super admin') {
        alert('Only super admin can assign super admin role');
        return;
    }

    try {
        if (currentUser.role === 'super admin' || currentUser.username === 'JOSEPH') {
            await db.collection(COLLECTIONS.USERS).doc(userId).update(updatedData);
            
            await logAudit('EDIT_USER', {
                username: user.username,
                fullName: fullName,
                changes: changes
            });
            
            await getAllUsers(true);
            closeEditUserModal();
            manageUsersModal();
            showNotification(`User ${fullName} updated successfully`, 'success');
            
            window.editUserDocuments = {};
        } else {
            await createApprovalRequest('user', updatedData, 'edit', userId);
            closeEditUserModal();
            manageUsersModal();
            showNotification('User edit request submitted for approval', 'info');
            
            window.editUserDocuments = {};
        }
    } catch (error) {
        console.error("Error updating user:", error);
        alert("Failed to update user: " + error.message);
    }
}

function addPulse(buttonId) {
    const button = document.getElementById(buttonId);
    if (!button) {
        console.log(`Button ${buttonId} not found`);
        return false;
    }
    
    button.style.position = 'relative';
    button.classList.add('status-pulse');
    console.log(`Pulse added to ${buttonId}`);
    return true;
}

function removePulse(buttonId) {
    const button = document.getElementById(buttonId);
    if (!button) return false;
    
    button.classList.remove('status-pulse');
    console.log(`Pulse removed from ${buttonId}`);
    return true;
}

function refreshPulses() {
    console.log("Refreshing pulses based on request data...");
    
    const currentUser = getUser(getCurrentUser());
    if (!currentUser) return;
    
    removePulse('requestsManagementBtn');
    removePulse('approvalHistoryNavBtn');
    removePulse('approvalRequestsNavBtn');
    
    if (currentUser.role === 'super admin' && approvalRequests.length > 0) {
        addPulse('requestsManagementBtn');
    }
    
    if (currentUser.role !== 'super admin') {
        const userPendingRequests = approvalRequests.filter(req => 
            req.requestedBy === currentUser.username && req.status === 'pending'
        ).length;
        
        if (userPendingRequests > 0) {
            addPulse('approvalHistoryNavBtn');
        }
    }
    
    if (canApproveRequests()) {
        let visibleRequests = approvalRequests;
        if (currentUser.role === 'admin') {
            visibleRequests = approvalRequests.filter(req => 
                req.requestedByRole === 'staff' || req.requestedByRole === 'admin'
            );
        }
        
        if (visibleRequests.length > 0) {
            addPulse('approvalRequestsNavBtn');
        }
    }
}

const originalLoadApprovalRequests = loadApprovalRequests;
loadApprovalRequests = async function() {
    await originalLoadApprovalRequests.apply(this, arguments);
    refreshPulses();
};

const originalConfirmApproval = confirmApproval;
confirmApproval = async function(approved) {
    await originalConfirmApproval.apply(this, arguments);
    setTimeout(refreshPulses, 500);
};

const originalSubmitRejectionReason = submitRejectionReason;
submitRejectionReason = async function() {
    await originalSubmitRejectionReason.apply(this, arguments);
    setTimeout(refreshPulses, 500);
};

function closeAddUserModal() {
    document.getElementById('addUserModal').style.display = 'none';
    document.getElementById('newFullName').value = '';
    document.getElementById('newUsername').value = '';
    document.getElementById('newRole').value = 'staff';
    document.getElementById('newNrc').value = '';
    document.getElementById('newEmail').value = '';
    document.getElementById('newPhone').value = '';
    document.getElementById('newInstitution').value = '';
    document.getElementById('newPosition').value = '';
    document.getElementById('newPassword').value = '';
    
    ['newDegreeDocPreview', 'newZipsDocPreview', 'newNrcDocPreview'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
    });
    
    userUploadedDocuments = { degree: null, zips: null, nrc: null };
}

    async function ensureDefaultUsers() {
    try {
        const usersSnapshot = await db.collection(COLLECTIONS.USERS).get();
        if (usersSnapshot.empty) {
            const defaultUsers = [
                { 
                    fullName: "Joseph Zulu",
                    username: "JOSEPH", 
                    password: "Ndola$100", 
                    role: "super admin", 
                    enabled: true,
                    nrc: "123456/78/1", 
                    email: "zulujosephp@gmail.com", 
                    phone: "+260973031254", 
                    institution: "ZAMCOM", 
                    position: "Procurement Lead",
                    documents: {},
                    createdAt: new Date().toISOString(),
                    lastActive: null
                },
                { 
                    fullName: "Chishala Banda",
                    username: "CHISHALA", 
                    password: "test1234", 
                    role: "staff", 
                    enabled: true, 
                    nrc: "998877/66/5", 
                    email: "chishala@zamcom.zm", 
                    phone: "+260977123456", 
                    institution: "ZAMCOM", 
                    position: "Procurement Officer",
                    documents: {},
                    createdAt: new Date().toISOString(),
                    lastActive: null
                }
            ];
            
            for (const user of defaultUsers) {
                await db.collection(COLLECTIONS.USERS).add(user);
            }
            await logAudit('SYSTEM_INIT', { action: 'Default users created' });
            console.log("Default users created with full names");
        } else {
            const existingUsers = usersSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            const usernames = existingUsers.map(u => u.username);
            
            const josephExists = usernames.includes('JOSEPH');
            const chishalaExists = usernames.includes('CHISHALA');
            
            console.log('Existing users:', usernames);
            
            if (!josephExists) {
                console.log('JOSEPH not found - adding default JOSEPH account');
                await db.collection(COLLECTIONS.USERS).add({
                    fullName: "Joseph Zulu",
                    username: "JOSEPH", 
                    password: "RIGHTJOSEPH", 
                    role: "super admin", 
                    enabled: true,
                    nrc: "123456/78/1", 
                    email: "zulujosephp@gmail.com", 
                    phone: "+260973031254", 
                    institution: "ZAMCOM", 
                    position: "Procurement Lead",
                    documents: {},
                    createdAt: new Date().toISOString(),
                    lastActive: null
                });
            }
            
            if (!chishalaExists) {
                console.log('CHISHALA not found - adding default CHISHALA account');
                await db.collection(COLLECTIONS.USERS).add({
                    fullName: "Chishala Banda",
                    username: "CHISHALA", 
                    password: "RIGHTCHISHALA", 
                    role: "staff", 
                    enabled: true, 
                    nrc: "998877/66/5", 
                    email: "chishala@zamcom.zm", 
                    phone: "+260977123456", 
                    institution: "ZAMCOM", 
                    position: "Procurement Officer",
                    documents: {},
                    createdAt: new Date().toISOString(),
                    lastActive: null
                });
            }
            
            const josephUser = existingUsers.find(u => u.username === 'JOSEPH');
            if (josephUser && josephUser.enabled === false) {
                await db.collection(COLLECTIONS.USERS).doc(josephUser.id).update({
                    enabled: true
                });
                console.log("JOSEPH account was re-enabled (protection enforced)");
            }
        }
    } catch (error) { 
        console.error("Error ensuring users:", error); 
    }
}

async function showRequestsManagementView() {
    const currentUser = getUser(getCurrentUser());
    
    if (!currentUser || currentUser.role !== 'super admin') {
        alert('Only Super Admin can access Requests Management');
        return;
    }
    
    showView('requestsManagement');
    await loadRequestsManagementData();
}

async function loadRequestsManagementData() {
    try {
        console.log("Loading requests management data efficiently...");

        const skeletonLoader = renderSkeletonLoader();
        document.getElementById('pendingAccountsList').innerHTML = renderSkeletonLoader();
        document.getElementById('pendingApprovalsList').innerHTML = renderSkeletonLoader();
        document.getElementById('approvedAccountsList').innerHTML = renderSkeletonLoader();
        document.getElementById('approvedApprovalsList').innerHTML = renderSkeletonLoader();
        document.getElementById('rejectedAccountsList').innerHTML = renderSkeletonLoader();
        document.getElementById('rejectedApprovalsList').innerHTML = renderSkeletonLoader(); 
        
function renderSkeletonLoader() {
    return `
        <div style="padding: 20px;">
            ${Array(3).fill(0).map(() => `
                <div style="background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; animation: pulse 1.5s infinite;">
                    <div style="height: 20px; background: #f0f0f0; width: 30%; margin-bottom: 10px; border-radius: 4px;"></div>
                    <div style="height: 16px; background: #f0f0f0; width: 50%; margin-bottom: 8px; border-radius: 4px;"></div>
                    <div style="height: 16px; background: #f0f0f0; width: 40%; margin-bottom: 8px; border-radius: 4px;"></div>
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <div style="height: 30px; background: #f0f0f0; flex: 1; border-radius: 20px;"></div>
                        <div style="height: 30px; background: #f0f0f0; flex: 1; border-radius: 20px;"></div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}
        const [approvalSnapshot, accountSnapshot] = await Promise.all([
            db.collection(COLLECTIONS.APPROVALS)
                .orderBy('createdAt', 'desc')
                .limit(50) 
                .get(),
            db.collection('account_requests')
                .orderBy('requestedAt', 'desc')
                .limit(50) 
                .get()
        ]);
        
        console.log(`Loaded ${approvalSnapshot.size} approvals and ${accountSnapshot.size} accounts`);
        
        const startTime = performance.now();
        
        const allApprovalRequests = [];
        for (const doc of approvalSnapshot.docs) {
            allApprovalRequests.push({ 
                id: doc.id, 
                type: 'approval',
                ...doc.data() 
            });
        }
        
        const allAccountRequests = [];
        for (const doc of accountSnapshot.docs) {
            allAccountRequests.push({ 
                id: doc.id, 
                type: 'account',
                ...doc.data() 
            });
        }
        
        const pendingAccountRequests = [];
        const approvedAccountRequests = [];
        const rejectedAccountRequests = [];
        
        for (const req of allAccountRequests) {
            if (req.status === 'pending') pendingAccountRequests.push(req);
            else if (req.status === 'approved') approvedAccountRequests.push(req);
            else if (req.status === 'rejected') rejectedAccountRequests.push(req);
        }
        
        const pendingApprovalRequests = [];
        const approvedApprovalRequests = [];
        const rejectedApprovalRequests = [];
        
        for (const req of allApprovalRequests) {
            if (req.status === 'pending') pendingApprovalRequests.push(req);
            else if (req.status === 'approved') approvedApprovalRequests.push(req);
            else if (req.status === 'rejected') rejectedApprovalRequests.push(req);
        }
        
        console.log(`Processing took ${performance.now() - startTime}ms`);
        updateRequestsStatsOptimized({
            pendingAccounts: pendingAccountRequests.length,
            pendingApprovals: pendingApprovalRequests.length,
            approvedAccounts: approvedAccountRequests.length,
            approvedApprovals: approvedApprovalRequests.length,
            rejectedAccounts: rejectedAccountRequests.length,
            rejectedApprovals: rejectedApprovalRequests.length,
            totalAccounts: allAccountRequests.length,
            totalApprovals: allApprovalRequests.length
        });
        
        document.getElementById('pendingAccountsCount').textContent = pendingAccountRequests.length;
        document.getElementById('pendingApprovalsCount').textContent = pendingApprovalRequests.length;
        
        setTimeout(() => {
            document.getElementById('pendingAccountsList').innerHTML = renderPendingAccountRequestsOptimized(pendingAccountRequests);
        }, 10);
        
        setTimeout(() => {
            document.getElementById('pendingApprovalsList').innerHTML = renderPendingApprovalRequestsOptimized(pendingApprovalRequests);
        }, 20);
        
        setTimeout(() => {
            document.getElementById('approvedAccountsList').innerHTML = renderHistoryAccountRequestsOptimized(approvedAccountRequests, 'approved');
        }, 30);
        
        setTimeout(() => {
            document.getElementById('approvedApprovalsList').innerHTML = renderHistoryApprovalRequestsOptimized(approvedApprovalRequests, 'approved');
        }, 40);
        
        setTimeout(() => {
            document.getElementById('rejectedAccountsList').innerHTML = renderHistoryAccountRequestsOptimized(rejectedAccountRequests, 'rejected');
        }, 50);
        
        setTimeout(() => {
            document.getElementById('rejectedApprovalsList').innerHTML = renderHistoryApprovalRequestsOptimized(rejectedApprovalRequests, 'rejected');
        }, 60);
        
    } catch (error) {
        console.error('Error loading requests management data:', error);
        showNotification('Failed to load requests data: ' + error.message, 'error');
    }
}


function updateRequestsStatsOptimized(stats) {
    const statsCards = document.getElementById('requestsStatsCards');
    if (!statsCards) return;
    
    statsCards.innerHTML = `
        <div style="background: white; padding: 15px; border-radius: 16px; border-left: 4px solid #3498db;">
            <div style="font-size: 24px; margin-bottom: 4px;">👤</div>
            <div style="font-size: 24px; font-weight: 700; color: #3498db;">${stats.pendingAccounts}</div>
            <div style="font-size: 11px; color: #666;">Pending Accounts</div>
        </div>
        
        <div style="background: white; padding: 15px; border-radius: 16px; border-left: 4px solid #f39c12;">
            <div style="font-size: 24px; margin-bottom: 4px;">⏳</div>
            <div style="font-size: 24px; font-weight: 700; color: #f39c12;">${stats.pendingApprovals}</div>
            <div style="font-size: 11px; color: #666;">Pending Approvals</div>
        </div>
        
        <div style="background: white; padding: 15px; border-radius: 16px; border-left: 4px solid #2ecc71;">
            <div style="font-size: 24px; margin-bottom: 4px;">✓</div>
            <div style="font-size: 24px; font-weight: 700; color: #2ecc71;">${stats.approvedAccounts + stats.approvedApprovals}</div>
            <div style="font-size: 11px; color: #666;">Approved</div>
        </div>
        
        <div style="background: white; padding: 15px; border-radius: 16px; border-left: 4px solid #e74c3c;">
            <div style="font-size: 24px; margin-bottom: 4px;">✗</div>
            <div style="font-size: 24px; font-weight: 700; color: #e74c3c;">${stats.rejectedAccounts + stats.rejectedApprovals}</div>
            <div style="font-size: 11px; color: #666;">Rejected</div>
        </div>
        
        <div style="background: white; padding: 15px; border-radius: 16px; border-left: 4px solid #9b59b6;">
            <div style="font-size: 24px; margin-bottom: 4px;">📊</div>
            <div style="font-size: 24px; font-weight: 700; color: #9b59b6;">${stats.totalAccounts}</div>
            <div style="font-size: 11px; color: #666;">Total Acc</div>
        </div>
        
        <div style="background: white; padding: 15px; border-radius: 16px; border-left: 4px solid #e67e22;">
            <div style="font-size: 24px; margin-bottom: 4px;">📋</div>
            <div style="font-size: 24px; font-weight: 700; color: #e67e22;">${stats.totalApprovals}</div>
            <div style="font-size: 11px; color: #666;">Total App</div>
        </div>
    `;
}

function renderPendingAccountRequestsOptimized(requests) {
    if (requests.length === 0) {
        return `
            <div style="text-align: center; padding: 40px; background: white; border-radius: 16px;">
                <div style="font-size: 40px; margin-bottom: 10px;">📭</div>
                <div style="color: #666;">No pending account requests</div>
            </div>
        `;
    }
    
    const items = [];
    for (const req of requests) {
        const requestedAt = req.requestedAt ? new Date(req.requestedAt).toLocaleString() : 'Unknown';
        
        items.push(`
            <div style="background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; border-left: 6px solid #3498db;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <span style="background: #3498db; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">NEW ACCOUNT</span>
                    <span style="color: #888; font-size: 11px;">${requestedAt}</span>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <div style="font-weight: 600;">${req.fullName || 'Unknown'}</div>
                    <div style="font-size: 12px; color: #666;">@${req.username || 'N/A'}</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; margin-bottom: 16px;">
                    <div><span style="color:#888;">NRC:</span> ${req.nrc || 'N/A'}</div>
                    <div><span style="color:#888;">Phone:</span> ${req.phone || 'N/A'}</div>
                    <div><span style="color:#888;">Email:</span> ${req.email || 'N/A'}</div>
                    <div><span style="color:#888;">Inst:</span> ${req.institution || 'N/A'}</div>
                </div>
                
                <div style="display: flex; gap: 8px;">
                    <button onclick="approveAccountRequest('${req.id}')" style="flex:1; background: #27ae60; color: white; border: none; padding: 10px; border-radius: 30px; font-size: 12px; cursor: pointer;">✓ APPROVE</button>
                    <button onclick="openRejectAccountReasonModal('${req.id}')" style="flex:1; background: #e74c3c; color: white; border: none; padding: 10px; border-radius: 30px; font-size: 12px; cursor: pointer;">✗ REJECT</button>
                </div>
            </div>
        `);
    }
    
    return items.join('');
}

function renderPendingApprovalRequestsOptimized(requests) {
    if (requests.length === 0) {
        return `
            <div style="text-align: center; padding: 40px; background: white; border-radius: 16px;">
                <div style="font-size: 40px; margin-bottom: 10px;">📭</div>
                <div style="color: #666;">No pending approval requests</div>
            </div>
        `;
    }
    
    const items = [];
    for (const req of requests) {
        const created = req.createdDate ? new Date(req.createdDate).toLocaleString() : 'Unknown';
        const actionColor = req.action === 'delete' ? '#e74c3c' : req.action === 'edit' ? '#f39c12' : '#3498db';
        
        items.push(`
            <div style="background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; border-left: 6px solid ${actionColor};">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <div>
                        <span style="background: ${actionColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px;">${req.action?.toUpperCase() || 'ACTION'}</span>
                        <span style="margin-left: 8px; background: ${req.requestedByRole === 'super admin' ? '#9b59b6' : req.requestedByRole === 'admin' ? '#3498db' : '#2ecc71'}; color: white; padding: 4px 8px; border-radius: 20px; font-size: 10px;">${req.requestedByRole?.toUpperCase() || 'STAFF'}</span>
                    </div>
                    <span style="color: #888; font-size: 10px;">${created}</span>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <div style="font-weight: 600;">From: ${req.requestedByFullName || req.requestedBy || 'Unknown'}</div>
                    <div style="font-size: 12px;">Item: ${req.requestedData?.name || req.oldData?.name || req.itemId || 'N/A'}</div>
                </div>
                
                <div style="display: flex; gap: 8px;">
                    <button onclick="approveRequestNow('${req.id}')" style="flex:1; background: #27ae60; color: white; border: none; padding: 8px; border-radius: 20px; font-size: 11px; cursor: pointer;">✓ APPROVE</button>
                    <button onclick="openRejectReasonModalForRequest('${req.id}')" style="flex:1; background: #e74c3c; color: white; border: none; padding: 8px; border-radius: 20px; font-size: 11px; cursor: pointer;">✗ REJECT</button>
                </div>
            </div>
        `);
    }
    
    return items.join('');
}

function updateRequestsStats(stats) {
    const statsHtml = `
        <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); border-left: 4px solid #3498db;">
            <div style="font-size: 28px; margin-bottom: 8px;">👤</div>
            <div style="font-size: 28px; font-weight: 800; color: #3498db;">${stats.pendingAccounts}</div>
            <div style="font-size: 12px; color: #666;">Pending Accounts</div>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); border-left: 4px solid #f39c12;">
            <div style="font-size: 28px; margin-bottom: 8px;">⏳</div>
            <div style="font-size: 28px; font-weight: 800; color: #f39c12;">${stats.pendingApprovals}</div>
            <div style="font-size: 12px; color: #666;">Pending Approvals</div>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); border-left: 4px solid #2ecc71;">
            <div style="font-size: 28px; margin-bottom: 8px;">✓</div>
            <div style="font-size: 28px; font-weight: 800; color: #2ecc71;">${stats.approvedAccounts + stats.approvedApprovals}</div>
            <div style="font-size: 12px; color: #666;">Total Approved</div>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); border-left: 4px solid #e74c3c;">
            <div style="font-size: 28px; margin-bottom: 8px;">✗</div>
            <div style="font-size: 28px; font-weight: 800; color: #e74c3c;">${stats.rejectedAccounts + stats.rejectedApprovals}</div>
            <div style="font-size: 12px; color: #666;">Total Rejected</div>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); border-left: 4px solid #9b59b6;">
            <div style="font-size: 28px; margin-bottom: 8px;">📊</div>
            <div style="font-size: 28px; font-weight: 800; color: #9b59b6;">${stats.totalAccounts}</div>
            <div style="font-size: 12px; color: #666;">Total Accounts</div>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); border-left: 4px solid #e67e22;">
            <div style="font-size: 28px; margin-bottom: 8px;">📋</div>
            <div style="font-size: 28px; font-weight: 800; color: #e67e22;">${stats.totalApprovals}</div>
            <div style="font-size: 12px; color: #666;">Total Approvals</div>
        </div>
    `;
    
    document.getElementById('requestsStatsCards').innerHTML = statsHtml;
}

function showRequestsManagementTab(tabName) {
    // Hide all sections
    document.querySelectorAll('.requests-section').forEach(section => {
        section.style.display = 'none';
    });
    
    const tabs = [
        'pendingAccountsTabBtn',
        'pendingApprovalsTabBtn',
        'approvedAccountsTabBtn',
        'approvedApprovalsTabBtn',
        'rejectedAccountsTabBtn',
        'rejectedApprovalsTabBtn'
    ];
    
    tabs.forEach(tabId => {
        const btn = document.getElementById(tabId);
        if (btn) {
            if (tabId.includes('pendingAccounts')) btn.style.background = '#34495e';
            else if (tabId.includes('pendingApprovals')) btn.style.background = '#34495e';
            else if (tabId.includes('approvedAccounts')) btn.style.background = '#34495e';
            else if (tabId.includes('approvedApprovals')) btn.style.background = '#34495e';
            else if (tabId.includes('rejectedAccounts')) btn.style.background = '#34495e';
            else if (tabId.includes('rejectedApprovals')) btn.style.background = '#34495e';
        }
    });
    
    switch(tabName) {
        case 'pendingAccounts':
            document.getElementById('pendingAccountsSection').style.display = 'block';
            document.getElementById('pendingAccountsTabBtn').style.background = '#3498db';
            break;
        case 'pendingApprovals':
            document.getElementById('pendingApprovalsSection').style.display = 'block';
            document.getElementById('pendingApprovalsTabBtn').style.background = '#f39c12';
            break;
        case 'approvedAccounts':
            document.getElementById('approvedAccountsSection').style.display = 'block';
            document.getElementById('approvedAccountsTabBtn').style.background = '#2ecc71';
            break;
        case 'approvedApprovals':
            document.getElementById('approvedApprovalsSection').style.display = 'block';
            document.getElementById('approvedApprovalsTabBtn').style.background = '#27ae60';
            break;
        case 'rejectedAccounts':
            document.getElementById('rejectedAccountsSection').style.display = 'block';
            document.getElementById('rejectedAccountsTabBtn').style.background = '#e74c3c';
            break;
        case 'rejectedApprovals':
            document.getElementById('rejectedApprovalsSection').style.display = 'block';
            document.getElementById('rejectedApprovalsTabBtn').style.background = '#c0392b';
            break;
    }
}

const originalShowView = showView;
showView = function(viewName) {
    originalShowView(viewName);
    
    document.getElementById('requestsManagementView').style.display = 'none';
    
    if (viewName === 'requestsManagement') {
        document.getElementById('requestsManagementView').style.display = 'block';
    }
    
    if (viewName === 'home') {
        const searchInput = document.getElementById('globalSearch');
        if (searchInput) {
            searchInput.value = '';
        }
    }
};

async function removeAllDuplicateAccounts() {
    try {
        console.log("Checking for ALL duplicate accounts...");
        
        const snapshot = await db.collection(COLLECTIONS.USERS).get();
        const allUsers = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        const userGroups = {};
        allUsers.forEach(user => {
            if (!userGroups[user.username]) {
                userGroups[user.username] = [];
            }
            userGroups[user.username].push(user);
        });
        
        const duplicates = {};
        let totalDuplicateCount = 0;
        let usersToDelete = [];
        
        for (const [username, users] of Object.entries(userGroups)) {
            if (users.length > 1) {
                duplicates[username] = users;
                
                users.sort((a, b) => {
                    const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                    const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                    return dateA - dateB;
                });
                
                const keepUser = users[users.length - 1];
                
                for (let i = 0; i < users.length - 1; i++) {
                    usersToDelete.push({
                        ...users[i],
                        keepUser: keepUser
                    });
                    totalDuplicateCount++;
                }
            }
        }
        
        if (totalDuplicateCount === 0) {
            alert("✅ No duplicate accounts found! Your user list is clean.");
            return;
        }
        
        let summaryMessage = `⚠️ FOUND ${totalDuplicateCount} DUPLICATE ACCOUNT(S)\n\n`;
        
        for (const [username, users] of Object.entries(duplicates)) {
            summaryMessage += `\n👤 ${username}: ${users.length} accounts\n`;
            users.forEach((user, index) => {
                const keepMarker = index === users.length - 1 ? "✅ KEEP" : "🗑️ DELETE";
                const created = user.createdAt ? new Date(user.createdAt).toLocaleString() : 'Unknown date';
                summaryMessage += `   ${keepMarker} - ID: ${user.id.substring(0,8)}... (Created: ${created})\n`;
            });
        }
        
        summaryMessage += `\n\n⚠️ This action will keep the MOST RECENT account for each username and delete all older duplicates.`;
        summaryMessage += `\n\nDo you want to proceed?`;
        
        if (!confirm(summaryMessage)) {
            return;
        }
        
        const batch = db.batch();
        let batchCount = 0;
        let deletedCount = 0;
        
        for (const userToDelete of usersToDelete) {
            batch.delete(db.collection(COLLECTIONS.USERS).doc(userToDelete.id));
            deletedCount++;
            batchCount++;
            
            if (batchCount >= 400) {
                await batch.commit();
                console.log(`Committed batch of ${batchCount} deletions`);
                batchCount = 0;
            }
        }
        
        if (batchCount > 0) {
            await batch.commit();
            console.log(`Committed final batch of ${batchCount} deletions`);
        }
        
        await logAudit('DUPLICATE_CLEANUP', {
            action: 'Removed all duplicate accounts',
            duplicatesFound: duplicates,
            totalDeleted: deletedCount,
            deletedBy: getCurrentUser()
        });
        
        await getAllUsers(true);
        
        let successMessage = `✅ Successfully removed ${deletedCount} duplicate account(s)\n\n`;
        successMessage += `Cleaned up usernames:\n`;
        
        for (const [username, users] of Object.entries(duplicates)) {
            successMessage += `• ${username}: kept 1 of ${users.length}\n`;
        }
        
        alert(successMessage);
        
        if (document.getElementById('userManagementModal').style.display === 'flex') {
            manageUsersModal();
        }
        
    } catch (error) {
        console.error("Error removing duplicate accounts:", error);
        alert("Failed to remove duplicate accounts: " + error.message);
    }
}

async function checkAllDuplicates() {
    try {
        const snapshot = await db.collection(COLLECTIONS.USERS).get();
        const allUsers = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        const userGroups = {};
        allUsers.forEach(user => {
            if (!userGroups[user.username]) {
                userGroups[user.username] = [];
            }
            userGroups[user.username].push(user);
        });
        
        const duplicates = {};
        let totalDuplicates = 0;
        
        for (const [username, users] of Object.entries(userGroups)) {
            if (users.length > 1) {
                duplicates[username] = users;
                totalDuplicates += users.length - 1;
            }
        }
        
        const duplicateCount = Object.keys(duplicates).length;
        
        if (duplicateCount === 0) {
            alert("✅ No duplicate accounts found! Your user list is clean.");
            return;
        }
        
        let message = `📊 DUPLICATE ACCOUNT REPORT\n\n`;
        message += `Total users: ${allUsers.length}\n`;
        message += `Unique usernames: ${Object.keys(userGroups).length}\n`;
        message += `Usernames with duplicates: ${duplicateCount}\n`;
        message += `Total duplicate copies: ${totalDuplicates}\n\n`;
        message += `DETAILS:\n`;
        
        for (const [username, users] of Object.entries(duplicates)) {
            message += `\n👤 ${username} (${users.length} accounts):\n`;
            
            users.sort((a, b) => {
                const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                return dateB - dateA; 
            });
            
            users.forEach((user, index) => {
                const created = user.createdAt ? new Date(user.createdAt).toLocaleString() : 'Unknown date';
                const isMostRecent = index === 0 ? "📅 MOST RECENT" : "📅 Older copy";
                message += `   ${isMostRecent} - ID: ${user.id}\n`;
                message += `       Created: ${created}\n`;
                if (user.role) message += `       Role: ${user.role}\n`;
            });
        }
        
        message += `\n⚠️ To remove duplicates, use the "Remove All Duplicates" button.`;
        
        const modalDiv = document.createElement('div');
        modalDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            z-index: 99999;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
            line-height: 1.5;
        `;
        
        modalDiv.innerHTML = `
            <h3 style="color: #e67e22; margin-top: 0;">📊 Duplicate Accounts Report</h3>
            <div style="margin: 20px 0;">${message.replace(/\n/g, '<br>')}</div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="this.closest('div').remove()" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Close</button>
                <button onclick="this.closest('div').remove(); removeAllDuplicateAccounts()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Remove All Duplicates</button>
            </div>
        `;
        
        document.body.appendChild(modalDiv);
        
    } catch (error) {
        console.error("Error checking duplicates:", error);
        alert("Failed to check duplicates: " + error.message);
    }
}

    function hideLoadingSpinner() {
        const spinner = document.getElementById('loadingSpinner');
        if (spinner) {
            spinner.style.opacity = '0';
            setTimeout(() => {
                spinner.style.display = 'none';
            }, 500);
        }
    }

    async function loadRequestsHistory() {
        try {
            const snapshot = await db.collection(COLLECTIONS.APPROVALS)
                .orderBy('createdAt', 'desc')
                .limit(100)
                .get();
            requestsHistory = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
        } catch (error) {
            console.error('Error loading requests history:', error);
        }
    }

async function openRequestsManagement() {
    try {
        // Get all approval requests (both pending and history)
        const approvalSnapshot = await db.collection(COLLECTIONS.APPROVALS)
            .orderBy('createdAt', 'desc')
            .get();
        
        const accountSnapshot = await db.collection('account_requests')
            .orderBy('requestedAt', 'desc')
            .get();
        
        const allApprovalRequests = approvalSnapshot.docs.map(doc => ({ 
            id: doc.id, 
            type: 'approval',
            ...doc.data() 
        }));
        
        const allAccountRequests = accountSnapshot.docs.map(doc => ({ 
            id: doc.id, 
            type: 'account',
            ...doc.data() 
        }));
        
        const pendingAccountRequests = allAccountRequests.filter(req => req.status === 'pending');
        const approvedAccountRequests = allAccountRequests.filter(req => req.status === 'approved');
        const rejectedAccountRequests = allAccountRequests.filter(req => req.status === 'rejected');
        
        const pendingApprovalRequests = allApprovalRequests.filter(req => req.status === 'pending');
        const approvedApprovalRequests = allApprovalRequests.filter(req => req.status === 'approved');
        const rejectedApprovalRequests = allApprovalRequests.filter(req => req.status === 'rejected');
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'requestsManagementModal';
        modal.style.display = 'flex';
        
        modal.innerHTML = `
            <div style="background: linear-gradient(145deg, #f8fafc, #f0f4f8); width: 1300px; max-width: 95%; max-height: 90vh; overflow-y: auto; border-radius: 32px; padding: 40px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="background: var(--primary-green); width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 20px;">
                            <span style="font-size: 32px; color: white;">📋</span>
                        </div>
                        <div>
                            <h2 style="color: #1e3b37; margin: 0; font-size: 28px; font-weight: 700;">Requests Management</h2>
                            <p style="color: #6b9080; margin: 5px 0 0 0; font-size: 15px;">Complete history of all account and approval requests</p>
                        </div>
                    </div>
                    <button onclick="this.closest('.modal').remove()" style="background: white; border: none; width: 48px; height: 48px; border-radius: 16px; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #666; box-shadow: 0 4px 12px rgba(0,0,0,0.02);">
                        ✕
                    </button>
                </div>
                
                <!-- Stats Cards -->
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 40px;">
                    <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); border-left: 4px solid #3498db;">
                        <div style="font-size: 28px; margin-bottom: 8px;">👤</div>
                        <div style="font-size: 28px; font-weight: 800; color: #3498db;">${pendingAccountRequests.length}</div>
                        <div style="font-size: 12px; color: #666;">Pending Accounts</div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); border-left: 4px solid #f39c12;">
                        <div style="font-size: 28px; margin-bottom: 8px;">⏳</div>
                        <div style="font-size: 28px; font-weight: 800; color: #f39c12;">${pendingApprovalRequests.length}</div>
                        <div style="font-size: 12px; color: #666;">Pending Approvals</div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); border-left: 4px solid #2ecc71;">
                        <div style="font-size: 28px; margin-bottom: 8px;">✓</div>
                        <div style="font-size: 28px; font-weight: 800; color: #2ecc71;">${approvedAccountRequests.length + approvedApprovalRequests.length}</div>
                        <div style="font-size: 12px; color: #666;">Total Approved</div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); border-left: 4px solid #e74c3c;">
                        <div style="font-size: 28px; margin-bottom: 8px;">✗</div>
                        <div style="font-size: 28px; font-weight: 800; color: #e74c3c;">${rejectedAccountRequests.length + rejectedApprovalRequests.length}</div>
                        <div style="font-size: 12px; color: #666;">Total Rejected</div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); border-left: 4px solid #9b59b6;">
                        <div style="font-size: 28px; margin-bottom: 8px;">📊</div>
                        <div style="font-size: 28px; font-weight: 800; color: #9b59b6;">${allAccountRequests.length}</div>
                        <div style="font-size: 12px; color: #666;">Total Accounts</div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); border-left: 4px solid #e67e22;">
                        <div style="font-size: 28px; margin-bottom: 8px;">📋</div>
                        <div style="font-size: 28px; font-weight: 800; color: #e67e22;">${allApprovalRequests.length}</div>
                        <div style="font-size: 12px; color: #666;">Total Approvals</div>
                    </div>
                </div>
                
                <!-- Tab Navigation -->
                <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e9ecef; padding-bottom: 16px; flex-wrap: wrap;">
                    <button id="pendingAccountsTabBtn" onclick="showRequestsTab('pendingAccounts')" style="background: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 40px; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <span>👤</span> PENDING ACCOUNTS (${pendingAccountRequests.length})
                    </button>
                    <button id="pendingApprovalsTabBtn" onclick="showRequestsTab('pendingApprovals')" style="background: #f39c12; color: white; border: none; padding: 12px 24px; border-radius: 40px; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <span>⏳</span> PENDING APPROVALS (${pendingApprovalRequests.length})
                    </button>
                    <button id="approvedAccountsTabBtn" onclick="showRequestsTab('approvedAccounts')" style="background: #2ecc71; color: white; border: none; padding: 12px 24px; border-radius: 40px; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <span>✓</span> APPROVED ACCOUNTS (${approvedAccountRequests.length})
                    </button>
                    <button id="approvedApprovalsTabBtn" onclick="showRequestsTab('approvedApprovals')" style="background: #27ae60; color: white; border: none; padding: 12px 24px; border-radius: 40px; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <span>✓</span> APPROVED APPROVALS (${approvedApprovalRequests.length})
                    </button>
                    <button id="rejectedAccountsTabBtn" onclick="showRequestsTab('rejectedAccounts')" style="background: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 40px; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <span>✗</span> REJECTED ACCOUNTS (${rejectedAccountRequests.length})
                    </button>
                    <button id="rejectedApprovalsTabBtn" onclick="showRequestsTab('rejectedApprovals')" style="background: #c0392b; color: white; border: none; padding: 12px 24px; border-radius: 40px; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <span>✗</span> REJECTED APPROVALS (${rejectedApprovalRequests.length})
                    </button>
                </div>
                
                <!-- Content Sections -->
                <div id="pendingAccountsSection" style="display: block;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                        <span style="background: #3498db; width: 8px; height: 30px; border-radius: 4px;"></span>
                        👤 Pending Account Requests
                    </h3>
                    <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
                        ${renderPendingAccountRequests(pendingAccountRequests)}
                    </div>
                </div>
                
                <div id="pendingApprovalsSection" style="display: none;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                        <span style="background: #f39c12; width: 8px; height: 30px; border-radius: 4px;"></span>
                        ⏳ Pending Approval Requests
                    </h3>
                    <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
                        ${renderPendingApprovalRequests(pendingApprovalRequests)}
                    </div>
                </div>
                
                <div id="approvedAccountsSection" style="display: none;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                        <span style="background: #2ecc71; width: 8px; height: 30px; border-radius: 4px;"></span>
                        ✓ Approved Account Requests
                    </h3>
                    <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
                        ${renderHistoryAccountRequests(approvedAccountRequests, 'approved')}
                    </div>
                </div>
                
                <div id="approvedApprovalsSection" style="display: none;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                        <span style="background: #27ae60; width: 8px; height: 30px; border-radius: 4px;"></span>
                        ✓ Approved Approval Requests
                    </h3>
                    <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
                        ${renderHistoryApprovalRequests(approvedApprovalRequests, 'approved')}
                    </div>
                </div>
                
                <div id="rejectedAccountsSection" style="display: none;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                        <span style="background: #e74c3c; width: 8px; height: 30px; border-radius: 4px;"></span>
                        ✗ Rejected Account Requests
                    </h3>
                    <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
                        ${renderHistoryAccountRequests(rejectedAccountRequests, 'rejected')}
                    </div>
                </div>
                
                <div id="rejectedApprovalsSection" style="display: none;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                        <span style="background: #c0392b; width: 8px; height: 30px; border-radius: 4px;"></span>
                        ✗ Rejected Approval Requests
                    </h3>
                    <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
                        ${renderHistoryApprovalRequests(rejectedApprovalRequests, 'rejected')}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to load requests: ' + error.message);
    }
}

function renderPendingAccountRequests(requests) {
    if (requests.length === 0) {
        return `
            <div style="text-align: center; padding: 60px; background: white; border-radius: 20px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 20px;">📭</div>
                <div style="font-size: 16px;">No pending account requests</div>
            </div>
        `;
    }
    
    return requests.map(req => {
        const requestedAt = req.requestedAt ? new Date(req.requestedAt).toLocaleString() : 'Unknown';
        
        return `
            <div style="background: white; border-radius: 24px; padding: 24px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.02); border: 1px solid #f0f0f0; border-left: 6px solid #3498db;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="background: #3498db; color: white; padding: 8px 20px; border-radius: 30px; font-weight: 700; font-size: 14px;">
                            👤 NEW ACCOUNT REQUEST
                        </span>
                    </div>
                    <span style="color: #888; font-size: 13px; background: #f8f9fa; padding: 6px 16px; border-radius: 30px;">
                        🕐 ${requestedAt}
                    </span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px; margin-bottom: 24px;">
                    <div style="background: #fafbfc; padding: 20px; border-radius: 20px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 10px;">👤 APPLICANT DETAILS</div>
                        <div style="font-weight: 700; font-size: 18px; margin-bottom: 5px;">${req.fullName || 'Unknown'}</div>
                        <div style="color: #666; font-size: 14px;">@${req.username || 'N/A'}</div>
                        <div style="margin-top: 15px;">
                            <span style="background: #e8f0fe; padding: 4px 12px; border-radius: 20px; font-size: 12px;">📧 ${req.email || 'No email'}</span>
                        </div>
                    </div>
                    
                    <div style="background: #fafbfc; padding: 20px; border-radius: 20px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 10px;">📋 APPLICATION DETAILS</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-size: 11px; color: #888;">NRC</div>
                                <div style="font-weight: 600;">${req.nrc || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #888;">Phone</div>
                                <div style="font-weight: 600;">${req.phone || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #888;">Institution</div>
                                <div style="font-weight: 600;">${req.institution || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #888;">Position</div>
                                <div style="font-weight: 600;">${req.position || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 16px; justify-content: flex-end; border-top: 1px solid #f0f0f0; padding-top: 24px;">
                    <button onclick="approveAccountRequest('${req.id}')" style="background: #27ae60; color: white; border: none; padding: 14px 32px; border-radius: 40px; font-weight: 700; font-size: 14px; cursor: pointer;">
                        ✓ APPROVE ACCOUNT
                    </button>
                    <button onclick="openRejectAccountReasonModal('${req.id}')" style="background: #e74c3c; color: white; border: none; padding: 14px 32px; border-radius: 40px; font-weight: 700; font-size: 14px; cursor: pointer;">
                        ✗ REJECT
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function renderPendingApprovalRequests(requests) {
    if (requests.length === 0) {
        return `
            <div style="text-align: center; padding: 60px; background: white; border-radius: 20px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 20px;">📭</div>
                <div style="font-size: 16px;">No pending approval requests</div>
            </div>
        `;
    }
    
    return requests.map(req => {
        const created = req.createdDate ? new Date(req.createdDate).toLocaleString() : 'Unknown';
        const actionColor = req.action === 'delete' ? '#e74c3c' : 
                          req.action === 'edit' ? '#f39c12' : '#3498db';
        
        return `
            <div style="background: white; border-radius: 24px; padding: 24px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.02); border: 1px solid #f0f0f0; border-left: 6px solid ${actionColor};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="background: ${actionColor}; color: white; padding: 8px 20px; border-radius: 30px; font-weight: 700; font-size: 14px;">
                            ⏳ ${req.action?.toUpperCase() || 'ACTION'} · ${req.type?.toUpperCase() || 'ITEM'}
                        </span>
                        <span style="background: ${req.requestedByRole === 'super admin' ? '#9b59b6' : req.requestedByRole === 'admin' ? '#3498db' : '#2ecc71'}; color: white; padding: 6px 16px; border-radius: 30px; font-size: 13px;">
                            ${req.requestedByRole?.toUpperCase() || 'STAFF'}
                        </span>
                    </div>
                    <span style="color: #888; font-size: 13px; background: #f8f9fa; padding: 6px 16px; border-radius: 30px;">
                        🕐 ${created}
                    </span>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 5px;">Requested By: ${req.requestedByFullName || req.requestedBy || 'Unknown'}</div>
                    <div style="color: #666; font-size: 14px;">Item: ${req.requestedData?.name || req.oldData?.name || req.itemId || 'N/A'}</div>
                    ${req.reason ? `<div style="margin-top: 10px; padding: 10px; background: #fff8e7; border-radius: 8px; font-size: 13px;"><strong>Reason:</strong> ${req.reason}</div>` : ''}
                </div>
                
                <div style="display: flex; gap: 16px; justify-content: flex-end;">
                    <button onclick="approveRequestNow('${req.id}')" style="background: #27ae60; color: white; border: none; padding: 12px 24px; border-radius: 30px; font-weight: 600; cursor: pointer;">✓ APPROVE</button>
                    <button onclick="openRejectReasonModalForRequest('${req.id}')" style="background: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 30px; font-weight: 600; cursor: pointer;">✗ REJECT</button>
                </div>
            </div>
        `;
    }).join('');
}

function renderHistoryAccountRequests(requests, status) {
    if (requests.length === 0) {
        return `
            <div style="text-align: center; padding: 60px; background: white; border-radius: 20px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 20px;">📭</div>
                <div style="font-size: 16px;">No ${status} account requests found</div>
            </div>
        `;
    }
    
    const statusColor = status === 'approved' ? '#2ecc71' : '#e74c3c';
    const statusBg = status === 'approved' ? '#e8f8f5' : '#fee9e7';
    
    return requests.map(req => {
        const requestedAt = req.requestedAt ? new Date(req.requestedAt).toLocaleString() : 'Unknown';
        const reviewedAt = req.approvedAt || req.rejectedAt ? new Date(req.approvedAt || req.rejectedAt).toLocaleString() : 'Unknown';
        const reviewedBy = req.approvedBy || req.rejectedBy || 'System';
        const reason = req.rejectionReason || '';
        
        return `
            <div style="background: white; border-radius: 24px; padding: 24px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.02); border: 1px solid #f0f0f0; border-left: 6px solid ${statusColor};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="background: ${statusColor}; color: white; padding: 8px 20px; border-radius: 30px; font-weight: 700; font-size: 14px;">
                            ${status === 'approved' ? '✓ APPROVED' : '✗ REJECTED'} ACCOUNT
                        </span>
                    </div>
                    <span style="color: #888; font-size: 13px; background: #f8f9fa; padding: 6px 16px; border-radius: 30px;">
                        🕐 Requested: ${requestedAt}
                    </span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px; margin-bottom: 24px;">
                    <div style="background: #fafbfc; padding: 20px; border-radius: 20px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 10px;">👤 APPLICANT</div>
                        <div style="font-weight: 700; font-size: 18px; margin-bottom: 5px;">${req.fullName || 'Unknown'}</div>
                        <div style="color: #666; font-size: 14px;">@${req.username || 'N/A'}</div>
                        <div style="margin-top: 15px;">
                            <span style="background: #e8f0fe; padding: 4px 12px; border-radius: 20px; font-size: 12px;">📧 ${req.email || 'No email'}</span>
                        </div>
                    </div>
                    
                    <div style="background: #fafbfc; padding: 20px; border-radius: 20px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 10px;">📋 REVIEW DETAILS</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-size: 11px; color: #888;">Reviewed By</div>
                                <div style="font-weight: 600;">${reviewedBy}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #888;">Reviewed At</div>
                                <div style="font-weight: 600;">${reviewedAt}</div>
                            </div>
                        </div>
                        ${reason ? `
                        <div style="margin-top: 15px; padding: 12px; background: #fee9e7; border-radius: 8px;">
                            <div style="font-size: 11px; color: #e74c3c; margin-bottom: 4px;">REJECTION REASON</div>
                            <div style="font-size: 13px;">${reason}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 16px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 10px;">📄 APPLICATION DETAILS</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div>
                            <div style="font-size: 11px; color: #888;">NRC</div>
                            <div style="font-weight: 500;">${req.nrc || 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #888;">Phone</div>
                            <div style="font-weight: 500;">${req.phone || 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #888;">Institution</div>
                            <div style="font-weight: 500;">${req.institution || 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #888;">Position</div>
                            <div style="font-weight: 500;">${req.position || 'N/A'}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function renderHistoryApprovalRequests(requests, status) {
    if (requests.length === 0) {
        return `
            <div style="text-align: center; padding: 60px; background: white; border-radius: 20px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 20px;">📭</div>
                <div style="font-size: 16px;">No ${status} approval requests found</div>
            </div>
        `;
    }
    
    const statusColor = status === 'approved' ? '#2ecc71' : '#e74c3c';
    return requests.map(req => {
        const created = req.createdDate ? new Date(req.createdDate).toLocaleString() : 'Unknown';
        const reviewedAt = req.reviewedAt ? new Date(req.reviewedAt).toLocaleString() : 'Unknown';
        const actionColor = req.action === 'delete' ? '#e74c3c' : 
                          req.action === 'edit' ? '#f39c12' : '#3498db';
        
        return `
            <div style="background: white; border-radius: 24px; padding: 24px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.02); border: 1px solid #f0f0f0; border-left: 6px solid ${actionColor};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="background: ${statusColor}; color: white; padding: 8px 20px; border-radius: 30px; font-weight: 700; font-size: 14px;">
                            ${status === 'approved' ? '✓ APPROVED' : '✗ REJECTED'}
                        </span>
                        <span style="background: ${actionColor}; color: white; padding: 6px 16px; border-radius: 30px; font-size: 13px;">
                            ${req.action?.toUpperCase() || 'ACTION'}
                        </span>
                        <span style="background: ${req.requestedByRole === 'super admin' ? '#9b59b6' : req.requestedByRole === 'admin' ? '#3498db' : '#2ecc71'}; color: white; padding: 6px 16px; border-radius: 30px; font-size: 13px;">
                            ${req.requestedByRole?.toUpperCase() || 'STAFF'}
                        </span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 12px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 4px;">📅 REQUESTED</div>
                        <div style="font-weight: 600;">${created}</div>
                        <div style="font-size: 12px; margin-top: 5px;">By: ${req.requestedByFullName || req.requestedBy}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 12px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 4px;">📅 REVIEWED</div>
                        <div style="font-weight: 600;">${reviewedAt}</div>
                        <div style="font-size: 12px; margin-top: 5px;">By: ${req.reviewedBy || 'System'}</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">📦 Item: ${req.requestedData?.name || req.oldData?.name || req.itemId || 'N/A'}</div>
                    ${req.reason ? `
                        <div style="margin-top: 10px; padding: 10px; background: #fff8e7; border-radius: 8px;">
                            <strong>Reason provided:</strong> ${req.reason}
                        </div>
                    ` : ''}
                    ${req.rejectionReason ? `
                        <div style="margin-top: 10px; padding: 10px; background: #fee9e7; border-radius: 8px;">
                            <strong style="color: #e74c3c;">Rejection reason:</strong> ${req.rejectionReason}
                        </div>
                    ` : ''}
                </div>
                
                ${req.changeSummary && req.changeSummary.length > 0 ? `
                    <div style="background: #f0f7ff; padding: 15px; border-radius: 12px; border-left: 4px solid #3498db;">
                        <div style="font-weight: 600; color: #2c3e50; margin-bottom: 10px;">📋 CHANGES APPLIED:</div>
                        <div style="display: grid; gap: 8px;">
                            ${req.changeSummary.map(change => `
                                <div style="font-size: 13px; padding: 5px 0; border-bottom: 1px dashed #ddd;">
                                    <span style="font-weight: 600; text-transform: capitalize;">${change.field}:</span> 
                                    <span style="color: #e74c3c;">${change.oldValue}</span> → 
                                    <span style="color: #27ae60;">${change.newValue}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

function showRequestsTab(tabName) {
    document.getElementById('pendingAccountsSection').style.display = 'none';
    document.getElementById('pendingApprovalsSection').style.display = 'none';
    document.getElementById('approvedAccountsSection').style.display = 'none';
    document.getElementById('approvedApprovalsSection').style.display = 'none';
    document.getElementById('rejectedAccountsSection').style.display = 'none';
    document.getElementById('rejectedApprovalsSection').style.display = 'none';
    
    document.getElementById('pendingAccountsTabBtn').style.background = '#34495e';
    document.getElementById('pendingApprovalsTabBtn').style.background = '#34495e';
    document.getElementById('approvedAccountsTabBtn').style.background = '#34495e';
    document.getElementById('approvedApprovalsTabBtn').style.background = '#34495e';
    document.getElementById('rejectedAccountsTabBtn').style.background = '#34495e';
    document.getElementById('rejectedApprovalsTabBtn').style.background = '#34495e';
    
    switch(tabName) {
        case 'pendingAccounts':
            document.getElementById('pendingAccountsSection').style.display = 'block';
            document.getElementById('pendingAccountsTabBtn').style.background = '#3498db';
            break;
        case 'pendingApprovals':
            document.getElementById('pendingApprovalsSection').style.display = 'block';
            document.getElementById('pendingApprovalsTabBtn').style.background = '#f39c12';
            break;
        case 'approvedAccounts':
            document.getElementById('approvedAccountsSection').style.display = 'block';
            document.getElementById('approvedAccountsTabBtn').style.background = '#2ecc71';
            break;
        case 'approvedApprovals':
            document.getElementById('approvedApprovalsSection').style.display = 'block';
            document.getElementById('approvedApprovalsTabBtn').style.background = '#27ae60';
            break;
        case 'rejectedAccounts':
            document.getElementById('rejectedAccountsSection').style.display = 'block';
            document.getElementById('rejectedAccountsTabBtn').style.background = '#e74c3c';
            break;
        case 'rejectedApprovals':
            document.getElementById('rejectedApprovalsSection').style.display = 'block';
            document.getElementById('rejectedApprovalsTabBtn').style.background = '#c0392b';
            break;
    }
}

async function viewRequestDocument(requestId, docType) {
    try {
        const doc = await db.collection('account_requests').doc(requestId).get();
        if (!doc.exists) {
            alert('Request not found');
            return;
        }
        
        const requestData = doc.data();
        
        if (!requestData.documents || !requestData.documents[docType]) {
            alert(`No ${docType} document found for this request`);
            return;
        }
        
        const documentData = requestData.documents[docType];
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'requestDocumentViewerModal';
        modal.style.display = 'flex';
        modal.style.zIndex = '60000';
        
        const isImage = documentData.type && 
                       (documentData.type.startsWith('image/') || 
                        documentData.name?.match(/\.(jpg|jpeg|png|gif|webp)$/i));
        
        const titleMap = {
            nrc: '🪪 NRC Document',
            degree: '🎓 Degree/Diploma Certificate',
            zips: '📜 ZIPS Membership Certificate'
        };
        
        modal.innerHTML = `
            <div style="background: white; width: 90%; max-width: 1000px; height: 90vh; border-radius: 24px; overflow: hidden; display: flex; flex-direction: column;">
                <div style="background: var(--primary-green); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                        ${titleMap[docType] || 'Document'} - ${requestData.fullName || requestData.username}
                    </h3>
                    <button onclick="this.closest('.modal').remove()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">✕</button>
                </div>
                <div style="flex: 1; padding: 20px; overflow: auto; background: #f5f5f5; display: flex; flex-direction: column; align-items: center;">
                    ${isImage ? `
                        <img src="${documentData.data}" style="max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px; width: 100%; max-width: 600px;">
                            <p><strong>File Name:</strong> ${documentData.name}</p>
                            <p><strong>Uploaded:</strong> ${new Date(documentData.uploadedAt).toLocaleString()}</p>
                            <p><strong>File Size:</strong> ${(documentData.size / 1024).toFixed(1)} KB</p>
                        </div>
                    ` : `
                        <iframe src="${documentData.data}" style="width: 100%; height: 80vh; border: none; border-radius: 8px;"></iframe>
                        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px; width: 100%;">
                            <p><strong>File Name:</strong> ${documentData.name}</p>
                            <p><strong>Uploaded:</strong> ${new Date(documentData.uploadedAt).toLocaleString()}</p>
                            <p><strong>File Size:</strong> ${(documentData.size / 1024).toFixed(1)} KB</p>
                        </div>
                    `}
                </div>
                <div style="padding: 20px; background: #f8f9fa; border-top: 1px solid #dee2e6; display: flex; gap: 10px; justify-content: flex-end;">
                    <a href="${documentData.data}" download="${documentData.name}" style="background: var(--primary-green); color: white; border: none; padding: 10px 25px; border-radius: 30px; text-decoration: none; font-weight: 600; cursor: pointer;">📥 Download</a>
                    <button onclick="this.closest('.modal').remove()" style="background: #95a5a6; color: white; border: none; padding: 10px 25px; border-radius: 30px; font-weight: 600; cursor: pointer;">Close</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error viewing document:', error);
        alert('Failed to view document: ' + error.message);
    }
}

async function approveAccountRequest(requestId) {
    try {
        console.log('Approving account with ID:', requestId);
        
        const doc = await db.collection('account_requests').doc(requestId).get();
        if (!doc.exists) {
            alert('Request not found');
            return;
        }
        
        const requestData = doc.data();
        console.log('Request data:', requestData);
        
        if (!requestData) {
            alert('Request data is missing');
            return;
        }

        const newUser = {
            fullName: requestData.fullName || 'Unknown User',
            username: requestData.username || 'unknown',
            password: requestData.password || 'default123',
            role: 'staff',
            nrc: requestData.nrc || '',
            phone: requestData.phone || '',
            institution: requestData.institution || '',
            position: requestData.position || '',
            email: requestData.email || '',
            documents: requestData.documents || {},
            enabled: true,
            createdAt: new Date().toISOString(),
            lastActive: null
        };

        console.log('Creating new user:', newUser);
        await db.collection(COLLECTIONS.USERS).add(newUser);
        await db.collection('account_requests').doc(requestId).update({
            status: 'approved',
            approvedAt: new Date().toISOString(),
            approvedBy: getCurrentUser()
        });

        await logAudit('ACCOUNT_APPROVED', {
            username: requestData.username,
            fullName: requestData.fullName,
            email: requestData.email,
            approvedBy: getCurrentUser()
        });

        showNotification(`Account for ${requestData.fullName || requestData.username} approved successfully`, 'success');
        const modal = document.getElementById('requestsManagementModal');
        if (modal) modal.remove();
        if (typeof openRequestsManagement === 'function') {
            openRequestsManagement();
        }

    } catch (error) {
        console.error('Error approving account:', error);
        alert('Failed to approve account: ' + error.message);
    }
}

let pendingAccountRejectId = null;

function openRejectAccountReasonModal(requestId) {
    pendingAccountRejectId = requestId;
    const existingModal = document.getElementById('rejectAccountReasonModal');
    if (existingModal) existingModal.remove();
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'rejectAccountReasonModal';
    modal.style.display = 'flex';
    
    modal.innerHTML = `
        <div class="reject-modal-content" style="border-radius: 24px; padding: 30px;">
            <h3 style="color: var(--danger-red); margin-bottom: 20px; text-align: center;">✗ Reject Account Request</h3>
            <p style="color: #666; margin-bottom: 15px;">Please provide a reason for rejecting this account request:</p>
            <textarea id="accountRejectReason" class="reject-textarea" placeholder="Enter rejection reason..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; min-height: 100px;"></textarea>
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="btn" style="flex: 1; background: var(--danger-red);" onclick="submitAccountRejection('${requestId}')">Confirm Rejection</button>
                <button class="btn" style="flex: 1; background: #95a5a6;" onclick="closeRejectAccountModal()">Cancel</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

async function submitAccountRejection(requestId) {
    const reason = document.getElementById('accountRejectReason')?.value.trim();
    
    if (!reason) {
        alert('Please provide a rejection reason');
        return;
    }
    
    try {
        const doc = await db.collection('account_requests').doc(requestId).get();
        if (!doc.exists) {
            alert('Request not found');
            return;
        }
        
        const requestData = doc.data();

        await db.collection('account_requests').doc(requestId).update({
            status: 'rejected',
            rejectedAt: new Date().toISOString(),
            rejectedBy: getCurrentUser(),
            rejectionReason: reason
        });

        await logAudit('ACCOUNT_REJECTED', {
            username: requestData.username,
            fullName: requestData.fullName,
            email: requestData.email,
            rejectedBy: getCurrentUser(),
            reason: reason
        });

        closeRejectAccountModal();
        
        const modal = document.getElementById('requestsManagementModal');
        if (modal) modal.remove();
        
        if (typeof openRequestsManagement === 'function') {
            openRequestsManagement();
        }
        
        showNotification(`Account request for ${requestData.fullName || requestData.username} rejected`, 'info');
        
    } catch (error) {
        console.error('Error rejecting account:', error);
        alert('Failed to reject account: ' + error.message);
    }
}

(function() {
    const EMAILJS_PUBLIC_KEY = '9r7UMO_eQNrADd-xN';
    const EMAILJS_SERVICE_ID = 'service_smyrjjn';
    const EMAILJS_TEMPLATE_ID = 'template_s04e0xg';
    
    window.emailJSConfig = {
        publicKey: EMAILJS_PUBLIC_KEY,
        serviceId: EMAILJS_SERVICE_ID,
        templateId: EMAILJS_TEMPLATE_ID
    };
    
    try {
        emailjs.init(EMAILJS_PUBLIC_KEY);
        console.log('EmailJS initialized with credentials');
    } catch (e) {
        console.error('EmailJS initialization failed:', e);
    }
})();

(function() {
    try {
        const savedConfig = localStorage.getItem('emailjs_config');
        if (savedConfig) {
            const config = JSON.parse(savedConfig);
            window.emailJSConfig = config;
            emailjs.init(config.publicKey);
            console.log('EmailJS initialized from saved config');
        }
    } catch (e) {
        console.log('No saved EmailJS config');
    }
})();

function configureEmailJS() {
    const publicKey = prompt('Enter your EmailJS Public Key:');
    if (!publicKey) return;
    
    const serviceId = prompt('Enter your EmailJS Service ID:');
    if (!serviceId) return;
    
    const templateId = prompt('Enter your EmailJS Template ID:');
    if (!templateId) return;
    
    const config = {
        publicKey: publicKey,
        serviceId: serviceId,
        templateId: templateId
    };
    
    window.emailJSConfig = config;
    localStorage.setItem('emailjs_config', JSON.stringify(config));
    emailjs.init(publicKey);
    
    alert('EmailJS configured successfully!');
    showNotification('EmailJS configured and saved', 'success');
}

(function() {
    try {
        const savedConfig = localStorage.getItem('emailjs_config');
        if (savedConfig) {
            const config = JSON.parse(savedConfig);
            window.emailJSConfig = config;
            emailjs.init(config.publicKey);
            console.log('EmailJS initialized from saved config');
        }
    } catch (e) {
        console.log('No saved EmailJS config or error loading:', e);
    }
})();

function addForgotPasswordModal() {
    if (document.getElementById('forgotPasswordModal')) return;
    
    const modalHTML = `
    <div id="forgotPasswordModal" class="modal" style="display: none; z-index: 25000;">
        <div class="modal-content" style="border-radius: 24px; max-width: 450px; padding: 25px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, var(--primary-green), #0f2a4a); width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <span style="font-size: 32px; color: white;">🔐</span>
                </div>
                <h3 style="color: #2c3e50; margin: 0 0 5px 0; font-size: 1.8rem;">Forgot Password</h3>
                <p style="color: #666; font-size: 12px; margin: 0;">Enter your details to retrieve your account</p>
            </div>
            
            <div id="forgotPasswordStep1">
                <div class="password-field" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #555;">NRC Number</label>
                    <input type="text" id="fpNrc" placeholder="e.g., 123456/78/1" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 15px;">
                </div>
                
                <div class="password-field" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #555;">Phone Number</label>
                    <input type="text" id="fpPhone" placeholder="e.g., 0977123456" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 15px;">
                </div>
                
                <div class="password-field" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #555;">Email Address</label>
                    <input type="email" id="fpEmail" placeholder="e.g., user@example.com" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 15px;">
                </div>
                
                <div style="display: flex; gap: 15px;">

                    <button class="btn btn-add" style="flex: 2; padding: 12px; font-size: 14px;" onclick="verifyForgotPassword()">
                        <span>🔍</span> Verify & Send
                    </button>
                    <button class="btn" style="flex: 1; background: #95a5a6; padding: 12px; font-size: 14px;" onclick="closeForgotPasswordModal()">
                        Cancel
                    </button>
                        
                    </div>
        <p style="text-align:center;color: #666; font-size: 14px; margin: 0;">If you are unable to received your Password Recovery Email, contact support at <br>zedsupplierdirectoryzm@gmail.com</p>
            </div>
            
            <div id="forgotPasswordStep2" style="display: none; text-align: center;">
                <div style="background: #2ecc71; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 20px auto;">
                    <span style="font-size: 40px; color: white;">✓</span>
                </div>
                <h4 style="color: #2c3e50; margin: 20px 0 10px 0;">Email Sent Successfully!</h4>
                <p style="color: #666; margin-bottom: 20px;">Your account details have been sent to:<br><strong id="sentEmailDisplay"></strong></p>
                <p style="font-size: 13px; color: #888; margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 12px;">
                    ⚠️ Please check your inbox or spam folder.<br> If you still haven't received your Password Recovery Email, contact support at <br>zedsupplierdirectoryzm@gmail.com <br>
                    For security, change your password after logging in.
                </p>
                <button class="btn btn-add" style="width: 100%; padding: 14px;" onclick="closeForgotPasswordModal()">
                    Return to Login
                </button>
            </div>
            
            <div id="forgotPasswordError" style="display: none; margin-top: 15px; padding: 12px; background: #fee9e7; border-left: 4px solid #e74c3c; border-radius: 8px; color: #e74c3c; font-size: 14px;">
                <span style="font-weight: bold;">✗ Error:</span> <span id="fpErrorMessage"></span>
            </div>
        </div>
    </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

addForgotPasswordModal();

function openForgotPasswordModal() {
    document.getElementById('fpNrc').value = '';
    document.getElementById('fpPhone').value = '';
    document.getElementById('fpEmail').value = '';
    document.getElementById('forgotPasswordStep1').style.display = 'block';
    document.getElementById('forgotPasswordStep2').style.display = 'none';
    document.getElementById('forgotPasswordError').style.display = 'none';
    document.getElementById('forgotPasswordModal').style.display = 'flex';
}

function closeForgotPasswordModal() {
    document.getElementById('forgotPasswordModal').style.display = 'none';
}

async function verifyForgotPassword() {
    const nrc = document.getElementById('fpNrc').value.trim();
    const phone = document.getElementById('fpPhone').value.trim();
    const email = document.getElementById('fpEmail').value.trim();
    
    if (!nrc || !phone || !email) {
        showForgotPasswordError('All fields are required');
        return;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showForgotPasswordError('Please enter a valid email address');
        return;
    }

    const config = window.emailJSConfig;
    console.log('EmailJS Config:', config);
    
    if (!config || !config.publicKey) {
        showForgotPasswordError('Email service not configured. Please contact administrator.');
        console.error('EmailJS config missing:', config);
        return;
    }

    const sendBtn = document.querySelector('#forgotPasswordStep1 .btn-add');
    const originalText = sendBtn.innerHTML;
    sendBtn.innerHTML = '<span>⏳</span> Sending...';
    sendBtn.disabled = true;
    
    try {
        const users = userAccounts.filter(u => 
            u.nrc && u.nrc.toLowerCase() === nrc.toLowerCase() &&
            u.phone && u.phone.replace(/\D/g, '') === phone.replace(/\D/g, '') &&
            u.email && u.email.toLowerCase() === email.toLowerCase()
        );
        
        console.log('Found users:', users.length);
        
        if (users.length === 0) {
            showForgotPasswordError('No account found with the provided details');
            sendBtn.innerHTML = originalText;
            sendBtn.disabled = false;
            return;
        }
        
        const user = users[0];
        console.log('User found:', user.username);
        
        emailjs.init(config.publicKey);
        
        const templateParams = {
            to_email: email,
            to_name: user.fullName || user.username,
            from_name: 'ZAMCOM Procurement',
            username: user.username,
            password: user.password,
            fullName: user.fullName || user.username,
            reply_to: 'noreply@zamcom.zm',
            subject: 'Your Zed Supplier Directory Account Information',
            message: `Hello ${user.fullName || user.username},\n\nYour account details are:\nUsername: ${user.username}\nPassword: ${user.password}\n\nPlease change your password after logging in.\n\nBest regards,\nZAMCOM Procurement Team`
        };
        
        console.log('Sending email with params:', templateParams);
        
        const response = await emailjs.send(
            config.serviceId,
            config.templateId,
            templateParams
        );
        
        console.log('Email sent successfully:', response);
        
        await logAudit('PASSWORD_RETRIEVAL', {
            username: user.username,
            email: email,
            method: 'forgot_password'
        });
        
        document.getElementById('forgotPasswordStep1').style.display = 'none';
        document.getElementById('sentEmailDisplay').textContent = email;
        document.getElementById('forgotPasswordStep2').style.display = 'block';
        document.getElementById('forgotPasswordError').style.display = 'none';
        
    } catch (error) {
        console.error('Error sending email:', error);
        
        let errorMessage = 'Failed to send email. ';
        
        if (error.text) {
            errorMessage += error.text;
        } else if (error.message) {
            errorMessage += error.message;
        } else {
            errorMessage += 'Please try again later.';
        }
        
        showForgotPasswordError(errorMessage);
        console.error('EmailJS Error Details:', {
            error: error,
            config: config,
            userAccounts: userAccounts.length
        });
        
    } finally {
        const sendBtn = document.querySelector('#forgotPasswordStep1 .btn-add');
        if (sendBtn) {
            sendBtn.innerHTML = '<span>🔍</span> Verify & Send';
            sendBtn.disabled = false;
        }
    }
}

function testEmailJSConfig() {
    const config = window.emailJSConfig;
    console.log('EmailJS Config:', config);
    
    if (!config) {
        alert('EmailJS config not found');
        return;
    }
    
    try {
        emailjs.init(config.publicKey);
        console.log('EmailJS initialized successfully');
        
        alert(`EmailJS configured with:\nPublic Key: ${config.publicKey}\nService ID: ${config.serviceId}\nTemplate ID: ${config.templateId}`);
        
    } catch (error) {
        console.error('EmailJS init error:', error);
        alert('EmailJS initialization failed: ' + error.message);
    }
}

function showForgotPasswordError(message) {
    const errorDiv = document.getElementById('forgotPasswordError');
    const errorMsg = document.getElementById('fpErrorMessage');
    errorMsg.textContent = message;
    errorDiv.style.display = 'block';
}

function forgotPasswordSimple() {
    openForgotPasswordModal();
}

function closeRejectAccountModal() {
    const modal = document.getElementById('rejectAccountReasonModal');
    if (modal) modal.remove();
    pendingAccountRejectId = null;
}

async function approveAccountRequest(requestId) {
    try {
        // Get the request data
        const doc = await db.collection('account_requests').doc(requestId).get();
        if (!doc.exists) {
            alert('Request not found');
            return;
        }
        
        const requestData = doc.data();
        console.log('Approving account:', requestData);
        
        const newUserAccount = {
            fullName: requestData.fullName || 'Unknown User',
            username: requestData.username || 'unknown',
            password: requestData.password || 'default123',
            role: 'staff',
            nrc: requestData.nrc || '',
            phone: requestData.phone || '',
            institution: requestData.institution || '',
            position: requestData.position || '',
            email: requestData.email || '',
            documents: requestData.documents || {},
            enabled: true,
            createdAt: new Date().toISOString(),
            lastActive: null
        };

        console.log('Creating user:', newUserAccount);

        await db.collection(COLLECTIONS.USERS).add(newUserAccount);

        await db.collection('account_requests').doc(requestId).update({
            status: 'approved',
            approvedAt: new Date().toISOString(),
            approvedBy: getCurrentUser()
        });

        await logAudit('ACCOUNT_APPROVED', {
            username: requestData.username,
            fullName: requestData.fullName,
            email: requestData.email,
            approvedBy: getCurrentUser()
        });

        showNotification(`Account for ${requestData.fullName || requestData.username} approved successfully`, 'success');

        const modal = document.getElementById('requestsManagementModal');
        if (modal) modal.remove();
        
        if (typeof openRequestsManagement === 'function') {
            openRequestsManagement();
        }

    } catch (error) {
        console.error('Error approving account:', error);
        alert('Failed to approve account: ' + error.message);
    }
}

async function submitAccountRejection(requestId) {
    const reason = document.getElementById('accountRejectReason')?.value.trim();
    
    if (!reason) {
        alert('Please provide a rejection reason');
        return;
    }
    
    try {
        const doc = await db.collection('account_requests').doc(requestId).get();
        if (!doc.exists) {
            alert('Request not found');
            return;
        }
        
        const requestData = doc.data();

        await db.collection('account_requests').doc(requestId).update({
            status: 'rejected',
            rejectedAt: new Date().toISOString(),
            rejectedBy: getCurrentUser(),
            rejectionReason: reason
        });

        await logAudit('ACCOUNT_REJECTED', {
            username: requestData.username,
            fullName: requestData.fullName,
            email: requestData.email,
            rejectedBy: getCurrentUser(),
            reason: reason
        });

        sendRejectionEmail(requestData.email, requestData.fullName, reason);

        closeRejectAccountModal();
        
        const modal = document.getElementById('requestsManagementModal');
        if (modal) modal.remove();
        
        openRequestsManagement();
        
        showNotification(`Account request for ${requestData.fullName} rejected`, 'info');
        
    } catch (error) {
        console.error('Error rejecting account:', error);
        alert('Failed to reject account: ' + error.message);
    }
}

function sendApprovalEmail(email, fullName, username) {
    console.log(`[EMAIL] Account approved for ${fullName} (${username}) at ${email}`);
    
    const subject = "Your Zed Supplier Directory Account Has Been Approved";
    const body = `Dear ${fullName},

Your account request for the Zed Supplier Directory has been APPROVED!

Login Details:
- Username: ${username}
- Role: Staff

You can now login to the system using your credentials.

Thank you for joining Zed Supplier Directory.

Best regards,
ZAMCOM Procurement Team`;
}

function sendRejectionEmail(email, fullName, reason) {
    console.log(`[EMAIL] Account rejected for ${fullName} at ${email}. Reason: ${reason}`);
    const subject = "Your Zed Supplier Directory Account Request";
    const body = `Dear ${fullName},

Your account request for the Zed Supplier Directory has been REJECTED.

Reason for rejection:
${reason}

If you believe this is an error, please contact the system administrator.

Best regards,
ZAMCOM Procurement Team`;
}

    window.showPendingTab = function() {
        const pending = document.getElementById('pendingSection');
        const history = document.getElementById('historySection');
        const pendingBtn = document.getElementById('pendingTabBtn');
        const historyBtn = document.getElementById('historyTabBtn');
        
        if (pending && history) {
            pending.style.display = 'block';
            history.style.display = 'none';
            pendingBtn.style.background = '#e67e22';
            historyBtn.style.background = '#34495e';
        }
    };

    window.showHistoryTab = function() {
        const pending = document.getElementById('pendingSection');
        const history = document.getElementById('historySection');
        const pendingBtn = document.getElementById('pendingTabBtn');
        const historyBtn = document.getElementById('historyTabBtn');
        
        if (pending && history) {
            pending.style.display = 'none';
            history.style.display = 'block';
            pendingBtn.style.background = '#34495e';
            historyBtn.style.background = '#e67e22';
        }
    };

    function openAccountRequestModal() {
    document.getElementById('requestFullName').value = '';
    document.getElementById('requestUsername').value = '';
    document.getElementById('requestNrc').value = '';
    document.getElementById('requestPhone').value = '';
    document.getElementById('requestInstitution').value = '';
    document.getElementById('requestPosition').value = '';
    document.getElementById('requestEmail').value = '';
    document.getElementById('requestPassword').value = '';
    
    ['requestNrcDocPreview', 'requestDegreeDocPreview', 'requestZipsDocPreview'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
    });
    
    requestDocuments = { nrc: null, degree: null, zips: null };
    
    const modal = document.getElementById('accountRequestModal');
    modal.style.display = 'flex';
    document.getElementById('loginOverlay').style.display = 'none';
}

function closeAccountRequestModal() {
    document.getElementById('accountRequestModal').style.display = 'none';
    document.getElementById('loginOverlay').style.display = 'flex';
}

let activePulses = {};

function showPulse(buttonId) {
    console.log(`Showing pulse for: ${buttonId}`);
    hidePulse(buttonId);
    
    const button = document.getElementById(buttonId);
    if (!button) {
        console.log(`Button ${buttonId} not found`);
        return;
    }
    
    const rect = button.getBoundingClientRect();
    const pulse = document.createElement('div');
    pulse.id = `pulse-${buttonId}`;
    pulse.className = 'pulse-dot';
    pulse.style.left = (rect.right - 15) + 'px';
    pulse.style.top = (rect.top + 5) + 'px';
    pulse.style.position = 'fixed';
    
    document.body.appendChild(pulse);
    activePulses[buttonId] = pulse;
    
    console.log(`Pulse added for ${buttonId} at position:`, rect.right, rect.top);
}

function hidePulse(buttonId) {
    if (activePulses[buttonId]) {
        activePulses[buttonId].remove();
        delete activePulses[buttonId];
        console.log(`Pulse removed for ${buttonId}`);
    }
}

function hideAllPulses() {
    Object.keys(activePulses).forEach(buttonId => {
        hidePulse(buttonId);
    });
}

function updatePulses() {
    console.log("Updating pulses...");
    
    const currentUser = getUser(getCurrentUser());
    if (!currentUser) return;
    
    hideAllPulses();
    
    if (currentUser.role === 'super admin' && approvalRequests.length > 0) {
        showPulse('requestsManagementBtn');
    }
    
    if (currentUser.role !== 'super admin') {
        const userPendingRequests = approvalRequests.filter(req => 
            req.requestedBy === currentUser.username
        ).length;
        
        if (userPendingRequests > 0) {
            showPulse('approvalHistoryNavBtn');
        }
    }
    
    if (canApproveRequests()) {
        let visibleRequests = approvalRequests;
        if (currentUser.role === 'admin') {
            visibleRequests = approvalRequests.filter(req => 
                req.requestedByRole === 'staff' || req.requestedByRole === 'admin'
            );
        }
        
        if (visibleRequests.length > 0) {
            showPulse('approvalRequestsNavBtn');
        }
    }
}

    function closeRequestsManagement() {
        const modal = document.getElementById('requestsManagementModal');
        if (modal) modal.remove();
    }

    function openRejectReasonModalForRequest(requestId) {
    document.getElementById('pendingRejectRequestId').value = requestId;
    localStorage.setItem('currentApprovalRequestId', requestId);
    document.getElementById('rejectReasonText').value = '';
    document.getElementById('rejectReasonModal').style.display = 'flex';
}

    function openRejectReasonModal() {
    document.getElementById('rejectReasonText').value = '';
    document.getElementById('rejectReasonModal').style.display = 'flex';
}

    function closeRejectReasonModal() {
        document.getElementById('rejectReasonModal').style.display = 'none';
        document.getElementById('pendingRejectRequestId').value = '';
        document.getElementById('rejectReasonText').value = '';
    }

    async function submitRejectionReason() {
    const requestId = document.getElementById('pendingRejectRequestId').value || localStorage.getItem('currentApprovalRequestId');
    const reason = document.getElementById('rejectReasonText').value.trim();
    
    if (!reason) {
        alert('Please provide a reason for rejection');
        return;
    }

    try {
        const requestDoc = await db.collection(COLLECTIONS.APPROVALS).doc(requestId).get();
        if (!requestDoc.exists) {
            alert('Request not found');
            return;
        }
        
        const requestData = requestDoc.data();
        const docRef = db.collection(COLLECTIONS.APPROVALS).doc(requestId);
        await docRef.update({
            status: 'rejected',
            reviewedBy: getCurrentUser(),
            reviewedAt: new Date().toISOString(),
            rejectionReason: reason,
            rejectionDate: new Date().toISOString()
        });

await logAudit('APPROVAL_REJECTED', {
    requestId: requestId,
    action: requestData.action || 'unknown',
    type: requestData.type || 'unknown',
    itemName: requestData.itemName || 
              requestData.requestedData?.name || 
              requestData.oldData?.name || 
              (requestData.type === 'user' ? requestData.requestedData?.fullName : 'Unknown'),
    requestedBy: requestData.requestedBy || 'Unknown',
    requestedByFullName: requestData.requestedByFullName || requestData.requestedBy || 'Unknown',
    reason: reason,
    reviewedBy: getCurrentUser()
});

        showNotification('Request rejected successfully', 'success');
        closeRejectReasonModal();
        document.getElementById('approvalActionModal').style.display = 'none';
        
        
        const modal = document.getElementById('requestsManagementModal');
        if (modal) modal.remove();
        
        await loadAllData(true);
        await loadApprovalRequests();
        
        const currentUser = getUser(getCurrentUser());
        if (currentUser && currentUser.role !== 'super admin') {
            await loadUserApprovalHistory();
        }
        
        renderCategories();
        applyRoleBasedUI();

        setTimeout(() => {
            loadApprovalRequests();
            updateRequestCounts();
        }, 500);

    } catch (error) {
        console.error('Error rejecting request:', error);
        alert('Failed to reject request: ' + error.message);
    }
}

    function renderUserManagementTable() {
    const tbody = document.getElementById('userMgmtTableBody');
    const currentUser = getUser(getCurrentUser());
    
    if (!currentUser) return;

    let html = '';

    for (let u of userAccounts) {
        if (currentUser.role === 'staff' && u.role !== 'staff') continue;
        if (currentUser.role === 'admin' && u.role === 'super admin') continue;

        const status = u.enabled ? 
            '<span style="color:green; font-weight:bold;">Enabled</span>' : 
            '<span style="color:red; font-weight:bold;">Disabled</span>';

        const canEdit = (currentUser.role === 'super admin') ? true : 
                       (currentUser.role === 'admin' && u.role !== 'super admin') ? true :
                       (currentUser.role === 'staff' && currentUser.id === u.id) ? true : false;

        const canDelete = (isJoseph(u.username)) ? false : 
                         (currentUser.role === 'super admin') ? true : 
                         (currentUser.role === 'admin' && u.role === 'staff') ? true : 
                         (currentUser.role === 'staff' && currentUser.id === u.id) ? true : false;

        let displayPhone = u.phone || '';
        let displayInfo = '';

        if (currentUser.role === 'super admin') {
            displayInfo = `
                <div style="font-size: 11px; color: #666;">
                    ${u.email || ''}<br>
                    NRC: ${u.nrc || ''}
                </div>
            `;
        } else {
            displayInfo = `
                <div style="font-size: 11px; color: #999;">
                    ********
                </div>
            `;
        }

        const docThumbnail = createDocumentThumbnail(u.documents, 'user', u.id, u.fullName || u.username);

        html += `
            <tr>
                <td>
                    <div style="font-weight: 600;">${u.fullName || u.username}</div>
                    <div style="font-size: 11px; color: #666;">@${u.username}</div>
                    ${isJoseph(u.username) ? '<span style="color: #f39c12; font-size: 10px;">🔒 Protected</span>' : ''}
                </td>
                <td>
                    <span class="role-badge" style="background: ${
                        u.role === 'super admin' ? '#9b59b6' : 
                        u.role === 'admin' ? '#3498db' : '#2ecc71'
                    }">
                        ${u.role}
                    </span>
                </td>
                <td>${displayPhone}</td>
                <td>
                    ${displayInfo}
                </td>
                <td>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        ${status}
                        ${docThumbnail}
                    </div>
                </td>
                <td>
                    <div class="action-buttons">
                        ${canEdit ? 
                            `<button class="btn-edit" onclick="openEditUserModal('${u.id}')">
                                <span>✏️</span> Edit
                            </button>` : ''
                        }
                        ${canDelete ? 
                            `<button class="btn-del" onclick="deleteUser('${u.id}')">
                                <span>🗑️</span> Delete
                            </button>` : ''
                        }
                    </div>
                </td>
            </tr>
        `;
    }

    tbody.innerHTML = html;
}

    function renderUserApprovalHistory(requests, filter) {
        const container = document.getElementById('userApprovalHistoryContainer');
        
        if (requests.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">📭</div>
                    <div style="font-size: 18px; font-weight: 500;">
                        ${filter === 'pending' ? 'No pending requests' : 'No request history'}
                    </div>
                </div>
            `;
            return;
        }

        let html = '';
        requests.forEach(req => {
            const created = req.createdAt ? 
                (req.createdAt.toDate ? req.createdAt.toDate().toLocaleString() : new Date(req.createdAt).toLocaleString()) 
                : 'Unknown';
            
            const status = req.status || 'pending';
            const statusColor = status === 'approved' ? '#2ecc71' : 
                              status === 'rejected' ? '#e74c3c' : '#f39c12';
            const statusBg = status === 'approved' ? '#e8f8f5' : 
                            status === 'rejected' ? '#fee9e7' : '#fef5e7';
            
            const actionColor = req.action === 'delete' ? '#e74c3c' : 
                              req.action === 'edit' ? '#f39c12' : '#3498db';
            
            const submissionReason = req.reason || '';
            const rejectionReason = req.rejectionReason || '';
            const reviewedBy = req.reviewedBy || 'System';
            const reviewedAt = req.reviewedAt ? new Date(req.reviewedAt).toLocaleString() : '';
            
            let changeSummaryHtml = '';
            if (req.changeSummary && req.changeSummary.length > 0 && status !== 'pending') {
                changeSummaryHtml = `
                    <div style="margin-top: 12px; background: #f8f9fa; padding: 12px; border-radius: 8px;">
                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px; font-size: 12px;">📋 CHANGES THAT WERE APPLIED:</div>
                        ${req.changeSummary.map(change => {
                            if (change.type === 'object' && change.nestedChanges) {
                                return `
                                    <div style="margin-bottom: 8px;">
                                        <span style="font-weight: bold; color: #e67e22;">${change.field}:</span>
                                        ${change.nestedChanges.map(n => `
                                            <div style="margin-left: 15px; font-size: 11px;">
                                                ${n.field}: <span style="color: #e74c3c;">${n.oldValue}</span> → <span style="color: #27ae60;">${n.newValue}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;
                            } else {
                                return `
                                    <div style="margin-bottom: 5px; font-size: 11px;">
                                        <span style="font-weight: bold;">${change.field}:</span> 
                                        <span style="color: #e74c3c;">${change.oldValue}</span> → 
                                        <span style="color: #27ae60;">${change.newValue}</span>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                `;
            }
            
            html += `
                <div style="background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid #e0e0e0; border-left: 6px solid ${actionColor};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <span style="background: ${statusColor}; color: white; padding: 6px 16px; border-radius: 30px; font-size: 12px; font-weight: 700; display: inline-block;">
                                ${status.toUpperCase()}
                            </span>
                            <span style="margin-left: 12px; font-weight: 600; color: #2c3e50; background: ${statusBg}; padding: 6px 16px; border-radius: 30px; display: inline-block;">
                                ${req.action?.toUpperCase()} - ${req.type?.toUpperCase()}
                            </span>
                        </div>
                        <span style="color: #888; font-size: 12px; background: #f8f9fa; padding: 4px 12px; border-radius: 20px;">${created}</span>
                    </div>
                    
                    <div style="margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 12px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">📦 ITEM</div>
                                <div style="font-weight: 600;">${req.requestedData?.name || req.oldData?.name || req.itemId || 'N/A'}</div>
                                <div style="font-size: 11px; color: #999; margin-top: 4px;">ID: ${req.itemId?.substring(0, 8) || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">👤 REQUESTED BY</div>
                                <div style="font-weight: 600;">${req.requestedBy || 'Unknown'}</div>
                                <span class="role-badge" style="background: ${req.requestedByRole === 'super admin' ? '#9b59b6' : req.requestedByRole === 'admin' ? '#3498db' : '#2ecc71'}; padding: 2px 8px; border-radius: 12px; color: white; display: inline-block; margin-top: 4px;">
                                    ${req.requestedByRole || 'staff'}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    ${submissionReason && status === 'pending' ? `
                    <div style="background: #fef5e7; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #f39c12;">
                        <span style="font-weight: 600; color: #f39c12;">📝 REASON PROVIDED:</span>
                        <p style="margin: 5px 0 0 0; color: #333; font-size: 13px;">${submissionReason}</p>
                    </div>
                    ` : ''}
                    
                    ${status === 'rejected' && rejectionReason ? `
                    <div style="background: #fee9e7; padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #e74c3c;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="background: #e74c3c; color: white; padding: 4px 12px; border-radius: 30px; font-size: 11px; font-weight: 700;">✗ REJECTION REASON</span>
                            <span style="font-size: 11px; color: #666;">By ${reviewedBy}</span>
                        </div>
                        <p style="margin: 0; color: #2c3e50; font-size: 14px; font-weight: 500;">${rejectionReason}</p>
                        ${reviewedAt ? `<div style="margin-top: 8px; font-size: 11px; color: #999;">Rejected on: ${reviewedAt}</div>` : ''}
                    </div>
                    ` : ''}
                    
                    ${status === 'approved' && reviewedBy ? `
                    <div style="background: #e8f8f5; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #2ecc71;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: #2ecc71; color: white; padding: 4px 12px; border-radius: 30px; font-size: 11px; font-weight: 700;">✓ APPROVED</span>
                            <span style="font-size: 11px; color: #666;">By ${reviewedBy}</span>
                        </div>
                        ${reviewedAt ? `<div style="margin-top: 8px; font-size: 11px; color: #999;">Approved on: ${reviewedAt}</div>` : ''}
                    </div>
                    ` : ''}
                    
                    ${changeSummaryHtml}
                    
                    ${status === 'pending' ? `
                    <div style="margin-top: 12px; font-size: 12px; color: #e67e22; background: #fef5e7; padding: 10px 15px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">⏳</span>
                        <span>This request is awaiting approval</span>
                    </div>
                    ` : ''}
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    function renderRequestsManagementHistory(requests) {
        let historyHtml = '';
        if (requests.length === 0) {
            historyHtml = `
                <div style="text-align: center; padding: 60px; background: white; border-radius: 20px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">📭</div>
                    <div style="font-size: 18px; font-weight: 500;">No request history</div>
                </div>
            `;
        } else {
            requests.slice(0, 20).forEach(req => {
                const created = req.createdAt ? 
                    (req.createdAt.toDate ? req.createdAt.toDate().toLocaleString() : new Date(req.createdAt).toLocaleString()) 
                    : 'Unknown';
                const statusColor = req.status === 'approved' ? '#2ecc71' : '#e74c3c';
                const statusBg = req.status === 'approved' ? '#e8f8f0' : '#fee9e7';
                
                const displayReason = req.status === 'rejected' ? 
                    (req.rejectionReason || req.reason || 'No reason provided') : 
                    (req.reason || 'No reason provided');
                
                const reviewedBy = req.reviewedBy || 'System';
                const reviewedAt = req.reviewedAt ? new Date(req.reviewedAt).toLocaleString() : '';
                
                historyHtml += `
                    <div style="background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid #f0f0f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <div style="background: ${statusBg}; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 16px; font-size: 24px;">
                                    ${req.status === 'approved' ? '✓' : '✗'}
                                </div>
                                <div>
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="background: ${statusColor}; color: white; padding: 4px 14px; border-radius: 30px; font-size: 12px; font-weight: 700;">
                                            ${req.status.toUpperCase()}
                                        </span>
                                        <span style="color: #666; font-size: 12px;">${req.action?.toUpperCase()} · ${req.type?.toUpperCase()}</span>
                                    </div>
                                    <div style="display: flex; gap: 20px; font-size: 13px;">
                                        <span style="color: #555;">👤 Requested: ${req.requestedBy}</span>
                                        <span style="color: #555;">✓ Reviewed: ${reviewedBy}</span>
                                    </div>
                                </div>
                            </div>
                            <div style="color: #888; font-size: 12px; background: #f8f9fa; padding: 4px 12px; border-radius: 20px;">
                                ${created}
                            </div>
                        </div>
                        
                        ${req.status === 'rejected' ? `
                        <div style="background: #fee9e7; padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #e74c3c;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                <span style="background: #e74c3c; color: white; padding: 2px 12px; border-radius: 30px; font-size: 11px; font-weight: 700;">✗ REJECTION REASON</span>
                                <span style="font-size: 11px; color: #666;">By ${reviewedBy} ${reviewedAt ? 'on ' + reviewedAt : ''}</span>
                            </div>
                            <p style="margin: 8px 0 0 0; color: #2c3e50; font-size: 14px; font-weight: 500;">${displayReason}</p>
                        </div>
                        ` : req.status === 'approved' ? `
                        <div style="background: #e8f8f5; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #2ecc71;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="background: #2ecc71; color: white; padding: 2px 12px; border-radius: 30px; font-size: 11px; font-weight: 700;">✓ APPROVED</span>
                                <span style="font-size: 11px; color: #666;">By ${reviewedBy} ${reviewedAt ? 'on ' + reviewedAt : ''}</span>
                            </div>
                            ${req.reason ? `
                            <p style="margin: 8px 0 0 0; color: #666; font-size: 13px; background: white; padding: 8px; border-radius: 4px;">
                                <strong>Reason provided:</strong> ${req.reason}
                            </p>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        ${req.changeSummary && req.changeSummary.length > 0 ? `
                        <div style="margin-top: 12px; background: #f8f9fa; padding: 12px; border-radius: 8px;">
                            <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">📋 Changes:</div>
                            ${req.changeSummary.map(change => `
                                <div style="font-size: 12px; margin-bottom: 3px;">
                                    ${change.field}: <span style="color: #e74c3c;">${change.oldValue}</span> → <span style="color: #27ae60;">${change.newValue}</span>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                `;
            });
        }
        
        return historyHtml;
    }

    async function openUserApprovalHistory() {
        const currentUser = getUser(getCurrentUser());
        if (currentUser && currentUser.role === 'super admin') {
            showNotification('Super admin: Please use Requests Management to view all requests', 'info');
            openRequestsManagement();
            return;
        }
        
        showView('userApprovalHistory');
        await loadUserApprovalHistory('pending');
    }

    async function loadUserApprovalHistory(filter = 'pending') {
        const currentUser = getCurrentUser();
        if (!currentUser) return;
        const container = document.getElementById('userApprovalHistoryContainer');
        if (!container) return;
        
        try {
            console.log(`Loading ${filter} requests for user: ${currentUser}`);
            const snapshot = await db.collection(COLLECTIONS.APPROVALS)
                .where('requestedBy', '==', currentUser)
                .get();
            
            console.log(`Found ${snapshot.docs.length} total requests for user`);
            
            let userRequests = snapshot.docs.map(doc => ({ 
                id: doc.id, 
                ...doc.data() 
            }));
            
            if (filter === 'pending') {
                userRequests = userRequests.filter(req => req.status === 'pending');
            } else {
                userRequests = userRequests.filter(req => 
                    req.status === 'approved' || req.status === 'rejected'
                );
            }
            
            userRequests.sort((a, b) => {
                const dateA = a.createdAt?.toDate?.() || new Date(a.createdAt || 0);
                const dateB = b.createdAt?.toDate?.() || new Date(b.createdAt || 0);
                return dateB - dateA;
            });
            
            renderUserApprovalHistory(userRequests, filter);
            
        } catch (error) {
            console.error('Error loading user approval history:', error);
            container.innerHTML = `
                <div style="text-align: center; padding: 60px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">❌</div>
                    <div style="font-size: 18px; font-weight: 500;">Failed to load requests</div>
                    <div style="font-size: 14px; color: #999; margin-top: 10px;">${error.message}</div>
                    <button onclick="loadUserApprovalHistory('${filter}')" class="btn" style="margin-top: 20px; background: var(--primary-green);">Retry</button>
                    <p style="margin-top: 20px; font-size: 12px; color: #f39c12;">
                        ⚠️ Please contact super admin to create the required Firestore indexes.
                    </p>
                </div>
            `;
        }
    }

    function renderUserApprovalHistory(requests, filter) {
        const container = document.getElementById('userApprovalHistoryContainer');
        
        if (requests.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">📭</div>
                    <div style="font-size: 18px; font-weight: 500;">
                        ${filter === 'pending' ? 'No pending requests' : 'No request history'}
                    </div>
                </div>
            `;
            return;
        }

        let html = '';
        requests.forEach(req => {
            const created = req.createdAt ? 
                (req.createdAt.toDate ? req.createdAt.toDate().toLocaleString() : new Date(req.createdAt).toLocaleString()) 
                : 'Unknown';
            const actionColor = req.action === 'delete' ? '#e74c3c' : 
                              req.action === 'edit' ? '#f39c12' : '#3498db';
            const statusColor = req.status === 'approved' ? '#2ecc71' : 
                              req.status === 'rejected' ? '#e74c3c' : '#f39c12';
            const rejectionReason = req.rejectionReason || '';
            
            html += `
                <div style="background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid #e0e0e0; border-left: 6px solid ${actionColor};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 30px; font-size: 12px; font-weight: 700;">
                                ${req.status?.toUpperCase() || 'PENDING'}
                            </span>
                            <span style="margin-left: 12px; font-weight: 600; color: #2c3e50;">
                                ${req.action?.toUpperCase()} - ${req.type?.toUpperCase()}
                            </span>
                        </div>
                        <span style="color: #888; font-size: 12px;">${created}</span>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <span style="font-weight: 600; color: #555;">Item:</span>
                        <span style="color: #333; margin-left: 8px;">${req.requestedData?.name || req.requestedData?.fullName || req.itemId || 'N/A'}</span>
                    </div>
                    
                    ${req.reason ? `
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <span style="font-weight: 600; color: #f39c12;">Reason provided:</span>
                        <span style="color: #333; margin-left: 8px;">${req.reason}</span>
                    </div>
                    ` : ''}
                    
                    ${req.status === 'rejected' && req.rejectionReason ? `
                    <div style="background: #fee9e7; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #e74c3c;">
                        <span style="font-weight: 600; color: #e74c3c;">Rejection reason:</span>
                        <span style="color: #333; margin-left: 8px;">${req.rejectionReason}</span>
                    </div>
                    ` : ''}
                    
                    ${req.reviewedBy ? `
                    <div style="font-size: 12px; color: #666; border-top: 1px solid #eee; padding-top: 12px;">
                        Reviewed by: ${req.reviewedBy} on ${req.reviewedAt ? new Date(req.reviewedAt).toLocaleString() : 'N/A'}
                    </div>
                    ` : ''}
                    
                    ${req.status === 'pending' ? `
                    <div style="margin-top: 12px; font-size: 12px; color: #e67e22; background: #fef5e7; padding: 8px 12px; border-radius: 8px;">
                        ⏳ This request is awaiting approval
                    </div>
                    ` : ''}
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    function switchApprovalHistoryTab(tab) {
        document.getElementById('historyPendingTab').classList.toggle('active', tab === 'pending');
        document.getElementById('historyHistoryTab').classList.toggle('active', tab === 'history');
        loadUserApprovalHistory(tab);
    }

    let currentAuditPage = 1;
    let auditLogsPerPage = 20;
    let totalAuditPages = 1;

    const bgImages = [
        './images/bgx.jpg',
        './images/bg.jpg',
        './images/bgx1.jpg'
    ];

    const LOCK_TIME = { hr: 16, min: 50 };
    const OPEN_TIME = { hr: 7, min: 30 };
    const COLLECTIONS = {
        USERS: 'users',
        CATEGORIES: 'categories',
        SUPPLIERS: 'suppliers',
        LINKS: 'links',
        AUDIT_LOGS: 'audit_logs',
        SESSIONS: 'sessions',
        APPROVALS: 'approval_requests'
    };

    function getCurrentUser() { 
        return localStorage.getItem('logged_user') || null; 
    }
    
    function getUser(username) { 
        return userAccounts.find(u => u.username === username); 
    }
    
    function isCurrentUserSuperAdmin() { 
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin'; 
    }
    
    function isCurrentUserAdmin() { 
        const user = getUser(getCurrentUser());
        return user && (user.role === 'admin' || user.role === 'super admin'); 
    }
    
    function isCurrentUserStaff() { 
        const user = getUser(getCurrentUser());
        return user && user.role === 'staff'; 
    }
    
    function canWorkAfterLock() { 
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin'); 
    }

    function canAddUser() {
        const user = getUser(getCurrentUser());
        if (!user) return false;
        return user.role === 'super admin' || user.role === 'admin' || user.role === 'staff';
    }
    
    function canEditUser() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canDeleteUser() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canDeleteUserWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }
    
    function isJoseph(username) {
        return username === 'JOSEPH';
    }

    function canCreateCategory() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canCreateCategoryWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }
    
    function canEditCategory() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canEditCategoryWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }
    
    function canDeleteCategory() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canDeleteCategoryWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }

    function canCreateSupplier() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canCreateSupplierWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }
    
    function canEditSupplier() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canEditSupplierWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }
    
    function canDeleteSupplier() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canDeleteSupplierWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }

    function canCreateLink() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canCreateLinkWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }
    
    function canEditLink() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canEditLinkWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }
    
    function canDeleteLink() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canDeleteLinkWithoutApproval() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }

    function canViewAuditLogs() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }
    
    function canDeleteAuditLogs() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }

    function canViewSessions() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin' || user.role === 'staff');
    }

    function canApproveRequests() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }
    
    function canApproveAllRequests() {
        const user = getUser(getCurrentUser());
        return user && user.role === 'super admin';
    }

    function canAccessLockedSystem() {
        const user = getUser(getCurrentUser());
        return user && (user.role === 'super admin' || user.role === 'admin');
    }

    function isSystemLocked() {
        const now = new Date();
        const currentTotal = (now.getHours() * 60) + now.getMinutes();
        const lockTotal = (LOCK_TIME.hr * 60) + LOCK_TIME.min;
        const openTotal = (OPEN_TIME.hr * 60) + OPEN_TIME.min;
        return (currentTotal >= lockTotal || currentTotal < openTotal);
    }

    function showLockScreen() {
        const lockScreen = document.getElementById('systemLockScreen');
        if (lockScreen) {
            lockScreen.style.display = 'flex';
            startLockCountdown();
        }
    }

    function hideLockScreen() {
        const lockScreen = document.getElementById('systemLockScreen');
        if (lockScreen) {
            lockScreen.style.display = 'none';
            if (lockScreenInterval) {
                clearInterval(lockScreenInterval);
                lockScreenInterval = null;
            }
        }
    }

    function startLockCountdown() {
        if (lockScreenInterval) {
            clearInterval(lockScreenInterval);
        }
        
        updateLockDisplay();
        lockScreenInterval = setInterval(updateLockDisplay, 1000);
    }

    function updateLockDisplay() {
        const now = new Date();
        const openTime = new Date(now);
        openTime.setHours(OPEN_TIME.hr, OPEN_TIME.min, 0, 0);
        
        if (now.getHours() >= LOCK_TIME.hr) {
            openTime.setDate(openTime.getDate() + 1);
        }
        
        const timeUntilUnlock = openTime - now;
        
        if (timeUntilUnlock <= 0) {
            hideLockScreen();
            return;
        }
        
        const hours = Math.floor(timeUntilUnlock / (1000 * 60 * 60));
        const minutes = Math.floor((timeUntilUnlock % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeUntilUnlock % (1000 * 60)) / 1000);
        
        const countdownEl = document.getElementById('lockCountdown');
        if (countdownEl) {
            countdownEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        const totalLockHours = 24 - (LOCK_TIME.hr - OPEN_TIME.hr);
        const totalLockMs = totalLockHours * 60 * 60 * 1000;
        const progress = ((totalLockMs - timeUntilUnlock) / totalLockMs) * 100;
        
        const progressBar = document.getElementById('lockProgress');
        if (progressBar) {
            progressBar.style.width = `${progress}%`;
        }
        
        const unlockTimeEl = document.getElementById('unlockTimeDisplay');
        if (unlockTimeEl) {
            const unlockHour = openTime.getHours().toString().padStart(2, '0');
            const unlockMin = openTime.getMinutes().toString().padStart(2, '0');
            unlockTimeEl.textContent = `Next unlock: ${unlockHour}:${unlockMin}:00`;
        }
    }

    function backToLoginFromLock() {
        hideLockScreen();
        document.getElementById('loginOverlay').style.display = 'flex';
        localStorage.removeItem('logged_user');
        localStorage.removeItem('last_login');
    }

async function logAudit(action, details = {}) {
    try {
        const currentUser = getCurrentUser() || 'SYSTEM';
        const user = getUser(currentUser);
        const userFullName = user?.fullName || currentUser;
    
        let readableMessage = '';
        let changeDetails = [];
        
        switch(action) {
            case 'CREATE_USER':
                readableMessage = `${userFullName} added a new user`;
                if (details.fullName) readableMessage += `: ${details.fullName}`;
                if (details.username) readableMessage += ` (${details.username})`;
                if (details.role) readableMessage += ` as ${details.role}`;
                changeDetails.push(`Created by: ${userFullName}`);
                changeDetails.push(`New user: ${details.fullName || details.username}`);
                changeDetails.push(`Role: ${details.role || 'staff'}`);
                if (details.email) changeDetails.push(`Email: ${details.email}`);
                if (details.phone) changeDetails.push(`Phone: ${details.phone}`);
                if (details.institution) changeDetails.push(`Institution: ${details.institution}`);
                if (details.position) changeDetails.push(`Position: ${details.position}`);
                break;
                
            case 'EDIT_USER':
                readableMessage = `${userFullName} updated user`;
                if (details.fullName) readableMessage += ` ${details.fullName}`;
                if (details.username) readableMessage += ` ${details.username}`;
                
                if (details.changes) {
                    const changes = [];
                    if (details.changes.fullName) {
                        changes.push(`name: "${details.changes.fullName.old || 'not set'}" → "${details.changes.fullName.new}"`);
                        changeDetails.push(`Full Name: ${details.changes.fullName.old || 'not set'} → ${details.changes.fullName.new}`);
                    }
                    if (details.changes.role) {
                        changes.push(`role: "${details.changes.role.old || 'not set'}" → "${details.changes.role.new}"`);
                        changeDetails.push(`Role: ${details.changes.role.old || 'not set'} → ${details.changes.role.new}`);
                    }
                    if (details.changes.email) {
                        changes.push(`email: "${details.changes.email.old || 'not set'}" → "${details.changes.email.new}"`);
                        changeDetails.push(`Email: ${details.changes.email.old || 'not set'} → ${details.changes.email.new}`);
                    }
                    if (details.changes.phone) {
                        changes.push(`phone: "${details.changes.phone.old || 'not set'}" → "${details.changes.phone.new}"`);
                        changeDetails.push(`Phone: ${details.changes.phone.old || 'not set'} → ${details.changes.phone.new}`);
                    }
                    if (details.changes.nrc) {
                        changes.push(`NRC: updated`);
                        changeDetails.push(`NRC: ${details.changes.nrc.old || 'not set'} → ${details.changes.nrc.new || 'not set'}`);
                    }
                    if (details.changes.institution) {
                        changes.push(`institution: "${details.changes.institution.old || 'not set'}" → "${details.changes.institution.new || 'not set'}"`);
                        changeDetails.push(`Institution: ${details.changes.institution.old || 'not set'} → ${details.changes.institution.new || 'not set'}`);
                    }
                    if (details.changes.position) {
                        changes.push(`position: "${details.changes.position.old || 'not set'}" → "${details.changes.position.new || 'not set'}"`);
                        changeDetails.push(`Position: ${details.changes.position.old || 'not set'} → ${details.changes.position.new || 'not set'}`);
                    }
                    if (details.changes.enabled !== undefined) {
                        const oldStatus = details.changes.enabled.old ? 'Enabled' : 'Disabled';
                        const newStatus = details.changes.enabled.new ? 'Enabled' : 'Disabled';
                        changes.push(`account status: ${oldStatus} → ${newStatus}`);
                        changeDetails.push(`Account Status: ${oldStatus} → ${newStatus}`);
                    }
                    
                    if (changes.length > 0) {
                        readableMessage += ` — ${changes.join('; ')}`;
                    }
                }
                break;
                
            case 'DELETE_USER':
                readableMessage = `${userFullName} deleted user`;
                if (details.fullName) readableMessage += ` ${details.fullName}`;
                if (details.username) readableMessage += ` (${details.username})`;
                changeDetails.push(`Deleted by: ${userFullName}`);
                changeDetails.push(`User: ${details.fullName || details.username}`);
                if (details.role) changeDetails.push(`Role: ${details.role}`);
                break;
            
            case 'CREATE_SUPPLIER':
                readableMessage = `${userFullName} added a new supplier: "${details.name}"`;
                if (details.category) readableMessage += ` in ${details.category}`;
                
                changeDetails.push(`Created by: ${userFullName}`);
                changeDetails.push(`Supplier: ${details.name}`);
                changeDetails.push(`Category: ${details.category || 'Not specified'}`);
                changeDetails.push(`Specialization: ${details.specialization || 'Not specified'}`);
                changeDetails.push(`Phone: ${details.phone || 'Not specified'}`);
                changeDetails.push(`TPIN: ${details.tpin || 'Not specified'}`);
                changeDetails.push(`Email: ${details.email || 'Not specified'}`);
                changeDetails.push(`Address: ${details.address || 'Not specified'}`);
                changeDetails.push(`Rating: ${details.rating || 0}★`);
                
                if (details.compliance) {
                    changeDetails.push(`Compliance - TPIN: ${details.compliance.tpin === 'yes' ? '✓ Compliant' : '✗ Not Compliant'}`);
                    changeDetails.push(`Compliance - NAPSA: ${details.compliance.napsa === 'yes' ? '✓ Compliant' : '✗ Not Compliant'}`);
                    changeDetails.push(`Compliance - ZRA: ${details.compliance.zra === 'yes' ? '✓ Compliant' : '✗ Not Compliant'}`);
                    changeDetails.push(`Compliance - ZPPA: ${details.compliance.zppa === 'yes' ? '✓ Compliant' : '✗ Not Compliant'}`);
                    changeDetails.push(`Compliance - E-Gp: ${details.compliance.egp === 'yes' ? '✓ Active' : '✗ Not Active'}`);
                }
                
                if (details.renewalDate) {
                    changeDetails.push(`Renewal Date: ${new Date(details.renewalDate).toLocaleDateString()}`);
                }
                break;
                
            case 'UPDATE_SUPPLIER':
                readableMessage = `${userFullName} updated supplier: "${details.name}"`;
                
                if (details.changes && details.changes.length > 0) {
                    const changeStrings = [];
                    
                    details.changes.forEach(change => {
                        if (change.field === 'name') {
                            changeStrings.push(`name from "${change.oldValue}" to "${change.newValue}"`);
                            changeDetails.push(`Name: ${change.oldValue} → ${change.newValue}`);
                        }
                        else if (change.field === 'specialization') {
                            changeStrings.push(`specialization from "${change.oldValue}" to "${change.newValue}"`);
                            changeDetails.push(`Specialization: ${change.oldValue} → ${change.newValue}`);
                        }
                        else if (change.field === 'phone') {
                            changeStrings.push(`phone from "${change.oldValue}" to "${change.newValue}"`);
                            changeDetails.push(`Phone: ${change.oldValue} → ${change.newValue}`);
                        }
                        else if (change.field === 'tpin') {
                            changeStrings.push(`TPIN from "${change.oldValue}" to "${change.newValue}"`);
                            changeDetails.push(`TPIN: ${change.oldValue} → ${change.newValue}`);
                        }
                        else if (change.field === 'email') {
                            changeStrings.push(`email from "${change.oldValue}" to "${change.newValue}"`);
                            changeDetails.push(`Email: ${change.oldValue} → ${change.newValue}`);
                        }
                        else if (change.field === 'address') {
                            changeStrings.push(`address updated`);
                            changeDetails.push(`Address: ${change.oldValue} → ${change.newValue}`);
                        }
                        else if (change.field === 'rating') {
                            changeStrings.push(`rating from ${change.oldValue}★ to ${change.newValue}★`);
                            changeDetails.push(`Rating: ${change.oldValue}★ → ${change.newValue}★`);
                        }
                        else if (change.field === 'category') {
                            changeStrings.push(`category from "${change.oldValue}" to "${change.newValue}"`);
                            changeDetails.push(`Category: ${change.oldValue} → ${change.newValue}`);
                        }
                        else if (change.field === 'renewalDate') {
                            changeStrings.push(`renewal date updated`);
                            changeDetails.push(`Renewal Date: ${change.oldValue} → ${change.newValue}`);
                        }
                        else if (change.field === 'compliance.tpin') {
                            const oldStatus = change.oldValue === 'yes' ? 'Compliant' : 'Not Compliant';
                            const newStatus = change.newValue === 'yes' ? 'Compliant' : 'Not Compliant';
                            changeStrings.push(`TPIN compliance from ${oldStatus} to ${newStatus}`);
                            changeDetails.push(`TPIN Compliance: ${oldStatus} → ${newStatus}`);
                        }
                        else if (change.field === 'compliance.napsa') {
                            const oldStatus = change.oldValue === 'yes' ? 'Compliant' : 'Not Compliant';
                            const newStatus = change.newValue === 'yes' ? 'Compliant' : 'Not Compliant';
                            changeStrings.push(`NAPSA compliance from ${oldStatus} to ${newStatus}`);
                            changeDetails.push(`NAPSA Compliance: ${oldStatus} → ${newStatus}`);
                        }
                        else if (change.field === 'compliance.zra') {
                            const oldStatus = change.oldValue === 'yes' ? 'Compliant' : 'Not Compliant';
                            const newStatus = change.newValue === 'yes' ? 'Compliant' : 'Not Compliant';
                            changeStrings.push(`ZRA compliance from ${oldStatus} to ${newStatus}`);
                            changeDetails.push(`ZRA Compliance: ${oldStatus} → ${newStatus}`);
                        }
                        else if (change.field === 'compliance.zppa') {
                            const oldStatus = change.oldValue === 'yes' ? 'Compliant' : 'Not Compliant';
                            const newStatus = change.newValue === 'yes' ? 'Compliant' : 'Not Compliant';
                            changeStrings.push(`ZPPA compliance from ${oldStatus} to ${newStatus}`);
                            changeDetails.push(`ZPPA Compliance: ${oldStatus} → ${newStatus}`);
                        }
                        else if (change.field === 'compliance.egp') {
                            const oldStatus = change.oldValue === 'yes' ? 'Active' : 'Not Active';
                            const newStatus = change.newValue === 'yes' ? 'Active' : 'Not Active';
                            changeStrings.push(`E-Gp status from ${oldStatus} to ${newStatus}`);
                            changeDetails.push(`E-Gp Status: ${oldStatus} → ${newStatus}`);
                        }
                    });
                    
                    if (changeStrings.length > 0) {
                        readableMessage += ` — ${changeStrings.join('; ')}`;
                    }
                }
                break;
                
            case 'DELETE_SUPPLIER':
                readableMessage = `${userFullName} deleted supplier: "${details.name}"`;
                changeDetails.push(`Deleted by: ${userFullName}`);
                changeDetails.push(`Supplier: ${details.name}`);
                if (details.category) changeDetails.push(`Category: ${details.category}`);
                if (details.phone) changeDetails.push(`Phone: ${details.phone}`);
                if (details.tpin) changeDetails.push(`TPIN: ${details.tpin}`);
                break;
            
            case 'CREATE_CATEGORY':
                readableMessage = `${userFullName} created a new category: "${details.name}"`;
                changeDetails.push(`Created by: ${userFullName}`);
                changeDetails.push(`Category: ${details.name}`);
                break;
                
            case 'UPDATE_CATEGORY':
                if (details.oldName && details.newName) {
                    readableMessage = `${userFullName} renamed category from "${details.oldName}" to "${details.newName}"`;
                    changeDetails.push(`Category: ${details.oldName} → ${details.newName}`);
                } else {
                    readableMessage = `${userFullName} updated category ${details.name || ''}`;
                }
                break;
                
            case 'DELETE_CATEGORY':
                readableMessage = `${userFullName} deleted category: "${details.name}"`;
                changeDetails.push(`Deleted by: ${userFullName}`);
                changeDetails.push(`Category: ${details.name}`);
                break;
            
            case 'CREATE_LINK':
                readableMessage = `${userFullName} added a new link for ${details.institution || 'Unknown'}`;
                changeDetails.push(`Created by: ${userFullName}`);
                changeDetails.push(`Institution: ${details.institution}`);
                changeDetails.push(`Website: ${details.website}`);
                if (details.email) changeDetails.push(`Email: ${details.email}`);
                break;
                
            case 'DELETE_LINK':
                readableMessage = `${userFullName} deleted link for ${details.institution || 'Unknown'}`;
                changeDetails.push(`Deleted by: ${userFullName}`);
                changeDetails.push(`Institution: ${details.institution}`);
                changeDetails.push(`Website: ${details.website}`);
                break;
            
            case 'ACCOUNT_REQUEST':
                readableMessage = `${details.fullName || details.username} requested to create a staff account`;
                changeDetails.push(`Requested by: ${details.fullName || details.username}`);
                changeDetails.push(`Username: ${details.username}`);
                changeDetails.push(`Email: ${details.email}`);
                changeDetails.push(`Phone: ${details.phone}`);
                changeDetails.push(`Institution: ${details.institution}`);
                changeDetails.push(`Position: ${details.position}`);
                break;
                
            case 'ACCOUNT_APPROVED':
                readableMessage = `${userFullName} approved account request for ${details.fullName || details.username}`;
                changeDetails.push(`Approved by: ${userFullName}`);
                changeDetails.push(`User: ${details.fullName || details.username}`);
                changeDetails.push(`Username: ${details.username}`);
                changeDetails.push(`Email: ${details.email}`);
                break;
                
            case 'ACCOUNT_REJECTED':
                readableMessage = `${userFullName} rejected account request for ${details.fullName || details.username}`;
                changeDetails.push(`Rejected by: ${userFullName}`);
                changeDetails.push(`User: ${details.fullName || details.username}`);
                changeDetails.push(`Username: ${details.username}`);
                changeDetails.push(`Reason: "${details.reason}"`);
                break;
            
            case 'APPROVAL_REQUEST_CREATED':
                if (details.action === 'add') {
                    readableMessage = `${details.requestedBy || 'Someone'} requested to add a new ${details.type}`;
                    if (details.itemName) readableMessage += `: "${details.itemName}"`;
                } else if (details.action === 'edit') {
                    readableMessage = `${details.requestedBy || 'Someone'} requested to edit a ${details.type}`;
                    if (details.itemName) readableMessage += `: "${details.itemName}"`;
                } else if (details.action === 'delete') {
                    readableMessage = `${details.requestedBy || 'Someone'} requested to delete a ${details.type}`;
                    if (details.itemName) readableMessage += `: "${details.itemName}"`;
                }
                if (details.reason) readableMessage += ` (Reason: "${details.reason}")`;
                
                changeDetails.push(`Requested by: ${details.requestedBy}`);
                changeDetails.push(`Action: ${details.action} ${details.type}`);
                changeDetails.push(`Item: ${details.itemName}`);
                if (details.reason) changeDetails.push(`Reason: ${details.reason}`);
                break;
                
            case 'APPROVAL_GRANTED':
                const approver = getUser(details.reviewedBy)?.fullName || details.reviewedBy || 'Someone';
                readableMessage = `${approver} approved a request to ${details.action} a ${details.type}`;
                if (details.itemName) readableMessage += `: "${details.itemName}"`;
                
                changeDetails.push(`Approved by: ${approver}`);
                changeDetails.push(`Request from: ${details.requestedBy}`);
                changeDetails.push(`Action: ${details.action} ${details.type}`);
                changeDetails.push(`Item: ${details.itemName}`);
                break;
                
            case 'APPROVAL_REJECTED':
                const rejector = getUser(details.reviewedBy)?.fullName || details.reviewedBy || 'Someone';
                const actionType = details.action || 'unknown';
                const requestType = details.type || 'unknown';
                const itemDisplay = details.itemName || 'Unknown';
                
                readableMessage = `${rejector} rejected a request to ${actionType} a ${requestType}`;
                if (itemDisplay && itemDisplay !== 'Unknown') readableMessage += `: "${itemDisplay}"`;
                if (details.reason) readableMessage += ` — Reason: "${details.reason}"`;
                
                changeDetails.push(`Rejected by: ${rejector}`);
                changeDetails.push(`Request from: ${details.requestedByFullName || details.requestedBy || 'Unknown'}`);
                changeDetails.push(`Action: ${actionType} ${requestType}`);
                changeDetails.push(`Item: ${itemDisplay}`);
                changeDetails.push(`Reason: ${details.reason || 'No reason provided'}`);
                break;

            case 'USER_LOGIN':
                readableMessage = `${userFullName} logged into the system`;
                changeDetails.push(`User: ${userFullName}`);
                changeDetails.push(`Username: ${currentUser}`);
                changeDetails.push(`Time: ${new Date().toLocaleString()}`);
                if (details.role) changeDetails.push(`Role: ${details.role}`);
                if (details.locked) changeDetails.push(`System Status: Locked (after-hours access)`);
                break;
                
            case 'USER_LOGOUT':
                readableMessage = `${userFullName} logged out of the system`;
                changeDetails.push(`User: ${userFullName}`);
                changeDetails.push(`Username: ${currentUser}`);
                changeDetails.push(`Time: ${new Date().toLocaleString()}`);
                break;
            
            case 'PASSWORD_CHANGE':
                readableMessage = `${userFullName} changed their password`;
                changeDetails.push(`User: ${userFullName}`);
                changeDetails.push(`Password changed at: ${new Date().toLocaleString()}`);
                break;
                
            case 'PASSWORD_RETRIEVAL':
                readableMessage = `Password was retrieved for ${details.username || 'a user'}`;
                changeDetails.push(`User: ${details.username}`);
                changeDetails.push(`Email sent to: ${details.email}`);
                changeDetails.push(`Retrieval method: Forgot Password`);
                break;
            
            case 'SYSTEM_INIT':
                readableMessage = `System was initialized with default data`;
                changeDetails.push(`Initialization: ${details.action || 'Default data created'}`);
                break;
                
            case 'EXPORT_BACKUP':
                readableMessage = `${userFullName} exported a system backup`;
                if (details.recordCounts) {
                    readableMessage += ` (${details.recordCounts.categories || 0} categories, ${details.recordCounts.suppliers || 0} suppliers)`;
                    changeDetails.push(`Categories: ${details.recordCounts.categories || 0}`);
                    changeDetails.push(`Suppliers: ${details.recordCounts.suppliers || 0}`);
                    changeDetails.push(`Links: ${details.recordCounts.links || 0}`);
                    changeDetails.push(`Users: ${details.recordCounts.users || 0}`);
                }
                changeDetails.push(`Exported by: ${userFullName}`);
                break;
                
            case 'DELETE_ALL_AUDIT_LOGS':
                readableMessage = `${userFullName} deleted all audit logs (${details.count || 'all'} records)`;
                changeDetails.push(`Deleted by: ${userFullName}`);
                changeDetails.push(`Records deleted: ${details.count || 'all'}`);
                break;
                
            case 'DELETE_LAST_50_AUDIT_LOGS':
                readableMessage = `${userFullName} deleted the last 50 audit logs`;
                changeDetails.push(`Deleted by: ${userFullName}`);
                changeDetails.push(`Records deleted: 50`);
                break;
            
            default:
                readableMessage = `${userFullName} performed action: ${action}`;
        }

        const logEntry = {
            timestamp: new Date().toISOString(),
            user: currentUser,
            userFullName: userFullName,
            action: action,
            readableMessage: readableMessage,
            details: details,
            changeDetails: changeDetails
        };
        
        await db.collection(COLLECTIONS.AUDIT_LOGS).add(logEntry);
        console.log('Audit log created:', readableMessage);
    } catch (error) {
        console.error('Error creating audit log:', error);
    }
}

async function saveSupplierWithCleanLogs() {
    if (!canCreateSupplier() && !canEditSupplier()) {
        alert('You do not have permission to save suppliers');
        return;
    }

    const name = document.getElementById('supplierName').value.trim();
    const phone = document.getElementById('supplierPhone').value.trim();
    const category = document.getElementById('supplierCategory').value;
    const province = document.getElementById('supplierProvince').value;

    if (!province) {
        alert('Supplier Province is required');
        return;
    }
    
    if (!name || !phone || !category) {
        alert('Supplier Name, Phone Number, and Category are required');
        return;
    }

    let rating = 3;
    const ratingInputs = document.querySelectorAll('input[name="rating"]');
    for (let input of ratingInputs) {
        if (input.checked) {
            rating = parseInt(input.value);
            break;
        }
    }

    const renewalYear = document.getElementById('supplierRenewalYear').value;
    const renewalMonth = document.getElementById('supplierRenewalMonth').value;
    const renewalDate = new Date(renewalYear, parseInt(renewalMonth), 31).toISOString();
    const compliance = {
        tpin: document.getElementById('complianceTpin').checked ? 'yes' : 'no',
        napsa: document.getElementById('complianceNapsa').checked ? 'yes' : 'no',
        zra: document.getElementById('complianceZra').checked ? 'yes' : 'no',
        zppa: document.getElementById('complianceZppa').checked ? 'yes' : 'no',
        egp: document.getElementById('complianceEgp').checked ? 'yes' : 'no'
    };

    const documents = [];
    for (let [type, doc] of Object.entries(uploadedDocuments)) {
        if (doc) {
            documents.push({
                type: type,
                name: doc.name,
                size: doc.size,
                uploadedAt: doc.uploadedAt,
                data: doc.data
            });
        }
    }

    const supplierData = {
        name: name,
        specialization: document.getElementById('supplierSpecialization').value.trim(),
        province: province,
        phone: phone,
        tpin: document.getElementById('supplierTpin').value.trim(),
        email: document.getElementById('supplierEmail').value.trim(),
        address: document.getElementById('supplierAddress').value.trim(),
        category: category,
        rating: rating,
        compliance: compliance,
        renewalDate: renewalDate,
        documents: documents,
        images: [],
        lastModifiedBy: getCurrentUser(),
        lastModifiedAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };

    const editingId = document.getElementById('editingSupplierId').value;
    const actionType = document.getElementById('supplierActionType').value;
    const currentUser = getUser(getCurrentUser());

    try {
        if (actionType === 'edit' && editingId) {
            const oldSupplier = suppliers.find(s => s.id === editingId);
            
            if (currentUser.role === 'super admin' || currentUser.role === 'admin') {
                const existingModifications = oldSupplier?.modifications || [];
                
                const fieldChanges = [];
                const changeSummary = [];
                
                if (oldSupplier.name !== name) {
                    fieldChanges.push(`name from "${oldSupplier.name}" to "${name}"`);
                    changeSummary.push({ field: 'name', oldValue: oldSupplier.name, newValue: name });
                }
                
                if (oldSupplier.specialization !== supplierData.specialization) {
                    fieldChanges.push(`specialization from "${oldSupplier.specialization || 'empty'}" to "${supplierData.specialization || 'empty'}"`);
                    changeSummary.push({ field: 'specialization', oldValue: oldSupplier.specialization || 'empty', newValue: supplierData.specialization || 'empty' });
                }
                
                if (oldSupplier.phone !== phone) {
                    fieldChanges.push(`phone from "${oldSupplier.phone || 'empty'}" to "${phone}"`);
                    changeSummary.push({ field: 'phone', oldValue: oldSupplier.phone || 'empty', newValue: phone });
                }
                
                if (oldSupplier.tpin !== supplierData.tpin) {
                    fieldChanges.push(`TPIN from "${oldSupplier.tpin || 'empty'}" to "${supplierData.tpin || 'empty'}"`);
                    changeSummary.push({ field: 'tpin', oldValue: oldSupplier.tpin || 'empty', newValue: supplierData.tpin || 'empty' });
                }
                
                if (oldSupplier.email !== supplierData.email) {
                    fieldChanges.push(`email from "${oldSupplier.email || 'empty'}" to "${supplierData.email || 'empty'}"`);
                    changeSummary.push({ field: 'email', oldValue: oldSupplier.email || 'empty', newValue: supplierData.email || 'empty' });
                }
                
                if (oldSupplier.address !== supplierData.address) {
                    fieldChanges.push(`address from "${oldSupplier.address || 'empty'}" to "${supplierData.address || 'empty'}"`);
                    changeSummary.push({ field: 'address', oldValue: oldSupplier.address || 'empty', newValue: supplierData.address || 'empty' });
                }
                
                if (oldSupplier.rating !== rating) {
                    fieldChanges.push(`rating from ${oldSupplier.rating || 0}★ to ${rating}★`);
                    changeSummary.push({ field: 'rating', oldValue: oldSupplier.rating || 0, newValue: rating });
                }
                
                if (oldSupplier.compliance) {
                    if (oldSupplier.compliance.tpin !== compliance.tpin) {
                        fieldChanges.push(`TPIN compliance from "${oldSupplier.compliance.tpin}" to "${compliance.tpin}"`);
                        changeSummary.push({ field: 'compliance.tpin', oldValue: oldSupplier.compliance.tpin, newValue: compliance.tpin });
                    }
                    if (oldSupplier.compliance.napsa !== compliance.napsa) {
                        fieldChanges.push(`NAPSA compliance from "${oldSupplier.compliance.napsa}" to "${compliance.napsa}"`);
                        changeSummary.push({ field: 'compliance.napsa', oldValue: oldSupplier.compliance.napsa, newValue: compliance.napsa });
                    }
                    if (oldSupplier.compliance.zra !== compliance.zra) {
                        fieldChanges.push(`ZRA compliance from "${oldSupplier.compliance.zra}" to "${compliance.zra}"`);
                        changeSummary.push({ field: 'compliance.zra', oldValue: oldSupplier.compliance.zra, newValue: compliance.zra });
                    }
                    if (oldSupplier.compliance.zppa !== compliance.zppa) {
                        fieldChanges.push(`ZPPA compliance from "${oldSupplier.compliance.zppa}" to "${compliance.zppa}"`);
                        changeSummary.push({ field: 'compliance.zppa', oldValue: oldSupplier.compliance.zppa, newValue: compliance.zppa });
                    }
                    if (oldSupplier.compliance.egp !== compliance.egp) {
                        fieldChanges.push(`E-Gp status from "${oldSupplier.compliance.egp || 'no'}" to "${compliance.egp}"`);
                        changeSummary.push({ field: 'compliance.egp', oldValue: oldSupplier.compliance.egp || 'no', newValue: compliance.egp });
                    }
                }
                
                if (oldSupplier.renewalDate !== renewalDate) {
                    const oldDate = oldSupplier.renewalDate ? new Date(oldSupplier.renewalDate).toLocaleDateString() : 'not set';
                    const newDate = new Date(renewalDate).toLocaleDateString();
                    fieldChanges.push(`renewal date from "${oldDate}" to "${newDate}"`);
                    changeSummary.push({ field: 'renewalDate', oldValue: oldDate, newValue: newDate });
                }
                
                let modificationDescription;
                if (fieldChanges.length > 0) {
                    modificationDescription = `${getCurrentUser()} updated supplier: ${fieldChanges.join('; ')}`;
                } else {
                    modificationDescription = `${getCurrentUser()} updated supplier documents or settings`;
                }
                
                const newModification = {
                    action: 'update',
                    field: 'supplier',
                    modifiedBy: getCurrentUser(),
                    modifiedAt: new Date().toISOString(),
                    description: modificationDescription,
                    changes: changeSummary
                };
                
                const updatedModifications = [newModification, ...existingModifications].slice(0, 50);
                await db.collection(COLLECTIONS.SUPPLIERS).doc(editingId).update({
                    ...supplierData,
                    modifications: updatedModifications
                });
                
                await logAudit('UPDATE_SUPPLIER', {
                    supplierId: editingId,
                    name: name,
                    changes: changeSummary
                });

                showNotification('Supplier updated successfully', 'success');
            } else {
                await createApprovalRequest('supplier', supplierData, 'edit', editingId);
                closeSupplierModal();
                showNotification('Supplier edit request submitted for approval', 'info');
                return;
            }
        } else {
            if (currentUser.role === 'super admin' || currentUser.role === 'admin') {
                const newSupplierData = {
                    ...supplierData,
                    createdAt: new Date().toISOString(),
                    createdBy: getCurrentUser(),
                    modifications: [{
                        action: 'create',
                        field: 'supplier',
                        modifiedBy: getCurrentUser(),
                        modifiedAt: new Date().toISOString(),
                        description: `${getCurrentUser()} created supplier "${name}"`,
                        changes: [{ field: 'name', oldValue: 'none', newValue: name }]
                    }]
                };

                await db.collection(COLLECTIONS.SUPPLIERS).add(newSupplierData);
                await logAudit('CREATE_SUPPLIER', {
                    name: name,
                    category: category
                });

                showNotification('Supplier added successfully', 'success');
            } else {
                await createApprovalRequest('supplier', supplierData, 'add', null);
                closeSupplierModal();
                showNotification('Supplier addition request submitted for approval', 'info');
                return;
            }
        }

        await loadAllData(true);
        closeSupplierModal();

        if (document.getElementById('categoryPageView').style.display === 'block') {
            const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
            renderSuppliersTable(categorySuppliers);
        }
    } catch (error) {
        console.error('Error saving supplier:', error);
        alert('Failed to save supplier: ' + error.message);
    }
}

async function showAuditLogs() {
    const currentUser = getUser(getCurrentUser());
    
    if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'super admin')) {
        alert('You do not have permission to view audit logs. This feature is only available to Admin and Super Admin users.');
        return;
    }
    
    showView('auditLogs');
    await loadAuditLogs(true);
    renderAuditLogs();
}

async function saveSupplierModification(supplierId, action, field, oldValue, newValue, modifiedBy) {
    try {
        const supplierRef = db.collection(COLLECTIONS.SUPPLIERS).doc(supplierId);
        const supplier = suppliers.find(s => s.id === supplierId);
        
        if (!supplier) return;
        
        const modification = {
            action: action,
            field: field,
            old: oldValue,
            new: newValue,
            modifiedBy: modifiedBy,
            modifiedAt: new Date().toISOString(),
            description: generateModificationDescription(action, field, oldValue, newValue, modifiedBy)
        };
        
        const modifications = supplier.modifications || [];
        modifications.unshift(modification);
        const recentModifications = modifications.slice(0, 50);
        
        await supplierRef.update({
            modifications: recentModifications,
            lastModifiedBy: modifiedBy,
            lastModifiedAt: new Date().toISOString()
        });
        
        console.log('Modification saved:', modification);
    } catch (error) {
        console.error('Error saving modification:', error);
    }
}

async function initializeSupplierModifications() {
    try {
        const snapshot = await db.collection(COLLECTIONS.SUPPLIERS).get();
        const batch = db.batch();
        let updates = 0;
        
        snapshot.docs.forEach(doc => {
            const data = doc.data();
            if (!data.modifications && data.createdBy) {
                batch.update(doc.ref, {
                    modifications: [{
                        action: 'create',
                        field: 'supplier',
                        modifiedBy: data.createdBy || 'SYSTEM',
                        modifiedAt: data.createdAt || new Date().toISOString(),
                        description: `${data.createdBy || 'SYSTEM'} created this supplier`
                    }]
                });
                updates++;
            }
        });
        
        if (updates > 0) {
            await batch.commit();
            console.log(`Initialized modifications for ${updates} suppliers`);
        }
    } catch (error) {
        console.error('Error initializing supplier modifications:', error);
    }
}

const originalHandleLogin = handleLogin;
handleLogin = async function() {
    await originalHandleLogin.apply(this, arguments);
    if (getCurrentUser()) {
        await initializeSupplierModifications();
    }
};

function toggleHistory(historyId) {
    const historyRow = document.getElementById(historyId);
    if (historyRow) {
        if (historyRow.style.display === 'none' || historyRow.style.display === '') {
            historyRow.style.display = 'table-row';
        } else {
            historyRow.style.display = 'none';
        }
    }
}

function generateModificationDescription(action, field, oldValue, newValue, modifiedBy) {
    const userDisplay = `<span style="color: #173979; font-weight: 600;">${modifiedBy}</span>`;
    
    if (action === 'create') {
        return `${userDisplay} created this supplier`;
    } else if (action === 'update') {
        if (field === 'name') {
            return `${userDisplay} renamed supplier from "${oldValue}" to "${newValue}"`;
        } else if (field === 'tpin') {
            return `${userDisplay} changed TPIN from "${oldValue}" to "${newValue}"`;
        } else if (field === 'phone') {
            return `${userDisplay} updated phone number from "${oldValue}" to "${newValue}"`;
        } else if (field === 'email') {
            return `${userDisplay} changed email from "${oldValue}" to "${newValue}"`;
        } else if (field === 'rating') {
            return `${userDisplay} changed rating from ${oldValue}★ to ${newValue}★`;
        } else if (field === 'compliance') {
            return `${userDisplay} updated compliance status`;
        } else {
            return `${userDisplay} updated ${field} from "${oldValue}" to "${newValue}"`;
        }
    } else if (action === 'delete') {
        return `${userDisplay} deleted this supplier`;
    }
    return `${userDisplay} modified supplier`;
}

function renderAuditLogs() {
    const container = document.getElementById('auditLogsContainer');
    const paginationDiv = document.getElementById('auditPagination');
    
    if (!container) return;
    
    if (!auditLogs || auditLogs.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 60px; color: #666;">📭 No audit logs found</div>';
        if (paginationDiv) paginationDiv.innerHTML = '';
        return;
    }

    const startIndex = (currentAuditPage - 1) * auditLogsPerPage;
    const endIndex = startIndex + auditLogsPerPage;
    const paginatedLogs = auditLogs.slice(startIndex, endIndex);

    let html = '<div class="audit-log-container">';
    
    paginatedLogs.forEach(log => {
        const timestamp = log.timestamp ? new Date(log.timestamp) : new Date();
        const timeStr = timestamp.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        let message = log.readableMessage || 
                     `${log.userFullName || log.user || 'SYSTEM'} performed ${log.action}`;

        let icon = '📝';
        if (log.action.includes('CREATE')) icon = '➕';
        else if (log.action.includes('UPDATE') || log.action.includes('EDIT')) icon = '✏️';
        else if (log.action.includes('DELETE')) icon = '🗑️';
        else if (log.action.includes('APPROVE')) icon = '✅';
        else if (log.action.includes('REJECT')) icon = '❌';
        else if (log.action.includes('LOGIN')) icon = '🔓';
        else if (log.action.includes('LOGOUT')) icon = '🔒';
        
        let detailsHtml = '';
        if (log.changeDetails && log.changeDetails.length > 0) {
            detailsHtml = `
                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; border-left: 4px solid #3498db;">
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 13px;">📋 DETAILED CHANGES:</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 8px;">
                        ${log.changeDetails.map(detail => `
                            <div style="font-size: 12px; padding: 6px 10px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                                <span style="color: #2c3e50;">${detail}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        html += `
            <div class="audit-log-entry" style="margin-bottom: 20px; padding: 20px; background: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); border-left: 6px solid ${getActionColor(log.action)};">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <span class="audit-timestamp" style="background: #f0f0f0; padding: 6px 12px; border-radius: 30px; font-size: 12px; color: #666;">
                            ${icon} ${timeStr}
                        </span>
                        <span style="background: ${getActionColor(log.action)}20; color: ${getActionColor(log.action)}; padding: 4px 12px; border-radius: 30px; font-size: 11px; font-weight: 600;">
                            ${log.action}
                        </span>
                    </div>
                    <span style="font-size: 12px; color: #666; background: #f8f9fa; padding: 4px 10px; border-radius: 20px;">
                        👤 ${log.userFullName || log.user}
                    </span>
                </div>
                
                <div style="font-size: 15px; line-height: 1.6; color: #2c3e50; padding: 5px 0;">
                    ${message}
                </div>
                
                ${detailsHtml}
                
                ${log.details?.reason ? `
                    <div style="margin-top: 10px; padding: 10px 15px; background: #fff8e7; border-radius: 8px; font-size: 13px; color: #e67e22; border-left: 4px solid #f39c12;">
                        <strong>📝 Reason provided:</strong> ${log.details.reason}
                    </div>
                ` : ''}
                
                <div style="margin-top: 8px; font-size: 11px; color: #999; font-family: monospace; border-top: 1px dashed #eee; padding-top: 8px;">
                    Log ID: ${log.id?.substring(0, 8)}...
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;

    let paginationHtml = '';
    if (totalAuditPages > 1) {
        paginationHtml += '<div class="pagination-controls" style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">';
        
        if (currentAuditPage > 1) {
            paginationHtml += `<button class="btn btn-pagination" onclick="changeAuditPage(${currentAuditPage - 1})">← Previous</button>`;
        }
        
        paginationHtml += `<span style="font-size: 14px; padding: 8px 16px; background: white; border-radius: 30px;">Page ${currentAuditPage} of ${totalAuditPages}</span>`;
        
        if (currentAuditPage < totalAuditPages) {
            paginationHtml += `<button class="btn btn-pagination" onclick="changeAuditPage(${currentAuditPage + 1})">Next →</button>`;
        }
        
        paginationHtml += '</div>';
    }
    
    if (paginationDiv) paginationDiv.innerHTML = paginationHtml;
}

function getActionColor(action) {
    if (action.includes('CREATE') || action.includes('ADD')) return '#27ae60';
    if (action.includes('UPDATE') || action.includes('EDIT')) return '#f39c12';
    if (action.includes('DELETE')) return '#e74c3c';
    if (action.includes('APPROVE')) return '#2ecc71';
    if (action.includes('REJECT')) return '#e74c3c';
    if (action.includes('LOGIN')) return '#3498db';
    if (action.includes('LOGOUT')) return '#95a5a6';
    return '#7f8c8d';
}

function changeAuditPage(newPage) {
    currentAuditPage = newPage;
    renderAuditLogs();
}
    async function deleteAllAuditLogs() {
        if (!canDeleteAuditLogs()) {
            alert('Only super admin can delete audit logs');
            return;
        }

        if (confirm('⚠️ Delete ALL audit logs? This action CANNOT be undone.')) {
            try {
                showNotification('Deleting all audit logs...', 'info');
                
                const snapshot = await db.collection(COLLECTIONS.AUDIT_LOGS).get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                await logAudit('DELETE_ALL_AUDIT_LOGS', { 
                    count: snapshot.size,
                    deletedBy: getCurrentUser() 
                });
                
                await loadAuditLogs();
                renderAuditLogs();
                showNotification(`✅ Deleted ${snapshot.size} audit logs successfully`, 'success');
            } catch (error) {
                console.error('Error deleting audit logs:', error);
                alert('Failed to delete audit logs: ' + error.message);
            }
        }
    }

    async function deleteLast50AuditLogs() {
        if (!canDeleteAuditLogs()) {
            alert('Only super admin can delete audit logs');
            return;
        }

        if (confirm('Delete the last 50 audit logs?')) {
            try {
                showNotification('Deleting last 50 audit logs...', 'info');
                
                const snapshot = await db.collection(COLLECTIONS.AUDIT_LOGS)
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                await logAudit('DELETE_LAST_50_AUDIT_LOGS', { 
                    count: snapshot.size,
                    deletedBy: getCurrentUser() 
                });
                
                await loadAuditLogs();
                renderAuditLogs();
                showNotification(`✅ Deleted ${snapshot.size} audit logs successfully`, 'success');
            } catch (error) {
                console.error('Error deleting audit logs:', error);
                alert('Failed to delete audit logs: ' + error.message);
            }
        }
    }

    function openReasonModal(type, id, name, callback) {
        document.getElementById('reasonModalTitle').innerHTML = `State Reason for ${type} Deletion`;
        document.getElementById('pendingDeletionType').value = type;
        document.getElementById('pendingDeletionId').value = id;
        document.getElementById('pendingDeletionName').value = name;
        document.getElementById('deletionReason').value = '';
        pendingDeletionCallback = callback;
        document.getElementById('reasonModal').style.display = 'flex';
    }

    function closeReasonModal() {
        document.getElementById('reasonModal').style.display = 'none';
        document.getElementById('deletionReason').value = '';
        pendingDeletionCallback = null;
    }

    async function submitDeletionReason() {
        const reason = document.getElementById('deletionReason').value.trim();
        if (!reason) {
            alert('Please provide a reason for deletion');
            return;
        }

        const type = document.getElementById('pendingDeletionType').value;
        const id = document.getElementById('pendingDeletionId').value;
        const name = document.getElementById('pendingDeletionName').value;

        if (pendingDeletionCallback) {
            await pendingDeletionCallback(type, id, name, reason);
        }
        closeReasonModal();
    }

    async function loadApprovalRequests() {
    try {
        console.log("Loading approval requests...");
        const snapshot = await db.collection(COLLECTIONS.APPROVALS)
            .where('status', '==', 'pending')
            .orderBy('createdAt', 'desc')
            .get();
        
        approvalRequests = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        console.log(`Found ${approvalRequests.length} pending requests`);
        updateApprovalsButton();
        updateRequestCounts();
 
        
    } catch (error) {
        console.error('Error loading approval requests:', error);
        approvalRequests = [];
        updateRequestCounts();
        hideAllPulses();
    }
}

    function updateRequestCounts() {
    const navBtn = document.getElementById('approvalRequestsNavBtn');
    const countSpan = document.getElementById('approvalRequestCount');
    
    const currentUser = getUser(getCurrentUser());
    if (!currentUser) return;
    
    let visibleRequests = approvalRequests;
    if (currentUser.role === 'admin') {
        visibleRequests = approvalRequests.filter(req => 
            req.requestedByRole === 'staff' || req.requestedByRole === 'admin'
        );
    } else if (currentUser.role === 'staff') {
        visibleRequests = [];
    }
    
    const count = visibleRequests.length;
    
    if (countSpan) {
        countSpan.textContent = count;
        countSpan.className = `request-count-badge ${count === 0 ? 'request-count-zero' : ''}`;
    }
    
    if (navBtn) {
        if (canApproveRequests() && count > 0) {
            navBtn.style.display = 'inline-block';
        } else {
            navBtn.style.display = 'none';
        }
    }
    
    const requestsBtn = document.getElementById('requestsManagementBtn');
    if (requestsBtn) {
        requestsBtn.style.display = currentUser.role === 'super admin' ? 'inline-block' : 'none';
    }
    
    const historyBtn = document.getElementById('approvalHistoryNavBtn');
    if (historyBtn) {
        historyBtn.style.display = currentUser.role !== 'super admin' ? 'inline-block' : 'none';
    }
}

    function generateChangeDescription(userName, type, oldData, newData, changes) {
    if (!changes || changes.length === 0) return '';
    
    let description = `<span style="color: #173979; font-weight: 600;">${userName}</span> `;
    
    if (type === 'supplier') {
        description += `updated supplier "${oldData.name || 'Unknown'}"`;
        const changeList = [];
        
        changes.forEach(change => {
            if (change.field === 'name' && change.oldValue !== change.newValue) {
                changeList.push(`renamed from "${change.oldValue}" to "${change.newValue}"`);
            } else if (change.field === 'tpin') {
                changeList.push(`changed TPIN from "${change.oldValue}" to "${change.newValue}"`);
            } else if (change.field === 'phone') {
                changeList.push(`updated phone from "${change.oldValue}" to "${change.newValue}"`);
            } else if (change.field === 'rating') {
                changeList.push(`changed rating from ${change.oldValue}★ to ${change.newValue}★`);
            } else if (change.field === 'compliance') {
                if (change.nestedChanges) {
                    change.nestedChanges.forEach(n => {
                        changeList.push(`${n.field} compliance from "${n.oldValue}" to "${n.newValue}"`);
                    });
                }
            }
        });
        
        if (changeList.length > 0) {
            description += `: ${changeList.join('; ')}`;
        }
    } else if (type === 'category') {
        description += `renamed category from "${oldData?.name}" to "${newData?.name}"`;
    } else if (type === 'user') {
        description += `updated user ${oldData?.fullName || oldData?.username || 'Unknown'}`;
        const changeList = [];
        
        changes.forEach(change => {
            if (change.field === 'fullName') {
                changeList.push(`name from "${change.oldValue}" to "${change.newValue}"`);
            } else if (change.field === 'role') {
                changeList.push(`role from "${change.oldValue}" to "${change.newValue}"`);
            } else if (change.field === 'enabled') {
                changeList.push(`account status from "${change.oldValue}" to "${change.newValue}"`);
            }
        });
        
        if (changeList.length > 0) {
            description += `: ${changeList.join('; ')}`;
        }
    }
    
    return description;
}

async function createApprovalRequest(type, newData, action, itemId, reason = null, oldData = null) {
    try {
        const currentUser = getUser(getCurrentUser());
        if (!currentUser) {
            alert('You must be logged in to create a request');
            return;
        }

        console.log(`Creating ${action} request for ${type}:`, newData);
        
        let changeDescription = '';
        let changeSummary = [];
        
        if (action === 'edit' && oldData) {
            changeSummary = getChangeSummary(oldData, newData);
            changeDescription = generateChangeDescription(currentUser.fullName || currentUser.username, type, oldData, newData, changeSummary);
        } else if (action === 'add') {
            changeDescription = `${currentUser.fullName || currentUser.username} submitted a request to add a new ${type}`;
            if (newData.name) changeDescription += `: "${newData.name}"`;
            if (type === 'user' && newData.fullName) changeDescription += ` (${newData.fullName})`;
        } else if (action === 'delete') {
            changeDescription = `${currentUser.fullName || currentUser.username} submitted a request to delete a ${type}`;
            if (oldData?.name) changeDescription += `: "${oldData.name}"`;
            if (reason) changeDescription += `. Reason: ${reason}`;
        }
        
        const request = {
            type: type,
            action: action,
            itemId: itemId,
            requestedBy: getCurrentUser(),
            requestedByFullName: currentUser.fullName || currentUser.username,
            requestedByRole: currentUser.role,
            requestedData: newData,
            oldData: oldData,
            changeSummary: changeSummary,
            changeDescription: changeDescription,
            itemName: newData?.name || oldData?.name || (type === 'user' ? newData?.fullName : null),
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdDate: new Date().toISOString()
        };
        
        if (reason) {
            request.reason = reason;
        }
        
        const docRef = await db.collection(COLLECTIONS.APPROVALS).add(request);
        console.log(`Request created with ID: ${docRef.id}`);
        
        await logAudit('APPROVAL_REQUEST_CREATED', {
            action: action,
            type: type,
            itemName: request.itemName,
            requestedBy: currentUser.fullName || currentUser.username,
            reason: reason,
            changeDescription: changeDescription
        });
        
        await loadApprovalRequests();
        updateApprovalsButton();
        updateRequestCounts();
        
        showNotification('✅ Approval request submitted successfully', 'success');
    } catch (error) {
        console.error('Error creating approval request:', error);
        alert('Failed to create approval request: ' + error.message);
    }
}

    function updateApprovalsButton() {
    const navBtn = document.getElementById('approvalRequestsNavBtn');
    if (navBtn) {
        navBtn.style.display = 'none';
    }

    const historyBtn = document.getElementById('approvalHistoryNavBtn');
    if (historyBtn && getCurrentUser()) {
        const currentUser = getUser(getCurrentUser());
        if (currentUser && currentUser.role === 'super admin') {
            historyBtn.style.display = 'none';
        } else {
            historyBtn.style.display = 'inline-block';
        }
    }
    
    updateRequestCounts();
}

async function openApprovalActionModal(requestId) {
    const request = approvalRequests.find(r => r.id === requestId);
    if (!request) return;
    
    localStorage.setItem('currentApprovalRequestId', requestId);
    
    const detailsDiv = document.getElementById('approvalActionDetails');
    const actionColor = request.action === 'delete' ? '#e74c3c' : 
                       request.action === 'edit' ? '#f39c12' : '#3498db';
    
    let detailsHtml = `
        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                <span style="background: ${actionColor}; color: white; padding: 8px 20px; border-radius: 30px; font-weight: 700; font-size: 14px;">
                    ${request.action.toUpperCase()} ${request.type.toUpperCase()}
                </span>
                <span style="background: ${request.requestedByRole === 'super admin' ? '#9b59b6' : request.requestedByRole === 'admin' ? '#3498db' : '#2ecc71'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
                    ${request.requestedByRole}
                </span>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                <div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">👤 REQUESTED BY</div>
                    <div style="font-weight: 600; color: #173979;">${request.requestedByFullName || request.requestedBy}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">${request.requestedBy}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">📅 SUBMITTED</div>
                    <div style="font-weight: 600;">${new Date(request.createdAt?.toDate ? request.createdAt.toDate() : request.createdAt).toLocaleString()}</div>
                </div>
            </div>
        </div>
    `;
    
    if (request.changeDescription) {
        detailsHtml += `
            <div style="background: ${actionColor}10; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 6px solid ${actionColor};">
                <div style="font-weight: 700; color: ${actionColor}; margin-bottom: 10px;">📋 REQUEST DETAILS:</div>
                <div style="font-size: 15px; line-height: 1.6;">${request.changeDescription}</div>
            </div>
        `;
    }
    
    if (request.changeSummary && request.changeSummary.length > 0) {
        detailsHtml += `
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
                <div style="font-weight: 700; color: #2c3e50; margin-bottom: 15px;">🔍 SPECIFIC CHANGES:</div>
        `;
        
        request.changeSummary.forEach(change => {
            if (change.type === 'object' && change.nestedChanges) {
                detailsHtml += `
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: 600; color: #e67e22; margin-bottom: 8px;">${change.field.toUpperCase()}:</div>
                `;
                change.nestedChanges.forEach(n => {
                    detailsHtml += `
                        <div style="display: flex; margin-bottom: 8px; background: #f8f9fa; padding: 8px; border-radius: 6px;">
                            <span style="min-width: 100px; font-weight: 500;">${n.field}:</span>
                            <span style="color: #e74c3c; text-decoration: line-through; margin-right: 15px;">${n.oldValue || 'empty'}</span>
                            <span style="color: #27ae60;">→ ${n.newValue || 'empty'}</span>
                        </div>
                    `;
                });
                detailsHtml += `</div>`;
            } else {
                detailsHtml += `
                    <div style="display: flex; margin-bottom: 10px; background: #f8f9fa; padding: 10px; border-radius: 6px;">
                        <span style="min-width: 120px; font-weight: 600; color: #2c3e50;">${change.field}:</span>
                        <span style="color: #e74c3c; text-decoration: line-through; margin-right: 15px;">${change.oldValue || 'empty'}</span>
                        <span style="color: #27ae60;">→ ${change.newValue || 'empty'}</span>
                    </div>
                `;
            }
        });
        
        detailsHtml += `</div>`;
    }
    
    if (request.reason) {
        detailsHtml += `
            <div style="background: #fff8e7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f39c12;">
                <span style="font-weight: 600; color: #f39c12;">📝 REASON PROVIDED:</span>
                <p style="margin: 8px 0 0 0; color: #2c3e50;">${request.reason}</p>
            </div>
        `;
    }
    
    detailsDiv.innerHTML = detailsHtml;
    document.getElementById('approvalActionTitle').innerHTML = `Review ${request.action} Request`;
    document.getElementById('approvalActionModal').style.display = 'flex';
}

async function loadAccountRequests() {
    try {
        const snapshot = await db.collection('account_requests')
            .where('status', '==', 'pending')
            .orderBy('requestedAt', 'desc')
            .get();
        
        return snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
    } catch (error) {
        console.error('Error loading account requests:', error);
        return [];
    }
}


async function rejectAccountRequest(requestId, requestData, reason) {
    try {
        await db.collection('account_requests').doc(requestId).update({
            status: 'rejected',
            rejectedAt: new Date().toISOString(),
            rejectedBy: getCurrentUser(),
            rejectionReason: reason
        });

        await logAudit('ACCOUNT_REJECTED', {
            username: requestData.username,
            fullName: requestData.fullName,
            rejectedBy: getCurrentUser(),
            reason: reason
        });

        sendRejectionEmail(requestData.email, requestData.fullName, reason);

        showNotification(`Account request for ${requestData.fullName} rejected`, 'info');
        
    } catch (error) {
        console.error('Error rejecting account:', error);
        alert('Failed to reject account: ' + error.message);
    }
}

function sendApprovalEmail(email, fullName) {
    console.log(`[EMAIL] Account approved for ${fullName} at ${email}`);
    
}

function sendRejectionEmail(email, fullName, reason) {
    console.log(`[EMAIL] Account rejected for ${fullName} at ${email}. Reason: ${reason}`);
    
}

    async function confirmApprovalWithSummary(approved) {
        const requestId = localStorage.getItem('currentApprovalRequestId');
        
        if (!requestId) {
            alert('No request selected');
            return;
        }

        try {
            const docRef = db.collection(COLLECTIONS.APPROVALS).doc(requestId);
            const doc = await docRef.get();
            
            if (!doc.exists) {
                alert('Request not found. It may have been already processed.');
                localStorage.removeItem('currentApprovalRequestId');
                return;
            }

            const request = { id: doc.id, ...doc.data() };
            
            let approvalMessage = '';
            if (request.changeSummary && request.changeSummary.length > 0) {
                approvalMessage = 'Changes to be applied:\n' + 
                    request.changeSummary.map(change => 
                        `- ${change.field}: "${change.oldValue}" → "${change.newValue}"`
                    ).join('\n');
            } else if (request.action === 'delete') {
                approvalMessage = `Delete ${request.type}: ${request.oldData?.name || request.requestedData?.name}`;
            } else if (request.action === 'add') {
                approvalMessage = `Add new ${request.type}: ${request.requestedData?.name}`;
            }
            
            if (approvalMessage && !confirm(`Are you sure you want to ${approved ? 'APPROVE' : 'REJECT'} this request?\n\n${approvalMessage}`)) {
                return;
            }
            
            if (approved) {
                if (request.action === 'delete') {
                    if (request.type === 'category') {
                        await db.collection(COLLECTIONS.CATEGORIES).doc(request.itemId).delete();
                        showNotification('Category deleted', 'success');
                    } else if (request.type === 'supplier') {
                        await db.collection(COLLECTIONS.SUPPLIERS).doc(request.itemId).delete();
                        showNotification('Supplier deleted', 'success');
                    } else if (request.type === 'link') {
                        await db.collection(COLLECTIONS.LINKS).doc(request.itemId).delete();
                        showNotification('Link deleted', 'success');
                    } else if (request.type === 'user') {
                        await db.collection(COLLECTIONS.USERS).doc(request.itemId).delete();
                        showNotification('User deleted', 'success');
                    }
                } else if (request.action === 'edit') {
                    if (request.type === 'category') {
                        await db.collection(COLLECTIONS.CATEGORIES).doc(request.itemId).update(request.requestedData);
                        showNotification('Category updated', 'success');
                    } else if (request.type === 'supplier') {
                        await db.collection(COLLECTIONS.SUPPLIERS).doc(request.itemId).update(request.requestedData);
                        showNotification('Supplier updated', 'success');
                    } else if (request.type === 'link') {
                        await db.collection(COLLECTIONS.LINKS).doc(request.itemId).update(request.requestedData);
                        showNotification('Link updated', 'success');
                    } else if (request.type === 'user') {
                        await db.collection(COLLECTIONS.USERS).doc(request.itemId).update(request.requestedData);
                        showNotification('User updated', 'success');
                    }
                } else if (request.action === 'add') {
                    if (request.type === 'user' || request.type === 'category' || request.type === 'supplier' || request.type === 'link') {
                        const collectionMap = {
                            'user': COLLECTIONS.USERS,
                            'category': COLLECTIONS.CATEGORIES,
                            'supplier': COLLECTIONS.SUPPLIERS,
                            'link': COLLECTIONS.LINKS
                        };
                        
                        await db.collection(collectionMap[request.type]).add(request.requestedData);
                        showNotification(`${request.type} added successfully`, 'success');
                    }
                }
            }

            await docRef.update({
                status: approved ? 'approved' : 'pending',
                reviewedBy: getCurrentUser(),
                reviewedAt: new Date().toISOString()
            });

            await logAudit(approved ? 'APPROVAL_GRANTED' : 'APPROVAL_PENDING', {
                requestId: requestId,
                type: request.type,
                action: request.action,
                requestedBy: request.requestedBy,
                changes: request.changeSummary,
                reason: request.reason
            });

            if (approved) {
                showNotification('Request approved successfully', 'success');
            }

            document.getElementById('approvalActionModal').style.display = 'none';
            document.getElementById('approvalRequestsModal').style.display = 'none';
            
            const modal = document.getElementById('requestsManagementModal');
            if (modal) modal.remove();
            
            await loadAllData(true);
            await loadApprovalRequests();
            
            const currentUser = getUser(getCurrentUser());
            if (currentUser && currentUser.role !== 'super admin') {
                await loadUserApprovalHistory();
            }
            
            renderCategories();
            applyRoleBasedUI();
            
            if (document.getElementById('categoryPageView').style.display === 'block') {
                const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
                renderSuppliersTable(categorySuppliers);
            }

        } catch (error) {
            console.error('Error:', error);
            alert('Failed to process request: ' + error.message);
        } finally {
            localStorage.removeItem('currentApprovalRequestId');
        }
    }

    window.confirmApproval = confirmApprovalWithSummary;
    async function confirmApproval(approved) {
        const requestId = localStorage.getItem('currentApprovalRequestId');
        
        if (!requestId) {
            alert('No request selected');
            return;
        }

        try {
            const docRef = db.collection(COLLECTIONS.APPROVALS).doc(requestId);
            const doc = await docRef.get();
            
            if (!doc.exists) {
                alert('Request not found. It may have been already processed.');
                localStorage.removeItem('currentApprovalRequestId');
                return;
            }

            const request = { id: doc.id, ...doc.data() };
            
            if (approved) {
                if (request.action === 'delete') {
                    if (request.type === 'category') {
                        await db.collection(COLLECTIONS.CATEGORIES).doc(request.itemId).delete();
                        showNotification('Category deleted', 'success');
                    } else if (request.type === 'supplier') {
                        await db.collection(COLLECTIONS.SUPPLIERS).doc(request.itemId).delete();
                        showNotification('Supplier deleted', 'success');
                    } else if (request.type === 'link') {
                        await db.collection(COLLECTIONS.LINKS).doc(request.itemId).delete();
                        showNotification('Link deleted', 'success');
                    } else if (request.type === 'user') {
                        await db.collection(COLLECTIONS.USERS).doc(request.itemId).delete();
                        showNotification('User deleted', 'success');
                    }
                } else if (request.action === 'edit') {
                    if (request.type === 'category') {
                        await db.collection(COLLECTIONS.CATEGORIES).doc(request.itemId).update(request.requestedData);
                        showNotification('Category updated', 'success');
                    } else if (request.type === 'supplier') {
                        await db.collection(COLLECTIONS.SUPPLIERS).doc(request.itemId).update(request.requestedData);
                        showNotification('Supplier updated', 'success');
                    } else if (request.type === 'link') {
                        await db.collection(COLLECTIONS.LINKS).doc(request.itemId).update(request.requestedData);
                        showNotification('Link updated', 'success');
                    } else if (request.type === 'user') {
                        await db.collection(COLLECTIONS.USERS).doc(request.itemId).update(request.requestedData);
                        showNotification('User updated', 'success');
                    }
                } else if (request.action === 'add') {
                    if (request.type === 'user' || request.type === 'category' || request.type === 'supplier' || request.type === 'link') {
                        // Add the item to the appropriate collection
                        const collectionMap = {
                            'user': COLLECTIONS.USERS,
                            'category': COLLECTIONS.CATEGORIES,
                            'supplier': COLLECTIONS.SUPPLIERS,
                            'link': COLLECTIONS.LINKS
                        };
                        
                        await db.collection(collectionMap[request.type]).add(request.requestedData);
                        showNotification(`${request.type} added successfully`, 'success');
                    }
                }
            }

            await docRef.update({
                status: approved ? 'approved' : 'pending',
                reviewedBy: getCurrentUser(),
                reviewedAt: new Date().toISOString()
            });

            await logAudit(approved ? 'APPROVAL_GRANTED' : 'APPROVAL_PENDING', {
                requestId: requestId,
                type: request.type,
                action: request.action,
                requestedBy: request.requestedBy,
                reason: request.reason
            });

            if (approved) {
                showNotification('Request approved successfully', 'success');
            }

            document.getElementById('approvalActionModal').style.display = 'none';
            document.getElementById('approvalRequestsModal').style.display = 'none';
            
            const modal = document.getElementById('requestsManagementModal');
            if (modal) modal.remove();
            
            await loadAllData(true);
            await loadApprovalRequests();
            
            const currentUser = getUser(getCurrentUser());
            if (currentUser && currentUser.role !== 'super admin') {
                await loadUserApprovalHistory();
            }
            
            renderCategories();
            applyRoleBasedUI();
            
            if (document.getElementById('categoryPageView').style.display === 'block') {
                const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
                renderSuppliersTable(categorySuppliers);
            }

        setTimeout(() => {
            loadApprovalRequests();
            updateRequestCounts();
        }, 500);

        } catch (error) {
            console.error('Error:', error);
            alert('Failed to process request: ' + error.message);
        } finally {
            localStorage.removeItem('currentApprovalRequestId');
        }
    }

    window.approveRequestNow = async function(requestId) {
        localStorage.setItem('currentApprovalRequestId', requestId);
        await confirmApproval(true);
        openRequestsManagement();
    };

    window.rejectRequestNow = async function(requestId) {
        localStorage.setItem('currentApprovalRequestId', requestId);
        openRejectReasonModal();
    };

    window.deleteRequestNow = async function(requestId) {
        if (!isCurrentUserSuperAdmin()) {
            alert('Only super admin can delete approval requests');
            return;
        }
        
        if (confirm('Delete this approval request permanently?')) {
            try {
                await db.collection(COLLECTIONS.APPROVALS).doc(requestId).delete();
                await loadApprovalRequests();
                showNotification('Approval request deleted', 'success');
            } catch (error) {
                console.error('Error deleting approval request:', error);
                alert('Failed to delete approval request: ' + error.message);
            }
        }
    };

    async function deleteApprovalRequest(requestId) {
        if (!isCurrentUserSuperAdmin()) {
            alert('Only super admin can delete approval requests');
            return;
        }
        
        if (confirm('Delete this approval request permanently?')) {
            try {
                await db.collection(COLLECTIONS.APPROVALS).doc(requestId).delete();
                await loadApprovalRequests();
                showNotification('Approval request deleted', 'success');
            } catch (error) {
                console.error('Error deleting approval request:', error);
                alert('Failed to delete approval request: ' + error.message);
            }
        }
    }

    function updateComplianceUI() {
    const tpinChecked = document.getElementById('complianceTpin')?.checked || false;
    const napsaChecked = document.getElementById('complianceNapsa')?.checked || false;
    const zraChecked = document.getElementById('complianceZra')?.checked || false;
    const zppaChecked = document.getElementById('complianceZppa')?.checked || false;
    const egpChecked = document.getElementById('complianceEgp')?.checked || false;
    
    const statusElements = {
        tpin: document.getElementById('complianceTpinStatus'),
        napsa: document.getElementById('complianceNapsaStatus'),
        zra: document.getElementById('complianceZraStatus'),
        zppa: document.getElementById('complianceZppaStatus'),
        egp: document.getElementById('complianceEgpStatus')
    };
    
    if (statusElements.tpin) {
        statusElements.tpin.textContent = tpinChecked ? 'Compliant' : 'Not Compliant';
        statusElements.tpin.style.background = tpinChecked ? '#2ecc71' : '#e74c3c';
    }
    if (statusElements.napsa) {
        statusElements.napsa.textContent = napsaChecked ? 'Compliant' : 'Not Compliant';
        statusElements.napsa.style.background = napsaChecked ? '#2ecc71' : '#e74c3c';
    }
    if (statusElements.zra) {
        statusElements.zra.textContent = zraChecked ? 'Compliant' : 'Not Compliant';
        statusElements.zra.style.background = zraChecked ? '#2ecc71' : '#e74c3c';
    }
    if (statusElements.zppa) {
        statusElements.zppa.textContent = zppaChecked ? 'Compliant' : 'Not Compliant';
        statusElements.zppa.style.background = zppaChecked ? '#2ecc71' : '#e74c3c';
    }
    if (statusElements.egp) {
        statusElements.egp.textContent = egpChecked ? 'Active' : 'Not Active';
        statusElements.egp.style.background = egpChecked ? '#2ecc71' : '#e74c3c';
    }
    
    const totalChecked = [tpinChecked, napsaChecked, zraChecked, zppaChecked, egpChecked].filter(Boolean).length;
    const percent = (totalChecked / 5) * 100;
    
    const percentEl = document.getElementById('overallCompliancePercent');
    const barEl = document.getElementById('overallComplianceBar');
    
    if (percentEl) percentEl.textContent = `${Math.round(percent)}%`;
    if (barEl) {
        barEl.style.width = `${percent}%`;
        barEl.className = `compliance-bar-fill ${percent >= 70 ? 'good' : percent >= 40 ? 'expiring' : 'poor'}`;
    }
}

    function handleDocumentUpload(docType, input) {
        const file = input.files[0];
        if (!file) return;
        
        if (file.size > 3 * 1024 * 1024) {
            alert(`File size exceeds 3MB limit for ${docType.toUpperCase()} document`);
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            uploadedDocuments[docType] = {
                name: file.name,
                type: file.type,
                size: file.size,
                data: e.target.result,
                uploadedAt: new Date().toISOString()
            };
            
            const previewEl = document.getElementById(`${docType}DocPreview`);
            if (previewEl) {
                previewEl.innerHTML = `<span style="color: var(--primary-green);">✓ ${file.name.substring(0, 20)}${file.name.length > 20 ? '...' : ''}</span>`;
            }
            
            if (docType === 'tpin') document.getElementById('complianceTpin').checked = true;
            if (docType === 'napsa') document.getElementById('complianceNapsa').checked = true;
            if (docType === 'zra') document.getElementById('complianceZra').checked = true;
            if (docType === 'zppa') document.getElementById('complianceZppa').checked = true;
            
            updateComplianceUI();
        };
        reader.readAsDataURL(file);
    }

    async function getAllUsers(forceRefresh = false) {
        try {
            userAccounts = await getCachedData('users', forceRefresh);
            console.log('Loaded users with documents:', userAccounts.map(u => ({
                username: u.username,
                hasDocs: !!u.documents,
                docKeys: u.documents ? Object.keys(u.documents) : []
            })));
        } catch (error) { 
            console.error("Error getting users:", error); 
        }
    }

    async function loadAllData(forceRefresh = false) {
        try {
            const [catData, supData, linkData] = await Promise.all([
                getCachedData('categories', forceRefresh),
                getCachedData('suppliers', forceRefresh),
                getCachedData('links', forceRefresh)
            ]);
            
            categories = catData;
            suppliers = supData;
            links = linkData;
            
            console.log("✅ Data loaded from " + (forceRefresh ? 'Firestore' : 'cache'));
        } catch (error) { 
            console.error("Error loading data:", error); 
        }
    }

    async function initializeFirestoreCollections() {
        try {
            const catSnap = await db.collection(COLLECTIONS.CATEGORIES).limit(1).get();
            if (catSnap.empty) {
                const defaultCategories = [
                    "Stationery & Office Supplies",
                    "ICT Equipment & Services",
                    "Cleaning Services & Materials",
                    "Catering & Refreshments",
                    "Furniture & Furnishings",
                    "Printing & Publishing",
                    "Construction & Maintenance",
                    "Transport & Logistics",
                    "Consultancy Services",
                    "Security Services"
                ];
                for (const name of defaultCategories) {
                    await db.collection(COLLECTIONS.CATEGORIES).add({ 
                        name, 
                        createdAt: new Date().toISOString() 
                    });
                }
                await logAudit('SYSTEM_INIT', { action: 'Default categories created' });
                console.log("Default categories created");
            }
            
            const linkSnap = await db.collection(COLLECTIONS.LINKS).limit(1).get();
            if (linkSnap.empty) {
                await db.collection(COLLECTIONS.LINKS).add({ 
                    institution: "Public Procurement Authority", 
                    website: "https://www.ppa.org.zm", 
                    email: "info@ppa.org.zm", 
                    createdAt: new Date().toISOString() 
                });
                await db.collection(COLLECTIONS.LINKS).add({ 
                    institution: "ZPPA", 
                    website: "https://www.zppa.org.zm", 
                    email: "director@zppa.org.zm", 
                    createdAt: new Date().toISOString() 
                });
                await logAudit('SYSTEM_INIT', { action: 'Default links created' });
                console.log("Default links created");
            }
        } catch (error) { 
            console.error("Error initializing collections:", error); 
        }
    }

    function togglePassword() {
        const pField = document.getElementById('passIn');
        if (pField) pField.type = pField.type === "password" ? "text" : "password";
    }

    async function handleLogin() {
        const username = document.getElementById('userIn').value.toUpperCase().trim();
        const password = document.getElementById('passIn').value.trim();
        
        if (!username || !password) { 
            alert("Username and password required."); 
            return; 
        }

        try {
            await getAllUsers(true);
            const user = userAccounts.find(u => u.username === username);
            
            if (user && user.password === password && user.enabled) {
                if (isSystemLocked() && user.role === 'staff') {
                    showLockScreen();
                    return;
                }
                
                localStorage.setItem('logged_user', username);
                localStorage.setItem('last_login', new Date().toDateString());
                
                if (isSystemLocked()) {
                    if (canAccessLockedSystem()) {
                        document.getElementById('timeWarning').style.display = 'block';
                        setTimeout(() => {
                            document.getElementById('timeWarning').style.display = 'none';
                        }, 5000);
                    }
                }

                if (user.id) {
                    await db.collection(COLLECTIONS.USERS).doc(user.id).update({
                        lastActive: new Date().toISOString()
                    });
                }

                await getAllUsers(true);
                await loadAllData(true);
                updateTotalSuppliersCounter();
                await initializeFirestoreCollections();
                await loadApprovalRequests();
                
                await logAudit('USER_LOGIN', { 
                    username: username,
                    role: user.role,
                    locked: isSystemLocked()
                });

                document.getElementById('loginOverlay').style.display = 'none';
                hideLoadingSpinner();
                updateGreeting();
                updateUserDisplay();
                applyRoleBasedUI();
                showView('home');
                startSessionHeartbeat();
                showNotification(`Welcome, ${username} (${user.role})`, 'success');
            } else {
                if (user && !user.enabled) {
                    alert("Your account has been disabled. Please contact super admin.");
                } else {
                    alert("Invalid username or password!");
                }
            }

            setTimeout(refreshPulses, 1000);
        } catch (error) {
            console.error("Login error:", error);
            alert("Login failed. Please try again.");
        }
    }

async function debugSupplierCount() {
    try {
        const snapshot = await db.collection(COLLECTIONS.SUPPLIERS).get();
        const allSuppliers = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        console.log('=== SUPPLIER DEBUG INFO ===');
        console.log(`Total documents in suppliers collection: ${allSuppliers.length}`);
        
        const nameGroups = {};
        allSuppliers.forEach(supplier => {
            const name = supplier.name || 'Unnamed';
            if (!nameGroups[name]) {
                nameGroups[name] = [];
            }
            nameGroups[name].push(supplier);
        });
        
        const uniqueNames = Object.keys(nameGroups).length;
        let duplicateCount = 0;
        let duplicateDetails = [];
        
        console.log(`Unique supplier names: ${uniqueNames}`);
        console.log('\n--- Suppliers by name ---');
        
        Object.entries(nameGroups).forEach(([name, suppliers]) => {
            if (suppliers.length > 1) {
                duplicateCount += suppliers.length - 1;
                duplicateDetails.push({
                    name: name,
                    count: suppliers.length,
                    ids: suppliers.map(s => s.id)
                });
                console.log(`❌ "${name}": ${suppliers.length} copies`);
            } else {
                console.log(`✅ "${name}": 1 copy`);
            }
        });
        
        console.log(`\nTotal duplicates found: ${duplicateCount}`);
        console.log('Duplicate details:', duplicateDetails);
        
        let message = `📊 SUPPLIER COUNT ANALYSIS\n\n`;
        message += `Total in database: ${allSuppliers.length}\n`;
        message += `Unique suppliers: ${uniqueNames}\n`;
        message += `Duplicate copies: ${duplicateCount}\n\n`;
        
        if (duplicateCount > 0) {
            message += `DUPLICATES FOUND:\n`;
            duplicateDetails.forEach(d => {
                message += `• "${d.name}" - ${d.count} copies\n`;
            });
            message += `\nYour total of 12 suppliers means you have ${uniqueNames} unique suppliers.`;
        } else {
            message += `✅ No duplicates found!`;
        }
        
        alert(message);
        
        const totalSuppliersEl = document.getElementById('totalSuppliersCount');
        if (totalSuppliersEl) {
            totalSuppliersEl.textContent = uniqueNames;
            totalSuppliersEl.style.color = '#ff9800';
            totalSuppliersEl.style.fontWeight = 'bold';
        }
        
        return { total: allSuppliers.length, unique: uniqueNames, duplicates: duplicateDetails };
        
    } catch (error) {
        console.error('Debug error:', error);
        alert('Error: ' + error.message);
    }
}

function updateTotalSuppliersCounter() {
    const totalSuppliersEl = document.getElementById('totalSuppliersCount');
    const totalCategoriesEl = document.getElementById('totalCategoriesCount');
    const avgRatingEl = document.getElementById('avgRatingDisplay');
    const compliantCountEl = document.getElementById('compliantCount');
    
    if (!totalSuppliersEl) return;
    
    let filteredSuppliers = suppliers;
    if (currentProvinceFilter !== 'All') {
        filteredSuppliers = suppliers.filter(s => s.province === currentProvinceFilter);
    }
    
    const uniqueSuppliers = [];
    const seenIds = new Set();
    
    filteredSuppliers.forEach(s => {
        if (!seenIds.has(s.id)) {
            seenIds.add(s.id);
            uniqueSuppliers.push(s);
        }
    });
    
    const finalUniqueSuppliers = [];
    const seenNames = new Set();
    
    uniqueSuppliers.forEach(s => {
        const nameKey = s.name?.toLowerCase().trim() || 'unnamed';
        if (!seenNames.has(nameKey)) {
            seenNames.add(nameKey);
            finalUniqueSuppliers.push(s);
        } else {
            console.log(`Duplicate supplier name found and filtered: ${s.name}`);
        }
    });
    
    const totalSuppliers = finalUniqueSuppliers.length;
    const rawTotal = filteredSuppliers.length;
    
    totalSuppliersEl.textContent = totalSuppliers;
    
    if (rawTotal > totalSuppliers) {
        totalSuppliersEl.innerHTML = `${totalSuppliers} <span style="font-size: 14px; color: #ff9800;">(${rawTotal - totalSuppliers} duplicates hidden)</span>`;
    }
    
    totalCategoriesEl.textContent = categories.length;
    
    if (totalSuppliers > 0) {
        const totalRating = finalUniqueSuppliers.reduce((sum, s) => sum + (s.rating || 0), 0);
        const avgRating = (totalRating / totalSuppliers).toFixed(1);
        avgRatingEl.textContent = avgRating;
    } else {
        avgRatingEl.textContent = '0.0';
    }
    
    const compliantSuppliers = finalUniqueSuppliers.filter(s => {
        if (!s.compliance) return false;
        const complianceItems = [
            s.compliance.tpin === 'yes',
            s.compliance.napsa === 'yes',
            s.compliance.zra === 'yes',
            s.compliance.zppa === 'yes',
            s.compliance.egp === 'yes'
        ];
        return complianceItems.filter(Boolean).length >= 4;
    }).length;
    
    compliantCountEl.textContent = compliantSuppliers;
    
    console.log(`Displaying ${totalSuppliers} unique suppliers out of ${rawTotal} in memory`);
}

async function removeDuplicateSuppliers() {
    if (!isCurrentUserSuperAdmin()) {
        alert('Only super admin can remove duplicates');
        return;
    }
    
    try {
        const snapshot = await db.collection(COLLECTIONS.SUPPLIERS).get();
        const allSuppliers = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        const nameGroups = {};
        allSuppliers.forEach(supplier => {
            const name = supplier.name?.toLowerCase().trim() || 'unnamed';
            if (!nameGroups[name]) {
                nameGroups[name] = [];
            }
            nameGroups[name].push(supplier);
        });
        
        const toDelete = [];
        const toKeep = [];
        
        Object.entries(nameGroups).forEach(([name, suppliers]) => {
            if (suppliers.length > 1) {
                suppliers.sort((a, b) => {
                    const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                    const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                    return dateB - dateA;
                });
                
                toKeep.push(suppliers[0]);
                for (let i = 1; i < suppliers.length; i++) {
                    toDelete.push(suppliers[i]);
                }
            } else {
                toKeep.push(suppliers[0]);
            }
        });
        
        if (toDelete.length === 0) {
            alert('No duplicate suppliers found!');
            return;
        }
        
        let confirmMessage = `Found ${toDelete.length} duplicate supplier(s):\n\n`;
        toDelete.forEach(d => {
            confirmMessage += `• "${d.name}" (ID: ${d.id.substring(0,8)}...)\n`;
        });
        confirmMessage += `\nKeep ${toKeep.length} unique suppliers.\n\nDelete these ${toDelete.length} duplicates?`;
        
        if (!confirm(confirmMessage)) return;
        
        const batch = db.batch();
        let batchCount = 0;
        
        toDelete.forEach(supplier => {
            batch.delete(db.collection(COLLECTIONS.SUPPLIERS).doc(supplier.id));
            batchCount++;
            
            if (batchCount >= 400) {
                batch.commit();
                batchCount = 0;
            }
        });
        
        if (batchCount > 0) {
            await batch.commit();
        }
        
        await logAudit('REMOVE_DUPLICATE_SUPPLIERS', {
            removed: toDelete.length,
            kept: toKeep.length,
            deletedBy: getCurrentUser()
        });
        
        await loadAllData(true);
        updateTotalSuppliersCounter();
        
        showNotification(`✅ Removed ${toDelete.length} duplicate suppliers. Now showing ${toKeep.length} unique suppliers.`, 'success');
        
    } catch (error) {
        console.error('Error removing duplicates:', error);
        alert('Error: ' + error.message);
    }
}

    function logout() {
        const username = getCurrentUser();
        logAudit('USER_LOGOUT', { username: username });
        
        localStorage.removeItem('logged_user');
        localStorage.removeItem('last_login');
        
        if (sessionHeartbeat) {
            clearInterval(sessionHeartbeat);
            sessionHeartbeat = null;
        }

        ['homeView','categoryPageView','aboutView','contactView','linksView','auditLogsView','userApprovalHistoryView'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });

        hideLockScreen();
        document.getElementById('loginOverlay').style.display = 'flex';
        document.getElementById('userIn').value = '';
        document.getElementById('passIn').value = '';
        document.getElementById('timeWarning').style.display = 'none';
    }

    function applyRoleBasedUI() {
    const user = getUser(getCurrentUser());
    if (!user) return;

    const isSuper = (user.role === 'super admin');
    const isAdmin = (user.role === 'admin');
    const isStaff = (user.role === 'staff');

    document.querySelectorAll('.exclusive-super').forEach(el => {
        el.style.display = isSuper ? 'inline-block' : 'none';
    });

    const auditLogsBtn = document.getElementById('auditLogsNavBtn');
    if (auditLogsBtn) {
        auditLogsBtn.style.display = (isSuper || isAdmin) ? 'inline-block' : 'none';
    }

    document.getElementById('userMgmtBtn').style.display = 'inline-block';
    
    document.getElementById('sessionsBtn').style.display = canViewSessions() ? 'inline-block' : 'none';
    
const approvalsBtn = document.getElementById('approvalRequestsNavBtn');
if (approvalsBtn) {
    approvalsBtn.style.display = 'none'; // Always hidden
}

    const historyBtn = document.getElementById('approvalHistoryNavBtn');
    if (historyBtn) {
        if (getCurrentUser() && !isSuper) {
            historyBtn.style.display = 'inline-block';
        } else {
            historyBtn.style.display = 'none';
        }
    }

    const requestsBtn = document.getElementById('requestsManagementBtn');
    if (requestsBtn) {
        requestsBtn.style.display = isSuper ? 'inline-block' : 'none';
    }

    const newCategoryBtn = document.getElementById('newCategoryBtn');
    if (newCategoryBtn) {
        newCategoryBtn.style.display = canCreateCategory() ? 'inline-block' : 'none';
    }

    const categoryNewCategoryBtn = document.getElementById('categoryNewCategoryBtn');
    if (categoryNewCategoryBtn) {
        categoryNewCategoryBtn.style.display = canCreateCategory() ? 'inline-block' : 'none';
    }

    const categoryNewSupplierBtn = document.getElementById('categoryNewSupplierBtn');
    if (categoryNewSupplierBtn) {
        categoryNewSupplierBtn.style.display = canCreateSupplier() ? 'inline-block' : 'none';
    }

    const editCategoryBtn = document.getElementById('editCategoryBtn');
    if (editCategoryBtn) {
        editCategoryBtn.style.display = canEditCategory() ? 'inline-block' : 'none';
    }

    const newSupplierBtn = document.getElementById('newSupplierBtn');
    if (newSupplierBtn) {
        newSupplierBtn.style.display = canCreateSupplier() ? 'inline-block' : 'none';
    }

    const addLinkBtn = document.getElementById('addLinkBtn');
    if (addLinkBtn) {
        addLinkBtn.style.display = canCreateLink() ? 'inline-block' : 'none';
    }

    renderCategories();
    renderLinks();
    updateRequestCounts();
    setTimeout(refreshPulses, 500);
}

    function startSessionHeartbeat() {
        if (sessionHeartbeat) clearInterval(sessionHeartbeat);
        sessionHeartbeat = setInterval(async () => {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const user = getUser(currentUser);
            if (user && user.id) {
                try {
                    await db.collection(COLLECTIONS.USERS).doc(user.id).update({
                        lastActive: new Date().toISOString()
                    });
                    await getAllUsers(true);
                } catch (error) {
                    console.error("Heartbeat error:", error);
                }
            }
        }, 30000);
    }

    function openCategoryModal() {
        if (!canCreateCategory() && !canEditCategory()) {
            alert('You do not have permission to create/edit categories');
            return;
        }
        
        const isEdit = document.getElementById('editingCategoryId').value;
        document.getElementById('categoryModalTitle').innerHTML = isEdit ? '✏️ Edit Category' : '➕ Add New Category';
        document.getElementById('categoryModalSaveBtn').innerHTML = isEdit ? 'Update Category' : 'Create Category';
        document.getElementById('categoryNameInput').value = isEdit ? categories.find(c => c.id === document.getElementById('editingCategoryId').value)?.name || '' : '';
        document.getElementById('categoryModal').style.display = 'flex';
    }

    function closeCategoryModal() {
        document.getElementById('categoryModal').style.display = 'none';
        document.getElementById('editingCategoryId').value = '';
        document.getElementById('categoryNameInput').value = '';
    }

    function editCurrentCategory() {
        if (!canEditCategory()) {
            alert('You do not have permission to edit categories');
            return;
        }
        
        const category = categories.find(c => c.name === currentCategory);
        if (!category) return;
        
        document.getElementById('editingCategoryId').value = category.id;
        openCategoryModal();
    }

    async function saveNewCategory() {
        if (!canCreateCategory() && !canEditCategory()) {
            alert('You do not have permission to create/edit categories');
            return;
        }

        const name = document.getElementById('categoryNameInput').value.trim();
        const editingId = document.getElementById('editingCategoryId').value;
        
        if (!name) {
            alert('Category name is required');
            return;
        }

        try {
            if (editingId) {
                const oldCategory = categories.find(c => c.id === editingId);
                
                if (canEditCategoryWithoutApproval()) {
                    await db.collection(COLLECTIONS.CATEGORIES).doc(editingId).update({
                        name: name,
                        lastModifiedBy: getCurrentUser(),
                        lastModifiedAt: new Date().toISOString()
                    });

                    await logAudit('UPDATE_CATEGORY', { 
                        categoryId: editingId,
                        oldName: oldCategory?.name,
                        newName: name,
                        updatedBy: getCurrentUser()
                    });

                    await loadAllData(true);
                    renderCategories();
                    closeCategoryModal();
                    showNotification(`Category updated to "${name}" successfully`, 'success');
                    populateCategoryDropdown();
                    
                    if (document.getElementById('categoryPageView').style.display === 'block') {
                        document.getElementById('categoryTitle').textContent = name;
                    }
                } else {
                    await createApprovalRequest('category', { name: name }, 'edit', editingId);
                    closeCategoryModal();
                    showNotification('Category edit request submitted for approval', 'info');
                }
            } else {
                if (canCreateCategoryWithoutApproval()) {
                    await db.collection(COLLECTIONS.CATEGORIES).add({
                        name: name,
                        createdAt: new Date().toISOString(),
                        createdBy: getCurrentUser()
                    });

                    await logAudit('CREATE_CATEGORY', { 
                        name: name,
                        createdBy: getCurrentUser()
                    });

                    await loadAllData(true);
                    renderCategories();
                    closeCategoryModal();
                    showNotification(`Category "${name}" created successfully`, 'success');
                    populateCategoryDropdown();
                } else {
                    await createApprovalRequest('category', { name: name }, 'add', null);
                    closeCategoryModal();
                    showNotification('Category creation request submitted for approval', 'info');
                }
            }
        } catch (error) {
            console.error('Error saving category:', error);
            alert('Failed to save category: ' + error.message);
        }
    }

    async function deleteCategory(categoryId) {
        if (!canDeleteCategory()) {
            alert('You do not have permission to delete categories');
            return;
        }

        const category = categories.find(c => c.id === categoryId);
        if (!category) return;

        const currentUser = getUser(getCurrentUser());

        if (currentUser.role === 'super admin') {
            if (confirm(`Delete category "${category.name}"?`)) {
                try {
                    await db.collection(COLLECTIONS.CATEGORIES).doc(categoryId).delete();
                    await logAudit('DELETE_CATEGORY', { 
                        categoryId, 
                        name: category.name,
                        deletedBy: getCurrentUser() 
                    });
                    await loadAllData(true);
                    renderCategories();
                    showNotification('Category deleted', 'success');
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to delete');
                }
            }
        } else {
            openReasonModal('category', categoryId, category.name, async (type, id, name, reason) => {
                await createApprovalRequest('category', { name: name }, 'delete', id, reason);
                showNotification('Delete request submitted for approval', 'info');
            });
        }
    }

    function renderCategories() {
    renderFilteredCategories();
}

async function fixSupplierCount() {
    try {
        const snapshot = await db.collection(COLLECTIONS.SUPPLIERS).get();
        const allSuppliers = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        console.log(`Total suppliers in database: ${allSuppliers.length}`);
        
        const supplierMap = new Map();
        const duplicates = [];
        
        allSuppliers.forEach(supplier => {
            const name = supplier.name?.toLowerCase().trim();
            if (supplierMap.has(name)) {
                duplicates.push({
                    duplicate: supplier,
                    original: supplierMap.get(name)
                });
            } else {
                supplierMap.set(name, supplier);
            }
        });
        
        if (duplicates.length > 0) {
            console.log(`Found ${duplicates.length} duplicate suppliers`);
            
            if (confirm(`Found ${duplicates.length} duplicate suppliers. Do you want to remove duplicates?`)) {
                const batch = db.batch();
                let removedCount = 0;
                
                duplicates.forEach(({ duplicate }) => {
                    batch.delete(db.collection(COLLECTIONS.SUPPLIERS).doc(duplicate.id));
                    removedCount++;
                });
                
                await batch.commit();
                console.log(`Removed ${removedCount} duplicate suppliers`);
                
                await loadAllData(true);
                showNotification(`Removed ${removedCount} duplicate suppliers`, 'success');
            }
        } else {
            showNotification('No duplicate suppliers found', 'success');
        }
        
        updateTotalSuppliersCounter();
        
    } catch (error) {
        console.error('Error fixing supplier count:', error);
        alert('Error: ' + error.message);
    }
}

function updateTotalSuppliersCounter() {
    const totalSuppliersEl = document.getElementById('totalSuppliersCount');
    const totalCategoriesEl = document.getElementById('totalCategoriesCount');
    const avgRatingEl = document.getElementById('avgRatingDisplay');
    const compliantCountEl = document.getElementById('compliantCount');
    
    if (!totalSuppliersEl) return;
    
    // Apply province filter
    let filteredSuppliers = suppliers;
    if (currentProvinceFilter !== 'All') {
        filteredSuppliers = suppliers.filter(s => s.province === currentProvinceFilter);
    }
    
    const uniqueSuppliers = [];
    const seenIds = new Set();
    
    filteredSuppliers.forEach(s => {
        if (!seenIds.has(s.id)) {
            seenIds.add(s.id);
            uniqueSuppliers.push(s);
        }
    });
    
    const totalSuppliers = uniqueSuppliers.length;
    totalSuppliersEl.textContent = totalSuppliers;
    
    // Total categories
    totalCategoriesEl.textContent = categories.length;
    
    if (totalSuppliers > 0) {
        const totalRating = uniqueSuppliers.reduce((sum, s) => sum + (s.rating || 0), 0);
        const avgRating = (totalRating / totalSuppliers).toFixed(1);
        avgRatingEl.textContent = avgRating;
    } else {
        avgRatingEl.textContent = '0.0';
    }
    
    const compliantSuppliers = uniqueSuppliers.filter(s => {
        if (!s.compliance) return false;
        const complianceItems = [
            s.compliance.tpin === 'yes',
            s.compliance.napsa === 'yes',
            s.compliance.zra === 'yes',
            s.compliance.zppa === 'yes',
            s.compliance.egp === 'yes'
        ];
        return complianceItems.filter(Boolean).length >= 4;
    }).length;
    
    compliantCountEl.textContent = compliantSuppliers;
    
    console.log(`Displaying ${totalSuppliers} unique suppliers out of ${filteredSuppliers.length} in memory`);
}

    function openSupplierModal() {
        if (!canCreateSupplier()) {
            alert('You do not have permission to add suppliers');
            return;
        }

        document.getElementById('supplierModalTitle').innerHTML = '➕ Add New Supplier';
        document.getElementById('supplierName').value = '';
        document.getElementById('supplierSpecialization').value = '';
        document.getElementById('supplierPhone').value = '';
        document.getElementById('supplierTpin').value = '';
        document.getElementById('supplierEmail').value = '';
        document.getElementById('supplierAddress').value = '';
        document.getElementById('editingSupplierId').value = '';
        document.getElementById('supplierActionType').value = 'add';
        
        document.getElementById('star3').checked = true;
        
        document.getElementById('complianceTpin').checked = false;
        document.getElementById('complianceNapsa').checked = false;
        document.getElementById('complianceZra').checked = false;
        document.getElementById('complianceZppa').checked = false;
        
        document.getElementById('supplierRenewalMonth').value = '11';

        document.getElementById('supplierProvince').value = '';
        
        uploadedDocuments = { tpin: null, napsa: null, zra: null, zppa: null };
        ['tpin', 'napsa', 'zra', 'zppa'].forEach(type => {
            const previewEl = document.getElementById(`${type}DocPreview`);
            if (previewEl) previewEl.innerHTML = '';
        });
        
        updateComplianceUI();
        populateCategoryDropdown();
        document.getElementById('supplierModal').style.display = 'flex';
        document.getElementById('supplierProvince').value = '';
    }

    function populateCategoryDropdown() {
        const select = document.getElementById('supplierCategory');
        if (!select) return;
        
        select.innerHTML = '<option value="">Select Category</option>';
        categories.forEach(cat => {
            select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
        });
    }

    function closeSupplierModal() {
        document.getElementById('supplierModal').style.display = 'none';
    }

    async function saveSupplier() {
        if (!canCreateSupplier() && !canEditSupplier()) {
            alert('You do not have permission to save suppliers');
            return;
        }

        const name = document.getElementById('supplierName').value.trim();
        const phone = document.getElementById('supplierPhone').value.trim();
        const category = document.getElementById('supplierCategory').value;
        
        if (!name || !phone || !category) {
            alert('Supplier Name, Phone Number, and Category are required');
            return;
        }

        let rating = 3;
        const ratingInputs = document.querySelectorAll('input[name="rating"]');
        for (let input of ratingInputs) {
            if (input.checked) {
                rating = parseInt(input.value);
                break;
            }
        }

        const renewalYear = document.getElementById('supplierRenewalYear').value;
        const renewalMonth = document.getElementById('supplierRenewalMonth').value;
        const renewalDate = new Date(renewalYear, parseInt(renewalMonth), 31).toISOString();

        const compliance = {
            tpin: document.getElementById('complianceTpin').checked ? 'yes' : 'no',
            napsa: document.getElementById('complianceNapsa').checked ? 'yes' : 'no',
            zra: document.getElementById('complianceZra').checked ? 'yes' : 'no',
            zppa: document.getElementById('complianceZppa').checked ? 'yes' : 'no'
        };

        const documents = [];
        for (let [type, doc] of Object.entries(uploadedDocuments)) {
            if (doc) {
                documents.push({
                    type: type,
                    name: doc.name,
                    size: doc.size,
                    uploadedAt: doc.uploadedAt,
                    data: doc.data
                });
            }
        }

        const supplierData = {
            name: name,
            specialization: document.getElementById('supplierSpecialization').value.trim(),
            phone: phone,
            tpin: document.getElementById('supplierTpin').value.trim(),
            email: document.getElementById('supplierEmail').value.trim(),
            address: document.getElementById('supplierAddress').value.trim(),
            category: category,
            rating: rating,
            compliance: compliance,
            renewalDate: renewalDate,
            documents: documents,
            images: [],
            lastModifiedBy: getCurrentUser(),
            lastModifiedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        const editingId = document.getElementById('editingSupplierId').value;
        const actionType = document.getElementById('supplierActionType').value;
        const currentUser = getUser(getCurrentUser());

        try {
            if (actionType === 'edit' && editingId) {
                const oldSupplier = suppliers.find(s => s.id === editingId);
                
                if (currentUser.role === 'super admin' || currentUser.role === 'admin') {
                    await db.collection(COLLECTIONS.SUPPLIERS).doc(editingId).update(supplierData);
                    
                    const changes = {};
                    if (oldSupplier) {
                        for (let key in supplierData) {
                            if (JSON.stringify(oldSupplier[key]) !== JSON.stringify(supplierData[key])) {
                                changes[key] = { old: oldSupplier[key], new: supplierData[key] };
                            }
                        }
                    }
                    
                    await logAudit('UPDATE_SUPPLIER', {
                        supplierId: editingId,
                        name: name,
                        updatedBy: getCurrentUser(),
                        changes: changes
                    });

                    showNotification('Supplier updated successfully', 'success');
                } else {
                    await createApprovalRequest('supplier', supplierData, 'edit', editingId);
                    closeSupplierModal();
                    showNotification('Supplier edit request submitted for approval', 'info');
                    return;
                }
            } else {
                if (currentUser.role === 'super admin' || currentUser.role === 'admin') {
                    await db.collection(COLLECTIONS.SUPPLIERS).add({
                        ...supplierData,
                        createdAt: new Date().toISOString(),
                        createdBy: getCurrentUser()
                    });

                    await logAudit('CREATE_SUPPLIER', {
                        name: name,
                        category: category,
                        createdBy: getCurrentUser()
                    });

                    showNotification('Supplier added successfully', 'success');
                } else {
                    await createApprovalRequest('supplier', supplierData, 'add', null);
                    closeSupplierModal();
                    showNotification('Supplier addition request submitted for approval', 'info');
                    return;
                }
            }

            await loadAllData(true);
            closeSupplierModal();

            if (document.getElementById('categoryPageView').style.display === 'block') {
                const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
                renderSuppliersTable(categorySuppliers);
            }
        } catch (error) {
            console.error('Error saving supplier:', error);
            alert('Failed to save supplier: ' + error.message);
        }
    }

    function editSupplier(supplierId) {
        if (!canEditSupplier()) {
            alert('You do not have permission to edit suppliers');
            return;
        }

        const supplier = suppliers.find(s => s.id === supplierId);
        if (!supplier) return;

        document.getElementById('supplierModalTitle').innerHTML = '✏️ Edit Supplier';
        document.getElementById('supplierName').value = supplier.name || '';
        document.getElementById('supplierSpecialization').value = supplier.specialization || '';
        document.getElementById('supplierProvince').value = supplier.province || '';
        document.getElementById('supplierPhone').value = supplier.phone || '';
        document.getElementById('supplierTpin').value = supplier.tpin || '';
        document.getElementById('supplierEmail').value = supplier.email || '';
        document.getElementById('supplierAddress').value = supplier.address || '';
        document.getElementById('editingSupplierId').value = supplierId;
        document.getElementById('supplierActionType').value = 'edit';
        
        populateCategoryDropdown();
        setTimeout(() => {
            document.getElementById('supplierCategory').value = supplier.category || '';
        }, 100);

        document.getElementById('supplierProvince').value = supplier.province || '';
        
        const rating = supplier.rating || 3;
        document.querySelectorAll('input[name="rating"]').forEach(input => {
            input.checked = parseInt(input.value) === rating;
        });
        
        document.getElementById('complianceTpin').checked = supplier.compliance?.tpin === 'yes';
        document.getElementById('complianceNapsa').checked = supplier.compliance?.napsa === 'yes';
        document.getElementById('complianceZra').checked = supplier.compliance?.zra === 'yes';
        document.getElementById('complianceZppa').checked = supplier.compliance?.zppa === 'yes';
        
        if (supplier.renewalDate) {
            const date = new Date(supplier.renewalDate);
            document.getElementById('supplierRenewalMonth').value = date.getMonth().toString();
            document.getElementById('supplierRenewalYear').value = date.getFullYear().toString();
        }
        
        updateComplianceUI();
        
        uploadedDocuments = { tpin: null, napsa: null, zra: null, zppa: null };
        ['tpin', 'napsa', 'zra', 'zppa'].forEach(type => {
            const previewEl = document.getElementById(`${type}DocPreview`);
            if (previewEl) previewEl.innerHTML = '';
        });
        
        document.getElementById('supplierModal').style.display = 'flex';
    }

    async function deleteSupplier(supplierId) {
        if (!canDeleteSupplier()) {
            alert('You do not have permission to delete suppliers');
            return;
        }

        const supplier = suppliers.find(s => s.id === supplierId);
        if (!supplier) return;

        const currentUser = getUser(getCurrentUser());

        if (currentUser.role === 'super admin') {
            if (confirm(`Delete supplier "${supplier.name}"?`)) {
                try {
                    await db.collection(COLLECTIONS.SUPPLIERS).doc(supplierId).delete();
                    await logAudit('DELETE_SUPPLIER', { 
                        supplierId, 
                        name: supplier.name,
                        deletedBy: getCurrentUser() 
                    });
                    await loadAllData(true);
                    showNotification('Supplier deleted', 'success');
                    
                    if (document.getElementById('categoryPageView').style.display === 'block') {
                        const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
                        renderSuppliersTable(categorySuppliers);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to delete');
                }
            }
        } else {
            openReasonModal('supplier', supplierId, supplier.name, async (type, id, name, reason) => {
                await createApprovalRequest('supplier', { name: name }, 'delete', id, reason);
                showNotification('Delete request submitted for approval', 'info');
            });
        }
    }

    function openCategoryPage(categoryId) {
    const category = categories.find(cat => cat.id === categoryId);
    if (!category) return;
    currentCategory = category.name;
    currentCategoryId = categoryId;
    document.getElementById('categoryTitle').textContent = category.name;

    let categorySuppliers = suppliers.filter(s => s.category === category.name);
    if (currentProvinceFilter !== 'All') {
        categorySuppliers = categorySuppliers.filter(s => s.province === currentProvinceFilter);
    }
    
    renderSuppliersTable(categorySuppliers);
    showView('category');
}

function renderSuppliersTable(suppliersList) {
    const tbody = document.getElementById('supplierTableBody');
    if (!tbody) return;

    const user = getUser(getCurrentUser());

    if (!suppliersList || suppliersList.length === 0) {
    tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 20px;">No suppliers found in this category.</td></tr>';
    return;
}

    tbody.innerHTML = suppliersList.map((s, index) => {
        const daysRemaining = getDaysRemaining(s);
        const renewalClass = daysRemaining < 0 ? 'expired' : daysRemaining < 30 ? 'expiring' : '';
        const canEdit = canEditSupplier();
        const canDelete = canDeleteSupplier();
        const isSuperAdmin = user && user.role === 'super admin';
        const historyId = `history-${s.id}`;
        const docThumbnail = createDocumentThumbnail(
            s.documents ? { docs: s.documents } : null, 
            'supplier', 
            s.id, 
            s.name
        );

        return `
            <tr>
                <td>${s.name || ''}</td>
                <td>${s.specialization || ''}</td>
                <td>${s.province || 'Not specified'}</td>
                <td><a href="https://wa.me/${s.phone?.replace(/\D/g, '')}" target="_blank" class="clickable-phone" title="Open WhatsApp">${s.phone || ''}</a></td>
                <td><a href="https://portal.zra.org.zm/searchTaxpayer" target="_blank" class="clickable-tpin" title="Search on ZRA Portal">${s.tpin || ''}</a></td>
                <td><a href="mailto:${s.email || ''}" class="clickable-email" title="Send Email">${s.email || ''}</a></td>
                <td>${s.address || ''}</td>
                <td><div class="star-rating-view">${renderStars(s.rating || 0)}<span class="rating-value">${s.rating || 0}/5</span></div></td>
                <td><div class="compliance-box">${renderCompliancePills(s)}</div></td>
                <td>
                    <div class="vertical-life-bar-container">
                        <div class="vertical-life-bar-fill ${renewalClass}" style="height:${calculateRenewalPercentage(s)}%"></div>
                        <div class="vertical-life-bar-text">${daysRemaining}d</div>
                    </div>
                </td>
                <td>
                    <div style="display: flex; justify-content: center;">
                        ${docThumbnail}
                    </div>
                </td>
                <td>
                    <div class="action-buttons">
                        ${canEdit ? `<button class="btn-edit" onclick="editSupplier('${s.id}')">Edit</button>` : ''}
                        ${canDelete && isSuperAdmin ? `<button class="btn-del" onclick="deleteSupplier('${s.id}')">Delete</button>` : ''}
                        ${canDelete && !isSuperAdmin ? `<button class="btn-request-delete" onclick="deleteSupplier('${s.id}')">Request Delete</button>` : ''}
                        <button class="btn-view" onclick="toggleHistory('${historyId}')" style="background: #3498db; padding: 5px 10px; font-size: 12px; border-radius: 4px; color: white; border: none; cursor: pointer;">
                            📋 History
                        </button>
                    </div>
                </td>
            </tr>
            <!-- HISTORY SECTION - HIDDEN BY DEFAULT -->
            <tr id="${historyId}" class="history-row" style="display: none;">
                <td colspan="11" style="padding: 0; background: transparent;">
                    <div style="margin: 10px 20px 30px 20px; padding: 20px; background: #f8fafc; border-radius: 16px; border-left: 6px solid #173979;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #173979; font-size: 16px; font-weight: 600;">
                                📋 Activity History for ${s.name}
                            </h4>
                            <div>
                                <span style="background: #173979; color: white; padding: 4px 12px; border-radius: 30px; font-size: 12px; margin-right: 10px;">
                                    Last: ${formatDate(s.lastModifiedAt || s.createdAt)}
                                </span>
                                <button onclick="toggleHistory('${historyId}')" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #666;">✕</button>
                            </div>
                        </div>
                        ${renderSupplierHistory(s)}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function toggleHistory(historyId) {
    const historyRow = document.getElementById(historyId);
    if (historyRow) {
        if (historyRow.style.display === 'none') {
            historyRow.style.display = 'table-row';
        } else {
            historyRow.style.display = 'none';
        }
    }
}

function renderSupplierHistory(supplier) {
    const modifications = supplier.modifications || [];
    
    if (modifications.length === 0) {
        return `
            <div style="text-align: center; padding: 30px; color: #999; background: white; border-radius: 12px;">
                <span style="font-size: 24px; display: block; margin-bottom: 10px;">📭</span>
                No activity history yet
            </div>
        `;
    }

    const recentMods = modifications.slice(0, 10);
    
    return recentMods.map((mod, index) => {
        const modDate = mod.modifiedAt ? new Date(mod.modifiedAt).toLocaleString() : '';
        const actionColor = mod.action === 'delete' ? '#e74c3c' : 
                           mod.action === 'create' ? '#27ae60' : '#f39c12';
        
        return `
            <div style="margin-bottom: ${index === recentMods.length - 1 ? '0' : '15px'}; 
                        padding: 15px; 
                        background: white; 
                        border-radius: 12px; 
                        box-shadow: 0 2px 8px rgba(0,0,0,0.02);
                        border-left: 4px solid ${actionColor};">
                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px; flex-wrap: wrap;">
                    <span style="background: ${actionColor}; color: white; padding: 4px 16px; border-radius: 30px; font-size: 11px; font-weight: 700; text-transform: uppercase;">
                        ${mod.action || 'UPDATE'}
                    </span>
                    <span style="color: #173979; font-weight: 600; font-size: 14px;">
                        👤 ${mod.modifiedBy || 'SYSTEM'}
                    </span>
                    <span style="color: #666; font-size: 12px;">
                        🕐 ${modDate}
                    </span>
                </div>
                <div style="font-size: 14px; color: #2c3e50; line-height: 1.6;">
                    ${mod.description || (mod.field ? 
                        `<span style="font-weight: 500;">${mod.field}:</span> 
                         <span style="color: #e74c3c; text-decoration: line-through; background: #fee9e7; padding: 2px 8px; border-radius: 4px; margin: 0 8px;">${mod.old || 'empty'}</span> 
                         → 
                         <span style="color: #27ae60; background: #e8f8f5; padding: 2px 8px; border-radius: 4px;">${mod.new || 'empty'}</span>` 
                        : 'Activity recorded')}
                </div>
            </div>
        `;
    }).join('');
}

    function renderLinks() {
        const tbody = document.getElementById('linksBody');
        if (!tbody) return;

        const user = getUser(getCurrentUser());
        const canDelete = canDeleteLink();
        const isSuperAdmin = user && user.role === 'super admin';

        if (!links || links.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No links found.</td></tr>';
            return;
        }

        tbody.innerHTML = links.map(link => `
            <tr>
                <td>${link.institution || ''}</td>
                <td><a href="${link.website}" target="_blank">${link.website}</a></td>
                <td>${link.email || ''}</td>
                <td>
                    <div class="action-buttons">
                        ${canDelete && isSuperAdmin ? 
                            `<button class="btn-del" onclick="deleteLink('${link.id}')">Delete</button>` : 
                            canDelete && !isSuperAdmin ? 
                            `<button class="btn-request-delete" onclick="deleteLink('${link.id}')">Request Delete</button>` : 
                            '—'}
                    </div>
                </td>
            </tr>
        `).join('');
    }

    async function addLink() {
        if (!canCreateLink()) {
            alert('You do not have permission to add links');
            return;
        }

        const institution = document.getElementById('instName').value.trim();
        const website = document.getElementById('instWeb').value.trim();
        const email = document.getElementById('instEmail').value.trim();
        const currentUser = getUser(getCurrentUser());
        
        if (!institution || !website) {
            alert("Institution and website are required");
            return;
        }

        try {
            if (currentUser.role === 'super admin' || currentUser.role === 'admin') {
                const newLink = {
                    institution,
                    website,
                    email,
                    createdAt: new Date().toISOString(),
                    createdBy: getCurrentUser()
                };
                
                await db.collection(COLLECTIONS.LINKS).add(newLink);
                await logAudit('CREATE_LINK', { institution, website, email, createdBy: getCurrentUser() });
                await loadAllData(true);
                renderLinks();
                closeLinkModal();
                showNotification('Link added successfully');
            } else {
                await createApprovalRequest('link', { institution, website, email }, 'add', null);
                closeLinkModal();
                showNotification('Link addition request submitted for approval', 'info');
            }
        } catch (error) {
            console.error("Error adding link:", error);
            alert("Failed to add link");
        }
    }

    async function deleteLink(id) {
        if (!canDeleteLink()) {
            alert("You don't have permission to delete links");
            return;
        }

        const link = links.find(l => l.id === id);
        if (!link) return;

        const currentUser = getUser(getCurrentUser());

        if (currentUser.role === 'super admin') {
            if (confirm('Are you sure you want to delete this link?')) {
                try {
                    await db.collection(COLLECTIONS.LINKS).doc(id).delete();
                    await logAudit('DELETE_LINK', { 
                        institution: link?.institution,
                        website: link?.website,
                        deletedBy: getCurrentUser() 
                    });
                    await loadAllData(true);
                    renderLinks();
                    showNotification('Link deleted successfully');
                } catch (error) {
                    console.error("Error deleting link:", error);
                    alert("Failed to delete link");
                }
            }
        } else {
            openReasonModal('link', id, link.institution, async (type, id, name, reason) => {
                await createApprovalRequest('link', { name: name }, 'delete', id, reason);
                showNotification('Delete request submitted for approval', 'info');
            });
        }
    }

    function getChangeSummary(oldData, newData, excludeFields = ['id', 'createdAt', 'updatedAt', 'lastModifiedAt', 'lastModifiedBy', 'createdBy']) {
        const changes = [];
        const allKeys = new Set([...Object.keys(oldData || {}), ...Object.keys(newData || {})]);
        
        for (const key of allKeys) {
            if (excludeFields.includes(key)) continue;
            
            const oldValue = oldData?.[key];
            const newValue = newData?.[key];
            
            if (!oldValue && !newValue) continue;
            
            if (typeof oldValue === 'object' && typeof newValue === 'object' && oldValue !== null && newValue !== null) {
                const nestedChanges = getChangeSummary(oldValue, newValue, []);
                if (nestedChanges.length > 0) {
                    changes.push({
                        field: key,
                        oldValue: oldValue,
                        newValue: newValue,
                        type: 'object',
                        nestedChanges: nestedChanges
                    });
                }
            }

            else if (JSON.stringify(oldValue) !== JSON.stringify(newValue)) {
                changes.push({
                    field: key,
                    oldValue: oldValue || '(empty)',
                    newValue: newValue || '(empty)',
                    type: 'primitive'
                });
            }
        }
        
        return changes;
    }

    async function createApprovalRequestWithChanges(type, newData, action, itemId, reason = null, oldData = null) {
        try {
            const currentUser = getUser(getCurrentUser());
            if (!currentUser) {
                alert('You must be logged in to create a request');
                return;
            }

            console.log(`Creating ${action} request for ${type}:`, newData);
            
            let changeSummary = null;
            let changeDescription = '';
            
            if (action === 'edit' && oldData) {
                const changes = getChangeSummary(oldData, newData);
                changeSummary = changes;
                
                if (changes.length > 0) {
                    changeDescription = changes.map(change => {
                        if (change.type === 'object' && change.nestedChanges) {
                            const nestedDesc = change.nestedChanges.map(n => 
                                `${n.field}: "${n.oldValue}" → "${n.newValue}"`
                            ).join(', ');
                            return `${change.field} (${nestedDesc})`;
                        } else {
                            return `${change.field}: "${change.oldValue}" → "${change.newValue}"`;
                        }
                    }).join('; ');
                }
            }
            
            const request = {
                type: type,
                action: action,
                itemId: itemId,
                requestedBy: getCurrentUser(),
                requestedByRole: currentUser.role,
                requestedData: newData,
                oldData: oldData,
                changeSummary: changeSummary,
                changeDescription: changeDescription,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdDate: new Date().toISOString()
            };
            
            if (reason) {
                request.reason = reason;
            }
            
            const docRef = await db.collection(COLLECTIONS.APPROVALS).add(request);
            console.log(`Request created with ID: ${docRef.id}`);
            
            await loadApprovalRequests();
            updateApprovalsButton();
            updateRequestCounts();
            
            showNotification('✅ Approval request submitted successfully', 'success');
        } catch (error) {
            console.error('Error creating approval request:', error);
            alert('Failed to create approval request: ' + error.message);
        }
    }

    async function saveSupplierWithChangeTracking() {
        if (!canCreateSupplier() && !canEditSupplier()) {
            alert('You do not have permission to save suppliers');
            return;
        }

        const name = document.getElementById('supplierName').value.trim();
        const phone = document.getElementById('supplierPhone').value.trim();
        const category = document.getElementById('supplierCategory').value;
        
        if (!name || !phone || !category) {
            alert('Supplier Name, Phone Number, and Category are required');
            return;
        }

        let rating = 3;
        const ratingInputs = document.querySelectorAll('input[name="rating"]');
        for (let input of ratingInputs) {
            if (input.checked) {
                rating = parseInt(input.value);
                break;
            }
        }

        const renewalYear = document.getElementById('supplierRenewalYear').value;
        const renewalMonth = document.getElementById('supplierRenewalMonth').value;
        const renewalDate = new Date(renewalYear, parseInt(renewalMonth), 31).toISOString();

        const compliance = {
            tpin: document.getElementById('complianceTpin').checked ? 'yes' : 'no',
            napsa: document.getElementById('complianceNapsa').checked ? 'yes' : 'no',
            zra: document.getElementById('complianceZra').checked ? 'yes' : 'no',
            zppa: document.getElementById('complianceZppa').checked ? 'yes' : 'no'
        };

        const documents = [];
        for (let [type, doc] of Object.entries(uploadedDocuments)) {
            if (doc) {
                documents.push({
                    type: type,
                    name: doc.name,
                    size: doc.size,
                    uploadedAt: doc.uploadedAt,
                    data: doc.data
                });
            }
        }

        const supplierData = {
            name: name,
            specialization: document.getElementById('supplierSpecialization').value.trim(),
            province: province,
            phone: phone,
            tpin: document.getElementById('supplierTpin').value.trim(),
            email: document.getElementById('supplierEmail').value.trim(),
            address: document.getElementById('supplierAddress').value.trim(),
            category: category,
            rating: rating,
            compliance: compliance,
            renewalDate: renewalDate,
            documents: documents,
            images: [],
            lastModifiedBy: getCurrentUser(),
            lastModifiedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        const editingId = document.getElementById('editingSupplierId').value;
        const actionType = document.getElementById('supplierActionType').value;
        const currentUser = getUser(getCurrentUser());

        try {
            if (actionType === 'edit' && editingId) {
                const oldSupplier = suppliers.find(s => s.id === editingId);
                
                if (currentUser.role === 'super admin' || currentUser.role === 'admin') {
                    await db.collection(COLLECTIONS.SUPPLIERS).doc(editingId).update(supplierData);
                    const changes = getChangeSummary(oldSupplier, supplierData);
                    
                    await logAudit('UPDATE_SUPPLIER', {
                        supplierId: editingId,
                        name: name,
                        updatedBy: getCurrentUser(),
                        changes: changes,
                        changeDescription: changes.map(c => `${c.field}: "${c.oldValue}" → "${c.newValue}"`).join('; ')
                    });

                    showNotification('Supplier updated successfully', 'success');
                } else {
                    await createApprovalRequestWithChanges(
                        'supplier', 
                        supplierData, 
                        'edit', 
                        editingId,
                        null,
                        oldSupplier
                    );
                    closeSupplierModal();
                    showNotification('Supplier edit request submitted for approval. Changes: ' + 
                        getChangeSummary(oldSupplier, supplierData).map(c => 
                            `${c.field}: "${c.oldValue}" → "${c.newValue}"`
                        ).join(', '), 'info');
                    return;
                }
            } else {
                if (currentUser.role === 'super admin' || currentUser.role === 'admin') {
                    await db.collection(COLLECTIONS.SUPPLIERS).add({
                        ...supplierData,
                        createdAt: new Date().toISOString(),
                        createdBy: getCurrentUser()
                    });

                    await logAudit('CREATE_SUPPLIER', {
                        name: name,
                        category: category,
                        createdBy: getCurrentUser()
                    });

                    showNotification('Supplier added successfully', 'success');
                } else {
                    await createApprovalRequestWithChanges('supplier', supplierData, 'add', null);
                    closeSupplierModal();
                    showNotification('Supplier addition request submitted for approval', 'info');
                    return;
                }
            }

            await loadAllData(true);
            closeSupplierModal();

            if (document.getElementById('categoryPageView').style.display === 'block') {
                const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
                renderSuppliersTable(categorySuppliers);
            }
        } catch (error) {
            console.error('Error saving supplier:', error);
            alert('Failed to save supplier: ' + error.message);
        }
    }

    async function saveCategoryWithChangeTracking() {
        if (!canCreateCategory() && !canEditCategory()) {
            alert('You do not have permission to create/edit categories');
            return;
        }

        const name = document.getElementById('categoryNameInput').value.trim();
        const editingId = document.getElementById('editingCategoryId').value;
        
        if (!name) {
            alert('Category name is required');
            return;
        }

        try {
            if (editingId) {
                const oldCategory = categories.find(c => c.id === editingId);
                
                if (canEditCategoryWithoutApproval()) {
                    await db.collection(COLLECTIONS.CATEGORIES).doc(editingId).update({
                        name: name,
                        lastModifiedBy: getCurrentUser(),
                        lastModifiedAt: new Date().toISOString()
                    });

                    await logAudit('UPDATE_CATEGORY', { 
                        categoryId: editingId,
                        oldName: oldCategory?.name,
                        newName: name,
                        changeDescription: `Category name changed from "${oldCategory?.name}" to "${name}"`,
                        updatedBy: getCurrentUser()
                    });

                    await loadAllData(true);
                    renderCategories();
                    closeCategoryModal();
                    showNotification(`Category updated from "${oldCategory?.name}" to "${name}" successfully`, 'success');
                    populateCategoryDropdown();
                    
                    if (document.getElementById('categoryPageView').style.display === 'block') {
                        document.getElementById('categoryTitle').textContent = name;
                    }
                } else {
                    await createApprovalRequestWithChanges(
                        'category', 
                        { name: name }, 
                        'edit', 
                        editingId,
                        null,
                        oldCategory
                    );
                    closeCategoryModal();
                    showNotification(`Category edit request submitted for approval: "${oldCategory?.name}" → "${name}"`, 'info');
                }
            } else {
                if (canCreateCategoryWithoutApproval()) {
                    await db.collection(COLLECTIONS.CATEGORIES).add({
                        name: name,
                        createdAt: new Date().toISOString(),
                        createdBy: getCurrentUser()
                    });

                    await logAudit('CREATE_CATEGORY', { 
                        name: name,
                        createdBy: getCurrentUser()
                    });

                    await loadAllData(true);
                    renderCategories();
                    closeCategoryModal();
                    showNotification(`Category "${name}" created successfully`, 'success');
                    populateCategoryDropdown();
                } else {
                    await createApprovalRequestWithChanges('category', { name: name }, 'add', null);
                    closeCategoryModal();
                    showNotification('Category creation request submitted for approval', 'info');
                }
            }
        } catch (error) {
            console.error('Error saving category:', error);
            alert('Failed to save category: ' + error.message);
        }
    }

    async function deleteSupplierWithReason(supplierId) {
        if (!canDeleteSupplier()) {
            alert('You do not have permission to delete suppliers');
            return;
        }

        const supplier = suppliers.find(s => s.id === supplierId);
        if (!supplier) return;

        const currentUser = getUser(getCurrentUser());

        if (currentUser.role === 'super admin') {
            if (confirm(`Delete supplier "${supplier.name}"?`)) {
                try {
                    await db.collection(COLLECTIONS.SUPPLIERS).doc(supplierId).delete();
                    await logAudit('DELETE_SUPPLIER', { 
                        supplierId, 
                        name: supplier.name,
                        deletedBy: getCurrentUser() 
                    });
                    await loadAllData(true);
                    showNotification('Supplier deleted', 'success');
                    
                    if (document.getElementById('categoryPageView').style.display === 'block') {
                        const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
                        renderSuppliersTable(categorySuppliers);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to delete');
                }
            }
        } else {
            openReasonModal('supplier', supplierId, supplier.name, async (type, id, name, reason) => {
                await createApprovalRequestWithChanges(
                    'supplier', 
                    { name: name, role: currentUser.role }, 
                    'delete', 
                    id, 
                    reason,
                    supplier
                );
                showNotification(`Delete request submitted for approval for supplier "${name}". Reason: ${reason}`, 'info');
            });
        }
    }

    async function openEnhancedApprovalActionModal(requestId) {
        const request = approvalRequests.find(r => r.id === requestId);
        if (!request) return;
        
        localStorage.setItem('currentApprovalRequestId', requestId);
        
        const detailsDiv = document.getElementById('approvalActionDetails');
        const actionColor = request.action === 'delete' ? '#e74c3c' : 
                           request.action === 'edit' ? '#f39c12' : '#3498db';
        
        let changesHtml = '';
        
        if (request.changeSummary && request.changeSummary.length > 0) {
            changesHtml = `
                <div style="margin-top: 20px; border-top: 2px solid ${actionColor}; padding-top: 15px;">
                    <h4 style="color: ${actionColor}; margin-bottom: 15px;">📋 SPECIFIC CHANGES TO BE APPLIED:</h4>
                    ${request.changeSummary.map(change => {
                        if (change.type === 'object' && change.nestedChanges) {
                            return `
                                <div style="margin-bottom: 15px; background: #f8f9fa; padding: 12px; border-radius: 8px;">
                                    <div style="font-weight: bold; color: #e67e22; margin-bottom: 8px; text-transform: capitalize;">${change.field}</div>
                                    ${change.nestedChanges.map(n => `
                                        <div style="display: flex; margin-bottom: 5px;">
                                            <span style="min-width: 100px; font-weight: 500;">${n.field}:</span>
                                            <div style="flex: 1;">
                                                <span style="color: #e74c3c; text-decoration: line-through; margin-right: 10px;">${n.oldValue}</span>
                                                <span style="color: #27ae60;">→ ${n.newValue}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        } else {
                            return `
                                <div style="display: flex; margin-bottom: 10px; background: #f8f9fa; padding: 8px 12px; border-radius: 8px;">
                                    <span style="min-width: 120px; font-weight: bold; text-transform: capitalize;">${change.field}:</span>
                                    <div style="flex: 1;">
                                        <span style="color: #e74c3c; text-decoration: line-through; margin-right: 10px;">${change.oldValue}</span>
                                        <span style="color: #27ae60;">→ ${change.newValue}</span>
                                    </div>
                                </div>
                            `;
                        }
                    }).join('')}
                </div>
            `;
        }
        
        let detailsHtml = `
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <p><strong>Request Type:</strong> <span style="color: ${actionColor}; font-weight: bold;">${request.action.toUpperCase()} ${request.type.toUpperCase()}</span></p>
                <p><strong>Requested By:</strong> ${request.requestedBy} <span class="role-badge" style="background: ${request.requestedByRole === 'super admin' ? '#9b59b6' : request.requestedByRole === 'admin' ? '#3498db' : '#2ecc71'};">${request.requestedByRole}</span></p>
                <p><strong>Date:</strong> ${new Date(request.createdAt?.toDate ? request.createdAt.toDate() : request.createdAt).toLocaleString()}</p>
                <p><strong>Item ID:</strong> ${request.itemId || 'N/A'}</p>
            </div>
        `;
        
        if (request.reason) {
            detailsHtml += `
                <div style="margin-top: 15px; padding: 12px; background: #fff8e7; border-left: 4px solid #f39c12; border-radius: 8px;">
                    <strong style="color: #f39c12;">Reason:</strong>
                    <p style="margin: 5px 0 0 0; font-size: 13px;">${request.reason}</p>
                </div>
            `;
        }
        
        detailsHtml += changesHtml;
        
        if (!request.changeSummary && request.action === 'edit') {
            detailsHtml += `
                <div style="margin-top: 15px;">
                    <strong>Full Request Data:</strong>
                    <pre style="background: #fff; padding: 10px; border-radius: 5px; font-size: 12px; overflow-x: auto; max-height: 200px;">${JSON.stringify(request.requestedData, null, 2)}</pre>
                </div>
            `;
        }
        
        detailsDiv.innerHTML = detailsHtml;
        document.getElementById('approvalActionTitle').innerHTML = `Review ${request.action} Request`;
        document.getElementById('approvalActionModal').style.display = 'flex';
    }

    const originalOpenApprovalActionModal = window.openApprovalActionModal;
    window.openApprovalActionModal = openEnhancedApprovalActionModal;
    window.saveSupplier = saveSupplierWithChangeTracking;
    window.saveNewCategory = saveCategoryWithChangeTracking;
    window.deleteSupplier = deleteSupplierWithReason;

    function openLinkModal() { 
        if (!canCreateLink()) {
            alert('You do not have permission to add links');
            return;
        }
        document.getElementById('linkModal').style.display = 'flex'; 
    }
    
    function closeLinkModal() { 
        document.getElementById('linkModal').style.display = 'none'; 
        document.getElementById('instName').value = '';
        document.getElementById('instWeb').value = '';
        document.getElementById('instEmail').value = '';
    }

    async function openApprovalActionModal(requestId) {
    const request = approvalRequests.find(r => r.id === requestId);
    if (!request) return;
    
    localStorage.setItem('currentApprovalRequestId', requestId);
    document.getElementById('pendingRejectRequestId').value = requestId;
    
    const detailsDiv = document.getElementById('approvalActionDetails');
    const actionColor = request.action === 'delete' ? '#e74c3c' : 
                       request.action === 'edit' ? '#f39c12' : '#3498db';
    
    let detailsHtml = `
        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                <span style="background: ${actionColor}; color: white; padding: 8px 20px; border-radius: 30px; font-weight: 700; font-size: 14px;">
                    ${request.action?.toUpperCase() || 'ACTION'} ${request.type?.toUpperCase() || 'ITEM'}
                </span>
                <span style="background: ${request.requestedByRole === 'super admin' ? '#9b59b6' : request.requestedByRole === 'admin' ? '#3498db' : '#2ecc71'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
                    ${request.requestedByRole || 'staff'}
                </span>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                <div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">👤 REQUESTED BY</div>
                    <div style="font-weight: 600; color: #173979;">${request.requestedByFullName || request.requestedBy || 'Unknown'}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">${request.requestedBy || ''}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">📅 SUBMITTED</div>
                    <div style="font-weight: 600;">${new Date(request.createdAt?.toDate ? request.createdAt.toDate() : request.createdAt).toLocaleString()}</div>
                </div>
            </div>
        </div>
    `;
    
    
    detailsDiv.innerHTML = detailsHtml;
    document.getElementById('approvalActionTitle').innerHTML = `Review ${request.action || 'Unknown'} Request`;
    document.getElementById('approvalActionModal').style.display = 'flex';
}

async function deleteUser(userId) {
    if (!canDeleteUser(userId)) {
        alert("You don't have permission to delete this user");
        return;
    }

    const user = userAccounts.find(u => u.id === userId);
    if (!user) return;
    if (isJoseph(user.username)) {
        alert('⚠️ JOSEPH is a protected system account and cannot be deleted.');
        return;
    }

    const currentUser = getUser(getCurrentUser());
    if (currentUser.role === 'staff' && currentUser.id !== userId) {
        alert('You can only delete your own account.');
        return;
    }

    if (currentUser.role === 'super admin') {
        if (confirm(`Are you sure you want to permanently delete user ${user.fullName || user.username}?`)) {
            try {
                await db.collection(COLLECTIONS.USERS).doc(userId).delete();
                
                await logAudit('DELETE_USER', {
                    username: user.username,
                    fullName: user.fullName,
                    role: user.role,
                    deletedBy: getCurrentUser()
                });
                
                await getAllUsers(true);
                manageUsersModal();
                showNotification(`User ${user.fullName || user.username} deleted successfully`);
            } catch (error) {
                console.error("Error deleting user:", error);
                alert("Failed to delete user");
            }
        }
    } else {
        openReasonModal('user', userId, user.fullName || user.username, async (type, id, name, reason) => {
            await createApprovalRequest('user', { name: name, role: user.role, fullName: user.fullName }, 'delete', id, reason);
            showNotification('User deletion request submitted for approval', 'info');
            manageUsersModal();
        });
    }
}

    async function manageUsersModal() {
        const currentUser = getCurrentUser();
        const curUser = getUser(currentUser);
        
        if (!curUser) {
            alert("Please log in first");
            return;
        }

        await getAllUsers(true);
        const tbody = document.getElementById('userMgmtTableBody');
        let html = '';

        for (let u of userAccounts) {
            const canSeeFullData = (curUser.role === 'super admin' || curUser.role === 'admin');
            
            let displayEmail = '';
            let displayNrc = '';
            let displayPhone = u.phone || '';
            
            if (curUser.role === 'super admin') {
                displayEmail = u.email || '';
                displayNrc = u.nrc || '';
            } else if (curUser.role === 'admin') {
                if (u.role === 'super admin') {
                    continue;
                }
                displayEmail = u.email || '****@****';
                displayNrc = '******';
            } else if (curUser.role === 'staff') {
                if (u.role !== 'staff') {
                    continue;
                }
                displayEmail = '****@****';
                displayNrc = '******';
            }

            const status = u.enabled ? 
                '<span style="color:green; font-weight:bold;">Enabled</span>' : 
                '<span style="color:red; font-weight:bold;">Disabled</span>';
            
            const canEdit = (curUser.role === 'super admin') || 
                           (curUser.role === 'admin' && u.role !== 'super admin' && u.role !== 'admin') ||
                           (curUser.role === 'staff' && u.role === 'staff');
            
            const canDelete = (curUser.role === 'super admin' && !isJoseph(u.username)) ||
                             (curUser.role === 'admin' && u.role === 'staff') ||
                             (curUser.role === 'staff' && u.role === 'staff' && !isJoseph(u.username));
            
            let actions = '';
            if (canEdit) {
                actions += `<button class="btn-edit" onclick="openEditUserModal('${u.id}')">Edit</button> `;
            }
            if (canDelete) {
                actions += `<button class="btn-del" onclick="deleteUser('${u.id}')">Delete</button>`;
            }
            if (!actions) actions = '—';

            const roleClass = u.role.replace(' ', '');
            html += `<tr>
    <td>
        ${u.username}
        ${isJoseph(u.username) ? ' 🔒' : ''}
        <br><span style="font-size: 11px; color: #666;">${u.fullName || ''}</span>
    </td>
    <td><span class="role-badge role-${roleClass}">${u.role}</span></td>
    <td>${displayPhone}</td>
    <td>${displayEmail}<br><span style="font-size:11px; color:#666;">NRC: ${displayNrc}</span></td>
    <td>
        ${status}
        <div style="display: flex; gap: 5px; justify-content: center; margin-top: 8px;">
            ${u.documents?.degree && canSeeFullData ? 
                `<button onclick="viewUserDocument('${u.id}', 'degree', event)" style="background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 20px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;" title="View Degree/Diploma">
                    <span>🎓</span> Degree
                </button>` 
                : '<span style="color: #ccc; font-size: 11px; background: #f0f0f0; padding: 5px 10px; border-radius: 20px;">🎓 No Degree</span>'}
        </div>
        <div style="display: flex; gap: 5px; justify-content: center; margin-top: 5px;">
            ${u.documents?.zips && canSeeFullData ? 
                `<button onclick="viewUserDocument('${u.id}', 'zips', event)" style="background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 20px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;" title="View ZIPS Certificate">
                    <span>📜</span> ZIPS
                </button>` 
                : '<span style="color: #ccc; font-size: 11px; background: #f0f0f0; padding: 5px 10px; border-radius: 20px;">📜 No ZIPS</span>'}
        </div>
        <div style="display: flex; gap: 5px; justify-content: center; margin-top: 5px;">
            ${u.documents?.nrc && canSeeFullData ? 
                `<button onclick="viewUserDocument('${u.id}', 'nrc', event)" style="background: #e67e22; color: white; border: none; padding: 5px 10px; border-radius: 20px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;" title="View NRC">
                    <span>🪪</span> NRC
                </button>` 
                : '<span style="color: #ccc; font-size: 11px; background: #f0f0f0; padding: 5px 10px; border-radius: 20px;">🪪 No NRC</span>'}
        </div>
    </td>
    <td><div class="action-buttons">${actions}</div></td>
</tr>`;
        }

        tbody.innerHTML = html;
        document.getElementById('userManagementModal').style.display = 'flex';
    }

    function closeUserMgmtModal() { 
        document.getElementById('userManagementModal').style.display = 'none'; 
    }

    function openAddUserModal() {
        if (!canAddUser()) {
            alert("You don't have permission to add users");
            return;
        }

        document.getElementById('addUserTitle').innerText = '➕ Add New User';
        
        ['newFullName', 'newUsername', 'newNrc', 'newEmail', 'newPhone', 'newInstitution', 'newPosition', 'newPassword'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        
        ['newDegreeDocPreview', 'newZipsDocPreview', 'newNrcDocPreview'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = '';
        });
        
        userUploadedDocuments = { degree: null, zips: null, nrc: null };
        document.getElementById('newRole').value = 'staff';
        const currentUser = getUser(getCurrentUser());
        
        if (currentUser.role === 'staff') {
            const roleSelect = document.getElementById('newRole');
            for (let i = 0; i < roleSelect.options.length; i++) {
                if (roleSelect.options[i].value !== 'staff') {
                    roleSelect.options[i].disabled = true;
                }
            }
        } else if (currentUser.role === 'admin') {
            const roleSelect = document.getElementById('newRole');
            for (let i = 0; i < roleSelect.options.length; i++) {
                if (roleSelect.options[i].value === 'super admin') {
                    roleSelect.options[i].disabled = true;
                } else {
                    roleSelect.options[i].disabled = false;
                }
            }
        } else if (currentUser.role === 'super admin') {
            document.querySelectorAll('#newRole option').forEach(opt => opt.disabled = false);
        }

        document.getElementById('addUserModal').style.display = 'flex';
    }

    async function toggleSessionsPanel() {
        if (!canViewSessions()) {
            alert('You do not have permission to view sessions');
            return;
        }

        const panel = document.getElementById('sessionsPanel');
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
            return;
        }

        await getAllUsers(true);
        const listDiv = document.getElementById('activeSessionsList');
        const now = new Date();
        let html = '';

        for (let u of userAccounts) {
            if (!u.enabled) continue;
            
            const lastActive = u.lastActive ? new Date(u.lastActive) : null;
            const isOnline = lastActive && (now - lastActive) < 300000;
            
            let timeAgo = 'Never';
            if (lastActive) {
                const diffMs = now - lastActive;
                const diffMins = Math.floor(diffMs / 60000);
                if (diffMins < 1) timeAgo = 'Just now';
                else if (diffMins < 60) timeAgo = `${diffMins} min ago`;
                else timeAgo = `${Math.floor(diffMins / 60)}h ${diffMins % 60}m ago`;
            }

            html += `
                <div style="padding:10px; border-bottom:1px solid #eee;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span class="online-indicator ${isOnline ? 'pulse-online beaming' : 'offline-grey'}"></span>
                        <strong>${u.username}</strong>
                        <span style="font-size:11px; background:#f0f0f0; padding:2px 6px; border-radius:12px;">${u.role}</span>
                    </div>
                    <div style="font-size:11px; color:#666; margin-top:4px;">
                        Last active: ${timeAgo}
                    </div>
                </div>
            `;
        }

        listDiv.innerHTML = html || '<p style="padding:15px; text-align:center; color:#888;">No users found</p>';
        panel.style.display = 'block';
    }

async function loadAuditLogs(forceRefresh = false) {
    try {
        const snapshot = await db.collection(COLLECTIONS.AUDIT_LOGS)
            .orderBy('timestamp', 'desc')
            .limit(100)
            .get();
        
        auditLogs = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        totalAuditPages = Math.ceil(auditLogs.length / auditLogsPerPage) || 1;
        currentAuditPage = 1;
        
        console.log(`Loaded ${auditLogs.length} audit logs`);
        return auditLogs;
    } catch (error) {
        console.error('Error loading audit logs:', error);
        try {
            const snapshot = await db.collection(COLLECTIONS.AUDIT_LOGS)
                .limit(100)
                .get();
            
            auditLogs = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            })).sort((a, b) => {
                const dateA = a.timestamp ? new Date(a.timestamp) : new Date(0);
                const dateB = b.timestamp ? new Date(b.timestamp) : new Date(0);
                return dateB - dateA;
            });
            
            totalAuditPages = Math.ceil(auditLogs.length / auditLogsPerPage) || 1;
            currentAuditPage = 1;
        } catch (fallbackError) {
            console.error('Fallback error loading audit logs:', fallbackError);
            auditLogs = [];
            totalAuditPages = 1;
        }
    }
}

    async function exportData() {
        if (!isCurrentUserSuperAdmin()) {
            alert("Only super admin can export backup");
            return;
        }

        try {
            await loadAllData(true);
            await getAllUsers(true);
            await loadAuditLogs();

            const backup = {
                categories,
                suppliers,
                links,
                users: userAccounts.map(u => {
                    const { password, ...safeUser } = u;
                    return safeUser;
                }),
                auditLogs: auditLogs.slice(0, 100),
                exportedAt: new Date().toISOString(),
                exportedBy: getCurrentUser()
            };

            const dataStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `zamcom_backup_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            await logAudit('EXPORT_BACKUP', {
                recordCounts: {
                    categories: categories.length,
                    suppliers: suppliers.length,
                    links: links.length,
                    users: userAccounts.length
                }
            });
            
            showNotification('Backup downloaded successfully (super admin only)');
        } catch (error) {
            console.error("Export error:", error);
            alert("Failed to export backup");
        }
    }

    function importData(event) {
        if (!isCurrentUserSuperAdmin()) {
            alert("Only super admin can import data");
            event.target.value = '';
            return;
        }
        alert('Import & Merge feature - Firestore implementation pending');
        event.target.value = '';
    }

    function showView(viewName) {
    document.getElementById('homeView').style.display = 'none';
    document.getElementById('categoryPageView').style.display = 'none';
    document.getElementById('aboutView').style.display = 'none';
    document.getElementById('contactView').style.display = 'none';
    document.getElementById('linksView').style.display = 'none';
    document.getElementById('auditLogsView').style.display = 'none';
    document.getElementById('userApprovalHistoryView').style.display = 'none';
    document.getElementById('searchResultSection').style.display = 'none';

    if (viewName === 'home') {
        document.getElementById('homeView').style.display = 'block';
        renderCategories();
        
        const searchInput = document.getElementById('globalSearch');
        if (searchInput) {
            searchInput.value = '';
        }
        
    } else if (viewName === 'category') {
        document.getElementById('categoryPageView').style.display = 'block';
    } else if (viewName === 'about') {
        document.getElementById('aboutView').style.display = 'block';
    } else if (viewName === 'contact') {
        document.getElementById('contactView').style.display = 'block';
    } else if (viewName === 'links') {
        document.getElementById('linksView').style.display = 'block';
        renderLinks();
    } else if (viewName === 'auditLogs') {
        document.getElementById('auditLogsView').style.display = 'block';
    } else if (viewName === 'userApprovalHistory') {
        document.getElementById('userApprovalHistoryView').style.display = 'block';
        loadUserApprovalHistory('pending');
    }
}

    function updateGreeting() {
        const hour = new Date().getHours();
        const user = getCurrentUser() || 'User';
        const msg = hour < 12 ? "Good Morning" : hour < 18 ? "Good Afternoon" : "Good Evening";
        const greetingEl = document.getElementById('greeting');
        if (greetingEl) greetingEl.innerHTML = `<i>${msg}, ${user}</i>`;
    }

    function updateUserDisplay() {
    const currentUser = getCurrentUser();
    const userInfo = document.getElementById('currentUserDisplay');
    const roleBadge = document.getElementById('userRoleBadge');
    
    if (currentUser && userInfo) {
        const user = getUser(currentUser);
        if (user) {
            userInfo.innerHTML = `
                <div class="user-menu">
                    <button class="user-menu-button">
                        <span>👤</span> ${currentUser}
                        <span style="font-size: 12px; margin-left: 5px;">▼</span>
                    </button>
                    <div class="user-dropdown">
                        <div class="user-dropdown-item" onclick="openChangePasswordModal()">
                            <span>🔐</span> Change Password
                        </div>
                        <div class="user-dropdown-divider"></div>
                        <div class="user-dropdown-item" onclick="logout()">
                            <span>🚪</span> Logout
                        </div>
                    </div>
                </div>
            `;
            
            if (roleBadge) {
                roleBadge.textContent = user.role.toUpperCase();
                roleBadge.style.display = 'inline-block';
                roleBadge.style.background = 
                    user.role === 'super admin' ? '#9b59b6' : 
                    user.role === 'admin' ? '#3498db' : '#2ecc71';
            }
        }
    } else if (userInfo) {
        userInfo.textContent = 'Not logged in';
        if (roleBadge) roleBadge.style.display = 'none';
    }
}

    function updateDashboardStatus() {
        const clockEl = document.getElementById('liveClock');
        if (clockEl) {
            const now = new Date();
            clockEl.textContent = now.toLocaleTimeString('en-US', { 
                hour12: true, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
        }

        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const currentUser = getCurrentUser();
        
        if (statusDot && statusText) {
            if (isSystemLocked()) {
                if (canAccessLockedSystem()) {
                    statusDot.className = 'pulse-online';
                    statusText.innerText = "🔓 SYSTEM LOCKED - You have after-hours access";
                    statusText.style.color = "var(--warning-orange)";
                } else {
                    statusDot.className = 'offline-grey';
                    statusText.innerText = "🔒 SYSTEM LOCKED (07:30 - 16:50 only)";
                    statusText.style.color = "var(--danger-red)";
                }
            } else {
                statusDot.className = 'pulse-online';
                statusText.innerText = "✅ SYSTEM OPERATIONAL (OPEN)";
                statusText.style.color = "var(--primary-green)";
            }
        }
    }

    function syncBG() {
        const header = document.getElementById('headerSection');
        if (!header) return;
        header.style.backgroundImage = `linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('${bgImages[bgIndex]}')`;
        bgIndex = (bgIndex + 1) % bgImages.length;
    }

    function renderStars(rating) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            stars += `<span class="star-view ${i <= rating ? 'filled' : 'star-empty-view'}">★</span>`;
        }
        return stars;
    }

    function renderCompliancePills(supplier) {
        if (!supplier.compliance) return '<span class="compliance-pill comp-bad">NO DATA</span>';
        let pills = [];
        pills.push(supplier.compliance.tpin === 'yes' ? 
            '<span class="compliance-pill comp-ok">TPIN</span>' : 
            '<span class="compliance-pill comp-bad">TPIN</span>');
        pills.push(supplier.compliance.napsa === 'yes' ? 
            '<span class="compliance-pill comp-ok">NAPSA</span>' : 
            '<span class="compliance-pill comp-bad">NAPSA</span>');
        pills.push(supplier.compliance.zra === 'yes' ? 
            '<span class="compliance-pill comp-ok">ZRA</span>' : 
            '<span class="compliance-pill comp-bad">ZRA</span>');
        pills.push(supplier.compliance.zppa === 'yes' ? 
            '<span class="compliance-pill comp-ok">ZPPA</span>' : 
            '<span class="compliance-pill comp-bad">ZPPA</span>');
        return pills.join('');
    }

    function getDaysRemaining(supplier) {
        if (!supplier.renewalDate) return 0;
        const today = new Date();
        const renewal = new Date(supplier.renewalDate);
        return Math.ceil((renewal - today) / (1000 * 60 * 60 * 24));
    }

    function calculateRenewalPercentage(supplier) {
        if (!supplier.renewalDate) return 0;
        const days = getDaysRemaining(supplier);
        if (days < 0) return 0;
        return Math.min(100, (days / 365) * 100);
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' });
    }

    function viewDocuments(supplierId) {
        const supplier = suppliers.find(s => s.id === supplierId);
        if (!supplier || !supplier.documents || supplier.documents.length === 0) {
            alert('No documents available for this supplier');
            return;
        }

        const viewerBody = document.getElementById('documentViewerBody');
        viewerBody.innerHTML = '';

        supplier.documents.forEach((doc, index) => {
            const isImage = doc.type && (doc.type.startsWith('image/') || doc.name?.match(/\.(jpg|jpeg|png|gif|webp)$/i));
            const docType = doc.type ? doc.type.toUpperCase() : 'PDF';
            
            const docElement = document.createElement('div');
            docElement.style.cssText = 'background: #f8f9fa; border-radius: 12px; padding: 15px; text-align: center;';
            
            if (isImage) {
                docElement.innerHTML = `
                    <img src="${doc.data}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; cursor: pointer;" onclick="window.open('${doc.data}', '_blank')">
                    <div style="font-weight: bold; margin-bottom: 5px; word-break: break-word;">${doc.name}</div>
                    <div style="font-size: 11px; color: #666;">${doc.type || 'Image'} • ${(doc.size / 1024).toFixed(1)} KB</div>
                    <div style="margin-top: 10px;">
                        <button class="btn-edit" style="padding: 5px 10px; font-size: 11px;" onclick="window.open('${doc.data}', '_blank')">View Full Image</button>
                    </div>
                `;
            } else {
                docElement.innerHTML = `
                    <div style="background: #e74c3c; width: 100%; height: 150px; display: flex; align-items: center; justify-content: center; border-radius: 8px; margin-bottom: 10px;">
                        <span style="font-size: 48px; color: white;">📄</span>
                    </div>
                    <div style="font-weight: bold; margin-bottom: 5px; word-break: break-word;">${doc.name}</div>
                    <div style="font-size: 11px; color: #666;">${docType} • ${(doc.size / 1024).toFixed(1)} KB</div>
                    <div style="margin-top: 10px;">
                        <button class="btn-edit" style="padding: 5px 10px; font-size: 11px;" onclick="window.open('${doc.data}', '_blank')">View</button>
                    </div>
                `;
            }
            
            viewerBody.appendChild(docElement);
        });

        document.getElementById('documentViewerTitle').innerHTML = `📁 Documents: ${supplier.name}`;
        document.getElementById('documentViewerModal').style.display = 'flex';
    }

    function closeDocumentViewer() { 
        document.getElementById('documentViewerModal').style.display = 'none'; 
    }

let searchTimeout;
function filterEverything() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const term = document.getElementById('globalSearch').value.toLowerCase();
        if (term.length < 2) { 
            document.getElementById('searchResultSection').style.display = 'none';
            document.getElementById('defaultHomeContent').style.display = 'block';
            return;
        }
        
        const supplierResults = suppliers.filter(s => s.name && s.name.toLowerCase().includes(term));
        const categoryResults = categories.filter(c => c.name && c.name.toLowerCase().includes(term));
        
        const tbody = document.getElementById('globalSearchResultsBody');
        
        let resultsHtml = '';
        if (categoryResults.length > 0) {
            resultsHtml += categoryResults.map(c => {
                const suppliersInCategory = suppliers.filter(s => s.category === c.name).length;
                return `
                <tr style="background-color: #f0f8ff; border-left: 4px solid #173979;">
                    <td><strong>📁 CATEGORY:</strong> ${c.name}</td>
                    <td>—</td>
                    <td>—</td>
                    <td>—</td>
                    <td>—</td>
                    <td>—</td>
                    <td><span style="background: #173979; color: white; padding: 3px 8px; border-radius: 12px;">${suppliersInCategory} suppliers</span></td>
                    <td>
                        <button class="btn-edit" onclick="openCategoryPage('${c.id}')" style="font-size: 11px; padding: 5px 10px;">
                            View Category
                        </button>
                    </td>
                </tr>
            `}).join('');
        }
        
        if (supplierResults.length > 0) {
            resultsHtml += supplierResults.map(s => {
                const daysRemaining = getDaysRemaining(s);
                return `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.category || ''}</td>
                    <td>${s.specialization || ''}</td>
                    <td>${s.province || 'Not specified'}</td>
                    <td><a href="https://wa.me/${s.phone?.replace(/\D/g, '')}" target="_blank">${s.phone || ''}</a></td>
                    <td>${renderStars(s.rating || 0)} ${s.rating || 0}/5</td>
                    <td><span style="background: ${daysRemaining < 0 ? '#e74c3c' : daysRemaining < 30 ? '#f39c12' : '#2ecc71'}; color: white; padding: 3px 8px; border-radius: 12px;">${daysRemaining} days</span></td>
                    <td><div class="action-buttons">${canEditSupplier() ? `<button class="btn-edit" onclick="editSupplier('${s.id}')">Edit</button>` : '—'}</div></td>
                </tr>
            `}).join('');
        }
        
        // If no results at all
        if (categoryResults.length === 0 && supplierResults.length === 0) {
            resultsHtml = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 30px; color: #666;">
                        No categories or suppliers found matching "${term}"
                    </td>
                </tr>
            `;
        }
        
        tbody.innerHTML = resultsHtml;
        document.getElementById('defaultHomeContent').style.display = 'none';
        document.getElementById('searchResultSection').style.display = 'block';
    }, 300);
}

    async function migrateSuppliersAddProvince() {
    if (!isCurrentUserSuperAdmin()) {
        alert('Only super admin can run migration');
        return;
    }
    
    if (!confirm('This will add "Not specified" province to all suppliers without a province. Continue?')) {
        return;
    }
    
    try {
        const batch = db.batch();
        let updatedCount = 0;
        
        for (const supplier of suppliers) {
            if (!supplier.province) {
                const supplierRef = db.collection(COLLECTIONS.SUPPLIERS).doc(supplier.id);
                batch.update(supplierRef, { province: 'Not specified' });
                updatedCount++;
            }
        }
        
        if (updatedCount > 0) {
            await batch.commit();
            await loadAllData(true);
            showNotification(`Updated ${updatedCount} suppliers with default province`, 'success');
        } else {
            showNotification('No suppliers needed updating', 'info');
        }
    } catch (error) {
        console.error('Migration error:', error);
        alert('Migration failed: ' + error.message);
    }
}

    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        notification.style.background = type === 'success' ? '#173979' : type === 'info' ? '#3498db' : '#ff4d4d';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 4000);
    }

async function saveSupplierWithModifications() {
    if (!canCreateSupplier() && !canEditSupplier()) {
        alert('You do not have permission to save suppliers');
        return;
    }

    const name = document.getElementById('supplierName').value.trim();
    const phone = document.getElementById('supplierPhone').value.trim();
    const category = document.getElementById('supplierCategory').value;
    
    if (!name || !phone || !category) {
        alert('Supplier Name, Phone Number, and Category are required');
        return;
    }

    let rating = 3;
    const ratingInputs = document.querySelectorAll('input[name="rating"]');
    for (let input of ratingInputs) {
        if (input.checked) {
            rating = parseInt(input.value);
            break;
        }
    }

    const renewalYear = document.getElementById('supplierRenewalYear').value;
    const renewalMonth = document.getElementById('supplierRenewalMonth').value;
    const renewalDate = new Date(renewalYear, parseInt(renewalMonth), 31).toISOString();

    const compliance = {
        tpin: document.getElementById('complianceTpin').checked ? 'yes' : 'no',
        napsa: document.getElementById('complianceNapsa').checked ? 'yes' : 'no',
        zra: document.getElementById('complianceZra').checked ? 'yes' : 'no',
        zppa: document.getElementById('complianceZppa').checked ? 'yes' : 'no',
        egp: document.getElementById('complianceEgp').checked ? 'yes' : 'no'
    };

    const documents = [];
    for (let [type, doc] of Object.entries(uploadedDocuments)) {
        if (doc) {
            documents.push({
                type: type,
                name: doc.name,
                size: doc.size,
                uploadedAt: doc.uploadedAt,
                data: doc.data
            });
        }
    }

    const supplierData = {
        name: name,
        specialization: document.getElementById('supplierSpecialization').value.trim(),
        phone: phone,
        tpin: document.getElementById('supplierTpin').value.trim(),
        email: document.getElementById('supplierEmail').value.trim(),
        address: document.getElementById('supplierAddress').value.trim(),
        category: category,
        rating: rating,
        compliance: compliance,
        renewalDate: renewalDate,
        documents: documents,
        images: [],
        lastModifiedBy: getCurrentUser(),
        lastModifiedAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };

    const editingId = document.getElementById('editingSupplierId').value;
    const actionType = document.getElementById('supplierActionType').value;
    const currentUser = getUser(getCurrentUser());
    const username = currentUser?.username || getCurrentUser();

    try {
        if (actionType === 'edit' && editingId) {
            const oldSupplier = suppliers.find(s => s.id === editingId);
            
            if (currentUser.role === 'super admin' || currentUser.role === 'admin') {
                await db.collection(COLLECTIONS.SUPPLIERS).doc(editingId).update(supplierData);
                
                if (oldSupplier) {
                    if (oldSupplier.name !== name) {
                        await saveSupplierModification(editingId, 'update', 'name', oldSupplier.name, name, username);
                    }
                    if (oldSupplier.tpin !== supplierData.tpin) {
                        await saveSupplierModification(editingId, 'update', 'tpin', oldSupplier.tpin || 'empty', supplierData.tpin || 'empty', username);
                    }
                    if (oldSupplier.phone !== phone) {
                        await saveSupplierModification(editingId, 'update', 'phone', oldSupplier.phone || 'empty', phone, username);
                    }
                    if (oldSupplier.rating !== rating) {
                        await saveSupplierModification(editingId, 'update', 'rating', oldSupplier.rating || '0', rating.toString(), username);
                    }
                    if (JSON.stringify(oldSupplier.compliance) !== JSON.stringify(compliance)) {
                        await saveSupplierModification(editingId, 'update', 'compliance', 'previous settings', 'updated settings', username);
                    }
                }
                
                const changes = getChangeSummary(oldSupplier, supplierData);
                await logAudit('UPDATE_SUPPLIER', {
                    supplierId: editingId,
                    name: name,
                    updatedBy: getCurrentUser(),
                    changes: changes,
                    changeDescription: changes.map(c => `${c.field}: "${c.oldValue}" → "${c.newValue}"`).join('; ')
                });

                showNotification('Supplier updated successfully', 'success');
            } else {
                await createApprovalRequest('supplier', supplierData, 'edit', editingId);
                closeSupplierModal();
                showNotification('Supplier edit request submitted for approval', 'info');
                return;
            }
        } else {
            if (currentUser.role === 'super admin' || currentUser.role === 'admin') {
                const newSupplierData = {
                    ...supplierData,
                    createdAt: new Date().toISOString(),
                    createdBy: getCurrentUser(),
                    modifications: [{
                        action: 'create',
                        field: 'supplier',
                        old: 'none',
                        new: name,
                        modifiedBy: username,
                        modifiedAt: new Date().toISOString(),
                        description: `${username} created this supplier`
                    }]
                };
                
                const docRef = await db.collection(COLLECTIONS.SUPPLIERS).add(newSupplierData);

                await logAudit('CREATE_SUPPLIER', {
                    supplierId: docRef.id,
                    name: name,
                    category: category,
                    createdBy: getCurrentUser()
                });

                showNotification('Supplier added successfully', 'success');
            } else {
                await createApprovalRequest('supplier', supplierData, 'add', null);
                closeSupplierModal();
                showNotification('Supplier addition request submitted for approval', 'info');
                return;
            }
        }

        await loadAllData(true);
        closeSupplierModal();

        if (document.getElementById('categoryPageView').style.display === 'block') {
            const categorySuppliers = suppliers.filter(s => s.category === currentCategory);
            renderSuppliersTable(categorySuppliers);
        }
    } catch (error) {
        console.error('Error saving supplier:', error);
        alert('Failed to save supplier: ' + error.message);
    }
}

    function forgotPasswordSimple() { 
        alert('Please contact the super admin at zulujosephp@gmail.com'); 
    }

    let unsubscribeApprovals = null;

    function startRealtimeApprovalListener() {
        if (unsubscribeApprovals) {
            unsubscribeApprovals();
            unsubscribeApprovals = null;
        }
        
        const user = getCurrentUser();
        if (!user) return;
        
        const currentUser = getUser(user);
        if (!currentUser || !canApproveRequests()) {
            return;
        }
        
        let query;
        if (currentUser.role === 'super admin') {
            query = db.collection(COLLECTIONS.APPROVALS)
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc');
        } else {
            query = db.collection(COLLECTIONS.APPROVALS)
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc');
        }
        
        unsubscribeApprovals = query.onSnapshot((snapshot) => {
            console.log(`📡 Realtime update: ${snapshot.docs.length} pending approvals`);
            
            approvalRequests = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            updateApprovalsButton();
            updateRequestCounts();
            
            const modal = document.getElementById('approvalRequestsModal');
            if (modal && modal.style.display === 'flex') {
            }
            
            const reqModal = document.getElementById('requestsManagementModal');
            if (reqModal) {
                openRequestsManagement();
            }
            
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const req = change.doc.data();
                    if (req.requestedBy !== getCurrentUser()) {
                        showNotification(`📨 New approval request from ${req.requestedBy}`, 'info');
                    }
                }
            });
            
        }, (error) => {
            console.error("Realtime listener error:", error);
        });
    }


    async function initializeApp() {
        console.log("Initializing Zed Supplier Directory with loading spinner...");
        
        if (!enforceSingleTab()) {
            return;
        }
        
        document.getElementById('loadingSpinner').style.display = 'flex';
        document.getElementById('loginOverlay').style.display = 'none';
        const userDocModal = document.getElementById('userDocumentViewerModal');
        if (userDocModal) {
            userDocModal.style.display = 'none';
        }
        
        try {
            await ensureDefaultUsers();
            await getAllUsers(true);
            
            startRealtimeApprovalListener();
            
            ['complianceTpin', 'complianceNapsa', 'complianceZra', 'complianceZppa'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', updateComplianceUI);
                }
            });
            
            const originalShowAuditLogs = window.showAuditLogs;
        window.showAuditLogs = async function() {
        if (!canViewAuditLogs()) {
        alert('You do not have permission to view audit logs');
        return;
         }
        showView('auditLogs');
         await loadAuditLogs(true);
        renderAuditLogs();
        };
            const userIn = document.getElementById('userIn');
            const passIn = document.getElementById('passIn');
            if (userIn) userIn.value = '';
            if (passIn) passIn.value = '';
            
            const savedUser = localStorage.getItem('logged_user');
            
            if (savedUser) {
                const user = getUser(savedUser);
                if (user && user.enabled) {
                    if (isSystemLocked() && user.role === 'staff') {
                        localStorage.removeItem('logged_user');
                        hideLoadingSpinner();
                        showLockScreen();
                        return;
                    }
                    
                    localStorage.setItem('last_login', new Date().toDateString());
                    
                    await loadAllData(false);
                    await initializeFirestoreCollections();
                    await loadApprovalRequests();
                    
                    if (user.id) {
                        await db.collection(COLLECTIONS.USERS).doc(user.id).update({
                            lastActive: new Date().toISOString()
                        });
                    }
                    
                    hideLoadingSpinner();
                    document.getElementById('loginOverlay').style.display = 'none';
                    
                    updateGreeting();
                    updateUserDisplay();
                    applyRoleBasedUI();
                    showView('home');
                    startSessionHeartbeat();
                    
                    if (isSystemLocked() && canAccessLockedSystem()) {
                        document.getElementById('timeWarning').style.display = 'block';
                        setTimeout(() => {
                            document.getElementById('timeWarning').style.display = 'none';
                        }, 5000);
                    }
                } else {
                    localStorage.removeItem('logged_user');
                    localStorage.removeItem('last_login');
                    hideLoadingSpinner();
                    document.getElementById('loginOverlay').style.display = 'flex';
                }
            } else {
                hideLoadingSpinner();
                document.getElementById('loginOverlay').style.display = 'flex';
            }
        } catch (error) {
            console.error("Initialization error:", error);
            hideLoadingSpinner();
            document.getElementById('loginOverlay').style.display = 'flex';
        }

        setInterval(syncBG, 5000);
        setInterval(updateDashboardStatus, 1000);
        syncBG();
        updateDashboardStatus();

        const passInField = document.getElementById('passIn');
        if (passInField) {
            passInField.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
        }
        
        console.log("✅ Initialization complete");

    const originalInitializeApp = initializeApp;
    window.initializeApp = async function() {
        await originalInitializeApp();
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeFullscreenDocument();
                closeChangePasswordModal();
            }
        });

        window.onclick = function(event) {
            const fullscreenModal = document.getElementById('fullscreenDocumentView');
            const passwordModal = document.getElementById('changePasswordModal');
            
            if (event.target === fullscreenModal) {
                closeFullscreenDocument();
            }
            if (event.target === passwordModal) {
                closeChangePasswordModal();
            }
        };
    };

    window.manageUsersModal = async function() {
        const currentUser = getCurrentUser();
        const curUser = getUser(currentUser);
        
        if (!curUser) {
            alert("Please log in first");
            return;
        }

        await getAllUsers(true);
        renderUserManagementTable();
        document.getElementById('userManagementModal').style.display = 'flex';
    };

    window.openChangePasswordModal = openChangePasswordModal;
    window.closeChangePasswordModal = closeChangePasswordModal;

    window.onclick = function(event) {
        const modal = document.getElementById('documentViewerModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
        const fullscreenModal = document.getElementById('fullscreenDocumentView');
        if (event.target === fullscreenModal) {
            closeFullscreenDocument();
        }
        const passwordModal = document.getElementById('changePasswordModal');
        if (event.target === passwordModal) {
            closeChangePasswordModal();
        }
    };

    console.log("✅ Enhanced document viewer and password change features loaded");
    }

    window.onload = initializeApp;
    window.viewRequestDocument = viewRequestDocument;
    window.approveAccountRequest = approveAccountRequest;
    window.openRejectAccountReasonModal = openRejectAccountReasonModal;
    window.submitAccountRejection = submitAccountRejection;
    window.closeRejectAccountModal = closeRejectAccountModal;
    window.saveSupplier = saveSupplierWithCleanLogs;
    window.saveUserEdit = saveUserEdit;
    const originalCreateApprovalRequest = window.createApprovalRequest;
    window.createApprovalRequest = createApprovalRequest;
</script>

<!-- FOOTER -->
<footer style="text-align:center; padding: 40px; background: #333; color: white; margin-top: 40px;">
    <img src="./images/logo1.png" width="130" height="50" alt="ZAMCOM" onerror="this.style.display='none';">
    <p>Designed by Joseph Zulu <br> Zed Supplier Directory <br>Procurement Departments<br> © 2026 - Present</p>
    <a href="#headerSection" style="color: var(--primary-green); text-decoration: none;">Back to Top</a>
</footer>

</body>
</html>
